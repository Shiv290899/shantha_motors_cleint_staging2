import{u as N,a as M,r as i,j as e,L as _,b as U,G as O,_ as B,c as V,d as A}from"./index-DByWGH7d.js";/* empty css             */import{F as a}from"./index-fiQTrVnU.js";import{I as l,s as t}from"./index-mc3XMWnF.js";import{B as m}from"./button-BmMOSO5i.js";import{M as D}from"./index-BSIb012r.js";import"./TextArea-BDVSLBQS.js";import"./pickAttrs-DLhOEXIt.js";import"./EyeOutlined-DF4m-4HC.js";import"./index-BQHoEo7h.js";import"./useClosable-Dko-A-M4.js";import"./Skeleton-wxJCniSA.js";import"./PurePanel-B8np65kh.js";function re(){const x=N(),k=M(),[u]=a.useForm(),[F,j]=i.useState(!1),[P,g]=i.useState(!1),[p,c]=i.useState("request"),[S,v]=i.useState(!1),[b,R]=i.useState(!1),[w,h]=i.useState(""),[f]=a.useForm(),[d]=a.useForm();i.useEffect(()=>{p==="reset"&&d.setFieldsValue({token:w})},[p,w,d]),i.useEffect(()=>{const n=new URLSearchParams(k.search),s=n.get("resetToken")||n.get("token");s&&(h(s),c("reset"),g(!0))},[k.search]);const q=()=>{g(!0),c("request"),h(""),f.resetFields(),d.resetFields()},y=()=>{g(!1),c("request"),h(""),f.resetFields(),d.resetFields()},I=async({email:n})=>{v(!0);try{const s=await V(String(n||"").trim()),r=s?.message||"Reset instructions sent to your email.";s?.success?t.success(r):t.info(r),s?.devResetToken?(h(s.devResetToken),t.info(`Dev reset token: ${s.devResetToken}`,6),c("reset")):s?.emailSent&&y()}catch(s){const r=s?.response?.status;r===404?t.warning("We couldn't find that email. Please double-check or contact your administrator."):r===501?t.info("Password reset isn't enabled yet. Please reach out to your administrator."):t.error(s?.response?.data?.message||"Could not start the reset process. Try again later.")}finally{v(!1)}},C=async({token:n,password:s})=>{R(!0);try{const r=await A({token:String(n||"").trim(),password:s});r?.success?(t.success(r?.message||"Password updated successfully."),y()):t.error(r?.message||"Could not reset password. Try again.")}catch(r){r?.response?.status===400?t.warning(r?.response?.data?.message||"Reset link is invalid or has expired."):t.error(r?.response?.data?.message||"Could not reset password. Try again later.")}finally{R(!1)}},E=async n=>{j(!0);try{const s=await U(n);if(s?.success){if(s.token&&localStorage.setItem("token",s.token),s.user)try{localStorage.setItem("user",JSON.stringify(s.user))}catch{}try{const r=await O();if(r?.success&&r?.data){localStorage.setItem("user",JSON.stringify(r.data));const o=String(r.data.role||"").toLowerCase(),{routeForRole:L}=await B(async()=>{const{routeForRole:T}=await import("./roleRoute-Bz6JP6LZ.js");return{routeForRole:T}},[]);x(L(o));return}}catch{}t.success("Login successful!"),x("/dashboard")}else{try{localStorage.removeItem("token"),localStorage.removeItem("user")}catch(o){}const r=s?.message||(s?.code===401?"Invalid password":s?.code===404?"User does not exist":"Invalid email or password");if(s?.code===404){t.warning(r);try{u.setFields([{name:"email",errors:["User does not exist"]}])}catch(o){}}else if(s?.code===401){t.error(r);try{u.setFields([{name:"password",errors:["Invalid password"]}])}catch(o){}}else{t.error(r);try{u.setFields([{name:"email",errors:[""]},{name:"password",errors:[""]}])}catch(o){}}return}}catch(s){console.error("Login error:",s),localStorage.removeItem("user");const r=s?.response?.status,o=s?.response?.data?.message||"Something went wrong, please try again";r===404?t.warning(o):r===401?t.error(o):t.error(o)}finally{j(!1)}};return e.jsxs("div",{className:"auth-container",children:[e.jsxs("div",{className:"auth-box",children:[e.jsx("h1",{className:"title",children:"Login to Shantha Motors"}),e.jsxs(a,{layout:"vertical",form:u,onFinish:E,children:[e.jsx(a.Item,{label:"Email",name:"email",rules:[{required:!0,message:"Email is required"}],children:e.jsx(l,{type:"email",placeholder:"Enter your email"})}),e.jsx(a.Item,{label:"Password",name:"password",rules:[{required:!0,message:"Password is required"}],children:e.jsx(l.Password,{placeholder:"Enter your password"})}),e.jsxs("div",{className:"form-row",children:[e.jsx("span",{}),e.jsx(m,{type:"link",className:"link",onClick:q,children:"Forgot password?"})]}),e.jsx(m,{type:"primary",block:!0,htmlType:"submit",loading:F,children:"Login"})]}),e.jsxs("p",{className:"switch-text",children:["New User? ",e.jsx(_,{to:"/register",children:"Register here"})]})]}),e.jsx(D,{title:p==="reset"?"Choose a new password":"Reset your password",open:P,onCancel:y,footer:null,destroyOnClose:!0,children:p==="request"?e.jsxs(e.Fragment,{children:[e.jsx("p",{style:{marginBottom:16},children:"Enter the email you use for Shantha Motors. If we find a matching account, we'll send instructions to reset your password."}),e.jsxs(a,{form:f,layout:"vertical",onFinish:I,name:"resetPasswordRequest",children:[e.jsx(a.Item,{label:"Email",name:"email",rules:[{required:!0,message:"Email is required"},{type:"email",message:"Enter a valid email address"}],children:e.jsx(l,{placeholder:"you@example.com",autoComplete:"email"})}),e.jsx(m,{type:"primary",htmlType:"submit",block:!0,loading:S,children:"Send reset link"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{style:{marginBottom:16},children:"Paste the reset token you received (or the dev token shown above) and choose a new password."}),e.jsxs(a,{form:d,layout:"vertical",onFinish:C,name:"resetPasswordConfirm",initialValues:{token:w},children:[e.jsx(a.Item,{label:"Reset token",name:"token",rules:[{required:!0,message:"Reset token is required"}],children:e.jsx(l,{placeholder:"Paste token",autoComplete:"one-time-code"})}),e.jsx(a.Item,{label:"New password",name:"password",rules:[{required:!0,message:"Password is required"},{min:6,message:"At least 6 characters"}],hasFeedback:!0,children:e.jsx(l.Password,{placeholder:"Enter new password",autoComplete:"new-password"})}),e.jsx(a.Item,{label:"Confirm password",name:"confirm",dependencies:["password"],hasFeedback:!0,rules:[{required:!0,message:"Please confirm your password"},({getFieldValue:n})=>({validator(s,r){return!r||n("password")===r?Promise.resolve():Promise.reject(new Error("Passwords do not match"))}})],children:e.jsx(l.Password,{placeholder:"Re-enter new password",autoComplete:"new-password"})}),e.jsx(m,{type:"primary",htmlType:"submit",block:!0,loading:b,children:"Update password"}),e.jsx(m,{type:"link",block:!0,onClick:()=>c("request"),children:"Back"})]})]})})]})}export{re as default};
