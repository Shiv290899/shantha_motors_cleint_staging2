import{j as e,r as S,R as Le,G as Qe,u as at}from"./index-D3jyxz5S.js";import rt from"./Quotation-Bk4PV2PZ.js";import it from"./JobCard-BlM0SnFb.js";import{F as qe,R as lt,P as ct,B as dt}from"./BookingForm-fdAZNRnL.js";import{V as mt,I as ut}from"./VehicleSearch-CzABQKOF.js";import{P as pt,S as ht}from"./StockUpdate-BWTUZvx_.js";import{T as Xe,C as be}from"./index-Do8dGFqA.js";import{R as ft}from"./ToolOutlined-D5wRuDFv.js";import{u as gt,A as yt}from"./useAnnouncementBadge-BMJAPOpX.js";import{h as bt}from"./PostServiceSheet-a3wpyx66.js";import{d as xt}from"./index-BaYR0Azk.js";import{s as _e,a as Pe}from"./caseInsensitive-Bczb6n5Q.js";import{F as I}from"./index-CcgLN9cm.js";import{z as he,A as V,T as jt}from"./TextArea-Q3gpJu61.js";import{A as We}from"./index-DPxH9qVd.js";import{T as ve}from"./index-C0lBYX3a.js";import{B as Y}from"./button-CtJmIkB1.js";import{D as Ce}from"./index-CU-RyMmz.js";import{F as Ze}from"./Table-C4tN8BUo.js";import{T as ge}from"./index-BE1rlUlE.js";import{I as Oe,s as ne}from"./index-CY4Kamfr.js";import{S as ye}from"./index-BBYJ-6BB.js";import{G as et}from"./index-DjHBBus9.js";import{T as G}from"./index-Bv816-4y.js";import{M as St}from"./index-C426kwCm.js";import{a as Je,E as Ne}from"./index-CtRvdixs.js";import"./index-CZRYr7Ag.js";import"./useBubbleLock-Bjm2feVM.js";import"./PrinterOutlined-CzweR46M.js";import"./AntdIcon-DD3d8MPl.js";import"./PlusOutlined-aHmBnbM2.js";import"./PlusOutlined-AckC3LXy.js";import"./index-gy4sqIjf.js";import"./iconBase-DX4Dj3PV.js";import"./ThunderboltOutlined-BNjlM5sV.js";import"./CheckOutlined-Dmu6kb1T.js";import"./pickAttrs-CXQyGfOx.js";import"./index-nbuh2wRs.js";import"./EyeOutlined-pj_CrMc9.js";import"./index-BQ7ctNX1.js";import"./Skeleton-D--9XwWe.js";import"./useClosable-DfZqN2_R.js";import"./PurePanel-CsQLL2O2.js";import"./DownOutlined-C-UypXHl.js";import"./addEventListener-k3sqzIsr.js";import"./LeftOutlined-D-CNePKA.js";import"./index-CUWDS_la.js";function At(){const t=(g,j)=>e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[g,e.jsx("span",{children:j})]}),s="https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",n="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",i=s,l=n,c=[{key:"quotation",label:t(e.jsx(lt,{}),"Quotation"),children:e.jsx(qe,{mode:"quotation",webhookUrl:i})},{key:"jobcard",label:t(e.jsx(ft,{}),"Job Card"),children:e.jsx(qe,{mode:"jobcard",webhookUrl:l})}];return e.jsx(Xe,{defaultActiveKey:"quotation",items:c,destroyInactiveTabPane:!0})}function vt(t){try{const s=xt(t);return s.isValid()?s.format("DD-MM-YYYY HH:mm"):"-"}catch{return"-"}}const Nt=S.forwardRef(function({active:s=!0,vals:n={}},i){const l=String(n?.branchName||"").trim(),c=l==="Byadarahalli",g=n?.dateTimeIso||new Date,j=Array.isArray(n?.items)?n.items:[],v=Number(n?.summaryTotal||0)||0,o=Number(n?.customer?.cashCollected??n?.cashCollected??0)||0,f=Number(n?.customer?.onlineCollected??n?.onlineCollected??0)||0,A=o>0&&f>0?`CASH â‚¹${o} + ONLINE â‚¹${f}`:o>0?`CASH â‚¹${o}`:f>0?`ONLINE â‚¹${f}`:String(n?.customer?.paymentMode||"").toUpperCase()||"-",u=n?.customer?.utr||n?.utr;return e.jsxs("div",{ref:i,className:`print-sheet ${s?"active":""}`,children:[e.jsx("style",{children:`
@page { size: A4 portrait; margin: 0; }
@media screen { body:not(.print-host) .print-sheet { display: none !important; } }
@media print {
  body * { visibility: hidden !important; }
  .print-sheet { display: block; }
  .print-sheet.active, .print-sheet.active * { visibility: visible !important; }
  .print-sheet.active { position: absolute; inset: 0; width: 100%; }
}
.wrap { padding: 10mm; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; color: #000; }
.box { border: 1px solid #111; border-radius: 2mm; padding: 4mm; }
.hdr { display: grid; grid-template-columns: 26mm 1fr 26mm; align-items: center; gap: 4mm; }
.shop { text-align: center; }
.shop .en { font-size: 14.5pt; font-weight: 700; line-height: 1.08; }
.shop .sub { font-size: 9.5pt; margin-top: 1mm; }
.title { text-align: center; font-size: 16.5pt; font-weight: 800; margin: 6px 0 10px; letter-spacing: .4px; }
.kv{ display:grid; grid-template-columns: 32mm 1fr; column-gap:3mm; padding:1.5mm 0; border-bottom:1px solid #e5e7eb; }
.kv .name{ font-weight:600; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:2mm; }
.full{ grid-column:1 / -1; }
table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-top: 2mm; }
th, td { border: 1px solid #111; padding: 2.5mm; }
th { background: #fafafa; }
.right { text-align: right; }
.center { text-align: center; }
.sign-row { display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:8mm; }
.sign { border-top: 1px dashed #777; padding-top: 3mm; text-align: center; font-size: 10pt; }
      `}),e.jsx("div",{className:"wrap",children:e.jsxs("div",{className:"box",children:[e.jsxs("div",{className:"hdr",children:[e.jsx("img",{src:c?"/honda-logo.png":"/shantha-logoprint.jpg",alt:"Logo",style:{width:"100%",maxHeight:92}}),e.jsx("div",{className:"shop",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"en",children:"NH MOTORS | à²à²¨à³ à²à²šà³ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsxs("div",{className:"sub",children:["Site No. 116/1, Bydarahalli, Magadi Main Road, Opp.",e.jsx("br",{}),"HP Petrol Bunk, Bangalore - 560091"]}),e.jsx("div",{className:"sub",children:"Mob: 9731366921 / 8073283502 / 9741609799"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"en",children:"SHANTHA MOTORS | à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsx("div",{className:"sub",children:"Multi Brand Two Wheeler Sales & Service"}),e.jsx("div",{className:"sub",children:"Mob No : 9731366921 / 8073283502"})]})}),e.jsxs("div",{children:[e.jsx("img",{src:"/location-qr.png",alt:"QR",style:{width:"100%",maxHeight:92}}),e.jsx("div",{style:{fontSize:12,fontWeight:600,marginTop:4,textAlign:"center"},children:"Scan for Location"})]})]}),e.jsx("div",{className:"title",children:"Minor Sales Receipt"}),e.jsxs("div",{className:"grid",children:[e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Date/Time:"}),e.jsx("div",{children:vt(g)})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Order ID:"}),e.jsx("div",{children:n?.orderId||"-"})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Branch:"}),e.jsx("div",{children:l||"-"})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Executive:"}),e.jsx("div",{children:n?.staffName||"-"})]}),e.jsxs("div",{className:"kv full",children:[e.jsx("div",{className:"name",children:"Customer:"}),e.jsxs("div",{children:[String(n?.customer?.name||"-").toUpperCase()," (",n?.customer?.mobile||"-",")"]})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Payment:"}),e.jsx("div",{children:A})]}),f>0&&e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"UTR / Ref:"}),e.jsx("div",{children:u||"-"})]})]}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{className:"center",style:{width:"16mm"},children:"Qty"}),e.jsx("th",{className:"right",style:{width:"26mm"},children:"Unit"}),e.jsx("th",{className:"right",style:{width:"30mm"},children:"Amount"})]})}),e.jsxs("tbody",{children:[j.map((r,p)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.item}),e.jsx("td",{className:"center",children:r.qty}),e.jsxs("td",{className:"right",children:["â‚¹",r.unitPrice]}),e.jsxs("td",{className:"right",children:["â‚¹",r.amount]})]},p)),e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"right",style:{fontWeight:700},children:"Total"}),e.jsxs("td",{className:"right",style:{fontWeight:700},children:["â‚¹",v]})]})]})]}),e.jsxs("div",{className:"sign-row",children:[e.jsx("div",{className:"sign",children:"Customer Signature"}),e.jsx("div",{className:"sign",children:"Authorized Signature"})]})]})})]})}),we="https://script.google.com/macros/s/AKfycbzUYgfSeU54u65-wYXCFUAnlCCX9jUnbRYC3DhKrexWBi5wLJzbKlghU1TrfuChGtbc/exec",wt=[{required:!0,message:"Mobile number is required"},{pattern:/^[6-9]\d{9}$/,message:"Enter a valid 10-digit Indian mobile number"}],He=[{label:"Helmet",prices:[500,400]},{label:"Floor Mat",prices:[200,150,100]},{label:"Vehicle Cover",prices:[300,250,200]},{label:"Number Plate Frame",prices:[200,150,100]}],O=t=>Number(String(t??0).replace(/[â‚¹,\s]/g,""))||0;function Ke(t){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(Math.max(0,Math.round(t||0)))}function Ge(t){return String(t||"").replace(/\D/g,"").slice(-10)}function de(t){return String(t||"").trim().toUpperCase()}function Re(){const t=new Date;return[t.getFullYear().toString().slice(-2),("0"+(t.getMonth()+1)).slice(-2),("0"+t.getDate()).slice(-2),"-",Math.random().toString(36).slice(2,6).toUpperCase()].join("")}function Ct(){const[t]=I.useForm(),[,s]=S.useState(!1),[n,i]=S.useState({staffName:"",branchName:""}),[l,c]=S.useState([]),[g,j]=S.useState(Re()),[v,o]=S.useState(!1),[f,A]=S.useState(null),u=Le.useRef(null),r="MinorSales:outbox",p=(a,m)=>{try{const h=localStorage.getItem(a);return h?JSON.parse(h):m}catch{return m}},N=(a,m)=>{try{localStorage.setItem(a,JSON.stringify(m))}catch{}},B=a=>{const m=p(r,[]),h={id:Date.now()+":"+Math.random().toString(36).slice(2),job:a};return m.push(h),N(r,m),h.id},Q=a=>{const m=p(r,[]);N(r,m.filter(h=>h.id!==a))},E=async()=>{try{const a=p(r,[]);for(const m of a){const h=m.job||{};if(h?.type==="minor"&&we)try{const x=await _e({webhookUrl:we,method:"POST",payload:h.data});(x?.data||x)?.success!==!1&&Q(m.id)}catch{}}}catch{}};S.useEffect(()=>{setTimeout(()=>{E()},0)},[]),S.useEffect(()=>{const a=()=>E();return window.addEventListener("online",a),()=>window.removeEventListener("online",a)},[]),S.useEffect(()=>{(async()=>{try{let a=null;try{const x=localStorage.getItem("user");a=x?JSON.parse(x):null}catch{}if(!a){const x=await Qe().catch(()=>null);if(x?.success&&x.data){a=x.data;try{localStorage.setItem("user",JSON.stringify(a))}catch{}}}const m=a?.formDefaults?.staffName||a?.name||"",h=a?.formDefaults?.branchName||a?.primaryBranch?.name||(Array.isArray(a?.branches)?typeof a.branches[0]=="string"?a.branches[0]:a.branches[0]?.name||"":"");i({staffName:m,branchName:h})}catch{}})()},[]);const L=I.useWatch("item",t),_=I.useWatch("price",t),le=I.useWatch("qty",t)||1,X=I.useWatch("paymentCash",t),z=I.useWatch("paymentOnline",t),se=S.useMemo(()=>{const a=de(L);return He.filter(h=>!a||de(h.label).includes(a)).map(h=>({value:h.label}))},[L]),H=S.useMemo(()=>{const a=de(L);return a&&He.find(m=>de(m.label)===a)||null},[L]),De=S.useMemo(()=>(H?.prices||[]).map(a=>({value:String(a),label:`â‚¹${a}`})),[H]),k=S.useMemo(()=>!Array.isArray(l)||l.length===0?0:l.reduce((a,m)=>a+Number(m.amount||0),0),[l]),Ie=S.useMemo(()=>O(X)+O(z),[X,z]),je=k>0&&Ie===O(k),Z=S.useMemo(()=>{const a=String(L||"").trim();if(!a)return null;const m=O(_);if(!m)return null;const h=Number(le);return{item:a,qty:h,unitPrice:m,amount:m*h}},[L,_,le]);S.useEffect(()=>{const a=O(X),m=O(z);k>0&&a===0&&m===0&&t.setFieldsValue({paymentCash:k,paymentOnline:0})},[k,X,z,t]);function Ve(){if(!Z){ne.warning("Select item, price, and qty first");return}c(a=>{const m=a.findIndex(h=>h.item===Z.item&&Number(h.unitPrice)===Number(Z.unitPrice));if(m>=0){const h=[...a],x=Number(h[m].qty||0)+Number(Z.qty||0);return h[m]={...h[m],qty:x,amount:x*Number(h[m].unitPrice)},h}return[...a,Z]}),t.setFieldsValue({item:void 0,price:void 0,qty:1})}function ce(a,m){c(h=>{const x=[...h],K=Math.max(1,Number(m||1)),q=Number(x[a].unitPrice||0);return x[a]={...x[a],qty:K,amount:K*q},x})}function R(a){c(m=>m.filter((h,x)=>x!==a))}async function ee(){o(!0);try{if(await new Promise(te=>setTimeout(te,0)),!l.length){ne.warning("Add at least one item to cart");return}const a=await t.validateFields(["custName","custMobile","paymentCash","paymentOnline","utr"]),m=O(a.paymentCash),h=O(a.paymentOnline),x=m+h;if(x!==O(k)){ne.error("Cash + Online should equal the cart total.");return}const K=m>0&&h>0?"CASH+ONLINE":h>0?"ONLINE":"CASH",q={action:"minor_sales_save",data:{staffName:n.staffName||void 0,branchName:n.branchName||void 0,dateTimeIso:new Date().toISOString(),orderId:g,summaryTotal:k,source:"minorsales",cashCollected:m,onlineCollected:h,totalCollected:x,items:l,purchased:!0,customer:{name:String(a.custName||"").trim().toUpperCase(),mobile:Ge(a.custMobile),paymentMode:K,utr:h>0&&String(t.getFieldValue("utr")||"").trim()||void 0,cashCollected:m,onlineCollected:h}}},Se=B({type:"minor",data:q});setTimeout(async()=>{try{if(we){const te=await _e({webhookUrl:we,method:"POST",payload:q});(te?.data||te)?.success!==!1&&Q(Se)}}catch{}},0),ne.loading({key:"msave",content:"Saving in backgroundâ€¦",duration:1}),A({staffName:n.staffName,branchName:n.branchName,dateTimeIso:new Date().toISOString(),orderId:g,summaryTotal:k,source:"minorsales",cashCollected:m,onlineCollected:h,totalCollected:x,items:l,customer:{name:String(a.custName||"").trim().toUpperCase(),mobile:Ge(a.custMobile),paymentMode:K,cashCollected:m,onlineCollected:h,utr:h>0&&String(t.getFieldValue("utr")||"").trim()||void 0}}),await new Promise(te=>setTimeout(te,0)),await bt(u.current);try{t.resetFields()}catch{}c([]),j(Re()),A(null)}catch(a){if(a?.errorFields)return;console.error("Print slip failed",a),ne.error("Unable to print slip")}finally{o(!1)}}const me=S.useMemo(()=>({item:void 0,price:void 0,qty:1,paymentCash:0,paymentOnline:0}),[]);function ue(){try{t.resetFields()}catch{}c([]),j(Re())}return e.jsxs(be,{title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(ge.Text,{strong:!0,style:{fontSize:16},children:"Minor Sales (Quick)"}),e.jsxs("div",{style:{fontSize:11,color:"#888"},children:[n.branchName||""," Â· ",n.staffName||""]})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1},children:"Order ID"}),e.jsx("div",{style:{fontWeight:700},children:g})]})]}),bodyStyle:{padding:16},style:{borderRadius:10,boxShadow:"0 3px 10px rgba(0,0,0,0.06)"},extra:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(ge.Text,{style:{fontSize:12,color:"#888"},children:"Cart Total"}),e.jsx("div",{style:{fontWeight:700,fontSize:16},children:Ke(k)})]}),children:[e.jsxs(I,{form:t,layout:"vertical",initialValues:me,children:[e.jsxs(he,{gutter:[12,12],children:[e.jsx(V,{xs:24,md:10,children:e.jsx(I.Item,{name:"item",label:"Item",rules:[{required:!0,message:"Enter item"}],children:e.jsx(We,{options:se,placeholder:"Type or choose item",filterOption:(a,m)=>de(m?.value).includes(de(a)),defaultActiveFirstOption:!1,allowClear:!0})})}),e.jsx(V,{xs:24,md:8,children:e.jsx(I.Item,{name:"price",label:"Price (â‚¹)",rules:[{required:!0,message:"Enter price"},{validator:(a,m)=>O(m)>0?Promise.resolve():Promise.reject(new Error("Enter valid price"))}],children:e.jsx(We,{options:De,placeholder:H?"Type price or choose suggestion":"Type price",filterOption:(a,m)=>String(m?.value||"").includes(String(a||"").replace(/\D/g,"")),defaultActiveFirstOption:!1,allowClear:!0})})}),e.jsx(V,{xs:24,md:6,children:e.jsx(I.Item,{name:"qty",label:"Quantity",rules:[{required:!0,message:"Enter quantity"}],children:e.jsx(ve,{style:{width:"100%"},min:1,step:1})})})]}),e.jsx(he,{children:e.jsx(V,{span:24,children:e.jsx(Y,{onClick:Ve,type:"primary",ghost:!0,disabled:!Z,children:"Add to cart"})})}),e.jsx(Ce,{style:{margin:"12px 0"}}),e.jsx(be,{size:"small",title:"Cart",style:{marginBottom:12},bodyStyle:{padding:8},extra:e.jsxs(ge.Text,{strong:!0,children:["Items: ",l.length]}),children:e.jsx(Ze,{dataSource:l.map((a,m)=>({key:m,...a})),pagination:!1,size:"small",locale:{emptyText:"No items added yet"},columns:[{title:"Item",dataIndex:"item"},{title:"Qty",dataIndex:"qty",render:(a,m,h)=>e.jsx(ve,{min:1,value:a,onChange:x=>ce(h,x)})},{title:"Unit (â‚¹)",dataIndex:"unitPrice"},{title:"Amount (â‚¹)",dataIndex:"amount"},{title:"Action",render:(a,m,h)=>e.jsx(pt,{title:"Remove this item?",onConfirm:()=>R(h),children:e.jsx(Y,{danger:!0,size:"small",children:"Remove"})})}]})}),e.jsxs(be,{size:"small",title:"Customer & Payment",bodyStyle:{padding:8},children:[e.jsxs(he,{gutter:12,children:[e.jsx(V,{xs:24,md:8,children:e.jsx(I.Item,{name:"custName",label:"Name",rules:[{required:!0,message:"Name is required"}],getValueFromEvent:a=>a&&a.target?a.target.value.toUpperCase():a,children:e.jsx(Oe,{placeholder:"CUSTOMER NAME"})})}),e.jsx(V,{xs:24,md:8,children:e.jsx(I.Item,{name:"custMobile",label:"Mobile",rules:wt,children:e.jsx(Oe,{maxLength:10,placeholder:"10-digit mobile"})})})]}),e.jsxs(he,{gutter:12,children:[e.jsx(V,{xs:24,md:8,children:e.jsx(I.Item,{name:"paymentCash",label:"Cash (â‚¹)",rules:[{validator:(a,m)=>O(m)>=0?Promise.resolve():Promise.reject(new Error("Enter cash amount (â‚¹)"))}],children:e.jsx(ve,{min:0,step:50,style:{width:"100%"},prefix:"â‚¹",placeholder:"0"})})}),e.jsx(V,{xs:24,md:8,children:e.jsx(I.Item,{name:"paymentOnline",label:"Online (â‚¹)",rules:[{validator:(a,m)=>O(m)>=0?Promise.resolve():Promise.reject(new Error("Enter online amount (â‚¹)"))}],children:e.jsx(ve,{min:0,step:50,style:{width:"100%"},prefix:"â‚¹",placeholder:"0"})})}),e.jsx(V,{xs:24,md:8,children:e.jsx(I.Item,{shouldUpdate:!0,noStyle:!0,children:()=>{const a=O(t.getFieldValue("paymentOnline"));return e.jsx(I.Item,{name:"utr",label:"UTR / Reference No.",rules:a>0?[{required:!0,message:"Enter UTR/Reference for online payments"}]:[],getValueFromEvent:m=>{const h=m&&m.target?m.target.value:m;return typeof h=="string"?h.toUpperCase():h},children:e.jsx(Oe,{placeholder:"e.g., 23XXXXUTR123",style:{textTransform:"uppercase"},disabled:a<=0})})}})})]})]}),e.jsxs(he,{justify:"space-between",align:"middle",style:{marginTop:12},children:[e.jsxs(V,{children:[e.jsx(ge.Text,{type:"secondary",style:{fontSize:12},children:"Net Payable"}),e.jsx("div",{style:{fontSize:18,fontWeight:700},children:Ke(k)})]}),e.jsx(V,{children:e.jsxs(ye,{children:[e.jsx(Y,{onClick:ue,disabled:v,children:"Clear"}),e.jsx(Y,{type:"primary",onClick:ee,disabled:!l.length||v||!je,loading:v,children:"Print"})]})})]})]}),e.jsx("div",{style:{display:"none"},children:e.jsx(Nt,{ref:u,active:v,vals:f||{}})})]})}const Pt={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},{Text:P}=ge;function Tt(){const t=at(),n=!et.useBreakpoint().md,l="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",c="",j="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",v="",[o,f]=S.useState({bookingAmountPending:0,jcAmountPending:0,minorSalesAmountPending:0,totalPending:0,prevDueAssigned:0}),[A,u]=S.useState(!1),[r,p]=S.useState(!1),[N,B]=S.useState("cash"),[Q,E]=S.useState([]),[L,_]=S.useState(!1),[le,X]=S.useState(!1),[z,se]=S.useState(!1),[H,De]=S.useState([]),[k,Ie]=S.useState([]),[je,Z]=S.useState(null),ce=(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}})(),R=ce?.formDefaults?.branchName||ce?.primaryBranch?.name||"",ee=ce?.formDefaults?.staffName||ce?.name||"",me=`StaffAccount:${R}|${ee}`;S.useEffect(()=>{try{const d=localStorage.getItem(me);if(d){const y=JSON.parse(d);y&&y.data&&(f(y.data),X(!0))}}catch{}},[me]);const ue=d=>{try{localStorage.setItem(me,JSON.stringify({at:Date.now(),data:d}))}catch{}},a=async()=>{if(!(!R||!ee)){u(!0);try{const y=await Pe({webhookUrl:l,method:"GET",payload:c?{action:"staff_ledger_summary",branch:R,staff:ee,secret:c}:{action:"staff_ledger_summary",branch:R,staff:ee}}),w=y?.data||y||{};if(!w?.success)throw new Error("Failed");const b=w?.data&&typeof w.data=="object"?w.data:w,C=Number(b.prevDueAssigned??b.openingBalance??b.opening??0)||0,W={bookingAmountPending:0,jcAmountPending:0,minorSalesAmountPending:0,totalPending:Number(b.totalPending||0)||0,cashAmountPending:Number(b.cashPending||0)||0,onlineAmountPending:Number(b.onlinePending||0)||0,total:Number(b.totalPending||0)||0,cashAmount:Number(b.cashPending||0)||0,onlineAmount:Number(b.onlinePending||0)||0,settlementDone:!1,lastSettledAt:b.lastSettledAt||void 0,prevDueAssigned:C,prevDueNote:b.prevDueNote||"",prevDueUpdatedAt:b.prevDueUpdatedAt||b.prevDueAssignedAt||"",prevDueUpdatedBy:b.prevDueUpdatedBy||""};f(W),ue(W),u(!1);try{const oe=await $e({GAS_URL:l,SECRET:c,branch:R,staff:ee,mode:"all"}),J=F=>{const U=String(F||"").toLowerCase().trim().replace(/[^a-z]/g,"");return U.startsWith("book")?"booking":U==="jc"||U.includes("jobcard")||U.includes("job")?"jc":U.includes("minor")?"minor":"other"},M=oe.reduce((F,D)=>{const U=J(D.sourceType??D.SourceType??D.srcType??D.SrcType),Me=Number(D.cashPending??D.CashPending??D.cash??D.Cash??0)||0,pe=Number(D.onlinePending??D.OnlinePending??D.onLinePending??D.online??D.Online??0)||0,re=Me+pe;return U==="booking"?F.booking+=re:U==="jc"?F.jc+=re:U==="minor"?F.minor+=re:F.other+=re,F},{booking:0,jc:0,minor:0,other:0}),ae={...W,bookingAmount:M.booking,jcAmount:M.jc,minorSalesAmount:M.minor,bookingAmountPending:M.booking,jcAmountPending:M.jc,minorSalesAmountPending:M.minor};f(ae),ue(ae)}catch{f(W),ue(W)}}catch{ne.error("Could not load account summary")}finally{u(!1)}}};S.useEffect(()=>{a()},[l]);const m=Math.max(1e3,parseInt("600000",10)||6e5);S.useEffect(()=>{const d=setInterval(()=>{try{a()}catch{}try{Ae()}catch{}},m);return()=>clearInterval(d)},[l,m]);const h=d=>new Intl.NumberFormat("en-IN",{maximumFractionDigits:0}).format(Number(d||0)),x=S.useMemo(()=>{const d=re=>Number.isFinite(Number(re))?Number(re):0,y=d(o.cashAmount??o.cashAmountPending??o.cash??o.cashPending??0),w=d(o.onlineAmount??o.onlineAmountPending??o.online??o.onlinePending??0);let b=d(o.total??o.totalPending??y+w);b||(b=y+w);const C=d(o.bookingAmountPending??o.bookingAmount??0),W=d(o.minorSalesAmountPending??o.minorSalesAmount??0),oe=d(o.jcAmountPending??o.jcAmount??0),J=C+W+oe,M=d(o.prevDueAssigned??o.prevDue??o.openingBalance??o.opening??0),ae=M+J;d(o.jcCashPending??o.jcCash??0),d(o.jcOnlinePending??o.jcOnline??0);let F=d(o.closingPending??o.outstandingPending??o.closing??0);F||(F=Math.max(0,J-b));const D=Math.max(0,M+J-b),U=y,Me=U+w,pe={total:b,cash:U,online:w,totalCollected:Me,jc:oe,booking:C,minor:W,prevDue:M,breakdownTotal:ae,prevDueNote:o.prevDueNote||"",prevDueUpdatedAt:o.prevDueUpdatedAt||void 0,prevDueUpdatedBy:o.prevDueUpdatedBy||"",settlementDone:!!o.settlementDone,lastSettledAt:o.lastSettledAt||o.lastSettlementAt||void 0,pending:F,pendingAll:D,sales:J};return pe.settlementDone?{total:0,cash:0,online:0,totalCollected:0,jc:0,booking:0,minor:0,prevDue:0,breakdownTotal:0,prevDueNote:"",prevDueUpdatedAt:void 0,prevDueUpdatedBy:"",settlementDone:!0,lastSettledAt:pe.lastSettledAt,pending:0,pendingAll:0,sales:0}:pe},[o]),K=S.useMemo(()=>{const d=[];if(o.prevDueNote&&d.push(`Note: ${o.prevDueNote}`),o.prevDueUpdatedBy||o.prevDueUpdatedAt){const y=o.prevDueUpdatedAt?fe(o.prevDueUpdatedAt):"",b=["Assigned",(o.prevDueUpdatedBy?`by ${o.prevDueUpdatedBy}`:"").trim(),y?`on ${y}`:""].filter(Boolean).join(" ");b.trim()&&d.push(b.trim())}return d.join(" â€¢ ")},[o.prevDueNote,o.prevDueUpdatedAt,o.prevDueUpdatedBy]),q=({label:d,value:y,subtle:w})=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:6,opacity:w?.9:1},children:[e.jsx(P,{type:w?"secondary":void 0,children:d}),e.jsxs(P,{strong:!0,children:["â‚¹ ",h(y)]})]}),Se=async d=>{try{B(d),p(!0),E([]),_(!0);const y=await $e({GAS_URL:l,SECRET:c,branch:R,staff:ee,mode:d});E(y);try{if(y.filter(b=>!b.customerName&&String(b.sourceType||"").toLowerCase()==="jc").length){const b=await Promise.all(y.map(async C=>{if(C.customerName||String(C.sourceType||"").toLowerCase()!=="jc")return C;try{const W=c?{action:"search",mode:"jc",query:String(C.sourceId||""),secret:c}:{action:"search",mode:"jc",query:String(C.sourceId||"")},oe=await Pe({webhookUrl:l,method:"GET",payload:W}),J=oe?.data||oe||{},M=Array.isArray(J.rows)&&J.rows.length?J.rows[0]:null,ae=M?.values?.Customer_Name||M?.payload?.formValues?.custName||"";return ae?{...C,customerName:ae}:C}catch{return C}}));E(b)}}catch{}}catch{ne.error("Could not load transactions")}finally{_(!1)}},te=d=>{const y=String(d?.mobile||"").replace(/\D/g,"").slice(-10),w=String(d?.jcNo||d?.serialNo||"").trim(),b=new URLSearchParams;b.set("autoFetch","1"),y?(b.set("mode","mobile"),b.set("query",y)):w&&(b.set("mode","jc"),b.set("query",w)),w&&b.set("jcNo",w);const C=b.toString();t(C?`/jobcard?${C}`:"/jobcard")},Ae=async()=>{if(R){se(!0);try{const[d,y]=await Promise.all([kt({GAS_URL:l,SECRET:c,branch:R}),Dt({BOOKING_GAS_URL:j,BOOKING_SECRET:v,branch:R})]);De(d),Ie(y),Z(new Date)}catch{ne.error("Could not load pending summary")}finally{se(!1)}}};S.useEffect(()=>{Ae()},[R,l,j]);const Ee=S.useMemo(()=>{const d=Array.isArray(H)?H.length:0,y=Array.isArray(k)?k.length:0,w=(Array.isArray(k)?k:[]).reduce((b,C)=>b+(Number(C.balanceValue||0)||0),0);return{service:d,sales:y,salesBalance:w}},[H,k]);return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:n?"1fr":"1fr 1fr",gap:16,alignItems:"start"},children:[e.jsxs(be,{size:"small",loading:A&&!le,title:"Account Summary",style:{width:"100%"},extra:e.jsx(Y,{size:"small",onClick:a,disabled:A,children:"Refresh"}),children:[e.jsxs(ye,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:n?"1fr":"1fr 1fr",gap:12},children:[e.jsxs("div",{style:{padding:12,border:"1px solid #f0f0f0",borderRadius:8,background:"#fff"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(P,{strong:!0,children:"Cash to Hand Over"}),e.jsxs(ye,{size:6,children:[e.jsx(Y,{size:"small",onClick:()=>Se("cash"),children:"View"}),e.jsx(G,{color:"green",children:"Cash"})]})]}),e.jsxs("div",{style:{fontSize:24,fontWeight:800,marginTop:6},children:["â‚¹ ",h(x.cash)]})]}),e.jsxs("div",{style:{padding:12,border:"1px solid #f0f0f0",borderRadius:8,background:"#fafafa"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(P,{strong:!0,children:"Online Collected"}),e.jsxs(ye,{size:6,children:[e.jsx(Y,{size:"small",onClick:()=>Se("online"),children:"View"}),e.jsx(G,{color:"blue",children:"Online"})]})]}),e.jsxs("div",{style:{fontSize:24,fontWeight:800,marginTop:6},children:["â‚¹ ",h(x.online)]}),e.jsx(P,{type:"secondary",style:{fontSize:12},children:"Shown for record, not handed over"})]})]}),e.jsxs("div",{style:{paddingTop:6},children:[e.jsx(P,{strong:!0,children:"Total Sales"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:12},children:[e.jsx(ct,{percent:x.totalCollected||0?100:0,showInfo:!1,strokeColor:{from:"#52c41a",to:"#2f54eb"}}),e.jsxs(P,{style:{fontSize:18,fontWeight:700},children:["â‚¹ ",h(x.totalCollected)]})]}),e.jsx(P,{type:"secondary",style:{fontSize:12},children:"Cash to hand over + Online collected"})]}),e.jsx(Ce,{style:{margin:"8px 0"}}),e.jsx(P,{type:"secondary",style:{fontSize:12},children:"Breakdown"}),e.jsx(q,{label:"Previous Due (carry forward)",value:x.prevDue,subtle:!0}),K?e.jsx(P,{type:"secondary",style:{fontSize:11,marginTop:-6,marginBottom:4},children:K}):null,e.jsx(q,{label:"From Job Cards",value:x.jc,subtle:!0}),e.jsx(q,{label:"From Bookings",value:x.booking,subtle:!0}),e.jsx(q,{label:"From Minor Sales",value:x.minor,subtle:!0}),e.jsx(q,{label:"Total Pending Payments",value:x.breakdownTotal}),e.jsx(Ce,{style:{margin:"8px 0"}}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx(jt,{title:"After owner collects cash, only the owner can reset amounts to zero.",children:e.jsx(G,{color:"orange",children:"Owner resets to zero after collection"})}),x.settlementDone?e.jsx(G,{color:"green",children:"Settled"}):null,x.lastSettledAt?e.jsxs(G,{color:"default",children:["Last settled: ",String(x.lastSettledAt)]}):null]})]}),e.jsx(St,{open:r,title:N==="cash"?"Cash Transactions (Pending)":"Online Transactions (Pending)",onCancel:()=>{p(!1),E([])},footer:null,width:n?Math.min((typeof window<"u"?window.innerWidth:360)-24,520):800,children:e.jsx(Ze,{size:"small",rowKey:d=>`${d.dateTimeIso}-${d.sourceType}-${d.sourceId}`,dataSource:Q,loading:L,locale:L?{emptyText:" "}:void 0,columns:[{title:"Date",key:"date",render:(d,y)=>fe(y.dateTimeIso||y.date)},{title:"Customer",dataIndex:"customerName",key:"customer"},{title:"Mobile",dataIndex:"customerMobile",key:"mobile"},{title:"Source",key:"src",render:(d,y)=>`${String(y.sourceType||"").toUpperCase()} ${y.sourceId||""}`},{title:"Amount",key:"amt",align:"right",render:(d,y)=>(N==="cash"?y.cashPending:y.onlinePending).toLocaleString("en-IN")},{title:"UTR",key:"utr",render:(d,y)=>{if(String(y?.paymentMode||N||"").toLowerCase()==="cash")return"";const b=y?.utr??y?.utrNo??y?.reference??y?.ref,C=String(b??"").trim();return!C||C.toLowerCase()==="undefined"||C.toLowerCase()==="null"?"":C}}],pagination:{pageSize:n?6:10,size:n?"small":"default"},scroll:{x:"max-content"}})})]}),e.jsx(be,{size:"small",title:"Pending Summary",style:{width:"100%"},extra:e.jsx(Y,{size:"small",onClick:Ae,disabled:z,children:"Refresh"}),children:e.jsxs(ye,{direction:"vertical",style:{width:"100%"},size:12,children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs(G,{color:"orange",children:["Service Pending: ",Ee.service]}),e.jsxs(G,{color:"blue",children:["Sales Pending: ",Ee.sales]}),e.jsxs(G,{color:"geekblue",children:["Sales Balance: â‚¹ ",h(Ee.salesBalance)]}),je?e.jsxs(P,{type:"secondary",style:{fontSize:11},children:["Last refresh: ",fe(je)]}):null]}),e.jsxs("div",{children:[e.jsx(P,{strong:!0,children:"Service"}),e.jsx(P,{type:"secondary",style:{fontSize:12,marginLeft:6},children:"Pending Job Cards"}),e.jsx("div",{style:{marginTop:8,display:"grid",gap:8},children:z?e.jsx("div",{style:{padding:8},children:e.jsx(Je,{size:"small"})}):H.length?H.slice(0,8).map(d=>e.jsxs("div",{style:{padding:"8px 10px",border:"1px solid #f0f0f0",borderRadius:10,background:"#fff",display:"flex",alignItems:"center",gap:n?6:10,flexWrap:n?"wrap":"nowrap",fontSize:n?10:11},children:[e.jsx(P,{strong:!0,style:{fontSize:n?10:11,minWidth:n?0:110,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:n?"1 1 100%":"0 0 auto"},children:d.name||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:90,whiteSpace:"nowrap"},children:d.mobile||"â€”"}),e.jsx(P,{style:{fontSize:n?10:11,minWidth:n?0:140,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[d.model,d.regNo].filter(Boolean).join(" | ")||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:120,whiteSpace:"nowrap"},children:d.dateAt?fe(d.dateAt):""}),e.jsx(Y,{size:"small",type:"primary",style:{marginLeft:n?0:"auto",height:22,padding:"0 8px",fontSize:10},onClick:()=>te(d),children:"Post Service"})]},d.key)):e.jsx(Ne,{image:Ne.PRESENTED_IMAGE_SIMPLE,description:"No pending job cards"})})]}),e.jsx(Ce,{style:{margin:"6px 0"}}),e.jsxs("div",{children:[e.jsx(P,{strong:!0,children:"Sales"}),e.jsx(P,{type:"secondary",style:{fontSize:12,marginLeft:6},children:"Pending Balance (Bookings)"}),e.jsx("div",{style:{marginTop:8,display:"grid",gap:8,maxHeight:n?220:240,overflowY:"auto",paddingRight:4},children:z?e.jsx("div",{style:{padding:8},children:e.jsx(Je,{size:"small"})}):k.length?k.map(d=>e.jsxs("div",{style:{padding:"8px 10px",border:"1px solid #f0f0f0",borderRadius:10,background:"#fff",display:"flex",alignItems:"center",gap:n?6:10,flexWrap:n?"wrap":"nowrap",fontSize:n?10:11},children:[e.jsx(P,{strong:!0,style:{fontSize:n?10:11,minWidth:n?0:110,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:n?"1 1 100%":"0 0 auto"},children:d.name||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:90,whiteSpace:"nowrap"},children:d.mobile||"â€”"}),e.jsx(P,{style:{fontSize:n?10:11,minWidth:n?0:170,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[d.model,d.variant,d.color].filter(Boolean).join(" | ")||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:120,whiteSpace:"nowrap"},children:d.dateAt?fe(d.dateAt):""}),e.jsxs(G,{color:"blue",style:{marginLeft:n?0:"auto",fontSize:10,lineHeight:"14px",padding:"0 6px"},children:["â‚¹ ",h(d.balanceValue||0)]})]},d.key)):e.jsx(Ne,{image:Ne.PRESENTED_IMAGE_SIMPLE,description:"No pending balances"})})]})]})})]})}async function $e({GAS_URL:t,SECRET:s,branch:n,staff:i,mode:l}){const g=await Pe({webhookUrl:t,method:"GET",payload:{action:"staff_ledger_transactions",branch:n,staff:i,mode:l}}),j=g?.data||g||{};if(!j?.success)throw new Error("Failed");const v=Array.isArray(j.rows)?j.rows:[],o=r=>String(r??"").trim().toLowerCase(),f=r=>{const p=r?.dateTimeIso||r?.date,N=Number(new Date(String(p)));return Number.isFinite(N)?N:0},A=r=>{const p=o(r?.sourceId||r?.sourceID||r?.jcNo||r?.source||""),N=o(r?.dateTimeIso||r?.date||"");return[o(r?.branch),o(r?.staff),o(r?.sourceType),p||N,o(r?.customerMobile),o(r?.paymentMode),o(r?.cashAmount??r?.cashPending),o(r?.onlineAmount??r?.onlinePending),o(r?.utr)].join("|")},u=new Map;return v.forEach(r=>{const p=A(r),N=u.get(p);(!N||f(r)>=f(N))&&u.set(p,r)}),Array.from(u.values())}async function kt({GAS_URL:t,SECRET:s,branch:n}){if(!n)return[];const l=await Pe({webhookUrl:t,method:"GET",payload:{action:"list",branch:n,page:1,pageSize:1e4}}),c=l?.data||l||{},g=Array.isArray(c?.rows)?c.rows:Array.isArray(c?.data)?c.data:[],j=Te(n);return g.map((o,f)=>{const A=nt(o)||{},u=A.formValues||{},r=o?.values&&typeof o.values=="object"?o.values:o||{},p=u.branch||A.branch||r.Branch||r["Branch Name"]||r.Branch||"",N=It(A,r),B=u.jcNo||u.JCNo||A.jcNo||A.JCNo||u.serialNo||A.serialNo||r["JC No"]||r["JC No."]||r["Job Card No"]||"-";return{key:B||f,jcNo:B||"-",name:u.custName||u.name||r.Customer_Name||r["Customer Name"]||r.Customer||r.Name||"-",mobile:u.custMobile||u.mobile||r.Mobile||r["Mobile Number"]||r.Phone||"-",model:A.model||A.vehicle?.model||u.bikeModel||u.model||r.Model||"",regNo:u.regNo||r["Vehicle No"]||r.Vehicle_No||"",branch:String(p||"").trim(),dateAt:tt(A,r),postServiced:N}}).filter(o=>Te(o.branch)===j).filter(o=>!o.postServiced).sort((o,f)=>ke(f.dateAt)-ke(o.dateAt)).slice(0,50)}async function Dt({BOOKING_GAS_URL:t,BOOKING_SECRET:s,branch:n}){if(!n)return[];const i={action:"list",page:1,pageSize:1e4},l=n?{...i,branch:n}:i,c=await _e({webhookUrl:t,method:"GET",payload:l}),g=c?.data||c||{},j=Array.isArray(g?.rows)?g.rows:Array.isArray(g?.data)?g.data:[],v=Te(n);return j.map((f,A)=>{const u=nt(f)||{},r=u.formValues||{},p=f?.values&&typeof f.values=="object"?f.values:f||{},N=st(u.rawPayload,p?.["Raw Payload"],p?.rawPayload,p?.RawPayload,p?.rawpayload,f.rawPayload,f.payload?.rawPayload),B=r.branch||u.branch||p.Branch||p["Branch Name"]||p.Branch||"",{balanceValue:Q,balanceLabel:E}=zt({payload:u,values:p,rawPayload:N});return{key:r.bookingId||u.bookingId||p["Booking ID"]||p.Booking_Id||p["Booking Id"]||A,bookingId:r.bookingId||u.bookingId||p["Booking ID"]||p.Booking_Id||p["Booking Id"]||"",name:r.custName||r.name||p.Customer_Name||p["Customer Name"]||p.Customer||p.Name||"-",mobile:r.custMobile||r.mobile||p.Mobile||p["Mobile Number"]||p.Phone||"-",model:u.model||u.vehicle?.model||r.bikeModel||r.model||p.Model||"",variant:u.variant||u.vehicle?.variant||r.variant||p.Variant||"",color:u.color||u.vehicle?.color||r.color||p.Color||p.Colour||p["Vehicle Color"]||p["Vehicle Colour"]||"",branch:String(B||"").trim(),dateAt:tt(u,p),balanceValue:Q,balanceLabel:E}}).filter(f=>Te(f.branch)===v).filter(f=>Number(f.balanceValue||0)>ot).sort((f,A)=>ke(A.dateAt)-ke(f.dateAt))}const Te=t=>String(t||"").trim().toLowerCase(),ke=t=>{if(!t)return 0;const s=t instanceof Date?t:new Date(String(t)),n=Number(s.getTime());return Number.isFinite(n)?n:0},tt=(t={},s={})=>{const n=[t.postServiceAt,t.savedAt,t.ts,t.tsMs,t.createdAt,s["Post Service At"],s.PostServiceAt,s.Post_Service_At,s["Saved At"],s.savedAt,s.Timestamp,s.timestamp,s.DateTime,s["Date Time"],s.Date_Time,s["Submitted At"],s.SubmittedAt,s.submittedAt,s["Created At"],s.CreatedAt,s.createdAt].find(l=>l!=null&&String(l).trim()!=="");if(!n)return null;const i=n instanceof Date?n:new Date(String(n));return Number.isFinite(i.getTime())?i:null},nt=t=>{if(!t)return null;if(t.payload&&typeof t.payload=="object")return t.payload;if(typeof t.payload=="string")try{return JSON.parse(t.payload)}catch{}const s=t.values&&(t.values.Payload||t.values.payload||t.values.PAYLOAD)||t.Payload||t.PAYLOAD;if(typeof s=="string")try{return JSON.parse(s)}catch{}return t.formValues&&(t.followUp||t.savedAt||t.postServiceAt)?t:null},It=(t={},s={})=>{if(t.postServiceAt||Array.isArray(t.payments)&&t.payments.some(l=>Number(l?.amount||0)>0)||s["Post Service At"]||s.PostServiceAt||s.Post_Service_At)return!0;const i=l=>String(s[l]||"").trim().toLowerCase();return!!["yes","done","completed","true"].includes(i("Post Service"))},T=t=>{if(t==null||t==="")return 0;const s=String(t).replace(/[^0-9.-]/g,""),n=Number(s);return Number.isFinite(n)?n:0},ze=t=>{if(t==null)return null;if(typeof t=="object")return t;if(typeof t!="string")return null;try{return JSON.parse(t)}catch{return null}},st=(...t)=>{for(const s of t){if(!s&&s!==0)continue;if(typeof s=="object")return s;const n=ze(s);if(n)return n}return null},$=t=>{const s=Number(t);return Number.isFinite(s)&&s>=0?s:null},ot=.01,Ue=/balance/i,Fe=t=>{if(t==null)return{found:!1};const s=typeof t;if(s==="object"||s==="boolean")return{found:!1};if((s==="string"?t.trim():String(t).trim())==="")return{found:!1};const i=T(t);return Number.isFinite(i)?{found:!0,value:i}:{found:!1}},ie=t=>{const s=Fe(t);return s.found?s.value:null},Et=(t,s=[])=>{if(!(!t||!s.length))return s.reduce((n,i)=>{if(!(!n||typeof n!="object"))return n[i]},t)},Be=(t,s=[])=>{if(!Array.isArray(t))return[];const n=[];for(const i of t)if(!(!i||typeof i!="object"))for(const l of s){const c=Et(i,l);if(c==null)continue;const g=Fe(c);g.found&&n.push(g.value)}return n},xe=(t,s,n=3,i=new WeakSet)=>{if(!t||typeof t!="object"||n<0)return[];if(i.has(t))return[];i.add(t);const l=Array.isArray(t)?t.map((g,j)=>[String(j),g]):Object.entries(t),c=[];for(const[g,j]of l){if(s.test(String(g||""))){const v=Fe(j);v.found&&c.push(v.value)}if(j&&typeof j=="object")c.push(...xe(j,s,n-1,i));else if(typeof j=="string"){const v=ze(j);v&&typeof v=="object"&&c.push(...xe(v,s,n-1,i))}}return c},Mt=(...t)=>{const s=[],n=i=>{if(!(!i||typeof i!="object")){if(Array.isArray(i)){i.forEach(n);return}"payments"in i&&Array.isArray(i.payments)&&n(i.payments),"paymentSplit"in i&&Array.isArray(i.paymentSplit)&&i.paymentSplit.forEach(l=>{l&&typeof l=="object"&&s.push(l)}),"paymentDetails"in i&&Array.isArray(i.paymentDetails)&&n(i.paymentDetails),!("payments"in i)&&!("paymentSplit"in i)&&!("paymentDetails"in i)&&s.push(i)}};return t.forEach(i=>{if(i){if(Array.isArray(i)){i.forEach(n);return}if(typeof i=="string"){try{const l=JSON.parse(i);n(l)}catch{return}return}n(i)}}),s},Ot=({payload:t,values:s,rawPayload:n})=>{const i=s||{},l=Mt(t?.payments,i.payments,i.paymentDetails,t?.paymentSplit,i.paymentSplit,n?.payments,n?.paymentSplit,n?.paymentDetails),c={cash:0,online:0,total:0};l.forEach(f=>{const A=$(f?.amount);if(A===null)return;const u=String(f?.mode||"").trim().toLowerCase();u==="cash"?c.cash+=A:u==="online"&&(c.online+=A),c.total+=A});const g=$(t?.dp?.totalDp)??$(t?.totalDp)??$(t?.downPayment)??$(i.totalDp)??$(i.downPayment)??$(n?.dp?.totalDp)??$(n?.totalDp)??$(n?.downPayment),j=g!==null,v=j?g:0,o=Math.max(0,v-c.total);return{cashCollected:c.cash,onlineCollected:c.online,totalCollected:c.total,totalDp:v,balancedDp:o,hasTotals:j}},Ye=t=>{const s=t?.payload||{},n=t?.values||{},i=["purchaseMode","purchase_mode","purchase type","Purchase Mode","Purchase_Mode","Purchase Type","paymentMode","payment_mode","Payment Mode","Payment Type","paymentType","payment_type"],c=[s.purchaseMode,s.purchaseType,s.paymentType,...i.map(g=>n[g])].find(g=>typeof g=="string"&&g.trim());return String(c||"cash").trim().toLowerCase()},Rt=t=>{if(!t)return!1;const s=String(t).trim().toLowerCase();return["loan","nohp","hp","finance"].includes(s)},Ut=({payload:t={},values:s={},rawPayload:n=null,purchaseType:i}={})=>{if(!t||typeof t!="object")return{pendingAmount:null,pendingLabel:""};const l=st(n,s?.rawPayload,s?.["Raw Payload"],t?.rawPayload,t?.["Raw Payload"])||{},c=[T(t?.bookingAmount),T(s?.["Booking Amount"]),T(s?.bookingAmount),T(s?.Booking_Amount),T(l?.bookingAmount)].find(N=>N>0)??0,g=[T(l?.totalVehicleCost),T(l?.cash?.totalVehicleCost),T(l?.cash?.onRoadPrice),T(t?.totalVehicleCost),T(t?.onRoadPrice),T(s?.["Total Vehicle Cost"]),T(s?.["On Road Price"])].find(N=>N>0)??0,j=[T(l?.totalDp),T(l?.dp?.totalDp),T(t?.totalDp),T(t?.dp?.totalDp),T(s?.["Total DP"])].find(N=>N>0)??0,v=T(l?.downPayment||t?.downPayment||s?.["Down Payment"])+T(l?.extraFittingAmount||t?.extraFittingAmount||s?.["Extra Fitting Amount"])+T(l?.affidavitCharges||t?.affidavitCharges||s?.["Affidavit Charges"]),o=j||v||0,f=String(i||t?.purchaseMode||s?.["Purchase Mode"]||l?.purchaseMode||"cash").trim().toLowerCase(),A=["loan","nohp","hp","finance"].includes(f),u=A?"Balanced DP":"Balance Amount",r=A?o-c:g-c;return{pendingAmount:Math.max(0,Number.isFinite(r)?r:0),pendingLabel:u}},Bt=[["dp","balancedDp"],["dp","balanceTP"],["dp","balanceTPIC"],["balanceTP"],["balancedDp"],["balance"]],Lt=[["balancedAmount"],["balanceAmount"],["cash","balancedAmount"],["balance"],["dp","balancedDp"]],_t=[["cash","totalVehicleCost"],["cash","onRoadPrice"],["cash","price"],["vehicle","totalVehicleCost"],["vehicle","onRoadPrice"],["vehicle","price"],["totalVehicleCost"],["onRoadPrice"],["price"]],zt=({payload:t={},values:s={},rawPayload:n=null})=>{const i=[];if(t&&typeof t=="object"&&i.push(t),s&&typeof s=="object"&&i.push(s),n){const _=ze(n);_&&typeof _=="object"&&i.push(_)}const l={payload:t,values:s},c=Rt(Ye(l)),g=Ot({payload:t,values:s,rawPayload:n}),j=Ut({payload:t,values:s,rawPayload:n,purchaseType:Ye(l)}),v=Be(i,Lt),o=Be(i,Bt),f=Be(i,_t),A=Number.isFinite(g.totalCollected)?g.totalCollected:0,u=f.length?Math.max(...f):null,r=u!==null?Math.max(0,u-A):null,p=ie(t?.cash?.balancedAmount)??ie(t?.balancedAmount)??ie(s?.balancedAmount)??ie(s?.balanceAmount)??(v.length?Math.max(...v):null)??(r!==null?r:null),N=ie(t?.dp?.balancedDp)??ie(t?.balancedDp)??ie(s?.balancedDp)??(o.length?Math.max(...o):null)??(g.hasTotals?g.balancedDp:null),B=Number.isFinite(j?.pendingAmount)?j.pendingAmount:null,Q=j?.pendingLabel||"";let E=B!==null?B:c&&N!==null?N:p;if(E===null||!Number.isFinite(E)){const _=xe(t,Ue,3),le=xe(s,Ue,2),X=n&&typeof n=="object"?xe(n,Ue,2):[],z=[..._,...le,...X].filter(se=>Number.isFinite(se)&&se>ot);z.length&&(E=Math.max(...z))}const L=Q||(c&&E!==null?"Balanced DP":"Balanced Amount");return{balanceValue:Number(E||0),balanceLabel:L}};function fe(t){try{if(!t)return"";const s=t instanceof Date?t:new Date(String(t));if(Number.isNaN(s.getTime()))return String(t);const n=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0"),c=String(s.getHours()).padStart(2,"0"),g=String(s.getMinutes()).padStart(2,"0");return`${l}-${i}-${n} ${c}:${g}`}catch{return String(t||"")}}function Rn(){const s=!et.useBreakpoint().md,[n,i]=Le.useState(""),l={maxWidth:1200,margin:"0 auto",padding:s?12:16},c={paddingTop:12,width:"100%",overflowX:"auto",minWidth:0},{hasNew:g,latestItem:j}=gt(),v=u=>u==="alert"?"#fa541c":u==="warning"?"#faad14":"#2f54eb",o=()=>g?e.jsx("span",{style:{marginLeft:6,padding:"0 6px",borderRadius:10,fontSize:11,color:"#fff",fontWeight:700,background:v(j?.type),display:"inline-block",animation:"annPulse 1.6s ease-in-out infinite"},children:"NEW"}):null,f=(u,r)=>e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:8},children:[e.jsx("span",{"aria-hidden":!0,style:{fontSize:16},children:u}),e.jsx("span",{children:r})]});Le.useEffect(()=>{(async()=>{try{let u=null;try{const p=localStorage.getItem("user");u=p?JSON.parse(p):null}catch{}if(!u){const p=await Qe().catch(()=>null);if(p?.success&&p.data){u=p.data;try{localStorage.setItem("user",JSON.stringify(u))}catch{}}}const r=u?.formDefaults?.branchName||u?.primaryBranch?.name||(Array.isArray(u?.branches)?typeof u.branches[0]=="string"?u.branches[0]:u.branches[0]?.name||"":"");i(r||"")}catch{i("")}})()},[]);const A=[{key:"quotation",label:f("ğŸ§¾","Quotation"),children:e.jsx("div",{style:c,children:e.jsx(rt,{})})},{key:"jobcard",label:f("ğŸ”§","Job Card"),children:e.jsx("div",{style:c,children:e.jsx(it,{})})},{key:"followups",label:f("ğŸ“","Follow-ups"),children:e.jsx("div",{style:c,children:e.jsx(At,{})})},{key:"booking",label:f("ğŸ“…","Booking"),children:e.jsx("div",{style:c,children:e.jsx(dt,{})})},{key:"vehicle-search",label:f("ğŸï¸","Vehicle Search"),children:e.jsx("div",{style:c,children:e.jsx(mt,{})})},{key:"stock",label:f("ğŸ”","Stock Finder"),children:e.jsx("div",{style:c,children:e.jsx(ut,{})})},{key:"stock-update",label:f("ğŸ“¦","Stock Update"),children:e.jsx("div",{style:c,children:e.jsx(ht,{})})},{key:"minorsales",label:e.jsxs(e.Fragment,{children:[e.jsx("style",{children:"@keyframes annPulse{0%{transform:scale(1);}60%{transform:scale(1.05);}100%{transform:scale(1);}}"}),e.jsxs("span",{children:[f("ğŸ›’","Minor Sales"),e.jsx(o,{})]})]}),children:e.jsx("div",{style:c,children:e.jsx(Ct,{})})},{key:"account",label:f("ğŸ’¼","Account"),children:e.jsx("div",{style:c,children:e.jsx(Tt,{})})},{key:"announcements",label:e.jsxs(e.Fragment,{children:[e.jsx("style",{children:"@keyframes annPulse{0%{transform:scale(1);}60%{transform:scale(1.05);}100%{transform:scale(1);}}"}),e.jsxs("span",{children:[f("ğŸ“£","Announcements"),e.jsx(o,{})]})]}),children:e.jsx("div",{style:c,children:e.jsx(yt,{})})}];return e.jsxs("div",{style:l,children:[e.jsx("h2",{style:{marginTop:0,display:"flex",alignItems:"baseline",flexWrap:"wrap",gap:s?8:12,lineHeight:1.15},children:n?e.jsx("span",{title:"Your branch",style:{marginLeft:0,fontSize:s?18:28,fontWeight:800,letterSpacing:.3,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",lineHeight:1.1,background:"linear-gradient(90deg,#2f54eb 0%, #13c2c2 45%, #52c41a 100%)",WebkitBackgroundClip:"text",backgroundClip:"text",color:"transparent",textShadow:"0 1px 1px rgba(0,0,0,0.08)"},children:n}):null}),e.jsx(Xe,{defaultActiveKey:"quotation",items:A,tabPosition:"top",size:s?"small":"middle",tabBarGutter:s?8:16,tabBarStyle:{marginBottom:s?8:12},style:{width:"100%"},destroyInactiveTabPane:!0})]})}export{Rn as default};
