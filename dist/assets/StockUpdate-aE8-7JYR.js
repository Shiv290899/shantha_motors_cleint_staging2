import{r as o,j as t}from"./index-Ieo0N9F3.js";import{d as We}from"./index-D-crTbsR.js";import{g as ht,h as Wt,e as Dt,i as Ht,B as Ut,d as ft,u as qt,f as Yt,j as Gt,k as Qt,r as Jt}from"./BookingForm-BhvUDOyf.js";import{d as Kt,l as Xt,A as Zt}from"./caseInsensitive-D16MNlnB.js";import{G as es}from"./index-HpyCPvYK.js";import{R as gt,F as B}from"./index-DhuOMrZ7.js";import{s as b,I as ae}from"./index-CD4YwGtV.js";import{S,R as ie}from"./index-CY9tsZK0.js";import{B as P,c as ts}from"./button-CnzkbVQB.js";import{S as L}from"./index-D7eBwa3z.js";import{T as Ce}from"./index-Bu8NwQ7H.js";import{m as ss,C as yt,P as ns,Q as as,f as He,n as rs,p as os,O as ls,z as is,A as M,T as cs}from"./TextArea-CAqhmoVd.js";import{A as ds,M as pt}from"./index-DJnp3ZGz.js";import{F as ms}from"./Table-Dhv4ytuv.js";const us=r=>{const{componentCls:d,iconCls:l,antCls:a,zIndexPopup:c,colorText:h,colorWarning:m,marginXXS:y,marginXS:x,fontSize:I,fontWeightStrong:V,colorTextHeading:T}=r;return{[d]:{zIndex:c,[`&${a}-popover`]:{fontSize:I},[`${d}-message`]:{marginBottom:x,display:"flex",flexWrap:"nowrap",alignItems:"start",[`> ${d}-message-icon ${l}`]:{color:m,fontSize:I,lineHeight:1,marginInlineEnd:x},[`${d}-title`]:{fontWeight:V,color:T,"&:only-child":{fontWeight:"normal"}},[`${d}-description`]:{marginTop:y,color:h}},[`${d}-buttons`]:{textAlign:"end",whiteSpace:"nowrap",button:{marginInlineStart:x}}}}},hs=r=>{const{zIndexPopupBase:d}=r;return{zIndexPopup:d+60}},xt=ss("Popconfirm",r=>us(r),hs,{resetStyle:!1});var fs=function(r,d){var l={};for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&d.indexOf(a)<0&&(l[a]=r[a]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,a=Object.getOwnPropertySymbols(r);c<a.length;c++)d.indexOf(a[c])<0&&Object.prototype.propertyIsEnumerable.call(r,a[c])&&(l[a[c]]=r[a[c]]);return l};const vt=r=>{const{prefixCls:d,okButtonProps:l,cancelButtonProps:a,title:c,description:h,cancelText:m,okText:y,okType:x="primary",icon:I=o.createElement(gt,null),showCancel:V=!0,close:T,onConfirm:N,onCancel:J,onPopupClick:u}=r,{getPrefixCls:w}=o.useContext(yt),[j]=ns("Popconfirm",as.Popconfirm),z=ht(c),K=ht(h);return o.createElement("div",{className:`${d}-inner-content`,onClick:u},o.createElement("div",{className:`${d}-message`},I&&o.createElement("span",{className:`${d}-message-icon`},I),o.createElement("div",{className:`${d}-message-text`},z&&o.createElement("div",{className:`${d}-title`},z),K&&o.createElement("div",{className:`${d}-description`},K))),o.createElement("div",{className:`${d}-buttons`},V&&o.createElement(P,Object.assign({onClick:J,size:"small"},a),m||j?.cancelText),o.createElement(ds,{buttonProps:Object.assign(Object.assign({size:"small"},ts(x)),l),actionFn:N,close:T,prefixCls:w("btn"),quitOnNullishReturnValue:!0,emitEvent:!0},y||j?.okText)))},ps=r=>{const{prefixCls:d,placement:l,className:a,style:c}=r,h=fs(r,["prefixCls","placement","className","style"]),{getPrefixCls:m}=o.useContext(yt),y=m("popconfirm",d),[x]=xt(y);return x(o.createElement(Wt,{placement:l,className:He(y,a),style:c,content:o.createElement(vt,Object.assign({prefixCls:y},h))}))};var gs=function(r,d){var l={};for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&d.indexOf(a)<0&&(l[a]=r[a]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,a=Object.getOwnPropertySymbols(r);c<a.length;c++)d.indexOf(a[c])<0&&Object.prototype.propertyIsEnumerable.call(r,a[c])&&(l[a[c]]=r[a[c]]);return l};const ys=o.forwardRef((r,d)=>{var l,a;const{prefixCls:c,placement:h="top",trigger:m="click",okType:y="primary",icon:x=o.createElement(gt,null),children:I,overlayClassName:V,onOpenChange:T,onVisibleChange:N,overlayStyle:J,styles:u,classNames:w}=r,j=gs(r,["prefixCls","placement","trigger","okType","icon","children","overlayClassName","onOpenChange","onVisibleChange","overlayStyle","styles","classNames"]),{getPrefixCls:z,className:K,style:ce,classNames:X,styles:_}=rs("popconfirm"),[de,E]=os(!1,{value:(l=r.open)!==null&&l!==void 0?l:r.visible,defaultValue:(a=r.defaultOpen)!==null&&a!==void 0?a:r.defaultVisible}),W=(C,v)=>{E(C,!0),N?.(C),T?.(C,v)},U=C=>{W(!1,C)},ke=C=>{var v;return(v=r.onConfirm)===null||v===void 0?void 0:v.call(void 0,C)},re=C=>{var v;W(!1,C),(v=r.onCancel)===null||v===void 0||v.call(void 0,C)},Be=(C,v)=>{const{disabled:oe=!1}=r;oe||W(C,v)},q=z("popconfirm",c),$=He(q,K,V,X.root,w?.root),me=He(X.body,w?.body),[ue]=xt(q);return ue(o.createElement(Dt,Object.assign({},ls(j,["title"]),{trigger:m,placement:h,onOpenChange:Be,open:de,ref:d,classNames:{root:$,body:me},styles:{root:Object.assign(Object.assign(Object.assign(Object.assign({},_.root),ce),J),u?.root),body:Object.assign(Object.assign({},_.body),u?.body)},content:o.createElement(vt,Object.assign({okType:y,icon:x},r,{prefixCls:q,close:U,onConfirm:ke,onCancel:re})),"data-popover-inject":!0}),I))}),St=ys;St._InternalPanelDoNotUseOrYouWillBeFired=ps;const xs=r=>{if(r==null)return"";if(r instanceof Date)return r.toISOString();if(Array.isArray(r))return r.join("; ");if(typeof r=="object")try{return JSON.stringify(r)}catch{return String(r)}return String(r)},De=r=>{const d=xs(r).replace(/\r\n/g,`
`).replace(/\r/g,`
`),l=/["\n,]/.test(d),a=d.replace(/"/g,'""');return l?`"${a}"`:a},vs=(r=[],d=[])=>{const l=r.map(c=>De(c.label??c.key??c)),a=d.map(c=>r.map(h=>{const m=typeof h=="string"?h:h.key||h.dataIndex;return typeof h.value=="function"?De(h.value(c)):De(m?c?.[m]:"")}).join(","));return[l.join(","),...a].join(`
`)},Ss=(r,d)=>{const l=new Blob([d],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(l),c=document.createElement("a");c.href=a,c.download=r||"export.csv",c.click(),setTimeout(()=>URL.revokeObjectURL(a),500)},js=({filename:r="export.csv",headers:d=[],rows:l=[]})=>{if(!Array.isArray(l)||!l.length)return!1;const a=vs(d,l);return Ss(r,a),!0},Cs="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYGuNPY_2ivfS7MTX4bWiu1DWdF2mrHSCnmTznZVEHxNmsrgcGWjVZN4UDUTOzQQdXTnbeM-ylCJbB/pub?gid=408799621&single=true&output=csv",be={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"],color:["Color","Colours","Colors","Colour","Available Colors"]},bs=r=>{const d=[];let l=[],a="",c=!1;for(let h=0;h<r.length;h++){const m=r[h],y=r[h+1];if(m==='"'&&!c){c=!0;continue}if(m==='"'&&c){if(y==='"'){a+='"',h++;continue}c=!1;continue}if(m===","&&!c){l.push(a),a="";continue}if((m===`
`||m==="\r")&&!c){(a!==""||l.length)&&(l.push(a),d.push(l),l=[],a=""),m==="\r"&&y===`
`&&h++;continue}a+=m}return(a!==""||l.length)&&(l.push(a),d.push(l)),d},ws=async r=>{const d=await fetch(r,{cache:"no-store"});if(!d.ok)throw new Error("Sheet fetch failed");const l=await d.text();if(l.trim().startsWith("<"))throw new Error("Expected CSV, got HTML");const a=bs(l);if(!a.length)return[];const c=a[0].map(h=>(h||"").trim());return a.slice(1).map(h=>{const m={};return c.forEach((y,x)=>m[y]=h[x]??""),m})},we=(r,d)=>String(d.map(l=>r[l]??"").find(l=>l!=="")||"").trim(),ks=r=>r?String(r).split(/[|,/;\n]+/).map(d=>d.trim()).filter(Boolean):[],Bs=(r={})=>({company:we(r,be.company),model:we(r,be.model),variant:we(r,be.variant),color:we(r,be.color)});function Ts(){const{useBreakpoint:r}=es,l=!r().md,[a]=B.useForm(),[c,h]=o.useState([]),[m,y]=o.useState(""),[x,I]=o.useState(""),[V,T]=o.useState(""),[N,J]=o.useState(!1),[u,w]=o.useState("add"),[j,z]=o.useState(null),[K,ce]=o.useState(!1),[X,_]=o.useState(!1),[de,E]=o.useState(""),[W,U]=o.useState(null),[ke,re]=o.useState(!1),[Be,q]=o.useState(null),[$,me]=o.useState(null),[ue,C]=o.useState(!1),[v,oe]=o.useState([]),[Ue,Z]=o.useState(!1),[jt,qe]=o.useState(1),[Ye,Ct]=o.useState(25),[Te,Ge]=o.useState([]),[k,Qe]=o.useState("all"),[le,Je]=o.useState("all"),[Ne,Ke]=o.useState(""),[Oe,Me]=o.useState(""),[Xe,Ze]=o.useState([]),[et,tt]=o.useState(!1),[st,he]=o.useState(null),[nt,fe]=o.useState(null),Pe=e=>String(e||"").toLowerCase().normalize("NFKD").replace(/[^a-z0-9]/g,""),at=o.useMemo(()=>{const e=String(m||"").toLowerCase();return e?/^hero$/i.test(m)||e.includes("hero")?["Poorna Motors","Sai Bikes"]:/^honda$/i.test(m)||e.includes("honda")?["Silicon Honda","Springs Honda"]:[]:[]},[m]),R=o.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}},[]),g=o.useMemo(()=>R?.formDefaults?.branchName||R?.primaryBranch?.name||(Array.isArray(R?.branches)?R.branches[0]?.name:void 0)||"",[R]),ee=o.useMemo(()=>String(R?.role||"").toLowerCase(),[R]),Y=o.useMemo(()=>["staff","mechanic","employees"].includes(ee),[ee]),A=o.useMemo(()=>["admin","owner","backend"].includes(ee),[ee]),pe=Y,bt=A,D=o.useMemo(()=>A?k==="all"?"all":k||g||"":g||"",[A,k,g]),wt=o.useMemo(()=>{const e=(v||[]).filter(n=>String(n.action||"").toLowerCase()==="transfer"&&String(n.transferStatus||"").toLowerCase()==="pending");if(A&&D==="all")return e;const s=Pe(D||g||"");return e.filter(n=>Pe(n.targetBranch)===s)},[v,D,g,A,Pe]),ge=Xe.length?Xe:wt,rt=o.useMemo(()=>Y?g||"self":k==="all"?"all":k||"all",[Y,g,k]),Ie=o.useMemo(()=>`StockMovements:list:${JSON.stringify({role:ee||"",branch:rt})}`,[ee,rt]);o.useEffect(()=>{(async()=>{try{const s=(await ws(Cs)).map(Bs).filter(n=>n.company&&n.model&&n.variant);h(s),J(s.length>0)}catch{h([]),J(!1)}})()},[]),o.useEffect(()=>{(async()=>{try{const s=(await Kt({limit:100,status:"active"}).catch(()=>null))?.data?.items||[],n=(Array.isArray(s)&&s.length?s:(await Xt({status:"active",limit:100})).data.items)||[],f=Array.from(new Set(n.map(i=>String(i?.name||"").trim()).filter(Boolean)));Ge(f)}catch{Ge([])}})()},[]),o.useEffect(()=>{try{const e=localStorage.getItem(Ie);if(!e){Z(!1);return}const s=JSON.parse(e);s&&Array.isArray(s.items)?(oe(s.items),Z(!0)):Z(!1)}catch{Z(!1)}},[Ie]);const kt=o.useMemo(()=>[...new Set(c.map(e=>e.company))],[c]),Bt=o.useMemo(()=>[...new Set(c.filter(e=>e.company===m).map(e=>e.model))],[c,m]),Tt=o.useMemo(()=>[...new Set(c.filter(e=>e.company===m&&e.model===x).map(e=>e.variant))],[c,m,x]),Ee=o.useMemo(()=>[{name:"White",hex:"#ffffff",border:"#e5e7eb"},{name:"Black",hex:"#111827"},{name:"Mat Grey",hex:"#6b7280"},{name:"Red",hex:"#ef4444"},{name:"Blue",hex:"#2563eb"},{name:"Decent Blue",hex:"#3b82f6"},{name:"PS Blue",hex:"#1e3a8a"},{name:"Deep Ground Grey",hex:"#374151"},{name:"Brown",hex:"#8b4513"},{name:"Yellow",hex:"#f59e0b"},{name:"Purple",hex:"#8b5cf6"},{name:"Genny Grey",hex:"#9ca3af"},{name:"Militery Green",hex:"#4b5320"},{name:"Silver",hex:"#c0c0c0",border:"#9ca3af"},{name:"Orange",hex:"#f97316"},{name:"Starlight Blue",hex:"#60a5fa"},{name:"Gold",hex:"#d4af37"},{name:"Copper",hex:"#b87333"},{name:"Maroon",hex:"#800000"}],[]),te=o.useMemo(()=>{const e=c.filter(n=>n.company===m&&n.model===x&&n.variant===V).flatMap(n=>ks(n.color)),s=new Map;return e.forEach(n=>{const f=String(n).toLowerCase();s.has(f)||s.set(f,n)}),Array.from(s.values())},[c,m,x,V]),Ae=o.useMemo(()=>te.length?te:Ee.map(e=>e.name),[te,Ee]),ot=e=>{const s=Ee.find(n=>n.name.toLowerCase()===String(e||"").toLowerCase());return{bg:s?.hex||"#d1d5db",border:s?.border||"#d1d5db"}},Nt=e=>{y(e),I(""),T(""),a.setFieldsValue({model:void 0,variant:void 0,color:void 0})},Ot=e=>{I(e),T(""),a.setFieldsValue({variant:void 0,color:void 0})},Mt=e=>{T(e),a.setFieldsValue({color:void 0})},se=o.useCallback(async()=>{tt(!0);try{const e=await Ht({branch:D||void 0});!(e?.success??e?.ok)&&e?.message&&b.warning(e.message==="Token Invalid"?"Session expired. Please log in again to admit/reject transfers.":e.message);const f=(Array.isArray(e?.data)?e.data:[]).map((i,p)=>({key:i.movementId||p+1,movementId:i.movementId||"",chassis:i.chassisNo||"",company:i.company||"",model:i.model||"",variant:i.variant||"",color:i.color||"",sourceBranch:i.sourceBranch||"",targetBranch:i.targetBranch||"",notes:i.notes||"",createdByName:i.createdByName||"",ts:Re(i)}));Ze(f)}catch{Ze([])}finally{tt(!1)}},[D]),Pt=async()=>{let e=!1;try{E("");const s=await a.validateFields();ce(!0);const n=(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}})(),f={Chassis_No:String(s.chassis||"").toUpperCase(),Company:s.company||"",Model:s.model||"",Variant:s.variant||"",Color:s.color||"",Action:u,Target_Branch:u==="transfer"&&s.targetBranch||"",Return_To:u==="return"&&s.returnTo||"",Customer_Name:u==="invoice"&&s.customerName||"",Source_Branch:s.sourceBranch||"",Notes:(()=>{const i=String(s.notes||"").trim(),p=u==="add"?String(s.franchise||"").trim():"";return p?i?`${i} | Franchise: ${p}`:`Franchise: ${p}`:i})()};if(W){const i=await qt(W,f);if(e=!!(i?.success??i?.ok),e)b.success("Stock movement updated."),E("");else{const p=i?.message||"Update failed";E(p),b.error(p)}}else{const i=await ft({data:f,createdBy:n?.name||n?.email||"user"});if(e=!!(i?.success??i?.ok),e){const p=u==="transfer"?"Transfer recorded and waiting for admit by the target branch.":"Stock movement saved.";b.success(p),E("")}else{const p=i?.message||"Save failed";E(p),b.error(p)}}if(!e)return;a.resetFields(["chassis","notes","targetBranch","returnTo","customerName","franchise"]),_(!1),U(null),z(null),G(),u==="transfer"&&se()}catch(s){if(s?.errorFields)return;const n=s?.response?.data?.message||s?.message;E(n||"Failed to save. Check configuration or network."),b.error(n||"Failed to save. Check configuration or network.")}finally{ce(!1)}},O=e=>t.jsx("strong",{style:{fontWeight:700},children:e}),Fe=!!W,F=u!=="add"&&!Fe,lt=u!=="add"||Fe,ye=pe||u!=="add";o.useEffect(()=>{if(F||te.length!==1)return;a.getFieldValue("color")||a.setFieldsValue({color:te[0]})},[te,a,F]);const G=async()=>{C(!0);try{const e=Y?g:k==="all"?void 0:k,s=async i=>{const ne=[],H=new Set;let ze=1,Ve=null;for(;ze<=40;){const $e=await i({limit:5e3,page:ze}),Le=Array.isArray($e?.data)?$e.data:[],_e=Number($e?.total);if(Number.isFinite(_e)&&_e>0&&(Ve=_e),!Le.length)break;let mt=0;if(Le.forEach(je=>{const ut=String(je?.movementId||je?._id||"").trim()||JSON.stringify(je);H.has(ut)||(H.add(ut),ne.push(je),mt+=1)}),mt===0||Ve&&ne.length>=Ve||Le.length<500)break;ze+=1}return ne},f=(Y?await s(({limit:i,page:p})=>Yt({branch:e,limit:i,page:p})):await s(({limit:i,page:p})=>Gt({branch:e,mode:void 0,limit:i,page:p}))).map((i,p)=>{const Se=String(i.status||"").toLowerCase(),ne=String(i.transferStatus||"").toLowerCase();let H=String(i.action||"").toLowerCase();return H||(ne&&ne!=="completed"?H="transfer":Se==="in_stock"||Se==="in stock"?H="add":Se==="out"&&(H="invoice")),{key:p+1,ts:Re(i),chassis:i.chassisNo||"",company:i.company||"",model:i.model||"",variant:i.variant||"",color:i.color||"",action:H||"",targetBranch:i.targetBranch||"",returnTo:i.returnTo||"",customerName:i.customerName||"",sourceBranch:i.sourceBranch||"",lastSourceBranch:i.lastSourceBranch||"",notes:i.notes||"",movementId:i.movementId||"",transferStatus:i.transferStatus||"",resolvedByName:i.resolvedByName||"",resolvedAt:i.resolvedAt||""}});oe(f),Z(!0);try{localStorage.setItem(Ie,JSON.stringify({at:Date.now(),items:f}))}catch{}}catch{Ue||oe([]),Z(!1)}finally{C(!1)}},It=async e=>{he(e),fe("admit");try{const s=await Qt(e);if(!s?.success)throw new Error(s?.message||"Admit failed");b.success("Transfer admitted to this branch."),await G()}catch(s){b.error(s?.message||"Failed to admit transfer.")}finally{he(null),fe(null),await se()}},Et=async e=>{he(e),fe("reject");try{const s=await Jt(e);if(!s?.success)throw new Error(s?.message||"Reject failed");b.success("Transfer rejected; stock stays in source branch."),await G()}catch(s){b.error(s?.message||"Failed to reject transfer.")}finally{he(null),fe(null),await se()}};o.useEffect(()=>{G()},[g]),o.useEffect(()=>{A&&G()},[A,k]),o.useEffect(()=>{se()},[se]),o.useEffect(()=>{X&&pe&&g&&a.setFieldsValue({sourceBranch:g})},[X,pe,g,a]);const At=e=>{try{U(e?.movementId||null),z(null),E("");const s=String(e?.action||"add").toLowerCase();w(s),y(e?.company||""),I(e?.model||""),T(e?.variant||"");const n={chassis:e?.chassis||e?.chassisNo||void 0,company:e?.company||void 0,model:e?.model||void 0,variant:e?.variant||void 0,color:e?.color||void 0,sourceBranch:e?.sourceBranch||g||void 0,targetBranch:e?.targetBranch||void 0,returnTo:e?.returnTo||void 0,customerName:e?.customerName||void 0,notes:e?.notes||void 0};a.setFieldsValue(n),_(!0)}catch{}},it=(e,s)=>{if(!(!s||!e))try{U(null),z([e]),E(""),w(e),y(s?.company||""),I(s?.model||""),T(s?.variant||""),a.resetFields();const n={chassis:s?.chassis||s?.chassisNo||void 0,company:s?.company||void 0,model:s?.model||void 0,variant:s?.variant||void 0,color:s?.color||void 0,sourceBranch:s?.sourceBranch||s?.lastSourceBranch||g||void 0,targetBranch:void 0,returnTo:void 0,customerName:void 0,notes:void 0};a.setFieldsValue(n),_(!0)}catch{}},Ft=e=>{if(!e)return;const s={company:e.company||"",bikeModel:e.model||"",variant:e.variant||"",color:e.color||"",chassisNo:e.chassis||"",purchaseType:"cash",addressProofMode:"aadhaar",executive:R?.name||R?.email||"",branch:e.sourceBranch||e.lastSourceBranch||g||""};q(s),me(e),re(!0)},xe={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},Q={whiteSpace:l?"normal":"nowrap",overflow:"hidden",textOverflow:l?"clip":"ellipsis",wordBreak:l?"break-word":"normal"},Rt={whiteSpace:"normal",overflow:"visible",textOverflow:"clip",wordBreak:"break-all"},Re=e=>e?.timestamp||e?.createdAt||e?.updatedAt||e?.updated_at||e?.lastUpdated||e?.lastMovementAt||e?.time||e?.date||e?.Timestamp||e?.Time||e?.Date||e?.ts||"",zt=e=>{if(!e)return"—";const s=Number(e);if(!Number.isNaN(s)){const f=We(s);if(f.isValid())return f.format("DD-MM-YYYY HH:mm")}const n=We(e);return n.isValid()?n.format("DD-MM-YYYY HH:mm"):String(e)},Vt=(e,s)=>{const n=String(e||"").toLowerCase(),f=String(s?.transferStatus||"").toLowerCase();let i=n==="transfer"?"geekblue":n==="return"?"volcano":n==="invoice"?"green":n==="add"?"purple":"default",p=n==="invoice"?"Book":e||"-";return n==="transfer"&&(f==="pending"?(i="orange",p="Transfer (Pending)"):f==="rejected"?(i="red",p="Transfer (Rejected)"):f==="admitted"&&(i="green",p="Transfer (Admitted)")),t.jsx(Ce,{color:i,style:{fontSize:11,lineHeight:1.1},children:p})},ct=[{title:"Time / Source",key:"timeSource",width:l?70:90,render:(e,s)=>t.jsxs("div",{style:xe,children:[t.jsx("div",{style:Q,children:zt(Re(s))}),t.jsx("div",{style:Q,children:t.jsx("span",{style:{color:"#6b7280"},children:s.sourceBranch||"—"})})]})},{title:"Chassis / Company || Model",key:"chassisCompanyModel",width:l?90:100,render:(e,s)=>t.jsxs("div",{style:xe,children:[t.jsx("div",{style:Rt,children:t.jsx("span",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace"},children:s.chassis||"-"})}),t.jsx("div",{style:Q,children:`${s.company||"—"} || ${s.model||"—"}`})]})},{title:"Variant + Color || Action",key:"variantColorAction",width:l?110:130,render:(e,s)=>t.jsxs("div",{style:xe,children:[t.jsx("div",{style:Q,children:s.variant||"—"}),t.jsx("div",{style:Q,children:t.jsxs(L,{size:6,children:[t.jsx("span",{children:`${s.color||"—"} ||`}),Vt(s.action,s)]})})]})}],$t=[{title:"Target/Return/Customer + Notes",key:"destNotes",width:l?160:250,render:(e,s)=>t.jsxs("div",{style:xe,children:[t.jsx("div",{style:Q,children:s.targetBranch||s.returnTo||s.customerName||"—"}),t.jsx("div",{style:Q,children:s.notes||"—"})]})}],dt={title:"Actions",key:"actions",width:l?20:40,render:(e,s)=>bt?t.jsx(L,{size:4,wrap:!1,style:{whiteSpace:"nowrap"},children:t.jsx(P,{size:"small",onClick:()=>At(s),style:{fontSize:10,height:18,padding:"0 6px"},children:"Edit"})}):Y?t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[t.jsxs(L,{size:4,children:[t.jsx(P,{size:"small",onClick:()=>it("transfer",s),style:{fontSize:10,height:18,padding:"0 6px"},children:"Transfer"}),t.jsx(P,{size:"small",type:"primary",onClick:()=>Ft(s),style:{fontSize:10,height:18,padding:"0 6px"},children:"Book"})]}),t.jsx(L,{size:4,children:t.jsx(P,{size:"small",onClick:()=>it("return",s),style:{fontSize:10,height:18,padding:"0 6px"},children:"Return"})})]}):t.jsx("span",{style:{color:"#94a3b8"},children:"—"})},Lt=Y?[...ct,dt]:[...ct,dt,...$t],ve=o.useMemo(()=>{const e=v||[],s=String(Oe||"").toLowerCase();return e.filter(n=>!(A&&k!=="all"&&n.sourceBranch!==k||le!=="all"&&String(n.action||"").toLowerCase()!==le||s&&![n.chassis,n.company,n.model,n.variant,n.color,n.notes,n.targetBranch,n.returnTo,n.customerName,n.sourceBranch].map(i=>String(i||"").toLowerCase()).some(i=>i.includes(s))))},[v,A,k,le,Oe]);o.useEffect(()=>{qe(1)},[k,le,Oe]),o.useEffect(()=>{const e=setTimeout(()=>Me(String(Ne||"").trim()),150);return()=>clearTimeout(e)},[Ne]);const _t=()=>{if(!ve.length){b.info("No stock movements to export for current filters");return}const e=[{key:"ts",label:"Timestamp"},{key:"chassis",label:"Chassis"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"color",label:"Color"},{key:"action",label:"Action"},{key:"sourceBranch",label:"Source Branch"},{key:"targetBranch",label:"Target Branch"},{key:"returnTo",label:"Return To"},{key:"customerName",label:"Customer"},{key:"notes",label:"Notes"},{key:"transferStatus",label:"Transfer Status"}],s=ve.map(n=>({ts:n.ts,chassis:n.chassis,company:n.company,model:n.model,variant:n.variant,color:n.color,action:n.action,sourceBranch:n.sourceBranch||n.lastSourceBranch,targetBranch:n.targetBranch,returnTo:n.returnTo,customerName:n.customerName,notes:n.notes,transferStatus:n.transferStatus}));js({filename:"stock-movements.csv",headers:e,rows:s}),b.success(`Exported ${s.length} stock movements`)};return t.jsxs("div",{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:l?"stretch":"center",marginBottom:12,gap:8,flexWrap:"wrap"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap",flex:l?"1 1 100%":"1 1 auto"},children:[t.jsx("strong",{children:"Total:"})," ",ve.length||0,t.jsx(ae.Search,{placeholder:"Search chassis/company/model/notes",allowClear:!0,value:Ne,onChange:e=>Ke(e.target.value),onSearch:e=>Me(String(e||"").trim()),style:{width:l?"100%":260,minWidth:l?0:220}}),A&&t.jsxs(t.Fragment,{children:[t.jsx(S,{value:k,onChange:Qe,style:{minWidth:180},placeholder:"Branch",options:[{value:"all",label:"All Branches"},...Te.map(e=>({value:e,label:e}))]}),t.jsx(S,{value:le,onChange:Je,style:{width:150},placeholder:"Action",options:[{value:"all",label:"All Actions"},{value:"add",label:"Add"},{value:"transfer",label:"Transfer"},{value:"return",label:"Return"},{value:"invoice",label:"Invoice"}]})]}),t.jsx(P,{onClick:()=>{Ke(""),Me(""),Je("all"),Qe("all")},children:"Reset"})]}),t.jsxs(L,{wrap:!0,size:"small",style:{width:l?"100%":"auto",justifyContent:l?"space-between":"flex-end"},children:[t.jsx(P,{onClick:_t,style:{flex:l?"1 1 auto":"0 0 auto"},children:"Export CSV"}),t.jsx(P,{onClick:G,loading:ue,style:{flex:l?"1 1 auto":"0 0 auto"},children:"Refresh"}),t.jsx(P,{type:"primary",style:{flex:l?"1 1 auto":"0 0 auto"},onClick:()=>{z(["add"]),w("add"),U(null),E(""),a.resetFields(),pe&&g&&a.setFieldsValue({sourceBranch:g}),_(!0)},children:"New Movement"})]})]}),t.jsxs("div",{style:{marginBottom:16,padding:12,border:"1px solid #f97316",background:"#fff7ed",borderRadius:10,boxShadow:"0 1px 0 rgba(0,0,0,0.04)"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8,flexWrap:"wrap"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:700},children:"Notifications / Pending Transfers"}),t.jsx("div",{style:{fontSize:12,color:"#92400e"},children:D==="all"&&A?"Showing pending transfers across all branches":`Transfers awaiting admit for ${D||g||"your branch"}`})]}),t.jsxs(L,{size:"small",wrap:!0,children:[t.jsxs(Ce,{color:ge.length?"orange":"green",style:{margin:0},children:[ge.length," pending"]}),t.jsx(P,{size:"small",loading:et,onClick:se,children:"Refresh alerts"})]})]}),ge.length===0?t.jsx("div",{style:{marginTop:8,color:"#92400e",fontSize:12},children:et?"Checking pending transfers...":D==="all"&&A?"No pending transfers across branches.":"No pending transfers for this branch."}):t.jsx(L,{direction:"vertical",style:{width:"100%",marginTop:12},size:"small",children:ge.map(e=>t.jsxs("div",{style:{display:"flex",flexDirection:l?"column":"row",alignItems:l?"stretch":"flex-start",justifyContent:"space-between",gap:12,padding:12,borderRadius:8,border:"1px dashed #f97316",background:"#fff"},children:[t.jsxs("div",{style:{flex:l?"0 0 auto":"1 1 260px",minWidth:l?0:220},children:[t.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"},children:[t.jsx("span",{style:{fontWeight:700},children:"Chassis:"}),t.jsx("span",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace",wordBreak:"break-all"},children:e.chassis||"-"}),t.jsx(Ce,{color:"geekblue",style:{marginLeft:4,maxWidth:"100%",whiteSpace:"normal",lineHeight:1.2},children:[e.company,e.model,e.variant,e.color].filter(Boolean).join(" ")})]}),t.jsxs("div",{style:{marginTop:6,display:"flex",gap:12,flexWrap:"wrap",color:"#111827"},children:[t.jsx("span",{style:{fontWeight:600},children:e.sourceBranch||"Source ?"}),t.jsx("span",{style:{color:"#6b7280"},children:"→"}),t.jsx("span",{style:{fontWeight:600},children:e.targetBranch||"Target ?"})]}),t.jsxs("div",{style:{marginTop:4,fontSize:12,color:"#4b5563"},children:["Requested by ",e.createdByName||"user",e.ts?` on ${We(e.ts).format("DD-MM-YYYY HH:mm")}`:""]}),e.notes&&t.jsxs("div",{style:{marginTop:4,fontSize:12,color:"#92400e"},children:["Notes: ",e.notes]})]}),t.jsxs(L,{size:"small",align:"start",wrap:!0,style:{width:l?"100%":"auto",justifyContent:l?"flex-end":"flex-start"},children:[t.jsx(P,{type:"primary",size:"small",loading:st===e.movementId&&nt==="admit",onClick:()=>It(e.movementId),children:"Admit"}),t.jsx(St,{title:"Reject this transfer?",description:`Keep chassis ${e.chassis||""} in ${e.sourceBranch||"source branch"} and clear this alert.`,okText:"Reject",okType:"danger",onConfirm:()=>Et(e.movementId),children:t.jsx(P,{danger:!0,size:"small",loading:st===e.movementId&&nt==="reject",children:"Reject"})})]})]},e.movementId||e.key))})]}),t.jsx(ms,{dataSource:ve,columns:Lt,loading:ue&&!Ue,pagination:{current:jt,pageSize:Ye,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(e,s)=>{qe(e),s!==Ye&&Ct(s)},showTotal:(e,s)=>`${s[0]}-${s[1]} of ${e}`},size:"small",className:"stock-movements-table",tableLayout:l?"auto":"fixed",scroll:l?{x:"max-content",y:420}:{y:600},rowKey:e=>`${e.ts}-${e.chassis}-${e.key}`}),t.jsxs(pt,{title:W?"Edit Stock Movement":"New Stock Movement",open:X,onCancel:()=>{_(!1),z(null),w("add"),U(null),E("")},onOk:Pt,okText:"Save",confirmLoading:K,destroyOnClose:!0,forceRender:!0,width:720,children:[de&&t.jsx(Zt,{type:"error",showIcon:!0,message:de,style:{marginBottom:12}}),t.jsx(B,{form:a,layout:"vertical",initialValues:{},children:t.jsxs(is,{gutter:[12,8],children:[t.jsx(M,{span:24,children:t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:12},children:[t.jsx("div",{style:{fontWeight:700},children:"Vehicle Details (from CSV)"}),t.jsx("div",{style:{fontSize:12,color:N?"#10b981":"#ef4444"},children:N?"Catalog loaded":"Catalog unavailable"})]})}),t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"company",label:O("Company"),rules:F?[]:[{required:!0,message:"Company is required"}],children:t.jsx(S,{placeholder:N?"Select company":"Sheet unavailable",disabled:!N||F,onChange:Nt,showSearch:!0,optionFilterProp:"children",children:kt.map(e=>t.jsx(S.Option,{value:e,children:e},e))})})}),t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"model",label:O("Model"),rules:F?[]:[{required:!0,message:"Model is required"}],children:t.jsx(S,{placeholder:"Select model",disabled:!N||!m||F,onChange:Ot,showSearch:!0,optionFilterProp:"children",children:Bt.map(e=>t.jsx(S.Option,{value:e,children:e},e))})})}),t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"variant",label:O("Variant"),rules:F?[]:[{required:!0,message:"Variant is required"}],children:t.jsx(S,{placeholder:"Select variant",disabled:!N||!x||F,onChange:Mt,showSearch:!0,optionFilterProp:"children",children:Tt.map(e=>t.jsx(S.Option,{value:e,children:e},e))})})}),t.jsxs(M,{xs:24,md:12,children:[t.jsx(B.Item,{name:"color",label:O("Color"),rules:F?[]:[{required:!0,message:"Color is required"}],children:Ae.filter(Boolean).length?t.jsx(S,{placeholder:"Select color",disabled:!N||!V||F,showSearch:!0,optionFilterProp:"children",children:Ae.filter(Boolean).map(e=>{const s=ot(e);return t.jsx(S.Option,{value:e,children:t.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:8},children:[t.jsx("span",{style:{width:12,height:12,borderRadius:3,background:s.bg,border:`1px solid ${s.border}`}}),e]})},e)})}):t.jsx(ae,{placeholder:"Type color",disabled:F})}),!F&&t.jsx(L,{wrap:!0,size:"small",style:{marginTop:-8,marginBottom:8},children:Ae.filter(Boolean).map(e=>{const s=String(e||"").trim();if(!s)return null;const n=ot(s);return t.jsx(cs,{title:s,children:t.jsxs(P,{size:"small",onClick:()=>a.setFieldsValue({color:s}),style:{height:28,borderRadius:14,display:"inline-flex",alignItems:"center",gap:8,padding:"0 10px",border:`1px solid ${n.border}`,background:"#fff"},children:[t.jsx("span",{style:{width:14,height:14,borderRadius:7,background:n.bg,border:`1px solid ${n.border}`}}),t.jsx("span",{children:s})]})},s)})})]}),t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"sourceBranch",label:O("Source Branch"),children:t.jsx(S,{allowClear:!ye,disabled:ye,placeholder:ye?a.getFieldValue("sourceBranch")||g||"Current branch":"(Optional) Select current branch",value:ye?a.getFieldValue("sourceBranch")||g:void 0,children:Te.map(e=>t.jsx(S.Option,{value:e,children:e},e))})})}),t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"chassis",label:O("Chassis No."),rules:[{required:!0,message:"Chassis number is required"}],children:t.jsx(ae,{placeholder:lt?"Chassis fixed for this movement":"Enter chassis number",disabled:lt,onChange:e=>{const s=(e.target.value||"").toUpperCase();a.setFieldsValue({chassis:s})}})})}),u==="add"&&at.length>0&&t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"franchise",label:O("Franchise (Dealer)"),children:t.jsx(S,{placeholder:"Select franchise",allowClear:!0,disabled:!m,showSearch:!0,optionFilterProp:"children",children:at.map(e=>t.jsx(S.Option,{value:e,children:e},`fr:${e}`))})})}),t.jsx(M,{span:24,children:Array.isArray(j)&&j.length===1?t.jsxs("div",{style:{marginBottom:8},children:[O("Action")," ",t.jsx(Ce,{color:u==="add"?"purple":u==="transfer"?"geekblue":u==="return"?"volcano":"green",style:{marginLeft:8},children:u==="invoice"?"Book":u})]}):t.jsx(B.Item,{label:O("Action"),children:t.jsxs(ie.Group,{value:u,disabled:Fe,onChange:e=>w(e.target.value),children:[(j||["add","transfer","return","invoice"]).includes("add")&&t.jsx(ie,{value:"add",children:"Add New Stock"}),(j||["add","transfer","return","invoice"]).includes("transfer")&&t.jsx(ie,{value:"transfer",children:"Transfer To"}),(j||["add","transfer","return","invoice"]).includes("return")&&t.jsx(ie,{value:"return",children:"Return To"}),(j||["add","transfer","return","invoice"]).includes("invoice")&&t.jsx(ie,{value:"invoice",children:"Book"})]})})}),u==="transfer"&&t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"targetBranch",label:O("Target Branch"),rules:[{required:!0,message:"Select target branch"}],children:t.jsx(S,{placeholder:"Select branch",showSearch:!0,optionFilterProp:"children",children:Te.map(e=>t.jsx(S.Option,{value:e,children:e},e))})})}),u==="return"&&t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"returnTo",label:O("Return To (Dealer/Area)"),rules:[{required:!0,message:"Enter return destination"}],children:t.jsx(ae,{placeholder:"e.g., Kengaria / Dealer name"})})}),u==="invoice"&&t.jsx(M,{xs:24,md:12,children:t.jsx(B.Item,{name:"customerName",label:O("Customer Name"),rules:[{required:!0,message:"Customer name required"}],getValueFromEvent:e=>{const s=e?.target?.value??e;return typeof s=="string"?s.toUpperCase():s},children:t.jsx(ae,{placeholder:"ENTER CUSTOMER NAME",style:{textTransform:"uppercase"}})})}),t.jsx(M,{xs:24,children:t.jsx(B.Item,{name:"notes",label:O("Notes"),children:t.jsx(ae.TextArea,{rows:3,placeholder:"Optional notes"})})})]})})]}),t.jsx(pt,{title:"Book",open:ke,onCancel:()=>{re(!1),q(null)},footer:null,destroyOnClose:!0,width:980,children:t.jsx(Ut,{asModal:!0,initialValues:Be||{},autoUpdateStockOnSave:!1,onSuccess:async({response:e,payload:s})=>{try{const n=s?.vehicle||{},f={Chassis_No:String(n.chassisNo||$?.chassis||$?.chassisNo||"").toUpperCase(),Company:n.company||$?.company||"",Model:n.model||$?.model||"",Variant:n.variant||$?.variant||"",Color:n.color||$?.color||"",Action:"invoice",Customer_Name:s?.customerName||"",Source_Branch:$?.sourceBranch||g||"",Notes:e?.bookingId?`Book via Booking ID ${e.bookingId}`:"Book via Booking form"},i=await ft({data:f,createdBy:R?.name||R?.email||"user"});if(!(i?.success??i?.ok)){b.error(i?.message||"Failed to update stock for this booking.");return}b.success("Stock updated: vehicle marked booked / out of stock"),re(!1),q(null),me(null),await G()}catch(n){const f=n?.response?.data?.message||n?.message;b.error(f?`Saved booking but failed to update stock: ${f}`:"Saved booking but failed to update stock. Please refresh and try again.")}}})})]})}const Ws=Object.freeze(Object.defineProperty({__proto__:null,default:Ts},Symbol.toStringTag,{value:"Module"}));export{St as P,Ts as S,Ws as a,js as e};
