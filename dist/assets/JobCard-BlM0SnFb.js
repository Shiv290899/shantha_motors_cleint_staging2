import{r as c,j as e,a as Do,G as To,R as ko}from"./index-D3jyxz5S.js";import{L as Wt,d as T}from"./index-BaYR0Azk.js";import{f as Ot,t as as,i as is,S as Mt,P as Yo,h as Es}from"./PostServiceSheet-a3wpyx66.js";import{F as $t}from"./index-gy4sqIjf.js";import{A as Ks,a as ot,l as Po,b as Ro,g as Fo,u as Vs,n as Ls,D as Os,c as Eo}from"./caseInsensitive-Bczb6n5Q.js";import{B as te}from"./button-CtJmIkB1.js";import{M as mt}from"./index-C426kwCm.js";import{S as Vo}from"./index-BBYJ-6BB.js";import{R as Ut,a as zs,S as Ht}from"./index-CtRvdixs.js";import{I as me,s as v}from"./index-CY4Kamfr.js";import{F as w}from"./index-CcgLN9cm.js";import{T as Lo}from"./index-BE1rlUlE.js";import{C as tt}from"./index-Do8dGFqA.js";import{z as Be,A as L,T as Oo}from"./TextArea-Q3gpJu61.js";import{A as $s}from"./index-DPxH9qVd.js";import{C as $o}from"./index-CZRYr7Ag.js";import{T as It}from"./index-C0lBYX3a.js";import"./useClosable-DfZqN2_R.js";import"./pickAttrs-CXQyGfOx.js";import"./iconBase-DX4Dj3PV.js";import"./PurePanel-CsQLL2O2.js";import"./PlusOutlined-AckC3LXy.js";import"./index-nbuh2wRs.js";import"./Skeleton-D--9XwWe.js";import"./useBubbleLock-Bjm2feVM.js";import"./LeftOutlined-D-CNePKA.js";import"./CheckOutlined-Dmu6kb1T.js";import"./DownOutlined-C-UypXHl.js";import"./index-CUWDS_la.js";import"./EyeOutlined-pj_CrMc9.js";const Uo=c.forwardRef(function({active:p,vals:n,labourRows:S,executives:_=[],observationLines:U},k){const Y=f=>String(f||"").toLowerCase().replace(/\s+/g," ").trim(),ne=new Map((S||[]).map(f=>{const P=Number(f?.qty||0)*Number(f?.rate||0);return[Y(f?.desc||f?.name),P]})),re=(U||[]).map(f=>{const P=ne.get(Y(f));return{text:f,amount:Number.isFinite(P)?P:null}}),xe=re.reduce((f,P)=>f+(P.amount??0),0),je=f=>{const X=String(f??"").toUpperCase().trim().replace(/\s*KM\s*$/i,"").replace(/\D/g,"");return X?`${X} KM`:"-"},Q=({w:f="8mm"})=>e.jsx("span",{"aria-hidden":"true",style:{display:"inline-block",width:f}}),W=(()=>{const f=String(n?.executive||"").trim(),P=f.replace(/\D/g,"");return/^\d{10}$/.test(P)?P:(_||[]).find(X=>X.name===f)?.phone||null})(),ae=(()=>{const f=n?.floorMat;if(typeof f=="boolean")return f;const P=String(f??"").trim().toLowerCase();return P==="yes"||P==="y"||P==="true"||P==="1"})(),pe=n?.floorMat!=null?!ae:!1,le=String(n?.branch||"").trim().toLowerCase().replace(/\s+/g,"").includes("byadarahalli"),z=["Free","Paid","Minor","Accidental"];return e.jsxs("div",{ref:k,className:`print-sheet ${p?"active":""}`,children:[e.jsx("style",{children:`
/* =========================
   NEW PRINT BASELINE (A4)
   ========================= */
@page { size: A4 portrait; margin: 0; }
html, body {
  margin: 0 !important;
  padding: 0 !important;
  background: #fff !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica, sans-serif;
}
img { max-width: 100%; height: auto; background: transparent; }

/* Tame layout quirks during print */
@media print {
  * { transform: none !important; }
  .fixed, .sticky, [style*="position: sticky"], [style*="position: fixed"] { position: static !important; }
  .no-print { display: none !important; }
}

/* Screen preview */
@media screen {
  body:not(.print-host) 
  .print-sheet { display: none !important; }
}

/* If you still use the "active sheet only" pattern in full app print, keep it: */
@media print {
  body * { visibility: hidden !important; }                 /* hide all */
  .print-sheet { display: block; }
  .print-sheet.active,
  .print-sheet.active * { visibility: visible !important; } /* show only sheet */
  .print-sheet:not(.active) { display: none !important; }   /* ensure only one prints */
  .print-sheet.active { position: absolute; inset: 0; width: 100%; } /* start at top-left */

  /* Avoid blank extra pages by letting height auto */
  .pre-a4 { display: block !important; min-height: auto !important; height: auto !important; }

  /* Keep larger blocks from splitting */
  .voucher { break-inside: avoid; page-break-inside: avoid; }
}

/* ========== Your existing styles (kept) ========= */
.print-sheet { color: #000; }

/* Page grid */
.pre-a4 { /* container for a single A4 page */ }
.pre-wrap { padding: 4mm; }
.pre-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3mm; }

/* Generic boxes and text helpers */
.box { border: 1px solid #111; padding: 2.5mm; border-radius: 1mm; }
.tiny { font-size: 11px; }
.label { font-weight: 600; }

/* Titles */
.title-kn { font-size: 18pt; font-weight: 500; letter-spacing: 1px; }
.title-en { font-size: 25pt; font-weight: 700; margin-top: 2px; }
.title-wrap {
  display: flex;
  align-items: baseline;
  gap: 8px;
  white-space: nowrap;
}

/* Grids */
.row   { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2mm; }
.row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2mm; }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2mm; }

.right { text-align: right; }
.center { text-align: center; }
.v-top { align-self: start; }

/* Observation + cost split column */
.obs-cost {
  display: grid;
  grid-template-columns: 1fr 40mm; /* observation | cost column */
  gap: 2mm;
}
.list { padding-left: 4mm; margin: 0; }
.list li { margin: 0.8mm 0; }
.sum-row { display: grid; grid-template-columns: 1fr 40mm; gap: 2mm; align-items: center; }
.divider { border-top: 1px solid #000; margin: 3mm 0; }

/* Voucher area (bottom strip) */
.voucher {
  border-top: 3px dashed #777;
  padding-top: 3mm;
  height: 60%;
  align-items: stretch;
}

/* Brand line */
.voucher .brand-line{
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 8px;
  white-space: nowrap;
}
.voucher .brand-kn{ font-size:18pt; font-weight:500; line-height:1.05; }
.voucher .brand-en{ font-size:18pt; font-weight:500; line-height:1.05; }

/* Single outer box inside voucher: left | middle | right(=QR) */
.voucher .box {
  width: 98%;
  border: 1px solid #111;
  border-radius: 5mm;
  display: grid;
  grid-template-columns: 0.7fr 0.9fr 0.5fr;
  gap: 3mm;
  align-items: start;
  text-align: left;
}
.voucher .col { text-align: left; }
.voucher .col-right { text-align: center; }
.voucher .qr { height: 60px; width: 60px; object-fit: contain; }
.voucher .scan { font-size: 13px; font-weight: 600; margin-top: 4px; }
.voucher .phones { margin-top: 2px; }
/* Light helper for address lines */
.shop-sub { font-size: 12pt; }
.shop-addr { font-size: 11pt; }

/* Damage section */
.damage-box { border: 1px solid #111; padding: 2mm; min-width: 38mm; }
.damage-box .title { font-weight: 700; font-size: 12px; margin-bottom: 2mm; }
.damage-list { list-style: disc; padding-left: 5mm; margin: 0 0 3mm 0; }
.damage-list li { margin: 1mm 0; position: relative; }

/* Yes / No on the right of each line */
.yn {
  float: right;
  display: inline-flex;
  align-items: center;
  gap: 4mm;
}

/* Printable empty checkbox square */
.cb {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 5mm;
  height: 5mm;
  border: 1px solid #111;
  font-size: 12px;  /* ensures â˜‘ / â˜ fits */
}


/* NOTE block below the list */
.note-box { border-top: 1px dashed #777; margin-top: 3mm; padding-top: 2mm; }
.note-title { font-weight: 600; margin-bottom: 1.5mm; }
.note-area { border: 1px solid #111; height: 69mm; border-radius: 1mm; }
      `}),e.jsxs("div",{className:"pre-a4",children:[e.jsxs("div",{className:"pre-wrap",children:[e.jsxs("div",{className:"title-wrap",children:[e.jsx("div",{className:"title-en",children:le?"NH MOTORS JOB CARD":"SHANTHA MOTORS JOB CARD"}),e.jsx("div",{className:"title-kn",children:le?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"})]}),le&&e.jsxs("div",{style:{marginTop:2},children:[e.jsxs("div",{className:"shop-addr",children:["Site No. 116/1, Bydarahalli, Magadi Main Road, Opp.",e.jsx("br",{}),"HP Petrol Bunk, Bangalore - 560091"]}),e.jsx("div",{className:"shop-sub",children:"Mob: 9731366921 / 8073283502 / 9741609799"})]}),e.jsxs("div",{className:"box row-2",style:{marginTop:3},children:[e.jsxs("div",{style:{fontSize:"20px",lineHeight:"1.4"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Job Card No:"})," ",n.jcNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Executive:"})," ",n.executive||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Date:"})," ",Ot(n.createdAt)]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Mechanic:"})," ",n.mechanic||"-"]})]}),e.jsxs("div",{className:"center",children:[e.jsx("img",{src:"/location-qr.png",alt:"location qr",style:{height:60}}),e.jsx("div",{className:"scan",children:"Scan for Location"}),e.jsx("div",{className:"tiny",style:{marginTop:3},children:le?"Mob: 9731366921 / 8073283502 / 9741609799":"Mob: 9731366921 / 8073283502"})]})]}),e.jsxs("div",{className:"row-2",style:{marginTop:3},children:[e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Vehicle No:"})," ",n.regNo||"-"]}),e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Odometer Reading:"})," ",je(n.km)]})]}),e.jsxs("div",{className:"row-2",style:{marginTop:3},children:[e.jsx("div",{className:"box",children:e.jsx("div",{children:e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Model:"})," ",n.model||"-"]})})}),e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Expected Delivery Date:"})," ",Ot(n.expectedDelivery)]})]}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{style:{display:"flex",gap:"6mm",flexWrap:"wrap",alignItems:"center"},children:[z.map(f=>e.jsxs("div",{children:[as(n.serviceType===f)," ",f]},f)),e.jsx(Q,{w:"10mm"}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Color:"})," ",n.colour||"-"]})]})}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"4fr 3fr",gap:"3mm"},children:[e.jsxs("div",{className:"obs-cost",children:[e.jsxs("div",{children:[e.jsx("div",{className:"label",children:"Customer Observation"}),e.jsx("ul",{className:"list",children:re.length===0?e.jsx("li",{children:"â€”"}):re.map(({text:f},P)=>e.jsx("li",{children:f},P))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"label right",children:"Estimated Cost"}),e.jsx("ul",{className:"list",style:{listStyle:"none",paddingLeft:0},children:re.length===0?e.jsx("li",{className:"right",children:"â€”"}):re.map(({amount:f},P)=>e.jsx("li",{className:"right",children:f!=null?is(f):"â€”"},P))})]})]}),e.jsx("div",{className:"v-top",children:e.jsxs("div",{className:"damage-box",children:[e.jsx("div",{className:"title",children:"CHECK BODY PART FOR ANY DAMAGE"}),e.jsxs("ul",{className:"damage-list",children:[e.jsxs("li",{children:["Dent",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Scratch",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Broken",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Floor Mat",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb",children:as(ae)}),"No  ",e.jsx("span",{className:"cb",children:as(pe)})]})]})]}),e.jsxs("div",{className:"note-box",children:[e.jsx("div",{className:"note-title",children:"NOTE:"}),e.jsx("div",{className:"note-area"})]})]})})]})}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{className:"sum-row",style:{fontWeight:700},children:[e.jsx("div",{children:"Total Estimated Cost"}),e.jsx("div",{className:"right",children:is(xe)})]})}),e.jsxs("div",{className:"row-3 box",style:{marginTop:3},children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Customer Name:"})," ",n.custName||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Mobile No:"})," ",n.custMobile||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Sign:"})," "]})]})]}),e.jsxs("div",{className:"pre-wrap voucher",children:[e.jsxs("div",{className:"brand-line",children:[e.jsx("span",{className:"brand-kn",children:le?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsx("span",{children:" || "}),e.jsx("span",{className:"brand-en",children:le?"NH MOTORS":"SHANTHA MOTORS"})]}),e.jsxs("div",{className:"box",style:{fontSize:"20px",lineHeight:"1.3",marginTop:"2mm"},children:[e.jsxs("div",{className:"col",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Job Card No:"})," ",n?.jcNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Reg. No:"})," ",n?.regNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Exp. Del. Date:"})," ",Ot(n?.expectedDelivery)]})]}),e.jsxs("div",{className:"col",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Date:"})," ",Ot(n?.createdAt)]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Executive No:"})," ",W||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Apprx. Service Amount:"})," ",is(xe)]})]}),e.jsxs("div",{className:"col col-right",children:[e.jsx("img",{src:"/location-qr.png",alt:"Location QR",className:"qr"}),e.jsx("div",{className:"scan",children:"Scan for Location"}),e.jsx("div",{className:"tiny phones",children:le?"9731366921 â€¢ 8073283502 â€¢ 9741609799":"9731366921 â€¢ 8073283502"})]})]})]})]})]})}),Io={};function Bo({form:a,formatReg:p,buildRows:n,defaultGstLabour:S=0,lists:_,setServiceTypeLocal:U,setVehicleTypeLocal:k,setRegDisplay:Y,webhookUrl:ne,setFollowUpEnabled:re,setFollowUpAt:xe,setFollowUpNotes:je,setPostServiceLock:Q,autoSearch:W,prefillMode:ae="full",onAutoSearchStatusChange:pe}){const we=Io?.VITE_JOBCARD_GAS_SECRET||"",[le,z]=c.useState(!1),[f,P]=c.useState("mobile"),[Me,X]=c.useState(""),[nt,he]=c.useState(!1),[Oe,ye]=c.useState([]),[ke,ie]=c.useState(""),[He,ge]=c.useState(ae),Se=c.useRef(ae),{BRANCHES:We,MECHANIC:Re,EXECUTIVES:de,VEHICLE_TYPES:pt,SERVICE_TYPES:At}=c.useMemo(()=>_||{},[_]);c.useEffect(()=>{Se.current=ae,ge(ae)},[ae]);const b=c.useMemo(()=>({Branch:["Branch"],Mechanic:["Allotted Mechanic","Mechanic","Allocated Mechanic"],Executive:["Executive"],ExpectedDelivery:["Expected Delivery Date","Expected Delivery","Expected_Delivery_Date"],RegNo:["Vehicle No","Vehicle_No","Vehicle Number","Registration Number","Reg No","RegNo"],ChassisNo:["Chassis No","Chassis_No","Chassis Number","Chassis"],Model:["Model"],Colour:["Colour","Color"],KM:["Odometer Reading","Odomete Reading","KM","Odometer"],CustName:["Customer Name","Name","Customer_Name"],Mobile:["Mobile","Mobile No","Mobile Number","Phone","Phone Number"],Obs:["Customer Observation","Customer_Observation","Observation","Notes"],VehicleType:["Vehicle Type","Type of Vehicle","Vehicle_Type"],ServiceType:["Service Type","Service","Service_Type"],FloorMat:["Floor Mat"],Amount:["Collected Amount","Amount"],JCNo:["JC No","JCNo","Job Card No","JC Number","JC No."],CreatedAt:["Created At","Timestamp","Form Timestamp","Submission Time","Submitted At"]}),[]),O=(o,r)=>{for(const d of r)if(Object.prototype.hasOwnProperty.call(o,d)){const m=o[d];if(m!=null&&String(m).trim()!=="")return String(m).trim()}return""},Je=o=>o!=null&&String(o).trim()!=="",I=(...o)=>{for(const r of o)if(Je(r))return r;return""},Ne=o=>String(o||"").replace(/\D/g,"").slice(-10),Fe=o=>String(o||"").toUpperCase().replace(/[^A-Z0-9]/g,""),Dt=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,Ee=o=>{const r=Fe(o);return r.length>10||!/^[A-Z0-9]*$/.test(r)?!1:[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(m=>m.test(r))},ht=(o={})=>{const d=o?.source==="inline",m=f==="vehicle"?Fe(Me):Ne(Me)||String(Me||"").trim(),J=m?`No records found for ${f==="vehicle"?"vehicle number":"mobile number"} "${m}".`:"No records found.";ie(J),mt.warning({centered:!0,title:d?"No records found":"No job card found",content:J,okText:"Got it"})},Tt=o=>{const r=String(o||"").trim();if(!r)return null;const d=T(r,["DD-MM-YYYY HH:mm","D-M-YYYY HH:mm","DD/MM/YYYY HH:mm","D/M/YYYY HH:mm","DD-MM-YYYY","D-M-YYYY","DD/MM/YYYY","D/M/YYYY","YYYY-MM-DD",T.ISO_8601],!0);return d.isValid()?d:null},$e=o=>{const r=O(o,b.CreatedAt),d=T(r,[T.ISO_8601,"M/D/YYYY H:mm:ss","D/M/YYYY H:mm:ss","DD/MM/YYYY H:mm:ss","DD/MM/YYYY","D-M-YYYY H:mm:ss","DD-MM-YYYY H:mm:ss","DD-MM-YYYY HH:mm","DD-MM-YYYY"],!1);return d.isValid()?d:T(0)},kt=o=>{const r=o||{},d=r.formValues||{},m=r.savedAt||r.createdAt||r.ts||r.timestamp||r.postServiceAt||d.createdAt||d.savedAt||d.timestamp||d.submittedAt||d.expectedDelivery||"",x=T(m);return x.isValid()?x.valueOf():0},qe=(o,r)=>{const d=o&&o.payload?o.payload:o||{},m=o?._values||o?.values||{},x=d?.postServiceAt||d?.postService_at||d?.formValues?.postServiceAt||d?.formValues?.postService_at||m?.Post_Service_At||m?.Post_Service_at||m?.Post_Service||"",J=d?.formValues?.custMobile||d?.custMobile||m?.Mobile||m?.["Mobile Number"]||m?.Phone||m?.["Phone Number"]||"",oe=Ne(J);return{locked:!!d?.postServiceLogged||!!x,at:x||null,mobile:oe||null,amount:d?.postServiceAmount??null,mode:d?.postServiceMode||d?.paymentMode||null}},Ae=(o,r)=>{if(!Q)return;const d=qe(o);Q(d)},Ye=o=>String(o||"").toLowerCase().replace(/\s+/g,""),Ke=(o,r)=>{if(!r||!o?.length)return;const d=Ye(r);let m=o.find(x=>Ye(x)===d);return m||(m=o.find(x=>Ye(x).startsWith(d)),m)||(m=o.find(x=>Ye(x).includes(d))),m},ze=o=>{const r=String(o||"").toLowerCase();return r.includes("free")?"Free":r.includes("paid")?"Paid":r.includes("minor")?"Minor":r.includes("accid")?"Accidental":Ke(At||[],o)},Ze=o=>{const r=String(o||"").toLowerCase();return r.includes("scoot")||r.includes("scooty")?"Scooter":r.includes("bike")||r.includes("motor")?"Motorcycle":Ke(pt||[],o)},Jt=async(o,r)=>{if(!ne)throw new Error("Webhook URL not configured");const d=r||f,m=d==="vehicle"?"reg":d==="jc"?"jc":"mobile",x=String(o??Me??""),J=we?{action:"search",mode:m,query:x,secret:we}:{action:"search",mode:m,query:x};let oe=[];try{const A=await ot({webhookUrl:ne,method:"GET",payload:J}),h=A?.data||A;oe=Array.isArray(h?.rows)?h.rows:[]}catch(A){console.warn("Webhook search failed:",A)}if(!oe.length&&d==="vehicle")try{const h=await ot({webhookUrl:ne,method:"GET",payload:we?{action:"search",mode:"vehicle",query:x,secret:we}:{action:"search",mode:"vehicle",query:x}}),B=h?.data||h;oe=Array.isArray(B?.rows)?B.rows:[]}catch(A){console.warn("Vehicle search fallback failed:",A)}return{mode:"webhook",rows:oe.map(A=>{const h=A&&A.values?A.values:{},B=String(h.Post_Service_At||h.Post_Service_at||h.Post_Service||"").trim(),M={jcNo:String(h["JC No."]||""),branch:String(h.Branch||""),mechanic:String(h.Allotted_Mechanic||h["Allotted Mechanic"]||""),executive:String(h.Executive||""),regNo:p(h.Vehicle_No||h["Vehicle No"]||"",""),company:String(h.Company||""),serviceType:String(h.Service_Type||h["Service Type"]||""),model:String(h.Model||""),colour:String(h.Colour||h.Color||""),chassisNo:String(h.Chassis_No||h["Chassis No"]||"").toUpperCase(),km:String(h.KM||h["Odometer Reading"]||h["Odomete Reading"]||"").replace(/\D/g,"")||"",fuelLevel:String(h.Fuel_Level||h["Fuel Level"]||""),vehicleType:String(h.Vehicle_Type||h["Vehicle Type"]||""),paymentMode:String(h.Payment_Mode||h["Payment Mode"]||""),custName:String(h.Customer_Name||""),custMobile:String(h.Mobile||""),obs:String(h.Customer_Observation||""),expectedDelivery:String(h.Expected_Delivery_Date||""),amount:String(h.Collected_Amount||""),utr:String(h.UTR_No||h["UTR No"]||"")};if(A&&A.payload&&typeof A.payload=="object"){const R=A.payload||{},N=R.formValues||{},y={jcNo:I(N.jcNo,M.jcNo),branch:I(N.branch,M.branch),mechanic:I(N.mechanic,M.mechanic),executive:I(N.executive,M.executive),expectedDelivery:I(N.expectedDelivery,M.expectedDelivery),regNo:I(N.regNo,M.regNo),company:I(N.company,M.company),model:I(N.model,M.model),colour:I(N.colour,N.color,M.colour),chassisNo:I(N.chassisNo,N.chassis,M.chassisNo),km:String(I(N.km,M.km)).replace(/\D/g,""),fuelLevel:I(N.fuelLevel,M.fuelLevel),callStatus:I(N.callStatus,""),custName:I(N.custName,M.custName),custMobile:I(N.custMobile,M.custMobile),obs:I(N.obs,M.obs),vehicleType:I(N.vehicleType,M.vehicleType),serviceType:I(N.serviceType,M.serviceType),floorMat:I(N.floorMat,M.floorMat),amount:I(N.amount,M.amount),paymentMode:I(N.paymentMode,M.paymentMode),utr:I(N.utr,N.utrNo,M.utr)};return{payload:{...R,formValues:y,postServiceAt:R.postServiceAt||R.postService_at||B||void 0,postServiceLogged:R.postServiceLogged||!!(R.postServiceAt||R.postService_at||B),_values:h}}}return{payload:{formValues:M,labourRows:[],totals:{},postServiceAt:B||void 0,postServiceLogged:!!B,_values:h}}})}},rt=o=>{const r=O(o,b.Branch),d=O(o,b.Mechanic),m=O(o,b.Executive),x=Tt(O(o,b.ExpectedDelivery)),J=p(O(o,b.RegNo),""),oe=String(O(o,b.ChassisNo)||"").toUpperCase().replace(/[^A-Z0-9]/g,""),$=String(O(o,b.Model)||"").toUpperCase(),A=O(o,b.Colour),h=O(o,b.KM).replace(/\D/g,""),B=O(o,b.CustName),M=Ne(O(o,b.Mobile)),R=O(o,b.Obs),N=(()=>{const be=String(R||"").trim();return be?be.includes("#")?be.split(/\s*#\s*/g).map(vt=>vt.trim()).filter(Boolean).join(`
`):be.replace(/\r\n/g,`
`):""})(),y=Ze(O(o,b.VehicleType)),Z=ze(O(o,b.ServiceType)),q=O(o,b.FloorMat),Ce=O(o,b.JCNo),yt=Ke(Re,d),bt=Ke((de||[]).map(be=>be.name),m);return{fields:{jcNo:Ce,branch:Ke(We,r)||void 0,mechanic:yt,executive:bt,expectedDelivery:x||null,regNo:J,chassisNo:oe,model:$,colour:A,km:h?`${h} KM`:"",custName:B,custMobile:M,obs:N,vehicleType:y,serviceType:Z,floorMat:q==="Yes"||q==="No"?q:void 0,discounts:{labour:0},gstLabour:S},serviceType:Z,vehicleType:y}},gt=(o={})=>{const r={},d=p(o.regNo||"",""),m=String(o.custMobile||"").replace(/\D/g,"").slice(-10);d&&(r.regNo=d),m&&(r.custMobile=m),String(o.custName||"").trim()&&(r.custName=o.custName),String(o.company||"").trim()&&(r.company=String(o.company).toUpperCase()),String(o.model||"").trim()&&(r.model=String(o.model).toUpperCase()),String(o.colour||"").trim()&&(r.colour=o.colour),String(o.chassisNo||"").trim()&&(r.chassisNo=String(o.chassisNo).toUpperCase()),Object.keys(r).length&&a.setFieldsValue(r),d&&Y?.(d),Q&&Q({locked:!1,at:null,mobile:null,amount:null,mode:null}),v.success("Customer details pre-filled."),z(!1),ye([]),X("")},Ge=o=>{const{fields:r,serviceType:d,vehicleType:m}=rt(o);try{const x=$e(o);x&&x.isValid&&x.isValid()&&(r.savedAt=x.toISOString())}catch{}if(Se.current==="basic"){gt(r);return}U?.(d||null),k?.(m||null),a.setFieldsValue(r),Y?.(r.regNo||""),d&&m&&a.setFieldsValue({labourRows:n(d,m),gstLabour:S,discounts:{labour:0}}),Ae(o),v.success("Details filled from sheet."),z(!1),ye([]),X("")},at=o=>{try{if(Se.current==="basic"){const y=o?.formValues||{};gt({regNo:y.regNo||"",custMobile:String(y.custMobile||"").replace(/\D/g,"").slice(-10),custName:y.custName||"",company:y.company||"",chassisNo:y.chassisNo||y.chassis||"",model:String(y.model||"").toUpperCase(),colour:y.colour||""});return}const r=o?.formValues||{},d=o?._values||{},m=y=>{for(const Z of y){const q=d?.[Z];if(q!=null&&String(q).trim()!=="")return q}return""},x=o?.savedAt||o?.createdAt||o?.ts||o?.timestamp||r.savedAt||r.createdAt||r.timestamp||"",J=o?.updatedAt||r.updatedAt||"",oe=(()=>{const y=T(x);return y.isValid()?y.toISOString():x})(),$=(()=>{const y=T(J);return y.isValid()?y.toISOString():J})(),A=r.serviceType||null,h=r.vehicleType||null;U?.(A),k?.(h);const B=Number(o?.totals?.labourSub||0)||0,M=Number(o?.totals?.labourGST||0)||0,R=B>0&&M>0?Math.round(M/B*100):S,N=Number(o?.totals?.labourDisc||0)||0;if(a.setFieldsValue({jcNo:r.jcNo||"",branch:r.branch||m(["Branch"])||void 0,mechanic:r.mechanic||m(["Allotted_Mechanic","Allotted Mechanic"])||void 0,executive:r.executive||m(["Executive"])||void 0,expectedDelivery:r.expectedDelivery?T(r.expectedDelivery,["DD-MM-YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY","YYYY-MM-DD",T.ISO_8601],!0):null,regNo:r.regNo||m(["Vehicle_No","Vehicle No"])||"",company:String(r.company||m(["Company"])||"").toUpperCase(),model:String(r.model||m(["Model"])||"").toUpperCase(),colour:r.colour||m(["Colour","Color"])||"",chassisNo:String(r.chassisNo||r.chassis||m(["Chassis_No","Chassis No"])||"").toUpperCase(),km:r.km||m(["KM","Odometer Reading","Odomete Reading"])?`${String(r.km||m(["KM","Odometer Reading","Odomete Reading"])).replace(/\D/g,"")} KM`:"",fuelLevel:r.fuelLevel||m(["Fuel_Level","Fuel Level"])||void 0,callStatus:r.callStatus||"",custName:r.custName||"",custMobile:String(r.custMobile||m(["Mobile"])||"").replace(/\D/g,"").slice(-10),obs:String(r.obs||m(["Customer_Observation"])||"").replace(/\s*#\s*/g,`
`),vehicleType:h||m(["Vehicle_Type","Vehicle Type"])||void 0,serviceType:A||m(["Service_Type","Service Type"])||void 0,floorMat:r.floorMat==="Yes"?"Yes":r.floorMat==="No"?"No":void 0,discounts:{labour:N},gstLabour:R,labourRows:Array.isArray(o?.labourRows)&&o.labourRows.length?o.labourRows:n(A,h),savedAt:oe||void 0,updatedAt:$||void 0}),Y?.(r.regNo||""),o?.followUp)try{const y=o.followUp;if(typeof y.enabled<"u"&&re?.(!!y.enabled),y.at){const Z=T(y.at);Z.isValid()&&xe?.(Z)}typeof y.notes<"u"&&je?.(String(y.notes||""))}catch{}Ae(o),v.success("Details filled from saved Job Card."),z(!1),ye([]),X("")}catch(r){console.warn("applyPayloadToForm error:",r),v.error("Could not apply fetched Job Card.")}},Ve=o=>{o&&o.formValues?at(o):Ge(o)},ft=async(o,r,d,m={})=>{const x=r||f,J=typeof d=="string"&&d?d:ae;Se.current=J,ge(J);const oe=!!m?.autoPickLatest,$=m?.source,A=$==="inline",B=((typeof o=="string"||typeof o=="number"?String(o):void 0)??Me??"").trim();if(!B){v.warning(x==="vehicle"?"Enter vehicle no. (KA03AB1234)":x==="jc"?"Enter a valid Job Card number.":"Enter a valid 10-digit mobile number."),A&&pe?.(!1,$);return}let M=B;if(x==="vehicle"){const R=Fe(B);if(!Dt.test(R)){v.warning("Enter vehicle no. as KA03AB1234."),A&&pe?.(!1,$);return}M=R,X(R)}else if(x==="jc")M=B,X(B);else{const R=Ne(B);if(!R||R.length!==10){v.warning("Enter a valid 10-digit mobile number."),A&&pe?.(!1,$);return}M=R,X(R)}ie(""),he(!0),A&&pe?.(!0,$);try{const R=await Jt(M,x);if(!R)throw new Error("No result");if(R.mode==="webhook"){const Z=R.rows||[];if(!Z.length){ht({source:$}),ye([]);return}const q=Z.map(Ce=>Ce?.payload||Ce);if(oe){const Ce=[...q].sort((yt,bt)=>kt(bt)-kt(yt));at(Ce[0]);return}if(q.length===1){const Ce=q[0];at(Ce);return}ye(q.slice(0,10)),v.info(`Found ${Z.length} matches. Pick one.`);return}const N=R.rows;let y=[];if(x==="jc")y=N.filter(Z=>O(Z,b.JCNo)===B);else{const Z=Ne(B)||B.replace(/\D/g,"");y=N.filter(q=>{const Ce=Ne(O(q,b.Mobile));return Z?Z.length<10?Ce.endsWith(Z):Ce===Z:!1})}if(!y.length){ht({source:$}),ye([]);return}if(y.sort((Z,q)=>$e(q).valueOf()-$e(Z).valueOf()),oe){Ge(y[0]);return}if(y.length===1){Ge(y[0]);return}ye(y.slice(0,10)),v.info(`Found ${y.length} matches. Pick one.`)}catch(R){console.error(R),v.error("Could not fetch job cards. Check the Apps Script/CSV link.")}finally{he(!1),A&&pe?.(!1,$)}},Qe=c.useRef("");return c.useEffect(()=>{const o=String(W?.query||"").trim();if(!o)return;const r=W?.mode==="vehicle"||W?.mode==="jc"?W.mode:"mobile",d=`${r}:${o}:${W?.token||""}`;if(Qe.current===d)return;Qe.current=d,P(r),X(o);const m=W?.openModal!==!1;z(m),setTimeout(()=>{ft(o,r,W?.prefill,{autoPickLatest:W?.autoPickLatest,source:W?.source})},0)},[W]),e.jsxs(e.Fragment,{children:[e.jsx(te,{type:"primary",style:{background:"#52c41a",borderColor:"#52c41a"},onClick:()=>{ie(""),z(!0)},children:"Fetch Details"}),e.jsx(mt,{title:"Fetch Job Card",open:le,onCancel:()=>{z(!1),ye([]),ie("")},footer:[e.jsx(te,{onClick:()=>{z(!1),ye([]),ie("")},children:"Close"},"close"),e.jsx(te,{type:"primary",loading:nt,onClick:()=>ft(),children:"Search"},"search")],children:e.jsxs(Vo,{direction:"vertical",style:{width:"100%"},children:[e.jsxs(Ut.Group,{value:f,onChange:o=>{P(o.target.value),X("")},children:[e.jsx(Ut.Button,{value:"mobile",children:"By Mobile"}),e.jsx(Ut.Button,{value:"vehicle",children:"By Vehicle No"}),e.jsx(Ut.Button,{value:"jc",children:"By JC No"})]}),e.jsx(me,{placeholder:f==="vehicle"?"Enter Vehicle No (KA03AB1234)":f==="jc"?"Enter JC No":"Enter Mobile (10-digit)",value:Me,inputMode:f==="vehicle"||f==="jc"?"text":"numeric",onChange:o=>{const r=o.target.value||"";if(f==="vehicle"){const d=r.toUpperCase().replace(/[^A-Z0-9]/g,"");if(!Ee(d))return;X(d)}else if(f==="jc")X(String(r||"").toUpperCase());else{const d=String(r||"").replace(/\D/g,"").slice(0,10);X(d)}},onPressEnter:()=>ft(),allowClear:!0}),ke&&e.jsx(Ks,{type:"warning",showIcon:!0,message:ke}),nt&&e.jsx(zs,{}),Oe.length>1&&e.jsx(Wt,{size:"small",bordered:!0,dataSource:Oe,renderItem:o=>{const r=o&&o.formValues,d=r?o.formValues:null,m=r?d.jcNo||"â€”":O(o,b.JCNo)||"â€”",x=r?d.custName||"â€”":O(o,b.CustName)||"â€”",J=r?String(d.custMobile||"").replace(/\D/g,"").slice(-10)||"â€”":Ne(O(o,b.Mobile))||"â€”",oe=r?d.regNo||"â€”":O(o,b.RegNo)||"â€”",$=r?Tt(d.expectedDelivery):null,A=r?$?$.format("DD-MM-YYYY HH:mm"):d.expectedDelivery||"-":$e(o).format("DD-MM-YYYY HH:mm");return e.jsx(Wt.Item,{role:"button",tabIndex:0,onClick:()=>Ve(o),onKeyDown:h=>{(h.key==="Enter"||h.key===" ")&&Ve(o)},style:{cursor:"pointer"},actions:[e.jsx(te,{type:"link",onClick:h=>{h.stopPropagation(),Ve(o)},children:"Use"})],children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",width:"100%"},children:[e.jsxs("div",{children:[e.jsx("b",{children:"JC:"})," ",m," Â  ",e.jsx("b",{children:"Name:"})," ",x]}),e.jsxs("div",{children:[e.jsx("b",{children:"Mobile:"})," ",J," Â  ",e.jsx("b",{children:"Vehicle:"})," ",oe]}),e.jsxs("div",{style:{gridColumn:"1 / span 2",color:"#999"},children:[e.jsxs("b",{children:[r?"Expected Delivery":"Timestamp",":"]})," ",A]})]})})}})]})})]})}const{Title:_o,Text:Us}=Lo,{Option:En}=Ht,Ho="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",Pe=Ho,Is="",Wo=["Byadarahalli","Kadabagere","Muddinapalya","Andrahalli","Tavarekere","Hegganahalli","Channenahalli","Nelagadrahalli"],cs=[{name:"Rukmini",phone:"9901678562"},{name:"Meghana",phone:"9741609799"},{name:"Shubha",phone:"8971585057"},{name:"Rani",phone:"9108970455"},{name:"Likhitha",phone:"9535190015"},{name:"Vanitha",phone:"9380729861"},{name:"Prakash",phone:"9740176476"},{name:"Swathi",phone:"6363116317"},{name:"Kumar",phone:"7975807667"},{name:"Sujay",phone:"7022878048"},{name:"Kavi",phone:"9108970455"},{name:"Narasimha",phone:"9900887666"},{name:"Kavya",phone:"8073165374"}],Bs=["Free","Paid","Minor","Accidental"],_s=["Motorcycle","Scooter"],Hs=["SONU","KARTHIK","MANMOHAN","MANSUR","IRSHAD","DAKSHAT","SALMAN"],Ws={SONU:"7033558306",KARTHIK:"7338386813",MANMOHAN:"9956079799",MANSUR:"7795047627",IRSHAD:"6207176821",DAKSHAT:"7829096931",SALMAN:"7892335161"},Zs=a=>{const p=String(a||"").trim();return p&&(Ws[p]||Ws[p.toUpperCase()])||""},Jo=["Empty","Â¼","Â½","Â¾","Full"],st=0,Js={Scooter:{base:[{desc:"Engine oil",rate:450},{desc:"Consumables",rate:70},{desc:"Gearbox oil",rate:80}]},Motorcycle:{base:[{desc:"Engine oil",rate:450},{desc:"Consumables",rate:80},{desc:"Chain lubrication",rate:70}]},paidAddons:[{desc:"Service Labour",rate:400},{desc:"Water wash",rate:150}]},qo="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYGuNPY_2ivfS7MTX4bWiu1DWdF2mrHSCnmTznZVEHxNmsrgcGWjVZN4UDUTOzQQdXTnbeM-ylCJbB/pub?gid=408799621&single=true&output=csv",Ko=a=>{const p=[];let n=[],S="",_=!1;for(let U=0;U<a.length;U++){const k=a[U],Y=a[U+1];if(k==='"'&&!_){_=!0;continue}if(k==='"'&&_){if(Y==='"'){S+='"',U++;continue}_=!1;continue}if(k===","&&!_){n.push(S),S="";continue}if((k===`
`||k==="\r")&&!_){(S!==""||n.length)&&(n.push(S),p.push(n),n=[],S=""),k==="\r"&&Y===`
`&&U++;continue}S+=k}return(S!==""||n.length)&&(n.push(S),p.push(n)),p},ls={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"]},ds=(a,p)=>String(p.map(n=>a[n]??"").find(n=>n!=="")||"").trim(),zo=(a={})=>({company:ds(a,ls.company),model:ds(a,ls.model),variant:ds(a,ls.variant)}),Zo=(a={})=>({company:String(a["Company Name"]||a.company||"").trim(),model:String(a["Model Name"]||a.model||"").trim(),variant:String(a.Variant||a.variant||"").trim()});async function qs(a,p,n){try{const S=await Eo(a,p,n);if(S?.success&&S?.serial)return String(S.serial)}catch(S){console.warn("Reserve JC serial failed; falling back to timestamp:",S?.message||S)}return T().format("YYMMDDHHmmss")}function Go(a){const p=String(a||"").toUpperCase();return p.length>10||!/^[A-Z0-9]*$/.test(p)?!1:[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(S=>S.test(p))}function _e(a,p=""){const n=String(a||"").toUpperCase().replace(/[^A-Z0-9]/g,"");return Go(n)?n.slice(0,10):p||""}const Bt=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,se=a=>typeof a=="string"?a.toUpperCase():a,ut=a=>se(a?.target?.value??a),us=a=>Array.isArray(a)?a.map(p=>({...p,desc:se(p?.desc||"")})):[],Ct=a=>String(a||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20);function _t(a,p){if(!a||!p)return[];const n=String(a||"").toLowerCase(),S=n==="paid";if(!S&&!(n==="free"))return[];const k=(Js[p]?.base??[]).map(Y=>({desc:se(Y.desc),qty:1,rate:Y.rate}));return S&&k.push(...Js.paidAddons.map(Y=>({desc:se(Y.desc),qty:1,rate:Y.rate}))),k}const Le=a=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(Math.max(0,Math.round(Number(a||0)))),ms={locked:!1,at:null,mobile:null,amount:null,mode:null};async function Qo(a){const p=await ot({webhookUrl:Pe,method:"POST",payload:{action:"save",data:a}});return p?.data||p}function Gs(){try{const a=localStorage.getItem("user"),p=a?JSON.parse(a):null,n=String(p?.phone||"").replace(/\D/g,"");return n.length===10?`+91${n}`.replace("+",""):n.length===12&&n.startsWith("91")?n:""}catch{return""}}function ps(a){const p=String(a||"").replace(/\D/g,"");return p.length===10?`91${p}`:p.length===12&&p.startsWith("91")?p:""}function Xo(a,p){const n=a?.expectedDelivery?T(a.expectedDelivery).format("DD-MM-YYYY HH:mm"):"â€”",S=a?.createdAt?T(a.createdAt).format("DD-MM-YYYY HH:mm"):"â€”",_=Gs(),U=a?.branch||"â€”",k=(a?.custName?String(a.custName).trim():"")||"Customer",Y=a?.jcNo||"â€”",ne=a?.regNo||"â€”",re=Le(p?.grand??0),xe=a?.obs?a.obs.split(`
`).map(f=>f.trim()).filter(Boolean):[],je=xe.length?`*Customer Observations:*
${xe.map(f=>`- ${f}`).join(`
`)}

`:"",Q=(a?.mechanic?String(a.mechanic).trim():"")||"",W=Q?Zs(Q):"",ae=Q?`ðŸ‘· Assigned Mechanic: ${Q}${W?` (â˜Žï¸ ${W})`:""}
`:"",pe=String(U).toLowerCase().replace(/[^a-z]/g,""),we=pe.includes("byadarahalli")||pe.includes("badrally"),le=we?"NH Motors":"Shantha Motors";return`Hi ${k}! ðŸ‘‹

âœ… Your bike service is confirmed at ${le}.

Welcome to ${le},
${we?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}à²—à³† à²¸à³à²µà²¾à²—à²¤ ðŸï¸âœ¨

ðŸ§¾ Job Card: ${Y}
ðŸ•’ Job Card Created: ${S}
ðŸï¸ Vehicle: ${ne}
ðŸ“… Delivery Date: ${n}
ðŸ’° Estimated Cost (à²…à²‚à²¦à²¾à²œà³ à²µà³†à²šà³à²š): ${re}

`+ae+je+`â„¹ï¸ Final prices may vary based on actual service needs.

Need any help? Just reply here.

â€” ${a?.executive||"Team"}, ${U}${_?` (â˜Žï¸ ${_})`:""}`}function en(a){const p=(a?.custName?String(a.custName).trim():"")||"â€”",n=a?.custMobile?String(a.custMobile).replace(/\D/g,"").slice(-10):"â€”",S=(a?.model?String(a.model).trim():"")||"â€”",_=(a?.regNo?String(a.regNo).trim():"")||"â€”",U=(a?.serviceType?String(a.serviceType).trim():"")||"â€”",k=(a?.floorMat?String(a.floorMat).trim():"")||"â€”",Y=a?.createdAt?T(a.createdAt).format("DD-MM-YYYY HH:mm"):"â€”",ne=String(a?.km??"").toUpperCase().trim(),re=ne.replace(/\s*KM\s*$/i,"").replace(/\D/g,""),xe=re?`${re} KM`:ne||"â€”",je=a?.obs?a.obs.split(`
`).map(W=>W.trim()).filter(Boolean):[],Q=je.length?je.map(W=>`â€¢ ${W}`).join(`
`):"â€¢ â€”";return["*Job Card Details (Mechanic)* ðŸ› ï¸","",`ðŸ•’ Job Card Created: ${Y}`,`ðŸ‘¤ Customer Name: ${p}`,`ðŸ“ž Mobile Number: ${n}`,`ðŸ”§ Model: ${S}`,`ðŸï¸ Vehicle Number: ${_}`,`ðŸ§¼ Floor Mat: ${k}`,`ðŸ› ï¸ Service Type: ${U}`,`ðŸ§¾ Odometer Rating: ${xe}`,"","*Customer Observation:*",Q].join(`
`)}function hs({mobileE164:a,text:p,onFailToWhatsApp:n,allowSmsFallback:S=!0}){const _=`https://wa.me/${a}?text=${encodeURIComponent(p)}`,U=window.open(_,"_blank","noopener,noreferrer");if(!U||U.closed||typeof U.closed>"u"){if(n?.(),S){const Y=`sms:+${a}?body=${encodeURIComponent(p)}`;window.location.href=Y}return{opened:!1,blocked:!0}}return S?(setTimeout(()=>{try{if(U.closed)return;n?.(),U.close();const Y=`sms:+${a}?body=${encodeURIComponent(p)}`;window.location.href=Y}catch{n?.();const Y=`sms:+${a}?body=${encodeURIComponent(p)}`;window.location.href=Y}},1e3),{opened:!0,blocked:!1}):{opened:!0,blocked:!1}}function tn(a,p,n,S={}){const _=a?.jcNo||"â€”",U=a?.regNo||"â€”",k=a?.model||"",Y=a?.colour?String(a.colour).trim():"",ne=a?.km?String(a.km).replace(/\D/g,""):"",re=a?.branch||"â€”",xe=a?.executive||"Team",je=Gs(),Q=String(re).toLowerCase().replace(/[^a-z]/g,""),W=Q.includes("byadarahalli")||Q.includes("badrally"),ae=W?"NH Motors":"Shantha Motors",pe=W?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³",we=T().format("DD-MM-YYYY HH:mm"),le=b=>String(b).replace(/\s+/g," ").trim(),z=b=>Le(Math.round(Number(b||0))),f=(n||[]).map((b,O)=>{const Je=Number(b?.qty||0),I=Number(b?.rate||0),Ne=Je*I,Fe=String(b?.desc||"").trim()||"Item";return`${O+1}. ${le(Fe)} â€” ${Je} Ã— ${z(I)} = ${z(Ne)}`}),P=z(p?.labourSub||0),Me=Math.max(0,Math.round(Number(p?.labourDisc||0))),X=z(Me),nt=z(p?.grand||0),he=S||{},Oe=z(he?.collectedAmount||0),ye=he?.cashCollected?z(he.cashCollected):"",ke=he?.onlineCollected?z(he.onlineCollected):"",ie=Array.isArray(he?.payments)?he.payments.filter(b=>String(b.mode).toLowerCase()==="online"&&b.utr).map(b=>String(b.utr).trim()).filter(Boolean).join(" / "):"",He=he?.paymentMode?String(he.paymentMode).toUpperCase():"";let ge="";const Se=Number(ne||"");Number.isFinite(Se)&&Se>0&&(ge=String(Se+2e3));const We=Me>0?`Discount: ${X}`:"",Re=`ðŸ’³ *Mode Of Payment (${He||"NA"})*`,de=[];ye&&de.push(`â€¢ Cash: ${ye}`),ke&&de.push(`â€¢ Online: ${ke}${ie?` (UTR: ${ie})`:""}`),de.length?de.push(`â€¢ Total Paid: ${Oe}`):de.push(`â€¢ Total Paid: ${Oe}`);const pt=[Re,...de];return[`â­ï¸ *${ae}* â€” ${pe}`,"Multi Brand Two Wheeler Sales & Service","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","*âœ”ï¸ Service Invoice*","",`ðŸ“… Date: ${we}`,`ðŸ§¾ JC No: ${_}`,"","ðŸï¸ *Vehicle Details*",`â€¢ Vehicle: ${U}${k?` (${k})`:""}${Y?` â€¢ ${Y}`:""}`,...ne?[`â€¢ Odometer Reading: ${ne} km`]:[],...ge?[`â€¢ *Next Service Due:* ${ge} km`]:[],"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","","ðŸ› ï¸ *Service Details*",...f.length?f.map(b=>`â€¢ ${b}`):["â€¢ â€”"],"",`Subtotal: ${P}`,...We?[We]:[],`ðŸ’° *Final Bill Amount:* ${nt}`,"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","",...pt,"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","",`ðŸ™ Thank you for choosing *${ae}*!`,"à²§à²¨à³à²¯à²µà²¾à²¦à²—à²³à³ â¤ï¸",`â€” ${xe}, ${re}${je?` (â˜Žï¸ ${je})`:""}`].join(`
`)}function Vn({initialValues:a=null}={}){const p=Do(),[n]=w.useForm(),[,S]=c.useState(),[_,U]=c.useState(""),[k,Y]=c.useState(""),[ne,re]=c.useState([]),[xe,je]=c.useState(!1),[Q,W]=c.useState(""),[ae,pe]=c.useState(""),[we,le]=c.useState(""),[z,f]=c.useState([]),P="JobCard:outbox",Me=6e3,X=c.useRef({jcNo:"",ts:0,inFlight:!1}),nt=s=>{const t=X.current;t.jcNo===s&&(t.inFlight=!1)},he=(s,t)=>{try{const l=localStorage.getItem(s);return l?JSON.parse(l):t}catch{return t}},Oe=(s,t)=>{try{localStorage.setItem(s,JSON.stringify(t))}catch{}},ye=s=>{const t=he(P,[]),l={id:Date.now()+":"+Math.random().toString(36).slice(2),job:s};return t.push(l),Oe(P,t),l.id},ke=s=>{const t=he(P,[]);Oe(P,t.filter(l=>l.id!==s))},[ie,He]=c.useState(""),[ge,Se]=c.useState(null),[We,Re]=c.useState(null),[de,pt]=c.useState(!1),[At,b]=c.useState(""),O=c.useRef(null),Je=c.useRef(null),[I,Ne]=c.useState(!1),[Fe,Dt]=c.useState(!1),[Ee,ht]=c.useState(!1),[Tt,$e]=c.useState(!1),[kt,qe]=c.useState(1),[Ae,Ye]=c.useState({customer:!1,mechanic:!1,pre:!1}),[Ke,ze]=c.useState(!1),[Ze,Jt]=c.useState("cash"),[rt,gt]=c.useState(""),[Ge,at]=c.useState(""),[Ve,ft]=c.useState("online"),[Qe,o]=c.useState(""),[r,d]=c.useState(""),[m,x]=c.useState(""),[J,oe]=c.useState(ms),[$,A]=c.useState(0),[h,B]=c.useState(!1),[M,R]=c.useState(!1),[N,y]=c.useState([]),[Z,q]=c.useState(!1),[Ce,yt]=c.useState(null),[bt,qt]=c.useState(null),[be,vt]=c.useState(!1),[gs,Kt]=c.useState(null),zt=c.useRef(""),Zt=c.useRef(""),[xt,fs]=c.useState([]),[Yt,Gt]=c.useState(""),Pt=(s=6e3)=>{const t=Date.now()+s;A(t),setTimeout(()=>A(0),s+50)},[,ys]=c.useState(!1),[,bs]=c.useState(()=>T().add(2,"day").hour(10).minute(0).second(0).millisecond(0)),[,vs]=c.useState(""),Qs=["createdAt","branch","mechanic","executive","expectedDelivery","regNo","company","model","km","custName","custMobile","serviceType","vehicleType"],xs=s=>{const t=[...Qs];return s?.vehicleType==="Scooter"&&t.push("floorMat"),String(s?.serviceType||"").toLowerCase()==="free"&&t.push("chassisNo"),t},Ss=async()=>{try{const s=he(P,[]);if(!Array.isArray(s)||!s.length)return;for(const t of s){const l=t.job||{};try{if(l.type==="save"&&Pe){const i=await ot({webhookUrl:Pe,method:"POST",payload:{action:"save",data:l.data}});(i?.data||i)?.success!==!1&&ke(t.id)}else if(l.type==="post"&&Pe){const i=await ot({webhookUrl:Pe,method:"POST",payload:{action:"postService",data:l.data}});(i?.data||i)?.success!==!1&&ke(t.id)}}catch{}}}catch{}};c.useEffect(()=>{setTimeout(()=>{Ss()},0)},[]),c.useEffect(()=>{const s=()=>Ss();return window.addEventListener("online",s),()=>window.removeEventListener("online",s)},[]);const Xe=()=>{const s=n.getFieldsValue(!0),t=xs(s),l=t.every(g=>{const C=n.getFieldValue(g);return C!=null&&String(C).trim()!==""}),i=n.getFieldsError(t).some(({errors:g})=>g.length>0);let u="";if(l)i&&(u="Fix validation errors in highlighted fields.");else{const g=t.filter(C=>{const H=n.getFieldValue(C);return H==null||String(H).trim()===""});g.length&&(u=`Missing: ${g.join(", ")}`)}pt(l&&!i),b(u)},Xs=async()=>{const s=n.getFieldsValue(!0),t=xs(s);await n.validateFields(t)},Ns=c.useMemo(()=>({jcNo:"",createdAt:T(),expectedDelivery:T(),branch:void 0,executive:void 0,mechanic:"",serviceType:void 0,vehicleType:void 0,floorMat:"No",fuelLevel:void 0,regNo:"",company:"",model:"",colour:"",chassisNo:"",km:void 0,custName:"",custMobile:"",obs:"",labourRows:[],gstLabour:st,discounts:{labour:0}}),[]),js=c.useMemo(()=>{try{const s=p?.search||"";if(!s)return null;const t=new URLSearchParams(s),l=_e(t.get("regNo")||"",""),i=se(t.get("company")||""),u=se(t.get("model")||""),g=se(t.get("colour")||t.get("color")||""),C=se(t.get("custName")||t.get("customerName")||""),H=t.get("custMobile")||t.get("mobile")||"",F=Ct(t.get("chassisNo")||t.get("chassis")||"");return[l,i,u,g,F,C,H].some(V=>String(V||"").trim())?{formValues:{regNo:l,company:i,model:u,colour:g,chassisNo:F,custName:C,custMobile:String(H||"").replace(/\D/g,"").slice(-10)}}:null}catch{return null}},[p?.search]),eo=c.useMemo(()=>{try{const s=p?.search||"";if(!s)return null;const t=new URLSearchParams(s);if(!(t.get("autoFetch")||t.get("fetch")))return null;const i=t.get("query")||t.get("mobile")||t.get("custMobile")||t.get("jcNo")||t.get("jc")||"";if(!String(i||"").trim())return null;let u=t.get("mode")||"";return u||(t.get("jcNo")||t.get("jc")?u="jc":t.get("vehicle")||t.get("reg")?u="vehicle":u="mobile"),{mode:u,query:i}}catch{return null}},[p?.search]);c.useEffect(()=>{let s=!1;return(async()=>{try{const l=await fetch(qo,{cache:"no-store"});if(!l.ok)throw new Error("sheet fetch failed");const i=await l.text();if(i.trim().startsWith("<"))throw new Error("expected CSV, got HTML");const u=Ko(i);if(!u.length)throw new Error("empty sheet");const g=u[0].map(F=>(F||"").trim()),H=u.slice(1).map(F=>{const E={};return g.forEach((V,G)=>E[V]=F[G]??""),E}).map(zo).filter(F=>F.company&&F.model);s||fs(H)}catch{try{const l=await fetch("/bikeData.json",{cache:"no-store"});if(!l.ok)throw new Error("fallback missing");const i=await l.json(),u=(Array.isArray(i)?i:[]).map(Zo).filter(g=>g.company&&g.model);s||fs(u)}catch{}}})(),()=>{s=!0}},[]),c.useEffect(()=>{const s=a||js;if(s)try{const t=s.formValues||s,l=K=>{if(!K)return T();const D=T(K,["DD-MM-YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY","YYYY-MM-DD",T.ISO_8601],!0);return D.isValid()?D:null},i=t.km?`${String(t.km).replace(/\D/g,"")} KM`:"",u=_e(t.regNo||"",""),g=se(t.company||""),C=se(t.model||""),H=se(t.colour||""),F=Ct(t.chassisNo||t.chassis||""),E=se(t.custName||""),V=se((t.obs||"").replace(/\s*#\s*/g,`
`)),G={jcNo:t.jcNo||"",branch:t.branch||void 0,mechanic:t.mechanic||void 0,executive:t.executive||void 0,expectedDelivery:l(t.expectedDelivery),regNo:u,company:g,model:C,colour:H,chassisNo:F,km:i,fuelLevel:t.fuelLevel||void 0,custName:E,custMobile:String(t.custMobile||"").replace(/\D/g,"").slice(-10),obs:V,vehicleType:t.vehicleType||void 0,serviceType:t.serviceType||void 0,floorMat:t.floorMat==="Yes"?"Yes":t.floorMat==="No"?"No":void 0,discounts:{labour:0},gstLabour:st,labourRows:us(Array.isArray(a?.labourRows)&&a.labourRows.length?a.labourRows:_t(t.serviceType,t.vehicleType))};n.setFieldsValue(G),He(G.regNo||""),g&&Gt(g),Se(t.serviceType||null),Re(t.vehicleType||null)}catch{}},[a,js]),c.useEffect(()=>{(async()=>{try{const s=u=>String(u||"").trim().toUpperCase(),t=()=>{try{const u=localStorage.getItem("user");return u?JSON.parse(u):null}catch{return null}},l=u=>u?typeof u=="string"?u:typeof u=="object"&&(u._id||u.id||u.$oid)||null:null;let i=t();if(!i||!i.formDefaults){const u=await To().catch(()=>null);if(u?.success&&u.data){i=u.data;try{localStorage.setItem("user",JSON.stringify(i))}catch(g){}}}if(i){const u=i?.formDefaults?.staffName||i?.name||void 0,g=u?s(u):void 0,C=i?.role?String(i.role).toLowerCase():void 0,H=!!i?.canSwitchBranch||["owner","admin","backend"].includes(String(C||"").toLowerCase());je(H);try{const K=String(C||"").toLowerCase();if(["owner","admin","backend"].includes(K)){try{const D=await Po({status:"active",limit:500});if(D?.success&&Array.isArray(D?.data?.items)){const De=D.data.items.filter(ue=>String(ue?.status||"").toLowerCase()==="active").map(ue=>({id:String(ue.id||ue._id||""),name:s(ue.name),code:ue.code?String(ue.code).toUpperCase():""}));re(De)}}catch{}try{const D=await Ro({role:"staff",status:"active",limit:1e5});if(D?.success&&Array.isArray(D?.data?.items)){const ee=D.data.items.map(De=>({name:De.name,phone:De.phone||""}));f(ee)}}catch{}}else{const D=[],ee=ce=>{if(!ce)return;const jt=typeof ce=="string"?"":String(ce?.status||"").toLowerCase();if(jt&&jt!=="active")return;const wt=ce&&(ce._id||ce.id||ce.$oid||ce)||"",Lt=typeof ce=="string"?"":ce?.name||"",dt=s(Lt),et=typeof ce=="string"?"":ce?.code||"";!wt||!dt||D.push({id:String(wt),name:String(dt),code:et?String(et).toUpperCase():""})};i?.primaryBranch&&ee(i.primaryBranch),Array.isArray(i?.branches)&&i.branches.forEach(ee);const De=new Set,ue=[];D.forEach(ce=>{De.has(ce.id)||(De.add(ce.id),ue.push(ce))}),re(ue)}}catch{}let F=i?.formDefaults?.branchName?s(i.formDefaults.branchName):void 0;const E=i?.formDefaults?.branchCode&&String(i.formDefaults.branchCode).toUpperCase()||"";if(E){pe(E);try{n.setFieldsValue({branchCode:E})}catch{}}const V=i?.formDefaults&&(i.formDefaults.branchId?._id||i.formDefaults.branchId||null)||i?.primaryBranch&&(i.primaryBranch?._id||i.primaryBranch||null)||Array.isArray(i?.branches)&&i.branches.length&&(i.branches[0]?._id||i.branches[0])||null;if(V)try{const K=await Fo(String(V)).catch(()=>null);if(K?.success&&K?.data&&(F||(F=K.data.name),K?.data?.code&&!ae)){const D=String(K.data.code).toUpperCase();pe(D),le(String(K.data.id||V));try{n.setFieldsValue({branchCode:D})}catch{}}}catch{}g&&S(g),C&&U(C);const G={};try{const K=n.getFieldsValue(["branch","executive"])||{};!K?.executive&&g&&(G.executive=g),!K?.branch&&F&&(G.branch=F)}catch{}Object.keys(G).length&&n.setFieldsValue(G),F&&Y(F),g&&W(g)}}catch{}})()},[n]);const to=ko.useMemo(()=>{const s=new Map;return(ne||[]).forEach(t=>s.set(String(t.name||"").toLowerCase(),t)),s},[ne]),so=s=>{try{const t=String(s||"").toLowerCase(),l=to.get(t);if(l){le(l.id),l.code&&pe(String(l.code).toUpperCase());try{n.setFieldsValue({branch:l.name,branchCode:l.code?String(l.code).toUpperCase():void 0})}catch{}}}catch{}},it=w.useWatch("branch",n),ws=w.useWatch("executive",n),oo=String(it||k||"").trim().toLowerCase().replace(/\s+/g,"").includes("byadarahalli");c.useEffect(()=>{const s={};!it&&k&&(s.branch=k),!ws&&Q&&(s.executive=Q),Object.keys(s).length&&n.setFieldsValue(s)},[it,ws,k,Q]);const St=c.useMemo(()=>{const s=String(_||"").toLowerCase();return["owner","admin","backend"].includes(s)?"":it||k||""},[_,it,k]),Qt=c.useMemo(()=>{const s=String(_||"").toLowerCase();return["owner","admin","backend"].includes(s)?!0:!!String(St||"").trim()},[_,St]),Rt=Z?N.length:null,no=s=>{const t=s?.values||s||{},l=s?.payload||t.Payload||t.payload||t.PAYLOAD||s?.Payload||s?.PAYLOAD||"";let i={};try{i=typeof l=="object"?l:JSON.parse(String(l||"{}"))}catch{i={}}const u=i.formValues||i.values||{},g=(G,K)=>{for(const D of K){const ee=G?.[D];if(ee!=null&&String(ee).trim()!=="")return String(ee).trim()}return""},C=i?.postServiceAt||t["Post Service At"]||t.Post_Service_At||t.PostServiceAt||"",H=Array.isArray(i?.payments)&&i.payments.some(G=>Number(G?.amount||0)>0),F=C||H?"completed":"pending";let E=i?.followUp?.at||i?.followup?.at||i?.followUpAt||t["Follow-up At"]||t["Follow Up At"]||t["Followup At"]||t["Follow-up Date"]||t["Follow Up Date"]||t["Followup Date"]||"";if(!E){const G=t["Follow-up Date"]||t["Follow Up Date"]||t["Followup Date"]||"",K=t["Follow-up Time"]||t["Follow Up Time"]||t["Followup Time"]||"";G&&K&&(E=`${G} ${K}`)}const V=E?T(E,["DD-MM-YYYY HH:mm","DD/MM/YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY",T.ISO_8601],!0):null;return{jcNo:u.jcNo||g(t,["JC No","JC No.","Job Card No","JC Number"])||"-",name:u.custName||g(t,["Customer Name","Customer_Name","Name"])||"-",mobile:String(u.custMobile||g(t,["Mobile","Mobile Number","Phone"])||"").replace(/\D/g,"").slice(-10),regNo:u.regNo||g(t,["Vehicle No","Vehicle_No","Reg No","Registration Number"])||"-",branch:u.branch||g(t,["Branch","Branch Name"])||"-",followUpAt:V&&V.isValid()?V.format("DD-MM-YYYY HH:mm"):E||"",followUpNotes:i?.followUp?.notes||i?.followupNotes||i?.followUpNotes||t["Follow-up Notes"]||t["Follow Up Notes"]||t["Followup Notes"]||"",status:F,payload:i}},Xt=async({silent:s=!1}={})=>{if(!Qt){y([]),q(!1);return}s||R(!0);try{const t={action:"list",status:"pending",page:1,pageSize:200},l=St?{branch:St}:{},i=Is?{...t,...l,secret:Is}:{...t,...l},u=await ot({webhookUrl:Pe,method:"GET",payload:i}),g=u?.data||u,F=(Array.isArray(g?.data)?g.data:Array.isArray(g?.rows)?g.rows:[]).map(no).filter(E=>E&&E.jcNo!=="-").filter(E=>E.status==="pending");y(F),q(!0)}catch{y([]),q(!0)}finally{s||R(!1)}};c.useEffect(()=>{if(!Qt){y([]),q(!1);return}y([]),q(!1),Xt({silent:!0})},[Qt,St]);const ro=s=>{const t=_e(s.target.value,ie);He(t),n.setFieldsValue({regNo:t}),String(t||"").length<10&&(zt.current="")},ao=Bt.test(_e(ie||n.getFieldValue("regNo")||"",ie||"")),Ms=w.useWatch("labourRows",n),Ue=c.useMemo(()=>us(Ms||[]),[Ms]),Cs=w.useWatch("gstLabour",n)??st,As=w.useWatch("discounts",n),Ds=c.useMemo(()=>As||{labour:0},[As]),io=w.useWatch("km",n),ct=w.useWatch("company",n),Ts=w.useWatch("custMobile",n);c.useEffect(()=>{const s=_e(ie||n.getFieldValue("regNo")||"",ie||"");String(s||"").length<10||Bt.test(s)&&(be||zt.current!==s&&(zt.current=s,Et("vehicle")))},[ie,be,n]),c.useEffect(()=>{const s=String(Ts||"").replace(/\D/g,"").slice(-10);s.length===10&&(be||Zt.current!==s&&(Zt.current=s,Et("mobile")))},[Ts,be]);const ve=c.useMemo(()=>{const s=Ue.reduce((u,g)=>u+Number(g?.qty||0)*Number(g?.rate||0),0),t=s*(Number(Cs)/100),l=Number(Ds.labour||0),i=Math.max(0,s+t-l);return{labourSub:s,labourGST:t,labourDisc:l,grand:i}},[Ue,Cs,Ds]),co=c.useMemo(()=>Vs(xt.map(s=>s.company)),[xt]),lo=c.useMemo(()=>{const s=Ls(ct||Yt),t=s?xt.filter(l=>Ls(l.company)===s):xt;return Vs(t.map(l=>l.model))},[xt,ct,Yt]);c.useEffect(()=>{ct&&ct!==Yt&&Gt(ct)},[ct,Yt]);const ks=c.useMemo(()=>{const s=J.at;if(!s)return"";const t=T(s);return t.isValid()?t.format("DD-MM-YYYY HH:mm"):String(s)},[J.at]),fe=!!J.locked,es=c.useMemo(()=>{const s=Number(rt||0)||0,t=Number(Qe||0)||0;return Math.round(s+t)},[rt,Qe]),ts=c.useMemo(()=>Math.round(Number(ve?.grand||0)),[ve]),lt=c.useMemo(()=>ts-es,[es,ts]),uo=s=>{/[0-9]/.test(s.key)||s.preventDefault()},mo=s=>{/[0-9]/.test(s.key)||s.preventDefault()},po=s=>{const t=s.target.value;/^\d*$/.test(t)&&(t.length>10||(J.locked&&J.mobile&&J.mobile!==t&&oe(ms),n.setFieldsValue({custMobile:t}),String(t||"").length<10&&(Zt.current="")))},Ft=(Number(String(io||"").replace(/\D/g,""))||0)>1e4,Et=s=>{if(s==="vehicle"){const l=ie||n.getFieldValue("regNo")||"",i=_e(l,ie||"");if(!Bt.test(i)){v.warning("Enter vehicle no. as KA03AB1234.");return}Kt("vehicle"),vt(!0),qt({mode:"vehicle",query:i,token:Date.now(),prefill:"basic",autoPickLatest:!0,openModal:!1,source:"inline"});return}const t=String(n.getFieldValue("custMobile")||"").replace(/\D/g,"").slice(-10);if(t.length!==10){v.warning("Enter a valid 10-digit mobile number.");return}Kt("mobile"),vt(!0),qt({mode:"mobile",query:t,token:Date.now(),prefill:"basic",autoPickLatest:!0,openModal:!1,source:"inline"})},ho=Bs.map(s=>({label:s,value:s,disabled:s==="Free"&&Ft})),Nt=(s={})=>{const t={...s};return t.regNo=_e(t.regNo||""),t.company=se(t.company||""),t.model=se(t.model||""),t.colour=se(t.colour||""),t.chassisNo=Ct(t.chassisNo||t.chassis||""),t.custName=se(t.custName||""),t.obs=se(t.obs||""),t.labourRows=us(t.labourRows||[]),t},go=s=>{let t=null;if(s.length===0?t=null:s.length===1?t=s[0]:t=s.find(l=>l!==ge)||s[0],Ft&&t==="Free"){v.warning("Free service is not allowed above 10,000 KM.");return}if(Se(t||null),n.setFieldsValue({serviceType:t||void 0}),t){const l="Motorcycle";Re(l),n.setFieldsValue({vehicleType:l,labourRows:_t(t,l),gstLabour:st,discounts:{labour:0},floorMat:"No"}),v.success(`Applied preset: ${t} / ${l}`)}else n.setFieldsValue({labourRows:[]});Xe()};c.useEffect(()=>{Ft&&ge==="Free"&&(Se(null),n.setFieldsValue({serviceType:void 0}),Xe(),v.warning("Free service disabled for odometer above 10,000 KM."))},[Ft,ge,n]),c.useEffect(()=>{Xe()},[]);const Ys=async s=>{Date.now()<$||(Pt(6e3),await new Promise(requestAnimationFrame),s==="pre"?await Es(O.current):s==="post"&&await Es(Je.current))},fo=s=>s?T(s).format("DD-MM-YYYY HH:mm"):"",ss=" # ",os=async()=>{try{await Xs();const s=Nt(n.getFieldsValue(!0));let t=s.jcNo;if(!/^JC-[A-Z]+-[A-Z0-9]{6}$/.test(String(t||"").trim())){try{t=await qs(s.custMobile,ae||(n.getFieldValue("branchCode")||"").toUpperCase(),we)}catch{t=T().format("YYMMDDHHmmss")}n.setFieldsValue({jcNo:t}),v.success(`JC No. assigned: ${t}`)}const i=X.current,u=Date.now();if(i.jcNo===t&&(i.inFlight||u-i.ts<Me))return;i.jcNo=t,i.ts=u,i.inFlight=!0;const g=Number.isFinite(ve.grand)?Math.round(ve.grand):0,C=String(s.km||"").replace(/\D/g,""),H=typeof s.floorMat=="string"?s.floorMat:s.floorMat===!0?"Yes":(s.floorMat===!1,"No"),F=String(s.obs||"").replace(/\s*\r?\n\s*/g,ss).replace(new RegExp(`^(?:\\s*${ss}\\s*)+|(?:\\s*${ss}\\s*)+$`,"g"),"").trim(),E=new Date().toISOString(),V=s.savedAt||n.getFieldValue("savedAt")||s.createdAt,K=(typeof V=="string"&&V.trim()?V:T.isDayjs(V)||V instanceof Date&&!isNaN(V.getTime())?V.toISOString():"")||E;try{n.setFieldsValue({savedAt:K})}catch{}const D={savedAt:K,updatedAt:E,formValues:{jcNo:t,branch:s.branch||"",mechanic:s.mechanic||"",executive:s.executive||"",expectedDelivery:fo(s.expectedDelivery),regNo:s.regNo||"",company:s.company||"",model:s.model||"",colour:s.colour||"",chassisNo:s.chassisNo||"",km:C||"",fuelLevel:s.fuelLevel||"",custName:String(s.custName||"").trim(),custMobile:String(s.custMobile||""),obs:F,vehicleType:s.vehicleType||"",serviceType:s.serviceType||"",floorMat:H,amount:String(g)},labourRows:Ue||[],totals:ve};v.success({content:"Saved successfully",key:"autosave",duration:1.5});const ee={jcNo:t,formValues:D.formValues,payload:D},De=ye({type:"save",data:ee});setTimeout(async()=>{try{const ue=await Qo(ee);(ue?.data||ue)?.success!==!1&&ke(De)}catch{}finally{nt(t)}},0)}catch(s){if(s?.errorFields)v.error("Please complete required fields before auto-saving.");else{const t=s?.response?.data?.message||s?.message||"Failed to auto-save. Please try again.";v.error(t)}throw s}},ns=async s=>{if(fe){v.warning("Post-service already completed for this Job Card. Editing is locked.");return}try{if(ht(!0),await new Promise(j=>setTimeout(j,0)),Date.now()<$)return;Pt(6e3);const t=Nt(n.getFieldsValue(!0)),l=String(t.custMobile||"").replace(/\D/g,"").slice(-10);if(l.length!==10){v.error("Enter a valid 10-digit mobile number.");return}let i=t.jcNo;if(!/^JC-[A-Z]+-[A-Z0-9]{6}$/.test(String(i||"").trim()))try{i=await qs(t.custMobile,ae||(n.getFieldValue("branchCode")||"").toUpperCase(),we),n.setFieldsValue({jcNo:i})}catch(j){}const g=Number.isFinite(ve.grand)?Math.round(ve.grand):0,C=String(t.km||"").replace(/\D/g,""),H=typeof t.floorMat=="string"?t.floorMat:t.floorMat===!0?"Yes":(t.floorMat===!1,"No"),F=String(t.obs||"").replace(/\s*\r?\n\s*/g," # ").trim(),E=String(m||"").trim(),V=Number(rt||0)||0,G=Number(Qe||0)||0;if(!(V>0||G>0)){v.error("Enter amount for Cash or Online (at least one).");return}if(Ze==="online"&&V>0&&String(Ge||"").trim().length<4){v.error("Enter UTR for Online (Slot 1).");return}if(Ve==="online"&&G>0&&String(r||"").trim().length<4){v.error("Enter UTR for Online (Slot 2).");return}const D=[];V>0&&D.push({amount:Math.round(V),mode:Ze,...Ze==="online"?{utr:String(Ge||"").trim()}:{}}),G>0&&D.push({amount:Math.round(G),mode:Ve,...Ve==="online"?{utr:String(r||"").trim()}:{}});const ee=D.reduce((j,Te)=>j+(Number(Te.amount)||0),0),De=Array.from(new Set(D.map(j=>j.mode))),ue=De.length>1?"mixed":De[0]||"",jt=D.filter(j=>j.mode==="online"&&j.utr).map(j=>j.utr).join(" / "),wt=D.filter(j=>String(j.mode).toLowerCase()==="cash").reduce((j,Te)=>j+(Number(Te.amount)||0),0),Lt=D.filter(j=>String(j.mode).toLowerCase()==="online").reduce((j,Te)=>j+(Number(Te.amount)||0),0),dt=Math.round(Number(g||0));if(ee!==dt){const j=dt-ee,Te=`Payable: â‚¹${dt}. Collected: â‚¹${ee}. ${j>0?"Pending":"Excess"}: â‚¹${Math.abs(j)}.`;try{mt.warning({title:"Please collect full amount",content:Te})}catch{}v.error(`Please collect full amount. ${Te}`);return}const et=new Date().toISOString(),Ie=t.savedAt||n.getFieldValue("savedAt")||t.createdAt,Rs=(typeof Ie=="string"&&Ie.trim()?Ie:T.isDayjs(Ie)||Ie instanceof Date&&!isNaN(Ie.getTime())?Ie.toISOString():"")||et;try{n.setFieldsValue({savedAt:Rs})}catch{}const wo={savedAt:Rs,updatedAt:et,postServiceAt:et,formValues:{mechanic:t.mechanic||"",executive:t.executive||"",company:t.company||"",model:t.model||"",colour:t.colour||"",chassisNo:t.chassisNo||"",km:C||"",fuelLevel:t.fuelLevel||"",vehicleType:t.vehicleType||"",floorMat:H,expectedDelivery:t.expectedDelivery?T(t.expectedDelivery).format("DD-MM-YYYY HH:mm"):"",obs:F,remarks:E},labourRows:Ue||[],totals:ve};v.success({key:"postsave",content:"Saved successfully"});const Mo=t.expectedDelivery?T(t.expectedDelivery).format("DD-MM-YYYY HH:mm"):"",Fs={mobile:l,jcNo:i,serviceAmount:g,collectedAmount:ee,paymentMode:ue,payments:D,utr:jt||void 0,utrNo:jt||void 0,remarks:E,payload:{...wo,payments:D,remarks:E},formValues:{custName:String(t.custName||""),custMobile:l,branch:String(t.branch||""),executive:String(t.executive||""),regNo:String(t.regNo||""),company:String(t.company||""),serviceType:String(t.serviceType||""),vehicleType:String(t.vehicleType||""),mechanic:String(t.mechanic||""),model:String(t.model||""),colour:String(t.colour||""),chassisNo:String(t.chassisNo||""),km:C||"",fuelLevel:String(t.fuelLevel||""),expectedDelivery:Mo,obs:F,remarks:E},source:"jobcard",cashCollected:wt,onlineCollected:Lt,totalCollected:ee};oe({locked:!0,at:et,mobile:l,amount:ee,mode:ue||null});const Co=ye({type:"post",data:Fs});if(setTimeout(async()=>{try{let j=!0;if(Pe){const Te=await ot({webhookUrl:Pe,method:"POST",payload:{action:"postService",data:Fs}});j=(Te?.data||Te)?.success!==!1}j&&ke(Co)}catch{}},0),s===!0||s==="print")await new Promise(j=>setTimeout(j,50)),await Ys("post");else if(s==="whatsapp")try{const j=ps(t.custMobile);if(!j)v.error("Enter a valid 10-digit mobile number (India).");else{const Ao=tn(t,ve,Ue,{payments:D,collectedAmount:ee,cashCollected:wt,onlineCollected:Lt,paymentMode:ue});v.loading({key:"postshare",content:"Preparing WhatsApp messageâ€¦"}),hs({mobileE164:j,text:Ao,onFailToWhatsApp:()=>{v.info({key:"postshare",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2})}}),setTimeout(()=>{v.success({key:"postshare",content:"Ready to send.",duration:2})},800)}}catch{}Ne(!1),gt(""),at(""),o(""),d(""),x("");try{n.resetFields();const j={...Ns,createdAt:T(),expectedDelivery:null,branch:k||void 0,executive:Q||void 0,jcNo:"",labourRows:[],discounts:{labour:0},gstLabour:st};n.setFieldsValue(j),Se(null),Re(null),He(""),ys(!1),bs(null),vs(""),oe(ms),Ye({customer:!1,mechanic:!1,pre:!1}),qe(1),ze(!1),$e(!1),Xe(),v.success("Ready for the next Job Card")}catch{}}catch(t){console.warn("post-service save error:",t),v.error(t&&t.message||"Could not save post-service details.")}finally{ht(!1)}},Vt=Nt(n.getFieldsValue(!0)),yo=[...(Ue||[]).map(s=>s.desc),...Vt?.obs?Vt.obs.split(`
`).map(s=>s.trim()).filter(Boolean):[]],rs=s=>({display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,padding:"12px 14px",border:"1px solid #e5e7eb",borderRadius:8,background:kt===s?"#f0fdf4":"#fff"}),bo=async(s={})=>{const t=s&&typeof s.preventDefault=="function"?{}:s||{},l=t.allowSmsFallback!==!1,i=t.onPopupBlocked;try{if(Date.now()<$)return;Pt(6e3),await os();const u=Nt(n.getFieldsValue(!0));await n.validateFields(["custName","custMobile","branch"]);const g=ps(u.custMobile);if(!g){v.error("Enter a valid 10-digit mobile number (India).");return}const C=Xo(u,ve);v.loading({key:"share",content:"Preparing WhatsApp messageâ€¦"});const H=hs({mobileE164:g,text:C,allowSmsFallback:l,onFailToWhatsApp:()=>{l&&v.info({key:"share",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2}),i?.()}});return setTimeout(()=>{v.success({key:"share",content:"Ready to send.",duration:2})},800),H}catch{return null}},Ps=async(s={})=>{const t=s&&typeof s.preventDefault=="function"?{}:s||{},l=t.allowSmsFallback!==!1,i=t.onPopupBlocked,u=t.skipCooldown===!0;try{if(!u&&Date.now()<$)return;u||Pt(6e3),await os();const g=Nt(n.getFieldsValue(!0));await n.validateFields(["mechanic"]);const C=String(g.mechanic||"").trim(),H=Zs(C),F=ps(H);if(!F){v.error(C?`No phone number found for mechanic ${C}.`:"Select a mechanic with a saved phone number.");return}const E=en(g);v.loading({key:"mechshare",content:"Preparing mechanic WhatsApp messageâ€¦"});const V=hs({mobileE164:F,text:E,allowSmsFallback:l,onFailToWhatsApp:()=>{l&&v.info({key:"mechshare",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2}),i?.()}});return setTimeout(()=>{v.success({key:"mechshare",content:"Ready to send.",duration:2})},800),V}catch{return null}},vo=async()=>{let s=!1;try{Dt(!0),await new Promise(t=>setTimeout(t,0)),await os(),await Ys("pre"),s=!0}catch{}finally{Dt(!1)}return s},xo=()=>{ze(!1),qe(()=>Ae.customer?Ae.mechanic?3:2:1),$e(!0)},So=async()=>{if(!de||$>Date.now()||(ze(!1),!await bo()))return;const t=!Ae.mechanic;if(Ye(i=>({...i,customer:!0})),qe(t?2:3),!t)return;(await Ps({allowSmsFallback:!1,onPopupBlocked:()=>ze(!0),skipCooldown:!0}))?.opened&&(Ye(i=>({...i,mechanic:!0})),qe(3))},No=async()=>{!de||(ze(!1),!await Ps({skipCooldown:!0}))||(Ye(t=>({...t,mechanic:!0})),qe(3))},jo=async()=>{if(!de||Fe)return;await vo()&&Ye(t=>({...t,pre:!0}))};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        .wrap { max-width: 1000px; margin: 12px auto; padding: 0 12px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
        /* Make header actions stack on small screens */
        @media screen and (max-width: 600px) {
          .brand-actions-row { grid-template-columns: 1fr !important; row-gap: 8px; }
          .brand-actions { align-items: flex-start !important; }
        }
        .print-sheet { display: none; }
        @media print { .print-sheet { display: block; } .no-print { display: none !important; } }
      `}),e.jsx("div",{className:"wrap no-print",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"brand-actions-row",style:{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:12},children:[e.jsxs("div",{children:[e.jsx(_o,{level:4,style:{margin:0},children:oo?"NH MOTORS â€” JOB CARD":"SHANTHA MOTORS â€” JOB CARD"}),e.jsx(Us,{type:"secondary",children:"Multi Brand Two Wheeler Sales & Service"})]}),e.jsxs("div",{className:"brand-actions",style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx(Bo,{form:n,formatReg:_e,buildRows:_t,defaultGstLabour:st,lists:{BRANCHES:Wo,MECHANIC:Hs,EXECUTIVES:cs,VEHICLE_TYPES:_s,SERVICE_TYPES:Bs},setServiceTypeLocal:Se,setVehicleTypeLocal:Re,setRegDisplay:He,webhookUrl:Pe,setFollowUpEnabled:ys,setFollowUpAt:bs,setFollowUpNotes:vs,setPostServiceLock:oe,autoSearch:bt||Ce||eo,onAutoSearchStatusChange:(s,t)=>{t==="inline"&&(vt(!!s),s||Kt(null))}}),e.jsx(te,{onClick:async()=>{B(!0),await Xt()},children:Rt===null?"PendingCases":`PendingCases (${Rt})`})]})]}),e.jsx(mt,{title:Rt!==null?`PendingCases (${Rt})`:"PendingCases",open:h,onCancel:()=>B(!1),width:"min(1200px, 96vw)",footer:[e.jsx(te,{onClick:()=>Xt(),children:"Refresh"},"refresh"),e.jsx(te,{type:"primary",onClick:()=>B(!1),children:"Close"},"close")],children:M?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:16},children:e.jsx(zs,{})}):N.length?e.jsx(Wt,{size:"small",dataSource:N,renderItem:s=>e.jsx(Wt.Item,{children:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:10,width:"100%"},children:[e.jsxs("div",{style:{flex:1,minWidth:0,whiteSpace:"normal",overflow:"visible",wordBreak:"break-word",fontWeight:600,fontSize:16,lineHeight:1.4},title:`${s.name||"-"} | ${s.mobile||"-"} | ${s.jcNo||"-"} | ${s.regNo||"-"} | ${s.branch||"-"}${s.followUpAt?` | ${s.followUpAt}`:""}${s.followUpNotes?` | ${s.followUpNotes}`:""}`,children:[s.name||"-"," | ",s.mobile||"-"," | ",s.jcNo||"-"," | ",s.regNo||"-"," | ",s.branch||"-",s.followUpAt?` | ${s.followUpAt}`:"",s.followUpNotes?` | ${s.followUpNotes}`:""]}),e.jsx(te,{size:"small",type:"primary",onClick:()=>{const t=s.mobile||s.jcNo,l=s.mobile?"mobile":"jc";t&&(yt({mode:l,query:t,token:Date.now()}),B(!1),y(i=>i.filter(u=>u.jcNo!==s.jcNo)))},children:"Post Service"})]})})}):e.jsx("div",{style:{color:"#666"},children:"No pending job cards."})}),e.jsxs(w,{form:n,layout:"vertical",initialValues:Ns,style:{marginTop:12},onValuesChange:Xe,children:[e.jsxs(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Vehicle & Customer",children:[e.jsxs(Be,{gutter:[12,8],children:[e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Vehicle No.",name:"regNo",validateFirst:!0,rules:[{required:!0,message:"Vehicle number is required"},{validator:(s,t)=>!t||Bt.test(String(t||"").toUpperCase())?Promise.resolve():Promise.reject(new Error("Format must be KA05DB6000 (AA##AA####)"))}],children:e.jsx(me,{placeholder:"KA05DB6000",value:ie,onChange:ro,maxLength:10,inputMode:"latin",style:{textTransform:"uppercase"},suffix:e.jsx(te,{type:"primary",size:"small",loading:be&&gs==="vehicle",disabled:be||!ao,onClick:()=>Et("vehicle"),style:{height:22,paddingInline:6,fontSize:11,background:"#52c41a",borderColor:"#52c41a"},children:"Fetch"})})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Mobile",name:"custMobile",rules:[{required:!0,message:"Please enter mobile number"},{validator:(s,t)=>t?/^\d{10}$/.test(String(t))?Promise.resolve():Promise.reject(new Error("Enter 10-digit mobile number")):Promise.resolve()}],children:e.jsx(me,{maxLength:10,inputMode:"numeric",pattern:"[0-9]*",onKeyPress:mo,onChange:po,placeholder:"10-digit number",suffix:e.jsx(te,{type:"primary",size:"small",loading:be&&gs==="mobile",disabled:be,onClick:()=>Et("mobile"),style:{height:22,paddingInline:6,fontSize:11,background:"#52c41a",borderColor:"#52c41a"},children:"Fetch"})})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Customer Name",name:"custName",rules:[{required:!0,whitespace:!0,message:"Please enter customer name"}],getValueFromEvent:ut,children:e.jsx(me,{placeholder:"e.g., RAHUL SHARMA",style:{textTransform:"uppercase"}})})})]}),e.jsxs(Be,{gutter:[12,8],children:[e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Company",name:"company",rules:[{required:!0,message:"Please select company"}],getValueFromEvent:ut,children:e.jsx($s,{placeholder:"Type company (e.g., H â†’ HONDA / HERO)",options:co.map(s=>({value:s})),filterOption:(s,t)=>String(t?.value||"").toLowerCase().includes(String(s||"").toLowerCase()),onChange:s=>{const t=se(s);Gt(t),n.setFieldsValue({company:t,model:void 0})},style:{textTransform:"uppercase"}})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Model",name:"model",rules:[{required:!0}],getValueFromEvent:ut,children:e.jsx($s,{placeholder:"Type model (e.g., ACT â†’ ACTIVA 125)",options:lo.map(s=>({value:s})),filterOption:(s,t)=>String(t?.value||"").toLowerCase().includes(String(s||"").toLowerCase()),onChange:s=>n.setFieldsValue({model:se(s)}),style:{textTransform:"uppercase"}})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Colour",name:"colour",getValueFromEvent:ut,children:e.jsx(me,{style:{textTransform:"uppercase"}})})})]}),e.jsxs(Be,{gutter:[12,8],children:[e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Odometer Reading",name:"km",rules:[{required:!0,message:"Please enter Odometer Reading"}],getValueFromEvent:s=>{const t=s.target.value.replace(/\D/g,"");return t?`${t} KM`:""},getValueProps:s=>({value:s?.toString().replace(/\D/g,"")}),children:e.jsx(me,{style:{width:"100%"},maxLength:6,inputMode:"numeric",pattern:"[0-9]*",onKeyPress:uo,placeholder:"Enter KM",suffix:"KM"})})}),e.jsx(L,{xs:24,children:e.jsx(w.Item,{label:"Customer Observation (additional notes)",name:"obs",getValueFromEvent:ut,children:e.jsx(me.TextArea,{rows:3,placeholder:"Write the customer's observations...",style:{textTransform:"uppercase"}})})})]})]}),fe&&e.jsx(Ks,{type:"warning",showIcon:!0,style:{marginTop:12},message:"Post-service already completed",description:`Service & labour editing is locked${ks?` (completed on ${ks})`:""}. Enter a different mobile number to start a new job card.`}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Service",children:e.jsxs(Be,{gutter:[12,8],children:[e.jsx(L,{xs:24,md:6,children:e.jsx(w.Item,{label:"Service Type (tick one)",name:"serviceType",rules:[{required:!0,message:"Please select a service type"}],children:e.jsx($o.Group,{options:ho,value:ge?[ge]:[],onChange:go,disabled:fe})})}),e.jsx(L,{xs:24,md:6,children:e.jsx(w.Item,{label:"Chassis No",name:"chassisNo",rules:[{validator:(s,t)=>{const l=String(ge||"").toLowerCase()==="free",i=Ct(t||"");return!l||i?Promise.resolve():Promise.reject(new Error("Chassis number is required for Free service"))}}],getValueFromEvent:s=>{const t=s?.target?.value??s;return Ct(t)},children:e.jsx(me,{placeholder:"Chassis No (required for Free service)"})})}),ge&&e.jsx(L,{xs:24,md:6,children:e.jsx(w.Item,{label:"Vehicle Type",name:"vehicleType",rules:[{required:!0,message:"Please choose Scooter or Motorcycle"}],children:e.jsx(Mt,{className:"blue-segmented",block:!0,options:_s,value:We||void 0,disabled:fe,onChange:s=>{Re(s),n.setFieldsValue({vehicleType:s}),ge&&n.setFieldsValue({labourRows:_t(ge,s),gstLabour:st,discounts:{labour:0}}),Xe()}})})}),We==="Scooter"&&e.jsx(L,{xs:24,md:4,children:e.jsx(w.Item,{label:"Floor Mat (Mandatory)",name:"floorMat",initialValue:"No",rules:[{required:!0,message:"Please select Yes/No"}],children:e.jsx(Mt,{className:"blue-segmented",block:!0,options:["No","Yes"],disabled:fe,onChange:s=>{n.setFieldsValue({floorMat:s}),Xe()}})})}),e.jsx(L,{xs:24,md:8,children:e.jsx(w.Item,{label:"Fuel Level",name:"fuelLevel",children:e.jsx(Mt,{className:"blue-segmented",block:!0,options:Jo,disabled:fe})})})]})}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Labour",children:e.jsx(w.List,{name:"labourRows",children:(s,{add:t,remove:l})=>e.jsxs(e.Fragment,{children:[e.jsxs(Be,{gutter:8,style:{fontWeight:600,marginBottom:6},children:[e.jsx(L,{span:12,children:"Description"}),e.jsx(L,{span:4,children:"Qty"}),e.jsx(L,{span:4,children:"Rate"}),e.jsx(L,{span:4,style:{textAlign:"right"},children:"Amount"})]}),s.map(({key:i,name:u,...g})=>{const C=Ue?.[u]||{},H=Number(C?.qty||0)*Number(C?.rate||0);return e.jsxs(Be,{gutter:8,align:"middle",style:{marginBottom:6},children:[e.jsx(L,{span:12,children:e.jsx(w.Item,{...g,name:[u,"desc"],rules:[{required:!0}],getValueFromEvent:ut,children:e.jsx(me,{placeholder:"Labour description",disabled:fe,style:{textTransform:"uppercase"}})})}),e.jsx(L,{span:4,children:e.jsx(w.Item,{...g,name:[u,"qty"],initialValue:1,rules:[{required:!0}],children:e.jsx(It,{min:1,style:{width:"100%"},disabled:fe})})}),e.jsx(L,{span:4,children:e.jsx(w.Item,{...g,name:[u,"rate"],rules:[{required:!0}],children:e.jsx(It,{min:0,style:{width:"100%"},disabled:fe})})}),e.jsxs(L,{span:4,style:{textAlign:"right"},children:[e.jsx(Us,{children:Le(H)}),e.jsx(te,{type:"link",danger:!0,onClick:()=>l(u),style:{paddingLeft:8},disabled:fe,children:"Remove"})]})]},i)}),e.jsx(te,{onClick:()=>t({qty:1}),disabled:fe,children:"Add labour"})]})})}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Totals",children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:6,maxWidth:480},children:[e.jsx("div",{children:"Labour Subtotal"}),e.jsx("div",{style:{textAlign:"right"},children:Le(ve.labourSub)}),e.jsx(w.Item,{label:"GST % on Labour",name:"gstLabour",style:{marginBottom:0},children:e.jsx(It,{min:0,max:28,disabled:fe})}),e.jsx("div",{style:{textAlign:"right"},children:Le(ve.labourGST)}),e.jsx("div",{children:"Discount (Labour)"}),e.jsx(w.Item,{name:["discounts","labour"],style:{marginBottom:0},children:e.jsx(It,{min:0,disabled:fe})}),e.jsx("div",{style:{fontWeight:700},children:"Grand Total"}),e.jsx("div",{style:{textAlign:"right",fontWeight:700},children:Le(ve.grand)})]})}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Job Details",children:e.jsxs(Be,{gutter:[12,8],children:[e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"JC No.",name:"jcNo",children:e.jsx(me,{placeholder:"No Need to Enter",readOnly:!0})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Created At",name:"createdAt",rules:[{required:!0}],children:e.jsx(Os,{showTime:!0,style:{width:"100%"}})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Branch",name:"branch",rules:[{required:!0}],children:xe&&ne.length?e.jsx(Ht,{placeholder:"Select branch",value:it,onChange:s=>so(s),options:ne.map(s=>({value:s.name,label:s.name}))}):e.jsx(me,{readOnly:!0,placeholder:"Auto-fetched from your profile"})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Allotted Mechanic",name:"mechanic",rules:[{required:!0}],children:e.jsx(Ht,{placeholder:"Select mechanic",options:Hs.map(s=>({value:s,label:s}))})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Executive",name:"executive",rules:[{required:!0}],children:xe?e.jsx(Ht,{showSearch:!0,optionFilterProp:"label",placeholder:"Select executive",options:(z.length?z:cs).map(s=>({value:s.name,label:s.name}))}):e.jsx(me,{readOnly:!0,placeholder:"Auto-fetched from your profile"})})}),e.jsx(L,{xs:24,sm:12,md:8,children:e.jsx(w.Item,{label:"Expected Delivery Date",name:"expectedDelivery",rules:[{required:!0}],children:e.jsx(Os,{style:{width:"100%"}})})})]})}),e.jsxs(Be,{justify:"end",style:{marginTop:12},gutter:8,children:[e.jsx(L,{children:e.jsx(Oo,{title:de?"":At||"Fill all required fields",placement:"top",children:e.jsx(te,{type:"default",icon:e.jsx($t,{style:{color:"#25D366"}}),onClick:xo,disabled:!de||$>Date.now(),children:"WhatsApp"})})}),e.jsx(L,{children:e.jsx(te,{onClick:()=>Ne(!0),children:"Post-service"})})]})]})]})}),e.jsx(mt,{title:"WhatsApp",open:Tt,onCancel:()=>$e(!1),footer:null,destroyOnClose:!1,children:e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs("div",{style:rs(1),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["1. Customer WhatsApp ",Ae.customer?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Required"})]}),e.jsx(te,{type:"primary",icon:e.jsx($t,{style:{color:"#25D366"}}),onClick:So,disabled:!de||$>Date.now(),children:"Send"})]}),e.jsxs("div",{style:rs(2),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["2. Mechanic WhatsApp ",Ae.mechanic?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Required"}),Ke&&!Ae.mechanic?e.jsx("div",{style:{fontSize:12,color:"#b45309",marginTop:4},children:"Tap to open Mechanic WhatsApp."}):null,Ae.customer?null:e.jsx("div",{style:{fontSize:12,color:"#6b7280",marginTop:4},children:"Complete Customer WhatsApp first."})]}),e.jsx(te,{type:"primary",icon:e.jsx($t,{style:{color:"#25D366"}}),onClick:No,disabled:!de||!Ae.customer,children:"Send"})]}),e.jsxs("div",{style:rs(3),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["3. Pre-service ",Ae.pre?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Optional"})]}),e.jsx(te,{type:"default",onClick:jo,disabled:!de||Fe,loading:Fe,children:"Print"})]})]})}),e.jsxs(mt,{title:"Post-service",open:I,onCancel:()=>Ne(!1),footer:null,children:[e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs(tt,{size:"small",bordered:!0,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Amount (â‚¹)"}),e.jsx(me,{inputMode:"numeric",placeholder:"0",value:rt,onChange:s=>gt(s.target.value.replace(/[^0-9.]/g,""))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Mode"}),e.jsx(Mt,{value:Ze,onChange:Jt,options:[{label:"Cash",value:"cash"},{label:"Online",value:"online"}]})]})]}),Ze==="online"&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("div",{style:{marginBottom:6,fontSize:12,color:"#374151"},children:"UTR No. (Slot 1)"}),e.jsx(me,{placeholder:"Enter UTR number",value:Ge,onChange:s=>at(String(s.target.value||"").toUpperCase()),maxLength:32,style:{textTransform:"uppercase"}})]})]}),e.jsxs(tt,{size:"small",bordered:!0,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Amount (â‚¹)"}),e.jsx(me,{inputMode:"numeric",placeholder:"0",value:Qe,onChange:s=>o(s.target.value.replace(/[^0-9.]/g,""))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Mode"}),e.jsx(Mt,{value:Ve,onChange:ft,options:[{label:"Cash",value:"cash"},{label:"Online",value:"online"}]})]})]}),Ve==="online"&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("div",{style:{marginBottom:6,fontSize:12,color:"#374151"},children:"UTR No. (Slot 2)"}),e.jsx(me,{placeholder:"Enter UTR number",value:r,onChange:s=>d(String(s.target.value||"").toUpperCase()),maxLength:32,style:{textTransform:"uppercase"}})]})]})]}),e.jsxs("div",{style:{marginTop:8,fontSize:13,color:lt===0?"#166534":"#b91c1c"},children:[e.jsx("strong",{children:"Payable:"})," ",Le(ts)," Â | Â ",e.jsx("strong",{children:"Collected:"})," ",Le(es)," Â | Â ",e.jsxs("strong",{children:[lt>=0?"Due":"Excess",":"]})," ",Le(Math.abs(lt))]}),e.jsxs("div",{style:{marginTop:12},children:[e.jsx("div",{style:{marginBottom:6},children:"Remarks (optional)"}),e.jsx(me.TextArea,{placeholder:"Enter any delivery remarks for this service",value:m,onChange:s=>x(se(s.target.value||"")),style:{textTransform:"uppercase"},autoSize:{minRows:2,maxRows:3}})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:16,justifyContent:"flex-end"},children:[e.jsx(te,{onClick:()=>Ne(!1),disabled:Ee,children:"Cancel"}),e.jsx(te,{onClick:()=>ns(!1),disabled:fe||Ee||$>Date.now()||lt!==0,loading:Ee,children:"Save"}),e.jsx(te,{icon:e.jsx($t,{style:{color:"#25D366"}}),onClick:()=>ns("whatsapp"),disabled:fe||Ee||$>Date.now()||lt!==0,loading:Ee,children:"WhatsApp"}),e.jsx(te,{type:"primary",onClick:()=>ns(!0),disabled:fe||Ee||$>Date.now()||lt!==0,loading:Ee,children:"Print"})]})]}),e.jsx(Uo,{ref:O,active:!0,vals:Vt,labourRows:Ue,totals:ve,observationLines:yo,executives:cs}),e.jsx(Yo,{ref:Je,active:!0,vals:Vt,totals:ve})]})}export{Vn as default};
