import{r as o,R as le,j as e,u as Ka}from"./index-DByWGH7d.js";import{l as Zt,d as us,e as ms,f as hs,h as ps,b as ua,i as fs,j as ys,k as gs,s as rt,u as St,t as jt,n as te,D as ga,a as Dt,A as bs}from"./caseInsensitive-GFj-Zur4.js";import{G as Ut}from"./index-CINaf3Eu.js";import{F as H}from"./index-fiQTrVnU.js";import{s as S,I as ee}from"./index-mc3XMWnF.js";import{S as me}from"./index-DlPElhKY.js";import{S as pe,a as vs}from"./index-C2v3hDcT.js";import{B as q}from"./button-BmMOSO5i.js";import{R as Wa}from"./PlusOutlined-DysDbfLf.js";import{T as he}from"./index-DMDeWAJZ.js";import{F as Bt}from"./Table-g31uHPfu.js";import{M as it}from"./index-BSIb012r.js";import{z as Ot,A as ne,T as Rt}from"./TextArea-BDVSLBQS.js";import{d as Ze}from"./index-53S8uf0A.js";import{e as Gt,P as xs}from"./StockUpdate-D0yZO869.js";import{C as Ss}from"./index-Bbhzw47L.js";import{B as Ha,l as ks,a as ws,b as js,U as ca,c as Ma,d as Ya,e as Cs}from"./BookingForm-DWuipBFi.js";import{C as ba}from"./index-BP3wDuv0.js";import{D as Pa}from"./index-BW-IFf4J.js";import{E as As,T as Xt}from"./index-CBM7Jb_H.js";import{A as Oa}from"./index-DU0h2yX8.js";import{P as Rs,h as Is}from"./PostServiceSheet-CYx6JQNX.js";import{I as Ts}from"./AntdIcon-DqBt8ItB.js";import{T as Ns}from"./index-eVJyXskz.js";function ma(){return ma=Object.assign?Object.assign.bind():function(l){for(var x=1;x<arguments.length;x++){var u=arguments[x];for(var p in u)Object.prototype.hasOwnProperty.call(u,p)&&(l[p]=u[p])}return l},ma.apply(this,arguments)}const Ls=(l,x)=>o.createElement(Ts,ma({},l,{ref:x,icon:As})),Es=o.forwardRef(Ls),Ua=[{label:"Sales & Services",value:"sales & services"},{label:"Sales",value:"sales"},{label:"Service",value:"service"}],Ba=[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"},{label:"Under Maintenance",value:"under_maintenance"}];function wn({readOnly:l=!1}){const u=!Ut.useBreakpoint().md,[p,B]=le.useState(!1),[_,R]=le.useState(!1),[z,L]=le.useState([]),[V,d]=le.useState(0),[U,Z]=le.useState(!1),[E,G]=le.useState(null),[D]=H.useForm(),[ie,Se]=le.useState(""),[Y,J]=le.useState("all"),[k,$]=le.useState("all"),[ye,ge]=le.useState("all"),[ae,Le]=le.useState(1),[de,Ae]=le.useState(25),je=le.useCallback(async()=>{B(!0);try{if(l){const c=await Zt({limit:200});c?.success?(L(c.data.items||[]),d(c.data.total||0)):S.error(c?.message||"Failed to load branches")}else{const c=await us({limit:200});if(c?._status===401||c?._status===403){const w=await Zt({limit:200});w?.success?(S.info("Showing public branch list (read-only). Sign in for management."),L(w.data.items||[]),d(w.data.total||0)):(S.warning("Please login again to manage branches."),L([]),d(0))}else c?.success?(L(c.data.items||[]),d(c.data.total||0)):S.error(c?.message||"Failed to load branches")}}catch(c){S.error(c?.message||"Failed to load branches")}finally{B(!1)}},[l]);le.useEffect(()=>{je()},[je]);const Ue=le.useMemo(()=>{const c=new Set((z||[]).map(w=>w.address?.city?String(w.address.city).trim():"").filter(Boolean));return["all",...Array.from(c).sort((w,n)=>w.localeCompare(n))]},[z]),oe=le.useMemo(()=>{const c=String(ie||"").toLowerCase();return(z||[]).filter(w=>Y!=="all"&&String(w.address?.city||"")!==Y||k!=="all"&&String(w.type||"")!==k||ye!=="all"&&String(w.status||"")!==ye?!1:c?[w.code,w.name,w.phone,w.email,w.address?.line1,w.address?.line2,w.address?.area,w.address?.city,w.address?.state].map(M=>String(M||"").toLowerCase()).some(M=>M.includes(c)):!0)},[z,ie,Y,k,ye]);le.useEffect(()=>{Le(1)},[ie,Y,k,ye]);const _e=le.useMemo(()=>{const c=w=>{const n=new Map;return oe.forEach(M=>{const r=String(M[w]||"");n.set(r,(n.get(r)||0)+1)}),Array.from(n.entries()).sort((M,r)=>r[1]-M[1])};return{byType:c("type"),byStatus:c("status")}},[oe]),ue=()=>{const c=["Code","Name","Type","Status","Phone","Email","Line1","Line2","Area","City","State","Pincode","Latitude","Longitude"],w=oe.map(O=>[O.code||"",O.name||"",O.type||"",O.status||"",O.phone||"",O.email||"",O.address?.line1||"",O.address?.line2||"",O.address?.area||"",O.address?.city||"",O.address?.state||"",O.address?.pincode||"",O.location?.coordinates?.[1]??"",O.location?.coordinates?.[0]??""]),n=[c,...w].map(O=>O.map(Ce=>String(Ce).includes(",")?`"${String(Ce).replace(/"/g,'""')}"`:String(Ce)).join(",")).join(`
`),M=new Blob([n],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(M),P=document.createElement("a");P.href=r,P.download="branches.csv",P.click(),setTimeout(()=>URL.revokeObjectURL(r),500)},Ee=()=>{G(null),Z(!0),setTimeout(()=>{D.resetFields(),D.setFieldsValue({type:"sales & services",status:"active"})},0)},ze=c=>{G(c),D.setFieldsValue({id:c.id,code:c.code,name:c.name,type:c.type,phone:c.phone,email:c.email,address_line1:c.address?.line1,address_line2:c.address?.line2,area:c.address?.area,city:c.address?.city,state:c.address?.state,pincode:c.address?.pincode,lat:c.location?.coordinates?.[1],lng:c.location?.coordinates?.[0],status:c.status,manager:c.manager||void 0,staffIds:Array.isArray(c.staff)?c.staff.map(String).join(","):void 0,boysIds:Array.isArray(c.boys)?c.boys.map(String).join(","):void 0,mechanicsIds:Array.isArray(c.mechanics)?c.mechanics.map(String).join(","):void 0}),Z(!0)},be=async c=>{it.confirm({title:`Delete ${c.name}?`,content:"This cannot be undone.",okButtonProps:{danger:!0},okText:"Delete",onOk:async()=>{try{const w=await ps(c.id);w?.success?(S.success("Branch deleted"),je()):S.error(w?.message||"Delete failed")}catch{S.error("Delete failed")}}})},Re=async()=>{try{const c=await D.validateFields(),w={code:c.code,name:c.name,type:c.type,phone:c.phone,email:c.email,address:{line1:c.address_line1,line2:c.address_line2,area:c.area,city:c.city,state:c.state,pincode:c.pincode},lat:c.lat,lng:c.lng,status:c.status,...c.manager?{manager:String(c.manager).trim()}:{},...c.staffIds?{staff:String(c.staffIds).split(",").map(M=>M.trim()).filter(Boolean)}:{},...c.boysIds?{boys:String(c.boysIds).split(",").map(M=>M.trim()).filter(Boolean)}:{},...c.mechanicsIds?{mechanics:String(c.mechanicsIds).split(",").map(M=>M.trim()).filter(Boolean)}:{}};R(!0);let n;if(E?.id?n=await ms(E.id,w):n=await hs(w),n?._status===401||n?._status===403){S.warning("Please login again to continue.");return}n?.success?(S.success(E?"Branch updated":"Branch created"),Z(!1),G(null),D.resetFields(),je()):S.error(n?.message||"Save failed")}catch(c){const w=c?.response?.data?.message||c?.message||"Save failed";S.error(w)}finally{R(!1)}},Te=c=>{const w=[c.address?.line1,c.address?.line2,c.address?.area,c.address?.city,c.address?.state,c.address?.pincode].filter(Boolean).join(", ");return w?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(w)}`:null},K=[{title:"Code",dataIndex:"code",key:"code",width:80,sorter:(c,w)=>c.code.localeCompare(w.code)},{title:"Name",dataIndex:"name",key:"name",width:180,ellipsis:!0,sorter:(c,w)=>c.name.localeCompare(w.name),render:(c,w)=>e.jsxs("span",{children:[c," ",e.jsx(Rt,{title:"Open in Google Maps",children:Te(w)&&e.jsx("a",{href:Te(w),target:"_blank",rel:"noopener",style:{fontSize:12,marginLeft:4},children:"Map"})})]})},{title:"Type",dataIndex:"type",key:"type",width:110,render:c=>{const w=c==="sales"?"geekblue":c==="service"?"cyan":"blue";return e.jsx(he,{color:w,children:c})}},{title:"City",key:"city",width:110,ellipsis:!0,render:(c,w)=>w.address?.city||"â€”"},{title:"Phone",dataIndex:"phone",key:"phone",width:110,ellipsis:!0},{title:"Staff",key:"staffCount",width:60,render:(c,w)=>w.activeStaffCount??(Array.isArray(w.staff)?w.staff.length:0)},{title:"Boys",key:"boysCount",width:60,render:(c,w)=>w.activeBoysCount??(Array.isArray(w.boys)?w.boys.length:0)},{title:"Mechanics",key:"mechCount",width:80,render:(c,w)=>w.activeMechanicsCount??(Array.isArray(w.mechanics)?w.mechanics.length:0)},{title:"Status",dataIndex:"status",key:"status",width:110,render:c=>c==="active"?e.jsx(he,{color:"green",children:"Active"}):c==="inactive"?e.jsx(he,{children:"Inactive"}):e.jsx(he,{color:"orange",children:"Under Maintenance"})},...l?[]:[{title:"Actions",key:"actions",width:140,render:(c,w)=>e.jsxs(me,{size:4,wrap:!0,children:[e.jsx(q,{size:"small",onClick:()=>ze(w),children:"Edit"}),e.jsx(q,{size:"small",danger:!0,onClick:()=>be(w),children:"Delete"})]})}]];return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[e.jsxs(me,{size:[8,8],wrap:!0,children:[e.jsx(ee.Search,{placeholder:"Search code/name/city/phone",allowClear:!0,value:ie,onChange:c=>Se(c.target.value),style:{minWidth:220}}),e.jsx(pe,{value:Y,onChange:J,style:{minWidth:160},options:Ue.map(c=>({value:c,label:c==="all"?"All Cities":c}))}),e.jsx(pe,{value:k,onChange:$,style:{minWidth:160},options:[{value:"all",label:"All Types"},...Ua]}),e.jsx(pe,{value:ye,onChange:ge,style:{minWidth:180},options:[{value:"all",label:"All Status"},...Ba]}),e.jsx(q,{onClick:je,children:"Refresh"}),e.jsx(q,{onClick:ue,children:"Export CSV"})]}),e.jsx("div",{style:{flex:1}}),!l&&e.jsx(q,{type:"primary",icon:e.jsx(Wa,{}),onClick:Ee,children:"New Branch"})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:8},children:[_e.byStatus.map(([c,w])=>e.jsxs(he,{color:c==="active"?"green":c==="inactive"?"default":"orange",children:[c||"unknown",": ",w]},`st-${c||"unknown"}`)),_e.byType.map(([c,w])=>e.jsxs(he,{color:c==="sales"?"geekblue":c==="service"?"cyan":"blue",children:[c||"unknown",": ",w]},`tp-${c||"unknown"}`)),e.jsxs(he,{color:"blue",children:["Total: ",oe.length," / ",V]})]}),e.jsx(Bt,{rowKey:c=>c.id,dataSource:oe,columns:K,loading:p,tableLayout:u?"auto":"fixed",pagination:{current:ae,pageSize:de,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(c,w)=>{Le(c),w!==de&&Ae(w)},showTotal:(c,w)=>`${w[0]}-${w[1]} of ${c}`},size:u?"small":"middle",scroll:u?{x:"max-content"}:void 0}),e.jsx(it,{title:E?`Edit Branch â€“ ${E.name}`:"New Branch",open:U,onCancel:()=>{Z(!1),G(null)},onOk:Re,okText:E?"Save":"Create",confirmLoading:_,forceRender:!0,destroyOnClose:!0,children:e.jsx(H,{form:D,layout:"vertical",children:e.jsxs(Ot,{gutter:[12,8],children:[e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"code",label:"Code",rules:[{required:!0,message:"Code is required"}],children:e.jsx(ee,{placeholder:"e.g., BDRH",maxLength:10})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(ee,{placeholder:"e.g., Byadarahalli Branch"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"type",label:"Type",initialValue:"sales & services",rules:[{required:!0}],children:e.jsx(pe,{options:Ua})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"status",label:"Status",initialValue:"active",rules:[{required:!0}],children:e.jsx(pe,{options:Ba})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"phone",label:"Phone",children:e.jsx(ee,{placeholder:"Branch phone"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"email",label:"Email",children:e.jsx(ee,{placeholder:"Branch email",type:"email"})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"address_line1",label:"Address Line 1",children:e.jsx(ee,{})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"address_line2",label:"Address Line 2",children:e.jsx(ee,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"area",label:"Area",children:e.jsx(ee,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"city",label:"City",rules:[{required:!0,message:"City is required"}],children:e.jsx(ee,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"state",label:"State",children:e.jsx(ee,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"pincode",label:"Pincode",children:e.jsx(ee,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"lat",label:"Latitude",children:e.jsx(ee,{type:"number",step:"any"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"lng",label:"Longitude",children:e.jsx(ee,{type:"number",step:"any"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"manager",label:"Manager (User ID)",children:e.jsx(ee,{placeholder:"24-char user id (optional)"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"staffIds",label:"Staff (comma-separated User IDs)",children:e.jsx(ee,{placeholder:"id1,id2,id3"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"boysIds",label:"Boys (comma-separated User IDs)",children:e.jsx(ee,{placeholder:"id1,id2"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"mechanicsIds",label:"Mechanics (comma-separated User IDs)",children:e.jsx(ee,{placeholder:"id1,id2"})})})]})})})]})}const _a=[{label:"Admin",value:"admin"},{label:"Owner",value:"owner"},{label:"Staff",value:"staff"},{label:"Mechanic",value:"mechanic"},{label:"Employees",value:"employees"},{label:"User",value:"user"},{label:"Backend",value:"backend"}],Fa=[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"},{label:"Suspended",value:"suspended"}];function jn({readOnly:l=!1}){const u=!Ut.useBreakpoint().md,[p,B]=le.useState(!1),[_,R]=le.useState(!1),[z,L]=le.useState([]),[V,d]=le.useState(0),[U,Z]=le.useState(!1),[E,G]=le.useState(null),[D,ie]=le.useState([]),[Se]=H.useForm(),Y=le.useCallback(n=>n?.id||n?._id||n?.userId||null,[]),[J,k]=le.useState(""),[$,ye]=le.useState(""),[ge,ae]=le.useState(),[Le,de]=le.useState(),[Ae,je]=le.useState(),[Ue,oe]=le.useState(1),[_e,ue]=le.useState(25),Ee=le.useCallback(async()=>{const n=await Zt({limit:500,status:"active"});n?.success&&ie(n.data.items||[])},[]),ze=le.useCallback(async()=>{B(!0);try{if(l){const n=await ua({limit:1e5,page:1,...$?{q:$}:{},...ge?{role:ge}:{},...Le?{status:Le}:{},...Ae?{branch:Ae}:{}});n?.success?(L(n.data.items||[]),d(n.data.total||n.data.items?.length||0)):(S.error(n?.message||"Failed to load users"),L([]),d(0))}else{const n=await fs({limit:1e5,page:1,...$?{q:$}:{},...ge?{role:ge}:{},...Le?{status:Le}:{},...Ae?{branch:Ae}:{}});if(n?.success)L(n.data.items||[]),d(n.data.total||n.data.items?.length||0);else if(n?._status===401||n?._status===403){const M=await ua({limit:1e5,page:1,...$?{q:$}:{},...ge?{role:ge}:{},...Le?{status:Le}:{},...Ae?{branch:Ae}:{}});M?.success?(S.info("Showing public user list (read-only). Sign in for management."),L(M.data.items||[]),d(M.data.total||M.data.items?.length||0)):(S.error(n?.message||"Failed to load users"),L([]),d(0))}else S.error(n?.message||"Failed to load users")}}catch(n){S.error(n?.message||"Failed to load users")}finally{B(!1)}},[$,ge,Le,Ae,l]);le.useEffect(()=>{Ee()},[Ee]),le.useEffect(()=>{ze()},[ze]),le.useEffect(()=>{oe(1)},[$,ge,Le,Ae]);const be=n=>{const M=Y(n);if(!M){S.error("User ID missing. Please refresh and try again.");return}G({...n,id:M}),Se.setFieldsValue({id:M,name:n.name,email:n.email,phone:n.phone,role:n.role,status:n.status,jobTitle:n.jobTitle,employeeCode:n.employeeCode,primaryBranch:n.primaryBranch?._id||n.primaryBranch?.id||n.primaryBranch||void 0,branches:Array.isArray(n.branches)?n.branches.map(r=>typeof r=="string"?r:r?._id||r?.id).filter(Boolean):void 0,canSwitchBranch:!!n.canSwitchBranch}),Z(!0)},Re=async n=>{const M=Y(n);if(!M){S.error("User ID missing. Please refresh and try again.");return}it.confirm({title:`Delete ${n.name}?`,content:"This cannot be undone.",okButtonProps:{danger:!0},okText:"Delete",onOk:async()=>{try{const r=await gs(M);r?.success?(S.success("User deleted"),ze()):S.error(r?.message||"Delete failed")}catch{S.error("Delete failed")}}})},Te=async()=>{try{const n=await Se.validateFields(),M={name:n.name,email:n.email,...n.phone?{phone:n.phone}:{},role:n.role,status:n.status,...n.jobTitle?{jobTitle:n.jobTitle}:{},...n.employeeCode?{employeeCode:n.employeeCode}:{},...n.primaryBranch?{primaryBranch:n.primaryBranch}:{},...Array.isArray(n.branches)?{branches:n.branches}:{},canSwitchBranch:!!n.canSwitchBranch};R(!0);const r=Y(E);if(!r){S.error("Cannot create users here. Use registration.");return}const P=await ys(r,M);if(P?._status===401||P?._status===403){S.warning("Please login again to continue.");return}P?.success?(S.success("User updated"),Z(!1),G(null),Se.resetFields(),ze()):S.error(P?.message||"Save failed")}catch(n){const M=n?.response?.data?.message||n?.message||"Save failed";S.error(M)}finally{R(!1)}},K=D.map(n=>({label:n.name,value:n.id||n._id})),c=[{title:"Name",dataIndex:"name",key:"name",width:160,ellipsis:!0,sorter:(n,M)=>n.name.localeCompare(M.name)},{title:"Email",dataIndex:"email",key:"email",width:180,ellipsis:!0},{title:"Phone",dataIndex:"phone",key:"phone",width:110,ellipsis:!0},{title:"Role",dataIndex:"role",key:"role",width:100,render:n=>e.jsx(he,{color:n==="admin"?"red":n==="owner"?"gold":n==="backend"?"purple":n==="mechanic"?"cyan":n==="staff"?"blue":"default",children:n})},{title:"Primary Branch",key:"primaryBranch",width:140,ellipsis:!0,render:(n,M)=>M.primaryBranch?.name||"â€”"},{title:"Status",dataIndex:"status",key:"status",width:90,render:n=>n==="active"?e.jsx(he,{color:"green",children:"Active"}):n==="inactive"?e.jsx(he,{children:"Inactive"}):e.jsx(he,{color:"orange",children:"Suspended"})},{title:"Last Login",dataIndex:"lastLoginAt",key:"lastLoginAt",width:140,render:n=>n?Ze(n).format("DD-MM-YYYY HH:mm"):"â€”"},...l?[]:[{title:"Actions",key:"actions",width:160,render:(n,M)=>e.jsxs(me,{size:4,wrap:!0,children:[e.jsx(q,{size:"small",onClick:r=>{r.stopPropagation(),be(M)},children:"Edit"}),e.jsx(q,{size:"small",danger:!0,onClick:r=>{r.stopPropagation(),Re(M)},children:"Delete"})]})}]],w=()=>{if(!z.length){S.info("No users to export for current filters");return}const n=[{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"phone",label:"Phone"},{key:"role",label:"Role"},{key:"status",label:"Status"},{key:"jobTitle",label:"Job Title"},{key:"employeeCode",label:"Employee Code"},{key:"primaryBranch",label:"Primary Branch"},{key:"branches",label:"Additional Branches"},{key:"lastLoginAt",label:"Last Login"}],M=z.map(r=>{const P=Array.isArray(r.branches)?r.branches.map(O=>typeof O=="string"?O:O?.name||O?.branchName||"").filter(Boolean).join("; "):"";return{name:r.name,email:r.email,phone:r.phone,role:r.role,status:r.status,jobTitle:r.jobTitle,employeeCode:r.employeeCode,primaryBranch:(typeof r.primaryBranch=="string"?r.primaryBranch:r.primaryBranch?.name)||"",branches:P,lastLoginAt:r.lastLoginAt}});Gt({filename:"users.csv",headers:n,rows:M}),S.success(`Exported ${M.length} users`)};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:12,gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Total:"})," ",V]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(ee.Search,{placeholder:"Search name/email/phone",allowClear:!0,value:J,onChange:n=>k(n.target.value),onSearch:n=>ye((n||"").trim()),style:{width:240}}),e.jsx(pe,{placeholder:"Role",allowClear:!0,value:ge,onChange:n=>ae(n),options:_a,style:{width:140}}),e.jsx(pe,{placeholder:"Status",allowClear:!0,value:Le,onChange:n=>de(n),options:Fa,style:{width:140}}),e.jsx(pe,{placeholder:"Branch",allowClear:!0,showSearch:!0,optionFilterProp:"label",value:Ae,onChange:n=>je(n),options:D.map(n=>({label:n.name,value:n.id})),style:{width:220}}),e.jsx(q,{onClick:w,children:"Export CSV"}),e.jsx(q,{onClick:ze,children:"Refresh"}),e.jsx(q,{onClick:()=>{k(""),ye(""),ae(void 0),de(void 0),je(void 0)},children:"Reset"})]})]}),e.jsx(Bt,{rowKey:n=>Y(n)||`${n.email||""}-${n.phone||""}-${n.name||""}`,dataSource:z,columns:c,loading:p,tableLayout:u?"auto":"fixed",pagination:{current:Ue,pageSize:_e,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(n,M)=>{oe(n),M!==_e&&ue(M)},showTotal:(n,M)=>`${M[0]}-${M[1]} of ${n}`},size:u?"small":"middle",scroll:u?{x:"max-content"}:void 0}),e.jsx(it,{title:E?`Edit User â€“ ${E.name}`:"New User",open:U,onCancel:()=>{Z(!1),G(null)},onOk:Te,okText:E?"Save":"Create",confirmLoading:_,forceRender:!0,destroyOnClose:!0,children:e.jsx(H,{form:Se,layout:"vertical",children:e.jsxs(Ot,{gutter:[12,8],children:[e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(ee,{placeholder:"Full name"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"email",label:"Email",rules:[{required:!0,message:"Email is required"},{type:"email",message:"Enter a valid email"}],children:e.jsx(ee,{placeholder:"name@example.com"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"phone",label:"Phone",children:e.jsx(ee,{placeholder:"Mobile number"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"role",label:"Role",initialValue:"user",rules:[{required:!0}],children:e.jsx(pe,{options:_a})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"status",label:"Status",initialValue:"active",rules:[{required:!0}],children:e.jsx(pe,{options:Fa})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"jobTitle",label:"Job Title",children:e.jsx(ee,{placeholder:"e.g., Sales Executive"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"employeeCode",label:"Employee Code",children:e.jsx(ee,{placeholder:"Unique within primary branch"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"primaryBranch",label:"Primary Branch",children:e.jsx(pe,{allowClear:!0,options:K,placeholder:"Select primary branch"})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"branches",label:"Additional Branches",children:e.jsx(pe,{mode:"multiple",allowClear:!0,options:K,placeholder:"Select additional branches"})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"canSwitchBranch",valuePropName:"checked",children:e.jsx(Ss,{children:"Can switch branches"})})})]})})})]})}function va(l,x=250){const[u,p]=o.useState(l);return o.useEffect(()=>{const B=setTimeout(()=>p(l),x);return()=>clearTimeout(B)},[l,x]),u}function Ms({open:l,onClose:x,row:u,webhookUrl:p}){const[B,_]=o.useState(!1),[R,z]=o.useState(null),L=d=>Number(String(d??0).replace(/[â‚¹,\s]/g,""))||0,V=(d={})=>{const U=d.vehicle||{},Z=String(d.purchaseMode||d.purchaseType||"").toLowerCase()||"cash",E=Array.isArray(d.addressProofTypes)?d.addressProofTypes:String(d.addressProofTypes||"").split(",").map(Y=>Y.trim()).filter(Boolean),G=Array.isArray(d.payments)?d.payments:[];if((!G||G.length===0)&&(d.bookingAmount||d.paymentMode)){const Y={amount:d.bookingAmount,mode:d.paymentMode,reference:d.paymentReference||d.utr||d.ref};Number(Y.amount||0)>0&&Y.mode&&G.push(Y)}const D=Y=>Number(String(Y??"").replace(/[â‚¹,\s]/g,""))||0,ie=[{cash:0,online:0,ref:void 0},{cash:0,online:0,ref:void 0},{cash:0,online:0,ref:void 0}],Se=(Y,J=0)=>{const k=String(Y?.mode||"").toLowerCase(),$=D(Y?.amount);if(!$)return;const ye=Number(Y?.part)&&Number(Y?.part)>=1&&Number(Y?.part)<=3?Number(Y.part)-1:Math.min(Math.max(J,0),2);k==="online"?(ie[ye].online+=$,ie[ye].ref||(ie[ye].ref=Y?.reference||Y?.utr||Y?.ref)):ie[ye].cash+=$};return G.forEach((Y,J)=>Se(Y,J)),{customerName:d.customerName||d.name||"",mobileNumber:String(d.mobileNumber||d.mobile||""),address:d.address||"",branch:d.branch||"",executive:d.executive||"",company:U.company||"",bikeModel:U.model||"",variant:U.variant||"",color:U.color||void 0,chassisNo:U.chassisNo||(U.availability==="allot"?"__ALLOT__":void 0),rtoOffice:d.rtoOffice||"KA",purchaseType:Z,financier:Z==="loan"&&d.financier||void 0,nohpFinancier:Z==="nohp"&&(d.financier||d.nohpFinancier)||void 0,disbursementAmount:(Z==="loan"||Z==="nohp")&&L(d.disbursementAmount)||void 0,addressProofMode:d.addressProofMode||d.addressProof||"aadhaar",addressProofTypes:E,bookingAmount1Cash:ie[0].cash||void 0,bookingAmount1Online:ie[0].online||void 0,paymentReference1:ie[0].ref||void 0,bookingAmount2Cash:ie[1].cash||void 0,bookingAmount2Online:ie[1].online||void 0,paymentReference2:ie[1].ref||void 0,bookingAmount3Cash:ie[2].cash||void 0,bookingAmount3Online:ie[2].online||void 0,paymentReference3:ie[2].ref||void 0,bookingAmount:L(d.bookingAmount??void 0)||void 0,downPayment:L((d.dp&&d.dp.downPayment)??d.downPayment),extraFittingAmount:L((d.dp&&d.dp.extraFittingAmount)??d.extraFittingAmount),affidavitCharges:L((d.dp&&d.dp.affidavitCharges)??d.affidavitCharges)}};return o.useEffect(()=>{let d=!0;return(async()=>{if(!(!l||!u)){_(!0);try{if(p&&u.bookingId){const Z=await rt({webhookUrl:p,method:"GET",payload:{action:"search",mode:"booking",query:u.bookingId}}),E=Z?.data||Z,G=Array.isArray(E?.rows)&&E.rows.length?E.rows[0]?.payload:null;d&&z(V(G||{customerName:u.name,mobileNumber:u.mobile,branch:u.branch,vehicle:{company:u.company,model:u.model,variant:u.variant,chassisNo:u.chassis}}))}else d&&z(V({customerName:u?.name,mobileNumber:u?.mobile,branch:u?.branch,vehicle:{company:u?.company,model:u?.model,variant:u?.variant,chassisNo:u?.chassis}}))}catch{d&&(S.warning("Could not fetch full booking. Opening with available fields."),z(V({customerName:u?.name,mobileNumber:u?.mobile,branch:u?.branch,vehicle:{company:u?.company,model:u?.model,variant:u?.variant,chassisNo:u?.chassis}})))}finally{d&&_(!1)}}})(),()=>{d=!1}},[l,u,p]),e.jsx(it,{open:l,title:"Prefilled Booking Form",onCancel:x,footer:null,width:980,destroyOnClose:!0,children:B?e.jsx("div",{style:{display:"grid",placeItems:"center",height:160},children:e.jsx(vs,{})}):e.jsx("div",{style:{paddingTop:8},children:e.jsx(Ha,{asModal:!0,initialValues:R||{},startPaymentsOnly:!!u?.bookingId,editRefDefault:u?.bookingId?{bookingId:u.bookingId,mobile:u.mobile}:null})})})}const{Text:Pt}=Xt,He={ts:["Submitted At","Timestamp","Time","Date"],branch:["Branch"],name:["Customer Name","Customer_Name","Customer","Name"],mobile:["Mobile Number","Mobile","Phone"],bookingId:["Booking ID","Booking_ID","Booking Id","BookingID"],company:["Company"],model:["Model"],variant:["Variant"],color:["Color","Colour","Vehicle Color","Vehicle Colour"],chassis:["Chassis Number","Chassis No","Chassis"],file:["File URL","File","Document URL"],status:["Status","Booking Status","State"],availability:["Chassis Availability","Availability","Stock","Stock Status"]},Ye=(l,x)=>String(x.map(u=>l[u]??"").find(u=>u!=="")||"").trim();function Cn(){const x=!Ut.useBreakpoint().md,[u,p]=o.useState([]),[B,_]=o.useState(!1),[R,z]=o.useState("all"),[L,V]=o.useState("all"),[d,U]=o.useState(null),[Z,E]=o.useState(null),[,G]=o.useState(null),[D,ie]=o.useState({open:!1,row:null}),[Se,Y]=o.useState({open:!1,row:null}),[J,k]=o.useState(""),$=va(J,300),[ye,ge]=o.useState(1),[ae,Le]=o.useState(25),[de,Ae]=o.useState("pagination"),[je,Ue]=o.useState(25),[oe,_e]=o.useState(0),ue="true".toLowerCase()==="true",[Ee,ze]=o.useState({}),[be,Re]=o.useState({open:!1,refId:"",level:"ok",text:""}),[Te,K]=o.useState(!1),[c,w]=o.useState(!1),[n,M]=o.useState({open:!1,type:"",row:null,fileList:[],loading:!1}),[r,P]=o.useState({open:!1}),[O,Ce]=o.useState([]),[Oe,Ve]=o.useState([]),[Xe,gt]=o.useState(!1),[qe,ct]=o.useState([]),[It,Et]=o.useState([]),[Mt,bt]=o.useState(!1),[Ge,Be]=o.useState([]),[vt,Tt]=o.useState(!1),[Nt,Ct]=o.useState(0),[dt,ut]=o.useState(""),[mt,et]=o.useState(null),[De,kt]=o.useState(""),[tt,Ke]=o.useState(!1),[Fe,ht]=o.useState({open:!1,row:null}),[Lt,m]=o.useState(""),[f,j]=o.useState(!1),[T,C]=o.useState(!1),[a]=H.useForm(),[i,v]=o.useState(null),[g,y]=o.useState(""),[A,re]=o.useState([]);o.useEffect(()=>{try{const t=localStorage.getItem("user");if(!t)return;const s=JSON.parse(t);v(s),y(String(s?.role||"").toLowerCase());const h=[],b=s?.formDefaults?.branchName||s?.primaryBranch?.name||"";b&&h.push(b),Array.isArray(s?.branches)&&s.branches.forEach(I=>{const F=typeof I=="string"?I:I?.name||"";F&&h.push(F)}),re(Array.from(new Set(h.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(g)&&A.length&&R==="all"&&z(A[0])},[g,A,R]);const Q=o.useCallback(async()=>{gt(!0);try{const[t,s]=await Promise.allSettled([Zt({status:"active",limit:500}),ua({role:"staff",status:"active",limit:1e5})]);if(t.status==="fulfilled"&&t.value?.success){const h=St((t.value.data.items||[]).filter(b=>String(b?.status||"").toLowerCase()==="active").map(b=>b.name));Ce(h)}else Ce([]),t.status==="fulfilled"&&S.warning(t.value?.message||"Could not load branches");if(s.status==="fulfilled"&&s.value?.success){const h=St((s.value.data.items||[]).filter(b=>String(b.role||"").toLowerCase()==="staff").map(b=>b.name||b.email||""));Ve(h)}else Ve([]),s.status==="fulfilled"&&S.warning(s.value?.message||"Could not load executives")}catch{Ce([]),Ve([]),S.error("Could not load dropdown options")}finally{gt(!1)}},[]);o.useEffect(()=>{Q()},[Q]);const W="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",ce="",Ie=(()=>{const t=d&&d[0]?d[0].startOf("day").valueOf():"",s=d&&d[1]?d[1].endOf("day").valueOf():"";return`Bookings:list:${JSON.stringify({branchFilter:R,statusFilter:L,q:$||"",start:t,end:s,page:ye,pageSize:ae,USE_SERVER_PAG:ue})}`})(),we=o.useCallback((t,s=0)=>{let h={};try{h=typeof t["Raw Payload"]=="object"?t["Raw Payload"]||{}:JSON.parse(String(t["Raw Payload"]||t.rawPayload||t.payload||"{}"))}catch{h={}}const b=h?.color||h?.vehicle?.color||h?.vehicleColor||h?.formValues?.color||"",I=(h?.remark?.level||t.RemarkLevel||t.remarkLevel||"").toString(),F=h?.remark?.text||t.RemarkText||t.remarkText||"",se=String(I||"").toLowerCase();return{key:s,ts:Ye(t,He.ts),tsMs:da(Ye(t,He.ts)),bookingId:Ye(t,He.bookingId),name:Ye(t,He.name),mobile:Ye(t,He.mobile),company:Ye(t,He.company),model:Ye(t,He.model),variant:Ye(t,He.variant),color:Ye(t,He.color)||String(b||"").trim(),chassis:Ye(t,He.chassis),fileUrl:Ye(t,He.file),branch:Ye(t,He.branch),status:(Ye(t,He.status)||"pending").toLowerCase(),availability:Ye(t,He.availability),RemarkLevel:I||"",RemarkText:F||"",_remarkLevel:se,_remarkText:F||"",_raw:t}},[]);o.useEffect(()=>{try{const t=localStorage.getItem(Ie);if(!t)return;const s=JSON.parse(t);s&&Array.isArray(s.rows)&&(p(s.rows),_e(typeof s.total=="number"?s.total:s.rows.length),w(!0))}catch{}},[Ie]),o.useEffect(()=>{let t=!1;return(async()=>{try{const b=await rt({webhookUrl:W,method:"GET",payload:ce?{action:"list",page:1,pageSize:5e3,secret:ce}:{action:"list",page:1,pageSize:5e3}}),I=b?.data||b,se=(Array.isArray(I?.data)?I.data:[]).map((N,X)=>we(N,X));t||ct(se)}catch{}})(),()=>{t=!0}},[W,ce,we]),o.useEffect(()=>{let t=!1;return(async()=>{bt(!0);try{let I=1,F=[];for(;;){const se={action:"list"},N={q:$||"",branch:R!=="all"?R:"",status:L!=="all"?L:""};d&&d[0]&&d[1]&&(N.start=d[0].startOf("day").valueOf(),N.end=d[1].endOf("day").valueOf());const X={...se,page:I,pageSize:5e3,...N},xe=await rt({webhookUrl:W,method:"GET",payload:X}),Pe=xe?.data||xe,ke=Array.isArray(Pe?.data)?Pe.data:[];F=F.concat(ke.map((ft,xt)=>we(ft,xt)));const We=typeof Pe?.total=="number"?Pe.total:null;if(We!==null&&F.length>=We||ke.length===0||(I+=1,I>200))break}t||Et(F)}catch{t||Et([])}finally{t||bt(!1)}})(),()=>{t=!0}},[$,R,L,d,W,we]),o.useEffect(()=>{let t=!1;const s=async()=>{_(!0);try{const b=W,I="",F={action:"list"},se={q:$||"",branch:R!=="all"?R:"",status:L!=="all"?L:""};d&&d[0]&&d[1]&&(se.start=d[0].startOf("day").valueOf(),se.end=d[1].endOf("day").valueOf());const N=ue?{...F,page:ye,pageSize:ae,...se,...I?{secret:I}:{}}:I?{...F,secret:I}:F,X=await rt({webhookUrl:b,method:"GET",payload:N}),xe=X?.data||X;if(!xe?.ok||!Array.isArray(xe?.data))throw new Error("Invalid response");const ke=xe.data.map((We,ft)=>we(We,ft)).filter(We=>We.bookingId||We.name||We.mobile);if(!t){p(ke);const We=typeof xe.total=="number"?xe.total:ke.length;_e(We);const ft={};ke.forEach(xt=>{xt.bookingId&&(ft[xt.bookingId]={level:xt._remarkLevel||String(xt.RemarkLevel||"").toLowerCase(),text:xt._remarkText||xt.RemarkText||""})}),ze(ft);try{localStorage.setItem(Ie,JSON.stringify({at:Date.now(),rows:ke,total:We}))}catch{}}}catch{S.error("Could not load bookings via Apps Script. Check Web App URL / access."),t||(p([]),_e(0))}finally{t||_(!1)}};s();const h=()=>s();return window.addEventListener("reload-bookings",h),()=>{t=!0}},[$,R,L,ye,ae,d,W,ue]);const ve=qe.length?qe:u,Ne=o.useMemo(()=>{const s=["all",...St(ve.map(b=>b.branch))];if(!["owner","admin","backend"].includes(g)&&A.length){const b=jt(A);return s.filter(I=>I==="all"||b.has(te(I)))}return s},[ve,g,A]),$e=o.useMemo(()=>["all",...St(ve.map(t=>t.status))],[ve]),nt=o.useCallback(t=>{const s=jt(A);return(t||[]).filter(b=>{if(s.size&&!["owner","admin"].includes(g)&&!s.has(te(b.branch))||R!=="all"&&te(b.branch)!==te(R)||L!=="all"&&te(b.status)!==te(L))return!1;if(d&&d[0]&&d[1]){const I=d[0].startOf("day").valueOf(),F=d[1].endOf("day").valueOf(),se=b.tsMs??da(b.ts);if(!se||se<I||se>F)return!1}if($){const I=$.toLowerCase();if(![b.bookingId,b.name,b.mobile,b.company,b.model,b.variant,b.color,b.chassis,b.branch].some(F=>String(F||"").toLowerCase().includes(I)))return!1}return!0}).slice().sort((b,I)=>(I.tsMs||0)-(b.tsMs||0))},[A,R,d,$,L,g]),pt=o.useMemo(()=>nt(u),[nt,u]);o.useEffect(()=>{ge(1),Ue(ae)},[R,L,$,d]),o.useEffect(()=>{Ue(ae)},[ae]);const ot=o.useCallback(async()=>{if(!ue)return u;const t={action:"list",page:1,pageSize:1e4},s={q:$||"",branch:R!=="all"?R:"",status:L!=="all"?L:""};d&&d[0]&&d[1]&&(s.start=d[0].startOf("day").valueOf(),s.end=d[1].endOf("day").valueOf());const h={...t,...s},b=await rt({webhookUrl:W,method:"GET",payload:h}),I=b?.data||b;return(Array.isArray(I?.data)?I.data:[]).map((se,N)=>we(se,N)).filter(se=>se.bookingId||se.name||se.mobile)},[ue,W,ce,R,d,$,we,L,u]),ea=async()=>{const t="export-bookings";S.loading({key:t,content:"Preparing CSVâ€¦",duration:0});try{const s=ue?await ot():u,h=nt(s);if(!h.length){S.info({key:t,content:"No rows to export for current filters"});return}const b=[{key:"ts",label:"Submitted At"},{key:"bookingId",label:"Booking ID"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"status",label:"Status"},{key:"availability",label:"Stock Status"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"chassis",label:"Chassis"},{key:"fileUrl",label:"File URL"}],I=h.map(F=>({ts:F.ts,bookingId:F.bookingId,name:F.name,mobile:F.mobile,branch:F.branch,status:F.status,availability:xa(F.chassis,F.availability),company:F.company,model:F.model,variant:F.variant,chassis:F.chassis,fileUrl:F.fileUrl}));Gt({filename:"bookings.csv",headers:b,rows:I}),S.success({key:t,content:`Exported ${I.length} bookings`})}catch{S.error({key:t,content:"Export failed. Please try again."})}},ta=120*1e3,Kt=o.useMemo(()=>{const t=["owner","admin","backend"].includes(g);return R!=="all"?R:!t&&A.length===1?A[0]:""},[A,R,g]),_t=o.useMemo(()=>jt(O),[O]),Wt=o.useMemo(()=>R!=="all"?jt([R]):!["owner","admin","backend"].includes(g)&&A.length?jt(A):null,[A,R,g]),Ht=o.useCallback(t=>{const s=te(t?.sourceBranch||t?.branch||"");if(!s||_t.size&&!_t.has(s)||Wt&&Wt.size&&!Wt.has(s))return!1;const h=String(t?.status||"").toLowerCase();return!(h&&h!=="in_stock"&&h!=="in stock")},[_t,Wt]),Yt=o.useCallback(async(t=!1)=>{if(vt)return;const s=Kt||"";if(!(!t&&Ge.length>0&&Date.now()-Nt<ta&&dt===s)){Tt(!0);try{const b=await ks({branch:s||void 0,limit:2e3}),I=Array.isArray(b?.data)?b.data:[];Be(I),Ct(Date.now()),ut(s)}catch{S.error("Could not load stock list.")}finally{Tt(!1)}}},[vt,Ge.length,Nt,dt,Kt]),Qa={pending:"gold",seen:"blue",approved:"green",allotted:"purple",cancelled:"red"},xa=t=>!!String(t||"").trim()?"In Stock":"To be allotted",Za=t=>t==="In Stock"?"green":"volcano",At=async(t,s,h)=>{let b=!1;try{G(t);const F="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",se="",N=s||{},X={...N};N.invoiceStatus&&(X["Invoice Status"]=N.invoiceStatus),(N.invoiceFileUrl||N.invoiceFile)&&(X["Invoice File URL"]=N.invoiceFileUrl||N.invoiceFile),N.insuranceStatus&&(X["Insurance Status"]=N.insuranceStatus),(N.insuranceFileUrl||N.insuranceFile)&&(X["Insurance File URL"]=N.insuranceFileUrl||N.insuranceFile),N.rtoStatus&&(X["RTO Status"]=N.rtoStatus),(N.vehicleNo||N.regNo)&&(X["Vehicle No"]=N.vehicleNo||N.regNo),N.status&&(X.Status=N.status),await rt({webhookUrl:F,method:"POST",payload:se?{action:"update",bookingId:t,mobile:h,patch:X,secret:se}:{action:"update",bookingId:t,mobile:h,patch:X}}),p(xe=>xe.map(Pe=>{if(Pe.bookingId!==t)return Pe;const ke={...Pe};return s.status&&(ke.status=String(s.status).toLowerCase()),s.invoiceStatus&&(ke.invoiceStatus=s.invoiceStatus),(s.invoiceFileUrl||s.invoiceFile)&&(ke.invoiceFileUrl=s.invoiceFileUrl||s.invoiceFile),s.insuranceStatus&&(ke.insuranceStatus=s.insuranceStatus),(s.insuranceFileUrl||s.insuranceFile)&&(ke.insuranceFileUrl=s.insuranceFileUrl||s.insuranceFile),s.rtoStatus&&(ke.rtoStatus=s.rtoStatus),(s.vehicleNo||s.regNo)&&(ke.vehicleNo=s.vehicleNo||s.regNo),Object.prototype.hasOwnProperty.call(s,"chassis")&&(ke.chassis=s.chassis),Object.prototype.hasOwnProperty.call(s,"chassisNo")&&(ke.chassis=s.chassisNo),ke._raw={...Pe._raw||{},...s},ke})),S.success("Updated"),b=!0}catch{S.error("Update failed"),b=!1}finally{G(null)}return b},Xa=async t=>{const h="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",b="",I=new FormData;I.append("action","upload");const F=t?.originFileObj||t;I.append("file",F,t?.name||F?.name||"document.pdf");try{const N=await(await fetch(h,{method:"POST",body:I,credentials:"omit"})).json().catch(()=>({}));if(N&&(N.ok||N.success))return N;throw new Error("Upload failed")}catch(se){try{const N=await new Promise((ke,We)=>{const ft=new FileReader,xt=t?.originFileObj||t;ft.onload=()=>{const ia=String(ft.result||""),Ea=ia.indexOf(",");ke(Ea>=0?ia.slice(Ea+1):ia)},ft.onerror=We,ft.readAsDataURL(xt)}),X=b?{action:"upload_base64",name:t?.name||"document.pdf",base64:N,secret:b}:{action:"upload_base64",name:t?.name||"document.pdf",base64:N},xe=await rt({webhookUrl:h,method:"POST",payload:X}),Pe=xe?.data||xe;if(Pe&&(Pe.ok||Pe.success))return Pe}catch{}throw se}},es=t=>t.type==="application/pdf"||(t.name||"").toLowerCase().endsWith(".pdf")?(t.size||0)<=10*1024*1024?!1:(S.error("File must be <= 5MB"),ca.LIST_IGNORE):(S.error("Only PDF files allowed"),ca.LIST_IGNORE),ts=async(t,s)=>{s==="received"?M({open:!0,type:"invoice",row:t,fileList:[],loading:!1}):await At(t.bookingId,{invoiceStatus:s},t.mobile)},as=async(t,s)=>{s==="received"?M({open:!0,type:"insurance",row:t,fileList:[],loading:!1}):await At(t.bookingId,{insuranceStatus:s},t.mobile)},ss=async(t,s)=>{await At(t.bookingId,{rtoStatus:s},t.mobile)},[Sa,ns]=o.useState({}),ka=async t=>{const s=String(Sa[t.bookingId]||"").trim(),h=za(s);if(!h){S.error("Enter vehicle number");return}if(!/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/.test(h)){S.error("Use format KA55HY5666 (2 letters, 2 digits, 2 letters, 4 digits)");return}await At(t.bookingId,{vehicleNo:h,regNo:h},t.mobile)},wa=o.useCallback(t=>{if(!t)return[];const s=te(t.company),h=te(t.model),b=te(t.variant),I=te(t.color),F=new Set,se=[];return Ge.forEach(N=>{if(!Ht(N)||s&&te(N.company)!==s||h&&te(N.model)!==h||b&&te(N.variant)!==b||I&&te(N.color)!==I)return;const X=Je(N.chassisNo||N.chassis||"");if(!X||F.has(X))return;F.add(X);const xe=[X],Pe=String(N.color||"").trim(),ke=String(N.sourceBranch||N.branch||"").trim();Pe&&xe.push(Pe),ke&&xe.push(ke),se.push({value:X,label:xe.join(" - ")})}),se.sort((N,X)=>N.label.localeCompare(X.label))},[Ge,Ht]),ja=o.useCallback((t,s)=>{const h=Je(s);if(!h||!t)return null;const b=te(t.company),I=te(t.model),F=te(t.variant),se=te(t.color);return Ge.find(N=>!(!Ht(N)||Je(N.chassisNo||N.chassis||"")!==h||b&&te(N.company)!==b||I&&te(N.model)!==I||F&&te(N.variant)!==F||se&&te(N.color)!==se))||null},[Ge,Ht]);o.useEffect(()=>{if(!Fe.open||!Fe.row)return;const t=Fe.row,s=t.bookingId?`Booking ID ${t.bookingId}`:"";a.setFieldsValue({company:t.company||"",model:t.model||"",variant:t.variant||"",color:t.color||"",sourceBranch:t.branch||"",chassis:"",notes:s?`Added for ${s}`:""}),m(""),Yt()},[Fe.open,Fe.row,Yt,a]);const aa=t=>{if(!t?.bookingId){S.warning("Booking ID missing for this row.");return}et(null),kt(""),ht({open:!0,row:t})},Ca=()=>{f||T||(ht({open:!1,row:null}),m(""),a.resetFields())},os=t=>{if(!t?.bookingId){S.warning("Booking ID missing for this row.");return}if(!t?.chassis){aa(t);return}et(t.bookingId),kt(Je(t?.chassis||"")),Yt()},Aa=()=>{tt||(et(null),kt(""))},sa=async(t,s,h={})=>{if(!t?.bookingId)return!1;const b=Je(s);if(!b)return S.error("Select a chassis from stock to assign."),!1;const I=h?.matchedOverride||ja(t,b);if(!I)return S.error("Chassis not found in stock. Add stock movement first."),!1;if(!await At(t.bookingId,{chassis:b},t.mobile))return!1;if(I&&b){const se=i?.name||i?.email||"user",N={Chassis_No:b,Company:I.company||t.company||"",Model:I.model||t.model||"",Variant:I.variant||t.variant||"",Color:I.color||t.color||"",Action:"invoice",Customer_Name:t.name||"",Source_Branch:I.sourceBranch||I.branch||"",Notes:t.bookingId?`Allotted to Booking ID ${t.bookingId}`:"Allotted from bookings"};try{const X=await Ma({data:N,createdBy:se});!!(X?.success??X?.ok)?Be(Pe=>Pe.filter(ke=>Je(ke.chassisNo||ke.chassis||"")!==b)):S.error(X?.message||"Saved booking but failed to update stock.")}catch{S.error("Saved booking but failed to update stock.")}}return!0},na=async()=>{if(!Fe.row||f)return;j(!0);const t=await sa(Fe.row,Lt);j(!1),t&&(ht({open:!1,row:null}),m(""),a.resetFields())},ls=async()=>{if(!Fe.row||T||f)return;if(Je(a.getFieldValue("chassis"))){await rs();return}if(Je(Lt)){await na();return}S.warning("Enter chassis number or pick from stock.")},rs=async()=>{if(!Fe.row||T)return;let t=!1;try{const s=await a.validateFields();C(!0);const h=Fe.row,b=Je(s.chassis),I=h.bookingId?`Booking ID ${h.bookingId}`:"",F=String(s.notes||"").trim(),se=I?F?`${F} | ${I}`:I:F,N={Chassis_No:b,Company:s.company||h.company||"",Model:s.model||h.model||"",Variant:s.variant||h.variant||"",Color:s.color||h.color||"",Action:"add",Source_Branch:s.sourceBranch||h.branch||"",Notes:se},X=i?.name||i?.email||"user",xe=await Ma({data:N,createdBy:X});if(!!(xe?.success??xe?.ok)){const ke={chassisNo:b,company:N.Company||h.company||"",model:N.Model||h.model||"",variant:N.Variant||h.variant||"",color:N.Color||h.color||"",sourceBranch:N.Source_Branch||h.branch||"",status:"in_stock"};await sa(h,b,{matchedOverride:ke})?(S.success("Stock movement saved and chassis assigned."),t=!0):(S.warning("Stock movement saved. Assign chassis from stock below."),Yt(!0),m(b))}else S.error(xe?.message||"Failed to save stock movement.")}catch(s){if(s?.errorFields)return;const h=s?.response?.data?.message||s?.message;S.error(h||"Failed to save stock movement.")}finally{C(!1),t&&Ca()}},Ra=async t=>{if(!t?.bookingId||tt)return;const s=Je(De),h=Je(t?.chassis||"");if(s===h){Aa();return}Ke(!0);const b=await sa(t,s);Ke(!1),b&&(et(null),kt(""))},oa={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},Ft={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},is={...Ft,fontSize:11},la={whiteSpace:"normal"},cs=t=>{const s=Ze().format("DD-MM-YYYY HH:mm"),h=String(t||"").trim();return h?`${s} - ${h}`:s},Me=Fe.row,Ia=Me?[Me.company,Me.model,Me.variant,Me.color].filter(Boolean).join(" "):"",Ta=Me?St([Me.branch,...O].filter(Boolean)):O;let Jt=[{title:"Date / Branch",key:"dateBranch",width:130,render:(t,s)=>{const h=da(s.ts),b=h?Ze(h).format("DD-MM-YYYY HH:mm"):"â€”";return e.jsxs("div",{style:oa,children:[e.jsx("div",{style:Ft,children:b}),e.jsx("div",{style:Ft,children:e.jsx(Pt,{type:"secondary",children:s.branch||"â€”"})})]})}},{title:"Customer / Mobile / Model / File",key:"customerVehicleFile",width:240,render:(t,s)=>{const h=String(s.model||"").trim()||"â€”",b=String(s.variant||"").trim()||"â€”",I=String(s.color||"").trim(),F=[h,b,I].filter(Boolean).join(" || ")||"â€”";return e.jsxs("div",{style:oa,children:[e.jsx("div",{style:Ft,children:s.name||"â€”"}),e.jsx("div",{style:Ft,children:e.jsx(Pt,{type:"secondary",children:s.mobile||"â€”"})}),e.jsx("div",{style:is,children:F}),e.jsx("div",{style:la,children:e.jsxs(me,{size:6,wrap:!0,children:[e.jsx(Us,{url:s.fileUrl}),e.jsx(q,{size:"small",type:"primary",onClick:()=>ie({open:!0,row:s}),title:"Print","aria-label":"Print",children:"ðŸ–¨ï¸"}),e.jsx(q,{size:"small",onClick:()=>Y({open:!0,row:s}),title:"View details","aria-label":"View details",children:"ðŸ‘ï¸"})]})})]})}},{title:"Chassis / Stk Status + Actions",key:"chassisStock",width:210,render:(t,s)=>{if(mt===s.bookingId){const se=wa(s),N=ja(s,De);return e.jsxs(me,{direction:"vertical",size:4,children:[e.jsxs(me,{size:6,align:"center",wrap:!0,children:[e.jsx(Oa,{value:De,options:se,allowClear:!0,style:{width:200},placeholder:vt?"Loading stock...":"Pick chassis from stock",disabled:tt,onChange:X=>kt(Je(X)),onKeyDown:X=>{X.key==="Enter"&&(X.preventDefault(),Ra(s))},filterOption:(X,xe)=>String(xe?.value||"").toLowerCase().includes(String(X||"").toLowerCase())||String(xe?.label||"").toLowerCase().includes(String(X||"").toLowerCase())}),e.jsx(q,{size:"small",type:"primary",loading:tt,onClick:()=>Ra(s),children:"Save"}),e.jsx(q,{size:"small",disabled:tt,onClick:Aa,children:"Cancel"})]}),e.jsx(Pt,{type:"secondary",children:N?`In stock at ${N.sourceBranch||N.branch||"branch"} - will be allotted on save.`:se.length?"Pick from stock list to allot. If missing, add stock movement first.":"No stock for this model in current branches. Add stock movement first."})]})}const b=xa(s.chassis,s.availability),I=String(s.status||"pending").replace(/_/g," "),F=!s.chassis;return e.jsxs("div",{style:oa,children:[e.jsx("div",{style:la,children:e.jsxs(me,{size:6,align:"center",wrap:!0,children:[e.jsx("span",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace",cursor:"pointer"},title:F?"Assign chassis":"Edit chassis",onClick:()=>F?aa(s):os(s),children:s.chassis||"-"}),F?e.jsx(q,{size:"small",type:"link",onClick:()=>aa(s),children:"Assign"}):null]})}),e.jsx("div",{style:la,children:e.jsxs(me,{size:6,wrap:!0,children:[e.jsx(he,{color:Za(b),children:b}),e.jsx(he,{color:Qa[String(s.status||"").toLowerCase()]||"default",children:I})]})})]})}}];Jt.push({title:"More",key:"more",width:200,render:(t,s)=>e.jsxs(me,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsx(pe,{size:"small",placeholder:"Invoice",style:{width:"100%"},onChange:h=>ts(s,h),options:[{value:"submit_to_dealer",label:"Submit to dealer"},{value:"pending_by_dealer",label:"Pending by dealer"},{value:"received",label:"Received (upload)"}]}),e.jsx(pe,{size:"small",placeholder:"Insurance",style:{width:"100%"},onChange:h=>as(s,h),options:[{value:"sent",label:"Sent insurance"},{value:"received",label:"Received (upload)"}]}),e.jsx(pe,{size:"small",placeholder:"RTO status",style:{width:"100%"},onChange:h=>ss(s,h),options:[{value:"finance_otp_pending",label:"Finance Payment pending"},{value:"customer_otp_taken",label:"Customer OTP Pending"},{value:"registration_done",label:"Registration done"}]}),e.jsxs(me,{size:6,align:"center",children:[e.jsx(ee,{size:"small",placeholder:"KA55HY5666",style:{width:120},value:Sa[s.bookingId]??(s.vehicleNo||""),onChange:h=>ns(b=>({...b,[s.bookingId]:za(h.target.value)})),onPressEnter:()=>ka(s)}),e.jsx(q,{size:"small",onClick:()=>ka(s),children:"Save"})]})]})}),Jt.push({title:"Progress",key:"progress",width:120,render:(t,s)=>{const h=s._raw||{},b=h["Invoice Status"]||h.invoiceStatus||s.invoiceStatus||"",I=h["Invoice File URL"]||h.Invoice_File_URL||h.invoiceFileUrl||s.invoiceFileUrl||"",F=h["Insurance Status"]||h.insuranceStatus||s.insuranceStatus||"",se=h["Insurance File URL"]||h.Insurance_File_URL||h.insuranceFileUrl||s.insuranceFileUrl||"",N=h["RTO Status"]||h.rtoStatus||s.rtoStatus||"",X=h["Vehicle No"]||h.Vehicle_No||h.vehicleNo||s.vehicleNo||"",xe={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4,fontSize:11},children:[e.jsxs("div",{style:xe,children:[e.jsx(he,{color:"geekblue",title:"Invoice",children:String(b||"-").replace(/_/g," ")}),I?e.jsx("a",{href:I,target:"_blank",rel:"noopener noreferrer",children:"ðŸ“Ž"}):null]}),e.jsxs("div",{style:xe,children:[e.jsx(he,{color:"cyan",title:"Insurance",children:String(F||"-").replace(/_/g," ")}),se?e.jsx("a",{href:se,target:"_blank",rel:"noopener noreferrer",children:"ðŸ“Ž"}):null]}),e.jsx("div",{style:xe,children:e.jsx(he,{title:"RTO",children:String(N||"-").replace(/_/g," ")})}),e.jsx("div",{style:xe,children:e.jsx(he,{title:"Vehicle No",children:X||"-"})})]})}});const ra=["backend","admin","owner"].includes(g);Jt.push({title:ra?"Actions + Remarks":"Actions",key:"actions",width:ra?210:170,render:(t,s)=>e.jsxs(me,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsx(pe,{size:"small",defaultValue:s.status||"pending",style:{width:"100%"},onChange:h=>At(s.bookingId,{status:h},s.mobile),options:[{value:"pending",label:"Pending"},{value:"seen",label:"Seen"},{value:"approved",label:"Approved"},{value:"allotted",label:"Allotted"},{value:"cancelled",label:"Cancelled"}]}),ra?e.jsxs(me,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsxs(me,{size:6,wrap:!0,children:[e.jsx(he,{color:Ee[s.bookingId]?.level==="alert"?"red":Ee[s.bookingId]?.level==="warning"?"gold":Ee[s.bookingId]?.level==="ok"?"green":"default",children:Ee[s.bookingId]?.level?String(Ee[s.bookingId].level).toUpperCase():"â€”"}),e.jsx(q,{size:"small",onClick:()=>Re({open:!0,refId:s.bookingId,level:Ee[s.bookingId]?.level||"ok",text:Ee[s.bookingId]?.text||""}),children:"Remark"})]}),e.jsx(Rt,{title:Ee[s.bookingId]?.text?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:Ee[s.bookingId].text}):null,children:e.jsx("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:Ee[s.bookingId]?.text||"â€”"})})]}):null]})});const Na=ue?oe:u.length,La=x?420:600,zt=ue?pt:de==="loadMore"?pt.slice(0,je):pt,ds=o.useMemo(()=>{const t=It.length?It:nt(qe.length?qe:u),s=new Map;return(t||[]).forEach(h=>{const b=String(h.branch||"Unknown").trim()||"Unknown",I=te(b);s.has(I)||s.set(I,{key:I,branch:b,total:0});const F=s.get(I);F.total+=1}),Array.from(s.values()).sort((h,b)=>b.total-h.total)},[nt,qe,u,It]);return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[e.jsxs(me,{size:"small",wrap:!0,children:[e.jsx(pe,{value:R,onChange:z,style:{minWidth:160},disabled:!["owner","admin","backend"].includes(g),options:Ne.map(t=>({value:t,label:t==="all"?"All Branches":t}))}),e.jsx(pe,{value:L,onChange:V,style:{minWidth:160},options:$e.map(t=>({value:t,label:t==="all"?"All Statuses":t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ")}))}),e.jsx(ga.RangePicker,{value:d,onChange:t=>{U(t),E(null)},allowClear:!0}),e.jsx(q,{size:"small",type:Z==="today"?"primary":"default",onClick:()=>{const t=Ze();U([t,t]),E("today")},children:"Today"}),e.jsx(q,{size:"small",type:Z==="yesterday"?"primary":"default",onClick:()=>{const t=Ze().subtract(1,"day");U([t,t]),E("yesterday")},children:"Yesterday"}),e.jsx(q,{size:"small",onClick:()=>{U(null),E(null)},children:"Clear"}),e.jsx(ee,{placeholder:"Search name/mobile/booking",allowClear:!0,value:J,onChange:t=>k(t.target.value),style:{minWidth:220}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(me,{children:[e.jsx(q,{type:"primary",onClick:()=>{P({open:!0}),(!O.length||!Oe.length)&&Q()},children:"Booking Form"}),e.jsx(ws,{webhookUrl:W}),e.jsxs(he,{color:"blue",children:["Total: ",Na]}),e.jsxs(he,{color:"geekblue",children:["Showing: ",ue||de==="loadMore"?zt.length:pt.length,L!=="all"?` (status: ${L})`:""]}),!ue&&e.jsx(pe,{size:"small",value:de,onChange:t=>{Ae(t),Ue(ae)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(q,{onClick:ea,children:"Export CSV"}),e.jsx(q,{loading:B,onClick:()=>{const t=new Event("reload-bookings");window.dispatchEvent(t)},children:"Refresh"})]})]}),e.jsxs(Ot,{gutter:[12,12],style:{marginBottom:12},children:[Mt?e.jsx(ne,{xs:24,children:e.jsx(he,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,ds.map(t=>e.jsx(ne,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ba,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:t.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:t.total})]})})},t.key))]}),e.jsx(Bt,{dataSource:zt,columns:Jt,loading:B&&!c,size:"small",className:"compact-table",tableLayout:x?"auto":"fixed",pagination:ue?{current:ye,pageSize:ae,total:Na,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(t,s)=>{ge(t),s!==ae&&Le(s)},showTotal:(t,s)=>`${s[0]}-${s[1]} of ${t}`}:de==="pagination"?{current:ye,pageSize:ae,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(t,s)=>{ge(t),s!==ae&&Le(s)},showTotal:(t,s)=>`${s[0]}-${s[1]} of ${t}`}:!1,rowKey:t=>`${t.bookingId}-${t.mobile}-${t.ts}-${t.key}`,scroll:x?{x:"max-content",y:La}:{y:La}}),!ue&&de==="loadMore"&&zt.length<pt.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(q,{onClick:()=>Ue(t=>Math.min(t+ae,pt.length)),children:["Load more (",pt.length-zt.length," more)"]})}):null,e.jsx(it,{open:r.open,onCancel:()=>P({open:!1}),footer:null,width:1040,destroyOnClose:!0,title:"New Booking",bodyStyle:{paddingTop:8},children:e.jsx(Ha,{allowBranchSelect:!0,allowExecutiveSelect:!0,branchOptions:O,executiveOptions:Oe,branchOptionsLoading:Xe,executiveOptionsLoading:Xe,onSuccess:()=>{P({open:!1});try{window.dispatchEvent(new Event("reload-bookings"))}catch{}}})}),e.jsx(js,{open:D.open,onClose:()=>ie({open:!1,row:null}),row:D.row,webhookUrl:W,secret:ce}),e.jsx(Ms,{open:Se.open,onClose:()=>Y({open:!1,row:null}),row:Se.row,webhookUrl:W}),e.jsxs(it,{open:Fe.open,title:Me?`New Stock Movement â€“ ${Me.bookingId||Me.name||""}`:"New Stock Movement",onCancel:Ca,footer:null,width:760,destroyOnClose:!0,maskClosable:!f&&!T,closable:!f&&!T,children:[Me?e.jsxs("div",{style:{marginBottom:12},children:[e.jsxs("div",{style:{fontWeight:600},children:[Me.name||"Customer",Me.mobile?` â€¢ ${Me.mobile}`:""]}),e.jsxs("div",{style:{color:"#6b7280"},children:[Me.branch||"â€”",Ia?` â€¢ ${Ia}`:""]}),Me.bookingId?e.jsxs("div",{style:{color:"#6b7280"},children:["Booking ID: ",Me.bookingId]}):null]}):null,e.jsx(Pa,{orientation:"left",style:{marginTop:0},children:"New Stock Movement"}),e.jsxs(H,{form:a,layout:"vertical",children:[e.jsxs(Ot,{gutter:[12,8],children:[e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"company",label:"Company",children:e.jsx(ee,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"model",label:"Model",children:e.jsx(ee,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"variant",label:"Variant",children:e.jsx(ee,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"color",label:"Color",children:e.jsx(ee,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"sourceBranch",label:"Source Branch",rules:[{required:!0,message:"Source branch is required"}],children:Ta.length?e.jsx(pe,{showSearch:!0,optionFilterProp:"label",placeholder:"Select branch",options:Ta.map(t=>({label:t,value:t}))}):e.jsx(ee,{placeholder:"Enter source branch"})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"chassis",label:"Chassis No.",rules:[{required:!0,message:"Chassis number is required"}],children:e.jsx(ee,{placeholder:"Enter chassis number",onChange:t=>a.setFieldsValue({chassis:Je(t.target.value)})})})})]}),e.jsx(H.Item,{name:"notes",label:"Notes",children:e.jsx(ee.TextArea,{rows:2,placeholder:"Optional notes"})}),e.jsxs(me,{children:[e.jsx(q,{type:"primary",onClick:ls,loading:T||f,disabled:!Me,children:"Save & Assign"}),e.jsx(Pt,{type:"secondary",children:"Type chassis above or pick from stock below."})]})]}),e.jsx(Pa,{orientation:"left",children:"Assign from Stock"}),e.jsxs(me,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsx(Oa,{value:Lt,options:Me?wa(Me):[],allowClear:!0,style:{width:"100%"},placeholder:vt?"Loading stock...":"Pick chassis from stock",disabled:f,onChange:t=>m(Je(t)),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),na())},filterOption:(t,s)=>String(s?.value||"").toLowerCase().includes(String(t||"").toLowerCase())||String(s?.label||"").toLowerCase().includes(String(t||"").toLowerCase())}),e.jsxs(me,{children:[e.jsx(q,{type:"primary",onClick:na,loading:f,disabled:!Me,children:"Assign Chassis"}),e.jsx(Pt,{type:"secondary",children:"Only chassis from stock list can be assigned."})]})]})]}),e.jsx(it,{open:be.open,title:`Update Remark: ${be.refId}`,onCancel:()=>Te?null:Re({open:!1,refId:"",level:"ok",text:""}),confirmLoading:Te,maskClosable:!Te,keyboard:!Te,closable:!Te,cancelButtonProps:{disabled:Te},onOk:async()=>{if(!Te){K(!0);try{const t=cs(be.text),s=ce?{action:"remark",bookingId:be.refId,level:be.level,text:t,secret:ce}:{action:"remark",bookingId:be.refId,level:be.level,text:t},h=await rt({webhookUrl:W,method:"POST",payload:s});h&&(h.ok||h.success)?(ze(b=>({...b,[be.refId]:{level:be.level,text:t}})),p(b=>b.map(I=>I.bookingId===be.refId?{...I,RemarkLevel:be.level.toUpperCase(),RemarkText:t,_remarkLevel:be.level,_remarkText:t}:I)),S.success("Remark saved to sheet"),Re({open:!1,refId:"",level:"ok",text:""})):S.error("Save failed")}catch{S.error("Save failed")}finally{K(!1)}}},children:e.jsxs(me,{direction:"vertical",style:{width:"100%"},children:[e.jsx(pe,{value:be.level,onChange:t=>Re(s=>({...s,level:t})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(ee,{maxLength:140,showCount:!0,value:be.text,onChange:t=>Re(s=>({...s,text:t.target.value})),placeholder:"Short note (optional)"})]})}),e.jsx(it,{open:n.open,title:`${n.type==="invoice"?"Invoice":"Insurance"} â€“ Upload file`,onCancel:()=>M({open:!1,type:"",row:null,fileList:[],loading:!1}),confirmLoading:n.loading,okText:n.loading?"Savingâ€¦":"Save",cancelButtonProps:{disabled:n.loading},maskClosable:!n.loading,onOk:async()=>{if(n.loading)return;if(!n.row){M({open:!1,type:"",row:null,fileList:[],loading:!1});return}const t=(n.fileList||[])[0];if(!t){S.error("Please select a PDF file");return}M(h=>({...h,loading:!0}));const s="upload-progress";S.loading({key:s,content:"Uploading and savingâ€¦",duration:0}),setTimeout(async()=>{try{const h=await Xa(t),b=h?.url||h?.downloadUrl||"";if(!b){S.error({key:s,content:"Upload failed"}),M(I=>({...I,loading:!1}));return}n.type==="invoice"?await At(n.row.bookingId,{invoiceStatus:"received",invoiceFileUrl:b},n.row.mobile):n.type==="insurance"&&await At(n.row.bookingId,{insuranceStatus:"received",insuranceFileUrl:b},n.row.mobile),S.success({key:s,content:"Saved successfully"}),M({open:!1,type:"",row:null,fileList:[],loading:!1})}catch{S.error({key:s,content:"Could not upload file"}),M(h=>({...h,loading:!1}))}},0)},children:e.jsx(ca.Dragger,{multiple:!1,beforeUpload:es,accept:".pdf",fileList:n.fileList,maxCount:1,disabled:n.loading,onChange:({fileList:t})=>M(s=>({...s,fileList:t.slice(0,1)})),itemRender:t=>t,children:e.jsx("p",{children:"Drop PDF here or click to select (max 5MB, PDF only)"})})})]})}function da(l){if(!l)return null;if(l instanceof Date)return l.getTime();if(typeof l=="number")return l;const x=String(l).trim(),u=new Date(x);if(!isNaN(u.getTime()))return u.getTime();const p=x.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(p){const B=p[2];let _=parseInt(p[1],10),R=parseInt(p[3],10),z=parseInt(p[4],10);z<100&&(z+=2e3);let L,V;B==="-"||_>12?(V=_,L=R-1):(L=_-1,V=R);let d=p[5]?parseInt(p[5],10):0;const U=p[6]?parseInt(p[6],10):0,Z=p[7]?parseInt(p[7],10):0,E=(p[8]||"").toUpperCase();E==="PM"&&d<12&&(d+=12),E==="AM"&&d===12&&(d=0);const G=new Date(z,L,V,d,U,Z);if(!isNaN(G.getTime()))return G.getTime()}return null}function Ps(l){try{if(!l)return null;const x=new URL(l);if(x.searchParams.get("id"))return x.searchParams.get("id");const u=x.pathname.match(/\/d\/([^/]+)/);return u&&u[1]?u[1]:null}catch{const x=String(l||"").match(/[?&]id=([^&]+)/);return x?x[1]:null}}function Os(l){if(!l)return{view:"",download:"",embed:""};const x=Ps(l);return x?{view:`https://drive.google.com/uc?export=view&id=${x}`,download:`https://drive.google.com/uc?export=download&id=${x}`,embed:`https://drive.google.com/file/d/${x}/preview`}:{view:l,download:l,embed:l}}function Je(l){return String(l||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20)}function za(l){return String(l||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,10)}function Us({url:l}){if(!l)return e.jsx(Pt,{type:"secondary",children:"â€”"});const{view:x,download:u,embed:p}=Os(l),B=e.jsxs("div",{style:{width:340},children:[e.jsx("div",{style:{height:260,border:"1px solid #e5e7eb",borderRadius:8,overflow:"hidden",marginBottom:8},children:e.jsx("iframe",{src:p,title:"preview",width:"100%",height:"100%",style:{display:"block",border:0},allow:"fullscreen"})}),e.jsxs(me,{children:[e.jsx("a",{href:x,target:"_blank",rel:"noopener",children:"Open"}),e.jsx("a",{href:u,children:"Download"})]})]});return e.jsxs(me,{size:6,children:[e.jsx(Ya,{content:B,title:"Preview",trigger:"click",children:e.jsx(q,{size:"small",title:"Preview","aria-label":"Preview",children:"ðŸ”"})}),e.jsx("a",{href:u,title:"Download","aria-label":"Download",children:"â¬‡ï¸"})]})}const{Text:ha}=Xt,Qe={ts:["Timestamp","Time","Date"],name:["Customer_Name","Customer","Name"],mobile:["Mobile","Phone","Mobile Number"],branch:["Branch"],executive:["Executive"],serialNo:["Quotation No.","Quotation No","Serial","Serial No","Quote Id"],company:["Company"],model:["Model","Bike Model"],variant:["Variant"],price:["On-Road Price","On Road Price","Price"],offerings:["Offerings","Remarks","Remark","Quotation Remarks"],payload:["Payload"],status:["Status","FollowUp Status","Quotation Status"],followUpNotes:["Follow-up Notes","Follow Up Notes","Followup Notes","Notes"]},at=(l,x)=>String(x.map(u=>l[u]??"").find(u=>u!=="")||"").trim(),Da=typeof Intl<"u"?new Intl.NumberFormat("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2}):null,qt=l=>{if(l==null||Number.isNaN(Number(l)))return"â€”";const x=Number(l),u=Da?Da.format(Math.abs(x)):String(Math.abs(x));return`${x<0?"-":""}â‚¹${u}`},Bs=9,_s=11,Fs=8e3,zs=(l,x)=>{const u=Number(l||0),p=Number(x||0);return(u>0?p/u:0)>=.3?Bs:_s},Ds=(l,x,u)=>{const B=Math.max(Number(l||0)-Number(x||0),0)+Fs,_=u/12,R=zs(l,x),z=B*(R/100)*_,L=B+z;return u>0?L/u:0},$s=l=>String(l||"")==="12"?[12,18,24,36]:[24,30,36,48],Ja=(l,x,u)=>{const p=$s(u);if(!Number(l||0))return"";const B=p.map(_=>`${_}:${qt(Ds(l,x,_))}`);return B.length?`EMI(${u||"12"}): ${B.join(" | ")}`:""},Vs=({payload:l,baseOfferings:x})=>{const u=String(x||"").trim();if(!l||typeof l!="object")return u;const p=l.formValues||{},B=Array.isArray(l.extraVehicles)?l.extraVehicles:[],_=[],R=(z,L,V,d)=>{const U=Number(L||0),Z=Number(V||0);if(!(U||Z))return;const E=[];U&&E.push(`Price ${qt(U)}`),Z&&E.push(`DP ${qt(Z)}`);const G=Ja(U,Z,d||l.emiSet||"12");G&&E.push(G),_.push(`${z}: ${E.join(" | ")}`)};return R("V1",p.onRoadPrice??l.onRoadPrice,p.downPayment??l.downPayment,l.emiSet),B.forEach((z,L)=>{R(`V${L+2}`,z.onRoadPrice,z.downPayment,z.emiSet||l.emiSet)}),[u,..._].filter(Boolean).join(" â€¢ ")},$a=(l=[])=>Array.from(new Set((Array.isArray(l)?l:[]).map(x=>String(x||"").trim()).filter(Boolean))),qs=({payload:l,baseOfferings:x,fallbackText:u})=>{const p=String(x||"").trim(),B=[];if(l&&typeof l=="object"){const _=l.formValues||{},R=$a(l.fittings),z=({label:V,company:d,model:U,variant:Z,priceRaw:E,dpRaw:G,emiSetRaw:D,fittingsRaw:ie})=>{const Se=String(d||"").trim(),Y=String(U||"").trim(),J=String(Z||"").trim(),k=Number(E||0),$=Number(G||0),ye=$a(ie||R),ge=[Se,Y,J].filter(Boolean).join(" ");(ge||ye.length||k||$)&&B.push({label:V,title:ge||"Vehicle details not available",priceText:k?qt(k):"â€”",dpText:$?qt($):"â€”",emiText:k?Ja(k,$,D||l.emiSet||"12"):"",fittings:ye})};z({label:"Vehicle 1",company:_.company??l.company,model:_.bikeModel??_.model??l.model,variant:_.variant??l.variant,priceRaw:_.onRoadPrice??l.onRoadPrice,dpRaw:_.downPayment??l.downPayment,emiSetRaw:l.emiSet,fittingsRaw:l.fittings}),(Array.isArray(l.extraVehicles)?l.extraVehicles:[]).forEach((V,d)=>{z({label:`Vehicle ${d+2}`,company:V.company,model:V.model,variant:V.variant,priceRaw:V.onRoadPrice,dpRaw:V.downPayment,emiSetRaw:V.emiSet||l.emiSet,fittingsRaw:V.fittings})})}return!B.length&&u&&String(u).split("â€¢").map(R=>R.trim()).filter(Boolean).forEach(R=>{const z=R.match(/^V(\d+)\s*:\s*(.+)$/i);z&&B.push({label:`Vehicle ${z[1]}`,title:z[2],priceText:"â€”",dpText:"â€”",emiText:"",fittings:[]})}),{remarks:p,vehicles:B}};function An(){const x=!Ut.useBreakpoint().md,u=Ka(),[p,B]=o.useState([]),[_,R]=o.useState(!1),[z,L]=o.useState(!1),[V,d]=o.useState([]),[U,Z]=o.useState("all"),[E,G]=o.useState("all"),[D,ie]=o.useState("all"),[Se,Y]=o.useState(""),J=va(Se,300),[k,$]=o.useState(null),[ye,ge]=o.useState(null),[ae,Le]=o.useState(""),[de,Ae]=o.useState([]),[je,Ue]=o.useState(1),[oe,_e]=o.useState(25),[ue,Ee]=o.useState("pagination"),[ze,be]=o.useState(25),[Re,Te]=o.useState(0),K="true".toLowerCase()==="true",[c,w]=o.useState({}),[n,M]=o.useState({open:!1,refId:"",level:"ok",text:""}),[r,P]=o.useState(!1),[O,Ce]=o.useState(!1),[Oe,Ve]=o.useState([]);o.useEffect(()=>{try{const m=localStorage.getItem("user");if(!m)return;const f=JSON.parse(m);Le(String(f?.role||"").toLowerCase());const j=[],T=f?.formDefaults?.branchName||f?.primaryBranch?.name||"";T&&j.push(T),Array.isArray(f?.branches)&&f.branches.forEach(C=>{const a=typeof C=="string"?C:C?.name||"";a&&j.push(a)}),Ae(Array.from(new Set(j.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(ae)&&de.length&&U==="all"&&Z(de[0])},[ae,de,U]);const Xe=(()=>{const m=k&&k[0]?k[0].startOf("day").valueOf():"",f=k&&k[1]?k[1].endOf("day").valueOf():"";return`Quotations:list:${JSON.stringify({branchFilter:U,modeFilter:E,statusFilter:D,q:J||"",start:m,end:f,page:je,pageSize:oe,USE_SERVER_PAG:K})}`})(),gt=o.useMemo(()=>({GAS_URL:"https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",SECRET:""}),[]),qe=o.useCallback((m,f=0)=>{const j=m&&m.values?m.values:m,T=m&&m.payload?m.payload:(j?j[Qe.payload[0]]:void 0)||"";let C=null;try{C=typeof T=="object"?T:JSON.parse(String(T||"{}"))}catch{C=null}const a=C&&C.formValues?C.formValues:{},i=at(j,Qe.ts),v=String(a.createdAt||C&&(C.createdAt||C.created_at||C.createdOn||C.created_on||C.quoteCreatedAt||C.quotationCreatedAt)||j["Created At"]||j.CreatedAt||j["Quotation Created At"]||j["Quotation Created"]||j["Created Time"]||i||"").trim(),g=C&&C.mode||"",y=C&&C.followUp&&C.followUp.status||at(j,Qe.status)||"",A=C&&C.brand||"",re=a.company||at(j,Qe.company),Q=a.bikeModel||a.model||at(j,Qe.model),fe=a.variant||at(j,Qe.variant),W=String(a.onRoadPrice||at(j,Qe.price)||"").trim(),ce=String(a.remarks||C&&C.remarks||at(j,Qe.offerings)||"").trim(),Ie=Vs({payload:C,baseOfferings:ce}),we=String(C&&C.followUp&&C.followUp.notes||C&&C.closeNotes||C&&C.followupNotes||C&&C.notes||at(j,Qe.followUpNotes)||"").trim(),ve=C&&C.remark&&C.remark.level||j.RemarkLevel||j.remarkLevel||"",Ne=C&&C.remark&&C.remark.text||j.RemarkText||j.remarkText||"",$e=String(ve||"").toLowerCase();return{key:f,ts:v||i,tsMs:pa(v||i),name:a.name||at(j,Qe.name),mobile:a.mobile||at(j,Qe.mobile),branch:a.branch||at(j,Qe.branch),executive:a.executive||at(j,Qe.executive),serialNo:a.serialNo||at(j,Qe.serialNo),company:re,model:Q,variant:fe,price:W,offerings:Ie,offeringsBase:ce,payload:C,mode:g||C&&C.mode||"",brand:A,status:y,followUpNotes:we,RemarkLevel:ve||"",RemarkText:Ne||"",_remarkLevel:$e,_remarkText:Ne||""}},[]);o.useEffect(()=>{try{const m=localStorage.getItem(Xe);if(!m)return;const f=JSON.parse(m);f&&Array.isArray(f.rows)&&(B(f.rows),Te(typeof f.total=="number"?f.total:f.rows.length),Ce(!0))}catch{}},[Xe]),o.useEffect(()=>{let m=!1;return(async()=>{try{const{GAS_URL:j,SECRET:T}=gt;if(!j)return;const a=await rt({webhookUrl:j,method:"GET",payload:T?{action:"list",page:1,pageSize:5e3,secret:T}:{action:"list",page:1,pageSize:5e3}}),i=a?.data||a;if(!i||!i.ok&&!i.success)return;const g=(Array.isArray(i.data)?i.data:Array.isArray(i.rows)?i.rows:[]).map((y,A)=>qe(y,A));m||Ve(g)}catch{}})(),()=>{m=!0}},[gt,qe]),o.useEffect(()=>{let m=!1;const f=async()=>{R(!0);try{const{GAS_URL:T,SECRET:C}=gt;if(!T){S.info("Quotations: Apps Script URL not configured â€” showing empty list."),m||(B([]),Te(0));return}const a={action:"list"},i={q:J||"",branch:U!=="all"?U:"",mode:E!=="all"?E:"",status:D!=="all"?D:""};k&&k[0]&&k[1]&&(i.start=k[0].startOf("day").valueOf(),i.end=k[1].endOf("day").valueOf());const v=K?{...a,page:je,pageSize:oe,...i,...C?{secret:C}:{}}:C?{...a,secret:C}:a,g=await rt({webhookUrl:T,method:"GET",payload:v}),y=g?.data||g;if(!y||!y.ok&&!y.success)throw new Error("Invalid response");const Q=(Array.isArray(y.data)?y.data:Array.isArray(y.rows)?y.rows:[]).map((fe,W)=>qe(fe,W)).filter(fe=>fe.name||fe.mobile||fe.serialNo);if(!m){B(Q);const fe=typeof y.total=="number"?y.total:Q.length;Te(fe);const W={};Q.forEach(ce=>{ce.serialNo&&(W[ce.serialNo]={level:ce._remarkLevel||void 0,text:ce._remarkText||""})}),w(W);try{localStorage.setItem(Xe,JSON.stringify({at:Date.now(),rows:Q,total:fe}))}catch{}}}catch{S.error("Could not load quotations via Apps Script. Check QUOTATION Web App URL / access."),m||(B([]),Te(0))}finally{m||R(!1)}};f();const j=()=>f();return window.addEventListener("reload-quotations",j),()=>{m=!0,window.removeEventListener("reload-quotations",j)}},[J,U,E,D,je,oe,k,K]);const ct=Oe.length?Oe:p,It=o.useMemo(()=>{const f=["all",...St(ct.map(T=>T.branch))];if(!["owner","admin","backend"].includes(ae)&&de.length){const T=jt(de);return f.filter(C=>C==="all"||T.has(te(C)))}return f},[ct,ae,de]),Et=o.useMemo(()=>["all",...St(ct.map(m=>m.mode))],[ct]),Mt=o.useMemo(()=>{const m=ct.map(f=>f.status).filter(f=>te(f)!=="lost");return["all",...St(m)]},[ct]),bt=o.useCallback(m=>{const f=jt(de);return(m||[]).filter(T=>{const C=te(T.branch);if(f.size&&!["owner","admin","backend"].includes(ae)&&!f.has(C)||U!=="all"&&C!==te(U)||E!=="all"&&te(T.mode)!==te(E)||D!=="all"&&te(T.status)!==te(D))return!1;if(k&&k[0]&&k[1]){const a=k[0].startOf("day").valueOf(),i=k[1].endOf("day").valueOf(),v=T.tsMs??pa(T.ts);if(!v||v<a||v>i)return!1}if(J){const a=J.toLowerCase();if(![T.name,T.mobile,T.serialNo,T.company,T.model,T.variant,T.branch,T.executive,T.status,T.followUpNotes].some(i=>String(i||"").toLowerCase().includes(a)))return!1}return!0}).slice().sort((T,C)=>(C.tsMs||0)-(T.tsMs||0))},[de,U,k,J,E,D,ae]),Ge=o.useCallback(async()=>{if(!K)return p;const{GAS_URL:m,SECRET:f}=gt;if(!m)return p;const j=100,T={q:J||"",branch:U!=="all"?U:"",mode:E!=="all"?E:"",status:D!=="all"?D:""};k&&k[0]&&k[1]&&(T.start=k[0].startOf("day").valueOf(),T.end=k[1].endOf("day").valueOf());const C=[],a=new Set;let i=1,v=200;for(;i<=v;){const g={action:"list",page:i,pageSize:j},y=f?{...g,...T,secret:f}:{...g,...T},A=await rt({webhookUrl:m,method:"GET",payload:y}),re=A?.data||A;typeof re?.total=="number"&&Number.isFinite(re.total)&&(v=Math.ceil(re.total/j));const Q=Array.isArray(re?.data)?re.data:Array.isArray(re?.rows)?re.rows:[];if(!Q.length)break;let fe=0;if(Q.forEach(W=>{const Ie=String(W?.values?.["Quotation No."]||W?.values?.["Quotation No"]||W?.values?.Serial||W?.serialNo||W?.["Quotation No."]||W?.["Quotation No"]||W?.Serial||"").trim()||JSON.stringify(W);a.has(Ie)||(a.add(Ie),C.push(W),fe+=1)}),fe===0||Q.length<j)break;i+=1}return C.map((g,y)=>qe(g,y)).filter(g=>g.name||g.mobile||g.serialNo)},[K,gt,U,k,J,qe,E,p,D]),Be=o.useMemo(()=>bt(p),[bt,p]);o.useEffect(()=>{let m=!1;return(async()=>{if(!K){d(Be);return}L(!0);try{const j=await Ge(),T=bt(j);m||d(T)}catch{m||d([])}finally{m||L(!1)}})(),()=>{m=!0}},[K,Ge,bt,U,E,D,J,k,ae,de]),o.useEffect(()=>{Ue(1),be(oe)},[U,E,D,J,k]),o.useEffect(()=>{be(oe)},[oe]);const vt=async()=>{const m="export-quotations";S.loading({key:m,content:"Preparing CSVâ€¦",duration:0});try{const f=K?await Ge():p,j=bt(f);if(!j.length){S.info({key:m,content:"No rows to export for current filters"});return}const T=[{key:"ts",label:"Timestamp"},{key:"serialNo",label:"Quotation No"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"executive",label:"Executive"},{key:"mode",label:"Mode"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"price",label:"On-Road Price"},{key:"status",label:"Status"},{key:"RemarkLevel",label:"Remark Level"},{key:"RemarkText",label:"Remark"}],C=j.map(a=>({ts:a.ts,serialNo:a.serialNo,name:a.name,mobile:a.mobile,branch:a.branch,executive:a.executive,mode:a.mode,company:a.company,model:a.model,variant:a.variant,price:a.price,status:a.status,RemarkLevel:a.RemarkLevel||a._remarkLevel,RemarkText:a.RemarkText||a._remarkText}));Gt({filename:"quotations.csv",headers:T,rows:C}),S.success({key:m,content:`Exported ${C.length} quotations`})}catch{S.error({key:m,content:"Export failed. Please try again."})}},Tt=m=>{const f=String(m||"").toLowerCase();return f==="converted"||f==="booked"||f==="completed"?"green":f==="pending"?"orange":f==="not_interested"?"default":f==="unreachable"?"volcano":f==="wrong_number"?"magenta":f==="purchased_elsewhere"?"geekblue":f==="no_response"?"gold":"default"},Nt=m=>{const f=String(m||"").trim();return f?f.toLowerCase()==="converted"?"Booked":f.replace(/_/g," "):"â€”"},Ct=m=>{const f=Ze().format("DD-MM-YYYY HH:mm"),j=String(m||"").trim();return j?`${f} - ${j}`:f},dt={display:"flex",flexDirection:"column",gap:2,lineHeight:1},ut={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},mt={...ut,fontSize:8},et={...ut,fontSize:10},De={...ut,fontSize:9,lineHeight:1.1},kt={display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:x?3:4,overflow:"hidden",whiteSpace:"normal",fontSize:6,lineHeight:1},tt=[{title:"Time / Branch",key:"timeBranch",width:120,render:(m,f)=>e.jsxs("div",{style:dt,children:[e.jsx("div",{style:et,children:Gs(f.ts)}),e.jsx("div",{style:et,children:e.jsx(ha,{type:"secondary",style:{fontSize:"inherit"},children:f.branch||"â€”"})})]})},{title:"Customer / Mobile",key:"customerMobile",width:100,render:(m,f)=>e.jsxs("div",{style:dt,children:[e.jsx("div",{style:et,children:f.name||"â€”"}),e.jsx("div",{style:et,children:e.jsx(ha,{type:"secondary",style:{fontSize:"inherit"},children:f.mobile||"â€”"})})]})},{title:"Offerings",key:"offerings",width:280,render:(m,f)=>{const j=qs({payload:f.payload,baseOfferings:f.offeringsBase,fallbackText:f.offerings}),T=j.vehicles.length,C=e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,minWidth:360,maxWidth:520},children:[e.jsx("div",{style:{fontSize:13,fontWeight:800,color:"#1d4ed8"},children:T?`${T} Vehicle Offer${T>1?"s":""}`:"Offer Details"}),j.vehicles.length?j.vehicles.map(a=>e.jsxs("div",{style:{border:"1px solid #dbeafe",borderRadius:10,padding:8,background:"#f8fbff"},children:[e.jsx("div",{style:{fontSize:11,fontWeight:800,color:"#1e3a8a",textTransform:"uppercase",marginBottom:4},children:a.label}),e.jsx("div",{style:{fontSize:12,fontWeight:700,color:"#111827",marginBottom:4},children:a.title}),e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",fontSize:12,color:"#1f2937"},children:[e.jsxs("span",{children:[e.jsx("b",{children:"Price"}),": ",a.priceText]}),e.jsxs("span",{children:[e.jsx("b",{children:"DP"}),": ",a.dpText]})]}),a.emiText?e.jsx("div",{style:{marginTop:4,fontSize:11,color:"#334155",lineHeight:1.3},children:a.emiText}):null,a.fittings.length?e.jsxs("div",{style:{marginTop:4,fontSize:11,color:"#334155",lineHeight:1.3},children:[e.jsx("b",{children:"Fittings"}),": ",a.fittings.join(", ")]}):null]},a.label)):e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:"No vehicle-wise offer added."})]});return e.jsx("div",{style:dt,children:T?e.jsx(Ya,{content:C,trigger:["hover","click"],placement:"topLeft",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:4},children:j.vehicles.map(a=>e.jsxs("div",{style:{...ut,fontSize:10.5,color:"#1f2937"},children:[e.jsxs("span",{style:{fontWeight:800,color:"#1d4ed8"},children:[a.label,":"]})," ",a.title]},a.label))})}):e.jsx("div",{style:kt,children:"No offering details"})})}},{title:"Status / Follow-up Notes",key:"statusNotes",width:150,render:(m,f)=>{const j=String(f.followUpNotes||"").trim();return e.jsxs("div",{style:dt,children:[e.jsx("div",{style:ut,children:e.jsx(he,{color:Tt(f.status),children:Nt(f.status)})}),j?e.jsx(Rt,{title:e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:j}),placement:"topLeft",children:e.jsx("div",{style:mt,children:j})}):e.jsx("div",{style:mt})]})}},{title:"Mode / Executive",key:"vehicleMeta",width:120,render:(m,f)=>{const j=String(f.mode||"").trim().toUpperCase(),C=[String(f.executive||"").trim()||"â€”"].join(" || ");return e.jsxs("div",{style:dt,children:[e.jsx("div",{style:{...De,fontSize:10,fontWeight:700},children:j||"â€”"}),e.jsx("div",{style:De,children:C})]})}}];["backend","admin","owner"].includes(ae)&&tt.push({title:"Remarks / Remark Text",key:"remarks",width:240,render:(m,f)=>{const j=c[f.serialNo],T=String(j?.text||""),C=j?.level==="alert"?"red":j?.level==="warning"?"gold":j?.level==="ok"?"green":"default";return e.jsxs("div",{style:dt,children:[e.jsx("div",{style:ut,children:e.jsxs(me,{size:6,children:[e.jsx(he,{color:C,children:j?.level?j.level.toUpperCase():"â€”"}),e.jsx(q,{size:"small",onClick:()=>M({open:!0,refId:f.serialNo,level:j?.level||"ok",text:j?.text||""}),children:"Remark"})]})}),e.jsx(Rt,{title:T?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:T}):null,children:e.jsx("div",{style:ut,children:T||"â€”"})})]})}});const Ke=K?Re:p.length,Fe=x?420:600,ht=K?Be:ue==="loadMore"?Be.slice(0,ze):Be,Lt=o.useMemo(()=>{const m=(K?V:Be)||[],f=new Map;return m.forEach(j=>{const T=String(j.branch||"Unknown").trim()||"Unknown",C=te(T);f.has(C)||f.set(C,{key:C,branch:T,total:0});const a=f.get(C);a.total+=1}),Array.from(f.values()).sort((j,T)=>T.total-j.total)},[K,V,Be]);return e.jsxs("div",{style:{paddingTop:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxs(me,{wrap:!0,children:[e.jsx(pe,{value:U,onChange:Z,style:{minWidth:120},disabled:!["owner","admin","backend"].includes(ae),options:It.map(m=>({value:m,label:m==="all"?"All Branches":m}))}),e.jsx(pe,{value:E,onChange:G,style:{minWidth:100},options:Et.map(m=>({value:m,label:m==="all"?"All Modes":String(m).toUpperCase()}))}),e.jsx(pe,{value:D,onChange:ie,style:{minWidth:100},options:Mt.map(m=>({value:m,label:m==="all"?"All Statuses":Nt(m)}))}),e.jsx(ga.RangePicker,{value:k,onChange:m=>{$(m),ge(null)},allowClear:!0}),e.jsx(q,{size:"small",type:ye==="today"?"primary":"default",onClick:()=>{const m=Ze();$([m,m]),ge("today")},children:"Today"}),e.jsx(q,{size:"small",type:ye==="yesterday"?"primary":"default",onClick:()=>{const m=Ze().subtract(1,"day");$([m,m]),ge("yesterday")},children:"Yesterday"}),e.jsx(q,{size:"small",onClick:()=>{$(null),ge(null)},children:"Clear"}),e.jsx(ee,{placeholder:"Search name/mobile/quotation/company/model",allowClear:!0,value:Se,onChange:m=>Y(m.target.value),style:{minWidth:150}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(me,{children:[e.jsx(q,{type:"primary",onClick:()=>u("/quotation"),children:"Quotation"}),e.jsxs(he,{color:"blue",children:["Total: ",Ke]}),e.jsxs(he,{color:"geekblue",children:["Showing: ",K||ue==="loadMore"?ht.length:Be.length]}),!K&&e.jsx(pe,{size:"small",value:ue,onChange:m=>{Ee(m),be(oe)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(q,{onClick:vt,children:"Export CSV"}),e.jsx(q,{loading:_,onClick:()=>{const m=new Event("reload-quotations");window.dispatchEvent(m)},children:"Refresh"})]})]}),e.jsxs(Ot,{gutter:[12,12],style:{marginBottom:12},children:[z?e.jsx(ne,{xs:24,children:e.jsx(he,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,Lt.map(m=>e.jsx(ne,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ba,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:m.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:m.total})]})})},m.key))]}),e.jsx(Bt,{dataSource:ht,columns:tt,loading:_&&!O,size:"small",className:"compact-table",scroll:x?{x:"max-content",y:Fe}:{y:Fe},tableLayout:x?"auto":"fixed",pagination:K?{current:je,pageSize:oe,total:Ke,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(m,f)=>{Ue(m),f!==oe&&_e(f)},showTotal:(m,f)=>`${f[0]}-${f[1]} of ${m}`}:ue==="pagination"?{current:je,pageSize:oe,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(m,f)=>{Ue(m),f!==oe&&_e(f)},showTotal:(m,f)=>`${f[0]}-${f[1]} of ${m}`}:!1,rowKey:m=>`${m.serialNo}-${m.mobile}-${m.ts}-${m.key}`}),!K&&ue==="loadMore"&&ht.length<Be.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(q,{onClick:()=>be(m=>Math.min(m+oe,Be.length)),children:["Load more (",Be.length-ht.length," more)"]})}):null,e.jsx(it,{open:n.open,title:`Update Remark: ${n.refId}`,onCancel:()=>r?null:M({open:!1,refId:"",level:"ok",text:""}),confirmLoading:r,maskClosable:!r,keyboard:!r,closable:!r,cancelButtonProps:{disabled:r},onOk:async()=>{if(!r){P(!0);try{const m=Ct(n.text),f=qa?{action:"remark",serialNo:n.refId,level:n.level,text:m,secret:qa}:{action:"remark",serialNo:n.refId,level:n.level,text:m},j=await rt({webhookUrl:Va,method:"POST",payload:f});j&&(j.ok||j.success)?(w(T=>({...T,[n.refId]:{level:n.level,text:m}})),B(T=>T.map(C=>C.serialNo===n.refId?{...C,RemarkLevel:n.level.toUpperCase(),RemarkText:m,_remarkLevel:n.level,_remarkText:m}:C)),S.success("Remark saved to sheet"),M({open:!1,refId:"",level:"ok",text:""})):S.error("Save failed")}catch{S.error("Save failed")}finally{P(!1)}}},children:e.jsxs(me,{direction:"vertical",style:{width:"100%"},children:[e.jsx(pe,{value:n.level,onChange:m=>M(f=>({...f,level:m})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(ee,{maxLength:140,showCount:!0,value:n.text,onChange:m=>M(f=>({...f,text:m.target.value})),placeholder:"Short note (optional)"})]})})]})}function Gs(l){if(!l)return e.jsx(ha,{type:"secondary",children:"â€”"});try{const x=pa(l);return x?Ze(x).format("DD-MM-YYYY HH:mm"):String(l)}catch{return String(l)}}function pa(l){if(!l)return null;if(l instanceof Date)return l.getTime();if(typeof l=="number")return l;const x=String(l).trim(),u=new Date(x);if(!isNaN(u.getTime()))return u.getTime();const p=x.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(p){const B=p[2];let _=parseInt(p[1],10),R=parseInt(p[3],10),z=parseInt(p[4],10);z<100&&(z+=2e3);let L,V;B==="-"||_>12?(V=_,L=R-1):(L=_-1,V=R);let d=p[5]?parseInt(p[5],10):0;const U=p[6]?parseInt(p[6],10):0,Z=p[7]?parseInt(p[7],10):0,E=(p[8]||"").toUpperCase();E==="PM"&&d<12&&(d+=12),E==="AM"&&d===12&&(d=0);const G=new Date(z,L,V,d,U,Z);if(!isNaN(G.getTime()))return G.getTime()}return null}const Ks="https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",Va=Ks,qa="",Ws="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",wt=Ws,yt="",{Text:fa}=Xt,st={ts:["Timestamp","Time","Date"],name:["Customer Name","Customer","Name","Customer_Name"],mobile:["Mobile","Phone","Mobile Number"],branch:["Branch"],executive:["Executive"],jcNo:["JC No.","JC No","Job Card No","JobCard No","JCNumber"],regNo:["Vehicle No","Vehicle_No","Registration Number","RegNo","Reg No"],model:["Model","Bike Model"],serviceType:["Service Type","Service","Service_Type"],vehicleType:["Vehicle Type","Type of Vehicle","Vehicle_Type"],amount:["Service Amount","Collected Amount","Collected_Amount","Amount"],paymentMode:["Payment Mode","Mode of Payment","Payment_Mode","paymentMode"],payload:["Payload"]},lt=(l,x)=>String(x.map(u=>l?.[u]??"").find(u=>u!=="")||"").trim();function Rn(){const x=!Ut.useBreakpoint().md,u=Ka(),[p,B]=o.useState([]),[_,R]=o.useState(!1),[z,L]=o.useState(!1),[V,d]=o.useState([]),[U,Z]=o.useState("all"),[E,G]=o.useState("all"),[D,ie]=o.useState("all"),[Se,Y]=o.useState(""),J=va(Se,300),[k,$]=o.useState(null),[ye,ge]=o.useState(null),[ae,Le]=o.useState(""),[de,Ae]=o.useState([]),[je,Ue]=o.useState(1),[oe,_e]=o.useState(25),[ue,Ee]=o.useState("pagination"),[ze,be]=o.useState(25),[Re,Te]=o.useState(0),K="true".toLowerCase()==="true",[c,w]=o.useState({}),[n,M]=o.useState({open:!1,refId:"",level:"ok",text:""}),[r,P]=o.useState(!1),[O,Ce]=o.useState(!1),[Oe,Ve]=o.useState([]),Xe=o.useRef(null),[gt,qe]=o.useState(!1),[ct,It]=o.useState(null),[Et,Mt]=o.useState(null),bt=a=>{if(!a)return;const i=String(a?.mobile||"").replace(/\D/g,"").slice(-10),v=String(a?.jcNo||a?.serialNo||"").trim(),g=new URLSearchParams;g.set("autoFetch","1"),i?(g.set("mode","mobile"),g.set("query",i)):v&&(g.set("mode","jc"),g.set("query",v)),v&&g.set("jcNo",v);const y=g.toString();u(y?`/jobcard?${y}`:"/jobcard")};o.useEffect(()=>{try{const a=localStorage.getItem("user");if(!a)return;const i=JSON.parse(a);Le(String(i?.role||"").toLowerCase());const v=[],g=i?.formDefaults?.branchName||i?.primaryBranch?.name||"";g&&v.push(g),Array.isArray(i?.branches)&&i.branches.forEach(y=>{const A=typeof y=="string"?y:y?.name||"";A&&v.push(A)}),Ae(Array.from(new Set(v.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(ae)&&de.length&&U==="all"&&Z(de[0])},[ae,de,U]);const Ge=(()=>{const a=k&&k[0]?k[0].startOf("day").valueOf():"",i=k&&k[1]?k[1].endOf("day").valueOf():"";return`Jobcards:list:${JSON.stringify({branchFilter:U,serviceFilter:E,statusFilter:D,q:J||"",start:a,end:i,page:je,pageSize:oe,USE_SERVER_PAG:K})}`})(),Be=o.useCallback((a,i=0)=>{const v=a&&a.values?a.values:a,g=a&&a.payload?a.payload:(v?v[st.payload[0]]:void 0)||"";let y=null;try{y=typeof g=="object"?g:JSON.parse(String(g||"{}"))}catch{y=null}const A=y&&y.formValues?y.formValues:{},re=A.company||"",Q=A.model||lt(v,st.model),fe=A.regNo||lt(v,st.regNo),W=(()=>{const ot=y?.totals?.grand;return ot!=null&&ot!==""?String(ot):String(lt(v,st.amount)||"")})(),ce=(()=>{const ot=lt(v,st.paymentMode);return String(ot||y?.paymentMode||"")})(),Ie=y&&y.postServiceAt||v&&(v.Post_Service_At||v["Post Service At"])||"",we=(()=>{const ot=String(Ie||"").trim().length>0,ea=Array.isArray(y?.payments)&&y.payments.some(_t=>Number(_t?.amount||0)>0);if(ot||ea)return"completed";const ta=String(ce||"").trim().length>0,Kt=String(W||"").trim().length>0;return ta&&Kt?"completed":"pending"})(),ve=y?.remark?.level||v?.RemarkLevel||v?.["Remark Level"]||"",Ne=y?.remark?.text||v?.RemarkText||v?.["Remark Text"]||"",$e=String(ve||"").toLowerCase(),nt=A.serviceType||A.service||lt(v,st.serviceType),pt=y?.savedAt||y?.createdAt||y?.ts||y?.timestamp||A?.savedAt||A?.createdAt||A?.timestamp||lt(v,st.ts);return{key:i,ts:pt,tsMs:ya(pt),name:A.name||lt(v,st.name),mobile:A.mobile||lt(v,st.mobile),branch:A.branch||lt(v,st.branch),executive:A.executive||lt(v,st.executive),jcNo:A.jcNo||lt(v,st.jcNo),regNo:fe,model:Q,company:re,serviceType:nt||"",vehicleType:A.vehicleType||lt(v,st.vehicleType),amount:W,paymentMode:ce,postAt:Ie,status:we,RemarkLevel:ve||"",RemarkText:Ne||"",_remarkLevel:$e,_remarkText:Ne||"",payload:y,_raw:a}},[]),vt=a=>{if(!a)return null;if(a.payload&&typeof a.payload=="object")return a.payload;const i=a.payload||a.Payload||a.PAYLOAD||a?.values?.Payload||a?.values?.payload||a?.values?.PAYLOAD||a?._raw?.payload||a?._raw?.Payload||a?._raw?.PAYLOAD||a?._raw?.values?.Payload||a?._raw?.values?.payload||a?._raw?.values?.PAYLOAD||"";if(i&&typeof i=="object")return i;if(i&&typeof i=="string")try{return JSON.parse(i)}catch{return null}return a.formValues||a.values?a:null},Tt=(a,i)=>{if(!a)return null;const v=a.formValues||a.values||{},g=Array.isArray(a.labourRows)?a.labourRows:Array.isArray(v.labourRows)?v.labourRows:[],y=a.totals||v.totals||{},A=g.reduce((fe,W)=>fe+Number(W?.qty||0)*Number(W?.rate||0),0),re={labourSub:y.labourSub??A,labourGST:y.labourGST??0,labourDisc:y.labourDisc??0,grand:y.grand??A},Q=a.postServiceAt||a.createdAt||a.savedAt||i?.postAt||i?.ts||new Date;return{vals:{jcNo:i?.jcNo||v.jcNo||"",regNo:i?.regNo||v.regNo||"",custName:i?.name||v.custName||v.name||"",custMobile:i?.mobile||v.custMobile||v.mobile||"",km:v.km||"",model:i?.model||v.model||"",colour:v.colour||i?.colour||"",branch:i?.branch||v.branch||"",executive:i?.executive||v.executive||"",createdAt:Q,labourRows:g,gstLabour:y.gstLabour||y.labourGST||0},totals:re}},Nt=async a=>{if(!a)return;if(String(a.status||"").toLowerCase()!=="completed"){S.warning("Complete post-service to generate the service invoice.");return}const v=a.jcNo||a.key||a.mobile||"";Mt(v);try{let g=vt(a),y=g?Tt(g,a):null;const A=Array.isArray(y?.vals?.labourRows)&&y.vals.labourRows.length>0;if(!y||!A){const re=String(a.mobile||"").replace(/\D/g,"").slice(-10);if(re.length===10){const Q={action:"search",mode:"mobile",query:re},fe=yt?{...Q,secret:yt}:Q,W=await Dt({webhookUrl:wt,method:"GET",payload:fe}),ce=W?.data||W,Ie=Array.isArray(ce?.rows)?ce.rows:Array.isArray(ce?.data)?ce.data:[];if(Ie.length){let we=Ie[0];if(a.jcNo){const Ne=Ie.find($e=>{const nt=vt($e),ot=(nt?.formValues||nt?.values||{}).jcNo||$e?.jcNo||$e?.values?.["JC No"]||$e?.values?.["JC No."]||$e?.values?.["Job Card No"]||"";return String(ot||"").trim()===String(a.jcNo||"").trim()});Ne&&(we=Ne)}const ve=vt(we);y=ve?Tt(ve,a):y}}}if(!y){S.error("Could not load service invoice data.");return}It(y),qe(!0),setTimeout(()=>{try{Is(Xe.current)}catch{}setTimeout(()=>qe(!1),500)},50)}catch{S.error("Could not generate service invoice.")}finally{Mt(null)}};o.useEffect(()=>{try{const a=localStorage.getItem(Ge);if(!a){Ce(!1);return}const i=JSON.parse(a);i&&Array.isArray(i.rows)?(B(i.rows),Te(typeof i.total=="number"?i.total:i.rows.length),Ce(!0)):Ce(!1)}catch{Ce(!1)}},[Ge]),o.useEffect(()=>{let a=!1;const i=async()=>{R(!0);try{const g={action:"list"},y={q:J||"",branch:U!=="all"?U:"",service:E!=="all"?E:"",status:D!=="all"?D:""};k&&k[0]&&k[1]&&(y.start=k[0].startOf("day").valueOf(),y.end=k[1].endOf("day").valueOf());const A=K?yt?{...g,page:je,pageSize:oe,...y,secret:yt}:{...g,page:je,pageSize:oe,...y}:yt?{...g,secret:yt}:g,re=await Dt({webhookUrl:wt,method:"GET",payload:A}),Q=re?.data||re;if(!Q||!Q.ok&&!Q.success)throw new Error("Invalid response");const Ie=(Array.isArray(Q.data)?Q.data:Array.isArray(Q.rows)?Q.rows:[]).map((we,ve)=>Be(we,ve)).filter(we=>we.jcNo||we.name||we.mobile).slice().sort((we,ve)=>(ve.tsMs||0)-(we.tsMs||0));if(!a){B(Ie);const we=typeof Q.total=="number"?Q.total:Ie.length;Te(we);const ve={};Ie.forEach(Ne=>{if(!Ne.jcNo)return;const $e=(typeof Ne._remarkLevel<"u"?Ne._remarkLevel:Ne.remarkLevel)??String(Ne.RemarkLevel||"").toLowerCase(),nt=(typeof Ne._remarkText<"u"?Ne._remarkText:Ne.remarkText)??Ne.RemarkText??"";ve[Ne.jcNo]={level:$e||"",text:nt||""}}),w(ve);try{localStorage.setItem(Ge,JSON.stringify({at:Date.now(),rows:Ie,total:we}))}catch{}}}catch{S.error("Could not load job cards via Apps Script. Check JOBCARD Web App URL / access."),a||(B([]),Te(0))}finally{a||R(!1)}};i();const v=()=>i();return window.addEventListener("reload-jobcards",v),()=>{a=!0,window.removeEventListener("reload-jobcards",v)}},[U,E,D,J,k,je,oe,K]);const Ct=Oe.length?Oe:p,dt=o.useMemo(()=>{const a=St(Ct.map(v=>v.branch));if(!["owner","admin"].includes(ae)&&de.length){const v=jt(de);return["all",...a.filter(g=>v.has(te(g)))]}return["all",...a]},[Ct,ae,de]),ut=o.useMemo(()=>["all",...St(Ct.map(a=>a.serviceType))],[Ct]),mt=o.useCallback(a=>{const i=jt(de);return(a||[]).filter(g=>{if(i.size&&!["owner","admin","backend"].includes(ae)&&!i.has(te(g.branch))||U!=="all"&&te(g.branch)!==te(U)||E!=="all"&&te(g.serviceType)!==te(E)||D!=="all"&&te(g.status)!==te(D))return!1;if(k&&k[0]&&k[1]){const y=k[0].startOf("day").valueOf(),A=k[1].endOf("day").valueOf(),re=g.tsMs??ya(g.ts);if(!re||re<y||re>A)return!1}if(J){const y=J.toLowerCase();if(![g.name,g.mobile,g.jcNo,g.regNo,g.model,g.branch,g.executive,g.paymentMode,g.status].some(A=>String(A||"").toLowerCase().includes(y)))return!1}return!0}).slice().sort((g,y)=>(y.tsMs||0)-(g.tsMs||0))},[de,U,k,J,E,D,ae]),et=o.useCallback(async()=>{if(!K)return p;const a=100,i={q:J||"",branch:U!=="all"?U:"",service:E!=="all"?E:"",status:D!=="all"?D:""};k&&k[0]&&k[1]&&(i.start=k[0].startOf("day").valueOf(),i.end=k[1].endOf("day").valueOf());const v=[],g=new Set;let y=1,A=200,re=null;for(;y<=A;){const fe={...{action:"list",page:y,pageSize:a},...i},W=await Dt({webhookUrl:wt,method:"GET",payload:fe}),ce=W?.data||W;typeof ce?.total=="number"&&Number.isFinite(ce.total)&&(re=ce.total,A=Math.ceil(ce.total/a));const Ie=Array.isArray(ce?.data)?ce.data:Array.isArray(ce?.rows)?ce.rows:[];if(!Ie.length)break;let we=0;if(Ie.forEach(ve=>{const $e=String(ve?.values?.["JC No"]||ve?.values?.["JC No."]||ve?.values?.["Job Card No"]||ve?.jcNo||ve?.JCNo||ve?.["JC No"]||ve?.["JC No."]||"").trim()||JSON.stringify(ve);g.has($e)||(g.add($e),v.push(ve),we+=1)}),re!==null&&g.size>=re||we===0||Ie.length<a)break;y+=1}return v.map((Q,fe)=>Be(Q,fe)).filter(Q=>Q.jcNo||Q.name||Q.mobile)},[K,wt,yt,U,k,J,Be,p,E,D]),De=o.useMemo(()=>K?p:mt(p),[K,mt,p]);o.useEffect(()=>{let a=!1;return(async()=>{if(!K){d(mt(p));return}L(!0);try{const v=await et(),g=mt(v);a||d(g)}catch{a||d([])}finally{a||L(!1)}})(),()=>{a=!0}},[K,et,mt,U,E,D,J,k,ae,de,p]),o.useEffect(()=>{Ue(1),be(oe)},[U,E,D,J,k]),o.useEffect(()=>{be(oe)},[oe]);const kt=async()=>{const a="export-jobcards";S.loading({key:a,content:"Preparing CSVâ€¦",duration:0});try{const i=K?await et():p,v=K?i:mt(i);if(!v.length){S.info({key:a,content:"No rows to export for current filters"});return}const g=[{key:"ts",label:"Timestamp"},{key:"jcNo",label:"Job Card No"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"serviceType",label:"Service Type"},{key:"vehicleType",label:"Vehicle Type"},{key:"regNo",label:"Vehicle No"},{key:"model",label:"Model"},{key:"company",label:"Company"},{key:"amount",label:"Service Amount"},{key:"paymentMode",label:"Payment Mode"},{key:"status",label:"Status"},{key:"RemarkLevel",label:"Remark Level"},{key:"RemarkText",label:"Remark"}],y=v.map(A=>({ts:A.ts,jcNo:A.jcNo,name:A.name,mobile:A.mobile,branch:A.branch,serviceType:A.serviceType,vehicleType:A.vehicleType,regNo:A.regNo,model:A.model,company:A.company,amount:A.amount,paymentMode:A.paymentMode,status:A.status,RemarkLevel:A.RemarkLevel||A._remarkLevel,RemarkText:A.RemarkText||A._remarkText}));Gt({filename:"jobcards.csv",headers:g,rows:y}),S.success({key:a,content:`Exported ${y.length} job cards`})}catch{S.error({key:a,content:"Export failed. Please try again."})}};o.useEffect(()=>{let a=!1;return(async()=>{try{const g=await Dt({webhookUrl:wt,method:"GET",payload:yt?{action:"list",page:1,pageSize:5e3,secret:yt}:{action:"list",page:1,pageSize:5e3}}),y=g?.data||g;if(!y||!y.ok&&!y.success)return;const re=(Array.isArray(y.data)?y.data:Array.isArray(y.rows)?y.rows:[]).map((Q,fe)=>Be(Q,fe));a||Ve(re)}catch{}})(),()=>{a=!0}},[]);const tt={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},Ke={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},Fe=a=>{const i=String(a||"").toLowerCase();return i==="completed"?"green":i==="pending"?"orange":"default"},ht=a=>{const i=String(a||"").toLowerCase();return i==="completed"?"Completed":i==="pending"?"Pending":String(a||"â€”")||"â€”"},Lt=a=>{const i=Ze().format("DD-MM-YYYY HH:mm"),v=String(a||"").trim();return v?`${i} - ${v}`:i},m=[{title:"Time / Branch",key:"timeBranch",width:90,render:(a,i)=>e.jsxs("div",{style:tt,children:[e.jsx("div",{style:Ke,children:Hs(i.ts)}),e.jsx("div",{style:Ke,children:e.jsx(fa,{type:"secondary",children:i.branch||"â€”"})})]})},{title:"Customer / Mobile",key:"customerMobile",width:100,render:(a,i)=>e.jsxs("div",{style:tt,children:[e.jsx("div",{style:Ke,children:i.name||"â€”"}),e.jsx("div",{style:Ke,children:e.jsx(fa,{type:"secondary",children:i.mobile||"â€”"})})]})},{title:"Service / Status",key:"serviceStatus",width:200,render:(a,i)=>{const v=String(i.company||"").trim()||"â€”",g=String(i.model||"").trim()||"â€”",y=String(i.serviceType||"").trim()||"â€”",A=String(i.amount||"").trim()||"â€”",re=String(i.paymentMode||"").trim(),Q=`${v} || ${g} || ${y} || ${A} || ${re?re.toUpperCase():"â€”"}`,fe=String(i.executive||"").trim()||"â€”",W=String(i.regNo||"").trim()||"â€”";return e.jsxs("div",{style:tt,children:[e.jsx("div",{style:Ke,children:Q}),e.jsx("div",{style:Ke,children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:4},children:[e.jsx(he,{color:Fe(i.status),children:ht(i.status)}),e.jsx("span",{children:`|| ${fe} || ${W}`})]})})]})}}];["backend","admin","owner"].includes(ae)&&m.push({title:"Remarks / Remark Text",key:"remarks",width:250,render:(a,i)=>{const v=c[i.jcNo],g=String(v?.text||""),y=String(v?.level||"").toLowerCase(),A=y==="alert"?"red":y==="warning"?"gold":y==="ok"?"green":"default",re=g||"No remark yet",Q=String(i.status||"").toLowerCase(),fe=Q==="completed",W=Q==="pending",ce=Et===(i.jcNo||i.key||i.mobile||"");return e.jsxs("div",{style:tt,children:[e.jsx("div",{style:Ke,children:e.jsxs(me,{size:6,children:[e.jsx(Rt,{title:re,children:e.jsx(he,{color:A,children:y?y.toUpperCase():"â€”"})}),e.jsx(q,{size:"small",onClick:()=>M({open:!0,refId:i.jcNo,level:v?.level||"ok",text:v?.text||""}),children:"Remark"}),fe?e.jsx(Rt,{title:"Print service invoice",children:e.jsx(q,{size:"small",type:"primary",ghost:!0,loading:ce,onClick:()=>Nt(i),children:"Service Invoice"})}):e.jsx(Rt,{title:W?"Post service":"Service not completed",children:e.jsx(q,{size:"small",type:"primary",onClick:()=>bt(i),children:"Post Service"})})]})}),e.jsx(Rt,{title:g?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:g}):null,children:e.jsx("div",{style:Ke,children:g||"â€”"})})]})}});const f=K?Re:p.length,j=x?420:600,T=K?De:ue==="loadMore"?De.slice(0,ze):De,C=o.useMemo(()=>{const a=(K?V:De)||[],i=new Map;return a.forEach(v=>{const g=String(v.branch||"Unknown").trim()||"Unknown",y=te(g);i.has(y)||i.set(y,{key:y,branch:g,total:0});const A=i.get(y);A.total+=1}),Array.from(i.values()).sort((v,g)=>g.total-v.total)},[K,V,De]);return e.jsxs("div",{style:{paddingTop:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxs(me,{wrap:!0,children:[e.jsx(pe,{value:U,onChange:Z,style:{minWidth:120},disabled:!["owner","admin","backend"].includes(ae),options:dt.map(a=>({value:a,label:a==="all"?"All Branches":a}))}),e.jsx(pe,{value:E,onChange:G,style:{minWidth:100},options:ut.map(a=>({value:a,label:a==="all"?"All Services":String(a).toUpperCase()}))}),e.jsx(pe,{value:D,onChange:ie,style:{minWidth:100},options:[{value:"all",label:"All Statuses"},{value:"pending",label:"Pending"},{value:"completed",label:"Completed"}]}),e.jsx(ga.RangePicker,{value:k,onChange:a=>{$(a),ge(null)},allowClear:!0}),e.jsx(q,{size:"small",type:ye==="today"?"primary":"default",onClick:()=>{const a=Ze();$([a,a]),ge("today")},children:"Today"}),e.jsx(q,{size:"small",type:ye==="yesterday"?"primary":"default",onClick:()=>{const a=Ze().subtract(1,"day");$([a,a]),ge("yesterday")},children:"Yesterday"}),e.jsx(q,{size:"small",onClick:()=>{$(null),ge(null)},children:"Clear"}),e.jsx(ee,{placeholder:"Search name/mobile/jc/vehicle/model/mode",allowClear:!0,value:Se,onChange:a=>Y(a.target.value),style:{minWidth:120}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(me,{children:[e.jsx(q,{type:"primary",onClick:()=>u("/jobcard"),children:"Job Card"}),e.jsxs(he,{color:"blue",children:["Total: ",f]}),e.jsxs(he,{color:"geekblue",children:["Showing: ",K||ue==="loadMore"?T.length:De.length]}),!K&&e.jsx(pe,{size:"small",value:ue,onChange:a=>{Ee(a),be(oe)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(q,{onClick:kt,children:"Export CSV"}),e.jsx(q,{loading:_,onClick:()=>{const a=new Event("reload-jobcards");window.dispatchEvent(a)},children:"Refresh"})]})]}),e.jsxs(Ot,{gutter:[12,12],style:{marginBottom:12},children:[z?e.jsx(ne,{xs:24,children:e.jsx(he,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,C.map(a=>e.jsx(ne,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ba,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:a.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:a.total})]})})},a.key))]}),e.jsx(Bt,{dataSource:T,columns:m,loading:_&&!O,size:"small",className:"compact-table",tableLayout:x?"auto":"fixed",pagination:K?{current:je,pageSize:oe,total:f,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(a,i)=>{Ue(a),i!==oe&&_e(i)},showTotal:(a,i)=>`${i[0]}-${i[1]} of ${a}`}:ue==="pagination"?{current:je,pageSize:oe,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(a,i)=>{Ue(a),i!==oe&&_e(i)},showTotal:(a,i)=>`${i[0]}-${i[1]} of ${a}`}:!1,rowKey:a=>`${a.jcNo}-${a.mobile}-${a.ts}-${a.key}`,scroll:x?{x:"max-content",y:j}:{y:j}}),!K&&ue==="loadMore"&&T.length<De.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(q,{onClick:()=>be(a=>Math.min(a+oe,De.length)),children:["Load more (",De.length-T.length," more)"]})}):null,e.jsx(it,{open:n.open,title:`Update Remark: ${n.refId}`,confirmLoading:r,maskClosable:!r,keyboard:!r,closable:!r,cancelButtonProps:{disabled:r},onCancel:()=>{r||(M({open:!1,refId:"",level:"ok",text:""}),P(!1))},onOk:async()=>{P(!0);try{const a=Lt(n.text),i=yt?{action:"remark",jcNo:n.refId,level:n.level,text:a,secret:yt}:{action:"remark",jcNo:n.refId,level:n.level,text:a},v=await Dt({webhookUrl:wt,method:"POST",payload:i});v&&(v.ok||v.success)?(w(g=>({...g,[n.refId]:{level:n.level,text:a}})),B(g=>g.map(y=>y.jcNo===n.refId?{...y,RemarkLevel:n.level.toUpperCase(),RemarkText:a,_remarkLevel:n.level,_remarkText:a}:y)),S.success("Remark saved to sheet"),M({open:!1,refId:"",level:"ok",text:""})):S.error("Save failed")}catch{S.error("Save failed")}finally{P(!1)}},children:e.jsxs(me,{direction:"vertical",style:{width:"100%"},children:[e.jsx(pe,{value:n.level,onChange:a=>M(i=>({...i,level:a})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(ee,{maxLength:140,showCount:!0,value:n.text,onChange:a=>M(i=>({...i,text:a.target.value})),placeholder:"Short note (optional)"})]})}),e.jsx(Rs,{ref:Xe,active:gt,vals:ct?.vals||{},totals:ct?.totals||{}})]})}function Hs(l){if(!l)return e.jsx(fa,{type:"secondary",children:"â€”"});try{const x=ya(l);return x?Ze(x).format("DD-MM-YYYY HH:mm"):String(l)}catch{return String(l)}}function ya(l){if(!l)return null;if(l instanceof Date)return l.getTime();if(typeof l=="number")return l;const x=String(l).trim(),u=new Date(x);if(!isNaN(u.getTime()))return u.getTime();const p=x.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(p){const B=p[2];let _=parseInt(p[1],10),R=parseInt(p[3],10),z=parseInt(p[4],10);z<100&&(z+=2e3);let L,V;B==="-"||_>12?(V=_,L=R-1):(L=_-1,V=R);let d=p[5]?parseInt(p[5],10):0;const U=p[6]?parseInt(p[6],10):0,Z=p[7]?parseInt(p[7],10):0,E=(p[8]||"").toUpperCase();E==="PM"&&d<12&&(d+=12),E==="AM"&&d===12&&(d=0);const G=new Date(z,L,V,d,U,Z);if(!isNaN(G.getTime()))return G.getTime()}return null}const{Text:Qt}=Xt,$t={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"],color:["Color","Colours","Colors","Colour","Available Colors"],price:["On-Road Price","On Road Price","OnRoadPrice","Price"]},Ys=l=>{const x=[];let u=[],p="",B=!1;for(let _=0;_<l.length;_++){const R=l[_],z=l[_+1];if(R==='"'&&!B){B=!0;continue}if(R==='"'&&B){if(z==='"'){p+='"',_++;continue}B=!1;continue}if(R===","&&!B){u.push(p),p="";continue}if((R===`
`||R==="\r")&&!B){(p!==""||u.length)&&(u.push(p),x.push(u),u=[],p=""),R==="\r"&&z===`
`&&_++;continue}p+=R}return(p!==""||u.length)&&(u.push(p),x.push(u)),x},Js=async l=>{const x=await fetch(l,{cache:"no-store"});if(!x.ok)throw new Error("Sheet fetch failed");const u=await x.text();if(u.trim().startsWith("<"))throw new Error("Expected CSV, got HTML");const p=Ys(u);if(!p.length)return[];const B=p[0].map(_=>(_||"").trim());return p.slice(1).map(_=>{const R={};return B.forEach((z,L)=>R[z]=_[L]??""),R})},Vt=(l,x)=>String(x.map(u=>l[u]??"").find(u=>u!=="")||"").trim(),Qs=(l,x,u)=>{const p=B=>String(B||"").trim().toUpperCase();return[p(l),p(x),p(u)].join("|")},Ga=(l={})=>{const x=Vt(l,$t.price)||l.onRoadPrice||l.OnRoadPrice||l.onroadprice||l.price||0,u=Vt(l,$t.color)||l.color||l.colors||"",p=k=>Number(String(k||0).replace(/[",\sâ‚¹]/g,""))||0,B=k=>{const $=String(k||"").replace(/[",\sâ‚¹]/g,"");return $!==""&&!Number.isNaN(Number($))},_=Vt(l,$t.company)||l.company||"",R=Vt(l,$t.model)||l.model||"",z=Vt(l,$t.variant)||l.variant||"";let L=p(x),V=String(u||"").trim();const d=l.key||l.Key||"",U=l.UpdatedAt||l.updatedAt||l.updated_at||l.updated||"",Z=l.UpdatedBy||l.updatedBy||l.updated_by||l.user||"",E=k=>{const $=new Date(k);return!Number.isNaN($.getTime())},G=k=>String(k||"").includes("|"),D=Qs(_,R,z);let ie=U,Se=Z,Y=d||D;return(!G(Y)||Y==="")&&(Y=D),!B(x)&&B(u)&&L===0&&(L=p(u),V="",G(x)&&(Y=x),!Z&&E(d)&&(ie=d,Se=U)),{id:l.id||l._id||l.rowId||l._row||void 0,company:_,model:R,variant:z,color:V,onRoadPrice:L,updatedAt:ie,updatedBy:Se,key:Y}};function In({csvFallbackUrl:l}){const u=!Ut.useBreakpoint().md,p="https://script.google.com/macros/s/AKfycbw0zvptYU-X0yBRFytBJZeli0Dr-uOBFDSfpYgQeWv7nKMWXD73piVndyyTiARU0FL-Lg/exec",[B,_]=o.useState([]),[R,z]=o.useState(!1),[L,V]=o.useState(!1),[d,U]=o.useState(null),[Z,E]=o.useState(!1),[G]=H.useForm(),[D,ie]=o.useState(!1),[Se,Y]=o.useState(""),[J,k]=o.useState("all"),[$,ye]=o.useState(""),[ge,ae]=o.useState(1),[Le,de]=o.useState(25),Ae=r=>String(r||"").trim().toLowerCase(),je=r=>`${String(r.company||"").trim().toUpperCase()}|${String(r.model||"").trim().toUpperCase()}|${String(r.variant||"").trim().toUpperCase()}`,Ue=async()=>{const r=`${p}?action=list`,P=await fetch(r,{method:"GET",mode:"cors",credentials:"omit"});if(!P.ok)throw new Error("Failed to fetch catalog");return P.json()},oe=async r=>{const P=new URLSearchParams({action:"upsert",...r}),O=await fetch(p,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},body:P});if(!O.ok)throw new Error("Save failed");return O.json()},_e=async r=>{const P=new URLSearchParams({action:"delete",...r}),O=await fetch(p,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},body:P});if(!O.ok)throw new Error("Delete failed");return O.json()},ue=async()=>{z(!0),ie(!1);try{const r=await Ue(),P=r?.data||r?.items||r?.rows||r||[],O=Array.isArray(P)?P.map(Ga).filter(Ce=>Ce.company&&Ce.model&&Ce.variant):[];_(O),r?.ok===!1&&/catalog gas url/i.test(String(r?.message||""))&&ie(!0)}catch{if(l)try{const P=(await Js(l)).map(Ga).filter(O=>O.company&&O.model&&O.variant);_(P),ie(!0)}catch{_([])}else _([])}finally{z(!1)}};o.useEffect(()=>{ue()},[]);const Ee=()=>{U(null),G.resetFields(),E(!0)},ze=r=>{U(r),G.setFieldsValue({company:r.company,model:r.model,variant:r.variant,color:r.color,onRoadPrice:r.onRoadPrice}),E(!0)},be=async r=>{try{V(!0);const O={id:r.id||r.rowId||void 0,company:r.company,model:r.model,variant:r.variant,key:je(r)},Ce=await _e(O);if(!((Ce?.success??Ce?.ok??!0)!==!1))throw new Error(Ce?.message||"Delete failed");S.success("Vehicle deleted"),await ue()}catch(P){S.error(P?.message||"Could not delete vehicle")}finally{V(!1)}},Re=o.useMemo(()=>{const r=Se.trim().toLowerCase(),P=$.trim().toLowerCase();return B.filter(O=>{const Ce=!r||[O.company,O.model,O.variant,O.color,O.updatedBy].some(Xe=>String(Xe||"").toLowerCase().includes(r)),Oe=J==="all"||Ae(O.company)===J,Ve=!P||Ae(O.variant).includes(P);return Ce&&Oe&&Ve})},[B,Se,J,$]),Te=o.useMemo(()=>`vc-${J}-${$}-${Se}`,[J,$,Se]);o.useEffect(()=>{ae(1)},[J,$,Se]);const K=o.useMemo(()=>{const r=Re.length,P=Re.reduce((Ve,Xe)=>Ve+(Number(Xe.onRoadPrice)||0),0),O=r?Math.round(P/r):0,Ce=new Set(Re.map(Ve=>Ae(Ve.company))),Oe=new Set(Re.map(Ve=>Ae(Ve.variant)));return{count:r,totalPrice:P,avgPrice:O,companyCount:Ce.size,variantCount:Oe.size}},[Re,Ae]),c=o.useMemo(()=>{const r=new Set(B.map(P=>Ae(P.company)).filter(Boolean));return Array.from(r).map(P=>({value:P,label:(P||"").toUpperCase()})).sort((P,O)=>P.label.localeCompare(O.label))},[B]),w=async()=>{try{const r=await G.validateFields();["company","model","variant"].forEach(Oe=>{r[Oe]&&(r[Oe]=String(r[Oe]).toUpperCase())}),r.color&&(r.color=String(r.color).toUpperCase().trim()),V(!0);const P={...r,onRoadPrice:Number(r.onRoadPrice||0)||0,id:d?.id,key:d?.key||je(r),updatedBy:(()=>{try{const Oe=JSON.parse(localStorage.getItem("user")||"null");return Oe?.name||Oe?.email||""}catch{return""}})(),action:"upsert"},O=await oe(P);if(!((O?.success??O?.ok??!0)!==!1))throw new Error(O?.message||"Save failed");S.success(d?"Vehicle updated":"Vehicle added"),E(!1),U(null),await ue()}catch(r){if(r?.errorFields)return;S.error(r?.message||"Could not save vehicle")}finally{V(!1)}},n=o.useMemo(()=>[{title:"Company",dataIndex:"company",key:"company",sorter:(r,P)=>r.company.localeCompare(P.company)},{title:"Model",dataIndex:"model",key:"model",sorter:(r,P)=>r.model.localeCompare(P.model)},{title:"Variant",dataIndex:"variant",key:"variant",sorter:(r,P)=>r.variant.localeCompare(P.variant)},{title:"Colors",dataIndex:"color",key:"color",render:r=>r||e.jsx(Qt,{type:"secondary",children:"-"})},{title:"On-Road Price (â‚¹)",dataIndex:"onRoadPrice",key:"onRoadPrice",render:r=>r?r.toLocaleString("en-IN"):e.jsx(Qt,{type:"secondary",children:"0"}),sorter:(r,P)=>(r.onRoadPrice||0)-(P.onRoadPrice||0)},{title:"Updated At",dataIndex:"updatedAt",key:"updatedAt",render:r=>r?Ze(r).format("DD-MM-YYYY HH:mm"):e.jsx(Qt,{type:"secondary",children:"-"})},{title:"Updated By",dataIndex:"updatedBy",key:"updatedBy",render:r=>r||e.jsx(Qt,{type:"secondary",children:"-"})},{title:"Actions",key:"actions",render:(r,P)=>e.jsxs(me,{children:[e.jsx(q,{size:"small",icon:e.jsx(Es,{}),onClick:()=>ze(P),disabled:L||D,children:"Edit"}),e.jsx(xs,{title:"Delete this vehicle?",onConfirm:()=>be(P),disabled:L||D,children:e.jsx(q,{size:"small",danger:!0,disabled:L||D,children:"Delete"})})]})}],[L,D]),M=()=>{if(!Re.length){S.info("No catalog rows to export for current filters");return}const r=[{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"color",label:"Color"},{key:"onRoadPrice",label:"On-Road Price"},{key:"updatedAt",label:"Updated At"},{key:"updatedBy",label:"Updated By"}],P=Re.map(O=>({company:O.company,model:O.model,variant:O.variant,color:O.color,onRoadPrice:O.onRoadPrice,updatedAt:O.updatedAt,updatedBy:O.updatedBy}));Gt({filename:"vehicle-catalog.csv",headers:r,rows:P}),S.success(`Exported ${P.length} vehicles`)};return e.jsxs("div",{style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:16},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(120deg,#2563eb0d,#2563eb1f)",border:"1px solid #dbeafe"},children:[e.jsx("div",{style:{fontSize:12,color:"#2563eb"},children:"Records"}),e.jsx("div",{style:{fontSize:22,fontWeight:700},children:K.count.toLocaleString("en-IN")}),e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:"Filtered vehicles"})]}),e.jsxs("div",{style:{padding:12,borderRadius:10,background:"#f8fafc",border:"1px solid #e2e8f0"},children:[e.jsx("div",{style:{fontSize:12,color:"#0f172a"},children:"Mix"}),e.jsxs("div",{style:{fontSize:14,fontWeight:600},children:[K.companyCount," brands â€¢ ",K.variantCount," variants"]}),e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:J!=="all"?`Filtered: ${J.toUpperCase()}`:"All brands"})]})]}),e.jsxs(me,{style:{marginBottom:12,flexWrap:"wrap",width:"100%",justifyContent:"space-between"},children:[e.jsxs(me,{wrap:!0,children:[e.jsx(q,{type:"primary",icon:e.jsx(Wa,{}),onClick:Ee,disabled:D,children:"Add Vehicle"}),e.jsx(q,{icon:e.jsx(Cs,{}),onClick:ue,loading:R,children:"Reload"}),e.jsx(q,{onClick:M,children:"Export CSV"}),D&&e.jsx(he,{color:"red",children:"Save disabled (configure VEHICLE_CATALOG_GAS_URL)"})]}),e.jsxs(me,{wrap:!0,children:[e.jsx(ee,{placeholder:"Search company/model/variant/color/user",allowClear:!0,value:Se,onChange:r=>Y(r.target.value),style:{maxWidth:260}}),e.jsx(ee,{placeholder:"Filter variant",allowClear:!0,value:$,onChange:r=>ye(r.target.value),style:{maxWidth:160}}),e.jsx(pe,{value:J,onChange:r=>k(r===void 0?"all":Ae(r)),style:{minWidth:140},options:[{value:"all",label:"All Companies"},...c],showSearch:!0,optionFilterProp:"label",allowClear:!1})]})]}),D&&e.jsx(bs,{showIcon:!0,type:"warning",style:{marginBottom:12},message:"Catalog GAS URL not configured",description:"Listing works from the published CSV, but saving/updating requires VEHICLE_CATALOG_GAS_URL in the environment."}),e.jsxs("div",{style:{marginBottom:12,fontSize:12,color:"#475569"},children:["Showing ",Re.length.toLocaleString("en-IN")," of ",B.length.toLocaleString("en-IN")," catalog records."]}),e.jsx(Bt,{columns:n,dataSource:Re,loading:R,rowKey:r=>r.id||r.key||je(r),tableLayout:u?"auto":"fixed",scroll:u?{x:"max-content"}:void 0,pagination:{current:ge,pageSize:Le,total:Re.length,showSizeChanger:!0,showQuickJumper:!0,pageSizeOptions:["10","25","50","100","200"],onChange:(r,P)=>{ae(r),de(P)},showTotal:(r,P)=>`${P[0]}-${P[1]} of ${r}`},size:u?"small":"middle"},Te),e.jsx(it,{open:Z,title:d?"Edit Vehicle":"Add Vehicle",onCancel:()=>{E(!1),U(null)},onOk:w,okButtonProps:{loading:L},destroyOnClose:!0,children:e.jsxs(H,{form:G,layout:"vertical",children:[e.jsx(H.Item,{name:"company",label:"Company",rules:[{required:!0,message:"Enter company"}],children:e.jsx(ee,{placeholder:"e.g., HONDA",allowClear:!0,style:{textTransform:"uppercase"},onChange:r=>G.setFieldsValue({company:(r.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"model",label:"Model",rules:[{required:!0,message:"Enter model"}],children:e.jsx(ee,{placeholder:"e.g., SHINE",allowClear:!0,style:{textTransform:"uppercase"},onChange:r=>G.setFieldsValue({model:(r.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"variant",label:"Variant",rules:[{required:!0,message:"Enter variant"}],children:e.jsx(ee,{placeholder:"e.g., DISC",allowClear:!0,style:{textTransform:"uppercase"},onChange:r=>G.setFieldsValue({variant:(r.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"color",label:"Colors (comma-separated)",children:e.jsx(ee,{placeholder:"e.g., RED, BLACK, BLUE",allowClear:!0,style:{textTransform:"uppercase"},onChange:r=>G.setFieldsValue({color:(r.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"onRoadPrice",label:"On-Road Price (â‚¹)",rules:[{required:!0,message:"Enter price"}],children:e.jsx(Ns,{style:{width:"100%"},min:0,step:500,parser:r=>Number((r||"").toString().replace(/[^\d.-]/g,"")),formatter:r=>r?Number(r).toLocaleString("en-IN"):""})})]})})]})}export{Cn as B,Rn as J,An as Q,jn as U,In as V,wn as a};
