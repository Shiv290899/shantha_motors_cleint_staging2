import{r as l,j as e,a as Do,G as To,R as ko}from"./index-Cpnbu_hS.js";import{L as Gt,d as E}from"./index-6X0CyMNZ.js";import{f as $t,t as ls,i as ds,S as kt,P as Po,h as Fs}from"./PostServiceSheet-B3EW42tp.js";import{F as Bt}from"./index-C3wZZQpt.js";import{A as Js,a as lt,s as Ht,l as Yo,b as Ro,g as Eo,u as Vs,n as Os,D as Ls,c as Fo}from"./caseInsensitive-DUicqe8X.js";import{B as se}from"./button-BatQfFEZ.js";import{M as Nt}from"./index-_eB-6_5d.js";import{S as Vo}from"./index-Bh1aWF1p.js";import{R as Wt,a as zs,S as zt}from"./index-D-dakd2l.js";import{I as ye,s as x}from"./index-LPdCTC9Y.js";import{F as k}from"./index-DNb1SccI.js";import{T as Oo}from"./index-1WhPD5b5.js";import{C as it}from"./index-DCQr-s-B.js";import{z as Qe,A as U,T as Lo}from"./TextArea-R_tc8-o2.js";import{A as Us}from"./index-DsZwLS6c.js";import{C as Uo}from"./index-BEdwHSAw.js";import{T as Kt}from"./index-Hb-OJ-YF.js";import"./useClosable-DbzGHYuW.js";import"./pickAttrs-BVAqgOfw.js";import"./iconBase-DiVbFH8G.js";import"./PurePanel-ez_1tkJB.js";import"./PlusOutlined-7xIATISe.js";import"./index-B6oJeA1C.js";import"./Skeleton-CGp8jJhE.js";import"./useBubbleLock-Bs98J1M0.js";import"./LeftOutlined-BhX26yVi.js";import"./CheckOutlined-DFU0j46T.js";import"./DownOutlined-Crw_Sawk.js";import"./index-CUWDS_la.js";import"./EyeOutlined-o0bG0SND.js";const Io=l.forwardRef(function({active:h,vals:n,labourRows:S,executives:K=[],observationLines:$},F){const V=b=>String(b||"").toLowerCase().replace(/\s+/g," ").trim(),re=new Map((S||[]).map(b=>{const A=Number(b?.qty||0)*Number(b?.rate||0);return[V(b?.desc||b?.name),A]})),le=($||[]).map(b=>{const A=re.get(V(b));return{text:b,amount:Number.isFinite(A)?A:null}}),Ne=le.reduce((b,A)=>b+(A.amount??0),0),we=b=>{const De=String(b??"").toUpperCase().trim().replace(/\s*KM\s*$/i,"").replace(/\D/g,"");return De?`${De} KM`:"-"},ee=({w:b="8mm"})=>e.jsx("span",{"aria-hidden":"true",style:{display:"inline-block",width:b}}),G=(()=>{const b=String(n?.executive||"").trim(),A=b.replace(/\D/g,"");return/^\d{10}$/.test(A)?A:(K||[]).find(De=>De.name===b)?.phone||null})(),de=(()=>{const b=n?.floorMat;if(typeof b=="boolean")return b;const A=String(b??"").trim().toLowerCase();return A==="yes"||A==="y"||A==="true"||A==="1"})(),be=n?.floorMat!=null?!de:!1,me=String(n?.branch||"").trim().toLowerCase().replace(/\s+/g,"").includes("byadarahalli"),ne=["Free","Paid","Minor","Accidental"];return e.jsxs("div",{ref:F,className:`print-sheet ${h?"active":""}`,children:[e.jsx("style",{children:`
/* =========================
   NEW PRINT BASELINE (A4)
   ========================= */
@page { size: A4 portrait; margin: 0; }
html, body {
  margin: 0 !important;
  padding: 0 !important;
  background: #fff !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica, sans-serif;
}
img { max-width: 100%; height: auto; background: transparent; }

/* Tame layout quirks during print */
@media print {
  * { transform: none !important; }
  .fixed, .sticky, [style*="position: sticky"], [style*="position: fixed"] { position: static !important; }
  .no-print { display: none !important; }
}

/* Screen preview */
@media screen {
  body:not(.print-host) 
  .print-sheet { display: none !important; }
}

/* If you still use the "active sheet only" pattern in full app print, keep it: */
@media print {
  body * { visibility: hidden !important; }                 /* hide all */
  .print-sheet { display: block; }
  .print-sheet.active,
  .print-sheet.active * { visibility: visible !important; } /* show only sheet */
  .print-sheet:not(.active) { display: none !important; }   /* ensure only one prints */
  .print-sheet.active { position: absolute; inset: 0; width: 100%; } /* start at top-left */

  /* Avoid blank extra pages by letting height auto */
  .pre-a4 { display: block !important; min-height: auto !important; height: auto !important; }

  /* Keep larger blocks from splitting */
  .voucher { break-inside: avoid; page-break-inside: avoid; }
}

/* ========== Your existing styles (kept) ========= */
.print-sheet { color: #000; }

/* Page grid */
.pre-a4 { /* container for a single A4 page */ }
.pre-wrap { padding: 4mm; }
.pre-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3mm; }

/* Generic boxes and text helpers */
.box { border: 1px solid #111; padding: 2.5mm; border-radius: 1mm; }
.tiny { font-size: 11px; }
.label { font-weight: 600; }

/* Titles */
.title-kn { font-size: 18pt; font-weight: 500; letter-spacing: 1px; }
.title-en { font-size: 25pt; font-weight: 700; margin-top: 2px; }
.title-wrap {
  display: flex;
  align-items: baseline;
  gap: 8px;
  white-space: nowrap;
}

/* Grids */
.row   { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2mm; }
.row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2mm; }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2mm; }

.right { text-align: right; }
.center { text-align: center; }
.v-top { align-self: start; }

/* Observation + cost split column */
.obs-cost {
  display: grid;
  grid-template-columns: 1fr 40mm; /* observation | cost column */
  gap: 2mm;
}
.list { padding-left: 4mm; margin: 0; }
.list li { margin: 0.8mm 0; }
.sum-row { display: grid; grid-template-columns: 1fr 40mm; gap: 2mm; align-items: center; }
.divider { border-top: 1px solid #000; margin: 3mm 0; }

/* Voucher area (bottom strip) */
.voucher {
  border-top: 3px dashed #777;
  padding-top: 3mm;
  height: 60%;
  align-items: stretch;
}

/* Brand line */
.voucher .brand-line{
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 8px;
  white-space: nowrap;
}
.voucher .brand-kn{ font-size:18pt; font-weight:500; line-height:1.05; }
.voucher .brand-en{ font-size:18pt; font-weight:500; line-height:1.05; }

/* Single outer box inside voucher: left | middle | right(=QR) */
.voucher .box {
  width: 98%;
  border: 1px solid #111;
  border-radius: 5mm;
  display: grid;
  grid-template-columns: 0.7fr 0.9fr 0.5fr;
  gap: 3mm;
  align-items: start;
  text-align: left;
}
.voucher .col { text-align: left; }
.voucher .col-right { text-align: center; }
.voucher .qr { height: 60px; width: 60px; object-fit: contain; }
.voucher .scan { font-size: 13px; font-weight: 600; margin-top: 4px; }
.voucher .phones { margin-top: 2px; }
/* Light helper for address lines */
.shop-sub { font-size: 12pt; }
.shop-addr { font-size: 11pt; }

/* Damage section */
.damage-box { border: 1px solid #111; padding: 2mm; min-width: 38mm; }
.damage-box .title { font-weight: 700; font-size: 12px; margin-bottom: 2mm; }
.damage-list { list-style: disc; padding-left: 5mm; margin: 0 0 3mm 0; }
.damage-list li { margin: 1mm 0; position: relative; }

/* Yes / No on the right of each line */
.yn {
  float: right;
  display: inline-flex;
  align-items: center;
  gap: 4mm;
}

/* Printable empty checkbox square */
.cb {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 5mm;
  height: 5mm;
  border: 1px solid #111;
  font-size: 12px;  /* ensures â˜‘ / â˜ fits */
}


/* NOTE block below the list */
.note-box { border-top: 1px dashed #777; margin-top: 3mm; padding-top: 2mm; }
.note-title { font-weight: 600; margin-bottom: 1.5mm; }
.note-area { border: 1px solid #111; height: 69mm; border-radius: 1mm; }
      `}),e.jsxs("div",{className:"pre-a4",children:[e.jsxs("div",{className:"pre-wrap",children:[e.jsxs("div",{className:"title-wrap",children:[e.jsx("div",{className:"title-en",children:me?"NH MOTORS JOB CARD":"SHANTHA MOTORS JOB CARD"}),e.jsx("div",{className:"title-kn",children:me?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"})]}),me&&e.jsxs("div",{style:{marginTop:2},children:[e.jsxs("div",{className:"shop-addr",children:["Site No. 116/1, Bydarahalli, Magadi Main Road, Opp.",e.jsx("br",{}),"HP Petrol Bunk, Bangalore - 560091"]}),e.jsx("div",{className:"shop-sub",children:"Mob: 9731366921 / 8073283502 / 9741609799"})]}),e.jsxs("div",{className:"box row-2",style:{marginTop:3},children:[e.jsxs("div",{style:{fontSize:"20px",lineHeight:"1.4"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Job Card No:"})," ",n.jcNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Executive:"})," ",n.executive||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Date:"})," ",$t(n.createdAt)]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Mechanic:"})," ",n.mechanic||"-"]})]}),e.jsxs("div",{className:"center",children:[e.jsx("img",{src:"/location-qr.png",alt:"location qr",style:{height:60}}),e.jsx("div",{className:"scan",children:"Scan for Location"}),e.jsx("div",{className:"tiny",style:{marginTop:3},children:me?"Mob: 9731366921 / 8073283502 / 9741609799":"Mob: 9731366921 / 8073283502"})]})]}),e.jsxs("div",{className:"row-2",style:{marginTop:3},children:[e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Vehicle No:"})," ",n.regNo||"-"]}),e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Odometer Reading:"})," ",we(n.km)]})]}),e.jsxs("div",{className:"row-2",style:{marginTop:3},children:[e.jsx("div",{className:"box",children:e.jsx("div",{children:e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Model:"})," ",n.model||"-"]})})}),e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Expected Delivery Date:"})," ",$t(n.expectedDelivery)]})]}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{style:{display:"flex",gap:"6mm",flexWrap:"wrap",alignItems:"center"},children:[ne.map(b=>e.jsxs("div",{children:[ls(n.serviceType===b)," ",b]},b)),e.jsx(ee,{w:"10mm"}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Color:"})," ",n.colour||"-"]})]})}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"4fr 3fr",gap:"3mm"},children:[e.jsxs("div",{className:"obs-cost",children:[e.jsxs("div",{children:[e.jsx("div",{className:"label",children:"Customer Observation"}),e.jsx("ul",{className:"list",children:le.length===0?e.jsx("li",{children:"â€”"}):le.map(({text:b},A)=>e.jsx("li",{children:b},A))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"label right",children:"Estimated Cost"}),e.jsx("ul",{className:"list",style:{listStyle:"none",paddingLeft:0},children:le.length===0?e.jsx("li",{className:"right",children:"â€”"}):le.map(({amount:b},A)=>e.jsx("li",{className:"right",children:b!=null?ds(b):"â€”"},A))})]})]}),e.jsx("div",{className:"v-top",children:e.jsxs("div",{className:"damage-box",children:[e.jsx("div",{className:"title",children:"CHECK BODY PART FOR ANY DAMAGE"}),e.jsxs("ul",{className:"damage-list",children:[e.jsxs("li",{children:["Dent",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Scratch",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Broken",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Floor Mat",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb",children:ls(de)}),"No  ",e.jsx("span",{className:"cb",children:ls(be)})]})]})]}),e.jsxs("div",{className:"note-box",children:[e.jsx("div",{className:"note-title",children:"NOTE:"}),e.jsx("div",{className:"note-area"})]})]})})]})}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{className:"sum-row",style:{fontWeight:700},children:[e.jsx("div",{children:"Total Estimated Cost"}),e.jsx("div",{className:"right",children:ds(Ne)})]})}),e.jsxs("div",{className:"row-3 box",style:{marginTop:3},children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Customer Name:"})," ",n.custName||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Mobile No:"})," ",n.custMobile||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Sign:"})," "]})]})]}),e.jsxs("div",{className:"pre-wrap voucher",children:[e.jsxs("div",{className:"brand-line",children:[e.jsx("span",{className:"brand-kn",children:me?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsx("span",{children:" || "}),e.jsx("span",{className:"brand-en",children:me?"NH MOTORS":"SHANTHA MOTORS"})]}),e.jsxs("div",{className:"box",style:{fontSize:"20px",lineHeight:"1.3",marginTop:"2mm"},children:[e.jsxs("div",{className:"col",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Job Card No:"})," ",n?.jcNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Reg. No:"})," ",n?.regNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Exp. Del. Date:"})," ",$t(n?.expectedDelivery)]})]}),e.jsxs("div",{className:"col",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Date:"})," ",$t(n?.createdAt)]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Executive No:"})," ",G||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Apprx. Service Amount:"})," ",ds(Ne)]})]}),e.jsxs("div",{className:"col col-right",children:[e.jsx("img",{src:"/location-qr.png",alt:"Location QR",className:"qr"}),e.jsx("div",{className:"scan",children:"Scan for Location"}),e.jsx("div",{className:"tiny phones",children:me?"9731366921 â€¢ 8073283502 â€¢ 9741609799":"9731366921 â€¢ 8073283502"})]})]})]})]})]})}),ms={},_o="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec";function $o({form:i,formatReg:h,buildRows:n,defaultGstLabour:S=0,lists:K,setServiceTypeLocal:$,setVehicleTypeLocal:F,setRegDisplay:V,webhookUrl:re,setFollowUpEnabled:le,setFollowUpAt:Ne,setFollowUpNotes:we,setPostServiceLock:ee,autoSearch:G,prefillMode:de="full",onAutoSearchStatusChange:be}){const Me=ms?.VITE_JOBCARD_GAS_SECRET||"",me=ms?.VITE_BOOKING_GAS_SECRET||"",ne=ms?.VITE_BOOKING_GAS_URL||_o,[b,A]=l.useState(!1),[ae,De]=l.useState("mobile"),[Pe,q]=l.useState(""),[Be,He]=l.useState(!1),[Ee,Q]=l.useState([]),[Ie,ie]=l.useState(""),[Fe,We]=l.useState(de),Ce=l.useRef(de),{BRANCHES:he,MECHANIC:jt,EXECUTIVES:Rt,VEHICLE_TYPES:ue,SERVICE_TYPES:dt}=l.useMemo(()=>K||{},[K]);l.useEffect(()=>{Ce.current=de,We(de)},[de]);const O=l.useMemo(()=>({Branch:["Branch"],Mechanic:["Allotted Mechanic","Mechanic","Allocated Mechanic"],Executive:["Executive"],ExpectedDelivery:["Expected Delivery Date","Expected Delivery","Expected_Delivery_Date"],RegNo:["Vehicle No","Vehicle_No","Vehicle Number","Registration Number","Reg No","RegNo"],ChassisNo:["Chassis No","Chassis_No","Chassis Number","Chassis"],Model:["Model"],Colour:["Colour","Color"],KM:["Odometer Reading","Odomete Reading","KM","Odometer"],CustName:["Customer Name","Name","Customer_Name"],Mobile:["Mobile","Mobile No","Mobile Number","Phone","Phone Number"],Obs:["Customer Observation","Customer_Observation","Observation","Notes"],VehicleType:["Vehicle Type","Type of Vehicle","Vehicle_Type"],ServiceType:["Service Type","Service","Service_Type"],FloorMat:["Floor Mat"],Amount:["Collected Amount","Amount"],JCNo:["JC No","JCNo","Job Card No","JC Number","JC No."],CreatedAt:["Created At","Timestamp","Form Timestamp","Submission Time","Submitted At"]}),[]),I=(o,r)=>{for(const a of r)if(Object.prototype.hasOwnProperty.call(o,a)){const m=o[a];if(m!=null&&String(m).trim()!=="")return String(m).trim()}return""},Ke=o=>o!=null&&String(o).trim()!=="",N=(...o)=>{for(const r of o)if(Ke(r))return r;return""},Ye=o=>String(o||"").replace(/\D/g,"").slice(-10),Re=o=>String(o||"").toUpperCase().replace(/[^A-Z0-9]/g,""),Et=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,Zt=o=>{const r=Re(o);return r.length>10||!/^[A-Z0-9]*$/.test(r)?!1:[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(m=>m.test(r))},et=(o={})=>{const a=o?.source==="inline",m=ae==="vehicle"?Re(Pe):Ye(Pe)||String(Pe||"").trim(),B=m?`No records found for ${ae==="vehicle"?"vehicle number":"mobile number"} "${m}".`:"No records found.";ie(B),Nt.warning({centered:!0,title:a?"No records found":"No job card found",content:B,okText:"Got it"})},Ft=o=>{const r=String(o||"").trim();if(!r)return null;const a=E(r,["DD-MM-YYYY HH:mm","D-M-YYYY HH:mm","DD/MM/YYYY HH:mm","D/M/YYYY HH:mm","DD-MM-YYYY","D-M-YYYY","DD/MM/YYYY","D/M/YYYY","YYYY-MM-DD",E.ISO_8601],!0);return a.isValid()?a:null},Ve=o=>{const r=I(o,O.CreatedAt),a=E(r,[E.ISO_8601,"M/D/YYYY H:mm:ss","D/M/YYYY H:mm:ss","DD/MM/YYYY H:mm:ss","DD/MM/YYYY","D-M-YYYY H:mm:ss","DD-MM-YYYY H:mm:ss","DD-MM-YYYY HH:mm","DD-MM-YYYY"],!1);return a.isValid()?a:E(0)},Ae=o=>{const r=o?.formValues||{};let a=0;return String(r.regNo||"").trim()&&(a+=3),String(r.custMobile||"").replace(/\D/g,"").length===10&&(a+=2),String(r.custName||"").trim()&&(a+=2),String(r.company||"").trim()&&(a+=2),String(r.model||"").trim()&&(a+=2),String(r.colour||"").trim()&&(a+=1),a},Oe=o=>{const r=o||{},a=r.formValues||{},m=r.savedAt||r.createdAt||r.ts||r.timestamp||r.postServiceAt||a.createdAt||a.savedAt||a.timestamp||a.submittedAt||a.expectedDelivery||"",y=E(m);return y.isValid()?y.valueOf():0},Qt=(o,r)=>{const a=o&&o.payload?o.payload:o||{},m=o?._values||o?.values||{},y=a?.postServiceAt||a?.postService_at||a?.formValues?.postServiceAt||a?.formValues?.postService_at||m?.Post_Service_At||m?.Post_Service_at||m?.Post_Service||"",B=a?.formValues?.custMobile||a?.custMobile||m?.Mobile||m?.["Mobile Number"]||m?.Phone||m?.["Phone Number"]||"",ce=Ye(B);return{locked:!!a?.postServiceLogged||!!y,at:y||null,mobile:ce||null,amount:a?.postServiceAmount??null,mode:a?.postServiceMode||a?.paymentMode||null}},qe=(o,r)=>{if(!ee)return;const a=Qt(o);ee(a)},Le=o=>String(o||"").toLowerCase().replace(/\s+/g,""),tt=(o,r)=>{if(!r||!o?.length)return;const a=Le(r);let m=o.find(y=>Le(y)===a);return m||(m=o.find(y=>Le(y).startsWith(a)),m)||(m=o.find(y=>Le(y).includes(a))),m},mt=o=>{const r=String(o||"").toLowerCase();return r.includes("free")?"Free":r.includes("paid")?"Paid":r.includes("minor")?"Minor":r.includes("accid")?"Accidental":tt(dt||[],o)},Vt=o=>{const r=String(o||"").toLowerCase();return r.includes("scoot")||r.includes("scooty")?"Scooter":r.includes("bike")||r.includes("motor")?"Motorcycle":tt(ue||[],o)},ut=async(o,r)=>{if(!re)throw new Error("Webhook URL not configured");const a=r||ae,m=a==="vehicle"?"reg":a==="jc"?"jc":"mobile",y=String(o??Pe??""),B=Me?{action:"search",mode:m,query:y,secret:Me}:{action:"search",mode:m,query:y};let ce=[];try{const M=await lt({webhookUrl:re,method:"GET",payload:B}),p=M?.data||M;ce=Array.isArray(p?.rows)?p.rows:[]}catch(M){console.warn("Webhook search failed:",M)}if(!ce.length&&a==="vehicle")try{const p=await lt({webhookUrl:re,method:"GET",payload:Me?{action:"search",mode:"vehicle",query:y,secret:Me}:{action:"search",mode:"vehicle",query:y}}),H=p?.data||p;ce=Array.isArray(H?.rows)?H.rows:[]}catch(M){console.warn("Vehicle search fallback failed:",M)}return{mode:"webhook",rows:ce.map(M=>{const p=M&&M.values?M.values:{},H=String(p.Post_Service_At||p.Post_Service_at||p.Post_Service||"").trim(),f={jcNo:String(p["JC No."]||""),branch:String(p.Branch||""),mechanic:String(p.Allotted_Mechanic||p["Allotted Mechanic"]||""),executive:String(p.Executive||""),regNo:h(p.Vehicle_No||p["Vehicle No"]||"",""),company:String(p.Company||""),serviceType:String(p.Service_Type||p["Service Type"]||""),model:String(p.Model||""),colour:String(p.Colour||p.Color||""),chassisNo:String(p.Chassis_No||p["Chassis No"]||"").toUpperCase(),km:String(p.KM||p["Odometer Reading"]||p["Odomete Reading"]||"").replace(/\D/g,"")||"",fuelLevel:String(p.Fuel_Level||p["Fuel Level"]||""),vehicleType:String(p.Vehicle_Type||p["Vehicle Type"]||""),paymentMode:String(p.Payment_Mode||p["Payment Mode"]||""),custName:String(p.Customer_Name||""),custMobile:String(p.Mobile||""),obs:String(p.Customer_Observation||""),expectedDelivery:String(p.Expected_Delivery_Date||""),amount:String(p.Collected_Amount||""),utr:String(p.UTR_No||p["UTR No"]||"")};if(M&&M.payload&&typeof M.payload=="object"){const j=M.payload||{},w=j.formValues||{},v={jcNo:N(w.jcNo,f.jcNo),branch:N(w.branch,f.branch),mechanic:N(w.mechanic,f.mechanic),executive:N(w.executive,f.executive),expectedDelivery:N(w.expectedDelivery,f.expectedDelivery),regNo:N(w.regNo,f.regNo),company:N(w.company,f.company),model:N(w.model,f.model),colour:N(w.colour,w.color,f.colour),chassisNo:N(w.chassisNo,w.chassis,f.chassisNo),km:String(N(w.km,f.km)).replace(/\D/g,""),fuelLevel:N(w.fuelLevel,f.fuelLevel),callStatus:N(w.callStatus,""),custName:N(w.custName,f.custName),custMobile:N(w.custMobile,f.custMobile),obs:N(w.obs,f.obs),vehicleType:N(w.vehicleType,f.vehicleType),serviceType:N(w.serviceType,f.serviceType),floorMat:N(w.floorMat,f.floorMat),amount:N(w.amount,f.amount),paymentMode:N(w.paymentMode,f.paymentMode),utr:N(w.utr,w.utrNo,f.utr)};return{payload:{...j,formValues:v,postServiceAt:j.postServiceAt||j.postService_at||H||void 0,postServiceLogged:j.postServiceLogged||!!(j.postServiceAt||j.postService_at||H),_values:p}}}return{payload:{formValues:f,labourRows:[],totals:{},postServiceAt:H||void 0,postServiceLogged:!!H,_values:p}}})}},Ot=(o={})=>{const r=o?.values||{},a=o?.payload||o||{},m=a?.vehicle||{},y=N(m?.regNo,m?.registrationNumber,a?.regNo,a?.vehicleNo,r["Vehicle No"],r.Vehicle_No,r["Registration Number"],r["Vehicle Number"],r["Reg No"]),B=N(m?.model,a?.model,r.Model);return{formValues:{regNo:h(y||"",""),custMobile:Ye(N(a?.mobileNumber,a?.mobile,r.Mobile,r["Mobile Number"],r.Phone)),custName:N(a?.customerName,a?.name,r.Customer_Name,r["Customer Name"]),company:N(m?.company,a?.company,r.Company,r["Company Name"]),model:String(B||"").toUpperCase(),colour:N(m?.colour,m?.color,a?.colour,a?.color,r.Colour,r.Color),chassisNo:N(m?.chassisNo,m?.chassis,a?.chassisNo,r["Chassis No"],r.Chassis_No)},savedAt:N(a?.ts,a?.createdAt,a?.savedAt,r.Timestamp),createdAt:N(a?.createdAt,a?.ts,r.Timestamp),timestamp:N(a?.timestamp,a?.ts,a?.createdAt,r.Timestamp),_values:r}},st=async(o,r)=>{const a=r||ae;if(a!=="mobile"&&a!=="vehicle")return{mode:"booking",rows:[]};const m=String(o??Pe??"").trim(),y=a==="vehicle"?{action:"search",mode:"vehicle",query:m}:{action:"search",mode:"mobile",query:m};me&&(y.secret=me);const B=[Ht({webhookUrl:ne,method:"GET",payload:y}),Ht({webhookUrl:ne,method:"POST",payload:y})];if(a==="vehicle"){const f={...y,mode:"reg"};B.push(Ht({webhookUrl:ne,method:"GET",payload:f})),B.push(Ht({webhookUrl:ne,method:"POST",payload:f}))}const M=(await Promise.allSettled(B)).flatMap(f=>{if(f.status!=="fulfilled")return[];const j=f.value?.data||f.value;return Array.isArray(j?.rows)?j.rows:[]}).map(f=>Ot(f)),p=[],H=new Set;return M.forEach(f=>{const j=f?.formValues||{},w=[String(j.regNo||"").toUpperCase(),String(j.custMobile||""),String(j.custName||"").toUpperCase(),String(j.company||"").toUpperCase(),String(j.model||"").toUpperCase()].join("|");w&&(H.has(w)||(H.add(w),p.push({payload:f})))}),{mode:"booking",rows:p}},Xt=o=>{const r=I(o,O.Branch),a=I(o,O.Mechanic),m=I(o,O.Executive),y=Ft(I(o,O.ExpectedDelivery)),B=h(I(o,O.RegNo),""),ce=String(I(o,O.ChassisNo)||"").toUpperCase().replace(/[^A-Z0-9]/g,""),X=String(I(o,O.Model)||"").toUpperCase(),M=I(o,O.Colour),p=I(o,O.KM).replace(/\D/g,""),H=I(o,O.CustName),f=Ye(I(o,O.Mobile)),j=I(o,O.Obs),w=(()=>{const J=String(j||"").trim();return J?J.includes("#")?J.split(/\s*#\s*/g).map(xe=>xe.trim()).filter(Boolean).join(`
`):J.replace(/\r\n/g,`
`):""})(),v=Vt(I(o,O.VehicleType)),W=mt(I(o,O.ServiceType)),_=I(o,O.FloorMat),ge=I(o,O.JCNo),ze=tt(jt,a),_e=tt((Rt||[]).map(J=>J.name),m);return{fields:{jcNo:ge,branch:tt(he,r)||void 0,mechanic:ze,executive:_e,expectedDelivery:y||null,regNo:B,chassisNo:ce,model:X,colour:M,km:p?`${p} KM`:"",custName:H,custMobile:f,obs:w,vehicleType:v,serviceType:W,floorMat:_==="Yes"||_==="No"?_:void 0,discounts:{labour:0},gstLabour:S},serviceType:W,vehicleType:v}},ot=(o={})=>{const r={},a=h(o.regNo||"",""),m=String(o.custMobile||"").replace(/\D/g,"").slice(-10);a&&(r.regNo=a),m&&(r.custMobile=m),String(o.custName||"").trim()&&(r.custName=o.custName),String(o.company||"").trim()&&(r.company=String(o.company).toUpperCase()),String(o.model||"").trim()&&(r.model=String(o.model).toUpperCase()),String(o.colour||"").trim()&&(r.colour=o.colour),String(o.chassisNo||"").trim()&&(r.chassisNo=String(o.chassisNo).toUpperCase()),Object.keys(r).length&&i.setFieldsValue(r),a&&V?.(a),ee&&ee({locked:!1,at:null,mobile:null,amount:null,mode:null}),x.success("Customer details pre-filled."),A(!1),Q([]),q("")},pt=o=>{const{fields:r,serviceType:a,vehicleType:m}=Xt(o);try{const y=Ve(o);y&&y.isValid&&y.isValid()&&(r.savedAt=y.toISOString())}catch{}if(Ce.current==="basic"){ot(r);return}$?.(a||null),F?.(m||null),i.setFieldsValue(r),V?.(r.regNo||""),a&&m&&i.setFieldsValue({labourRows:n(a,m),gstLabour:S,discounts:{labour:0}}),qe(o),x.success("Details filled from sheet."),A(!1),Q([]),q("")},Je=o=>{try{if(Ce.current==="basic"){const v=o?.formValues||{};ot({regNo:v.regNo||"",custMobile:String(v.custMobile||"").replace(/\D/g,"").slice(-10),custName:v.custName||"",company:v.company||"",chassisNo:v.chassisNo||v.chassis||"",model:String(v.model||"").toUpperCase(),colour:v.colour||""});return}const r=o?.formValues||{},a=o?._values||{},m=v=>{for(const W of v){const _=a?.[W];if(_!=null&&String(_).trim()!=="")return _}return""},y=o?.savedAt||o?.createdAt||o?.ts||o?.timestamp||r.savedAt||r.createdAt||r.timestamp||"",B=o?.updatedAt||r.updatedAt||"",ce=(()=>{const v=E(y);return v.isValid()?v.toISOString():y})(),X=(()=>{const v=E(B);return v.isValid()?v.toISOString():B})(),M=r.serviceType||null,p=r.vehicleType||null;$?.(M),F?.(p);const H=Number(o?.totals?.labourSub||0)||0,f=Number(o?.totals?.labourGST||0)||0,j=H>0&&f>0?Math.round(f/H*100):S,w=Number(o?.totals?.labourDisc||0)||0;if(i.setFieldsValue({jcNo:r.jcNo||"",branch:r.branch||m(["Branch"])||void 0,mechanic:r.mechanic||m(["Allotted_Mechanic","Allotted Mechanic"])||void 0,executive:r.executive||m(["Executive"])||void 0,expectedDelivery:r.expectedDelivery?E(r.expectedDelivery,["DD-MM-YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY","YYYY-MM-DD",E.ISO_8601],!0):null,regNo:r.regNo||m(["Vehicle_No","Vehicle No"])||"",company:String(r.company||m(["Company"])||"").toUpperCase(),model:String(r.model||m(["Model"])||"").toUpperCase(),colour:r.colour||m(["Colour","Color"])||"",chassisNo:String(r.chassisNo||r.chassis||m(["Chassis_No","Chassis No"])||"").toUpperCase(),km:r.km||m(["KM","Odometer Reading","Odomete Reading"])?`${String(r.km||m(["KM","Odometer Reading","Odomete Reading"])).replace(/\D/g,"")} KM`:"",fuelLevel:r.fuelLevel||m(["Fuel_Level","Fuel Level"])||void 0,callStatus:r.callStatus||"",custName:r.custName||"",custMobile:String(r.custMobile||m(["Mobile"])||"").replace(/\D/g,"").slice(-10),obs:String(r.obs||m(["Customer_Observation"])||"").replace(/\s*#\s*/g,`
`),vehicleType:p||m(["Vehicle_Type","Vehicle Type"])||void 0,serviceType:M||m(["Service_Type","Service Type"])||void 0,floorMat:r.floorMat==="Yes"?"Yes":r.floorMat==="No"?"No":void 0,discounts:{labour:w},gstLabour:j,labourRows:Array.isArray(o?.labourRows)&&o.labourRows.length?o.labourRows:n(M,p),savedAt:ce||void 0,updatedAt:X||void 0}),V?.(r.regNo||""),o?.followUp)try{const v=o.followUp;if(typeof v.enabled<"u"&&le?.(!!v.enabled),v.at){const W=E(v.at);W.isValid()&&Ne?.(W)}typeof v.notes<"u"&&we?.(String(v.notes||""))}catch{}qe(o),x.success("Details filled from saved Job Card."),A(!1),Q([]),q("")}catch(r){console.warn("applyPayloadToForm error:",r),x.error("Could not apply fetched Job Card.")}},ht=o=>{o&&o.formValues?Je(o):pt(o)},gt=async(o,r,a,m={})=>{const y=r||ae,B=typeof a=="string"&&a?a:de;Ce.current=B,We(B);const ce=!!m?.autoPickLatest,X=m?.source,M=X==="inline",H=((typeof o=="string"||typeof o=="number"?String(o):void 0)??Pe??"").trim();if(!H){x.warning(y==="vehicle"?"Enter vehicle no. (KA03AB1234)":y==="jc"?"Enter a valid Job Card number.":"Enter a valid 10-digit mobile number."),M&&be?.(!1,X);return}let f=H;if(y==="vehicle"){const j=Re(H);if(!Et.test(j)){x.warning("Enter vehicle no. as KA03AB1234."),M&&be?.(!1,X);return}f=j,q(j)}else if(y==="jc")f=H,q(H);else{const j=Ye(H);if(!j||j.length!==10){x.warning("Enter a valid 10-digit mobile number."),M&&be?.(!1,X);return}f=j,q(j)}ie(""),He(!0),M&&be?.(!0,X);try{if(M&&Ce.current==="basic"&&(y==="mobile"||y==="vehicle")){let W=!1;const _=(J=[])=>{if(W||!J.length)return!1;const je=[...J].sort((yt,rt)=>{const Mt=Ae(rt)-Ae(yt);return Mt!==0?Mt:Oe(rt)-Oe(yt)})[0];return!je||Ae(je)<=0?!1:(W=!0,Je(je),!0)},ge=ut(f,y).then(J=>{const xe=(J?.rows||[]).map(je=>je?.payload||je).filter(Boolean);return _(xe),xe}).catch(J=>(console.warn("Inline jobcard fetch failed:",J),[])),ze=st(f,y).then(J=>{const xe=(J?.rows||[]).map(je=>je?.payload||je).filter(Boolean);return _(xe),xe}).catch(J=>(console.warn("Inline booking fetch failed:",J),[])),[_e,ft]=await Promise.allSettled([ge,ze]);if(!W){const J=[_e,ft].flatMap(xe=>xe.status==="fulfilled"&&Array.isArray(xe.value)?xe.value:[]);_(J)||(et({source:X}),Q([]))}return}const j=await ut(f,y);if(!j)throw new Error("No result");if(j.mode==="webhook"){const W=j.rows||[];if(!W.length){et({source:X}),Q([]);return}const _=W.map(ge=>ge?.payload||ge);if(ce){const ge=[..._].sort((ze,_e)=>Oe(_e)-Oe(ze));Je(ge[0]);return}if(_.length===1){const ge=_[0];Je(ge);return}Q(_.slice(0,10)),x.info(`Found ${W.length} matches. Pick one.`);return}const w=j.rows;let v=[];if(y==="jc")v=w.filter(W=>I(W,O.JCNo)===H);else{const W=Ye(H)||H.replace(/\D/g,"");v=w.filter(_=>{const ge=Ye(I(_,O.Mobile));return W?W.length<10?ge.endsWith(W):ge===W:!1})}if(!v.length){et({source:X}),Q([]);return}if(v.sort((W,_)=>Ve(_).valueOf()-Ve(W).valueOf()),ce){pt(v[0]);return}if(v.length===1){pt(v[0]);return}Q(v.slice(0,10)),x.info(`Found ${v.length} matches. Pick one.`)}catch(j){console.error(j),x.error("Could not fetch job cards. Check the Apps Script/CSV link.")}finally{He(!1),M&&be?.(!1,X)}},wt=l.useRef("");return l.useEffect(()=>{const o=String(G?.query||"").trim();if(!o)return;const r=G?.mode==="vehicle"||G?.mode==="jc"?G.mode:"mobile",a=`${r}:${o}:${G?.token||""}`;if(wt.current===a)return;wt.current=a,De(r),q(o);const m=G?.openModal!==!1;A(m),setTimeout(()=>{gt(o,r,G?.prefill,{autoPickLatest:G?.autoPickLatest,source:G?.source})},0)},[G]),e.jsxs(e.Fragment,{children:[e.jsx(se,{type:"primary",style:{background:"#52c41a",borderColor:"#52c41a"},onClick:()=>{ie(""),A(!0)},children:"Fetch Details"}),e.jsx(Nt,{title:"Fetch Job Card",open:b,onCancel:()=>{A(!1),Q([]),ie("")},footer:[e.jsx(se,{onClick:()=>{A(!1),Q([]),ie("")},children:"Close"},"close"),e.jsx(se,{type:"primary",loading:Be,onClick:()=>gt(),children:"Search"},"search")],children:e.jsxs(Vo,{direction:"vertical",style:{width:"100%"},children:[e.jsxs(Wt.Group,{value:ae,onChange:o=>{De(o.target.value),q("")},children:[e.jsx(Wt.Button,{value:"mobile",children:"By Mobile"}),e.jsx(Wt.Button,{value:"vehicle",children:"By Vehicle No"}),e.jsx(Wt.Button,{value:"jc",children:"By JC No"})]}),e.jsx(ye,{placeholder:ae==="vehicle"?"Enter Vehicle No (KA03AB1234)":ae==="jc"?"Enter JC No":"Enter Mobile (10-digit)",value:Pe,inputMode:ae==="vehicle"||ae==="jc"?"text":"numeric",onChange:o=>{const r=o.target.value||"";if(ae==="vehicle"){const a=r.toUpperCase().replace(/[^A-Z0-9]/g,"");if(!Zt(a))return;q(a)}else if(ae==="jc")q(String(r||"").toUpperCase());else{const a=String(r||"").replace(/\D/g,"").slice(0,10);q(a)}},onPressEnter:()=>gt(),allowClear:!0}),Ie&&e.jsx(Js,{type:"warning",showIcon:!0,message:Ie}),Be&&e.jsx(zs,{}),Ee.length>1&&e.jsx(Gt,{size:"small",bordered:!0,dataSource:Ee,renderItem:o=>{const r=o&&o.formValues,a=r?o.formValues:null,m=r?a.jcNo||"â€”":I(o,O.JCNo)||"â€”",y=r?a.custName||"â€”":I(o,O.CustName)||"â€”",B=r?String(a.custMobile||"").replace(/\D/g,"").slice(-10)||"â€”":Ye(I(o,O.Mobile))||"â€”",ce=r?a.regNo||"â€”":I(o,O.RegNo)||"â€”",X=r?Ft(a.expectedDelivery):null,M=r?X?X.format("DD-MM-YYYY HH:mm"):a.expectedDelivery||"-":Ve(o).format("DD-MM-YYYY HH:mm");return e.jsx(Gt.Item,{role:"button",tabIndex:0,onClick:()=>ht(o),onKeyDown:p=>{(p.key==="Enter"||p.key===" ")&&ht(o)},style:{cursor:"pointer"},actions:[e.jsx(se,{type:"link",onClick:p=>{p.stopPropagation(),ht(o)},children:"Use"})],children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",width:"100%"},children:[e.jsxs("div",{children:[e.jsx("b",{children:"JC:"})," ",m," Â  ",e.jsx("b",{children:"Name:"})," ",y]}),e.jsxs("div",{children:[e.jsx("b",{children:"Mobile:"})," ",B," Â  ",e.jsx("b",{children:"Vehicle:"})," ",ce]}),e.jsxs("div",{style:{gridColumn:"1 / span 2",color:"#999"},children:[e.jsxs("b",{children:[r?"Expected Delivery":"Timestamp",":"]})," ",M]})]})})}})]})})]})}const{Title:Bo,Text:Is}=Oo,{Option:Or}=zt,Ho="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",Ue=Ho,_s="",Wo=["Byadarahalli","Kadabagere","Muddinapalya","Andrahalli","Tavarekere","Hegganahalli","Channenahalli","Nelagadrahalli"],us=[{name:"Rukmini",phone:"9901678562"},{name:"Meghana",phone:"9741609799"},{name:"Shubha",phone:"8971585057"},{name:"Rani",phone:"9108970455"},{name:"Likhitha",phone:"9535190015"},{name:"Vanitha",phone:"9380729861"},{name:"Prakash",phone:"9740176476"},{name:"Swathi",phone:"6363116317"},{name:"Kumar",phone:"7975807667"},{name:"Sujay",phone:"7022878048"},{name:"Kavi",phone:"9108970455"},{name:"Narasimha",phone:"9900887666"},{name:"Kavya",phone:"8073165374"}],$s=["Free","Paid","Minor","Accidental"],Bs=["Motorcycle","Scooter"],Hs=["SONU","KARTHIK","MANMOHAN","MANSUR","IRSHAD","DAKSHAT","SALMAN"],Ws={SONU:"7033558306",KARTHIK:"7338386813",MANMOHAN:"9956079799",MANSUR:"7795047627",IRSHAD:"6207176821",DAKSHAT:"7829096931",SALMAN:"7892335161"},Gs=i=>{const h=String(i||"").trim();return h&&(Ws[h]||Ws[h.toUpperCase()])||""},Ko=["Empty","Â¼","Â½","Â¾","Full"],ct=0,Ks={Scooter:{base:[{desc:"Engine oil",rate:450},{desc:"Consumables",rate:70},{desc:"Gearbox oil",rate:80}]},Motorcycle:{base:[{desc:"Engine oil",rate:450},{desc:"Consumables",rate:80},{desc:"Chain lubrication",rate:70}]},paidAddons:[{desc:"Service Labour",rate:400},{desc:"Water wash",rate:150}]},qo="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYGuNPY_2ivfS7MTX4bWiu1DWdF2mrHSCnmTznZVEHxNmsrgcGWjVZN4UDUTOzQQdXTnbeM-ylCJbB/pub?gid=408799621&single=true&output=csv",Jo=i=>{const h=[];let n=[],S="",K=!1;for(let $=0;$<i.length;$++){const F=i[$],V=i[$+1];if(F==='"'&&!K){K=!0;continue}if(F==='"'&&K){if(V==='"'){S+='"',$++;continue}K=!1;continue}if(F===","&&!K){n.push(S),S="";continue}if((F===`
`||F==="\r")&&!K){(S!==""||n.length)&&(n.push(S),h.push(n),n=[],S=""),F==="\r"&&V===`
`&&$++;continue}S+=F}return(S!==""||n.length)&&(n.push(S),h.push(n)),h},ps={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"]},hs=(i,h)=>String(h.map(n=>i[n]??"").find(n=>n!=="")||"").trim(),zo=(i={})=>({company:hs(i,ps.company),model:hs(i,ps.model),variant:hs(i,ps.variant)}),Go=(i={})=>({company:String(i["Company Name"]||i.company||"").trim(),model:String(i["Model Name"]||i.model||"").trim(),variant:String(i.Variant||i.variant||"").trim()});async function qs(i,h,n){try{const S=await Fo(i,h,n);if(S?.success&&S?.serial)return String(S.serial)}catch(S){console.warn("Reserve JC serial failed; falling back to timestamp:",S?.message||S)}return E().format("YYMMDDHHmmss")}function Zo(i){const h=String(i||"").toUpperCase();return h.length>10||!/^[A-Z0-9]*$/.test(h)?!1:[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(S=>S.test(h))}function Xe(i,h=""){const n=String(i||"").toUpperCase().replace(/[^A-Z0-9]/g,"");return Zo(n)?n.slice(0,10):h||""}const qt=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,oe=i=>typeof i=="string"?i.toUpperCase():i,Pt=i=>oe(i?.target?.value??i),Qo=i=>String(i||"").toUpperCase().replace(/[^A-Z\s]/g,"").replace(/\s+/g," ").trimStart(),Xo=i=>Qo(i?.target?.value??i),er={validator:async(i,h)=>{const n=String(h||"").trim();if(!n)return Promise.resolve();if(n.startsWith("="))throw new Error("Name cannot start with =");if(/[^A-Z\s]/.test(n))throw new Error("Name can contain only letters and spaces")}},gs=i=>Array.isArray(i)?i.map(h=>({...h,desc:oe(h?.desc||"")})):[],Yt=i=>String(i||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20);function Jt(i,h){if(!i||!h)return[];const n=String(i||"").toLowerCase(),S=n==="paid";if(!S&&!(n==="free"))return[];const F=(Ks[h]?.base??[]).map(V=>({desc:oe(V.desc),qty:1,rate:V.rate}));return S&&F.push(...Ks.paidAddons.map(V=>({desc:oe(V.desc),qty:1,rate:V.rate}))),F}const $e=i=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(Math.max(0,Math.round(Number(i||0)))),fs={locked:!1,at:null,mobile:null,amount:null,mode:null};async function tr(i){const h=await lt({webhookUrl:Ue,method:"POST",payload:{action:"save",data:i}});return h?.data||h}function Zs(){try{const i=localStorage.getItem("user"),h=i?JSON.parse(i):null,n=String(h?.phone||"").replace(/\D/g,"");return n.length===10?`+91${n}`.replace("+",""):n.length===12&&n.startsWith("91")?n:""}catch{return""}}function ys(i){const h=String(i||"").replace(/\D/g,"");return h.length===10?`91${h}`:h.length===12&&h.startsWith("91")?h:""}function sr(i,h){const n=i?.expectedDelivery?E(i.expectedDelivery).format("DD-MM-YYYY HH:mm"):"â€”",S=i?.createdAt?E(i.createdAt).format("DD-MM-YYYY HH:mm"):"â€”",K=Zs(),$=i?.branch||"â€”",F=(i?.custName?String(i.custName).trim():"")||"Customer",V=i?.jcNo||"â€”",re=i?.regNo||"â€”",le=$e(h?.grand??0),Ne=i?.obs?i.obs.split(`
`).map(b=>b.trim()).filter(Boolean):[],we=Ne.length?`*Customer Observations:*
${Ne.map(b=>`- ${b}`).join(`
`)}

`:"",ee=(i?.mechanic?String(i.mechanic).trim():"")||"",G=ee?Gs(ee):"",de=ee?`ðŸ‘· Assigned Mechanic: ${ee}${G?` (â˜Žï¸ ${G})`:""}
`:"",be=String($).toLowerCase().replace(/[^a-z]/g,""),Me=be.includes("byadarahalli")||be.includes("badrally"),me=Me?"NH Motors":"Shantha Motors";return`Hi ${F}! ðŸ‘‹

âœ… Your bike service is confirmed at ${me}.

Welcome to ${me},
${Me?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}à²—à³† à²¸à³à²µà²¾à²—à²¤ ðŸï¸âœ¨

ðŸ§¾ Job Card: ${V}
ðŸ•’ Job Card Created: ${S}
ðŸï¸ Vehicle: ${re}
ðŸ“… Delivery Date: ${n}
ðŸ’° Estimated Cost (à²…à²‚à²¦à²¾à²œà³ à²µà³†à²šà³à²š): ${le}

`+de+we+`â„¹ï¸ Final prices may vary based on actual service needs.

Need any help? Just reply here.

â€” ${i?.executive||"Team"}, ${$}${K?` (â˜Žï¸ ${K})`:""}`}function or(i){const h=(i?.custName?String(i.custName).trim():"")||"â€”",n=i?.custMobile?String(i.custMobile).replace(/\D/g,"").slice(-10):"â€”",S=(i?.model?String(i.model).trim():"")||"â€”",K=(i?.regNo?String(i.regNo).trim():"")||"â€”",$=(i?.serviceType?String(i.serviceType).trim():"")||"â€”",F=(i?.floorMat?String(i.floorMat).trim():"")||"â€”",V=i?.createdAt?E(i.createdAt).format("DD-MM-YYYY HH:mm"):"â€”",re=String(i?.km??"").toUpperCase().trim(),le=re.replace(/\s*KM\s*$/i,"").replace(/\D/g,""),Ne=le?`${le} KM`:re||"â€”",we=i?.obs?i.obs.split(`
`).map(G=>G.trim()).filter(Boolean):[],ee=we.length?we.map(G=>`â€¢ ${G}`).join(`
`):"â€¢ â€”";return["*Job Card Details (Mechanic)* ðŸ› ï¸","",`ðŸ•’ Job Card Created: ${V}`,`ðŸ‘¤ Customer Name: ${h}`,`ðŸ“ž Mobile Number: ${n}`,`ðŸ”§ Model: ${S}`,`ðŸï¸ Vehicle Number: ${K}`,`ðŸ§¼ Floor Mat: ${F}`,`ðŸ› ï¸ Service Type: ${$}`,`ðŸ§¾ Odometer Rating: ${Ne}`,"","*Customer Observation:*",ee].join(`
`)}function bs({mobileE164:i,text:h,onFailToWhatsApp:n,allowSmsFallback:S=!0}){const K=`https://wa.me/${i}?text=${encodeURIComponent(h)}`,$=window.open(K,"_blank","noopener,noreferrer");if(!$||$.closed||typeof $.closed>"u"){if(n?.(),S){const V=`sms:+${i}?body=${encodeURIComponent(h)}`;window.location.href=V}return{opened:!1,blocked:!0}}return S?(setTimeout(()=>{try{if($.closed)return;n?.(),$.close();const V=`sms:+${i}?body=${encodeURIComponent(h)}`;window.location.href=V}catch{n?.();const V=`sms:+${i}?body=${encodeURIComponent(h)}`;window.location.href=V}},1e3),{opened:!0,blocked:!1}):{opened:!0,blocked:!1}}function rr(i,h,n,S={}){const K=i?.jcNo||"â€”",$=i?.regNo||"â€”",F=i?.model||"",V=i?.colour?String(i.colour).trim():"",re=i?.km?String(i.km).replace(/\D/g,""):"",le=i?.branch||"â€”",Ne=i?.executive||"Team",we=Zs(),ee=String(le).toLowerCase().replace(/[^a-z]/g,""),G=ee.includes("byadarahalli")||ee.includes("badrally"),de=G?"NH Motors":"Shantha Motors",be=G?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³",Me=E().format("DD-MM-YYYY HH:mm"),me=ue=>String(ue).replace(/\s+/g," ").trim(),ne=ue=>$e(Math.round(Number(ue||0))),b=(n||[]).map((ue,dt)=>{const O=Number(ue?.qty||0),I=Number(ue?.rate||0),Ke=O*I,N=String(ue?.desc||"").trim()||"Item";return`${dt+1}. ${me(N)} â€” ${O} Ã— ${ne(I)} = ${ne(Ke)}`}),A=ne(h?.labourSub||0),ae=Math.max(0,Math.round(Number(h?.labourDisc||0))),De=ne(ae),Pe=ne(h?.grand||0),q=S||{},Be=ne(q?.collectedAmount||0),He=q?.cashCollected?ne(q.cashCollected):"",Ee=q?.onlineCollected?ne(q.onlineCollected):"",Q=Array.isArray(q?.payments)?q.payments.filter(ue=>String(ue.mode).toLowerCase()==="online"&&ue.utr).map(ue=>String(ue.utr).trim()).filter(Boolean).join(" / "):"",Ie=q?.paymentMode?String(q.paymentMode).toUpperCase():"";let ie="";const Fe=Number(re||"");Number.isFinite(Fe)&&Fe>0&&(ie=String(Fe+2e3));const We=ae>0?`Discount: ${De}`:"",Ce=`ðŸ’³ *Mode Of Payment (${Ie||"NA"})*`,he=[];He&&he.push(`â€¢ Cash: ${He}`),Ee&&he.push(`â€¢ Online: ${Ee}${Q?` (UTR: ${Q})`:""}`),he.length?he.push(`â€¢ Total Paid: ${Be}`):he.push(`â€¢ Total Paid: ${Be}`);const jt=[Ce,...he];return[`â­ï¸ *${de}* â€” ${be}`,"Multi Brand Two Wheeler Sales & Service","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","*âœ”ï¸ Service Invoice*","",`ðŸ“… Date: ${Me}`,`ðŸ§¾ JC No: ${K}`,"","ðŸï¸ *Vehicle Details*",`â€¢ Vehicle: ${$}${F?` (${F})`:""}${V?` â€¢ ${V}`:""}`,...re?[`â€¢ Odometer Reading: ${re} km`]:[],...ie?[`â€¢ *Next Service Due:* ${ie} km`]:[],"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","","ðŸ› ï¸ *Service Details*",...b.length?b.map(ue=>`â€¢ ${ue}`):["â€¢ â€”"],"",`Subtotal: ${A}`,...We?[We]:[],`ðŸ’° *Final Bill Amount:* ${Pe}`,"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","",...jt,"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","",`ðŸ™ Thank you for choosing *${de}*!`,"à²§à²¨à³à²¯à²µà²¾à²¦à²—à²³à³ â¤ï¸",`â€” ${Ne}, ${le}${we?` (â˜Žï¸ ${we})`:""}`].join(`
`)}function Lr({initialValues:i=null}={}){const h=Do(),[n]=k.useForm(),[,S]=l.useState(),[K,$]=l.useState(""),[F,V]=l.useState(""),[re,le]=l.useState([]),[Ne,we]=l.useState(!1),[ee,G]=l.useState(""),[de,be]=l.useState(""),[Me,me]=l.useState(""),[ne,b]=l.useState([]),A="JobCard:outbox",ae=6e3,De=l.useRef({jcNo:"",ts:0,inFlight:!1}),Pe=s=>{const t=De.current;t.jcNo===s&&(t.inFlight=!1)},q=(s,t)=>{try{const d=localStorage.getItem(s);return d?JSON.parse(d):t}catch{return t}},Be=(s,t)=>{try{localStorage.setItem(s,JSON.stringify(t))}catch{}},He=s=>{const t=q(A,[]),d={id:Date.now()+":"+Math.random().toString(36).slice(2),job:s};return t.push(d),Be(A,t),d.id},Ee=s=>{const t=q(A,[]);Be(A,t.filter(d=>d.id!==s))},[Q,Ie]=l.useState(""),[ie,Fe]=l.useState(null),[We,Ce]=l.useState(null),[he,jt]=l.useState(!1),[Rt,ue]=l.useState(""),dt=l.useRef(null),O=l.useRef(null),[I,Ke]=l.useState(!1),[N,Ye]=l.useState(!1),[Re,Et]=l.useState(!1),[Zt,et]=l.useState(!1),[Ft,Ve]=l.useState(1),[Ae,Oe]=l.useState({customer:!1,mechanic:!1,pre:!1}),[Qt,qe]=l.useState(!1),[Le,tt]=l.useState("cash"),[mt,Vt]=l.useState(""),[ut,Ot]=l.useState(""),[st,Xt]=l.useState("online"),[ot,pt]=l.useState(""),[Je,ht]=l.useState(""),[gt,wt]=l.useState(""),[o,r]=l.useState(fs),[a,m]=l.useState(0),[y,B]=l.useState(!1),[ce,X]=l.useState(!1),[M,p]=l.useState([]),[H,f]=l.useState(!1),[j,w]=l.useState(null),[v,W]=l.useState(null),[_,ge]=l.useState(!1),[ze,_e]=l.useState(null),ft=l.useRef(""),[J,xe]=l.useState([]),[je,yt]=l.useState(""),rt=(s=6e3)=>{const t=Date.now()+s;m(t),setTimeout(()=>m(0),s+50)},[,Mt]=l.useState(!1),[,vs]=l.useState(()=>E().add(2,"day").hour(10).minute(0).second(0).millisecond(0)),[,xs]=l.useState(""),Qs=["createdAt","branch","mechanic","executive","expectedDelivery","regNo","company","model","km","custName","custMobile","serviceType","vehicleType"],Ss=s=>{const t=[...Qs];return s?.vehicleType==="Scooter"&&t.push("floorMat"),String(s?.serviceType||"").toLowerCase()==="free"&&t.push("chassisNo"),t},Ns=async()=>{try{const s=q(A,[]);if(!Array.isArray(s)||!s.length)return;for(const t of s){const d=t.job||{};try{if(d.type==="save"&&Ue){const c=await lt({webhookUrl:Ue,method:"POST",payload:{action:"save",data:d.data}});(c?.data||c)?.success!==!1&&Ee(t.id)}else if(d.type==="post"&&Ue){const c=await lt({webhookUrl:Ue,method:"POST",payload:{action:"postService",data:d.data}});(c?.data||c)?.success!==!1&&Ee(t.id)}}catch{}}}catch{}};l.useEffect(()=>{setTimeout(()=>{Ns()},0)},[]),l.useEffect(()=>{const s=()=>Ns();return window.addEventListener("online",s),()=>window.removeEventListener("online",s)},[]);const nt=()=>{const s=n.getFieldsValue(!0),t=Ss(s),d=t.every(g=>{const C=n.getFieldValue(g);return C!=null&&String(C).trim()!==""}),c=n.getFieldsError(t).some(({errors:g})=>g.length>0);let u="";if(d)c&&(u="Fix validation errors in highlighted fields.");else{const g=t.filter(C=>{const L=n.getFieldValue(C);return L==null||String(L).trim()===""});g.length&&(u=`Missing: ${g.join(", ")}`)}jt(d&&!c),ue(u)},Xs=async()=>{const s=n.getFieldsValue(!0),t=Ss(s);await n.validateFields(t)},js=l.useMemo(()=>({jcNo:"",createdAt:E(),expectedDelivery:E(),branch:void 0,executive:void 0,mechanic:"",serviceType:void 0,vehicleType:void 0,floorMat:"No",fuelLevel:void 0,regNo:"",company:"",model:"",colour:"",chassisNo:"",km:void 0,custName:"",custMobile:"",obs:"",labourRows:[],gstLabour:ct,discounts:{labour:0}}),[]),ws=l.useMemo(()=>{try{const s=h?.search||"";if(!s)return null;const t=new URLSearchParams(s),d=Xe(t.get("regNo")||"",""),c=oe(t.get("company")||""),u=oe(t.get("model")||""),g=oe(t.get("colour")||t.get("color")||""),C=oe(t.get("custName")||t.get("customerName")||""),L=t.get("custMobile")||t.get("mobile")||"",P=Yt(t.get("chassisNo")||t.get("chassis")||"");return[d,c,u,g,P,C,L].some(R=>String(R||"").trim())?{formValues:{regNo:d,company:c,model:u,colour:g,chassisNo:P,custName:C,custMobile:String(L||"").replace(/\D/g,"").slice(-10)}}:null}catch{return null}},[h?.search]),eo=l.useMemo(()=>{try{const s=h?.search||"";if(!s)return null;const t=new URLSearchParams(s);if(!(t.get("autoFetch")||t.get("fetch")))return null;const c=t.get("query")||t.get("mobile")||t.get("custMobile")||t.get("jcNo")||t.get("jc")||"";if(!String(c||"").trim())return null;let u=t.get("mode")||"";return u||(t.get("jcNo")||t.get("jc")?u="jc":t.get("vehicle")||t.get("reg")?u="vehicle":u="mobile"),{mode:u,query:c}}catch{return null}},[h?.search]);l.useEffect(()=>{let s=!1;return(async()=>{try{const d=await fetch(qo,{cache:"no-store"});if(!d.ok)throw new Error("sheet fetch failed");const c=await d.text();if(c.trim().startsWith("<"))throw new Error("expected CSV, got HTML");const u=Jo(c);if(!u.length)throw new Error("empty sheet");const g=u[0].map(P=>(P||"").trim()),L=u.slice(1).map(P=>{const Y={};return g.forEach((R,Z)=>Y[R]=P[Z]??""),Y}).map(zo).filter(P=>P.company&&P.model);s||xe(L)}catch{try{const d=await fetch("/bikeData.json",{cache:"no-store"});if(!d.ok)throw new Error("fallback missing");const c=await d.json(),u=(Array.isArray(c)?c:[]).map(Go).filter(g=>g.company&&g.model);s||xe(u)}catch{}}})(),()=>{s=!0}},[]),l.useEffect(()=>{const s=i||ws;if(s)try{const t=s.formValues||s,d=z=>{if(!z)return E();const T=E(z,["DD-MM-YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY","YYYY-MM-DD",E.ISO_8601],!0);return T.isValid()?T:null},c=t.km?`${String(t.km).replace(/\D/g,"")} KM`:"",u=Xe(t.regNo||"",""),g=oe(t.company||""),C=oe(t.model||""),L=oe(t.colour||""),P=Yt(t.chassisNo||t.chassis||""),Y=oe(t.custName||""),R=oe((t.obs||"").replace(/\s*#\s*/g,`
`)),Z={jcNo:t.jcNo||"",branch:t.branch||void 0,mechanic:t.mechanic||void 0,executive:t.executive||void 0,expectedDelivery:d(t.expectedDelivery),regNo:u,company:g,model:C,colour:L,chassisNo:P,km:c,fuelLevel:t.fuelLevel||void 0,custName:Y,custMobile:String(t.custMobile||"").replace(/\D/g,"").slice(-10),obs:R,vehicleType:t.vehicleType||void 0,serviceType:t.serviceType||void 0,floorMat:t.floorMat==="Yes"?"Yes":t.floorMat==="No"?"No":void 0,discounts:{labour:0},gstLabour:ct,labourRows:gs(Array.isArray(i?.labourRows)&&i.labourRows.length?i.labourRows:Jt(t.serviceType,t.vehicleType))};n.setFieldsValue(Z),Ie(Z.regNo||""),g&&yt(g),Fe(t.serviceType||null),Ce(t.vehicleType||null)}catch{}},[i,ws]),l.useEffect(()=>{(async()=>{try{const s=u=>String(u||"").trim().toUpperCase(),t=()=>{try{const u=localStorage.getItem("user");return u?JSON.parse(u):null}catch{return null}},d=u=>u?typeof u=="string"?u:typeof u=="object"&&(u._id||u.id||u.$oid)||null:null;let c=t();if(!c||!c.formDefaults){const u=await To().catch(()=>null);if(u?.success&&u.data){c=u.data;try{localStorage.setItem("user",JSON.stringify(c))}catch(g){}}}if(c){const u=c?.formDefaults?.staffName||c?.name||void 0,g=u?s(u):void 0,C=c?.role?String(c.role).toLowerCase():void 0,L=!!c?.canSwitchBranch||["owner","admin","backend"].includes(String(C||"").toLowerCase());we(L);try{const z=String(C||"").toLowerCase();if(["owner","admin","backend"].includes(z)){try{const T=await Yo({status:"active",limit:500});if(T?.success&&Array.isArray(T?.data?.items)){const Te=T.data.items.filter(fe=>String(fe?.status||"").toLowerCase()==="active").map(fe=>({id:String(fe.id||fe._id||""),name:s(fe.name),code:fe.code?String(fe.code).toUpperCase():""}));le(Te)}}catch{}try{const T=await Ro({role:"staff",status:"active",limit:1e5});if(T?.success&&Array.isArray(T?.data?.items)){const te=T.data.items.map(Te=>({name:Te.name,phone:Te.phone||""}));b(te)}}catch{}}else{const T=[],te=pe=>{if(!pe)return;const Dt=typeof pe=="string"?"":String(pe?.status||"").toLowerCase();if(Dt&&Dt!=="active")return;const Tt=pe&&(pe._id||pe.id||pe.$oid||pe)||"",_t=typeof pe=="string"?"":pe?.name||"",St=s(_t),at=typeof pe=="string"?"":pe?.code||"";!Tt||!St||T.push({id:String(Tt),name:String(St),code:at?String(at).toUpperCase():""})};c?.primaryBranch&&te(c.primaryBranch),Array.isArray(c?.branches)&&c.branches.forEach(te);const Te=new Set,fe=[];T.forEach(pe=>{Te.has(pe.id)||(Te.add(pe.id),fe.push(pe))}),le(fe)}}catch{}let P=c?.formDefaults?.branchName?s(c.formDefaults.branchName):void 0;const Y=c?.formDefaults?.branchCode&&String(c.formDefaults.branchCode).toUpperCase()||"";if(Y){be(Y);try{n.setFieldsValue({branchCode:Y})}catch{}}const R=c?.formDefaults&&(c.formDefaults.branchId?._id||c.formDefaults.branchId||null)||c?.primaryBranch&&(c.primaryBranch?._id||c.primaryBranch||null)||Array.isArray(c?.branches)&&c.branches.length&&(c.branches[0]?._id||c.branches[0])||null;if(R)try{const z=await Eo(String(R)).catch(()=>null);if(z?.success&&z?.data&&(P||(P=z.data.name),z?.data?.code&&!de)){const T=String(z.data.code).toUpperCase();be(T),me(String(z.data.id||R));try{n.setFieldsValue({branchCode:T})}catch{}}}catch{}g&&S(g),C&&$(C);const Z={};try{const z=n.getFieldsValue(["branch","executive"])||{};!z?.executive&&g&&(Z.executive=g),!z?.branch&&P&&(Z.branch=P)}catch{}Object.keys(Z).length&&n.setFieldsValue(Z),P&&V(P),g&&G(g)}}catch{}})()},[n]);const to=ko.useMemo(()=>{const s=new Map;return(re||[]).forEach(t=>s.set(String(t.name||"").toLowerCase(),t)),s},[re]),so=s=>{try{const t=String(s||"").toLowerCase(),d=to.get(t);if(d){me(d.id),d.code&&be(String(d.code).toUpperCase());try{n.setFieldsValue({branch:d.name,branchCode:d.code?String(d.code).toUpperCase():void 0})}catch{}}}catch{}},bt=k.useWatch("branch",n),Ms=k.useWatch("executive",n),oo=String(bt||F||"").trim().toLowerCase().replace(/\s+/g,"").includes("byadarahalli");l.useEffect(()=>{const s={};!bt&&F&&(s.branch=F),!Ms&&ee&&(s.executive=ee),Object.keys(s).length&&n.setFieldsValue(s)},[bt,Ms,F,ee]);const Ct=l.useMemo(()=>{const s=String(K||"").toLowerCase();return["owner","admin","backend"].includes(s)?"":bt||F||""},[K,bt,F]),es=l.useMemo(()=>{const s=String(K||"").toLowerCase();return["owner","admin","backend"].includes(s)?!0:!!String(Ct||"").trim()},[K,Ct]),Lt=H?M.length:null,ro=s=>{const t=s?.values||s||{},d=s?.payload||t.Payload||t.payload||t.PAYLOAD||s?.Payload||s?.PAYLOAD||"";let c={};try{c=typeof d=="object"?d:JSON.parse(String(d||"{}"))}catch{c={}}const u=c.formValues||c.values||{},g=(Z,z)=>{for(const T of z){const te=Z?.[T];if(te!=null&&String(te).trim()!=="")return String(te).trim()}return""},C=c?.postServiceAt||t["Post Service At"]||t.Post_Service_At||t.PostServiceAt||"",L=Array.isArray(c?.payments)&&c.payments.some(Z=>Number(Z?.amount||0)>0),P=C||L?"completed":"pending";let Y=c?.followUp?.at||c?.followup?.at||c?.followUpAt||t["Follow-up At"]||t["Follow Up At"]||t["Followup At"]||t["Follow-up Date"]||t["Follow Up Date"]||t["Followup Date"]||"";if(!Y){const Z=t["Follow-up Date"]||t["Follow Up Date"]||t["Followup Date"]||"",z=t["Follow-up Time"]||t["Follow Up Time"]||t["Followup Time"]||"";Z&&z&&(Y=`${Z} ${z}`)}const R=Y?E(Y,["DD-MM-YYYY HH:mm","DD/MM/YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY",E.ISO_8601],!0):null;return{jcNo:u.jcNo||g(t,["JC No","JC No.","Job Card No","JC Number"])||"-",name:u.custName||g(t,["Customer Name","Customer_Name","Name"])||"-",mobile:String(u.custMobile||g(t,["Mobile","Mobile Number","Phone"])||"").replace(/\D/g,"").slice(-10),regNo:u.regNo||g(t,["Vehicle No","Vehicle_No","Reg No","Registration Number"])||"-",branch:u.branch||g(t,["Branch","Branch Name"])||"-",followUpAt:R&&R.isValid()?R.format("DD-MM-YYYY HH:mm"):Y||"",followUpNotes:c?.followUp?.notes||c?.followupNotes||c?.followUpNotes||t["Follow-up Notes"]||t["Follow Up Notes"]||t["Followup Notes"]||"",status:P,payload:c}},ts=async({silent:s=!1}={})=>{if(!es){p([]),f(!1);return}s||X(!0);try{const t={action:"list",status:"pending",page:1,pageSize:200},d=Ct?{branch:Ct}:{},c=_s?{...t,...d,secret:_s}:{...t,...d},u=await lt({webhookUrl:Ue,method:"GET",payload:c}),g=u?.data||u,P=(Array.isArray(g?.data)?g.data:Array.isArray(g?.rows)?g.rows:[]).map(ro).filter(Y=>Y&&Y.jcNo!=="-").filter(Y=>Y.status==="pending");p(P),f(!0)}catch{p([]),f(!0)}finally{s||X(!1)}};l.useEffect(()=>{if(!es){p([]),f(!1);return}p([]),f(!1),ts({silent:!0})},[es,Ct]);const no=s=>{const t=Xe(s.target.value,Q);Ie(t),n.setFieldsValue({regNo:t}),String(t||"").length<10&&(ft.current="")},ao=qt.test(Xe(Q||n.getFieldValue("regNo")||"",Q||"")),Cs=k.useWatch("labourRows",n),Ge=l.useMemo(()=>gs(Cs||[]),[Cs]),As=k.useWatch("gstLabour",n)??ct,Ds=k.useWatch("discounts",n),Ts=l.useMemo(()=>Ds||{labour:0},[Ds]),io=k.useWatch("km",n),vt=k.useWatch("company",n);l.useEffect(()=>{const s=Xe(Q||n.getFieldValue("regNo")||"",Q||"");String(s||"").length<10||qt.test(s)&&(_||ft.current!==s&&(ft.current=s,rs("vehicle")))},[Q,_,n]);const Se=l.useMemo(()=>{const s=Ge.reduce((u,g)=>u+Number(g?.qty||0)*Number(g?.rate||0),0),t=s*(Number(As)/100),d=Number(Ts.labour||0),c=Math.max(0,s+t-d);return{labourSub:s,labourGST:t,labourDisc:d,grand:c}},[Ge,As,Ts]),co=l.useMemo(()=>Vs(J.map(s=>s.company)),[J]),lo=l.useMemo(()=>{const s=Os(vt||je),t=s?J.filter(d=>Os(d.company)===s):J;return Vs(t.map(d=>d.model))},[J,vt,je]);l.useEffect(()=>{vt&&vt!==je&&yt(vt)},[vt,je]);const ks=l.useMemo(()=>{const s=o.at;if(!s)return"";const t=E(s);return t.isValid()?t.format("DD-MM-YYYY HH:mm"):String(s)},[o.at]),ve=!!o.locked,ss=l.useMemo(()=>{const s=Number(mt||0)||0,t=Number(ot||0)||0;return Math.round(s+t)},[mt,ot]),os=l.useMemo(()=>Math.round(Number(Se?.grand||0)),[Se]),xt=l.useMemo(()=>os-ss,[ss,os]),mo=s=>{/[0-9]/.test(s.key)||s.preventDefault()},uo=s=>{/[0-9]/.test(s.key)||s.preventDefault()},po=s=>{const t=s.target.value;/^\d*$/.test(t)&&(t.length>10||(o.locked&&o.mobile&&o.mobile!==t&&r(fs),n.setFieldsValue({custMobile:t})))},Ut=(Number(String(io||"").replace(/\D/g,""))||0)>1e4,rs=s=>{if(s==="vehicle"){const d=Q||n.getFieldValue("regNo")||"",c=Xe(d,Q||"");if(!qt.test(c)){x.warning("Enter vehicle no. as KA03AB1234.");return}_e("vehicle"),ge(!0),W({mode:"vehicle",query:c,token:Date.now(),prefill:"basic",autoPickLatest:!0,openModal:!1,source:"inline"});return}const t=String(n.getFieldValue("custMobile")||"").replace(/\D/g,"").slice(-10);if(t.length!==10){x.warning("Enter a valid 10-digit mobile number.");return}_e("mobile"),ge(!0),W({mode:"mobile",query:t,token:Date.now(),prefill:"basic",autoPickLatest:!0,openModal:!1,source:"inline"})},ho=$s.map(s=>({label:s,value:s,disabled:s==="Free"&&Ut})),At=(s={})=>{const t={...s};return t.regNo=Xe(t.regNo||""),t.company=oe(t.company||""),t.model=oe(t.model||""),t.colour=oe(t.colour||""),t.chassisNo=Yt(t.chassisNo||t.chassis||""),t.custName=oe(t.custName||""),t.obs=oe(t.obs||""),t.labourRows=gs(t.labourRows||[]),t},go=s=>{let t=null;if(s.length===0?t=null:s.length===1?t=s[0]:t=s.find(d=>d!==ie)||s[0],Ut&&t==="Free"){x.warning("Free service is not allowed above 10,000 KM.");return}if(Fe(t||null),n.setFieldsValue({serviceType:t||void 0}),t){const d="Motorcycle";Ce(d),n.setFieldsValue({vehicleType:d,labourRows:Jt(t,d),gstLabour:ct,discounts:{labour:0},floorMat:"No"}),x.success(`Applied preset: ${t} / ${d}`)}else n.setFieldsValue({labourRows:[]});nt()};l.useEffect(()=>{Ut&&ie==="Free"&&(Fe(null),n.setFieldsValue({serviceType:void 0}),nt(),x.warning("Free service disabled for odometer above 10,000 KM."))},[Ut,ie,n]),l.useEffect(()=>{nt()},[]);const Ps=async s=>{Date.now()<a||(rt(6e3),await new Promise(requestAnimationFrame),s==="pre"?await Fs(dt.current):s==="post"&&await Fs(O.current))},fo=s=>s?E(s).format("DD-MM-YYYY HH:mm"):"",ns=" # ",as=async()=>{try{await Xs();const s=At(n.getFieldsValue(!0));let t=s.jcNo;if(!/^JC-[A-Z]+-[A-Z0-9]{6}$/.test(String(t||"").trim())){try{t=await qs(s.custMobile,de||(n.getFieldValue("branchCode")||"").toUpperCase(),Me)}catch{t=E().format("YYMMDDHHmmss")}n.setFieldsValue({jcNo:t}),x.success(`JC No. assigned: ${t}`)}const c=De.current,u=Date.now();if(c.jcNo===t&&(c.inFlight||u-c.ts<ae))return;c.jcNo=t,c.ts=u,c.inFlight=!0;const g=Number.isFinite(Se.grand)?Math.round(Se.grand):0,C=String(s.km||"").replace(/\D/g,""),L=typeof s.floorMat=="string"?s.floorMat:s.floorMat===!0?"Yes":(s.floorMat===!1,"No"),P=String(s.obs||"").replace(/\s*\r?\n\s*/g,ns).replace(new RegExp(`^(?:\\s*${ns}\\s*)+|(?:\\s*${ns}\\s*)+$`,"g"),"").trim(),Y=new Date().toISOString(),R=s.savedAt||n.getFieldValue("savedAt")||s.createdAt,z=(typeof R=="string"&&R.trim()?R:E.isDayjs(R)||R instanceof Date&&!isNaN(R.getTime())?R.toISOString():"")||Y;try{n.setFieldsValue({savedAt:z})}catch{}const T={savedAt:z,updatedAt:Y,formValues:{jcNo:t,branch:s.branch||"",mechanic:s.mechanic||"",executive:s.executive||"",expectedDelivery:fo(s.expectedDelivery),regNo:s.regNo||"",company:s.company||"",model:s.model||"",colour:s.colour||"",chassisNo:s.chassisNo||"",km:C||"",fuelLevel:s.fuelLevel||"",custName:String(s.custName||"").trim(),custMobile:String(s.custMobile||""),obs:P,vehicleType:s.vehicleType||"",serviceType:s.serviceType||"",floorMat:L,amount:String(g)},labourRows:Ge||[],totals:Se};x.success({content:"Saved successfully",key:"autosave",duration:1.5});const te={jcNo:t,formValues:T.formValues,payload:T},Te=He({type:"save",data:te});setTimeout(async()=>{try{const fe=await tr(te);(fe?.data||fe)?.success!==!1&&Ee(Te)}catch{}finally{Pe(t)}},0)}catch(s){if(s?.errorFields)x.error("Please complete required fields before auto-saving.");else{const t=s?.response?.data?.message||s?.message||"Failed to auto-save. Please try again.";x.error(t)}throw s}},is=async s=>{if(ve){x.warning("Post-service already completed for this Job Card. Editing is locked.");return}try{if(Et(!0),await new Promise(D=>setTimeout(D,0)),Date.now()<a)return;rt(6e3);const t=At(n.getFieldsValue(!0)),d=String(t.custMobile||"").replace(/\D/g,"").slice(-10);if(d.length!==10){x.error("Enter a valid 10-digit mobile number.");return}let c=t.jcNo;if(!/^JC-[A-Z]+-[A-Z0-9]{6}$/.test(String(c||"").trim()))try{c=await qs(t.custMobile,de||(n.getFieldValue("branchCode")||"").toUpperCase(),Me),n.setFieldsValue({jcNo:c})}catch(D){}const g=Number.isFinite(Se.grand)?Math.round(Se.grand):0,C=String(t.km||"").replace(/\D/g,""),L=typeof t.floorMat=="string"?t.floorMat:t.floorMat===!0?"Yes":(t.floorMat===!1,"No"),P=String(t.obs||"").replace(/\s*\r?\n\s*/g," # ").trim(),Y=String(gt||"").trim(),R=Number(mt||0)||0,Z=Number(ot||0)||0;if(!(R>0||Z>0)){x.error("Enter amount for Cash or Online (at least one).");return}if(Le==="online"&&R>0&&String(ut||"").trim().length<4){x.error("Enter UTR for Online (Slot 1).");return}if(st==="online"&&Z>0&&String(Je||"").trim().length<4){x.error("Enter UTR for Online (Slot 2).");return}const T=[];R>0&&T.push({amount:Math.round(R),mode:Le,...Le==="online"?{utr:String(ut||"").trim()}:{}}),Z>0&&T.push({amount:Math.round(Z),mode:st,...st==="online"?{utr:String(Je||"").trim()}:{}});const te=T.reduce((D,ke)=>D+(Number(ke.amount)||0),0),Te=Array.from(new Set(T.map(D=>D.mode))),fe=Te.length>1?"mixed":Te[0]||"",Dt=T.filter(D=>D.mode==="online"&&D.utr).map(D=>D.utr).join(" / "),Tt=T.filter(D=>String(D.mode).toLowerCase()==="cash").reduce((D,ke)=>D+(Number(ke.amount)||0),0),_t=T.filter(D=>String(D.mode).toLowerCase()==="online").reduce((D,ke)=>D+(Number(ke.amount)||0),0),St=Math.round(Number(g||0));if(te!==St){const D=St-te,ke=`Payable: â‚¹${St}. Collected: â‚¹${te}. ${D>0?"Pending":"Excess"}: â‚¹${Math.abs(D)}.`;try{Nt.warning({title:"Please collect full amount",content:ke})}catch{}x.error(`Please collect full amount. ${ke}`);return}const at=new Date().toISOString(),Ze=t.savedAt||n.getFieldValue("savedAt")||t.createdAt,Rs=(typeof Ze=="string"&&Ze.trim()?Ze:E.isDayjs(Ze)||Ze instanceof Date&&!isNaN(Ze.getTime())?Ze.toISOString():"")||at;try{n.setFieldsValue({savedAt:Rs})}catch{}const wo={savedAt:Rs,updatedAt:at,postServiceAt:at,formValues:{mechanic:t.mechanic||"",executive:t.executive||"",company:t.company||"",model:t.model||"",colour:t.colour||"",chassisNo:t.chassisNo||"",km:C||"",fuelLevel:t.fuelLevel||"",vehicleType:t.vehicleType||"",floorMat:L,expectedDelivery:t.expectedDelivery?E(t.expectedDelivery).format("DD-MM-YYYY HH:mm"):"",obs:P,remarks:Y},labourRows:Ge||[],totals:Se};x.success({key:"postsave",content:"Saved successfully"});const Mo=t.expectedDelivery?E(t.expectedDelivery).format("DD-MM-YYYY HH:mm"):"",Es={mobile:d,jcNo:c,serviceAmount:g,collectedAmount:te,paymentMode:fe,payments:T,utr:Dt||void 0,utrNo:Dt||void 0,remarks:Y,payload:{...wo,payments:T,remarks:Y},formValues:{custName:String(t.custName||""),custMobile:d,branch:String(t.branch||""),executive:String(t.executive||""),regNo:String(t.regNo||""),company:String(t.company||""),serviceType:String(t.serviceType||""),vehicleType:String(t.vehicleType||""),mechanic:String(t.mechanic||""),model:String(t.model||""),colour:String(t.colour||""),chassisNo:String(t.chassisNo||""),km:C||"",fuelLevel:String(t.fuelLevel||""),expectedDelivery:Mo,obs:P,remarks:Y},source:"jobcard",cashCollected:Tt,onlineCollected:_t,totalCollected:te};r({locked:!0,at,mobile:d,amount:te,mode:fe||null});const Co=He({type:"post",data:Es});if(setTimeout(async()=>{try{let D=!0;if(Ue){const ke=await lt({webhookUrl:Ue,method:"POST",payload:{action:"postService",data:Es}});D=(ke?.data||ke)?.success!==!1}D&&Ee(Co)}catch{}},0),s===!0||s==="print")await new Promise(D=>setTimeout(D,50)),await Ps("post");else if(s==="whatsapp")try{const D=ys(t.custMobile);if(!D)x.error("Enter a valid 10-digit mobile number (India).");else{const Ao=rr(t,Se,Ge,{payments:T,collectedAmount:te,cashCollected:Tt,onlineCollected:_t,paymentMode:fe});x.loading({key:"postshare",content:"Preparing WhatsApp messageâ€¦"}),bs({mobileE164:D,text:Ao,onFailToWhatsApp:()=>{x.info({key:"postshare",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2})}}),setTimeout(()=>{x.success({key:"postshare",content:"Ready to send.",duration:2})},800)}}catch{}Ke(!1),Vt(""),Ot(""),pt(""),ht(""),wt("");try{n.resetFields();const D={...js,createdAt:E(),expectedDelivery:null,branch:F||void 0,executive:ee||void 0,jcNo:"",labourRows:[],discounts:{labour:0},gstLabour:ct};n.setFieldsValue(D),Fe(null),Ce(null),Ie(""),Mt(!1),vs(null),xs(""),r(fs),Oe({customer:!1,mechanic:!1,pre:!1}),Ve(1),qe(!1),et(!1),nt(),x.success("Ready for the next Job Card")}catch{}}catch(t){console.warn("post-service save error:",t),x.error(t&&t.message||"Could not save post-service details.")}finally{Et(!1)}},It=At(n.getFieldsValue(!0)),yo=[...(Ge||[]).map(s=>s.desc),...It?.obs?It.obs.split(`
`).map(s=>s.trim()).filter(Boolean):[]],cs=s=>({display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,padding:"12px 14px",border:"1px solid #e5e7eb",borderRadius:8,background:Ft===s?"#f0fdf4":"#fff"}),bo=async(s={})=>{const t=s&&typeof s.preventDefault=="function"?{}:s||{},d=t.allowSmsFallback!==!1,c=t.onPopupBlocked;try{if(Date.now()<a)return;rt(6e3),await as();const u=At(n.getFieldsValue(!0));await n.validateFields(["custName","custMobile","branch"]);const g=ys(u.custMobile);if(!g){x.error("Enter a valid 10-digit mobile number (India).");return}const C=sr(u,Se);x.loading({key:"share",content:"Preparing WhatsApp messageâ€¦"});const L=bs({mobileE164:g,text:C,allowSmsFallback:d,onFailToWhatsApp:()=>{d&&x.info({key:"share",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2}),c?.()}});return setTimeout(()=>{x.success({key:"share",content:"Ready to send.",duration:2})},800),L}catch{return null}},Ys=async(s={})=>{const t=s&&typeof s.preventDefault=="function"?{}:s||{},d=t.allowSmsFallback!==!1,c=t.onPopupBlocked,u=t.skipCooldown===!0;try{if(!u&&Date.now()<a)return;u||rt(6e3),await as();const g=At(n.getFieldsValue(!0));await n.validateFields(["mechanic"]);const C=String(g.mechanic||"").trim(),L=Gs(C),P=ys(L);if(!P){x.error(C?`No phone number found for mechanic ${C}.`:"Select a mechanic with a saved phone number.");return}const Y=or(g);x.loading({key:"mechshare",content:"Preparing mechanic WhatsApp messageâ€¦"});const R=bs({mobileE164:P,text:Y,allowSmsFallback:d,onFailToWhatsApp:()=>{d&&x.info({key:"mechshare",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2}),c?.()}});return setTimeout(()=>{x.success({key:"mechshare",content:"Ready to send.",duration:2})},800),R}catch{return null}},vo=async()=>{let s=!1;try{Ye(!0),await new Promise(t=>setTimeout(t,0)),await as(),await Ps("pre"),s=!0}catch{}finally{Ye(!1)}return s},xo=()=>{qe(!1),Ve(()=>Ae.customer?Ae.mechanic?3:2:1),et(!0)},So=async()=>{if(!he||a>Date.now()||(qe(!1),!await bo()))return;const t=!Ae.mechanic;if(Oe(c=>({...c,customer:!0})),Ve(t?2:3),!t)return;(await Ys({allowSmsFallback:!1,onPopupBlocked:()=>qe(!0),skipCooldown:!0}))?.opened&&(Oe(c=>({...c,mechanic:!0})),Ve(3))},No=async()=>{!he||(qe(!1),!await Ys({skipCooldown:!0}))||(Oe(t=>({...t,mechanic:!0})),Ve(3))},jo=async()=>{if(!he||N)return;await vo()&&Oe(t=>({...t,pre:!0}))};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        .wrap { max-width: 1000px; margin: 12px auto; padding: 0 12px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
        /* Make header actions stack on small screens */
        @media screen and (max-width: 600px) {
          .brand-actions-row { grid-template-columns: 1fr !important; row-gap: 8px; }
          .brand-actions { align-items: flex-start !important; }
        }
        .print-sheet { display: none; }
        @media print { .print-sheet { display: block; } .no-print { display: none !important; } }
      `}),e.jsx("div",{className:"wrap no-print",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"brand-actions-row",style:{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:12},children:[e.jsxs("div",{children:[e.jsx(Bo,{level:4,style:{margin:0},children:oo?"NH MOTORS â€” JOB CARD":"SHANTHA MOTORS â€” JOB CARD"}),e.jsx(Is,{type:"secondary",children:"Multi Brand Two Wheeler Sales & Service"})]}),e.jsxs("div",{className:"brand-actions",style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx($o,{form:n,formatReg:Xe,buildRows:Jt,defaultGstLabour:ct,lists:{BRANCHES:Wo,MECHANIC:Hs,EXECUTIVES:us,VEHICLE_TYPES:Bs,SERVICE_TYPES:$s},setServiceTypeLocal:Fe,setVehicleTypeLocal:Ce,setRegDisplay:Ie,webhookUrl:Ue,setFollowUpEnabled:Mt,setFollowUpAt:vs,setFollowUpNotes:xs,setPostServiceLock:r,autoSearch:v||j||eo,onAutoSearchStatusChange:(s,t)=>{t==="inline"&&(ge(!!s),s||_e(null))}}),e.jsx(se,{onClick:async()=>{B(!0),await ts()},children:Lt===null?"PendingCases":`PendingCases (${Lt})`})]})]}),e.jsx(Nt,{title:Lt!==null?`PendingCases (${Lt})`:"PendingCases",open:y,onCancel:()=>B(!1),width:"min(1200px, 96vw)",footer:[e.jsx(se,{onClick:()=>ts(),children:"Refresh"},"refresh"),e.jsx(se,{type:"primary",onClick:()=>B(!1),children:"Close"},"close")],children:ce?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:16},children:e.jsx(zs,{})}):M.length?e.jsx(Gt,{size:"small",dataSource:M,renderItem:s=>{const t=String(s.name||"-").trim(),d=String(s.mobile||"-").trim(),c=String(s.jcNo||"-").trim(),u=String(s.regNo||"-").trim(),g=String(s.branch||"-").trim(),C=String(s.followUpAt||"-").trim(),L=String(s.followUpNotes||"").trim(),P=(t&&t!=="-"?t[0]:"P").toUpperCase(),Y=[t,d,c,u,g,C,L].filter(Boolean).join(" | ");return e.jsx(Gt.Item,{style:{paddingInline:0,paddingBlock:6},children:e.jsxs("div",{style:{width:"100%",display:"grid",gridTemplateColumns:"1fr auto",alignItems:"start",gap:10,padding:"10px 12px",borderRadius:12,border:"1px solid #dbe6ff",background:"linear-gradient(180deg, #ffffff 0%, #f8fbff 100%)"},title:Y,children:[e.jsxs("div",{style:{minWidth:0,display:"flex",flexDirection:"column",gap:6},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{width:30,height:30,borderRadius:"50%",background:"#2f6de1",color:"#fff",fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center",fontSize:14},children:P}),e.jsx("span",{style:{fontSize:16,fontWeight:800,color:"#0f172a",textTransform:"uppercase"},children:t})]}),e.jsxs("div",{style:{fontSize:12,color:"#334155",lineHeight:1.35,whiteSpace:"normal",wordBreak:"break-word"},children:[e.jsx("b",{children:d})," | ",c," | ",u]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx("span",{style:{padding:"1px 8px",borderRadius:999,background:"#eef3ff",border:"1px solid #d2dcf5",color:"#2b4f92",fontWeight:700,fontSize:12,textTransform:"uppercase"},children:g}),e.jsxs("span",{style:{padding:"1px 8px",borderRadius:999,background:"#f1f5fb",border:"1px solid #d7deec",color:"#41526d",fontWeight:600,fontSize:12},children:["FU: ",C]})]}),L?e.jsx("div",{style:{fontSize:12,color:"#5b6472",lineHeight:1.35},children:L}):null]}),e.jsx(se,{size:"small",type:"primary",onClick:()=>{const R=s.mobile||s.jcNo,Z=s.mobile?"mobile":"jc";R&&(w({mode:Z,query:R,token:Date.now()}),B(!1),p(z=>z.filter(T=>T.jcNo!==s.jcNo)))},children:"Post Service"})]})})}}):e.jsx("div",{style:{color:"#666"},children:"No pending job cards."})}),e.jsxs(k,{form:n,layout:"vertical",initialValues:js,style:{marginTop:12},onValuesChange:nt,children:[e.jsxs(it,{size:"small",bordered:!0,style:{marginTop:12},title:"Vehicle & Customer",children:[e.jsxs(Qe,{gutter:[12,8],children:[e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Vehicle No.",name:"regNo",validateFirst:!0,rules:[{required:!0,message:"Vehicle number is required"},{validator:(s,t)=>!t||qt.test(String(t||"").toUpperCase())?Promise.resolve():Promise.reject(new Error("Format must be KA05DB6000 (AA##AA####)"))}],children:e.jsx(ye,{placeholder:"KA05DB6000",value:Q,onChange:no,maxLength:10,inputMode:"latin",style:{textTransform:"uppercase"},suffix:e.jsx(se,{type:"primary",size:"small",loading:_&&ze==="vehicle",disabled:_||!ao,onClick:()=>rs("vehicle"),style:{height:22,paddingInline:6,fontSize:11,background:"#52c41a",borderColor:"#52c41a"},children:"Fetch"})})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Mobile",name:"custMobile",rules:[{required:!0,message:"Please enter mobile number"},{validator:(s,t)=>t?/^\d{10}$/.test(String(t))?Promise.resolve():Promise.reject(new Error("Enter 10-digit mobile number")):Promise.resolve()}],children:e.jsx(ye,{maxLength:10,inputMode:"numeric",pattern:"[0-9]*",onKeyPress:uo,onChange:po,placeholder:"10-digit number",suffix:e.jsx(se,{type:"primary",size:"small",loading:_&&ze==="mobile",disabled:_,onClick:()=>rs("mobile"),style:{height:22,paddingInline:6,fontSize:11,background:"#52c41a",borderColor:"#52c41a"},children:"Fetch"})})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Customer Name",name:"custName",rules:[{required:!0,whitespace:!0,message:"Please enter customer name"},er],getValueFromEvent:Xo,children:e.jsx(ye,{placeholder:"e.g., RAHUL SHARMA",style:{textTransform:"uppercase"}})})})]}),e.jsxs(Qe,{gutter:[12,8],children:[e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Company",name:"company",rules:[{required:!0,message:"Please select company"}],getValueFromEvent:Pt,children:e.jsx(Us,{placeholder:"Type company (e.g., H â†’ HONDA / HERO)",options:co.map(s=>({value:s})),filterOption:(s,t)=>String(t?.value||"").toLowerCase().includes(String(s||"").toLowerCase()),onChange:s=>{const t=oe(s);yt(t),n.setFieldsValue({company:t,model:void 0})},style:{textTransform:"uppercase"}})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Model",name:"model",rules:[{required:!0}],getValueFromEvent:Pt,children:e.jsx(Us,{placeholder:"Type model (e.g., ACT â†’ ACTIVA 125)",options:lo.map(s=>({value:s})),filterOption:(s,t)=>String(t?.value||"").toLowerCase().includes(String(s||"").toLowerCase()),onChange:s=>n.setFieldsValue({model:oe(s)}),style:{textTransform:"uppercase"}})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Colour",name:"colour",getValueFromEvent:Pt,children:e.jsx(ye,{style:{textTransform:"uppercase"}})})})]}),e.jsxs(Qe,{gutter:[12,8],children:[e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Odometer Reading",name:"km",rules:[{required:!0,message:"Please enter Odometer Reading"}],getValueFromEvent:s=>{const t=s.target.value.replace(/\D/g,"");return t?`${t} KM`:""},getValueProps:s=>({value:s?.toString().replace(/\D/g,"")}),children:e.jsx(ye,{style:{width:"100%"},maxLength:6,inputMode:"numeric",pattern:"[0-9]*",onKeyPress:mo,placeholder:"Enter KM",suffix:"KM"})})}),e.jsx(U,{xs:24,children:e.jsx(k.Item,{label:"Customer Observation (additional notes)",name:"obs",getValueFromEvent:Pt,children:e.jsx(ye.TextArea,{rows:3,placeholder:"Write the customer's observations...",style:{textTransform:"uppercase"}})})})]})]}),ve&&e.jsx(Js,{type:"warning",showIcon:!0,style:{marginTop:12},message:"Post-service already completed",description:`Service & labour editing is locked${ks?` (completed on ${ks})`:""}. Enter a different mobile number to start a new job card.`}),e.jsx(it,{size:"small",bordered:!0,style:{marginTop:12},title:"Service",children:e.jsxs(Qe,{gutter:[12,8],children:[e.jsx(U,{xs:24,md:6,children:e.jsx(k.Item,{label:"Service Type (tick one)",name:"serviceType",rules:[{required:!0,message:"Please select a service type"}],children:e.jsx(Uo.Group,{options:ho,value:ie?[ie]:[],onChange:go,disabled:ve})})}),e.jsx(U,{xs:24,md:6,children:e.jsx(k.Item,{label:"Chassis No",name:"chassisNo",rules:[{validator:(s,t)=>{const d=String(ie||"").toLowerCase()==="free",c=Yt(t||"");return!d||c?Promise.resolve():Promise.reject(new Error("Chassis number is required for Free service"))}}],getValueFromEvent:s=>{const t=s?.target?.value??s;return Yt(t)},children:e.jsx(ye,{placeholder:"Chassis No (required for Free service)"})})}),ie&&e.jsx(U,{xs:24,md:6,children:e.jsx(k.Item,{label:"Vehicle Type",name:"vehicleType",rules:[{required:!0,message:"Please choose Scooter or Motorcycle"}],children:e.jsx(kt,{className:"blue-segmented",block:!0,options:Bs,value:We||void 0,disabled:ve,onChange:s=>{Ce(s),n.setFieldsValue({vehicleType:s}),ie&&n.setFieldsValue({labourRows:Jt(ie,s),gstLabour:ct,discounts:{labour:0}}),nt()}})})}),We==="Scooter"&&e.jsx(U,{xs:24,md:4,children:e.jsx(k.Item,{label:"Floor Mat (Mandatory)",name:"floorMat",initialValue:"No",rules:[{required:!0,message:"Please select Yes/No"}],children:e.jsx(kt,{className:"blue-segmented",block:!0,options:["No","Yes"],disabled:ve,onChange:s=>{n.setFieldsValue({floorMat:s}),nt()}})})}),e.jsx(U,{xs:24,md:8,children:e.jsx(k.Item,{label:"Fuel Level",name:"fuelLevel",children:e.jsx(kt,{className:"blue-segmented",block:!0,options:Ko,disabled:ve})})})]})}),e.jsx(it,{size:"small",bordered:!0,style:{marginTop:12},title:"Labour",children:e.jsx(k.List,{name:"labourRows",children:(s,{add:t,remove:d})=>e.jsxs(e.Fragment,{children:[e.jsxs(Qe,{gutter:8,style:{fontWeight:600,marginBottom:6},children:[e.jsx(U,{span:12,children:"Description"}),e.jsx(U,{span:4,children:"Qty"}),e.jsx(U,{span:4,children:"Rate"}),e.jsx(U,{span:4,style:{textAlign:"right"},children:"Amount"})]}),s.map(({key:c,name:u,...g})=>{const C=Ge?.[u]||{},L=Number(C?.qty||0)*Number(C?.rate||0);return e.jsxs(Qe,{gutter:8,align:"middle",style:{marginBottom:6},children:[e.jsx(U,{span:12,children:e.jsx(k.Item,{...g,name:[u,"desc"],rules:[{required:!0}],getValueFromEvent:Pt,children:e.jsx(ye,{placeholder:"Labour description",disabled:ve,style:{textTransform:"uppercase"}})})}),e.jsx(U,{span:4,children:e.jsx(k.Item,{...g,name:[u,"qty"],initialValue:1,rules:[{required:!0}],children:e.jsx(Kt,{min:1,style:{width:"100%"},disabled:ve})})}),e.jsx(U,{span:4,children:e.jsx(k.Item,{...g,name:[u,"rate"],rules:[{required:!0}],children:e.jsx(Kt,{min:0,style:{width:"100%"},disabled:ve})})}),e.jsxs(U,{span:4,style:{textAlign:"right"},children:[e.jsx(Is,{children:$e(L)}),e.jsx(se,{type:"link",danger:!0,onClick:()=>d(u),style:{paddingLeft:8},disabled:ve,children:"Remove"})]})]},c)}),e.jsx(se,{onClick:()=>t({qty:1}),disabled:ve,children:"Add labour"})]})})}),e.jsx(it,{size:"small",bordered:!0,style:{marginTop:12},title:"Totals",children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:6,maxWidth:480},children:[e.jsx("div",{children:"Labour Subtotal"}),e.jsx("div",{style:{textAlign:"right"},children:$e(Se.labourSub)}),e.jsx(k.Item,{label:"GST % on Labour",name:"gstLabour",style:{marginBottom:0},children:e.jsx(Kt,{min:0,max:28,disabled:ve})}),e.jsx("div",{style:{textAlign:"right"},children:$e(Se.labourGST)}),e.jsx("div",{children:"Discount (Labour)"}),e.jsx(k.Item,{name:["discounts","labour"],style:{marginBottom:0},children:e.jsx(Kt,{min:0,disabled:ve})}),e.jsx("div",{style:{fontWeight:700},children:"Grand Total"}),e.jsx("div",{style:{textAlign:"right",fontWeight:700},children:$e(Se.grand)})]})}),e.jsx(it,{size:"small",bordered:!0,style:{marginTop:12},title:"Job Details",children:e.jsxs(Qe,{gutter:[12,8],children:[e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"JC No.",name:"jcNo",children:e.jsx(ye,{placeholder:"No Need to Enter",readOnly:!0})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Created At",name:"createdAt",rules:[{required:!0}],children:e.jsx(Ls,{showTime:!0,style:{width:"100%"}})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Branch",name:"branch",rules:[{required:!0}],children:Ne&&re.length?e.jsx(zt,{placeholder:"Select branch",value:bt,onChange:s=>so(s),options:re.map(s=>({value:s.name,label:s.name}))}):e.jsx(ye,{readOnly:!0,placeholder:"Auto-fetched from your profile"})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Allotted Mechanic",name:"mechanic",rules:[{required:!0}],children:e.jsx(zt,{placeholder:"Select mechanic",options:Hs.map(s=>({value:s,label:s}))})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Executive",name:"executive",rules:[{required:!0}],children:Ne?e.jsx(zt,{showSearch:!0,optionFilterProp:"label",placeholder:"Select executive",options:(ne.length?ne:us).map(s=>({value:s.name,label:s.name}))}):e.jsx(ye,{readOnly:!0,placeholder:"Auto-fetched from your profile"})})}),e.jsx(U,{xs:24,sm:12,md:8,children:e.jsx(k.Item,{label:"Expected Delivery Date",name:"expectedDelivery",rules:[{required:!0}],children:e.jsx(Ls,{style:{width:"100%"}})})})]})}),e.jsxs(Qe,{justify:"end",style:{marginTop:12},gutter:8,children:[e.jsx(U,{children:e.jsx(Lo,{title:he?"":Rt||"Fill all required fields",placement:"top",children:e.jsx(se,{type:"default",icon:e.jsx(Bt,{style:{color:"#25D366"}}),onClick:xo,disabled:!he||a>Date.now(),children:"WhatsApp"})})}),e.jsx(U,{children:e.jsx(se,{onClick:()=>Ke(!0),children:"Post-service"})})]})]})]})}),e.jsx(Nt,{title:"WhatsApp",open:Zt,onCancel:()=>et(!1),footer:null,destroyOnClose:!1,children:e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs("div",{style:cs(1),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["1. Customer WhatsApp ",Ae.customer?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Required"})]}),e.jsx(se,{type:"primary",icon:e.jsx(Bt,{style:{color:"#25D366"}}),onClick:So,disabled:!he||a>Date.now(),children:"Send"})]}),e.jsxs("div",{style:cs(2),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["2. Mechanic WhatsApp ",Ae.mechanic?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Required"}),Qt&&!Ae.mechanic?e.jsx("div",{style:{fontSize:12,color:"#b45309",marginTop:4},children:"Tap to open Mechanic WhatsApp."}):null,Ae.customer?null:e.jsx("div",{style:{fontSize:12,color:"#6b7280",marginTop:4},children:"Complete Customer WhatsApp first."})]}),e.jsx(se,{type:"primary",icon:e.jsx(Bt,{style:{color:"#25D366"}}),onClick:No,disabled:!he||!Ae.customer,children:"Send"})]}),e.jsxs("div",{style:cs(3),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["3. Pre-service ",Ae.pre?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Optional"})]}),e.jsx(se,{type:"default",onClick:jo,disabled:!he||N,loading:N,children:"Print"})]})]})}),e.jsxs(Nt,{title:"Post-service",open:I,onCancel:()=>Ke(!1),footer:null,children:[e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs(it,{size:"small",bordered:!0,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Amount (â‚¹)"}),e.jsx(ye,{inputMode:"numeric",placeholder:"0",value:mt,onChange:s=>Vt(s.target.value.replace(/[^0-9.]/g,""))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Mode"}),e.jsx(kt,{value:Le,onChange:tt,options:[{label:"Cash",value:"cash"},{label:"Online",value:"online"}]})]})]}),Le==="online"&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("div",{style:{marginBottom:6,fontSize:12,color:"#374151"},children:"UTR No. (Slot 1)"}),e.jsx(ye,{placeholder:"Enter UTR number",value:ut,onChange:s=>Ot(String(s.target.value||"").toUpperCase()),maxLength:32,style:{textTransform:"uppercase"}})]})]}),e.jsxs(it,{size:"small",bordered:!0,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Amount (â‚¹)"}),e.jsx(ye,{inputMode:"numeric",placeholder:"0",value:ot,onChange:s=>pt(s.target.value.replace(/[^0-9.]/g,""))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Mode"}),e.jsx(kt,{value:st,onChange:Xt,options:[{label:"Cash",value:"cash"},{label:"Online",value:"online"}]})]})]}),st==="online"&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("div",{style:{marginBottom:6,fontSize:12,color:"#374151"},children:"UTR No. (Slot 2)"}),e.jsx(ye,{placeholder:"Enter UTR number",value:Je,onChange:s=>ht(String(s.target.value||"").toUpperCase()),maxLength:32,style:{textTransform:"uppercase"}})]})]})]}),e.jsxs("div",{style:{marginTop:8,fontSize:13,color:xt===0?"#166534":"#b91c1c"},children:[e.jsx("strong",{children:"Payable:"})," ",$e(os)," Â | Â ",e.jsx("strong",{children:"Collected:"})," ",$e(ss)," Â | Â ",e.jsxs("strong",{children:[xt>=0?"Due":"Excess",":"]})," ",$e(Math.abs(xt))]}),e.jsxs("div",{style:{marginTop:12},children:[e.jsx("div",{style:{marginBottom:6},children:"Remarks (optional)"}),e.jsx(ye.TextArea,{placeholder:"Enter any delivery remarks for this service",value:gt,onChange:s=>wt(oe(s.target.value||"")),style:{textTransform:"uppercase"},autoSize:{minRows:2,maxRows:3}})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:16,justifyContent:"flex-end"},children:[e.jsx(se,{onClick:()=>Ke(!1),disabled:Re,children:"Cancel"}),e.jsx(se,{onClick:()=>is(!1),disabled:ve||Re||a>Date.now()||xt!==0,loading:Re,children:"Save"}),e.jsx(se,{icon:e.jsx(Bt,{style:{color:"#25D366"}}),onClick:()=>is("whatsapp"),disabled:ve||Re||a>Date.now()||xt!==0,loading:Re,children:"WhatsApp"}),e.jsx(se,{type:"primary",onClick:()=>is(!0),disabled:ve||Re||a>Date.now()||xt!==0,loading:Re,children:"Print"})]})]}),e.jsx(Io,{ref:dt,active:!0,vals:It,labourRows:Ge,totals:Se,observationLines:yo,executives:us}),e.jsx(Po,{ref:O,active:!0,vals:It,totals:Se})]})}export{Lr as default};
