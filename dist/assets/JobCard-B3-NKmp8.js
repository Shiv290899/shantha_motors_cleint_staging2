import{r as c,j as e,a as Do,G as To,R as ko}from"./index-DByWGH7d.js";import{L as _t,d as A}from"./index-53S8uf0A.js";import{f as Ot,t as rs,i as as,S as jt,P as Yo,h as Es}from"./PostServiceSheet-CYx6JQNX.js";import{F as Lt}from"./index-BnYplE8B.js";import{A as Ks,a as ot,l as Po,b as Ro,g as Fo,u as Vs,n as Os,D as Ls,c as Eo}from"./caseInsensitive-GFj-Zur4.js";import{B as q}from"./button-BmMOSO5i.js";import{M as pt}from"./index-BSIb012r.js";import{S as Vo}from"./index-DlPElhKY.js";import{R as $t,a as zs,S as Ht}from"./index-C2v3hDcT.js";import{I as ie,s as x}from"./index-mc3XMWnF.js";import{F as j}from"./index-fiQTrVnU.js";import{T as Oo}from"./index-CBM7Jb_H.js";import{C as tt}from"./index-BP3wDuv0.js";import{z as _e,A as F,T as Lo}from"./TextArea-BDVSLBQS.js";import{A as $s}from"./index-DU0h2yX8.js";import{C as $o}from"./index-Bbhzw47L.js";import{T as Ut}from"./index-eVJyXskz.js";import"./useClosable-Dko-A-M4.js";import"./pickAttrs-DLhOEXIt.js";import"./iconBase-CLQOV217.js";import"./PurePanel-B8np65kh.js";import"./PlusOutlined-68_8d4GS.js";import"./index-BQHoEo7h.js";import"./Skeleton-wxJCniSA.js";import"./useBubbleLock-CujG_eFi.js";import"./LeftOutlined-BxWPQNPi.js";import"./CheckOutlined-BWW6_Ha2.js";import"./DownOutlined-CAwmfW-2.js";import"./index-CUWDS_la.js";import"./EyeOutlined-DF4m-4HC.js";const Uo=c.forwardRef(function({active:m,vals:n,labourRows:v,executives:O=[],observationLines:V},D){const T=g=>String(g||"").toLowerCase().replace(/\s+/g," ").trim(),G=new Map((v||[]).map(g=>{const k=Number(g?.qty||0)*Number(g?.rate||0);return[T(g?.desc||g?.name),k]})),ee=(V||[]).map(g=>{const k=G.get(T(g));return{text:g,amount:Number.isFinite(k)?k:null}}),fe=ee.reduce((g,k)=>g+(k.amount??0),0),be=g=>{const J=String(g??"").toUpperCase().trim().replace(/\s*KM\s*$/i,"").replace(/\D/g,"");return J?`${J} KM`:"-"},W=({w:g="8mm"})=>e.jsx("span",{"aria-hidden":"true",style:{display:"inline-block",width:g}}),U=(()=>{const g=String(n?.executive||"").trim(),k=g.replace(/\D/g,"");return/^\d{10}$/.test(k)?k:(O||[]).find(J=>J.name===g)?.phone||null})(),te=(()=>{const g=n?.floorMat;if(typeof g=="boolean")return g;const k=String(g??"").trim().toLowerCase();return k==="yes"||k==="y"||k==="true"||k==="1"})(),ce=n?.floorMat!=null?!te:!1,re=String(n?.branch||"").trim().toLowerCase().replace(/\s+/g,"").includes("byadarahalli"),H=["Free","Paid","Minor","Accidental"];return e.jsxs("div",{ref:D,className:`print-sheet ${m?"active":""}`,children:[e.jsx("style",{children:`
/* =========================
   NEW PRINT BASELINE (A4)
   ========================= */
@page { size: A4 portrait; margin: 0; }
html, body {
  margin: 0 !important;
  padding: 0 !important;
  background: #fff !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica, sans-serif;
}
img { max-width: 100%; height: auto; background: transparent; }

/* Tame layout quirks during print */
@media print {
  * { transform: none !important; }
  .fixed, .sticky, [style*="position: sticky"], [style*="position: fixed"] { position: static !important; }
  .no-print { display: none !important; }
}

/* Screen preview */
@media screen {
  body:not(.print-host) 
  .print-sheet { display: none !important; }
}

/* If you still use the "active sheet only" pattern in full app print, keep it: */
@media print {
  body * { visibility: hidden !important; }                 /* hide all */
  .print-sheet { display: block; }
  .print-sheet.active,
  .print-sheet.active * { visibility: visible !important; } /* show only sheet */
  .print-sheet:not(.active) { display: none !important; }   /* ensure only one prints */
  .print-sheet.active { position: absolute; inset: 0; width: 100%; } /* start at top-left */

  /* Avoid blank extra pages by letting height auto */
  .pre-a4 { display: block !important; min-height: auto !important; height: auto !important; }

  /* Keep larger blocks from splitting */
  .voucher { break-inside: avoid; page-break-inside: avoid; }
}

/* ========== Your existing styles (kept) ========= */
.print-sheet { color: #000; }

/* Page grid */
.pre-a4 { /* container for a single A4 page */ }
.pre-wrap { padding: 4mm; }
.pre-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 3mm; }

/* Generic boxes and text helpers */
.box { border: 1px solid #111; padding: 2.5mm; border-radius: 1mm; }
.tiny { font-size: 11px; }
.label { font-weight: 600; }

/* Titles */
.title-kn { font-size: 18pt; font-weight: 500; letter-spacing: 1px; }
.title-en { font-size: 25pt; font-weight: 700; margin-top: 2px; }
.title-wrap {
  display: flex;
  align-items: baseline;
  gap: 8px;
  white-space: nowrap;
}

/* Grids */
.row   { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2mm; }
.row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 2mm; }
.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 2mm; }

.right { text-align: right; }
.center { text-align: center; }
.v-top { align-self: start; }

/* Observation + cost split column */
.obs-cost {
  display: grid;
  grid-template-columns: 1fr 40mm; /* observation | cost column */
  gap: 2mm;
}
.list { padding-left: 4mm; margin: 0; }
.list li { margin: 0.8mm 0; }
.sum-row { display: grid; grid-template-columns: 1fr 40mm; gap: 2mm; align-items: center; }
.divider { border-top: 1px solid #000; margin: 3mm 0; }

/* Voucher area (bottom strip) */
.voucher {
  border-top: 3px dashed #777;
  padding-top: 3mm;
  height: 60%;
  align-items: stretch;
}

/* Brand line */
.voucher .brand-line{
  display: flex;
  justify-content: center;
  align-items: baseline;
  gap: 8px;
  white-space: nowrap;
}
.voucher .brand-kn{ font-size:18pt; font-weight:500; line-height:1.05; }
.voucher .brand-en{ font-size:18pt; font-weight:500; line-height:1.05; }

/* Single outer box inside voucher: left | middle | right(=QR) */
.voucher .box {
  width: 98%;
  border: 1px solid #111;
  border-radius: 5mm;
  display: grid;
  grid-template-columns: 0.7fr 0.9fr 0.5fr;
  gap: 3mm;
  align-items: start;
  text-align: left;
}
.voucher .col { text-align: left; }
.voucher .col-right { text-align: center; }
.voucher .qr { height: 60px; width: 60px; object-fit: contain; }
.voucher .scan { font-size: 13px; font-weight: 600; margin-top: 4px; }
.voucher .phones { margin-top: 2px; }
/* Light helper for address lines */
.shop-sub { font-size: 12pt; }
.shop-addr { font-size: 11pt; }

/* Damage section */
.damage-box { border: 1px solid #111; padding: 2mm; min-width: 38mm; }
.damage-box .title { font-weight: 700; font-size: 12px; margin-bottom: 2mm; }
.damage-list { list-style: disc; padding-left: 5mm; margin: 0 0 3mm 0; }
.damage-list li { margin: 1mm 0; position: relative; }

/* Yes / No on the right of each line */
.yn {
  float: right;
  display: inline-flex;
  align-items: center;
  gap: 4mm;
}

/* Printable empty checkbox square */
.cb {
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 5mm;
  height: 5mm;
  border: 1px solid #111;
  font-size: 12px;  /* ensures â˜‘ / â˜ fits */
}


/* NOTE block below the list */
.note-box { border-top: 1px dashed #777; margin-top: 3mm; padding-top: 2mm; }
.note-title { font-weight: 600; margin-bottom: 1.5mm; }
.note-area { border: 1px solid #111; height: 69mm; border-radius: 1mm; }
      `}),e.jsxs("div",{className:"pre-a4",children:[e.jsxs("div",{className:"pre-wrap",children:[e.jsxs("div",{className:"title-wrap",children:[e.jsx("div",{className:"title-en",children:re?"NH MOTORS JOB CARD":"SHANTHA MOTORS JOB CARD"}),e.jsx("div",{className:"title-kn",children:re?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"})]}),re&&e.jsxs("div",{style:{marginTop:2},children:[e.jsxs("div",{className:"shop-addr",children:["Site No. 116/1, Bydarahalli, Magadi Main Road, Opp.",e.jsx("br",{}),"HP Petrol Bunk, Bangalore - 560091"]}),e.jsx("div",{className:"shop-sub",children:"Mob: 9731366921 / 8073283502 / 9741609799"})]}),e.jsxs("div",{className:"box row-2",style:{marginTop:3},children:[e.jsxs("div",{style:{fontSize:"20px",lineHeight:"1.4"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Job Card No:"})," ",n.jcNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Executive:"})," ",n.executive||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Date:"})," ",Ot(n.createdAt)]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Mechanic:"})," ",n.mechanic||"-"]})]}),e.jsxs("div",{className:"center",children:[e.jsx("img",{src:"/location-qr.png",alt:"location qr",style:{height:60}}),e.jsx("div",{className:"scan",children:"Scan for Location"}),e.jsx("div",{className:"tiny",style:{marginTop:3},children:re?"Mob: 9731366921 / 8073283502 / 9741609799":"Mob: 9731366921 / 8073283502"})]})]}),e.jsxs("div",{className:"row-2",style:{marginTop:3},children:[e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Vehicle No:"})," ",n.regNo||"-"]}),e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Odometer Reading:"})," ",be(n.km)]})]}),e.jsxs("div",{className:"row-2",style:{marginTop:3},children:[e.jsx("div",{className:"box",children:e.jsx("div",{children:e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Model:"})," ",n.model||"-"]})})}),e.jsxs("div",{className:"box",children:[e.jsx("span",{className:"label",children:"Expected Delivery Date:"})," ",Ot(n.expectedDelivery)]})]}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{style:{display:"flex",gap:"6mm",flexWrap:"wrap",alignItems:"center"},children:[H.map(g=>e.jsxs("div",{children:[rs(n.serviceType===g)," ",g]},g)),e.jsx(W,{w:"10mm"}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Color:"})," ",n.colour||"-"]})]})}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"4fr 3fr",gap:"3mm"},children:[e.jsxs("div",{className:"obs-cost",children:[e.jsxs("div",{children:[e.jsx("div",{className:"label",children:"Customer Observation"}),e.jsx("ul",{className:"list",children:ee.length===0?e.jsx("li",{children:"â€”"}):ee.map(({text:g},k)=>e.jsx("li",{children:g},k))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"label right",children:"Estimated Cost"}),e.jsx("ul",{className:"list",style:{listStyle:"none",paddingLeft:0},children:ee.length===0?e.jsx("li",{className:"right",children:"â€”"}):ee.map(({amount:g},k)=>e.jsx("li",{className:"right",children:g!=null?as(g):"â€”"},k))})]})]}),e.jsx("div",{className:"v-top",children:e.jsxs("div",{className:"damage-box",children:[e.jsx("div",{className:"title",children:"CHECK BODY PART FOR ANY DAMAGE"}),e.jsxs("ul",{className:"damage-list",children:[e.jsxs("li",{children:["Dent",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Scratch",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Broken",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb"}),"No ",e.jsx("span",{className:"cb"})]})]}),e.jsxs("li",{children:["Floor Mat",e.jsxs("span",{className:"yn",children:["Yes ",e.jsx("span",{className:"cb",children:rs(te)}),"No  ",e.jsx("span",{className:"cb",children:rs(ce)})]})]})]}),e.jsxs("div",{className:"note-box",children:[e.jsx("div",{className:"note-title",children:"NOTE:"}),e.jsx("div",{className:"note-area"})]})]})})]})}),e.jsx("div",{className:"box",style:{marginTop:3},children:e.jsxs("div",{className:"sum-row",style:{fontWeight:700},children:[e.jsx("div",{children:"Total Estimated Cost"}),e.jsx("div",{className:"right",children:as(fe)})]})}),e.jsxs("div",{className:"row-3 box",style:{marginTop:3},children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Customer Name:"})," ",n.custName||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Mobile No:"})," ",n.custMobile||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Sign:"})," "]})]})]}),e.jsxs("div",{className:"pre-wrap voucher",children:[e.jsxs("div",{className:"brand-line",children:[e.jsx("span",{className:"brand-kn",children:re?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsx("span",{children:" || "}),e.jsx("span",{className:"brand-en",children:re?"NH MOTORS":"SHANTHA MOTORS"})]}),e.jsxs("div",{className:"box",style:{fontSize:"20px",lineHeight:"1.3",marginTop:"2mm"},children:[e.jsxs("div",{className:"col",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Job Card No:"})," ",n?.jcNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Reg. No:"})," ",n?.regNo||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Exp. Del. Date:"})," ",Ot(n?.expectedDelivery)]})]}),e.jsxs("div",{className:"col",children:[e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Date:"})," ",Ot(n?.createdAt)]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Executive No:"})," ",U||"-"]}),e.jsxs("div",{children:[e.jsx("span",{className:"label",children:"Apprx. Service Amount:"})," ",as(fe)]})]}),e.jsxs("div",{className:"col col-right",children:[e.jsx("img",{src:"/location-qr.png",alt:"Location QR",className:"qr"}),e.jsx("div",{className:"scan",children:"Scan for Location"}),e.jsx("div",{className:"tiny phones",children:re?"9731366921 â€¢ 8073283502 â€¢ 9741609799":"9731366921 â€¢ 8073283502"})]})]})]})]})]})}),Io={};function Bo({form:r,formatReg:m,buildRows:n,defaultGstLabour:v=0,lists:O,setServiceTypeLocal:V,setVehicleTypeLocal:D,setRegDisplay:T,webhookUrl:G,setFollowUpEnabled:ee,setFollowUpAt:fe,setFollowUpNotes:be,setPostServiceLock:W,autoSearch:U,prefillMode:te="full",onAutoSearchStatusChange:ce}){const xe=Io?.VITE_JOBCARD_GAS_SECRET||"",[re,H]=c.useState(!1),[g,k]=c.useState("mobile"),[ve,J]=c.useState(""),[nt,le]=c.useState(!1),[Ee,me]=c.useState([]),[De,se]=c.useState(""),[Je,de]=c.useState(te),ye=c.useRef(te),{BRANCHES:qe,MECHANIC:Pe,EXECUTIVES:ae,VEHICLE_TYPES:ht,SERVICE_TYPES:Mt}=c.useMemo(()=>O||{},[O]);c.useEffect(()=>{ye.current=te,de(te)},[te]);const b=c.useMemo(()=>({Branch:["Branch"],Mechanic:["Allotted Mechanic","Mechanic","Allocated Mechanic"],Executive:["Executive"],ExpectedDelivery:["Expected Delivery Date","Expected Delivery","Expected_Delivery_Date"],RegNo:["Vehicle No","Vehicle_No","Vehicle Number","Registration Number","Reg No","RegNo"],ChassisNo:["Chassis No","Chassis_No","Chassis Number","Chassis"],Model:["Model"],Colour:["Colour","Color"],KM:["Odometer Reading","Odomete Reading","KM","Odometer"],CustName:["Customer Name","Name","Customer_Name"],Mobile:["Mobile","Mobile No","Mobile Number","Phone","Phone Number"],Obs:["Customer Observation","Customer_Observation","Observation","Notes"],VehicleType:["Vehicle Type","Type of Vehicle","Vehicle_Type"],ServiceType:["Service Type","Service","Service_Type"],FloorMat:["Floor Mat"],Amount:["Collected Amount","Amount"],JCNo:["JC No","JCNo","Job Card No","JC Number","JC No."],CreatedAt:["Created At","Timestamp","Form Timestamp","Submission Time","Submitted At"]}),[]),E=(o,a)=>{for(const d of a)if(Object.prototype.hasOwnProperty.call(o,d)){const h=o[d];if(h!=null&&String(h).trim()!=="")return String(h).trim()}return""},Se=o=>String(o||"").replace(/\D/g,"").slice(-10),Ve=o=>String(o||"").toUpperCase().replace(/[^A-Z0-9]/g,""),Oe=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,Ke=o=>{const a=Ve(o);return a.length>10||!/^[A-Z0-9]*$/.test(a)?!1:[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(h=>h.test(a))},gt=(o={})=>{const d=o?.source==="inline",h=g==="vehicle"?Ve(ve):Se(ve)||String(ve||"").trim(),oe=h?`No records found for ${g==="vehicle"?"vehicle number":"mobile number"} "${h}".`:"No records found.";se(oe),pt.warning({centered:!0,title:d?"No records found":"No job card found",content:oe,okText:"Got it"})},Te=o=>{const a=String(o||"").trim();if(!a)return null;const d=A(a,["DD-MM-YYYY HH:mm","D-M-YYYY HH:mm","DD/MM/YYYY HH:mm","D/M/YYYY HH:mm","DD-MM-YYYY","D-M-YYYY","DD/MM/YYYY","D/M/YYYY","YYYY-MM-DD",A.ISO_8601],!0);return d.isValid()?d:null},ze=o=>{const a=E(o,b.CreatedAt),d=A(a,[A.ISO_8601,"M/D/YYYY H:mm:ss","D/M/YYYY H:mm:ss","DD/MM/YYYY H:mm:ss","DD/MM/YYYY","D-M-YYYY H:mm:ss","DD-MM-YYYY H:mm:ss","DD-MM-YYYY HH:mm","DD-MM-YYYY"],!1);return d.isValid()?d:A(0)},Ct=o=>{const a=o||{},d=a.formValues||{},h=a.savedAt||a.createdAt||a.ts||a.timestamp||a.postServiceAt||d.createdAt||d.savedAt||d.timestamp||d.submittedAt||d.expectedDelivery||"",S=A(h);return S.isValid()?S.valueOf():0},ft=(o,a)=>{const d=o&&o.payload?o.payload:o||{},h=o?._values||o?.values||{},S=d?.postServiceAt||d?.postService_at||d?.formValues?.postServiceAt||d?.formValues?.postService_at||h?.Post_Service_At||h?.Post_Service_at||h?.Post_Service||"",oe=d?.formValues?.custMobile||d?.custMobile||h?.Mobile||h?.["Mobile Number"]||h?.Phone||h?.["Phone Number"]||"",z=Se(oe);return{locked:!!d?.postServiceLogged||!!S,at:S||null,mobile:z||null,amount:d?.postServiceAmount??null,mode:d?.postServiceMode||d?.paymentMode||null}},At=(o,a)=>{if(!W)return;const d=ft(o);W(d)},ke=o=>String(o||"").toLowerCase().replace(/\s+/g,""),pe=(o,a)=>{if(!a||!o?.length)return;const d=ke(a);let h=o.find(S=>ke(S)===d);return h||(h=o.find(S=>ke(S).startsWith(d)),h)||(h=o.find(S=>ke(S).includes(d))),h},Ze=o=>{const a=String(o||"").toLowerCase();return a.includes("free")?"Free":a.includes("paid")?"Paid":a.includes("minor")?"Minor":a.includes("accid")?"Accidental":pe(Mt||[],o)},Wt=o=>{const a=String(o||"").toLowerCase();return a.includes("scoot")||a.includes("scooty")?"Scooter":a.includes("bike")||a.includes("motor")?"Motorcycle":pe(ht||[],o)},Ge=async(o,a)=>{if(!G)throw new Error("Webhook URL not configured");const d=a||g,h=d==="vehicle"?"reg":d==="jc"?"jc":"mobile",S=String(o??ve??""),oe=xe?{action:"search",mode:h,query:S,secret:xe}:{action:"search",mode:h,query:S};let z=[];try{const M=await ot({webhookUrl:G,method:"GET",payload:oe}),y=M?.data||M;z=Array.isArray(y?.rows)?y.rows:[]}catch(M){console.warn("Webhook search failed:",M)}if(!z.length&&d==="vehicle")try{const y=await ot({webhookUrl:G,method:"GET",payload:xe?{action:"search",mode:"vehicle",query:S,secret:xe}:{action:"search",mode:"vehicle",query:S}}),I=y?.data||y;z=Array.isArray(I?.rows)?I.rows:[]}catch(M){console.warn("Vehicle search fallback failed:",M)}return{mode:"webhook",rows:z.map(M=>{const y=M&&M.values?M.values:{},I=String(y.Post_Service_At||y.Post_Service_at||y.Post_Service||"").trim(),Ne={jcNo:String(y["JC No."]||""),branch:String(y.Branch||""),regNo:m(y.Vehicle_No||y["Vehicle No"]||"",""),model:String(y.Model||""),colour:String(y.Colour||y.Color||""),km:String(y.KM||y["Odometer Reading"]||y["Odomete Reading"]||"").replace(/\D/g,"")||"",serviceType:String(y.Service_Type||y["Service Type"]||""),custName:String(y.Customer_Name||""),custMobile:String(y.Mobile||""),obs:String(y.Customer_Observation||""),expectedDelivery:String(y.Expected_Delivery_Date||""),amount:String(y.Collected_Amount||"")};if(M&&M.payload&&typeof M.payload=="object"){const f=M.payload||{},Ae={...Ne,...f.formValues||{}};return{payload:{...f,formValues:Ae,postServiceAt:f.postServiceAt||f.postService_at||I||void 0,postServiceLogged:f.postServiceLogged||!!(f.postServiceAt||f.postService_at||I),_values:y}}}return{payload:{formValues:Ne,labourRows:[],totals:{},postServiceAt:I||void 0,postServiceLogged:!!I,_values:y}}})}},Qe=o=>{const a=E(o,b.Branch),d=E(o,b.Mechanic),h=E(o,b.Executive),S=Te(E(o,b.ExpectedDelivery)),oe=m(E(o,b.RegNo),""),z=String(E(o,b.ChassisNo)||"").toUpperCase().replace(/[^A-Z0-9]/g,""),L=String(E(o,b.Model)||"").toUpperCase(),M=E(o,b.Colour),y=E(o,b.KM).replace(/\D/g,""),I=E(o,b.CustName),Ne=Se(E(o,b.Mobile)),f=E(o,b.Obs),Ae=(()=>{const Ue=String(f||"").trim();return Ue?Ue.includes("#")?Ue.split(/\s*#\s*/g).map(Tt=>Tt.trim()).filter(Boolean).join(`
`):Ue.replace(/\r\n/g,`
`):""})(),he=Wt(E(o,b.VehicleType)),Q=Ze(E(o,b.ServiceType)),X=E(o,b.FloorMat),je=E(o,b.JCNo),Re=pe(Pe,d),yt=pe((ae||[]).map(Ue=>Ue.name),h);return{fields:{jcNo:je,branch:pe(qe,a)||void 0,mechanic:Re,executive:yt,expectedDelivery:S||null,regNo:oe,chassisNo:z,model:L,colour:M,km:y?`${y} KM`:"",custName:I,custMobile:Ne,obs:Ae,vehicleType:he,serviceType:Q,floorMat:X==="Yes"||X==="No"?X:void 0,discounts:{labour:0},gstLabour:v},serviceType:Q,vehicleType:he}},Dt=(o={})=>{const a={},d=m(o.regNo||"",""),h=String(o.custMobile||"").replace(/\D/g,"").slice(-10);d&&(a.regNo=d),h&&(a.custMobile=h),String(o.custName||"").trim()&&(a.custName=o.custName),String(o.company||"").trim()&&(a.company=String(o.company).toUpperCase()),String(o.model||"").trim()&&(a.model=String(o.model).toUpperCase()),String(o.colour||"").trim()&&(a.colour=o.colour),String(o.chassisNo||"").trim()&&(a.chassisNo=String(o.chassisNo).toUpperCase()),Object.keys(a).length&&r.setFieldsValue(a),d&&T?.(d),W&&W({locked:!1,at:null,mobile:null,amount:null,mode:null}),x.success("Customer details pre-filled."),H(!1),me([]),J("")},Le=o=>{const{fields:a,serviceType:d,vehicleType:h}=Qe(o);try{const S=ze(o);S&&S.isValid&&S.isValid()&&(a.savedAt=S.toISOString())}catch{}if(ye.current==="basic"){Dt(a);return}V?.(d||null),D?.(h||null),r.setFieldsValue(a),T?.(a.regNo||""),d&&h&&r.setFieldsValue({labourRows:n(d,h),gstLabour:v,discounts:{labour:0}}),At(o),x.success("Details filled from sheet."),H(!1),me([]),J("")},rt=o=>{try{if(ye.current==="basic"){const f=o?.formValues||{};Dt({regNo:f.regNo||"",custMobile:String(f.custMobile||"").replace(/\D/g,"").slice(-10),custName:f.custName||"",company:f.company||"",chassisNo:f.chassisNo||f.chassis||"",model:String(f.model||"").toUpperCase(),colour:f.colour||""});return}const a=o?.formValues||{},d=o?.savedAt||o?.createdAt||o?.ts||o?.timestamp||a.savedAt||a.createdAt||a.timestamp||"",h=o?.updatedAt||a.updatedAt||"",S=(()=>{const f=A(d);return f.isValid()?f.toISOString():d})(),oe=(()=>{const f=A(h);return f.isValid()?f.toISOString():h})(),z=a.serviceType||null,L=a.vehicleType||null;V?.(z),D?.(L);const M=Number(o?.totals?.labourSub||0)||0,y=Number(o?.totals?.labourGST||0)||0,I=M>0&&y>0?Math.round(y/M*100):v,Ne=Number(o?.totals?.labourDisc||0)||0;if(r.setFieldsValue({jcNo:a.jcNo||"",branch:a.branch||void 0,mechanic:a.mechanic||void 0,executive:a.executive||void 0,expectedDelivery:a.expectedDelivery?A(a.expectedDelivery,["DD-MM-YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY","YYYY-MM-DD",A.ISO_8601],!0):null,regNo:a.regNo||"",company:String(a.company||"").toUpperCase(),model:String(a.model||"").toUpperCase(),colour:a.colour||"",chassisNo:String(a.chassisNo||a.chassis||"").toUpperCase(),km:a.km?`${String(a.km).replace(/\D/g,"")} KM`:"",fuelLevel:a.fuelLevel||void 0,callStatus:a.callStatus||"",custName:a.custName||"",custMobile:String(a.custMobile||"").replace(/\D/g,"").slice(-10),obs:(a.obs||"").replace(/\s*#\s*/g,`
`),vehicleType:L||void 0,serviceType:z||void 0,floorMat:a.floorMat==="Yes"?"Yes":a.floorMat==="No"?"No":void 0,discounts:{labour:Ne},gstLabour:I,labourRows:Array.isArray(o?.labourRows)&&o.labourRows.length?o.labourRows:n(z,L),savedAt:S||void 0,updatedAt:oe||void 0}),T?.(a.regNo||""),o?.followUp)try{const f=o.followUp;if(typeof f.enabled<"u"&&ee?.(!!f.enabled),f.at){const Ae=A(f.at);Ae.isValid()&&fe?.(Ae)}typeof f.notes<"u"&&be?.(String(f.notes||""))}catch{}At(o),x.success("Details filled from saved Job Card."),H(!1),me([]),J("")}catch(a){console.warn("applyPayloadToForm error:",a),x.error("Could not apply fetched Job Card.")}},Xe=o=>{o&&o.formValues?rt(o):Le(o)},at=async(o,a,d,h={})=>{const S=a||g,oe=typeof d=="string"&&d?d:te;ye.current=oe,de(oe);const z=!!h?.autoPickLatest,L=h?.source,M=L==="inline",I=((typeof o=="string"||typeof o=="number"?String(o):void 0)??ve??"").trim();if(!I){x.warning(S==="vehicle"?"Enter vehicle no. (KA03AB1234)":S==="jc"?"Enter a valid Job Card number.":"Enter a valid 10-digit mobile number."),M&&ce?.(!1,L);return}let Ne=I;if(S==="vehicle"){const f=Ve(I);if(!Oe.test(f)){x.warning("Enter vehicle no. as KA03AB1234."),M&&ce?.(!1,L);return}Ne=f,J(f)}else if(S==="jc")Ne=I,J(I);else{const f=Se(I);if(!f||f.length!==10){x.warning("Enter a valid 10-digit mobile number."),M&&ce?.(!1,L);return}Ne=f,J(f)}se(""),le(!0),M&&ce?.(!0,L);try{const f=await Ge(Ne,S);if(!f)throw new Error("No result");if(f.mode==="webhook"){const Q=f.rows||[];if(!Q.length){gt({source:L}),me([]);return}const X=Q.map(je=>je?.payload||je);if(z){const je=[...X].sort((Re,yt)=>Ct(yt)-Ct(Re));rt(je[0]);return}if(X.length===1){const je=X[0];rt(je);return}me(X.slice(0,10)),x.info(`Found ${Q.length} matches. Pick one.`);return}const Ae=f.rows;let he=[];if(S==="jc")he=Ae.filter(Q=>E(Q,b.JCNo)===I);else{const Q=Se(I)||I.replace(/\D/g,"");he=Ae.filter(X=>{const je=Se(E(X,b.Mobile));return Q?Q.length<10?je.endsWith(Q):je===Q:!1})}if(!he.length){gt({source:L}),me([]);return}if(he.sort((Q,X)=>ze(X).valueOf()-ze(Q).valueOf()),z){Le(he[0]);return}if(he.length===1){Le(he[0]);return}me(he.slice(0,10)),x.info(`Found ${he.length} matches. Pick one.`)}catch(f){console.error(f),x.error("Could not fetch job cards. Check the Apps Script/CSV link.")}finally{le(!1),M&&ce?.(!1,L)}},$e=c.useRef("");return c.useEffect(()=>{const o=String(U?.query||"").trim();if(!o)return;const a=U?.mode==="vehicle"||U?.mode==="jc"?U.mode:"mobile",d=`${a}:${o}:${U?.token||""}`;if($e.current===d)return;$e.current=d,k(a),J(o);const h=U?.openModal!==!1;H(h),setTimeout(()=>{at(o,a,U?.prefill,{autoPickLatest:U?.autoPickLatest,source:U?.source})},0)},[U]),e.jsxs(e.Fragment,{children:[e.jsx(q,{type:"primary",style:{background:"#52c41a",borderColor:"#52c41a"},onClick:()=>{se(""),H(!0)},children:"Fetch Details"}),e.jsx(pt,{title:"Fetch Job Card",open:re,onCancel:()=>{H(!1),me([]),se("")},footer:[e.jsx(q,{onClick:()=>{H(!1),me([]),se("")},children:"Close"},"close"),e.jsx(q,{type:"primary",loading:nt,onClick:()=>at(),children:"Search"},"search")],children:e.jsxs(Vo,{direction:"vertical",style:{width:"100%"},children:[e.jsxs($t.Group,{value:g,onChange:o=>{k(o.target.value),J("")},children:[e.jsx($t.Button,{value:"mobile",children:"By Mobile"}),e.jsx($t.Button,{value:"vehicle",children:"By Vehicle No"}),e.jsx($t.Button,{value:"jc",children:"By JC No"})]}),e.jsx(ie,{placeholder:g==="vehicle"?"Enter Vehicle No (KA03AB1234)":g==="jc"?"Enter JC No":"Enter Mobile (10-digit)",value:ve,inputMode:g==="vehicle"||g==="jc"?"text":"numeric",onChange:o=>{const a=o.target.value||"";if(g==="vehicle"){const d=a.toUpperCase().replace(/[^A-Z0-9]/g,"");if(!Ke(d))return;J(d)}else if(g==="jc")J(String(a||"").toUpperCase());else{const d=String(a||"").replace(/\D/g,"").slice(0,10);J(d)}},onPressEnter:()=>at(),allowClear:!0}),De&&e.jsx(Ks,{type:"warning",showIcon:!0,message:De}),nt&&e.jsx(zs,{}),Ee.length>1&&e.jsx(_t,{size:"small",bordered:!0,dataSource:Ee,renderItem:o=>{const a=o&&o.formValues,d=a?o.formValues:null,h=a?d.jcNo||"â€”":E(o,b.JCNo)||"â€”",S=a?d.custName||"â€”":E(o,b.CustName)||"â€”",oe=a?String(d.custMobile||"").replace(/\D/g,"").slice(-10)||"â€”":Se(E(o,b.Mobile))||"â€”",z=a?d.regNo||"â€”":E(o,b.RegNo)||"â€”",L=a?Te(d.expectedDelivery):null,M=a?L?L.format("DD-MM-YYYY HH:mm"):d.expectedDelivery||"-":ze(o).format("DD-MM-YYYY HH:mm");return e.jsx(_t.Item,{role:"button",tabIndex:0,onClick:()=>Xe(o),onKeyDown:y=>{(y.key==="Enter"||y.key===" ")&&Xe(o)},style:{cursor:"pointer"},actions:[e.jsx(q,{type:"link",onClick:y=>{y.stopPropagation(),Xe(o)},children:"Use"})],children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",width:"100%"},children:[e.jsxs("div",{children:[e.jsx("b",{children:"JC:"})," ",h," Â  ",e.jsx("b",{children:"Name:"})," ",S]}),e.jsxs("div",{children:[e.jsx("b",{children:"Mobile:"})," ",oe," Â  ",e.jsx("b",{children:"Vehicle:"})," ",z]}),e.jsxs("div",{style:{gridColumn:"1 / span 2",color:"#999"},children:[e.jsxs("b",{children:[a?"Expected Delivery":"Timestamp",":"]})," ",M]})]})})}})]})})]})}const{Title:Ho,Text:Us}=Oo,{Option:En}=Ht,_o="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",Ye=_o,Is="",Wo=["Byadarahalli","Kadabagere","Muddinapalya","Andrahalli","Tavarekere","Hegganahalli","Channenahalli","Nelagadrahalli"],is=[{name:"Rukmini",phone:"9901678562"},{name:"Meghana",phone:"9741609799"},{name:"Shubha",phone:"8971585057"},{name:"Rani",phone:"9108970455"},{name:"Likhitha",phone:"9535190015"},{name:"Vanitha",phone:"9380729861"},{name:"Prakash",phone:"9740176476"},{name:"Swathi",phone:"6363116317"},{name:"Kumar",phone:"7975807667"},{name:"Sujay",phone:"7022878048"},{name:"Kavi",phone:"9108970455"},{name:"Narasimha",phone:"9900887666"},{name:"Kavya",phone:"8073165374"}],Bs=["Free","Paid","Minor","Accidental"],Hs=["Motorcycle","Scooter"],_s=["SONU","KARTHIK","MANMOHAN","MANSUR","IRSHAD","DAKSHAT","SALMAN"],Ws={SONU:"7033558306",KARTHIK:"7338386813",MANMOHAN:"9956079799",MANSUR:"7795047627",IRSHAD:"6207176821",DAKSHAT:"7829096931",SALMAN:"7892335161"},Zs=r=>{const m=String(r||"").trim();return m&&(Ws[m]||Ws[m.toUpperCase()])||""},Jo=["Empty","Â¼","Â½","Â¾","Full"],st=0,Js={Scooter:{base:[{desc:"Engine oil",rate:450},{desc:"Consumables",rate:70},{desc:"Gearbox oil",rate:80}]},Motorcycle:{base:[{desc:"Engine oil",rate:450},{desc:"Consumables",rate:80},{desc:"Chain lubrication",rate:70}]},paidAddons:[{desc:"Service Labour",rate:400},{desc:"Water wash",rate:150}]},qo="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYGuNPY_2ivfS7MTX4bWiu1DWdF2mrHSCnmTznZVEHxNmsrgcGWjVZN4UDUTOzQQdXTnbeM-ylCJbB/pub?gid=408799621&single=true&output=csv",Ko=r=>{const m=[];let n=[],v="",O=!1;for(let V=0;V<r.length;V++){const D=r[V],T=r[V+1];if(D==='"'&&!O){O=!0;continue}if(D==='"'&&O){if(T==='"'){v+='"',V++;continue}O=!1;continue}if(D===","&&!O){n.push(v),v="";continue}if((D===`
`||D==="\r")&&!O){(v!==""||n.length)&&(n.push(v),m.push(n),n=[],v=""),D==="\r"&&T===`
`&&V++;continue}v+=D}return(v!==""||n.length)&&(n.push(v),m.push(n)),m},cs={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"]},ls=(r,m)=>String(m.map(n=>r[n]??"").find(n=>n!=="")||"").trim(),zo=(r={})=>({company:ls(r,cs.company),model:ls(r,cs.model),variant:ls(r,cs.variant)}),Zo=(r={})=>({company:String(r["Company Name"]||r.company||"").trim(),model:String(r["Model Name"]||r.model||"").trim(),variant:String(r.Variant||r.variant||"").trim()});async function qs(r,m,n){try{const v=await Eo(r,m,n);if(v?.success&&v?.serial)return String(v.serial)}catch(v){console.warn("Reserve JC serial failed; falling back to timestamp:",v?.message||v)}return A().format("YYMMDDHHmmss")}function Go(r){const m=String(r||"").toUpperCase();return m.length>10||!/^[A-Z0-9]*$/.test(m)?!1:[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(v=>v.test(m))}function We(r,m=""){const n=String(r||"").toUpperCase().replace(/[^A-Z0-9]/g,"");return Go(n)?n.slice(0,10):m||""}const It=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,K=r=>typeof r=="string"?r.toUpperCase():r,mt=r=>K(r?.target?.value??r),ds=r=>Array.isArray(r)?r.map(m=>({...m,desc:K(m?.desc||"")})):[],wt=r=>String(r||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20);function Bt(r,m){if(!r||!m)return[];const n=String(r||"").toLowerCase(),v=n==="paid";if(!v&&!(n==="free"))return[];const D=(Js[m]?.base??[]).map(T=>({desc:K(T.desc),qty:1,rate:T.rate}));return v&&D.push(...Js.paidAddons.map(T=>({desc:K(T.desc),qty:1,rate:T.rate}))),D}const Fe=r=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(Math.max(0,Math.round(Number(r||0)))),us={locked:!1,at:null,mobile:null,amount:null,mode:null};async function Qo(r){const m=await ot({webhookUrl:Ye,method:"POST",payload:{action:"save",data:r}});return m?.data||m}function Gs(){try{const r=localStorage.getItem("user"),m=r?JSON.parse(r):null,n=String(m?.phone||"").replace(/\D/g,"");return n.length===10?`+91${n}`.replace("+",""):n.length===12&&n.startsWith("91")?n:""}catch{return""}}function ms(r){const m=String(r||"").replace(/\D/g,"");return m.length===10?`91${m}`:m.length===12&&m.startsWith("91")?m:""}function Xo(r,m){const n=r?.expectedDelivery?A(r.expectedDelivery).format("DD-MM-YYYY HH:mm"):"â€”",v=r?.createdAt?A(r.createdAt).format("DD-MM-YYYY HH:mm"):"â€”",O=Gs(),V=r?.branch||"â€”",D=(r?.custName?String(r.custName).trim():"")||"Customer",T=r?.jcNo||"â€”",G=r?.regNo||"â€”",ee=Fe(m?.grand??0),fe=r?.obs?r.obs.split(`
`).map(g=>g.trim()).filter(Boolean):[],be=fe.length?`*Customer Observations:*
${fe.map(g=>`- ${g}`).join(`
`)}

`:"",W=(r?.mechanic?String(r.mechanic).trim():"")||"",U=W?Zs(W):"",te=W?`ðŸ‘· Assigned Mechanic: ${W}${U?` (â˜Žï¸ ${U})`:""}
`:"",ce=String(V).toLowerCase().replace(/[^a-z]/g,""),xe=ce.includes("byadarahalli")||ce.includes("badrally"),re=xe?"NH Motors":"Shantha Motors";return`Hi ${D}! ðŸ‘‹

âœ… Your bike service is confirmed at ${re}.

Welcome to ${re},
${xe?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}à²—à³† à²¸à³à²µà²¾à²—à²¤ ðŸï¸âœ¨

ðŸ§¾ Job Card: ${T}
ðŸ•’ Job Card Created: ${v}
ðŸï¸ Vehicle: ${G}
ðŸ“… Delivery Date: ${n}
ðŸ’° Estimated Cost (à²…à²‚à²¦à²¾à²œà³ à²µà³†à²šà³à²š): ${ee}

`+te+be+`â„¹ï¸ Final prices may vary based on actual service needs.

Need any help? Just reply here.

â€” ${r?.executive||"Team"}, ${V}${O?` (â˜Žï¸ ${O})`:""}`}function en(r){const m=(r?.custName?String(r.custName).trim():"")||"â€”",n=r?.custMobile?String(r.custMobile).replace(/\D/g,"").slice(-10):"â€”",v=(r?.model?String(r.model).trim():"")||"â€”",O=(r?.regNo?String(r.regNo).trim():"")||"â€”",V=(r?.serviceType?String(r.serviceType).trim():"")||"â€”",D=(r?.floorMat?String(r.floorMat).trim():"")||"â€”",T=r?.createdAt?A(r.createdAt).format("DD-MM-YYYY HH:mm"):"â€”",G=String(r?.km??"").toUpperCase().trim(),ee=G.replace(/\s*KM\s*$/i,"").replace(/\D/g,""),fe=ee?`${ee} KM`:G||"â€”",be=r?.obs?r.obs.split(`
`).map(U=>U.trim()).filter(Boolean):[],W=be.length?be.map(U=>`â€¢ ${U}`).join(`
`):"â€¢ â€”";return["*Job Card Details (Mechanic)* ðŸ› ï¸","",`ðŸ•’ Job Card Created: ${T}`,`ðŸ‘¤ Customer Name: ${m}`,`ðŸ“ž Mobile Number: ${n}`,`ðŸ”§ Model: ${v}`,`ðŸï¸ Vehicle Number: ${O}`,`ðŸ§¼ Floor Mat: ${D}`,`ðŸ› ï¸ Service Type: ${V}`,`ðŸ§¾ Odometer Rating: ${fe}`,"","*Customer Observation:*",W].join(`
`)}function ps({mobileE164:r,text:m,onFailToWhatsApp:n,allowSmsFallback:v=!0}){const O=`https://wa.me/${r}?text=${encodeURIComponent(m)}`,V=window.open(O,"_blank","noopener,noreferrer");if(!V||V.closed||typeof V.closed>"u"){if(n?.(),v){const T=`sms:+${r}?body=${encodeURIComponent(m)}`;window.location.href=T}return{opened:!1,blocked:!0}}return v?(setTimeout(()=>{try{if(V.closed)return;n?.(),V.close();const T=`sms:+${r}?body=${encodeURIComponent(m)}`;window.location.href=T}catch{n?.();const T=`sms:+${r}?body=${encodeURIComponent(m)}`;window.location.href=T}},1e3),{opened:!0,blocked:!1}):{opened:!0,blocked:!1}}function tn(r,m,n,v={}){const O=r?.jcNo||"â€”",V=r?.regNo||"â€”",D=r?.model||"",T=r?.colour?String(r.colour).trim():"",G=r?.km?String(r.km).replace(/\D/g,""):"",ee=r?.branch||"â€”",fe=r?.executive||"Team",be=Gs(),W=String(ee).toLowerCase().replace(/[^a-z]/g,""),U=W.includes("byadarahalli")||W.includes("badrally"),te=U?"NH Motors":"Shantha Motors",ce=U?"à²Žà²¨à³ à²Žà²šà³ à²®à³‹à²Ÿà²°à³à²¸à³":"à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³",xe=A().format("DD-MM-YYYY HH:mm"),re=b=>String(b).replace(/\s+/g," ").trim(),H=b=>Fe(Math.round(Number(b||0))),g=(n||[]).map((b,E)=>{const Se=Number(b?.qty||0),Ve=Number(b?.rate||0),Oe=Se*Ve,Ke=String(b?.desc||"").trim()||"Item";return`${E+1}. ${re(Ke)} â€” ${Se} Ã— ${H(Ve)} = ${H(Oe)}`}),k=H(m?.labourSub||0),ve=Math.max(0,Math.round(Number(m?.labourDisc||0))),J=H(ve),nt=H(m?.grand||0),le=v||{},Ee=H(le?.collectedAmount||0),me=le?.cashCollected?H(le.cashCollected):"",De=le?.onlineCollected?H(le.onlineCollected):"",se=Array.isArray(le?.payments)?le.payments.filter(b=>String(b.mode).toLowerCase()==="online"&&b.utr).map(b=>String(b.utr).trim()).filter(Boolean).join(" / "):"",Je=le?.paymentMode?String(le.paymentMode).toUpperCase():"";let de="";const ye=Number(G||"");Number.isFinite(ye)&&ye>0&&(de=String(ye+2e3));const qe=ve>0?`Discount: ${J}`:"",Pe=`ðŸ’³ *Mode Of Payment (${Je||"NA"})*`,ae=[];me&&ae.push(`â€¢ Cash: ${me}`),De&&ae.push(`â€¢ Online: ${De}${se?` (UTR: ${se})`:""}`),ae.length?ae.push(`â€¢ Total Paid: ${Ee}`):ae.push(`â€¢ Total Paid: ${Ee}`);const ht=[Pe,...ae];return[`â­ï¸ *${te}* â€” ${ce}`,"Multi Brand Two Wheeler Sales & Service","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","*âœ”ï¸ Service Invoice*","",`ðŸ“… Date: ${xe}`,`ðŸ§¾ JC No: ${O}`,"","ðŸï¸ *Vehicle Details*",`â€¢ Vehicle: ${V}${D?` (${D})`:""}${T?` â€¢ ${T}`:""}`,...G?[`â€¢ Odometer Reading: ${G} km`]:[],...de?[`â€¢ *Next Service Due:* ${de} km`]:[],"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","","ðŸ› ï¸ *Service Details*",...g.length?g.map(b=>`â€¢ ${b}`):["â€¢ â€”"],"",`Subtotal: ${k}`,...qe?[qe]:[],`ðŸ’° *Final Bill Amount:* ${nt}`,"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","",...ht,"","â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€","",`ðŸ™ Thank you for choosing *${te}*!`,"à²§à²¨à³à²¯à²µà²¾à²¦à²—à²³à³ â¤ï¸",`â€” ${fe}, ${ee}${be?` (â˜Žï¸ ${be})`:""}`].join(`
`)}function Vn({initialValues:r=null}={}){const m=Do(),[n]=j.useForm(),[,v]=c.useState(),[O,V]=c.useState(""),[D,T]=c.useState(""),[G,ee]=c.useState([]),[fe,be]=c.useState(!1),[W,U]=c.useState(""),[te,ce]=c.useState(""),[xe,re]=c.useState(""),[H,g]=c.useState([]),k="JobCard:outbox",ve=6e3,J=c.useRef({jcNo:"",ts:0,inFlight:!1}),nt=s=>{const t=J.current;t.jcNo===s&&(t.inFlight=!1)},le=(s,t)=>{try{const l=localStorage.getItem(s);return l?JSON.parse(l):t}catch{return t}},Ee=(s,t)=>{try{localStorage.setItem(s,JSON.stringify(t))}catch{}},me=s=>{const t=le(k,[]),l={id:Date.now()+":"+Math.random().toString(36).slice(2),job:s};return t.push(l),Ee(k,t),l.id},De=s=>{const t=le(k,[]);Ee(k,t.filter(l=>l.id!==s))},[se,Je]=c.useState(""),[de,ye]=c.useState(null),[qe,Pe]=c.useState(null),[ae,ht]=c.useState(!1),[Mt,b]=c.useState(""),E=c.useRef(null),Se=c.useRef(null),[Ve,Oe]=c.useState(!1),[Ke,gt]=c.useState(!1),[Te,ze]=c.useState(!1),[Ct,ft]=c.useState(!1),[At,ke]=c.useState(1),[pe,Ze]=c.useState({customer:!1,mechanic:!1,pre:!1}),[Wt,Ge]=c.useState(!1),[Qe,Dt]=c.useState("cash"),[Le,rt]=c.useState(""),[Xe,at]=c.useState(""),[$e,o]=c.useState("online"),[a,d]=c.useState(""),[h,S]=c.useState(""),[oe,z]=c.useState(""),[L,M]=c.useState(us),[y,I]=c.useState(0),[Ne,f]=c.useState(!1),[Ae,he]=c.useState(!1),[Q,X]=c.useState([]),[je,Re]=c.useState(!1),[yt,hs]=c.useState(null),[Ue,Tt]=c.useState(null),[Ie,Jt]=c.useState(!1),[gs,qt]=c.useState(null),Kt=c.useRef(""),zt=c.useRef(""),[bt,fs]=c.useState([]),[kt,Zt]=c.useState(""),Yt=(s=6e3)=>{const t=Date.now()+s;I(t),setTimeout(()=>I(0),s+50)},[,ys]=c.useState(!1),[,bs]=c.useState(()=>A().add(2,"day").hour(10).minute(0).second(0).millisecond(0)),[,xs]=c.useState(""),Qs=["createdAt","branch","mechanic","executive","expectedDelivery","regNo","company","model","km","custName","custMobile","serviceType","vehicleType"],vs=s=>{const t=[...Qs];return s?.vehicleType==="Scooter"&&t.push("floorMat"),String(s?.serviceType||"").toLowerCase()==="free"&&t.push("chassisNo"),t},Ss=async()=>{try{const s=le(k,[]);if(!Array.isArray(s)||!s.length)return;for(const t of s){const l=t.job||{};try{if(l.type==="save"&&Ye){const i=await ot({webhookUrl:Ye,method:"POST",payload:{action:"save",data:l.data}});(i?.data||i)?.success!==!1&&De(t.id)}else if(l.type==="post"&&Ye){const i=await ot({webhookUrl:Ye,method:"POST",payload:{action:"postService",data:l.data}});(i?.data||i)?.success!==!1&&De(t.id)}}catch{}}}catch{}};c.useEffect(()=>{setTimeout(()=>{Ss()},0)},[]),c.useEffect(()=>{const s=()=>Ss();return window.addEventListener("online",s),()=>window.removeEventListener("online",s)},[]);const et=()=>{const s=n.getFieldsValue(!0),t=vs(s),l=t.every(p=>{const w=n.getFieldValue(p);return w!=null&&String(w).trim()!==""}),i=n.getFieldsError(t).some(({errors:p})=>p.length>0);let u="";if(l)i&&(u="Fix validation errors in highlighted fields.");else{const p=t.filter(w=>{const $=n.getFieldValue(w);return $==null||String($).trim()===""});p.length&&(u=`Missing: ${p.join(", ")}`)}ht(l&&!i),b(u)},Xs=async()=>{const s=n.getFieldsValue(!0),t=vs(s);await n.validateFields(t)},Ns=c.useMemo(()=>({jcNo:"",createdAt:A(),expectedDelivery:A(),branch:void 0,executive:void 0,mechanic:"",serviceType:void 0,vehicleType:void 0,floorMat:"No",fuelLevel:void 0,regNo:"",company:"",model:"",colour:"",chassisNo:"",km:void 0,custName:"",custMobile:"",obs:"",labourRows:[],gstLabour:st,discounts:{labour:0}}),[]),js=c.useMemo(()=>{try{const s=m?.search||"";if(!s)return null;const t=new URLSearchParams(s),l=We(t.get("regNo")||"",""),i=K(t.get("company")||""),u=K(t.get("model")||""),p=K(t.get("colour")||t.get("color")||""),w=K(t.get("custName")||t.get("customerName")||""),$=t.get("custMobile")||t.get("mobile")||"",Y=wt(t.get("chassisNo")||t.get("chassis")||"");return[l,i,u,p,Y,w,$].some(R=>String(R||"").trim())?{formValues:{regNo:l,company:i,model:u,colour:p,chassisNo:Y,custName:w,custMobile:String($||"").replace(/\D/g,"").slice(-10)}}:null}catch{return null}},[m?.search]),eo=c.useMemo(()=>{try{const s=m?.search||"";if(!s)return null;const t=new URLSearchParams(s);if(!(t.get("autoFetch")||t.get("fetch")))return null;const i=t.get("query")||t.get("mobile")||t.get("custMobile")||t.get("jcNo")||t.get("jc")||"";if(!String(i||"").trim())return null;let u=t.get("mode")||"";return u||(t.get("jcNo")||t.get("jc")?u="jc":t.get("vehicle")||t.get("reg")?u="vehicle":u="mobile"),{mode:u,query:i}}catch{return null}},[m?.search]);c.useEffect(()=>{let s=!1;return(async()=>{try{const l=await fetch(qo,{cache:"no-store"});if(!l.ok)throw new Error("sheet fetch failed");const i=await l.text();if(i.trim().startsWith("<"))throw new Error("expected CSV, got HTML");const u=Ko(i);if(!u.length)throw new Error("empty sheet");const p=u[0].map(Y=>(Y||"").trim()),$=u.slice(1).map(Y=>{const P={};return p.forEach((R,_)=>P[R]=Y[_]??""),P}).map(zo).filter(Y=>Y.company&&Y.model);s||fs($)}catch{try{const l=await fetch("/bikeData.json",{cache:"no-store"});if(!l.ok)throw new Error("fallback missing");const i=await l.json(),u=(Array.isArray(i)?i:[]).map(Zo).filter(p=>p.company&&p.model);s||fs(u)}catch{}}})(),()=>{s=!0}},[]),c.useEffect(()=>{const s=r||js;if(s)try{const t=s.formValues||s,l=B=>{if(!B)return A();const C=A(B,["DD-MM-YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY","YYYY-MM-DD",A.ISO_8601],!0);return C.isValid()?C:null},i=t.km?`${String(t.km).replace(/\D/g,"")} KM`:"",u=We(t.regNo||"",""),p=K(t.company||""),w=K(t.model||""),$=K(t.colour||""),Y=wt(t.chassisNo||t.chassis||""),P=K(t.custName||""),R=K((t.obs||"").replace(/\s*#\s*/g,`
`)),_={jcNo:t.jcNo||"",branch:t.branch||void 0,mechanic:t.mechanic||void 0,executive:t.executive||void 0,expectedDelivery:l(t.expectedDelivery),regNo:u,company:p,model:w,colour:$,chassisNo:Y,km:i,fuelLevel:t.fuelLevel||void 0,custName:P,custMobile:String(t.custMobile||"").replace(/\D/g,"").slice(-10),obs:R,vehicleType:t.vehicleType||void 0,serviceType:t.serviceType||void 0,floorMat:t.floorMat==="Yes"?"Yes":t.floorMat==="No"?"No":void 0,discounts:{labour:0},gstLabour:st,labourRows:ds(Array.isArray(r?.labourRows)&&r.labourRows.length?r.labourRows:Bt(t.serviceType,t.vehicleType))};n.setFieldsValue(_),Je(_.regNo||""),p&&Zt(p),ye(t.serviceType||null),Pe(t.vehicleType||null)}catch{}},[r,js]),c.useEffect(()=>{(async()=>{try{const s=u=>String(u||"").trim().toUpperCase(),t=()=>{try{const u=localStorage.getItem("user");return u?JSON.parse(u):null}catch{return null}},l=u=>u?typeof u=="string"?u:typeof u=="object"&&(u._id||u.id||u.$oid)||null:null;let i=t();if(!i||!i.formDefaults){const u=await To().catch(()=>null);if(u?.success&&u.data){i=u.data;try{localStorage.setItem("user",JSON.stringify(i))}catch(p){}}}if(i){const u=i?.formDefaults?.staffName||i?.name||void 0,p=u?s(u):void 0,w=i?.role?String(i.role).toLowerCase():void 0,$=!!i?.canSwitchBranch||["owner","admin"].includes(String(w||"").toLowerCase());be($);try{const B=String(w||"").toLowerCase();if(["owner","admin"].includes(B)){try{const C=await Po({status:"active",limit:500});if(C?.success&&Array.isArray(C?.data?.items)){const Me=C.data.items.filter(ue=>String(ue?.status||"").toLowerCase()==="active").map(ue=>({id:String(ue.id||ue._id||""),name:s(ue.name),code:ue.code?String(ue.code).toUpperCase():""}));ee(Me)}}catch{}try{const C=await Ro({role:"staff",status:"active",limit:1e5});if(C?.success&&Array.isArray(C?.data?.items)){const Z=C.data.items.map(Me=>({name:Me.name,phone:Me.phone||""}));g(Z)}}catch{}}else{const C=[],Z=ne=>{if(!ne)return;const St=typeof ne=="string"?"":String(ne?.status||"").toLowerCase();if(St&&St!=="active")return;const Nt=ne&&(ne._id||ne.id||ne.$oid||ne)||"",Vt=typeof ne=="string"?"":ne?.name||"",dt=s(Vt),ut=typeof ne=="string"?"":ne?.code||"";!Nt||!dt||C.push({id:String(Nt),name:String(dt),code:ut?String(ut).toUpperCase():""})};i?.primaryBranch&&Z(i.primaryBranch),Array.isArray(i?.branches)&&i.branches.forEach(Z);const Me=new Set,ue=[];C.forEach(ne=>{Me.has(ne.id)||(Me.add(ne.id),ue.push(ne))}),ee(ue)}}catch{}let Y=i?.formDefaults?.branchName?s(i.formDefaults.branchName):void 0;const P=i?.formDefaults?.branchCode&&String(i.formDefaults.branchCode).toUpperCase()||"";if(P){ce(P);try{n.setFieldsValue({branchCode:P})}catch{}}const R=i?.formDefaults&&(i.formDefaults.branchId?._id||i.formDefaults.branchId||null)||i?.primaryBranch&&(i.primaryBranch?._id||i.primaryBranch||null)||Array.isArray(i?.branches)&&i.branches.length&&(i.branches[0]?._id||i.branches[0])||null;if(R)try{const B=await Fo(String(R)).catch(()=>null);if(B?.success&&B?.data&&(Y||(Y=B.data.name),B?.data?.code&&!te)){const C=String(B.data.code).toUpperCase();ce(C),re(String(B.data.id||R));try{n.setFieldsValue({branchCode:C})}catch{}}}catch{}p&&v(p),w&&V(w);const _={};try{const B=n.getFieldsValue(["branch","executive"])||{};!B?.executive&&p&&(_.executive=p),!B?.branch&&Y&&(_.branch=Y)}catch{}Object.keys(_).length&&n.setFieldsValue(_),Y&&T(Y),p&&U(p)}}catch{}})()},[n]);const to=ko.useMemo(()=>{const s=new Map;return(G||[]).forEach(t=>s.set(String(t.name||"").toLowerCase(),t)),s},[G]),so=s=>{try{const t=String(s||"").toLowerCase(),l=to.get(t);if(l){re(l.id),l.code&&ce(String(l.code).toUpperCase());try{n.setFieldsValue({branch:l.name,branchCode:l.code?String(l.code).toUpperCase():void 0})}catch{}}}catch{}},it=j.useWatch("branch",n),ws=j.useWatch("executive",n),oo=String(it||D||"").trim().toLowerCase().replace(/\s+/g,"").includes("byadarahalli");c.useEffect(()=>{const s={};!it&&D&&(s.branch=D),!ws&&W&&(s.executive=W),Object.keys(s).length&&n.setFieldsValue(s)},[it,ws,D,W]);const xt=c.useMemo(()=>{const s=String(O||"").toLowerCase();return["owner","admin","backend"].includes(s)?"":it||D||""},[O,it,D]),Gt=c.useMemo(()=>{const s=String(O||"").toLowerCase();return["owner","admin","backend"].includes(s)?!0:!!String(xt||"").trim()},[O,xt]),Pt=je?Q.length:null,no=s=>{const t=s?.values||s||{},l=s?.payload||t.Payload||t.payload||t.PAYLOAD||s?.Payload||s?.PAYLOAD||"";let i={};try{i=typeof l=="object"?l:JSON.parse(String(l||"{}"))}catch{i={}}const u=i.formValues||i.values||{},p=(_,B)=>{for(const C of B){const Z=_?.[C];if(Z!=null&&String(Z).trim()!=="")return String(Z).trim()}return""},w=i?.postServiceAt||t["Post Service At"]||t.Post_Service_At||t.PostServiceAt||"",$=Array.isArray(i?.payments)&&i.payments.some(_=>Number(_?.amount||0)>0),Y=w||$?"completed":"pending";let P=i?.followUp?.at||i?.followup?.at||i?.followUpAt||t["Follow-up At"]||t["Follow Up At"]||t["Followup At"]||t["Follow-up Date"]||t["Follow Up Date"]||t["Followup Date"]||"";if(!P){const _=t["Follow-up Date"]||t["Follow Up Date"]||t["Followup Date"]||"",B=t["Follow-up Time"]||t["Follow Up Time"]||t["Followup Time"]||"";_&&B&&(P=`${_} ${B}`)}const R=P?A(P,["DD-MM-YYYY HH:mm","DD/MM/YYYY HH:mm","DD-MM-YYYY","DD/MM/YYYY",A.ISO_8601],!0):null;return{jcNo:u.jcNo||p(t,["JC No","JC No.","Job Card No","JC Number"])||"-",name:u.custName||p(t,["Customer Name","Customer_Name","Name"])||"-",mobile:String(u.custMobile||p(t,["Mobile","Mobile Number","Phone"])||"").replace(/\D/g,"").slice(-10),regNo:u.regNo||p(t,["Vehicle No","Vehicle_No","Reg No","Registration Number"])||"-",branch:u.branch||p(t,["Branch","Branch Name"])||"-",followUpAt:R&&R.isValid()?R.format("DD-MM-YYYY HH:mm"):P||"",followUpNotes:i?.followUp?.notes||i?.followupNotes||i?.followUpNotes||t["Follow-up Notes"]||t["Follow Up Notes"]||t["Followup Notes"]||"",status:Y,payload:i}},Qt=async({silent:s=!1}={})=>{if(!Gt){X([]),Re(!1);return}s||he(!0);try{const t={action:"list",status:"pending",page:1,pageSize:200},l=xt?{branch:xt}:{},i=Is?{...t,...l,secret:Is}:{...t,...l},u=await ot({webhookUrl:Ye,method:"GET",payload:i}),p=u?.data||u,Y=(Array.isArray(p?.data)?p.data:Array.isArray(p?.rows)?p.rows:[]).map(no).filter(P=>P&&P.jcNo!=="-").filter(P=>P.status==="pending");X(Y),Re(!0)}catch{X([]),Re(!0)}finally{s||he(!1)}};c.useEffect(()=>{if(!Gt){X([]),Re(!1);return}X([]),Re(!1),Qt({silent:!0})},[Gt,xt]);const ro=s=>{const t=We(s.target.value,se);Je(t),n.setFieldsValue({regNo:t}),String(t||"").length<10&&(Kt.current="")},ao=It.test(We(se||n.getFieldValue("regNo")||"",se||"")),Ms=j.useWatch("labourRows",n),Be=c.useMemo(()=>ds(Ms||[]),[Ms]),Cs=j.useWatch("gstLabour",n)??st,As=j.useWatch("discounts",n),Ds=c.useMemo(()=>As||{labour:0},[As]),io=j.useWatch("km",n),ct=j.useWatch("company",n),Ts=j.useWatch("custMobile",n);c.useEffect(()=>{const s=We(se||n.getFieldValue("regNo")||"",se||"");String(s||"").length<10||It.test(s)&&(Ie||Kt.current!==s&&(Kt.current=s,Ft("vehicle")))},[se,Ie,n]),c.useEffect(()=>{const s=String(Ts||"").replace(/\D/g,"").slice(-10);s.length===10&&(Ie||zt.current!==s&&(zt.current=s,Ft("mobile")))},[Ts,Ie]);const ge=c.useMemo(()=>{const s=Be.reduce((u,p)=>u+Number(p?.qty||0)*Number(p?.rate||0),0),t=s*(Number(Cs)/100),l=Number(Ds.labour||0),i=Math.max(0,s+t-l);return{labourSub:s,labourGST:t,labourDisc:l,grand:i}},[Be,Cs,Ds]),co=c.useMemo(()=>Vs(bt.map(s=>s.company)),[bt]),lo=c.useMemo(()=>{const s=Os(ct||kt),t=s?bt.filter(l=>Os(l.company)===s):bt;return Vs(t.map(l=>l.model))},[bt,ct,kt]);c.useEffect(()=>{ct&&ct!==kt&&Zt(ct)},[ct,kt]);const ks=c.useMemo(()=>{const s=L.at;if(!s)return"";const t=A(s);return t.isValid()?t.format("DD-MM-YYYY HH:mm"):String(s)},[L.at]),we=!!L.locked,Xt=c.useMemo(()=>{const s=Number(Le||0)||0,t=Number(a||0)||0;return Math.round(s+t)},[Le,a]),es=c.useMemo(()=>Math.round(Number(ge?.grand||0)),[ge]),lt=c.useMemo(()=>es-Xt,[Xt,es]),uo=s=>{/[0-9]/.test(s.key)||s.preventDefault()},mo=s=>{/[0-9]/.test(s.key)||s.preventDefault()},po=s=>{const t=s.target.value;/^\d*$/.test(t)&&(t.length>10||(L.locked&&L.mobile&&L.mobile!==t&&M(us),n.setFieldsValue({custMobile:t}),String(t||"").length<10&&(zt.current="")))},Rt=(Number(String(io||"").replace(/\D/g,""))||0)>1e4,Ft=s=>{if(s==="vehicle"){const l=se||n.getFieldValue("regNo")||"",i=We(l,se||"");if(!It.test(i)){x.warning("Enter vehicle no. as KA03AB1234.");return}qt("vehicle"),Jt(!0),Tt({mode:"vehicle",query:i,token:Date.now(),prefill:"basic",autoPickLatest:!0,openModal:!1,source:"inline"});return}const t=String(n.getFieldValue("custMobile")||"").replace(/\D/g,"").slice(-10);if(t.length!==10){x.warning("Enter a valid 10-digit mobile number.");return}qt("mobile"),Jt(!0),Tt({mode:"mobile",query:t,token:Date.now(),prefill:"basic",autoPickLatest:!0,openModal:!1,source:"inline"})},ho=Bs.map(s=>({label:s,value:s,disabled:s==="Free"&&Rt})),vt=(s={})=>{const t={...s};return t.regNo=We(t.regNo||""),t.company=K(t.company||""),t.model=K(t.model||""),t.colour=K(t.colour||""),t.chassisNo=wt(t.chassisNo||t.chassis||""),t.custName=K(t.custName||""),t.obs=K(t.obs||""),t.labourRows=ds(t.labourRows||[]),t},go=s=>{let t=null;if(s.length===0?t=null:s.length===1?t=s[0]:t=s.find(l=>l!==de)||s[0],Rt&&t==="Free"){x.warning("Free service is not allowed above 10,000 KM.");return}if(ye(t||null),n.setFieldsValue({serviceType:t||void 0}),t){const l="Motorcycle";Pe(l),n.setFieldsValue({vehicleType:l,labourRows:Bt(t,l),gstLabour:st,discounts:{labour:0},floorMat:"No"}),x.success(`Applied preset: ${t} / ${l}`)}else n.setFieldsValue({labourRows:[]});et()};c.useEffect(()=>{Rt&&de==="Free"&&(ye(null),n.setFieldsValue({serviceType:void 0}),et(),x.warning("Free service disabled for odometer above 10,000 KM."))},[Rt,de,n]),c.useEffect(()=>{et()},[]);const Ys=async s=>{Date.now()<y||(Yt(6e3),await new Promise(requestAnimationFrame),s==="pre"?await Es(E.current):s==="post"&&await Es(Se.current))},fo=s=>s?A(s).format("DD-MM-YYYY HH:mm"):"",ts=" # ",ss=async()=>{try{await Xs();const s=vt(n.getFieldsValue(!0));let t=s.jcNo;if(!/^JC-[A-Z]+-[A-Z0-9]{6}$/.test(String(t||"").trim())){try{t=await qs(s.custMobile,te||(n.getFieldValue("branchCode")||"").toUpperCase(),xe)}catch{t=A().format("YYMMDDHHmmss")}n.setFieldsValue({jcNo:t}),x.success(`JC No. assigned: ${t}`)}const i=J.current,u=Date.now();if(i.jcNo===t&&(i.inFlight||u-i.ts<ve))return;i.jcNo=t,i.ts=u,i.inFlight=!0;const p=Number.isFinite(ge.grand)?Math.round(ge.grand):0,w=String(s.km||"").replace(/\D/g,""),$=typeof s.floorMat=="string"?s.floorMat:s.floorMat===!0?"Yes":(s.floorMat===!1,"No"),Y=String(s.obs||"").replace(/\s*\r?\n\s*/g,ts).replace(new RegExp(`^(?:\\s*${ts}\\s*)+|(?:\\s*${ts}\\s*)+$`,"g"),"").trim(),P=new Date().toISOString(),R=s.savedAt||n.getFieldValue("savedAt")||s.createdAt,B=(typeof R=="string"&&R.trim()?R:A.isDayjs(R)||R instanceof Date&&!isNaN(R.getTime())?R.toISOString():"")||P;try{n.setFieldsValue({savedAt:B})}catch{}const C={savedAt:B,updatedAt:P,formValues:{jcNo:t,branch:s.branch||"",mechanic:s.mechanic||"",executive:s.executive||"",expectedDelivery:fo(s.expectedDelivery),regNo:s.regNo||"",company:s.company||"",model:s.model||"",colour:s.colour||"",chassisNo:s.chassisNo||"",km:w||"",fuelLevel:s.fuelLevel||"",custName:String(s.custName||"").trim(),custMobile:String(s.custMobile||""),obs:Y,vehicleType:s.vehicleType||"",serviceType:s.serviceType||"",floorMat:$,amount:String(p)},labourRows:Be||[],totals:ge};x.success({content:"Saved successfully",key:"autosave",duration:1.5});const Z={jcNo:t,formValues:C.formValues,payload:C},Me=me({type:"save",data:Z});setTimeout(async()=>{try{const ue=await Qo(Z);(ue?.data||ue)?.success!==!1&&De(Me)}catch{}finally{nt(t)}},0)}catch(s){if(s?.errorFields)x.error("Please complete required fields before auto-saving.");else{const t=s?.response?.data?.message||s?.message||"Failed to auto-save. Please try again.";x.error(t)}throw s}},os=async s=>{try{if(ze(!0),await new Promise(N=>setTimeout(N,0)),Date.now()<y)return;Yt(6e3);const t=vt(n.getFieldsValue(!0)),l=String(t.custMobile||"").replace(/\D/g,"").slice(-10);if(l.length!==10){x.error("Enter a valid 10-digit mobile number.");return}let i=t.jcNo;if(!/^JC-[A-Z]+-[A-Z0-9]{6}$/.test(String(i||"").trim()))try{i=await qs(t.custMobile,te||(n.getFieldValue("branchCode")||"").toUpperCase(),xe),n.setFieldsValue({jcNo:i})}catch(N){}const p=Number.isFinite(ge.grand)?Math.round(ge.grand):0,w=String(t.km||"").replace(/\D/g,""),$=typeof t.floorMat=="string"?t.floorMat:t.floorMat===!0?"Yes":(t.floorMat===!1,"No"),Y=String(t.obs||"").replace(/\s*\r?\n\s*/g," # ").trim(),P=String(oe||"").trim(),R=Number(Le||0)||0,_=Number(a||0)||0;if(!(R>0||_>0)){x.error("Enter amount for Cash or Online (at least one).");return}if(Qe==="online"&&R>0&&String(Xe||"").trim().length<4){x.error("Enter UTR for Online (Slot 1).");return}if($e==="online"&&_>0&&String(h||"").trim().length<4){x.error("Enter UTR for Online (Slot 2).");return}const C=[];R>0&&C.push({amount:Math.round(R),mode:Qe,...Qe==="online"?{utr:String(Xe||"").trim()}:{}}),_>0&&C.push({amount:Math.round(_),mode:$e,...$e==="online"?{utr:String(h||"").trim()}:{}});const Z=C.reduce((N,Ce)=>N+(Number(Ce.amount)||0),0),Me=Array.from(new Set(C.map(N=>N.mode))),ue=Me.length>1?"mixed":Me[0]||"",St=C.filter(N=>N.mode==="online"&&N.utr).map(N=>N.utr).join(" / "),Nt=C.filter(N=>String(N.mode).toLowerCase()==="cash").reduce((N,Ce)=>N+(Number(Ce.amount)||0),0),Vt=C.filter(N=>String(N.mode).toLowerCase()==="online").reduce((N,Ce)=>N+(Number(Ce.amount)||0),0),dt=Math.round(Number(p||0));if(Z!==dt){const N=dt-Z,Ce=`Payable: â‚¹${dt}. Collected: â‚¹${Z}. ${N>0?"Pending":"Excess"}: â‚¹${Math.abs(N)}.`;try{pt.warning({title:"Please collect full amount",content:Ce})}catch{}x.error(`Please collect full amount. ${Ce}`);return}const ut=new Date().toISOString(),He=t.savedAt||n.getFieldValue("savedAt")||t.createdAt,Rs=(typeof He=="string"&&He.trim()?He:A.isDayjs(He)||He instanceof Date&&!isNaN(He.getTime())?He.toISOString():"")||ut;try{n.setFieldsValue({savedAt:Rs})}catch{}const wo={savedAt:Rs,updatedAt:ut,postServiceAt:ut,formValues:{mechanic:t.mechanic||"",executive:t.executive||"",company:t.company||"",model:t.model||"",colour:t.colour||"",chassisNo:t.chassisNo||"",km:w||"",fuelLevel:t.fuelLevel||"",vehicleType:t.vehicleType||"",floorMat:$,expectedDelivery:t.expectedDelivery?A(t.expectedDelivery).format("DD-MM-YYYY HH:mm"):"",obs:Y,remarks:P},labourRows:Be||[],totals:ge};x.success({key:"postsave",content:"Saved successfully"});const Mo=t.expectedDelivery?A(t.expectedDelivery).format("DD-MM-YYYY HH:mm"):"",Fs={mobile:l,jcNo:i,serviceAmount:p,collectedAmount:Z,paymentMode:ue,payments:C,utr:St||void 0,utrNo:St||void 0,remarks:P,payload:{...wo,payments:C,remarks:P},formValues:{custName:String(t.custName||""),custMobile:l,branch:String(t.branch||""),executive:String(t.executive||""),regNo:String(t.regNo||""),company:String(t.company||""),serviceType:String(t.serviceType||""),vehicleType:String(t.vehicleType||""),mechanic:String(t.mechanic||""),model:String(t.model||""),colour:String(t.colour||""),chassisNo:String(t.chassisNo||""),km:w||"",fuelLevel:String(t.fuelLevel||""),expectedDelivery:Mo,obs:Y,remarks:P},source:"jobcard",cashCollected:Nt,onlineCollected:Vt,totalCollected:Z},Co=me({type:"post",data:Fs});if(setTimeout(async()=>{try{let N=!0;if(Ye){const Ce=await ot({webhookUrl:Ye,method:"POST",payload:{action:"postService",data:Fs}});N=(Ce?.data||Ce)?.success!==!1}N&&De(Co)}catch{}},0),s===!0||s==="print")await new Promise(N=>setTimeout(N,50)),await Ys("post");else if(s==="whatsapp")try{const N=ms(t.custMobile);if(!N)x.error("Enter a valid 10-digit mobile number (India).");else{const Ao=tn(t,ge,Be,{payments:C,collectedAmount:Z,cashCollected:Nt,onlineCollected:Vt,paymentMode:ue});x.loading({key:"postshare",content:"Preparing WhatsApp messageâ€¦"}),ps({mobileE164:N,text:Ao,onFailToWhatsApp:()=>{x.info({key:"postshare",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2})}}),setTimeout(()=>{x.success({key:"postshare",content:"Ready to send.",duration:2})},800)}}catch{}Oe(!1),rt(""),at(""),d(""),S(""),z("");try{n.resetFields();const N={...Ns,createdAt:A(),expectedDelivery:null,branch:D||void 0,executive:W||void 0,jcNo:"",labourRows:[],discounts:{labour:0},gstLabour:st};n.setFieldsValue(N),ye(null),Pe(null),Je(""),ys(!1),bs(null),xs(""),M(us),Ze({customer:!1,mechanic:!1,pre:!1}),ke(1),Ge(!1),ft(!1),et(),x.success("Ready for the next Job Card")}catch{}}catch(t){console.warn("post-service save error:",t),x.error(t&&t.message||"Could not save post-service details.")}finally{ze(!1)}},Et=vt(n.getFieldsValue(!0)),yo=[...(Be||[]).map(s=>s.desc),...Et?.obs?Et.obs.split(`
`).map(s=>s.trim()).filter(Boolean):[]],ns=s=>({display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,padding:"12px 14px",border:"1px solid #e5e7eb",borderRadius:8,background:At===s?"#f0fdf4":"#fff"}),bo=async(s={})=>{const t=s&&typeof s.preventDefault=="function"?{}:s||{},l=t.allowSmsFallback!==!1,i=t.onPopupBlocked;try{if(Date.now()<y)return;Yt(6e3),await ss();const u=vt(n.getFieldsValue(!0));await n.validateFields(["custName","custMobile","branch"]);const p=ms(u.custMobile);if(!p){x.error("Enter a valid 10-digit mobile number (India).");return}const w=Xo(u,ge);x.loading({key:"share",content:"Preparing WhatsApp messageâ€¦"});const $=ps({mobileE164:p,text:w,allowSmsFallback:l,onFailToWhatsApp:()=>{l&&x.info({key:"share",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2}),i?.()}});return setTimeout(()=>{x.success({key:"share",content:"Ready to send.",duration:2})},800),$}catch{return null}},Ps=async(s={})=>{const t=s&&typeof s.preventDefault=="function"?{}:s||{},l=t.allowSmsFallback!==!1,i=t.onPopupBlocked,u=t.skipCooldown===!0;try{if(!u&&Date.now()<y)return;u||Yt(6e3),await ss();const p=vt(n.getFieldsValue(!0));await n.validateFields(["mechanic"]);const w=String(p.mechanic||"").trim(),$=Zs(w),Y=ms($);if(!Y){x.error(w?`No phone number found for mechanic ${w}.`:"Select a mechanic with a saved phone number.");return}const P=en(p);x.loading({key:"mechshare",content:"Preparing mechanic WhatsApp messageâ€¦"});const R=ps({mobileE164:Y,text:P,allowSmsFallback:l,onFailToWhatsApp:()=>{l&&x.info({key:"mechshare",content:"WhatsApp may not be available. Falling back to SMS composerâ€¦",duration:2}),i?.()}});return setTimeout(()=>{x.success({key:"mechshare",content:"Ready to send.",duration:2})},800),R}catch{return null}},xo=async()=>{let s=!1;try{gt(!0),await new Promise(t=>setTimeout(t,0)),await ss(),await Ys("pre"),s=!0}catch{}finally{gt(!1)}return s},vo=()=>{Ge(!1),ke(()=>pe.customer?pe.mechanic?3:2:1),ft(!0)},So=async()=>{if(!ae||y>Date.now()||(Ge(!1),!await bo()))return;const t=!pe.mechanic;if(Ze(i=>({...i,customer:!0})),ke(t?2:3),!t)return;(await Ps({allowSmsFallback:!1,onPopupBlocked:()=>Ge(!0),skipCooldown:!0}))?.opened&&(Ze(i=>({...i,mechanic:!0})),ke(3))},No=async()=>{!ae||(Ge(!1),!await Ps({skipCooldown:!0}))||(Ze(t=>({...t,mechanic:!0})),ke(3))},jo=async()=>{if(!ae||Ke)return;await xo()&&Ze(t=>({...t,pre:!0}))};return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        .wrap { max-width: 1000px; margin: 12px auto; padding: 0 12px; }
        .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
        /* Make header actions stack on small screens */
        @media screen and (max-width: 600px) {
          .brand-actions-row { grid-template-columns: 1fr !important; row-gap: 8px; }
          .brand-actions { align-items: flex-start !important; }
        }
        .print-sheet { display: none; }
        @media print { .print-sheet { display: block; } .no-print { display: none !important; } }
      `}),e.jsx("div",{className:"wrap no-print",children:e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"brand-actions-row",style:{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:12},children:[e.jsxs("div",{children:[e.jsx(Ho,{level:4,style:{margin:0},children:oo?"NH MOTORS â€” JOB CARD":"SHANTHA MOTORS â€” JOB CARD"}),e.jsx(Us,{type:"secondary",children:"Multi Brand Two Wheeler Sales & Service"})]}),e.jsxs("div",{className:"brand-actions",style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx(Bo,{form:n,formatReg:We,buildRows:Bt,defaultGstLabour:st,lists:{BRANCHES:Wo,MECHANIC:_s,EXECUTIVES:is,VEHICLE_TYPES:Hs,SERVICE_TYPES:Bs},setServiceTypeLocal:ye,setVehicleTypeLocal:Pe,setRegDisplay:Je,webhookUrl:Ye,setFollowUpEnabled:ys,setFollowUpAt:bs,setFollowUpNotes:xs,setPostServiceLock:M,autoSearch:Ue||yt||eo,onAutoSearchStatusChange:(s,t)=>{t==="inline"&&(Jt(!!s),s||qt(null))}}),e.jsx(q,{onClick:async()=>{f(!0),await Qt()},children:Pt===null?"PendingCases":`PendingCases (${Pt})`})]})]}),e.jsx(pt,{title:Pt!==null?`PendingCases (${Pt})`:"PendingCases",open:Ne,onCancel:()=>f(!1),footer:[e.jsx(q,{onClick:()=>Qt(),children:"Refresh"},"refresh"),e.jsx(q,{type:"primary",onClick:()=>f(!1),children:"Close"},"close")],children:Ae?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:16},children:e.jsx(zs,{})}):Q.length?e.jsx(_t,{size:"small",dataSource:Q,renderItem:s=>e.jsx(_t.Item,{actions:[e.jsx(q,{size:"small",type:"primary",onClick:()=>{const t=s.mobile||s.jcNo,l=s.mobile?"mobile":"jc";t&&(hs({mode:l,query:t,token:Date.now()}),f(!1),X(i=>i.filter(u=>u.jcNo!==s.jcNo)))},children:"Post Service"})],children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:2,width:"100%"},children:[e.jsx("div",{style:{fontWeight:600},children:s.name||"-"}),e.jsxs("div",{children:["ðŸ“ž ",s.mobile||"-"," | ðŸ§¾ ",s.jcNo||"-"]}),e.jsxs("div",{children:["ðŸï¸ ",s.regNo||"-"," | ðŸ¢ ",s.branch||"-"]}),s.followUpAt?e.jsxs("div",{children:["ðŸ—“ï¸ ",s.followUpAt]}):null,s.followUpNotes?e.jsx("div",{style:{color:"#666"},children:s.followUpNotes}):null]})})}):e.jsx("div",{style:{color:"#666"},children:"No pending job cards."})}),e.jsxs(j,{form:n,layout:"vertical",initialValues:Ns,style:{marginTop:12},onValuesChange:et,children:[e.jsxs(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Vehicle & Customer",children:[e.jsxs(_e,{gutter:[12,8],children:[e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Vehicle No.",name:"regNo",validateFirst:!0,rules:[{required:!0,message:"Vehicle number is required"},{validator:(s,t)=>!t||It.test(String(t||"").toUpperCase())?Promise.resolve():Promise.reject(new Error("Format must be KA05DB6000 (AA##AA####)"))}],children:e.jsx(ie,{placeholder:"KA05DB6000",value:se,onChange:ro,maxLength:10,inputMode:"latin",style:{textTransform:"uppercase"},suffix:e.jsx(q,{type:"primary",size:"small",loading:Ie&&gs==="vehicle",disabled:Ie||!ao,onClick:()=>Ft("vehicle"),style:{height:22,paddingInline:6,fontSize:11,background:"#52c41a",borderColor:"#52c41a"},children:"Fetch"})})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Mobile",name:"custMobile",rules:[{required:!0,message:"Please enter mobile number"},{validator:(s,t)=>t?/^\d{10}$/.test(String(t))?Promise.resolve():Promise.reject(new Error("Enter 10-digit mobile number")):Promise.resolve()}],children:e.jsx(ie,{maxLength:10,inputMode:"numeric",pattern:"[0-9]*",onKeyPress:mo,onChange:po,placeholder:"10-digit number",suffix:e.jsx(q,{type:"primary",size:"small",loading:Ie&&gs==="mobile",disabled:Ie,onClick:()=>Ft("mobile"),style:{height:22,paddingInline:6,fontSize:11,background:"#52c41a",borderColor:"#52c41a"},children:"Fetch"})})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Customer Name",name:"custName",rules:[{required:!0,whitespace:!0,message:"Please enter customer name"}],getValueFromEvent:mt,children:e.jsx(ie,{placeholder:"e.g., RAHUL SHARMA",style:{textTransform:"uppercase"}})})})]}),e.jsxs(_e,{gutter:[12,8],children:[e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Company",name:"company",rules:[{required:!0,message:"Please select company"}],getValueFromEvent:mt,children:e.jsx($s,{placeholder:"Type company (e.g., H â†’ HONDA / HERO)",options:co.map(s=>({value:s})),filterOption:(s,t)=>String(t?.value||"").toLowerCase().includes(String(s||"").toLowerCase()),onChange:s=>{const t=K(s);Zt(t),n.setFieldsValue({company:t,model:void 0})},style:{textTransform:"uppercase"}})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Model",name:"model",rules:[{required:!0}],getValueFromEvent:mt,children:e.jsx($s,{placeholder:"Type model (e.g., ACT â†’ ACTIVA 125)",options:lo.map(s=>({value:s})),filterOption:(s,t)=>String(t?.value||"").toLowerCase().includes(String(s||"").toLowerCase()),onChange:s=>n.setFieldsValue({model:K(s)}),style:{textTransform:"uppercase"}})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Colour",name:"colour",getValueFromEvent:mt,children:e.jsx(ie,{style:{textTransform:"uppercase"}})})})]}),e.jsxs(_e,{gutter:[12,8],children:[e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Odometer Reading",name:"km",rules:[{required:!0,message:"Please enter Odometer Reading"}],getValueFromEvent:s=>{const t=s.target.value.replace(/\D/g,"");return t?`${t} KM`:""},getValueProps:s=>({value:s?.toString().replace(/\D/g,"")}),children:e.jsx(ie,{style:{width:"100%"},maxLength:6,inputMode:"numeric",pattern:"[0-9]*",onKeyPress:uo,placeholder:"Enter KM",suffix:"KM"})})}),e.jsx(F,{xs:24,children:e.jsx(j.Item,{label:"Customer Observation (additional notes)",name:"obs",getValueFromEvent:mt,children:e.jsx(ie.TextArea,{rows:3,placeholder:"Write the customer's observations...",style:{textTransform:"uppercase"}})})})]})]}),we&&e.jsx(Ks,{type:"warning",showIcon:!0,style:{marginTop:12},message:"Post-service already completed",description:`Service & labour editing is locked${ks?` (completed on ${ks})`:""}. Enter a different mobile number to start a new job card.`}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Service",children:e.jsxs(_e,{gutter:[12,8],children:[e.jsx(F,{xs:24,md:6,children:e.jsx(j.Item,{label:"Service Type (tick one)",name:"serviceType",rules:[{required:!0,message:"Please select a service type"}],children:e.jsx($o.Group,{options:ho,value:de?[de]:[],onChange:go,disabled:we})})}),e.jsx(F,{xs:24,md:6,children:e.jsx(j.Item,{label:"Chassis No",name:"chassisNo",rules:[{validator:(s,t)=>{const l=String(de||"").toLowerCase()==="free",i=wt(t||"");return!l||i?Promise.resolve():Promise.reject(new Error("Chassis number is required for Free service"))}}],getValueFromEvent:s=>{const t=s?.target?.value??s;return wt(t)},children:e.jsx(ie,{placeholder:"Chassis No (required for Free service)"})})}),de&&e.jsx(F,{xs:24,md:6,children:e.jsx(j.Item,{label:"Vehicle Type",name:"vehicleType",rules:[{required:!0,message:"Please choose Scooter or Motorcycle"}],children:e.jsx(jt,{className:"blue-segmented",block:!0,options:Hs,value:qe||void 0,disabled:we,onChange:s=>{Pe(s),n.setFieldsValue({vehicleType:s}),de&&n.setFieldsValue({labourRows:Bt(de,s),gstLabour:st,discounts:{labour:0}}),et()}})})}),qe==="Scooter"&&e.jsx(F,{xs:24,md:4,children:e.jsx(j.Item,{label:"Floor Mat (Mandatory)",name:"floorMat",initialValue:"No",rules:[{required:!0,message:"Please select Yes/No"}],children:e.jsx(jt,{className:"blue-segmented",block:!0,options:["No","Yes"],disabled:we,onChange:s=>{n.setFieldsValue({floorMat:s}),et()}})})}),e.jsx(F,{xs:24,md:8,children:e.jsx(j.Item,{label:"Fuel Level",name:"fuelLevel",children:e.jsx(jt,{className:"blue-segmented",block:!0,options:Jo,disabled:we})})})]})}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Labour",children:e.jsx(j.List,{name:"labourRows",children:(s,{add:t,remove:l})=>e.jsxs(e.Fragment,{children:[e.jsxs(_e,{gutter:8,style:{fontWeight:600,marginBottom:6},children:[e.jsx(F,{span:12,children:"Description"}),e.jsx(F,{span:4,children:"Qty"}),e.jsx(F,{span:4,children:"Rate"}),e.jsx(F,{span:4,style:{textAlign:"right"},children:"Amount"})]}),s.map(({key:i,name:u,...p})=>{const w=Be?.[u]||{},$=Number(w?.qty||0)*Number(w?.rate||0);return e.jsxs(_e,{gutter:8,align:"middle",style:{marginBottom:6},children:[e.jsx(F,{span:12,children:e.jsx(j.Item,{...p,name:[u,"desc"],rules:[{required:!0}],getValueFromEvent:mt,children:e.jsx(ie,{placeholder:"Labour description",disabled:we,style:{textTransform:"uppercase"}})})}),e.jsx(F,{span:4,children:e.jsx(j.Item,{...p,name:[u,"qty"],initialValue:1,rules:[{required:!0}],children:e.jsx(Ut,{min:1,style:{width:"100%"},disabled:we})})}),e.jsx(F,{span:4,children:e.jsx(j.Item,{...p,name:[u,"rate"],rules:[{required:!0}],children:e.jsx(Ut,{min:0,style:{width:"100%"},disabled:we})})}),e.jsxs(F,{span:4,style:{textAlign:"right"},children:[e.jsx(Us,{children:Fe($)}),e.jsx(q,{type:"link",danger:!0,onClick:()=>l(u),style:{paddingLeft:8},disabled:we,children:"Remove"})]})]},i)}),e.jsx(q,{onClick:()=>t({qty:1}),disabled:we,children:"Add labour"})]})})}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Totals",children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:6,maxWidth:480},children:[e.jsx("div",{children:"Labour Subtotal"}),e.jsx("div",{style:{textAlign:"right"},children:Fe(ge.labourSub)}),e.jsx(j.Item,{label:"GST % on Labour",name:"gstLabour",style:{marginBottom:0},children:e.jsx(Ut,{min:0,max:28,disabled:we})}),e.jsx("div",{style:{textAlign:"right"},children:Fe(ge.labourGST)}),e.jsx("div",{children:"Discount (Labour)"}),e.jsx(j.Item,{name:["discounts","labour"],style:{marginBottom:0},children:e.jsx(Ut,{min:0,disabled:we})}),e.jsx("div",{style:{fontWeight:700},children:"Grand Total"}),e.jsx("div",{style:{textAlign:"right",fontWeight:700},children:Fe(ge.grand)})]})}),e.jsx(tt,{size:"small",bordered:!0,style:{marginTop:12},title:"Job Details",children:e.jsxs(_e,{gutter:[12,8],children:[e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"JC No.",name:"jcNo",children:e.jsx(ie,{placeholder:"No Need to Enter",readOnly:!0})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Created At",name:"createdAt",rules:[{required:!0}],children:e.jsx(Ls,{showTime:!0,style:{width:"100%"}})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Branch",name:"branch",rules:[{required:!0}],children:fe&&G.length?e.jsx(Ht,{placeholder:"Select branch",value:it,onChange:s=>so(s),options:G.map(s=>({value:s.name,label:s.name}))}):e.jsx(ie,{readOnly:!0,placeholder:"Auto-fetched from your profile"})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Allotted Mechanic",name:"mechanic",rules:[{required:!0}],children:e.jsx(Ht,{placeholder:"Select mechanic",options:_s.map(s=>({value:s,label:s}))})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Executive",name:"executive",rules:[{required:!0}],children:fe?e.jsx(Ht,{showSearch:!0,optionFilterProp:"label",placeholder:"Select executive",options:(H.length?H:is).map(s=>({value:s.name,label:s.name}))}):e.jsx(ie,{readOnly:!0,placeholder:"Auto-fetched from your profile"})})}),e.jsx(F,{xs:24,sm:12,md:8,children:e.jsx(j.Item,{label:"Expected Delivery Date",name:"expectedDelivery",rules:[{required:!0}],children:e.jsx(Ls,{style:{width:"100%"}})})})]})}),e.jsxs(_e,{justify:"end",style:{marginTop:12},gutter:8,children:[e.jsx(F,{children:e.jsx(Lo,{title:ae?"":Mt||"Fill all required fields",placement:"top",children:e.jsx(q,{type:"default",icon:e.jsx(Lt,{style:{color:"#25D366"}}),onClick:vo,disabled:!ae||y>Date.now(),children:"WhatsApp"})})}),e.jsx(F,{children:e.jsx(q,{onClick:()=>Oe(!0),children:"Post-service"})})]})]})]})}),e.jsx(pt,{title:"WhatsApp",open:Ct,onCancel:()=>ft(!1),footer:null,destroyOnClose:!1,children:e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs("div",{style:ns(1),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["1. Customer WhatsApp ",pe.customer?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Required"})]}),e.jsx(q,{type:"primary",icon:e.jsx(Lt,{style:{color:"#25D366"}}),onClick:So,disabled:!ae||y>Date.now(),children:"Send"})]}),e.jsxs("div",{style:ns(2),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["2. Mechanic WhatsApp ",pe.mechanic?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Required"}),Wt&&!pe.mechanic?e.jsx("div",{style:{fontSize:12,color:"#b45309",marginTop:4},children:"Tap to open Mechanic WhatsApp."}):null,pe.customer?null:e.jsx("div",{style:{fontSize:12,color:"#6b7280",marginTop:4},children:"Complete Customer WhatsApp first."})]}),e.jsx(q,{type:"primary",icon:e.jsx(Lt,{style:{color:"#25D366"}}),onClick:No,disabled:!ae||!pe.customer,children:"Send"})]}),e.jsxs("div",{style:ns(3),children:[e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:600},children:["3. Pre-service ",pe.pre?"âœ…":""]}),e.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Optional"})]}),e.jsx(q,{type:"default",onClick:jo,disabled:!ae||Ke,loading:Ke,children:"Print"})]})]})}),e.jsxs(pt,{title:"Post-service",open:Ve,onCancel:()=>Oe(!1),footer:null,children:[e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsxs(tt,{size:"small",bordered:!0,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Amount (â‚¹)"}),e.jsx(ie,{inputMode:"numeric",placeholder:"0",value:Le,onChange:s=>rt(s.target.value.replace(/[^0-9.]/g,""))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Mode"}),e.jsx(jt,{value:Qe,onChange:Dt,options:[{label:"Cash",value:"cash"},{label:"Online",value:"online"}]})]})]}),Qe==="online"&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("div",{style:{marginBottom:6,fontSize:12,color:"#374151"},children:"UTR No. (Slot 1)"}),e.jsx(ie,{placeholder:"Enter UTR number",value:Xe,onChange:s=>at(String(s.target.value||"").toUpperCase()),maxLength:32,style:{textTransform:"uppercase"}})]})]}),e.jsxs(tt,{size:"small",bordered:!0,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8},children:[e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Amount (â‚¹)"}),e.jsx(ie,{inputMode:"numeric",placeholder:"0",value:a,onChange:s=>d(s.target.value.replace(/[^0-9.]/g,""))})]}),e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:6},children:"Mode"}),e.jsx(jt,{value:$e,onChange:o,options:[{label:"Cash",value:"cash"},{label:"Online",value:"online"}]})]})]}),$e==="online"&&e.jsxs("div",{style:{marginTop:10},children:[e.jsx("div",{style:{marginBottom:6,fontSize:12,color:"#374151"},children:"UTR No. (Slot 2)"}),e.jsx(ie,{placeholder:"Enter UTR number",value:h,onChange:s=>S(String(s.target.value||"").toUpperCase()),maxLength:32,style:{textTransform:"uppercase"}})]})]})]}),e.jsxs("div",{style:{marginTop:8,fontSize:13,color:lt===0?"#166534":"#b91c1c"},children:[e.jsx("strong",{children:"Payable:"})," ",Fe(es)," Â | Â ",e.jsx("strong",{children:"Collected:"})," ",Fe(Xt)," Â | Â ",e.jsxs("strong",{children:[lt>=0?"Due":"Excess",":"]})," ",Fe(Math.abs(lt))]}),e.jsxs("div",{style:{marginTop:12},children:[e.jsx("div",{style:{marginBottom:6},children:"Remarks (optional)"}),e.jsx(ie.TextArea,{placeholder:"Enter any delivery remarks for this service",value:oe,onChange:s=>z(K(s.target.value||"")),style:{textTransform:"uppercase"},autoSize:{minRows:2,maxRows:3}})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:16,justifyContent:"flex-end"},children:[e.jsx(q,{onClick:()=>Oe(!1),disabled:Te,children:"Cancel"}),e.jsx(q,{onClick:()=>os(!1),disabled:Te||y>Date.now()||lt!==0,loading:Te,children:"Save"}),e.jsx(q,{icon:e.jsx(Lt,{style:{color:"#25D366"}}),onClick:()=>os("whatsapp"),disabled:Te||y>Date.now()||lt!==0,loading:Te,children:"WhatsApp"}),e.jsx(q,{type:"primary",onClick:()=>os(!0),disabled:Te||y>Date.now()||lt!==0,loading:Te,children:"Print"})]})]}),e.jsx(Uo,{ref:E,active:!0,vals:Et,labourRows:Be,totals:ge,observationLines:yo,executives:is}),e.jsx(Yo,{ref:Se,active:!0,vals:Et,totals:ge})]})}export{Vn as default};
