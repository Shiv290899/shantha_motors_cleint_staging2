import{r as o,R as oe,j as e,u as Vs}from"./index-D3jyxz5S.js";import{l as Qt,d as ca,e as da,f as ua,h as ma,b as cs,i as ha,j as pa,k as fa,s as ot,u as xt,t as St,n as ee,D as fs,a as Dt,A as ya}from"./caseInsensitive-Bczb6n5Q.js";import{G as Ut}from"./index-DjHBBus9.js";import{F as K}from"./index-CcgLN9cm.js";import{s as w,I as X}from"./index-CY4Kamfr.js";import{S as ue}from"./index-BBYJ-6BB.js";import{S as pe,a as ga}from"./index-CtRvdixs.js";import{B as q}from"./button-CtJmIkB1.js";import{R as qs}from"./PlusOutlined-aHmBnbM2.js";import{T as he}from"./index-Bv816-4y.js";import{F as Bt}from"./Table-C4tN8BUo.js";import{M as rt}from"./index-C426kwCm.js";import{z as Pt,A as ae,T as Ct}from"./TextArea-Q3gpJu61.js";import{d as Pe}from"./index-BaYR0Azk.js";import{e as Gt,P as ba}from"./StockUpdate-BWTUZvx_.js";import{C as xa}from"./index-CZRYr7Ag.js";import{B as Gs,b as va,l as Sa,a as ka,c as wa,U as ls,d as Ls,e as Ks,f as ja}from"./BookingForm-fdAZNRnL.js";import{C as ys}from"./index-Do8dGFqA.js";import{D as Es}from"./index-CU-RyMmz.js";import{E as Ca,T as Zt}from"./index-BE1rlUlE.js";import{A as Ms}from"./index-DPxH9qVd.js";import{P as Ra,h as Aa}from"./PostServiceSheet-a3wpyx66.js";import{I as Ta}from"./AntdIcon-DD3d8MPl.js";import{T as Ia}from"./index-C0lBYX3a.js";function ds(){return ds=Object.assign?Object.assign.bind():function(n){for(var S=1;S<arguments.length;S++){var d=arguments[S];for(var h in d)Object.prototype.hasOwnProperty.call(d,h)&&(n[h]=d[h])}return n},ds.apply(this,arguments)}const Na=(n,S)=>o.createElement(Ta,ds({},n,{ref:S,icon:Ca})),La=o.forwardRef(Na),Os=[{label:"Sales & Services",value:"sales & services"},{label:"Sales",value:"sales"},{label:"Service",value:"service"}],Ps=[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"},{label:"Under Maintenance",value:"under_maintenance"}];function wn({readOnly:n=!1}){const d=!Ut.useBreakpoint().md,[h,O]=oe.useState(!1),[P,I]=oe.useState(!1),[$,A]=oe.useState([]),[W,x]=oe.useState(0),[_,le]=oe.useState(!1),[L,Q]=oe.useState(null),[D]=K.useForm(),[fe,ye]=oe.useState(""),[Le,se]=oe.useState("all"),[E,te]=oe.useState("all"),[ve,me]=oe.useState("all"),[Z,Re]=oe.useState(1),[ie,Se]=oe.useState(25),je=oe.useCallback(async()=>{O(!0);try{if(n){const l=await Qt({limit:200});l?.success?(A(l.data.items||[]),x(l.data.total||0)):w.error(l?.message||"Failed to load branches")}else{const l=await ca({limit:200});if(l?._status===401||l?._status===403){const v=await Qt({limit:200});v?.success?(w.info("Showing public branch list (read-only). Sign in for management."),A(v.data.items||[]),x(v.data.total||0)):(w.warning("Please login again to manage branches."),A([]),x(0))}else l?.success?(A(l.data.items||[]),x(l.data.total||0)):w.error(l?.message||"Failed to load branches")}}catch(l){w.error(l?.message||"Failed to load branches")}finally{O(!1)}},[n]);oe.useEffect(()=>{je()},[je]);const Be=oe.useMemo(()=>{const l=new Set(($||[]).map(v=>v.address?.city?String(v.address.city).trim():"").filter(Boolean));return["all",...Array.from(l).sort((v,c)=>v.localeCompare(c))]},[$]),ne=oe.useMemo(()=>{const l=String(fe||"").toLowerCase();return($||[]).filter(v=>Le!=="all"&&String(v.address?.city||"")!==Le||E!=="all"&&String(v.type||"")!==E||ve!=="all"&&String(v.status||"")!==ve?!1:l?[v.code,v.name,v.phone,v.email,v.address?.line1,v.address?.line2,v.address?.area,v.address?.city,v.address?.state].map(U=>String(U||"").toLowerCase()).some(U=>U.includes(l)):!0)},[$,fe,Le,E,ve]);oe.useEffect(()=>{Re(1)},[fe,Le,E,ve]);const ze=oe.useMemo(()=>{const l=v=>{const c=new Map;return ne.forEach(U=>{const i=String(U[v]||"");c.set(i,(c.get(i)||0)+1)}),Array.from(c.entries()).sort((U,i)=>i[1]-U[1])};return{byType:l("type"),byStatus:l("status")}},[ne]),de=()=>{const l=["Code","Name","Type","Status","Phone","Email","Line1","Line2","Area","City","State","Pincode","Latitude","Longitude"],v=ne.map(B=>[B.code||"",B.name||"",B.type||"",B.status||"",B.phone||"",B.email||"",B.address?.line1||"",B.address?.line2||"",B.address?.area||"",B.address?.city||"",B.address?.state||"",B.address?.pincode||"",B.location?.coordinates?.[1]??"",B.location?.coordinates?.[0]??""]),c=[l,...v].map(B=>B.map(Ce=>String(Ce).includes(",")?`"${String(Ce).replace(/"/g,'""')}"`:String(Ce)).join(",")).join(`
`),U=new Blob([c],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(U),M=document.createElement("a");M.href=i,M.download="branches.csv",M.click(),setTimeout(()=>URL.revokeObjectURL(i),500)},Ie=()=>{Q(null),le(!0),setTimeout(()=>{D.resetFields(),D.setFieldsValue({type:"sales & services",status:"active"})},0)},De=l=>{Q(l),D.setFieldsValue({id:l.id,code:l.code,name:l.name,type:l.type,phone:l.phone,email:l.email,address_line1:l.address?.line1,address_line2:l.address?.line2,area:l.address?.area,city:l.address?.city,state:l.address?.state,pincode:l.address?.pincode,lat:l.location?.coordinates?.[1],lng:l.location?.coordinates?.[0],status:l.status,manager:l.manager||void 0,staffIds:Array.isArray(l.staff)?l.staff.map(String).join(","):void 0,boysIds:Array.isArray(l.boys)?l.boys.map(String).join(","):void 0,mechanicsIds:Array.isArray(l.mechanics)?l.mechanics.map(String).join(","):void 0}),le(!0)},Ee=async l=>{rt.confirm({title:`Delete ${l.name}?`,content:"This cannot be undone.",okButtonProps:{danger:!0},okText:"Delete",onOk:async()=>{try{const v=await ma(l.id);v?.success?(w.success("Branch deleted"),je()):w.error(v?.message||"Delete failed")}catch{w.error("Delete failed")}}})},Ae=async()=>{try{const l=await D.validateFields(),v={code:l.code,name:l.name,type:l.type,phone:l.phone,email:l.email,address:{line1:l.address_line1,line2:l.address_line2,area:l.area,city:l.city,state:l.state,pincode:l.pincode},lat:l.lat,lng:l.lng,status:l.status,...l.manager?{manager:String(l.manager).trim()}:{},...l.staffIds?{staff:String(l.staffIds).split(",").map(U=>U.trim()).filter(Boolean)}:{},...l.boysIds?{boys:String(l.boysIds).split(",").map(U=>U.trim()).filter(Boolean)}:{},...l.mechanicsIds?{mechanics:String(l.mechanicsIds).split(",").map(U=>U.trim()).filter(Boolean)}:{}};I(!0);let c;if(L?.id?c=await da(L.id,v):c=await ua(v),c?._status===401||c?._status===403){w.warning("Please login again to continue.");return}c?.success?(w.success(L?"Branch updated":"Branch created"),le(!1),Q(null),D.resetFields(),je()):w.error(c?.message||"Save failed")}catch(l){const v=l?.response?.data?.message||l?.message||"Save failed";w.error(v)}finally{I(!1)}},$e=l=>{const v=[l.address?.line1,l.address?.line2,l.address?.area,l.address?.city,l.address?.state,l.address?.pincode].filter(Boolean).join(", ");return v?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v)}`:null},H=[{title:"Code",dataIndex:"code",key:"code",width:80,sorter:(l,v)=>l.code.localeCompare(v.code)},{title:"Name",dataIndex:"name",key:"name",width:180,ellipsis:!0,sorter:(l,v)=>l.name.localeCompare(v.name),render:(l,v)=>e.jsxs("span",{children:[l," ",e.jsx(Ct,{title:"Open in Google Maps",children:$e(v)&&e.jsx("a",{href:$e(v),target:"_blank",rel:"noopener",style:{fontSize:12,marginLeft:4},children:"Map"})})]})},{title:"Type",dataIndex:"type",key:"type",width:110,render:l=>{const v=l==="sales"?"geekblue":l==="service"?"cyan":"blue";return e.jsx(he,{color:v,children:l})}},{title:"City",key:"city",width:110,ellipsis:!0,render:(l,v)=>v.address?.city||"â€”"},{title:"Phone",dataIndex:"phone",key:"phone",width:110,ellipsis:!0},{title:"Staff",key:"staffCount",width:60,render:(l,v)=>v.activeStaffCount??(Array.isArray(v.staff)?v.staff.length:0)},{title:"Boys",key:"boysCount",width:60,render:(l,v)=>v.activeBoysCount??(Array.isArray(v.boys)?v.boys.length:0)},{title:"Mechanics",key:"mechCount",width:80,render:(l,v)=>v.activeMechanicsCount??(Array.isArray(v.mechanics)?v.mechanics.length:0)},{title:"Status",dataIndex:"status",key:"status",width:110,render:l=>l==="active"?e.jsx(he,{color:"green",children:"Active"}):l==="inactive"?e.jsx(he,{children:"Inactive"}):e.jsx(he,{color:"orange",children:"Under Maintenance"})},...n?[]:[{title:"Actions",key:"actions",width:140,render:(l,v)=>e.jsxs(ue,{size:4,wrap:!0,children:[e.jsx(q,{size:"small",onClick:()=>De(v),children:"Edit"}),e.jsx(q,{size:"small",danger:!0,onClick:()=>Ee(v),children:"Delete"})]})}]];return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[e.jsxs(ue,{size:[8,8],wrap:!0,children:[e.jsx(X.Search,{placeholder:"Search code/name/city/phone",allowClear:!0,value:fe,onChange:l=>ye(l.target.value),style:{minWidth:220}}),e.jsx(pe,{value:Le,onChange:se,style:{minWidth:160},options:Be.map(l=>({value:l,label:l==="all"?"All Cities":l}))}),e.jsx(pe,{value:E,onChange:te,style:{minWidth:160},options:[{value:"all",label:"All Types"},...Os]}),e.jsx(pe,{value:ve,onChange:me,style:{minWidth:180},options:[{value:"all",label:"All Status"},...Ps]}),e.jsx(q,{onClick:je,children:"Refresh"}),e.jsx(q,{onClick:de,children:"Export CSV"})]}),e.jsx("div",{style:{flex:1}}),!n&&e.jsx(q,{type:"primary",icon:e.jsx(qs,{}),onClick:Ie,children:"New Branch"})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:8},children:[ze.byStatus.map(([l,v])=>e.jsxs(he,{color:l==="active"?"green":l==="inactive"?"default":"orange",children:[l||"unknown",": ",v]},`st-${l||"unknown"}`)),ze.byType.map(([l,v])=>e.jsxs(he,{color:l==="sales"?"geekblue":l==="service"?"cyan":"blue",children:[l||"unknown",": ",v]},`tp-${l||"unknown"}`)),e.jsxs(he,{color:"blue",children:["Total: ",ne.length," / ",W]})]}),e.jsx(Bt,{rowKey:l=>l.id,dataSource:ne,columns:H,loading:h,tableLayout:d?"auto":"fixed",pagination:{current:Z,pageSize:ie,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(l,v)=>{Re(l),v!==ie&&Se(v)},showTotal:(l,v)=>`${v[0]}-${v[1]} of ${l}`},size:d?"small":"middle",scroll:d?{x:"max-content"}:void 0}),e.jsx(rt,{title:L?`Edit Branch â€“ ${L.name}`:"New Branch",open:_,onCancel:()=>{le(!1),Q(null)},onOk:Ae,okText:L?"Save":"Create",confirmLoading:P,forceRender:!0,destroyOnClose:!0,children:e.jsx(K,{form:D,layout:"vertical",children:e.jsxs(Pt,{gutter:[12,8],children:[e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"code",label:"Code",rules:[{required:!0,message:"Code is required"}],children:e.jsx(X,{placeholder:"e.g., BDRH",maxLength:10})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(X,{placeholder:"e.g., Byadarahalli Branch"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"type",label:"Type",initialValue:"sales & services",rules:[{required:!0}],children:e.jsx(pe,{options:Os})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"status",label:"Status",initialValue:"active",rules:[{required:!0}],children:e.jsx(pe,{options:Ps})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"phone",label:"Phone",children:e.jsx(X,{placeholder:"Branch phone"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"email",label:"Email",children:e.jsx(X,{placeholder:"Branch email",type:"email"})})}),e.jsx(ae,{span:24,children:e.jsx(K.Item,{name:"address_line1",label:"Address Line 1",children:e.jsx(X,{})})}),e.jsx(ae,{span:24,children:e.jsx(K.Item,{name:"address_line2",label:"Address Line 2",children:e.jsx(X,{})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"area",label:"Area",children:e.jsx(X,{})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"city",label:"City",rules:[{required:!0,message:"City is required"}],children:e.jsx(X,{})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"state",label:"State",children:e.jsx(X,{})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"pincode",label:"Pincode",children:e.jsx(X,{})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"lat",label:"Latitude",children:e.jsx(X,{type:"number",step:"any"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"lng",label:"Longitude",children:e.jsx(X,{type:"number",step:"any"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"manager",label:"Manager (User ID)",children:e.jsx(X,{placeholder:"24-char user id (optional)"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"staffIds",label:"Staff (comma-separated User IDs)",children:e.jsx(X,{placeholder:"id1,id2,id3"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"boysIds",label:"Boys (comma-separated User IDs)",children:e.jsx(X,{placeholder:"id1,id2"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"mechanicsIds",label:"Mechanics (comma-separated User IDs)",children:e.jsx(X,{placeholder:"id1,id2"})})})]})})})]})}const Us=[{label:"Admin",value:"admin"},{label:"Owner",value:"owner"},{label:"Staff",value:"staff"},{label:"Mechanic",value:"mechanic"},{label:"Employees",value:"employees"},{label:"User",value:"user"},{label:"Backend",value:"backend"}],Bs=[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"},{label:"Suspended",value:"suspended"}];function jn({readOnly:n=!1}){const d=!Ut.useBreakpoint().md,[h,O]=oe.useState(!1),[P,I]=oe.useState(!1),[$,A]=oe.useState([]),[W,x]=oe.useState(0),[_,le]=oe.useState(!1),[L,Q]=oe.useState(null),[D,fe]=oe.useState([]),[ye]=K.useForm(),Le=oe.useCallback(c=>c?.id||c?._id||c?.userId||null,[]),[se,E]=oe.useState(""),[te,ve]=oe.useState(""),[me,Z]=oe.useState(),[Re,ie]=oe.useState(),[Se,je]=oe.useState(),[Be,ne]=oe.useState(1),[ze,de]=oe.useState(25),Ie=oe.useCallback(async()=>{const c=await Qt({limit:500,status:"active"});c?.success&&fe(c.data.items||[])},[]),De=oe.useCallback(async()=>{O(!0);try{if(n){const c=await cs({limit:1e5,page:1,...te?{q:te}:{},...me?{role:me}:{},...Re?{status:Re}:{},...Se?{branch:Se}:{}});c?.success?(A(c.data.items||[]),x(c.data.total||c.data.items?.length||0)):(w.error(c?.message||"Failed to load users"),A([]),x(0))}else{const c=await ha({limit:1e5,page:1,...te?{q:te}:{},...me?{role:me}:{},...Re?{status:Re}:{},...Se?{branch:Se}:{}});if(c?.success)A(c.data.items||[]),x(c.data.total||c.data.items?.length||0);else if(c?._status===401||c?._status===403){const U=await cs({limit:1e5,page:1,...te?{q:te}:{},...me?{role:me}:{},...Re?{status:Re}:{},...Se?{branch:Se}:{}});U?.success?(w.info("Showing public user list (read-only). Sign in for management."),A(U.data.items||[]),x(U.data.total||U.data.items?.length||0)):(w.error(c?.message||"Failed to load users"),A([]),x(0))}else w.error(c?.message||"Failed to load users")}}catch(c){w.error(c?.message||"Failed to load users")}finally{O(!1)}},[te,me,Re,Se,n]);oe.useEffect(()=>{Ie()},[Ie]),oe.useEffect(()=>{De()},[De]),oe.useEffect(()=>{ne(1)},[te,me,Re,Se]);const Ee=c=>{const U=Le(c);if(!U){w.error("User ID missing. Please refresh and try again.");return}Q({...c,id:U}),ye.setFieldsValue({id:U,name:c.name,email:c.email,phone:c.phone,role:c.role,status:c.status,jobTitle:c.jobTitle,employeeCode:c.employeeCode,primaryBranch:c.primaryBranch?._id||c.primaryBranch?.id||c.primaryBranch||void 0,branches:Array.isArray(c.branches)?c.branches.map(i=>typeof i=="string"?i:i?._id||i?.id).filter(Boolean):void 0,canSwitchBranch:!!c.canSwitchBranch}),le(!0)},Ae=async c=>{const U=Le(c);if(!U){w.error("User ID missing. Please refresh and try again.");return}rt.confirm({title:`Delete ${c.name}?`,content:"This cannot be undone.",okButtonProps:{danger:!0},okText:"Delete",onOk:async()=>{try{const i=await fa(U);i?.success?(w.success("User deleted"),De()):w.error(i?.message||"Delete failed")}catch{w.error("Delete failed")}}})},$e=async()=>{try{const c=await ye.validateFields(),U={name:c.name,email:c.email,...c.phone?{phone:c.phone}:{},role:c.role,status:c.status,...c.jobTitle?{jobTitle:c.jobTitle}:{},...c.employeeCode?{employeeCode:c.employeeCode}:{},...c.primaryBranch?{primaryBranch:c.primaryBranch}:{},...Array.isArray(c.branches)?{branches:c.branches}:{},canSwitchBranch:!!c.canSwitchBranch};I(!0);const i=Le(L);if(!i){w.error("Cannot create users here. Use registration.");return}const M=await pa(i,U);if(M?._status===401||M?._status===403){w.warning("Please login again to continue.");return}M?.success?(w.success("User updated"),le(!1),Q(null),ye.resetFields(),De()):w.error(M?.message||"Save failed")}catch(c){const U=c?.response?.data?.message||c?.message||"Save failed";w.error(U)}finally{I(!1)}},H=D.map(c=>({label:c.name,value:c.id||c._id})),l=[{title:"Name",dataIndex:"name",key:"name",width:160,ellipsis:!0,sorter:(c,U)=>c.name.localeCompare(U.name)},{title:"Email",dataIndex:"email",key:"email",width:180,ellipsis:!0},{title:"Phone",dataIndex:"phone",key:"phone",width:110,ellipsis:!0},{title:"Role",dataIndex:"role",key:"role",width:100,render:c=>e.jsx(he,{color:c==="admin"?"red":c==="owner"?"gold":c==="backend"?"purple":c==="mechanic"?"cyan":c==="staff"?"blue":"default",children:c})},{title:"Primary Branch",key:"primaryBranch",width:140,ellipsis:!0,render:(c,U)=>U.primaryBranch?.name||"â€”"},{title:"Status",dataIndex:"status",key:"status",width:90,render:c=>c==="active"?e.jsx(he,{color:"green",children:"Active"}):c==="inactive"?e.jsx(he,{children:"Inactive"}):e.jsx(he,{color:"orange",children:"Suspended"})},{title:"Last Login",dataIndex:"lastLoginAt",key:"lastLoginAt",width:140,render:c=>c?Pe(c).format("DD-MM-YYYY HH:mm"):"â€”"},...n?[]:[{title:"Actions",key:"actions",width:160,render:(c,U)=>e.jsxs(ue,{size:4,wrap:!0,children:[e.jsx(q,{size:"small",onClick:i=>{i.stopPropagation(),Ee(U)},children:"Edit"}),e.jsx(q,{size:"small",danger:!0,onClick:i=>{i.stopPropagation(),Ae(U)},children:"Delete"})]})}]],v=()=>{if(!$.length){w.info("No users to export for current filters");return}const c=[{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"phone",label:"Phone"},{key:"role",label:"Role"},{key:"status",label:"Status"},{key:"jobTitle",label:"Job Title"},{key:"employeeCode",label:"Employee Code"},{key:"primaryBranch",label:"Primary Branch"},{key:"branches",label:"Additional Branches"},{key:"lastLoginAt",label:"Last Login"}],U=$.map(i=>{const M=Array.isArray(i.branches)?i.branches.map(B=>typeof B=="string"?B:B?.name||B?.branchName||"").filter(Boolean).join("; "):"";return{name:i.name,email:i.email,phone:i.phone,role:i.role,status:i.status,jobTitle:i.jobTitle,employeeCode:i.employeeCode,primaryBranch:(typeof i.primaryBranch=="string"?i.primaryBranch:i.primaryBranch?.name)||"",branches:M,lastLoginAt:i.lastLoginAt}});Gt({filename:"users.csv",headers:c,rows:U}),w.success(`Exported ${U.length} users`)};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:12,gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Total:"})," ",W]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(X.Search,{placeholder:"Search name/email/phone",allowClear:!0,value:se,onChange:c=>E(c.target.value),onSearch:c=>ve((c||"").trim()),style:{width:240}}),e.jsx(pe,{placeholder:"Role",allowClear:!0,value:me,onChange:c=>Z(c),options:Us,style:{width:140}}),e.jsx(pe,{placeholder:"Status",allowClear:!0,value:Re,onChange:c=>ie(c),options:Bs,style:{width:140}}),e.jsx(pe,{placeholder:"Branch",allowClear:!0,showSearch:!0,optionFilterProp:"label",value:Se,onChange:c=>je(c),options:D.map(c=>({label:c.name,value:c.id})),style:{width:220}}),e.jsx(q,{onClick:v,children:"Export CSV"}),e.jsx(q,{onClick:De,children:"Refresh"}),e.jsx(q,{onClick:()=>{E(""),ve(""),Z(void 0),ie(void 0),je(void 0)},children:"Reset"})]})]}),e.jsx(Bt,{rowKey:c=>Le(c)||`${c.email||""}-${c.phone||""}-${c.name||""}`,dataSource:$,columns:l,loading:h,tableLayout:d?"auto":"fixed",pagination:{current:Be,pageSize:ze,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(c,U)=>{ne(c),U!==ze&&de(U)},showTotal:(c,U)=>`${U[0]}-${U[1]} of ${c}`},size:d?"small":"middle",scroll:d?{x:"max-content"}:void 0}),e.jsx(rt,{title:L?`Edit User â€“ ${L.name}`:"New User",open:_,onCancel:()=>{le(!1),Q(null)},onOk:$e,okText:L?"Save":"Create",confirmLoading:P,forceRender:!0,destroyOnClose:!0,children:e.jsx(K,{form:ye,layout:"vertical",children:e.jsxs(Pt,{gutter:[12,8],children:[e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(X,{placeholder:"Full name"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"email",label:"Email",rules:[{required:!0,message:"Email is required"},{type:"email",message:"Enter a valid email"}],children:e.jsx(X,{placeholder:"name@example.com"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"phone",label:"Phone",children:e.jsx(X,{placeholder:"Mobile number"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"role",label:"Role",initialValue:"user",rules:[{required:!0}],children:e.jsx(pe,{options:Us})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"status",label:"Status",initialValue:"active",rules:[{required:!0}],children:e.jsx(pe,{options:Bs})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"jobTitle",label:"Job Title",children:e.jsx(X,{placeholder:"e.g., Sales Executive"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"employeeCode",label:"Employee Code",children:e.jsx(X,{placeholder:"Unique within primary branch"})})}),e.jsx(ae,{xs:24,sm:12,children:e.jsx(K.Item,{name:"primaryBranch",label:"Primary Branch",children:e.jsx(pe,{allowClear:!0,options:H,placeholder:"Select primary branch"})})}),e.jsx(ae,{span:24,children:e.jsx(K.Item,{name:"branches",label:"Additional Branches",children:e.jsx(pe,{mode:"multiple",allowClear:!0,options:H,placeholder:"Select additional branches"})})}),e.jsx(ae,{span:24,children:e.jsx(K.Item,{name:"canSwitchBranch",valuePropName:"checked",children:e.jsx(xa,{children:"Can switch branches"})})})]})})})]})}function gs(n,S=250){const[d,h]=o.useState(n);return o.useEffect(()=>{const O=setTimeout(()=>h(n),S);return()=>clearTimeout(O)},[n,S]),d}function Ea({open:n,onClose:S,row:d,webhookUrl:h}){const[O,P]=o.useState(!1),[I,$]=o.useState(null),A=(W={})=>{const{patch:x}=va(W);return x||{}};return o.useEffect(()=>{let W=!0;return(async()=>{if(!(!n||!d)){P(!0);try{if(h&&d.bookingId){const _=await ot({webhookUrl:h,method:"GET",payload:{action:"search",mode:"booking",query:d.bookingId}}),le=_?.data||_,L=Array.isArray(le?.rows)&&le.rows.length?le.rows[0]?.payload:null;W&&$(A(L||{customerName:d.name,mobileNumber:d.mobile,branch:d.branch,vehicle:{company:d.company,model:d.model,variant:d.variant,chassisNo:d.chassis}}))}else W&&$(A({customerName:d?.name,mobileNumber:d?.mobile,branch:d?.branch,vehicle:{company:d?.company,model:d?.model,variant:d?.variant,chassisNo:d?.chassis}}))}catch{W&&(w.warning("Could not fetch full booking. Opening with available fields."),$(A({customerName:d?.name,mobileNumber:d?.mobile,branch:d?.branch,vehicle:{company:d?.company,model:d?.model,variant:d?.variant,chassisNo:d?.chassis}})))}finally{W&&P(!1)}}})(),()=>{W=!1}},[n,d,h]),e.jsx(rt,{open:n,title:"Prefilled Booking Form",onCancel:S,footer:null,width:980,destroyOnClose:!0,children:O?e.jsx("div",{style:{display:"grid",placeItems:"center",height:160},children:e.jsx(ga,{})}):e.jsx("div",{style:{paddingTop:8},children:e.jsx(Gs,{asModal:!0,initialValues:I||{},startPaymentsOnly:!!d?.bookingId,editRefDefault:d?.bookingId?{bookingId:d.bookingId,mobile:d.mobile}:null})})})}const{Text:Ot}=Zt,Ye={ts:["Submitted At","Timestamp","Time","Date"],branch:["Branch"],name:["Customer Name","Customer_Name","Customer","Name"],mobile:["Mobile Number","Mobile","Phone"],bookingId:["Booking ID","Booking_ID","Booking Id","BookingID"],company:["Company"],model:["Model"],variant:["Variant"],color:["Color","Colour","Vehicle Color","Vehicle Colour"],chassis:["Chassis Number","Chassis No","Chassis"],file:["File URL","File","Document URL"],status:["Status","Booking Status","State"],availability:["Chassis Availability","Availability","Stock","Stock Status"]},Je=(n,S)=>String(S.map(d=>n[d]??"").find(d=>d!=="")||"").trim();function Cn(){const S=!Ut.useBreakpoint().md,[d,h]=o.useState([]),[O,P]=o.useState(!1),[I,$]=o.useState("all"),[A,W]=o.useState("all"),[x,_]=o.useState(()=>[Pe().startOf("month"),Pe()]),[le,L]=o.useState(null),[,Q]=o.useState(null),[D,fe]=o.useState({open:!1,row:null}),[ye,Le]=o.useState({open:!1,row:null}),[se,E]=o.useState(""),te=gs(se,300),[ve,me]=o.useState(1),[Z,Re]=o.useState(25),[ie,Se]=o.useState("pagination"),[je,Be]=o.useState(25),[ne,ze]=o.useState(0),de="true".toLowerCase()==="true",[Ie,De]=o.useState({}),[Ee,Ae]=o.useState({open:!1,refId:"",level:"ok",text:""}),[$e,H]=o.useState(!1),[l,v]=o.useState({open:!1,type:"",row:null,fileList:[],loading:!1}),[c,U]=o.useState({open:!1}),[i,M]=o.useState([]),[B,Ce]=o.useState([]),[_e,Ue]=o.useState(!1),[ke,lt]=o.useState([]),[Rt,Nt]=o.useState([]),[Lt,pt]=o.useState(!1),[Ke,Fe]=o.useState([]),[ft,At]=o.useState(!1),[Tt,kt]=o.useState(0),[it,ct]=o.useState(""),[dt,Xe]=o.useState(null),[qe,vt]=o.useState(""),[et,We]=o.useState(!1),[Ve,ut]=o.useState({open:!1,row:null}),[It,u]=o.useState(""),[p,R]=o.useState(!1),[T,j]=o.useState(!1),[s]=K.useForm(),[r,f]=o.useState(null),[y,b]=o.useState(""),[C,G]=o.useState([]);o.useEffect(()=>{try{const t=localStorage.getItem("user");if(!t)return;const a=JSON.parse(t);f(a),b(String(a?.role||"").toLowerCase());const m=[],g=a?.formDefaults?.branchName||a?.primaryBranch?.name||"";g&&m.push(g),Array.isArray(a?.branches)&&a.branches.forEach(N=>{const F=typeof N=="string"?N:N?.name||"";F&&m.push(F)}),G(Array.from(new Set(m.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(y)&&C.length&&I==="all"&&$(C[0])},[y,C,I]);const z=o.useCallback(async()=>{Ue(!0);try{const[t,a]=await Promise.allSettled([Qt({status:"active",limit:500}),cs({role:"staff",status:"active",limit:1e5})]);if(t.status==="fulfilled"&&t.value?.success){const m=xt((t.value.data.items||[]).filter(g=>String(g?.status||"").toLowerCase()==="active").map(g=>g.name));M(m)}else M([]),t.status==="fulfilled"&&w.warning(t.value?.message||"Could not load branches");if(a.status==="fulfilled"&&a.value?.success){const m=xt((a.value.data.items||[]).filter(g=>String(g.role||"").toLowerCase()==="staff").map(g=>g.name||g.email||""));Ce(m)}else Ce([]),a.status==="fulfilled"&&w.warning(a.value?.message||"Could not load executives")}catch{M([]),Ce([]),w.error("Could not load dropdown options")}finally{Ue(!1)}},[]);o.useEffect(()=>{z()},[z]);const Y="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",re="",Te=(()=>{const t=x&&x[0]?x[0].startOf("day").valueOf():"",a=x&&x[1]?x[1].endOf("day").valueOf():"";return`Bookings:list:${JSON.stringify({branchFilter:I,statusFilter:A,q:te||"",start:t,end:a,page:ve,pageSize:Z,USE_SERVER_PAG:de})}`})(),we=o.useCallback((t,a=0)=>{let m={};try{m=typeof t["Raw Payload"]=="object"?t["Raw Payload"]||{}:JSON.parse(String(t["Raw Payload"]||t.rawPayload||t.payload||"{}"))}catch{m={}}const g=m?.color||m?.vehicle?.color||m?.vehicleColor||m?.formValues?.color||"",N=(m?.remark?.level||t.RemarkLevel||t.remarkLevel||"").toString(),F=m?.remark?.text||t.RemarkText||t.remarkText||"",V=String(N||"").toLowerCase();return{key:a,ts:Je(t,Ye.ts),tsMs:is(Je(t,Ye.ts)),bookingId:Je(t,Ye.bookingId),name:Je(t,Ye.name),mobile:Je(t,Ye.mobile),company:Je(t,Ye.company),model:Je(t,Ye.model),variant:Je(t,Ye.variant),color:Je(t,Ye.color)||String(g||"").trim(),chassis:Je(t,Ye.chassis),fileUrl:Je(t,Ye.file),branch:Je(t,Ye.branch),status:(Je(t,Ye.status)||"pending").toLowerCase(),availability:Je(t,Ye.availability),RemarkLevel:N||"",RemarkText:F||"",_remarkLevel:V,_remarkText:F||"",_raw:t}},[]);o.useEffect(()=>{try{const t=localStorage.getItem(Te);if(!t)return;const a=JSON.parse(t);a&&Array.isArray(a.rows)&&(h(a.rows),ze(typeof a.total=="number"?a.total:a.rows.length),H(!0))}catch{}},[Te]),o.useEffect(()=>{let t=!1;return(async()=>{try{const g=await ot({webhookUrl:Y,method:"GET",payload:re?{action:"list",page:1,pageSize:5e3,secret:re}:{action:"list",page:1,pageSize:5e3}}),N=g?.data||g,V=(Array.isArray(N?.data)?N.data:[]).map((k,J)=>we(k,J));t||lt(V)}catch{}})(),()=>{t=!0}},[Y,re,we]),o.useEffect(()=>{let t=!1;return(async()=>{pt(!0);try{let N=1,F=[];for(;;){const V={action:"list"},k={q:te||"",branch:I!=="all"?I:"",status:A!=="all"?A:""};x&&x[0]&&x[1]&&(k.start=x[0].startOf("day").valueOf(),k.end=x[1].endOf("day").valueOf());const J={...V,page:N,pageSize:5e3,...k},be=await ot({webhookUrl:Y,method:"GET",payload:J}),Oe=be?.data||be,xe=Array.isArray(Oe?.data)?Oe.data:[];F=F.concat(xe.map((mt,bt)=>we(mt,bt)));const He=typeof Oe?.total=="number"?Oe.total:null;if(He!==null&&F.length>=He||xe.length===0||(N+=1,N>200))break}t||Nt(F)}catch{t||Nt([])}finally{t||pt(!1)}})(),()=>{t=!0}},[te,I,A,x,Y,we]),o.useEffect(()=>{let t=!1;const a=async()=>{P(!0);try{const g=Y,N="",F={action:"list"},V={q:te||"",branch:I!=="all"?I:"",status:A!=="all"?A:""};x&&x[0]&&x[1]&&(V.start=x[0].startOf("day").valueOf(),V.end=x[1].endOf("day").valueOf());const k=de?{...F,page:ve,pageSize:Z,...V,...N?{secret:N}:{}}:N?{...F,secret:N}:F,J=await ot({webhookUrl:g,method:"GET",payload:k}),be=J?.data||J;if(!be?.ok||!Array.isArray(be?.data))throw new Error("Invalid response");const xe=be.data.map((He,mt)=>we(He,mt)).filter(He=>He.bookingId||He.name||He.mobile);if(!t){h(xe);const He=typeof be.total=="number"?be.total:xe.length;ze(He);const mt={};xe.forEach(bt=>{bt.bookingId&&(mt[bt.bookingId]={level:bt._remarkLevel||String(bt.RemarkLevel||"").toLowerCase(),text:bt._remarkText||bt.RemarkText||""})}),De(mt);try{localStorage.setItem(Te,JSON.stringify({at:Date.now(),rows:xe,total:He}))}catch{}}}catch{w.error("Could not load bookings via Apps Script. Check Web App URL / access."),t||(h([]),ze(0))}finally{t||P(!1)}};a();const m=()=>a();return window.addEventListener("reload-bookings",m),()=>{t=!0}},[te,I,A,ve,Z,x,Y,de]);const ge=ke.length?ke:d,Ne=o.useMemo(()=>{const a=["all",...xt(ge.map(g=>g.branch))];if(!["owner","admin","backend"].includes(y)&&C.length){const g=St(C);return a.filter(N=>N==="all"||g.has(ee(N)))}return a},[ge,y,C]),Ge=o.useMemo(()=>["all",...xt(ge.map(t=>t.status))],[ge]),at=o.useCallback(t=>{const a=St(C);return(t||[]).filter(g=>{if(a.size&&!["owner","admin","backend"].includes(y)&&!a.has(ee(g.branch))||I!=="all"&&ee(g.branch)!==ee(I)||A!=="all"&&ee(g.status)!==ee(A))return!1;if(x&&x[0]&&x[1]){const N=x[0].startOf("day").valueOf(),F=x[1].endOf("day").valueOf(),V=g.tsMs??is(g.ts);if(!V||V<N||V>F)return!1}if(te){const N=te.toLowerCase();if(![g.bookingId,g.name,g.mobile,g.company,g.model,g.variant,g.color,g.chassis,g.branch].some(F=>String(F||"").toLowerCase().includes(N)))return!1}return!0}).slice().sort((g,N)=>(N.tsMs||0)-(g.tsMs||0))},[C,I,x,te,A,y]),yt=o.useMemo(()=>at(d),[at,d]);o.useEffect(()=>{me(1),Be(Z)},[I,A,te,x]),o.useEffect(()=>{Be(Z)},[Z]);const Et=o.useCallback(async()=>{if(!de)return d;const t={action:"list",page:1,pageSize:1e4},a={q:te||"",branch:I!=="all"?I:"",status:A!=="all"?A:""};x&&x[0]&&x[1]&&(a.start=x[0].startOf("day").valueOf(),a.end=x[1].endOf("day").valueOf());const m={...t,...a},g=await ot({webhookUrl:Y,method:"GET",payload:m}),N=g?.data||g;return(Array.isArray(N?.data)?N.data:[]).map((V,k)=>we(V,k)).filter(V=>V.bookingId||V.name||V.mobile)},[de,Y,re,I,x,te,we,A,d]),gt=async()=>{const t="export-bookings";w.loading({key:t,content:"Preparing CSVâ€¦",duration:0});try{const a=de?await Et():d,m=at(a);if(!m.length){w.info({key:t,content:"No rows to export for current filters"});return}const g=[{key:"ts",label:"Submitted At"},{key:"bookingId",label:"Booking ID"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"status",label:"Status"},{key:"availability",label:"Stock Status"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"chassis",label:"Chassis"},{key:"fileUrl",label:"File URL"}],N=m.map(F=>({ts:F.ts,bookingId:F.bookingId,name:F.name,mobile:F.mobile,branch:F.branch,status:F.status,availability:bs(F.chassis,F.availability),company:F.company,model:F.model,variant:F.variant,chassis:F.chassis,fileUrl:F.fileUrl}));Gt({filename:"bookings.csv",headers:g,rows:N}),w.success({key:t,content:`Exported ${N.length} bookings`})}catch{w.error({key:t,content:"Export failed. Please try again."})}},Xt=120*1e3,Kt=o.useMemo(()=>{const t=["owner","admin","backend"].includes(y);return I!=="all"?I:!t&&C.length===1?C[0]:""},[C,I,y]),_t=o.useMemo(()=>St(i),[i]),Mt=o.useMemo(()=>I!=="all"?St([I]):!["owner","admin","backend"].includes(y)&&C.length?St(C):null,[C,I,y]),Wt=o.useCallback(t=>{const a=ee(t?.sourceBranch||t?.branch||"");if(!a||_t.size&&!_t.has(a)||Mt&&Mt.size&&!Mt.has(a))return!1;const m=String(t?.status||"").toLowerCase();return!(m&&m!=="in_stock"&&m!=="in stock")},[_t,Mt]),Ht=o.useCallback(async(t=!1)=>{if(ft)return;const a=Kt||"";if(!(!t&&Ke.length>0&&Date.now()-Tt<Xt&&it===a)){At(!0);try{const g=await Sa({branch:a||void 0,limit:2e3}),N=Array.isArray(g?.data)?g.data:[];Fe(N),kt(Date.now()),ct(a)}catch{w.error("Could not load stock list.")}finally{At(!1)}}},[ft,Ke.length,Tt,it,Kt]),Ys={pending:"gold",seen:"blue",approved:"green",allotted:"purple",cancelled:"red"},bs=t=>!!String(t||"").trim()?"In Stock":"To be allotted",Js=t=>t==="In Stock"?"green":"volcano",wt=async(t,a,m)=>{let g=!1;try{Q(t);const F="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",V="",k=a||{},J={...k};k.invoiceStatus&&(J["Invoice Status"]=k.invoiceStatus),(k.invoiceFileUrl||k.invoiceFile)&&(J["Invoice File URL"]=k.invoiceFileUrl||k.invoiceFile),k.insuranceStatus&&(J["Insurance Status"]=k.insuranceStatus),(k.insuranceFileUrl||k.insuranceFile)&&(J["Insurance File URL"]=k.insuranceFileUrl||k.insuranceFile),k.rtoStatus&&(J["RTO Status"]=k.rtoStatus),(k.vehicleNo||k.regNo)&&(J["Vehicle No"]=k.vehicleNo||k.regNo),k.status&&(J.Status=k.status),await ot({webhookUrl:F,method:"POST",payload:V?{action:"update",bookingId:t,mobile:m,patch:J,secret:V}:{action:"update",bookingId:t,mobile:m,patch:J}}),h(be=>be.map(Oe=>{if(Oe.bookingId!==t)return Oe;const xe={...Oe};return a.status&&(xe.status=String(a.status).toLowerCase()),a.invoiceStatus&&(xe.invoiceStatus=a.invoiceStatus),(a.invoiceFileUrl||a.invoiceFile)&&(xe.invoiceFileUrl=a.invoiceFileUrl||a.invoiceFile),a.insuranceStatus&&(xe.insuranceStatus=a.insuranceStatus),(a.insuranceFileUrl||a.insuranceFile)&&(xe.insuranceFileUrl=a.insuranceFileUrl||a.insuranceFile),a.rtoStatus&&(xe.rtoStatus=a.rtoStatus),(a.vehicleNo||a.regNo)&&(xe.vehicleNo=a.vehicleNo||a.regNo),Object.prototype.hasOwnProperty.call(a,"chassis")&&(xe.chassis=a.chassis),Object.prototype.hasOwnProperty.call(a,"chassisNo")&&(xe.chassis=a.chassisNo),xe._raw={...Oe._raw||{},...a},xe})),w.success("Updated"),g=!0}catch{w.error("Update failed"),g=!1}finally{Q(null)}return g},Qs=async t=>{const m="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",g="",N=new FormData;N.append("action","upload");const F=t?.originFileObj||t;N.append("file",F,t?.name||F?.name||"document.pdf");try{const k=await(await fetch(m,{method:"POST",body:N,credentials:"omit"})).json().catch(()=>({}));if(k&&(k.ok||k.success))return k;throw new Error("Upload failed")}catch(V){try{const k=await new Promise((xe,He)=>{const mt=new FileReader,bt=t?.originFileObj||t;mt.onload=()=>{const rs=String(mt.result||""),Ns=rs.indexOf(",");xe(Ns>=0?rs.slice(Ns+1):rs)},mt.onerror=He,mt.readAsDataURL(bt)}),J=g?{action:"upload_base64",name:t?.name||"document.pdf",base64:k,secret:g}:{action:"upload_base64",name:t?.name||"document.pdf",base64:k},be=await ot({webhookUrl:m,method:"POST",payload:J}),Oe=be?.data||be;if(Oe&&(Oe.ok||Oe.success))return Oe}catch{}throw V}},Zs=t=>t.type==="application/pdf"||(t.name||"").toLowerCase().endsWith(".pdf")?(t.size||0)<=10*1024*1024?!1:(w.error("File must be <= 5MB"),ls.LIST_IGNORE):(w.error("Only PDF files allowed"),ls.LIST_IGNORE),Xs=async(t,a)=>{a==="received"?v({open:!0,type:"invoice",row:t,fileList:[],loading:!1}):await wt(t.bookingId,{invoiceStatus:a},t.mobile)},ea=async(t,a)=>{a==="received"?v({open:!0,type:"insurance",row:t,fileList:[],loading:!1}):await wt(t.bookingId,{insuranceStatus:a},t.mobile)},ta=async(t,a)=>{await wt(t.bookingId,{rtoStatus:a},t.mobile)},[xs,sa]=o.useState({}),vs=async t=>{const a=String(xs[t.bookingId]||"").trim(),m=_s(a);if(!m){w.error("Enter vehicle number");return}if(!/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/.test(m)){w.error("Use format KA55HY5666 (2 letters, 2 digits, 2 letters, 4 digits)");return}await wt(t.bookingId,{vehicleNo:m,regNo:m},t.mobile)},Ss=o.useCallback(t=>{if(!t)return[];const a=ee(t.company),m=ee(t.model),g=ee(t.variant),N=ee(t.color),F=new Set,V=[];return Ke.forEach(k=>{if(!Wt(k)||a&&ee(k.company)!==a||m&&ee(k.model)!==m||g&&ee(k.variant)!==g||N&&ee(k.color)!==N)return;const J=Qe(k.chassisNo||k.chassis||"");if(!J||F.has(J))return;F.add(J);const be=[J],Oe=String(k.color||"").trim(),xe=String(k.sourceBranch||k.branch||"").trim();Oe&&be.push(Oe),xe&&be.push(xe),V.push({value:J,label:be.join(" - ")})}),V.sort((k,J)=>k.label.localeCompare(J.label))},[Ke,Wt]),ks=o.useCallback((t,a)=>{const m=Qe(a);if(!m||!t)return null;const g=ee(t.company),N=ee(t.model),F=ee(t.variant),V=ee(t.color);return Ke.find(k=>!(!Wt(k)||Qe(k.chassisNo||k.chassis||"")!==m||g&&ee(k.company)!==g||N&&ee(k.model)!==N||F&&ee(k.variant)!==F||V&&ee(k.color)!==V))||null},[Ke,Wt]);o.useEffect(()=>{if(!Ve.open||!Ve.row)return;const t=Ve.row,a=t.bookingId?`Booking ID ${t.bookingId}`:"";s.setFieldsValue({company:t.company||"",model:t.model||"",variant:t.variant||"",color:t.color||"",sourceBranch:t.branch||"",chassis:"",notes:a?`Added for ${a}`:""}),u(""),Ht()},[Ve.open,Ve.row,Ht,s]);const es=t=>{if(!t?.bookingId){w.warning("Booking ID missing for this row.");return}Xe(null),vt(""),ut({open:!0,row:t})},ws=()=>{p||T||(ut({open:!1,row:null}),u(""),s.resetFields())},aa=t=>{if(!t?.bookingId){w.warning("Booking ID missing for this row.");return}if(!t?.chassis){es(t);return}Xe(t.bookingId),vt(Qe(t?.chassis||"")),Ht()},js=()=>{et||(Xe(null),vt(""))},ts=async(t,a,m={})=>{if(!t?.bookingId)return!1;const g=Qe(a);if(!g)return w.error("Select a chassis from stock to assign."),!1;const N=m?.matchedOverride||ks(t,g);if(!N)return w.error("Chassis not found in stock. Add stock movement first."),!1;if(!await wt(t.bookingId,{chassis:g},t.mobile))return!1;if(N&&g){const V=r?.name||r?.email||"user",k={Chassis_No:g,Company:N.company||t.company||"",Model:N.model||t.model||"",Variant:N.variant||t.variant||"",Color:N.color||t.color||"",Action:"invoice",Customer_Name:t.name||"",Source_Branch:N.sourceBranch||N.branch||"",Notes:t.bookingId?`Allotted to Booking ID ${t.bookingId}`:"Allotted from bookings"};try{const J=await Ls({data:k,createdBy:V});!!(J?.success??J?.ok)?Fe(Oe=>Oe.filter(xe=>Qe(xe.chassisNo||xe.chassis||"")!==g)):w.error(J?.message||"Saved booking but failed to update stock.")}catch{w.error("Saved booking but failed to update stock.")}}return!0},ss=async()=>{if(!Ve.row||p)return;R(!0);const t=await ts(Ve.row,It);R(!1),t&&(ut({open:!1,row:null}),u(""),s.resetFields())},na=async()=>{if(!Ve.row||T||p)return;if(Qe(s.getFieldValue("chassis"))){await oa();return}if(Qe(It)){await ss();return}w.warning("Enter chassis number or pick from stock.")},oa=async()=>{if(!Ve.row||T)return;let t=!1;try{const a=await s.validateFields();j(!0);const m=Ve.row,g=Qe(a.chassis),N=m.bookingId?`Booking ID ${m.bookingId}`:"",F=String(a.notes||"").trim(),V=N?F?`${F} | ${N}`:N:F,k={Chassis_No:g,Company:a.company||m.company||"",Model:a.model||m.model||"",Variant:a.variant||m.variant||"",Color:a.color||m.color||"",Action:"add",Source_Branch:a.sourceBranch||m.branch||"",Notes:V},J=r?.name||r?.email||"user",be=await Ls({data:k,createdBy:J});if(!!(be?.success??be?.ok)){const xe={chassisNo:g,company:k.Company||m.company||"",model:k.Model||m.model||"",variant:k.Variant||m.variant||"",color:k.Color||m.color||"",sourceBranch:k.Source_Branch||m.branch||"",status:"in_stock"};await ts(m,g,{matchedOverride:xe})?(w.success("Stock movement saved and chassis assigned."),t=!0):(w.warning("Stock movement saved. Assign chassis from stock below."),Ht(!0),u(g))}else w.error(be?.message||"Failed to save stock movement.")}catch(a){if(a?.errorFields)return;const m=a?.response?.data?.message||a?.message;w.error(m||"Failed to save stock movement.")}finally{j(!1),t&&ws()}},Cs=async t=>{if(!t?.bookingId||et)return;const a=Qe(qe),m=Qe(t?.chassis||"");if(a===m){js();return}We(!0);const g=await ts(t,a);We(!1),g&&(Xe(null),vt(""))},as={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},Ft={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},ra={...Ft,fontSize:11},ns={whiteSpace:"normal"},la=t=>{const a=Pe().format("DD-MM-YYYY HH:mm"),m=String(t||"").trim();return m?`${a} - ${m}`:a},Me=Ve.row,Rs=Me?[Me.company,Me.model,Me.variant,Me.color].filter(Boolean).join(" "):"",As=Me?xt([Me.branch,...i].filter(Boolean)):i;let Yt=[{title:"Date / Branch",key:"dateBranch",width:130,render:(t,a)=>{const m=is(a.ts),g=m?Pe(m).format("DD-MM-YYYY HH:mm"):"â€”";return e.jsxs("div",{style:as,children:[e.jsx("div",{style:Ft,children:g}),e.jsx("div",{style:Ft,children:e.jsx(Ot,{type:"secondary",children:a.branch||"â€”"})})]})}},{title:"Customer / Mobile / Model / File",key:"customerVehicleFile",width:240,render:(t,a)=>{const m=String(a.model||"").trim()||"â€”",g=String(a.variant||"").trim()||"â€”",N=String(a.color||"").trim(),F=[m,g,N].filter(Boolean).join(" || ")||"â€”";return e.jsxs("div",{style:as,children:[e.jsx("div",{style:Ft,children:a.name||"â€”"}),e.jsx("div",{style:Ft,children:e.jsx(Ot,{type:"secondary",children:a.mobile||"â€”"})}),e.jsx("div",{style:ra,children:F}),e.jsx("div",{style:ns,children:e.jsxs(ue,{size:6,wrap:!0,children:[e.jsx(Pa,{url:a.fileUrl}),e.jsx(q,{size:"small",type:"primary",onClick:()=>fe({open:!0,row:a}),title:"Print","aria-label":"Print",children:"ðŸ–¨ï¸"}),e.jsx(q,{size:"small",onClick:()=>Le({open:!0,row:a}),title:"View details","aria-label":"View details",children:"ðŸ‘ï¸"})]})})]})}},{title:"Chassis / Stk Status + Actions",key:"chassisStock",width:210,render:(t,a)=>{if(dt===a.bookingId){const V=Ss(a),k=ks(a,qe);return e.jsxs(ue,{direction:"vertical",size:4,children:[e.jsxs(ue,{size:6,align:"center",wrap:!0,children:[e.jsx(Ms,{value:qe,options:V,allowClear:!0,style:{width:200},placeholder:ft?"Loading stock...":"Pick chassis from stock",disabled:et,onChange:J=>vt(Qe(J)),onKeyDown:J=>{J.key==="Enter"&&(J.preventDefault(),Cs(a))},filterOption:(J,be)=>String(be?.value||"").toLowerCase().includes(String(J||"").toLowerCase())||String(be?.label||"").toLowerCase().includes(String(J||"").toLowerCase())}),e.jsx(q,{size:"small",type:"primary",loading:et,onClick:()=>Cs(a),children:"Save"}),e.jsx(q,{size:"small",disabled:et,onClick:js,children:"Cancel"})]}),e.jsx(Ot,{type:"secondary",children:k?`In stock at ${k.sourceBranch||k.branch||"branch"} - will be allotted on save.`:V.length?"Pick from stock list to allot. If missing, add stock movement first.":"No stock for this model in current branches. Add stock movement first."})]})}const g=bs(a.chassis,a.availability),N=String(a.status||"pending").replace(/_/g," "),F=!a.chassis;return e.jsxs("div",{style:as,children:[e.jsx("div",{style:ns,children:e.jsxs(ue,{size:6,align:"center",wrap:!0,children:[e.jsx("span",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace",cursor:"pointer"},title:F?"Assign chassis":"Edit chassis",onClick:()=>F?es(a):aa(a),children:a.chassis||"-"}),F?e.jsx(q,{size:"small",type:"link",onClick:()=>es(a),children:"Assign"}):null]})}),e.jsx("div",{style:ns,children:e.jsxs(ue,{size:6,wrap:!0,children:[e.jsx(he,{color:Js(g),children:g}),e.jsx(he,{color:Ys[String(a.status||"").toLowerCase()]||"default",children:N})]})})]})}}];Yt.push({title:"More",key:"more",width:200,render:(t,a)=>e.jsxs(ue,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsx(pe,{size:"small",placeholder:"Invoice",style:{width:"100%"},onChange:m=>Xs(a,m),options:[{value:"submit_to_dealer",label:"Submit to dealer"},{value:"pending_by_dealer",label:"Pending by dealer"},{value:"received",label:"Received (upload)"}]}),e.jsx(pe,{size:"small",placeholder:"Insurance",style:{width:"100%"},onChange:m=>ea(a,m),options:[{value:"sent",label:"Sent insurance"},{value:"received",label:"Received (upload)"}]}),e.jsx(pe,{size:"small",placeholder:"RTO status",style:{width:"100%"},onChange:m=>ta(a,m),options:[{value:"finance_otp_pending",label:"Finance Payment pending"},{value:"customer_otp_taken",label:"Customer OTP Pending"},{value:"registration_done",label:"Registration done"}]}),e.jsxs(ue,{size:6,align:"center",children:[e.jsx(X,{size:"small",placeholder:"KA55HY5666",style:{width:120},value:xs[a.bookingId]??(a.vehicleNo||""),onChange:m=>sa(g=>({...g,[a.bookingId]:_s(m.target.value)})),onPressEnter:()=>vs(a)}),e.jsx(q,{size:"small",onClick:()=>vs(a),children:"Save"})]})]})}),Yt.push({title:"Progress",key:"progress",width:120,render:(t,a)=>{const m=a._raw||{},g=m["Invoice Status"]||m.invoiceStatus||a.invoiceStatus||"",N=m["Invoice File URL"]||m.Invoice_File_URL||m.invoiceFileUrl||a.invoiceFileUrl||"",F=m["Insurance Status"]||m.insuranceStatus||a.insuranceStatus||"",V=m["Insurance File URL"]||m.Insurance_File_URL||m.insuranceFileUrl||a.insuranceFileUrl||"",k=m["RTO Status"]||m.rtoStatus||a.rtoStatus||"",J=m["Vehicle No"]||m.Vehicle_No||m.vehicleNo||a.vehicleNo||"",be={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4,fontSize:11},children:[e.jsxs("div",{style:be,children:[e.jsx(he,{color:"geekblue",title:"Invoice",children:String(g||"-").replace(/_/g," ")}),N?e.jsx("a",{href:N,target:"_blank",rel:"noopener noreferrer",children:"ðŸ“Ž"}):null]}),e.jsxs("div",{style:be,children:[e.jsx(he,{color:"cyan",title:"Insurance",children:String(F||"-").replace(/_/g," ")}),V?e.jsx("a",{href:V,target:"_blank",rel:"noopener noreferrer",children:"ðŸ“Ž"}):null]}),e.jsx("div",{style:be,children:e.jsx(he,{title:"RTO",children:String(k||"-").replace(/_/g," ")})}),e.jsx("div",{style:be,children:e.jsx(he,{title:"Vehicle No",children:J||"-"})})]})}});const os=["backend","admin","owner"].includes(y);Yt.push({title:os?"Actions + Remarks":"Actions",key:"actions",width:os?210:170,render:(t,a)=>e.jsxs(ue,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsx(pe,{size:"small",defaultValue:a.status||"pending",style:{width:"100%"},onChange:m=>wt(a.bookingId,{status:m},a.mobile),options:[{value:"pending",label:"Pending"},{value:"seen",label:"Seen"},{value:"approved",label:"Approved"},{value:"allotted",label:"Allotted"},{value:"cancelled",label:"Cancelled"}]}),os?e.jsxs(ue,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsxs(ue,{size:6,wrap:!0,children:[e.jsx(he,{color:Ie[a.bookingId]?.level==="alert"?"red":Ie[a.bookingId]?.level==="warning"?"gold":Ie[a.bookingId]?.level==="ok"?"green":"default",children:Ie[a.bookingId]?.level?String(Ie[a.bookingId].level).toUpperCase():"â€”"}),e.jsx(q,{size:"small",onClick:()=>Ae({open:!0,refId:a.bookingId,level:Ie[a.bookingId]?.level||"ok",text:Ie[a.bookingId]?.text||""}),children:"Remark"})]}),e.jsx(Ct,{title:Ie[a.bookingId]?.text?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:Ie[a.bookingId].text}):null,children:e.jsx("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:Ie[a.bookingId]?.text||"â€”"})})]}):null]})});const Ts=de?ne:d.length,Is=S?420:600,zt=de?yt:ie==="loadMore"?yt.slice(0,je):yt,ia=o.useMemo(()=>{const t=Rt.length?Rt:at(ke.length?ke:d),a=new Map;return(t||[]).forEach(m=>{const g=String(m.branch||"Unknown").trim()||"Unknown",N=ee(g);a.has(N)||a.set(N,{key:N,branch:g,total:0});const F=a.get(N);F.total+=1}),Array.from(a.values()).sort((m,g)=>g.total-m.total)},[at,ke,d,Rt]);return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[e.jsxs(ue,{size:"small",wrap:!0,children:[e.jsx(pe,{value:I,onChange:$,style:{minWidth:160},disabled:!["owner","admin","backend"].includes(y),options:Ne.map(t=>({value:t,label:t==="all"?"All Branches":t}))}),e.jsx(pe,{value:A,onChange:W,style:{minWidth:160},options:Ge.map(t=>({value:t,label:t==="all"?"All Statuses":t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ")}))}),e.jsx(fs.RangePicker,{value:x,onChange:t=>{_(t),L(null)},allowClear:!0}),e.jsx(q,{size:"small",type:le==="today"?"primary":"default",onClick:()=>{const t=Pe();_([t,t]),L("today")},children:"Today"}),e.jsx(q,{size:"small",type:le==="yesterday"?"primary":"default",onClick:()=>{const t=Pe().subtract(1,"day");_([t,t]),L("yesterday")},children:"Yesterday"}),e.jsx(q,{size:"small",onClick:()=>{_(null),L(null)},children:"Clear"}),e.jsx(X,{placeholder:"Search name/mobile/booking",allowClear:!0,value:se,onChange:t=>E(t.target.value),style:{minWidth:220}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(ue,{children:[e.jsx(q,{type:"primary",onClick:()=>{U({open:!0}),(!i.length||!B.length)&&z()},children:"Booking Form"}),e.jsx(ka,{webhookUrl:Y}),e.jsxs(he,{color:"blue",children:["Total: ",Ts]}),e.jsxs(he,{color:"geekblue",children:["Showing: ",de||ie==="loadMore"?zt.length:yt.length,A!=="all"?` (status: ${A})`:""]}),!de&&e.jsx(pe,{size:"small",value:ie,onChange:t=>{Se(t),Be(Z)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(q,{onClick:gt,children:"Export CSV"}),e.jsx(q,{loading:O,onClick:()=>{const t=new Event("reload-bookings");window.dispatchEvent(t)},children:"Refresh"})]})]}),e.jsxs(Pt,{gutter:[12,12],style:{marginBottom:12},children:[Lt?e.jsx(ae,{xs:24,children:e.jsx(he,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,ia.map(t=>e.jsx(ae,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ys,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:t.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:t.total})]})})},t.key))]}),e.jsx(Bt,{dataSource:zt,columns:Yt,loading:O&&!$e,size:"small",className:"compact-table",tableLayout:S?"auto":"fixed",pagination:de?{current:ve,pageSize:Z,total:Ts,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(t,a)=>{me(t),a!==Z&&Re(a)},showTotal:(t,a)=>`${a[0]}-${a[1]} of ${t}`}:ie==="pagination"?{current:ve,pageSize:Z,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(t,a)=>{me(t),a!==Z&&Re(a)},showTotal:(t,a)=>`${a[0]}-${a[1]} of ${t}`}:!1,rowKey:t=>`${t.bookingId}-${t.mobile}-${t.ts}-${t.key}`,scroll:S?{x:"max-content",y:Is}:{y:Is}}),!de&&ie==="loadMore"&&zt.length<yt.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(q,{onClick:()=>Be(t=>Math.min(t+Z,yt.length)),children:["Load more (",yt.length-zt.length," more)"]})}):null,e.jsx(rt,{open:c.open,onCancel:()=>U({open:!1}),footer:null,width:1040,destroyOnClose:!0,title:"New Booking",bodyStyle:{paddingTop:8},children:e.jsx(Gs,{allowBranchSelect:!0,allowExecutiveSelect:!0,branchOptions:i,executiveOptions:B,branchOptionsLoading:_e,executiveOptionsLoading:_e,onSuccess:()=>{U({open:!1});try{window.dispatchEvent(new Event("reload-bookings"))}catch{}}})}),e.jsx(wa,{open:D.open,onClose:()=>fe({open:!1,row:null}),row:D.row,webhookUrl:Y,secret:re}),e.jsx(Ea,{open:ye.open,onClose:()=>Le({open:!1,row:null}),row:ye.row,webhookUrl:Y}),e.jsxs(rt,{open:Ve.open,title:Me?`New Stock Movement â€“ ${Me.bookingId||Me.name||""}`:"New Stock Movement",onCancel:ws,footer:null,width:760,destroyOnClose:!0,maskClosable:!p&&!T,closable:!p&&!T,children:[Me?e.jsxs("div",{style:{marginBottom:12},children:[e.jsxs("div",{style:{fontWeight:600},children:[Me.name||"Customer",Me.mobile?` â€¢ ${Me.mobile}`:""]}),e.jsxs("div",{style:{color:"#6b7280"},children:[Me.branch||"â€”",Rs?` â€¢ ${Rs}`:""]}),Me.bookingId?e.jsxs("div",{style:{color:"#6b7280"},children:["Booking ID: ",Me.bookingId]}):null]}):null,e.jsx(Es,{orientation:"left",style:{marginTop:0},children:"New Stock Movement"}),e.jsxs(K,{form:s,layout:"vertical",children:[e.jsxs(Pt,{gutter:[12,8],children:[e.jsx(ae,{xs:24,md:12,children:e.jsx(K.Item,{name:"company",label:"Company",children:e.jsx(X,{disabled:!0})})}),e.jsx(ae,{xs:24,md:12,children:e.jsx(K.Item,{name:"model",label:"Model",children:e.jsx(X,{disabled:!0})})}),e.jsx(ae,{xs:24,md:12,children:e.jsx(K.Item,{name:"variant",label:"Variant",children:e.jsx(X,{disabled:!0})})}),e.jsx(ae,{xs:24,md:12,children:e.jsx(K.Item,{name:"color",label:"Color",children:e.jsx(X,{disabled:!0})})}),e.jsx(ae,{xs:24,md:12,children:e.jsx(K.Item,{name:"sourceBranch",label:"Source Branch",rules:[{required:!0,message:"Source branch is required"}],children:As.length?e.jsx(pe,{showSearch:!0,optionFilterProp:"label",placeholder:"Select branch",options:As.map(t=>({label:t,value:t}))}):e.jsx(X,{placeholder:"Enter source branch"})})}),e.jsx(ae,{xs:24,md:12,children:e.jsx(K.Item,{name:"chassis",label:"Chassis No.",rules:[{required:!0,message:"Chassis number is required"}],children:e.jsx(X,{placeholder:"Enter chassis number",onChange:t=>s.setFieldsValue({chassis:Qe(t.target.value)})})})})]}),e.jsx(K.Item,{name:"notes",label:"Notes",children:e.jsx(X.TextArea,{rows:2,placeholder:"Optional notes"})}),e.jsxs(ue,{children:[e.jsx(q,{type:"primary",onClick:na,loading:T||p,disabled:!Me,children:"Save & Assign"}),e.jsx(Ot,{type:"secondary",children:"Type chassis above or pick from stock below."})]})]}),e.jsx(Es,{orientation:"left",children:"Assign from Stock"}),e.jsxs(ue,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsx(Ms,{value:It,options:Me?Ss(Me):[],allowClear:!0,style:{width:"100%"},placeholder:ft?"Loading stock...":"Pick chassis from stock",disabled:p,onChange:t=>u(Qe(t)),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),ss())},filterOption:(t,a)=>String(a?.value||"").toLowerCase().includes(String(t||"").toLowerCase())||String(a?.label||"").toLowerCase().includes(String(t||"").toLowerCase())}),e.jsxs(ue,{children:[e.jsx(q,{type:"primary",onClick:ss,loading:p,disabled:!Me,children:"Assign Chassis"}),e.jsx(Ot,{type:"secondary",children:"Only chassis from stock list can be assigned."})]})]})]}),e.jsx(rt,{open:Ee.open,title:`Update Remark: ${Ee.refId}`,onCancel:()=>Ae({open:!1,refId:"",level:"ok",text:""}),onOk:()=>{const{refId:t,level:a,text:m}=Ee,g=la(m),N=Ie[t],F=d.find(V=>V.bookingId===t);De(V=>({...V,[t]:{level:a,text:g}})),h(V=>V.map(k=>k.bookingId===t?{...k,RemarkLevel:a.toUpperCase(),RemarkText:g,_remarkLevel:a,_remarkText:g}:k)),Ae({open:!1,refId:"",level:"ok",text:""}),(async()=>{try{const k=await ot({webhookUrl:Y,method:"POST",payload:re?{action:"remark",bookingId:t,level:a,text:g,secret:re}:{action:"remark",bookingId:t,level:a,text:g}}),J=k?.data||k;if(!(J&&(J.ok||J.success)))throw new Error("Save failed");w.success("Remark saved to sheet")}catch{De(V=>{const k={...V};return N?k[t]=N:delete k[t],k}),F&&h(V=>V.map(k=>k.bookingId===t?F:k)),w.error("Save failed")}})()},children:e.jsxs(ue,{direction:"vertical",style:{width:"100%"},children:[e.jsx(pe,{value:Ee.level,onChange:t=>Ae(a=>({...a,level:t})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(X,{maxLength:140,showCount:!0,value:Ee.text,onChange:t=>Ae(a=>({...a,text:t.target.value})),placeholder:"Short note (optional)"})]})}),e.jsx(rt,{open:l.open,title:`${l.type==="invoice"?"Invoice":"Insurance"} â€“ Upload file`,onCancel:()=>v({open:!1,type:"",row:null,fileList:[],loading:!1}),confirmLoading:l.loading,okText:l.loading?"Savingâ€¦":"Save",cancelButtonProps:{disabled:l.loading},maskClosable:!l.loading,onOk:async()=>{if(l.loading)return;if(!l.row){v({open:!1,type:"",row:null,fileList:[],loading:!1});return}const t=(l.fileList||[])[0];if(!t){w.error("Please select a PDF file");return}v(m=>({...m,loading:!0}));const a="upload-progress";w.loading({key:a,content:"Uploading and savingâ€¦",duration:0}),setTimeout(async()=>{try{const m=await Qs(t),g=m?.url||m?.downloadUrl||"";if(!g){w.error({key:a,content:"Upload failed"}),v(N=>({...N,loading:!1}));return}l.type==="invoice"?await wt(l.row.bookingId,{invoiceStatus:"received",invoiceFileUrl:g},l.row.mobile):l.type==="insurance"&&await wt(l.row.bookingId,{insuranceStatus:"received",insuranceFileUrl:g},l.row.mobile),w.success({key:a,content:"Saved successfully"}),v({open:!1,type:"",row:null,fileList:[],loading:!1})}catch{w.error({key:a,content:"Could not upload file"}),v(m=>({...m,loading:!1}))}},0)},children:e.jsx(ls.Dragger,{multiple:!1,beforeUpload:Zs,accept:".pdf",fileList:l.fileList,maxCount:1,disabled:l.loading,onChange:({fileList:t})=>v(a=>({...a,fileList:t.slice(0,1)})),itemRender:t=>t,children:e.jsx("p",{children:"Drop PDF here or click to select (max 5MB, PDF only)"})})})]})}function is(n){if(!n)return null;if(n instanceof Date)return n.getTime();if(typeof n=="number")return n;const S=String(n).trim(),d=new Date(S);if(!isNaN(d.getTime()))return d.getTime();const h=S.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(h){const O=h[2];let P=parseInt(h[1],10),I=parseInt(h[3],10),$=parseInt(h[4],10);$<100&&($+=2e3);let A,W;O==="-"||P>12?(W=P,A=I-1):(A=P-1,W=I);let x=h[5]?parseInt(h[5],10):0;const _=h[6]?parseInt(h[6],10):0,le=h[7]?parseInt(h[7],10):0,L=(h[8]||"").toUpperCase();L==="PM"&&x<12&&(x+=12),L==="AM"&&x===12&&(x=0);const Q=new Date($,A,W,x,_,le);if(!isNaN(Q.getTime()))return Q.getTime()}return null}function Ma(n){try{if(!n)return null;const S=new URL(n);if(S.searchParams.get("id"))return S.searchParams.get("id");const d=S.pathname.match(/\/d\/([^/]+)/);return d&&d[1]?d[1]:null}catch{const S=String(n||"").match(/[?&]id=([^&]+)/);return S?S[1]:null}}function Oa(n){if(!n)return{view:"",download:"",embed:""};const S=Ma(n);return S?{view:`https://drive.google.com/uc?export=view&id=${S}`,download:`https://drive.google.com/uc?export=download&id=${S}`,embed:`https://drive.google.com/file/d/${S}/preview`}:{view:n,download:n,embed:n}}function Qe(n){return String(n||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20)}function _s(n){return String(n||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,10)}function Pa({url:n}){if(!n)return e.jsx(Ot,{type:"secondary",children:"â€”"});const{view:S,download:d,embed:h}=Oa(n),O=e.jsxs("div",{style:{width:340},children:[e.jsx("div",{style:{height:260,border:"1px solid #e5e7eb",borderRadius:8,overflow:"hidden",marginBottom:8},children:e.jsx("iframe",{src:h,title:"preview",width:"100%",height:"100%",style:{display:"block",border:0},allow:"fullscreen"})}),e.jsxs(ue,{children:[e.jsx("a",{href:S,target:"_blank",rel:"noopener",children:"Open"}),e.jsx("a",{href:d,children:"Download"})]})]});return e.jsxs(ue,{size:6,children:[e.jsx(Ks,{content:O,title:"Preview",trigger:"click",children:e.jsx(q,{size:"small",title:"Preview","aria-label":"Preview",children:"ðŸ”"})}),e.jsx("a",{href:d,title:"Download","aria-label":"Download",children:"â¬‡ï¸"})]})}const{Text:us}=Zt,Ze={ts:["Timestamp","Time","Date"],name:["Customer_Name","Customer","Name"],mobile:["Mobile","Phone","Mobile Number"],branch:["Branch"],executive:["Executive"],serialNo:["Quotation No.","Quotation No","Serial","Serial No","Quote Id"],company:["Company"],model:["Model","Bike Model"],variant:["Variant"],price:["On-Road Price","On Road Price","Price"],offerings:["Offerings","Remarks","Remark","Quotation Remarks"],payload:["Payload"],status:["Status","FollowUp Status","Quotation Status"],followUpNotes:["Follow-up Notes","Follow Up Notes","Followup Notes","Notes"]},tt=(n,S)=>String(S.map(d=>n[d]??"").find(d=>d!=="")||"").trim(),Fs=typeof Intl<"u"?new Intl.NumberFormat("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2}):null,qt=n=>{if(n==null||Number.isNaN(Number(n)))return"â€”";const S=Number(n),d=Fs?Fs.format(Math.abs(S)):String(Math.abs(S));return`${S<0?"-":""}â‚¹${d}`},Ua=9,Ba=11,_a=8e3,Fa=(n,S)=>{const d=Number(n||0),h=Number(S||0);return(d>0?h/d:0)>=.3?Ua:Ba},za=(n,S,d)=>{const O=Math.max(Number(n||0)-Number(S||0),0)+_a,P=d/12,I=Fa(n,S),$=O*(I/100)*P,A=O+$;return d>0?A/d:0},Da=n=>String(n||"")==="12"?[12,18,24,36]:[24,30,36,48],Ws=(n,S,d)=>{const h=Da(d);if(!Number(n||0))return"";const O=h.map(P=>`${P}:${qt(za(n,S,P))}`);return O.length?`EMI(${d||"12"}): ${O.join(" | ")}`:""},$a=n=>String(n||"").trim().toLowerCase(),Hs=n=>["loan","nohp","hp","finance"].includes($a(n)),Va=({payload:n,baseOfferings:S})=>{const d=String(S||"").trim();if(!n||typeof n!="object")return d;const h=n.formValues||{},O=Array.isArray(n.extraVehicles)?n.extraVehicles:[],P=h.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType??"cash",I=[],$=(A,W,x,_,le)=>{const L=Number(W||0),Q=Number(x||0);if(!(L||Q))return;const D=Hs(le??P),fe=[];L&&fe.push(`Price ${qt(L)}`),D&&Q&&fe.push(`DP ${qt(Q)}`);const ye=D?Ws(L,Q,_||n.emiSet||"12"):"";D&&ye&&fe.push(ye),I.push(`${A}: ${fe.join(" | ")}`)};return $("V1",h.onRoadPrice??n.onRoadPrice,h.downPayment??n.downPayment,n.emiSet,h.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType),O.forEach((A,W)=>{$(`V${W+2}`,A.onRoadPrice,A.downPayment,A.emiSet||n.emiSet,A.mode??A.purchaseMode??A.purchaseType??A.paymentType)}),[d,...I].filter(Boolean).join(" â€¢ ")},zs=(n=[])=>Array.from(new Set((Array.isArray(n)?n:[]).map(S=>String(S||"").trim()).filter(Boolean))),qa=({payload:n,baseOfferings:S,fallbackText:d})=>{const h=String(S||"").trim(),O=[];if(n&&typeof n=="object"){const P=n.formValues||{},I=zs(n.fittings),$=P.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType??"cash",A=({label:x,company:_,model:le,variant:L,priceRaw:Q,dpRaw:D,emiSetRaw:fe,fittingsRaw:ye,modeRaw:Le})=>{const se=String(_||"").trim(),E=String(le||"").trim(),te=String(L||"").trim(),ve=Number(Q||0),me=Number(D||0),Z=zs(ye||I),Re=[se,E,te].filter(Boolean).join(" "),ie=!!(Re||Z.length||ve||me),Se=Hs(Le??$);ie&&O.push({label:x,title:Re||"Vehicle details not available",priceText:ve?qt(ve):"â€”",dpText:me?qt(me):"â€”",emiText:Se&&ve?Ws(ve,me,fe||n.emiSet||"12"):"",fittings:Z,showFinance:Se})};A({label:"Vehicle 1",company:P.company??n.company,model:P.bikeModel??P.model??n.model,variant:P.variant??n.variant,priceRaw:P.onRoadPrice??n.onRoadPrice,dpRaw:P.downPayment??n.downPayment,emiSetRaw:n.emiSet,fittingsRaw:n.fittings,modeRaw:P.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType}),(Array.isArray(n.extraVehicles)?n.extraVehicles:[]).forEach((x,_)=>{A({label:`Vehicle ${_+2}`,company:x.company,model:x.model,variant:x.variant,priceRaw:x.onRoadPrice,dpRaw:x.downPayment,emiSetRaw:x.emiSet||n.emiSet,fittingsRaw:x.fittings,modeRaw:x.mode??x.purchaseMode??x.purchaseType??x.paymentType})})}return!O.length&&d&&String(d).split("â€¢").map(I=>I.trim()).filter(Boolean).forEach(I=>{const $=I.match(/^V(\d+)\s*:\s*(.+)$/i);$&&O.push({label:`Vehicle ${$[1]}`,title:$[2],priceText:"â€”",dpText:"â€”",emiText:"",fittings:[],showFinance:!1})}),{remarks:h,vehicles:O}};function Rn(){const S=!Ut.useBreakpoint().md,d=Vs(),[h,O]=o.useState([]),[P,I]=o.useState(!1),[$,A]=o.useState(!1),[W,x]=o.useState([]),[_,le]=o.useState("all"),[L,Q]=o.useState("all"),[D,fe]=o.useState("all"),[ye,Le]=o.useState(""),se=gs(ye,300),[E,te]=o.useState(()=>[Pe().startOf("month"),Pe()]),[ve,me]=o.useState(null),[Z,Re]=o.useState(""),[ie,Se]=o.useState([]),[je,Be]=o.useState(1),[ne,ze]=o.useState(25),[de,Ie]=o.useState("pagination"),[De,Ee]=o.useState(25),[Ae,$e]=o.useState(0),H="true".toLowerCase()==="true",[l,v]=o.useState({}),[c,U]=o.useState({open:!1,refId:"",level:"ok",text:""}),[i,M]=o.useState(!1),[B,Ce]=o.useState([]);o.useEffect(()=>{try{const u=localStorage.getItem("user");if(!u)return;const p=JSON.parse(u);Re(String(p?.role||"").toLowerCase());const R=[],T=p?.formDefaults?.branchName||p?.primaryBranch?.name||"";T&&R.push(T),Array.isArray(p?.branches)&&p.branches.forEach(j=>{const s=typeof j=="string"?j:j?.name||"";s&&R.push(s)}),Se(Array.from(new Set(R.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(Z)&&ie.length&&_==="all"&&le(ie[0])},[Z,ie,_]);const _e=(()=>{const u=E&&E[0]?E[0].startOf("day").valueOf():"",p=E&&E[1]?E[1].endOf("day").valueOf():"";return`Quotations:list:${JSON.stringify({branchFilter:_,modeFilter:L,statusFilter:D,q:se||"",start:u,end:p,page:je,pageSize:ne,USE_SERVER_PAG:H})}`})(),Ue=o.useMemo(()=>({GAS_URL:"https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",SECRET:""}),[]),ke=o.useCallback((u,p=0)=>{const R=u&&u.values?u.values:u,T=u&&u.payload?u.payload:(R?R[Ze.payload[0]]:void 0)||"";let j=null;try{j=typeof T=="object"?T:JSON.parse(String(T||"{}"))}catch{j=null}const s=j&&j.formValues?j.formValues:{},r=tt(R,Ze.ts),f=String(s.createdAt||j&&(j.createdAt||j.created_at||j.createdOn||j.created_on||j.quoteCreatedAt||j.quotationCreatedAt)||R["Created At"]||R.CreatedAt||R["Quotation Created At"]||R["Quotation Created"]||R["Created Time"]||r||"").trim(),y=j&&j.mode||"",b=j&&j.followUp&&j.followUp.status||tt(R,Ze.status)||"",C=j&&j.brand||"",G=s.company||tt(R,Ze.company),z=s.bikeModel||s.model||tt(R,Ze.model),ce=s.variant||tt(R,Ze.variant),Y=String(s.onRoadPrice||tt(R,Ze.price)||"").trim(),re=String(s.remarks||j&&j.remarks||tt(R,Ze.offerings)||"").trim(),Te=Va({payload:j,baseOfferings:re}),we=String(j&&j.followUp&&j.followUp.notes||j&&j.closeNotes||j&&j.followupNotes||j&&j.notes||tt(R,Ze.followUpNotes)||"").trim(),ge=j&&j.remark&&j.remark.level||R.RemarkLevel||R.remarkLevel||"",Ne=j&&j.remark&&j.remark.text||R.RemarkText||R.remarkText||"",Ge=String(ge||"").toLowerCase();return{key:p,ts:f||r,tsMs:ms(f||r),name:s.name||tt(R,Ze.name),mobile:s.mobile||tt(R,Ze.mobile),branch:s.branch||tt(R,Ze.branch),executive:s.executive||tt(R,Ze.executive),serialNo:s.serialNo||tt(R,Ze.serialNo),company:G,model:z,variant:ce,price:Y,offerings:Te,offeringsBase:re,payload:j,mode:y||j&&j.mode||"",brand:C,status:b,followUpNotes:we,RemarkLevel:ge||"",RemarkText:Ne||"",_remarkLevel:Ge,_remarkText:Ne||""}},[]);o.useEffect(()=>{try{const u=localStorage.getItem(_e);if(!u)return;const p=JSON.parse(u);p&&Array.isArray(p.rows)&&(O(p.rows),$e(typeof p.total=="number"?p.total:p.rows.length),M(!0))}catch{}},[_e]),o.useEffect(()=>{let u=!1;return(async()=>{try{const{GAS_URL:R,SECRET:T}=Ue;if(!R)return;const s=await ot({webhookUrl:R,method:"GET",payload:T?{action:"list",page:1,pageSize:5e3,secret:T}:{action:"list",page:1,pageSize:5e3}}),r=s?.data||s;if(!r||!r.ok&&!r.success)return;const y=(Array.isArray(r.data)?r.data:Array.isArray(r.rows)?r.rows:[]).map((b,C)=>ke(b,C));u||Ce(y)}catch{}})(),()=>{u=!0}},[Ue,ke]),o.useEffect(()=>{let u=!1;const p=async()=>{I(!0);try{const{GAS_URL:T,SECRET:j}=Ue;if(!T){w.info("Quotations: Apps Script URL not configured â€” showing empty list."),u||(O([]),$e(0));return}const s={action:"list"},r={q:se||"",branch:_!=="all"?_:"",mode:L!=="all"?L:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(r.start=E[0].startOf("day").valueOf(),r.end=E[1].endOf("day").valueOf());const f=H?{...s,page:je,pageSize:ne,...r,...j?{secret:j}:{}}:j?{...s,secret:j}:s,y=await ot({webhookUrl:T,method:"GET",payload:f}),b=y?.data||y;if(!b||!b.ok&&!b.success)throw new Error("Invalid response");const z=(Array.isArray(b.data)?b.data:Array.isArray(b.rows)?b.rows:[]).map((ce,Y)=>ke(ce,Y)).filter(ce=>ce.name||ce.mobile||ce.serialNo);if(!u){O(z);const ce=typeof b.total=="number"?b.total:z.length;$e(ce);const Y={};z.forEach(re=>{re.serialNo&&(Y[re.serialNo]={level:re._remarkLevel||void 0,text:re._remarkText||""})}),v(Y);try{localStorage.setItem(_e,JSON.stringify({at:Date.now(),rows:z,total:ce}))}catch{}}}catch{w.error("Could not load quotations via Apps Script. Check QUOTATION Web App URL / access."),u||(O([]),$e(0))}finally{u||I(!1)}};p();const R=()=>p();return window.addEventListener("reload-quotations",R),()=>{u=!0,window.removeEventListener("reload-quotations",R)}},[se,_,L,D,je,ne,E,H]);const lt=B.length?B:h,Rt=o.useMemo(()=>{const p=["all",...xt(lt.map(T=>T.branch))];if(!["owner","admin","backend"].includes(Z)&&ie.length){const T=St(ie);return p.filter(j=>j==="all"||T.has(ee(j)))}return p},[lt,Z,ie]),Nt=o.useMemo(()=>["all",...xt(lt.map(u=>u.mode))],[lt]),Lt=o.useMemo(()=>{const u=lt.map(p=>p.status).filter(p=>ee(p)!=="lost");return["all",...xt(u)]},[lt]),pt=o.useCallback(u=>{const p=St(ie);return(u||[]).filter(T=>{const j=ee(T.branch);if(p.size&&!["owner","admin","backend"].includes(Z)&&!p.has(j)||_!=="all"&&j!==ee(_)||L!=="all"&&ee(T.mode)!==ee(L)||D!=="all"&&ee(T.status)!==ee(D))return!1;if(E&&E[0]&&E[1]){const s=E[0].startOf("day").valueOf(),r=E[1].endOf("day").valueOf(),f=T.tsMs??ms(T.ts);if(!f||f<s||f>r)return!1}if(se){const s=se.toLowerCase();if(![T.name,T.mobile,T.serialNo,T.company,T.model,T.variant,T.branch,T.executive,T.status,T.followUpNotes].some(r=>String(r||"").toLowerCase().includes(s)))return!1}return!0}).slice().sort((T,j)=>(j.tsMs||0)-(T.tsMs||0))},[ie,_,E,se,L,D,Z]),Ke=o.useCallback(async()=>{if(!H)return h;const{GAS_URL:u,SECRET:p}=Ue;if(!u)return h;const R=100,T={q:se||"",branch:_!=="all"?_:"",mode:L!=="all"?L:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(T.start=E[0].startOf("day").valueOf(),T.end=E[1].endOf("day").valueOf());const j=[],s=new Set;let r=1,f=200;for(;r<=f;){const y={action:"list",page:r,pageSize:R},b=p?{...y,...T,secret:p}:{...y,...T},C=await ot({webhookUrl:u,method:"GET",payload:b}),G=C?.data||C;typeof G?.total=="number"&&Number.isFinite(G.total)&&(f=Math.ceil(G.total/R));const z=Array.isArray(G?.data)?G.data:Array.isArray(G?.rows)?G.rows:[];if(!z.length)break;let ce=0;if(z.forEach(Y=>{const Te=String(Y?.values?.["Quotation No."]||Y?.values?.["Quotation No"]||Y?.values?.Serial||Y?.serialNo||Y?.["Quotation No."]||Y?.["Quotation No"]||Y?.Serial||"").trim()||JSON.stringify(Y);s.has(Te)||(s.add(Te),j.push(Y),ce+=1)}),ce===0||z.length<R)break;r+=1}return j.map((y,b)=>ke(y,b)).filter(y=>y.name||y.mobile||y.serialNo)},[H,Ue,_,E,se,ke,L,h,D]),Fe=o.useMemo(()=>pt(h),[pt,h]);o.useEffect(()=>{let u=!1;return(async()=>{if(!H){x(Fe);return}A(!0);try{const R=await Ke(),T=pt(R);u||x(T)}catch{u||x([])}finally{u||A(!1)}})(),()=>{u=!0}},[H,Ke,pt,_,L,D,se,E,Z,ie]),o.useEffect(()=>{Be(1),Ee(ne)},[_,L,D,se,E]),o.useEffect(()=>{Ee(ne)},[ne]);const ft=async()=>{const u="export-quotations";w.loading({key:u,content:"Preparing CSVâ€¦",duration:0});try{const p=H?await Ke():h,R=pt(p);if(!R.length){w.info({key:u,content:"No rows to export for current filters"});return}const T=[{key:"ts",label:"Timestamp"},{key:"serialNo",label:"Quotation No"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"executive",label:"Executive"},{key:"mode",label:"Mode"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"price",label:"On-Road Price"},{key:"status",label:"Status"},{key:"RemarkLevel",label:"Remark Level"},{key:"RemarkText",label:"Remark"}],j=R.map(s=>({ts:s.ts,serialNo:s.serialNo,name:s.name,mobile:s.mobile,branch:s.branch,executive:s.executive,mode:s.mode,company:s.company,model:s.model,variant:s.variant,price:s.price,status:s.status,RemarkLevel:s.RemarkLevel||s._remarkLevel,RemarkText:s.RemarkText||s._remarkText}));Gt({filename:"quotations.csv",headers:T,rows:j}),w.success({key:u,content:`Exported ${j.length} quotations`})}catch{w.error({key:u,content:"Export failed. Please try again."})}},At=u=>{const p=String(u||"").toLowerCase();return p==="converted"||p==="booked"||p==="completed"?"green":p==="pending"?"orange":p==="not_interested"?"default":p==="unreachable"?"volcano":p==="wrong_number"?"magenta":p==="purchased_elsewhere"?"geekblue":p==="no_response"?"gold":"default"},Tt=u=>{const p=String(u||"").trim();return p?p.toLowerCase()==="converted"?"Booked":p.replace(/_/g," "):"â€”"},kt=u=>{const p=Pe().format("DD-MM-YYYY HH:mm"),R=String(u||"").trim();return R?`${p} - ${R}`:p},it={display:"flex",flexDirection:"column",gap:2,lineHeight:1},ct={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},dt={...ct,fontSize:8},Xe={...ct,fontSize:10},qe={...ct,fontSize:9,lineHeight:1.1},vt={display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:S?3:4,overflow:"hidden",whiteSpace:"normal",fontSize:6,lineHeight:1},et=[{title:"Time / Branch",key:"timeBranch",width:120,render:(u,p)=>e.jsxs("div",{style:it,children:[e.jsx("div",{style:Xe,children:Ga(p.ts)}),e.jsx("div",{style:Xe,children:e.jsx(us,{type:"secondary",style:{fontSize:"inherit"},children:p.branch||"â€”"})})]})},{title:"Customer / Mobile",key:"customerMobile",width:100,render:(u,p)=>e.jsxs("div",{style:it,children:[e.jsx("div",{style:Xe,children:p.name||"â€”"}),e.jsx("div",{style:Xe,children:e.jsx(us,{type:"secondary",style:{fontSize:"inherit"},children:p.mobile||"â€”"})})]})},{title:"Offerings",key:"offerings",width:280,render:(u,p)=>{const R=qa({payload:p.payload,baseOfferings:p.offeringsBase,fallbackText:p.offerings}),T=R.vehicles.length,j=e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,minWidth:360,maxWidth:520},children:[e.jsx("div",{style:{fontSize:13,fontWeight:800,color:"#1d4ed8"},children:T?`${T} Vehicle Offer${T>1?"s":""}`:"Offer Details"}),R.vehicles.length?R.vehicles.map(s=>e.jsxs("div",{style:{border:"1px solid #dbeafe",borderRadius:10,padding:8,background:"#f8fbff"},children:[e.jsx("div",{style:{fontSize:11,fontWeight:800,color:"#1e3a8a",textTransform:"uppercase",marginBottom:4},children:s.label}),e.jsx("div",{style:{fontSize:12,fontWeight:700,color:"#111827",marginBottom:4},children:s.title}),e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",fontSize:12,color:"#1f2937"},children:[e.jsxs("span",{children:[e.jsx("b",{children:"Price"}),": ",s.priceText]}),s.showFinance?e.jsxs("span",{children:[e.jsx("b",{children:"DP"}),": ",s.dpText]}):null]}),s.showFinance&&s.emiText?e.jsx("div",{style:{marginTop:4,fontSize:11,color:"#334155",lineHeight:1.3},children:s.emiText}):null,s.fittings.length?e.jsxs("div",{style:{marginTop:4,fontSize:11,color:"#334155",lineHeight:1.3},children:[e.jsx("b",{children:"Fittings"}),": ",s.fittings.join(", ")]}):null]},s.label)):e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:"No vehicle-wise offer added."})]});return e.jsx("div",{style:it,children:T?e.jsx(Ks,{content:j,trigger:["hover","click"],placement:"topLeft",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:4},children:R.vehicles.map(s=>e.jsxs("div",{style:{...ct,fontSize:10.5,color:"#1f2937"},children:[e.jsxs("span",{style:{fontWeight:800,color:"#1d4ed8"},children:[s.label,":"]})," ",s.title]},s.label))})}):e.jsx("div",{style:vt,children:"No offering details"})})}},{title:"Status / Follow-up Notes",key:"statusNotes",width:150,render:(u,p)=>{const R=String(p.followUpNotes||"").trim();return e.jsxs("div",{style:it,children:[e.jsx("div",{style:ct,children:e.jsx(he,{color:At(p.status),children:Tt(p.status)})}),R?e.jsx(Ct,{title:e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:R}),placement:"topLeft",children:e.jsx("div",{style:dt,children:R})}):e.jsx("div",{style:dt})]})}},{title:"Mode / Executive",key:"vehicleMeta",width:120,render:(u,p)=>{const R=String(p.mode||"").trim().toUpperCase(),j=[String(p.executive||"").trim()||"â€”"].join(" || ");return e.jsxs("div",{style:it,children:[e.jsx("div",{style:{...qe,fontSize:10,fontWeight:700},children:R||"â€”"}),e.jsx("div",{style:qe,children:j})]})}}];["backend","admin","owner"].includes(Z)&&et.push({title:"Remarks / Remark Text",key:"remarks",width:240,render:(u,p)=>{const R=l[p.serialNo],T=String(R?.text||""),j=R?.level==="alert"?"red":R?.level==="warning"?"gold":R?.level==="ok"?"green":"default";return e.jsxs("div",{style:it,children:[e.jsx("div",{style:ct,children:e.jsxs(ue,{size:6,children:[e.jsx(he,{color:j,children:R?.level?R.level.toUpperCase():"â€”"}),e.jsx(q,{size:"small",onClick:()=>U({open:!0,refId:p.serialNo,level:R?.level||"ok",text:R?.text||""}),children:"Remark"})]})}),e.jsx(Ct,{title:T?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:T}):null,children:e.jsx("div",{style:ct,children:T||"â€”"})})]})}});const We=H?Ae:h.length,Ve=S?420:600,ut=H?Fe:de==="loadMore"?Fe.slice(0,De):Fe,It=o.useMemo(()=>{const u=(H?W:Fe)||[],p=new Map;return u.forEach(R=>{const T=String(R.branch||"Unknown").trim()||"Unknown",j=ee(T);p.has(j)||p.set(j,{key:j,branch:T,total:0});const s=p.get(j);s.total+=1}),Array.from(p.values()).sort((R,T)=>T.total-R.total)},[H,W,Fe]);return e.jsxs("div",{style:{paddingTop:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxs(ue,{wrap:!0,children:[e.jsx(pe,{value:_,onChange:le,style:{minWidth:120},disabled:!["owner","admin","backend"].includes(Z),options:Rt.map(u=>({value:u,label:u==="all"?"All Branches":u}))}),e.jsx(pe,{value:L,onChange:Q,style:{minWidth:100},options:Nt.map(u=>({value:u,label:u==="all"?"All Modes":String(u).toUpperCase()}))}),e.jsx(pe,{value:D,onChange:fe,style:{minWidth:100},options:Lt.map(u=>({value:u,label:u==="all"?"All Statuses":Tt(u)}))}),e.jsx(fs.RangePicker,{value:E,onChange:u=>{te(u),me(null)},allowClear:!0}),e.jsx(q,{size:"small",type:ve==="today"?"primary":"default",onClick:()=>{const u=Pe();te([u,u]),me("today")},children:"Today"}),e.jsx(q,{size:"small",type:ve==="yesterday"?"primary":"default",onClick:()=>{const u=Pe().subtract(1,"day");te([u,u]),me("yesterday")},children:"Yesterday"}),e.jsx(q,{size:"small",onClick:()=>{te(null),me(null)},children:"Clear"}),e.jsx(X,{placeholder:"Search name/mobile/quotation/company/model",allowClear:!0,value:ye,onChange:u=>Le(u.target.value),style:{minWidth:150}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(ue,{children:[e.jsx(q,{type:"primary",onClick:()=>d("/quotation"),children:"Quotation"}),e.jsxs(he,{color:"blue",children:["Total: ",We]}),e.jsxs(he,{color:"geekblue",children:["Showing: ",H||de==="loadMore"?ut.length:Fe.length]}),!H&&e.jsx(pe,{size:"small",value:de,onChange:u=>{Ie(u),Ee(ne)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(q,{onClick:ft,children:"Export CSV"}),e.jsx(q,{loading:P,onClick:()=>{const u=new Event("reload-quotations");window.dispatchEvent(u)},children:"Refresh"})]})]}),e.jsxs(Pt,{gutter:[12,12],style:{marginBottom:12},children:[$?e.jsx(ae,{xs:24,children:e.jsx(he,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,It.map(u=>e.jsx(ae,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ys,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:u.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:u.total})]})})},u.key))]}),e.jsx(Bt,{dataSource:ut,columns:et,loading:P&&!i,size:"small",className:"compact-table",scroll:S?{x:"max-content",y:Ve}:{y:Ve},tableLayout:S?"auto":"fixed",pagination:H?{current:je,pageSize:ne,total:We,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(u,p)=>{Be(u),p!==ne&&ze(p)},showTotal:(u,p)=>`${p[0]}-${p[1]} of ${u}`}:de==="pagination"?{current:je,pageSize:ne,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(u,p)=>{Be(u),p!==ne&&ze(p)},showTotal:(u,p)=>`${p[0]}-${p[1]} of ${u}`}:!1,rowKey:u=>`${u.serialNo}-${u.mobile}-${u.ts}-${u.key}`}),!H&&de==="loadMore"&&ut.length<Fe.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(q,{onClick:()=>Ee(u=>Math.min(u+ne,Fe.length)),children:["Load more (",Fe.length-ut.length," more)"]})}):null,e.jsx(rt,{open:c.open,title:`Update Remark: ${c.refId}`,onCancel:()=>U({open:!1,refId:"",level:"ok",text:""}),onOk:()=>{const{refId:u,level:p,text:R}=c,T=kt(R),j=l[u],s=h.find(r=>r.serialNo===u);v(r=>({...r,[u]:{level:p,text:T}})),O(r=>r.map(f=>f.serialNo===u?{...f,RemarkLevel:p.toUpperCase(),RemarkText:T,_remarkLevel:p,_remarkText:T}:f)),U({open:!1,refId:"",level:"ok",text:""}),(async()=>{try{const f=await ot({webhookUrl:Wa,method:"POST",payload:Ds?{action:"remark",serialNo:u,level:p,text:T,secret:Ds}:{action:"remark",serialNo:u,level:p,text:T}}),y=f?.data||f;if(!(y&&(y.ok||y.success)))throw new Error("Save failed");w.success("Remark saved to sheet")}catch{v(r=>{const f={...r};return j?f[u]=j:delete f[u],f}),s&&O(r=>r.map(f=>f.serialNo===u?s:f)),w.error("Save failed")}})()},children:e.jsxs(ue,{direction:"vertical",style:{width:"100%"},children:[e.jsx(pe,{value:c.level,onChange:u=>U(p=>({...p,level:u})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(X,{maxLength:140,showCount:!0,value:c.text,onChange:u=>U(p=>({...p,text:u.target.value})),placeholder:"Short note (optional)"})]})})]})}function Ga(n){if(!n)return e.jsx(us,{type:"secondary",children:"â€”"});try{const S=ms(n);return S?Pe(S).format("DD-MM-YYYY HH:mm"):String(n)}catch{return String(n)}}function ms(n){if(!n)return null;if(n instanceof Date)return n.getTime();if(typeof n=="number")return n;const S=String(n).trim(),d=new Date(S);if(!isNaN(d.getTime()))return d.getTime();const h=S.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(h){const O=h[2];let P=parseInt(h[1],10),I=parseInt(h[3],10),$=parseInt(h[4],10);$<100&&($+=2e3);let A,W;O==="-"||P>12?(W=P,A=I-1):(A=P-1,W=I);let x=h[5]?parseInt(h[5],10):0;const _=h[6]?parseInt(h[6],10):0,le=h[7]?parseInt(h[7],10):0,L=(h[8]||"").toUpperCase();L==="PM"&&x<12&&(x+=12),L==="AM"&&x===12&&(x=0);const Q=new Date($,A,W,x,_,le);if(!isNaN(Q.getTime()))return Q.getTime()}return null}const Ka="https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",Wa=Ka,Ds="",Ha="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",jt=Ha,ht="",{Text:hs}=Zt,st={ts:["Timestamp","Time","Date"],name:["Customer Name","Customer","Name","Customer_Name"],mobile:["Mobile","Phone","Mobile Number"],branch:["Branch"],executive:["Executive"],jcNo:["JC No.","JC No","Job Card No","JobCard No","JCNumber"],regNo:["Vehicle No","Vehicle_No","Registration Number","RegNo","Reg No"],model:["Model","Bike Model"],serviceType:["Service Type","Service","Service_Type"],vehicleType:["Vehicle Type","Type of Vehicle","Vehicle_Type"],amount:["Service Amount","Collected Amount","Collected_Amount","Amount"],paymentMode:["Payment Mode","Mode of Payment","Payment_Mode","paymentMode"],payload:["Payload"]},nt=(n,S)=>String(S.map(d=>n?.[d]??"").find(d=>d!=="")||"").trim();function An(){const S=!Ut.useBreakpoint().md,d=Vs(),[h,O]=o.useState([]),[P,I]=o.useState(!1),[$,A]=o.useState(!1),[W,x]=o.useState([]),[_,le]=o.useState("all"),[L,Q]=o.useState("all"),[D,fe]=o.useState("all"),[ye,Le]=o.useState(""),se=gs(ye,300),[E,te]=o.useState(()=>[Pe().startOf("month"),Pe()]),[ve,me]=o.useState(null),[Z,Re]=o.useState(""),[ie,Se]=o.useState([]),[je,Be]=o.useState(1),[ne,ze]=o.useState(25),[de,Ie]=o.useState("pagination"),[De,Ee]=o.useState(25),[Ae,$e]=o.useState(0),H="true".toLowerCase()==="true",[l,v]=o.useState({}),[c,U]=o.useState({open:!1,refId:"",level:"ok",text:""}),[i,M]=o.useState(!1),[B,Ce]=o.useState([]),_e=o.useRef(null),[Ue,ke]=o.useState(!1),[lt,Rt]=o.useState(null),[Nt,Lt]=o.useState(null),pt=s=>{if(!s)return;const r=String(s?.mobile||"").replace(/\D/g,"").slice(-10),f=String(s?.jcNo||s?.serialNo||"").trim(),y=new URLSearchParams;y.set("autoFetch","1"),r?(y.set("mode","mobile"),y.set("query",r)):f&&(y.set("mode","jc"),y.set("query",f)),f&&y.set("jcNo",f);const b=y.toString();d(b?`/jobcard?${b}`:"/jobcard")};o.useEffect(()=>{try{const s=localStorage.getItem("user");if(!s)return;const r=JSON.parse(s);Re(String(r?.role||"").toLowerCase());const f=[],y=r?.formDefaults?.branchName||r?.primaryBranch?.name||"";y&&f.push(y),Array.isArray(r?.branches)&&r.branches.forEach(b=>{const C=typeof b=="string"?b:b?.name||"";C&&f.push(C)}),Se(Array.from(new Set(f.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(Z)&&ie.length&&_==="all"&&le(ie[0])},[Z,ie,_]);const Ke=(()=>{const s=E&&E[0]?E[0].startOf("day").valueOf():"",r=E&&E[1]?E[1].endOf("day").valueOf():"";return`Jobcards:list:${JSON.stringify({branchFilter:_,serviceFilter:L,statusFilter:D,q:se||"",start:s,end:r,page:je,pageSize:ne,USE_SERVER_PAG:H})}`})(),Fe=o.useCallback((s,r=0)=>{const f=s&&s.values?s.values:s,y=s&&s.payload?s.payload:(f?f[st.payload[0]]:void 0)||"";let b=null;try{b=typeof y=="object"?y:JSON.parse(String(y||"{}"))}catch{b=null}const C=b&&b.formValues?b.formValues:{},G=C.company||"",z=C.model||nt(f,st.model),ce=C.regNo||nt(f,st.regNo),Y=(()=>{const gt=b?.totals?.grand;return gt!=null&&gt!==""?String(gt):String(nt(f,st.amount)||"")})(),re=(()=>{const gt=nt(f,st.paymentMode);return String(gt||b?.paymentMode||"")})(),Te=b&&b.postServiceAt||f&&(f.Post_Service_At||f["Post Service At"])||"",we=(()=>{const gt=String(Te||"").trim().length>0,Xt=Array.isArray(b?.payments)&&b.payments.some(Mt=>Number(Mt?.amount||0)>0);if(gt||Xt)return"completed";const Kt=String(re||"").trim().length>0,_t=String(Y||"").trim().length>0;return Kt&&_t?"completed":"pending"})(),ge=b?.remark?.level||f?.RemarkLevel||f?.["Remark Level"]||"",Ne=b?.remark?.text||f?.RemarkText||f?.["Remark Text"]||"",Ge=String(ge||"").toLowerCase(),at=C.serviceType||C.service||nt(f,st.serviceType),yt=String(C.km||f?.KM||f?.["Odometer Reading"]||"").replace(/\D/g,""),Et=b?.savedAt||b?.createdAt||b?.ts||b?.timestamp||C?.savedAt||C?.createdAt||C?.timestamp||nt(f,st.ts);return{key:r,ts:Et,tsMs:ps(Et),name:C.name||nt(f,st.name),mobile:C.mobile||nt(f,st.mobile),branch:C.branch||nt(f,st.branch),executive:C.executive||nt(f,st.executive),jcNo:C.jcNo||nt(f,st.jcNo),regNo:ce,model:z,company:G,serviceType:at||"",vehicleType:C.vehicleType||nt(f,st.vehicleType),amount:Y,km:yt,paymentMode:re,postAt:Te,status:we,RemarkLevel:ge||"",RemarkText:Ne||"",_remarkLevel:Ge,_remarkText:Ne||"",payload:b,_raw:s}},[]),ft=s=>{if(!s)return null;if(s.payload&&typeof s.payload=="object")return s.payload;const r=s.payload||s.Payload||s.PAYLOAD||s?.values?.Payload||s?.values?.payload||s?.values?.PAYLOAD||s?._raw?.payload||s?._raw?.Payload||s?._raw?.PAYLOAD||s?._raw?.values?.Payload||s?._raw?.values?.payload||s?._raw?.values?.PAYLOAD||"";if(r&&typeof r=="object")return r;if(r&&typeof r=="string")try{return JSON.parse(r)}catch{return null}return s.formValues||s.values?s:null},At=(s,r)=>{if(!s)return null;const f=s.formValues||s.values||{},y=Array.isArray(s.labourRows)?s.labourRows:Array.isArray(f.labourRows)?f.labourRows:[],b=s.totals||f.totals||{},C=y.reduce((ce,Y)=>ce+Number(Y?.qty||0)*Number(Y?.rate||0),0),G={labourSub:b.labourSub??C,labourGST:b.labourGST??0,labourDisc:b.labourDisc??0,grand:b.grand??C},z=s.postServiceAt||s.createdAt||s.savedAt||r?.postAt||r?.ts||new Date;return{vals:{jcNo:r?.jcNo||f.jcNo||"",regNo:r?.regNo||f.regNo||"",custName:r?.name||f.custName||f.name||"",custMobile:r?.mobile||f.custMobile||f.mobile||"",km:r?.km||f.km||"",model:r?.model||f.model||"",colour:f.colour||r?.colour||"",branch:r?.branch||f.branch||"",executive:r?.executive||f.executive||"",createdAt:z,labourRows:y,gstLabour:b.gstLabour||b.labourGST||0},totals:G}},Tt=async s=>{if(!s)return;if(String(s.status||"").toLowerCase()!=="completed"){w.warning("Complete post-service to generate the service invoice.");return}const f=s.jcNo||s.key||s.mobile||"";Lt(f);try{let y=ft(s),b=y?At(y,s):null;const C=Array.isArray(b?.vals?.labourRows)&&b.vals.labourRows.length>0;if(!b||!C){const G=String(s.mobile||"").replace(/\D/g,"").slice(-10);if(G.length===10){const z={action:"search",mode:"mobile",query:G},ce=ht?{...z,secret:ht}:z,Y=await Dt({webhookUrl:jt,method:"GET",payload:ce}),re=Y?.data||Y,Te=Array.isArray(re?.rows)?re.rows:Array.isArray(re?.data)?re.data:[];if(Te.length){let we=Te[0];if(s.jcNo){const Ne=Te.find(Ge=>{const at=ft(Ge),Et=(at?.formValues||at?.values||{}).jcNo||Ge?.jcNo||Ge?.values?.["JC No"]||Ge?.values?.["JC No."]||Ge?.values?.["Job Card No"]||"";return String(Et||"").trim()===String(s.jcNo||"").trim()});Ne&&(we=Ne)}const ge=ft(we);b=ge?At(ge,s):b}}}if(!b){w.error("Could not load service invoice data.");return}Rt(b),ke(!0),setTimeout(()=>{try{Aa(_e.current)}catch{}setTimeout(()=>ke(!1),500)},50)}catch{w.error("Could not generate service invoice.")}finally{Lt(null)}};o.useEffect(()=>{try{const s=localStorage.getItem(Ke);if(!s){M(!1);return}const r=JSON.parse(s);r&&Array.isArray(r.rows)?(O(r.rows),$e(typeof r.total=="number"?r.total:r.rows.length),M(!0)):M(!1)}catch{M(!1)}},[Ke]),o.useEffect(()=>{let s=!1;const r=async()=>{I(!0);try{const y={action:"list"},b={q:se||"",branch:_!=="all"?_:"",service:L!=="all"?L:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(b.start=E[0].startOf("day").valueOf(),b.end=E[1].endOf("day").valueOf());const C=H?ht?{...y,page:je,pageSize:ne,...b,secret:ht}:{...y,page:je,pageSize:ne,...b}:ht?{...y,secret:ht}:y,G=await Dt({webhookUrl:jt,method:"GET",payload:C}),z=G?.data||G;if(!z||!z.ok&&!z.success)throw new Error("Invalid response");const Te=(Array.isArray(z.data)?z.data:Array.isArray(z.rows)?z.rows:[]).map((we,ge)=>Fe(we,ge)).filter(we=>we.jcNo||we.name||we.mobile).slice().sort((we,ge)=>(ge.tsMs||0)-(we.tsMs||0));if(!s){O(Te);const we=typeof z.total=="number"?z.total:Te.length;$e(we);const ge={};Te.forEach(Ne=>{if(!Ne.jcNo)return;const Ge=(typeof Ne._remarkLevel<"u"?Ne._remarkLevel:Ne.remarkLevel)??String(Ne.RemarkLevel||"").toLowerCase(),at=(typeof Ne._remarkText<"u"?Ne._remarkText:Ne.remarkText)??Ne.RemarkText??"";ge[Ne.jcNo]={level:Ge||"",text:at||""}}),v(ge);try{localStorage.setItem(Ke,JSON.stringify({at:Date.now(),rows:Te,total:we}))}catch{}}}catch{w.error("Could not load job cards via Apps Script. Check JOBCARD Web App URL / access."),s||(O([]),$e(0))}finally{s||I(!1)}};r();const f=()=>r();return window.addEventListener("reload-jobcards",f),()=>{s=!0,window.removeEventListener("reload-jobcards",f)}},[_,L,D,se,E,je,ne,H]);const kt=B.length?B:h,it=o.useMemo(()=>{const s=xt(kt.map(f=>f.branch));if(!["owner","admin","backend"].includes(Z)&&ie.length){const f=St(ie);return["all",...s.filter(y=>f.has(ee(y)))]}return["all",...s]},[kt,Z,ie]),ct=o.useMemo(()=>["all",...xt(kt.map(s=>s.serviceType))],[kt]),dt=o.useCallback(s=>{const r=St(ie);return(s||[]).filter(y=>{if(r.size&&!["owner","admin","backend"].includes(Z)&&!r.has(ee(y.branch))||_!=="all"&&ee(y.branch)!==ee(_)||L!=="all"&&ee(y.serviceType)!==ee(L)||D!=="all"&&ee(y.status)!==ee(D))return!1;if(E&&E[0]&&E[1]){const b=E[0].startOf("day").valueOf(),C=E[1].endOf("day").valueOf(),G=y.tsMs??ps(y.ts);if(!G||G<b||G>C)return!1}if(se){const b=se.toLowerCase();if(![y.name,y.mobile,y.jcNo,y.regNo,y.model,y.branch,y.executive,y.paymentMode,y.status].some(C=>String(C||"").toLowerCase().includes(b)))return!1}return!0}).slice().sort((y,b)=>(b.tsMs||0)-(y.tsMs||0))},[ie,_,E,se,L,D,Z]),Xe=o.useCallback(async()=>{if(!H)return h;const s=100,r={q:se||"",branch:_!=="all"?_:"",service:L!=="all"?L:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(r.start=E[0].startOf("day").valueOf(),r.end=E[1].endOf("day").valueOf());const f=[],y=new Set;let b=1,C=200,G=null;for(;b<=C;){const ce={...{action:"list",page:b,pageSize:s},...r},Y=await Dt({webhookUrl:jt,method:"GET",payload:ce}),re=Y?.data||Y;typeof re?.total=="number"&&Number.isFinite(re.total)&&(G=re.total,C=Math.ceil(re.total/s));const Te=Array.isArray(re?.data)?re.data:Array.isArray(re?.rows)?re.rows:[];if(!Te.length)break;let we=0;if(Te.forEach(ge=>{const Ge=String(ge?.values?.["JC No"]||ge?.values?.["JC No."]||ge?.values?.["Job Card No"]||ge?.jcNo||ge?.JCNo||ge?.["JC No"]||ge?.["JC No."]||"").trim()||JSON.stringify(ge);y.has(Ge)||(y.add(Ge),f.push(ge),we+=1)}),G!==null&&y.size>=G||we===0||Te.length<s)break;b+=1}return f.map((z,ce)=>Fe(z,ce)).filter(z=>z.jcNo||z.name||z.mobile)},[H,jt,ht,_,E,se,Fe,h,L,D]),qe=o.useMemo(()=>H?h:dt(h),[H,dt,h]);o.useEffect(()=>{let s=!1;return(async()=>{if(!H){x(dt(h));return}A(!0);try{const f=await Xe(),y=dt(f);s||x(y)}catch{s||x([])}finally{s||A(!1)}})(),()=>{s=!0}},[H,Xe,dt,_,L,D,se,E,Z,ie,h]),o.useEffect(()=>{Be(1),Ee(ne)},[_,L,D,se,E]),o.useEffect(()=>{Ee(ne)},[ne]);const vt=async()=>{const s="export-jobcards";w.loading({key:s,content:"Preparing CSVâ€¦",duration:0});try{const r=H?await Xe():h,f=H?r:dt(r);if(!f.length){w.info({key:s,content:"No rows to export for current filters"});return}const y=[{key:"ts",label:"Timestamp"},{key:"jcNo",label:"Job Card No"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"serviceType",label:"Service Type"},{key:"vehicleType",label:"Vehicle Type"},{key:"regNo",label:"Vehicle No"},{key:"model",label:"Model"},{key:"company",label:"Company"},{key:"amount",label:"Service Amount"},{key:"paymentMode",label:"Payment Mode"},{key:"status",label:"Status"},{key:"RemarkLevel",label:"Remark Level"},{key:"RemarkText",label:"Remark"}],b=f.map(C=>({ts:C.ts,jcNo:C.jcNo,name:C.name,mobile:C.mobile,branch:C.branch,serviceType:C.serviceType,vehicleType:C.vehicleType,regNo:C.regNo,model:C.model,company:C.company,amount:C.amount,paymentMode:C.paymentMode,status:C.status,RemarkLevel:C.RemarkLevel||C._remarkLevel,RemarkText:C.RemarkText||C._remarkText}));Gt({filename:"jobcards.csv",headers:y,rows:b}),w.success({key:s,content:`Exported ${b.length} job cards`})}catch{w.error({key:s,content:"Export failed. Please try again."})}};o.useEffect(()=>{let s=!1;return(async()=>{try{const y=await Dt({webhookUrl:jt,method:"GET",payload:ht?{action:"list",page:1,pageSize:5e3,secret:ht}:{action:"list",page:1,pageSize:5e3}}),b=y?.data||y;if(!b||!b.ok&&!b.success)return;const G=(Array.isArray(b.data)?b.data:Array.isArray(b.rows)?b.rows:[]).map((z,ce)=>Fe(z,ce));s||Ce(G)}catch{}})(),()=>{s=!0}},[]);const et={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},We={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},Ve=s=>{const r=String(s||"").toLowerCase();return r==="completed"?"green":r==="pending"?"orange":"default"},ut=s=>{const r=String(s||"").toLowerCase();return r==="completed"?"Completed":r==="pending"?"Pending":String(s||"â€”")||"â€”"},It=s=>{const r=Pe().format("DD-MM-YYYY HH:mm"),f=String(s||"").trim();return f?`${r} - ${f}`:r},u=[{title:"Time / Branch",key:"timeBranch",width:90,render:(s,r)=>e.jsxs("div",{style:et,children:[e.jsx("div",{style:We,children:Ya(r.ts)}),e.jsx("div",{style:We,children:e.jsx(hs,{type:"secondary",children:r.branch||"â€”"})})]})},{title:"Customer / Mobile",key:"customerMobile",width:100,render:(s,r)=>e.jsxs("div",{style:et,children:[e.jsx("div",{style:We,children:r.name||"â€”"}),e.jsx("div",{style:We,children:e.jsx(hs,{type:"secondary",children:r.mobile||"â€”"})})]})},{title:"Service / Status",key:"serviceStatus",width:200,render:(s,r)=>{const f=String(r.company||"").trim()||"â€”",y=String(r.model||"").trim()||"â€”",b=String(r.serviceType||"").trim()||"â€”",C=String(r.amount||"").trim()||"â€”",G=String(r.paymentMode||"").trim(),z=`${f} || ${y} || ${b} || ${C} || ${G?G.toUpperCase():"â€”"}`,ce=String(r.executive||"").trim()||"â€”",Y=String(r.regNo||"").trim()||"â€”";return e.jsxs("div",{style:et,children:[e.jsx("div",{style:We,children:z}),e.jsx("div",{style:We,children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:4},children:[e.jsx(he,{color:Ve(r.status),children:ut(r.status)}),e.jsx("span",{children:`|| ${ce} || ${Y}`})]})})]})}}];["backend","admin","owner"].includes(Z)&&u.push({title:"Remarks / Remark Text",key:"remarks",width:250,render:(s,r)=>{const f=l[r.jcNo],y=String(f?.text||""),b=String(f?.level||"").toLowerCase(),C=b==="alert"?"red":b==="warning"?"gold":b==="ok"?"green":"default",G=y||"No remark yet",z=String(r.status||"").toLowerCase(),ce=z==="completed",Y=z==="pending",re=Nt===(r.jcNo||r.key||r.mobile||"");return e.jsxs("div",{style:et,children:[e.jsx("div",{style:We,children:e.jsxs(ue,{size:6,children:[e.jsx(Ct,{title:G,children:e.jsx(he,{color:C,children:b?b.toUpperCase():"â€”"})}),e.jsx(q,{size:"small",onClick:()=>U({open:!0,refId:r.jcNo,level:f?.level||"ok",text:f?.text||""}),children:"Remark"}),ce?e.jsx(Ct,{title:"Print service invoice",children:e.jsx(q,{size:"small",type:"primary",ghost:!0,loading:re,onClick:()=>Tt(r),children:"Service Invoice"})}):e.jsx(Ct,{title:Y?"Post service":"Service not completed",children:e.jsx(q,{size:"small",type:"primary",onClick:()=>pt(r),children:"Post Service"})})]})}),e.jsx(Ct,{title:y?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:y}):null,children:e.jsx("div",{style:We,children:y||"â€”"})})]})}});const p=H?Ae:h.length,R=S?420:600,T=H?qe:de==="loadMore"?qe.slice(0,De):qe,j=o.useMemo(()=>{const s=(H?W:qe)||[],r=new Map;return s.forEach(f=>{const y=String(f.branch||"Unknown").trim()||"Unknown",b=ee(y);r.has(b)||r.set(b,{key:b,branch:y,total:0});const C=r.get(b);C.total+=1}),Array.from(r.values()).sort((f,y)=>y.total-f.total)},[H,W,qe]);return e.jsxs("div",{style:{paddingTop:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxs(ue,{wrap:!0,children:[e.jsx(pe,{value:_,onChange:le,style:{minWidth:120},disabled:!["owner","admin","backend"].includes(Z),options:it.map(s=>({value:s,label:s==="all"?"All Branches":s}))}),e.jsx(pe,{value:L,onChange:Q,style:{minWidth:100},options:ct.map(s=>({value:s,label:s==="all"?"All Services":String(s).toUpperCase()}))}),e.jsx(pe,{value:D,onChange:fe,style:{minWidth:100},options:[{value:"all",label:"All Statuses"},{value:"pending",label:"Pending"},{value:"completed",label:"Completed"}]}),e.jsx(fs.RangePicker,{value:E,onChange:s=>{te(s),me(null)},allowClear:!0}),e.jsx(q,{size:"small",type:ve==="today"?"primary":"default",onClick:()=>{const s=Pe();te([s,s]),me("today")},children:"Today"}),e.jsx(q,{size:"small",type:ve==="yesterday"?"primary":"default",onClick:()=>{const s=Pe().subtract(1,"day");te([s,s]),me("yesterday")},children:"Yesterday"}),e.jsx(q,{size:"small",onClick:()=>{te(null),me(null)},children:"Clear"}),e.jsx(X,{placeholder:"Search name/mobile/jc/vehicle/model/mode",allowClear:!0,value:ye,onChange:s=>Le(s.target.value),style:{minWidth:120}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(ue,{children:[e.jsx(q,{type:"primary",onClick:()=>d("/jobcard"),children:"Job Card"}),e.jsxs(he,{color:"blue",children:["Total: ",p]}),e.jsxs(he,{color:"geekblue",children:["Showing: ",H||de==="loadMore"?T.length:qe.length]}),!H&&e.jsx(pe,{size:"small",value:de,onChange:s=>{Ie(s),Ee(ne)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(q,{onClick:vt,children:"Export CSV"}),e.jsx(q,{loading:P,onClick:()=>{const s=new Event("reload-jobcards");window.dispatchEvent(s)},children:"Refresh"})]})]}),e.jsxs(Pt,{gutter:[12,12],style:{marginBottom:12},children:[$?e.jsx(ae,{xs:24,children:e.jsx(he,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,j.map(s=>e.jsx(ae,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ys,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:s.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:s.total})]})})},s.key))]}),e.jsx(Bt,{dataSource:T,columns:u,loading:P&&!i,size:"small",className:"compact-table",tableLayout:S?"auto":"fixed",pagination:H?{current:je,pageSize:ne,total:p,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(s,r)=>{Be(s),r!==ne&&ze(r)},showTotal:(s,r)=>`${r[0]}-${r[1]} of ${s}`}:de==="pagination"?{current:je,pageSize:ne,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(s,r)=>{Be(s),r!==ne&&ze(r)},showTotal:(s,r)=>`${r[0]}-${r[1]} of ${s}`}:!1,rowKey:s=>`${s.jcNo}-${s.mobile}-${s.ts}-${s.key}`,scroll:S?{x:"max-content",y:R}:{y:R}}),!H&&de==="loadMore"&&T.length<qe.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(q,{onClick:()=>Ee(s=>Math.min(s+ne,qe.length)),children:["Load more (",qe.length-T.length," more)"]})}):null,e.jsx(rt,{open:c.open,title:`Update Remark: ${c.refId}`,onCancel:()=>U({open:!1,refId:"",level:"ok",text:""}),onOk:()=>{const{refId:s,level:r,text:f}=c,y=It(f),b=l[s],C=h.find(G=>G.jcNo===s);v(G=>({...G,[s]:{level:r,text:y}})),O(G=>G.map(z=>z.jcNo===s?{...z,RemarkLevel:r.toUpperCase(),RemarkText:y,_remarkLevel:r,_remarkText:y}:z)),U({open:!1,refId:"",level:"ok",text:""}),(async()=>{try{const z=await Dt({webhookUrl:jt,method:"POST",payload:ht?{action:"remark",jcNo:s,level:r,text:y,secret:ht}:{action:"remark",jcNo:s,level:r,text:y}}),ce=z?.data||z;if(!(ce&&(ce.ok||ce.success)))throw new Error("Save failed");w.success("Remark saved to sheet")}catch{v(G=>{const z={...G};return b?z[s]=b:delete z[s],z}),C&&O(G=>G.map(z=>z.jcNo===s?C:z)),w.error("Save failed")}})()},children:e.jsxs(ue,{direction:"vertical",style:{width:"100%"},children:[e.jsx(pe,{value:c.level,onChange:s=>U(r=>({...r,level:s})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(X,{maxLength:140,showCount:!0,value:c.text,onChange:s=>U(r=>({...r,text:s.target.value})),placeholder:"Short note (optional)"})]})}),e.jsx(Ra,{ref:_e,active:Ue,vals:lt?.vals||{},totals:lt?.totals||{}})]})}function Ya(n){if(!n)return e.jsx(hs,{type:"secondary",children:"â€”"});try{const S=ps(n);return S?Pe(S).format("DD-MM-YYYY HH:mm"):String(n)}catch{return String(n)}}function ps(n){if(!n)return null;if(n instanceof Date)return n.getTime();if(typeof n=="number")return n;const S=String(n).trim(),d=new Date(S);if(!isNaN(d.getTime()))return d.getTime();const h=S.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(h){const O=h[2];let P=parseInt(h[1],10),I=parseInt(h[3],10),$=parseInt(h[4],10);$<100&&($+=2e3);let A,W;O==="-"||P>12?(W=P,A=I-1):(A=P-1,W=I);let x=h[5]?parseInt(h[5],10):0;const _=h[6]?parseInt(h[6],10):0,le=h[7]?parseInt(h[7],10):0,L=(h[8]||"").toUpperCase();L==="PM"&&x<12&&(x+=12),L==="AM"&&x===12&&(x=0);const Q=new Date($,A,W,x,_,le);if(!isNaN(Q.getTime()))return Q.getTime()}return null}const{Text:Jt}=Zt,$t={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"],color:["Color","Colours","Colors","Colour","Available Colors"],price:["On-Road Price","On Road Price","OnRoadPrice","Price"]},Ja=n=>{const S=[];let d=[],h="",O=!1;for(let P=0;P<n.length;P++){const I=n[P],$=n[P+1];if(I==='"'&&!O){O=!0;continue}if(I==='"'&&O){if($==='"'){h+='"',P++;continue}O=!1;continue}if(I===","&&!O){d.push(h),h="";continue}if((I===`
`||I==="\r")&&!O){(h!==""||d.length)&&(d.push(h),S.push(d),d=[],h=""),I==="\r"&&$===`
`&&P++;continue}h+=I}return(h!==""||d.length)&&(d.push(h),S.push(d)),S},Qa=async n=>{const S=await fetch(n,{cache:"no-store"});if(!S.ok)throw new Error("Sheet fetch failed");const d=await S.text();if(d.trim().startsWith("<"))throw new Error("Expected CSV, got HTML");const h=Ja(d);if(!h.length)return[];const O=h[0].map(P=>(P||"").trim());return h.slice(1).map(P=>{const I={};return O.forEach(($,A)=>I[$]=P[A]??""),I})},Vt=(n,S)=>String(S.map(d=>n[d]??"").find(d=>d!=="")||"").trim(),$s=(n={})=>{const S=Vt(n,$t.price)||n.onRoadPrice||n.OnRoadPrice||n.onroadprice||n.price||0,d=Vt(n,$t.color)||n.color||n.colors||"",h=fe=>Number(String(fe||0).replace(/[",\sâ‚¹]/g,""))||0,O=fe=>{const ye=String(fe||"").replace(/[",\sâ‚¹]/g,"");return ye!==""&&!Number.isNaN(Number(ye))},P=Vt(n,$t.company)||n.company||"",I=Vt(n,$t.model)||n.model||"",$=Vt(n,$t.variant)||n.variant||"";let A=h(S),W=String(d||"").trim();const x=n.UpdatedAt||n.updatedAt||n.updated_at||n.updated||"",_=n.UpdatedBy||n.updatedBy||n.updated_by||n.user||"",le=fe=>String(fe||"").includes("|");let L=x,Q=_;return!O(S)&&O(d)&&A===0&&(A=h(d),W="",!_&&le(S)&&(Q=x)),{id:n.id||n._id||n.rowId||n._row||void 0,company:P,model:I,variant:$,color:W,onRoadPrice:A,updatedAt:L,updatedBy:Q}};function Tn({csvFallbackUrl:n}){const d=!Ut.useBreakpoint().md,h="https://script.google.com/macros/s/AKfycbw0zvptYU-X0yBRFytBJZeli0Dr-uOBFDSfpYgQeWv7nKMWXD73piVndyyTiARU0FL-Lg/exec",[O,P]=o.useState([]),[I,$]=o.useState(!1),[A,W]=o.useState(!1),[x,_]=o.useState(null),[le,L]=o.useState(!1),[Q]=K.useForm(),[D,fe]=o.useState(!1),[ye,Le]=o.useState(""),[se,E]=o.useState("all"),[te,ve]=o.useState(""),[me,Z]=o.useState(1),[Re,ie]=o.useState(25),Se=i=>String(i||"").trim().toLowerCase(),je=i=>`${String(i.company||"").trim().toUpperCase()}|${String(i.model||"").trim().toUpperCase()}|${String(i.variant||"").trim().toUpperCase()}`,Be=async()=>{const i=`${h}?action=list`,M=await fetch(i,{method:"GET",mode:"cors",credentials:"omit"});if(!M.ok)throw new Error("Failed to fetch catalog");return M.json()},ne=async i=>{const M=new URLSearchParams({action:"upsert",...i}),B=await fetch(h,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},body:M});if(!B.ok)throw new Error("Save failed");return B.json()},ze=async i=>{const M=new URLSearchParams({action:"delete",...i}),B=await fetch(h,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},body:M});if(!B.ok)throw new Error("Delete failed");return B.json()},de=async()=>{$(!0),fe(!1);try{const i=await Be(),M=i?.data||i?.items||i?.rows||i||[],B=Array.isArray(M)?M.map($s).filter(Ce=>Ce.company&&Ce.model&&Ce.variant):[];P(B),i?.ok===!1&&/catalog gas url/i.test(String(i?.message||""))&&fe(!0)}catch{if(n)try{const M=(await Qa(n)).map($s).filter(B=>B.company&&B.model&&B.variant);P(M),fe(!0)}catch{P([])}else P([])}finally{$(!1)}};o.useEffect(()=>{de()},[]);const Ie=()=>{_(null),Q.resetFields(),L(!0)},De=i=>{_(i),Q.setFieldsValue({company:i.company,model:i.model,variant:i.variant,color:i.color,onRoadPrice:i.onRoadPrice}),L(!0)},Ee=async i=>{try{W(!0);const B={id:i.id||i.rowId||void 0,company:i.company,model:i.model,variant:i.variant},Ce=await ze(B);if(!((Ce?.success??Ce?.ok??!0)!==!1))throw new Error(Ce?.message||"Delete failed");w.success("Vehicle deleted"),await de()}catch(M){w.error(M?.message||"Could not delete vehicle")}finally{W(!1)}},Ae=o.useMemo(()=>{const i=ye.trim().toLowerCase(),M=te.trim().toLowerCase();return O.filter(B=>{const Ce=!i||[B.company,B.model,B.variant,B.color,B.updatedBy].some(ke=>String(ke||"").toLowerCase().includes(i)),_e=se==="all"||Se(B.company)===se,Ue=!M||Se(B.variant).includes(M);return Ce&&_e&&Ue})},[O,ye,se,te]),$e=o.useMemo(()=>`vc-${se}-${te}-${ye}`,[se,te,ye]);o.useEffect(()=>{Z(1)},[se,te,ye]);const H=o.useMemo(()=>{const i=Ae.length,M=Ae.reduce((Ue,ke)=>Ue+(Number(ke.onRoadPrice)||0),0),B=i?Math.round(M/i):0,Ce=new Set(Ae.map(Ue=>Se(Ue.company))),_e=new Set(Ae.map(Ue=>Se(Ue.variant)));return{count:i,totalPrice:M,avgPrice:B,companyCount:Ce.size,variantCount:_e.size}},[Ae,Se]),l=o.useMemo(()=>{const i=new Set(O.map(M=>Se(M.company)).filter(Boolean));return Array.from(i).map(M=>({value:M,label:(M||"").toUpperCase()})).sort((M,B)=>M.label.localeCompare(B.label))},[O]),v=async()=>{try{const i=await Q.validateFields();["company","model","variant"].forEach(ke=>{i[ke]&&(i[ke]=String(i[ke]).toUpperCase())}),i.color&&(i.color=String(i.color).toUpperCase().trim());const M=je(i);if(O.find(ke=>je(ke)===M&&String(ke.id||"")!==String(x?.id||""))){w.error("Duplicate vehicle: same Company + Model + Variant already exists");return}W(!0);const Ce={...i,onRoadPrice:Number(i.onRoadPrice||0)||0,id:x?.id,updatedBy:(()=>{try{const ke=JSON.parse(localStorage.getItem("user")||"null");return ke?.name||ke?.email||""}catch{return""}})(),action:"upsert"},_e=await ne(Ce);if(!((_e?.success??_e?.ok??!0)!==!1))throw new Error(_e?.message||"Save failed");w.success(x?"Vehicle updated":"Vehicle added"),L(!1),_(null),await de()}catch(i){if(i?.errorFields)return;w.error(i?.message||"Could not save vehicle")}finally{W(!1)}},c=o.useMemo(()=>[{title:"Company",dataIndex:"company",key:"company",sorter:(i,M)=>i.company.localeCompare(M.company)},{title:"Model",dataIndex:"model",key:"model",sorter:(i,M)=>i.model.localeCompare(M.model)},{title:"Variant",dataIndex:"variant",key:"variant",sorter:(i,M)=>i.variant.localeCompare(M.variant)},{title:"Colors",dataIndex:"color",key:"color",render:i=>i||e.jsx(Jt,{type:"secondary",children:"-"})},{title:"On-Road Price (â‚¹)",dataIndex:"onRoadPrice",key:"onRoadPrice",render:i=>i?i.toLocaleString("en-IN"):e.jsx(Jt,{type:"secondary",children:"0"}),sorter:(i,M)=>(i.onRoadPrice||0)-(M.onRoadPrice||0)},{title:"Updated At",dataIndex:"updatedAt",key:"updatedAt",render:i=>i?Pe(i).format("DD-MM-YYYY HH:mm"):e.jsx(Jt,{type:"secondary",children:"-"})},{title:"Updated By",dataIndex:"updatedBy",key:"updatedBy",render:i=>i||e.jsx(Jt,{type:"secondary",children:"-"})},{title:"Actions",key:"actions",render:(i,M)=>e.jsxs(ue,{children:[e.jsx(q,{size:"small",icon:e.jsx(La,{}),onClick:()=>De(M),disabled:A||D,children:"Edit"}),e.jsx(ba,{title:"Delete this vehicle?",onConfirm:()=>Ee(M),disabled:A||D,children:e.jsx(q,{size:"small",danger:!0,disabled:A||D,children:"Delete"})})]})}],[A,D]),U=()=>{if(!Ae.length){w.info("No catalog rows to export for current filters");return}const i=[{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"color",label:"Color"},{key:"onRoadPrice",label:"On-Road Price"},{key:"updatedAt",label:"Updated At"},{key:"updatedBy",label:"Updated By"}],M=Ae.map(B=>({company:B.company,model:B.model,variant:B.variant,color:B.color,onRoadPrice:B.onRoadPrice,updatedAt:B.updatedAt,updatedBy:B.updatedBy}));Gt({filename:"vehicle-catalog.csv",headers:i,rows:M}),w.success(`Exported ${M.length} vehicles`)};return e.jsxs("div",{style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:16},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(120deg,#2563eb0d,#2563eb1f)",border:"1px solid #dbeafe"},children:[e.jsx("div",{style:{fontSize:12,color:"#2563eb"},children:"Records"}),e.jsx("div",{style:{fontSize:22,fontWeight:700},children:H.count.toLocaleString("en-IN")}),e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:"Filtered vehicles"})]}),e.jsxs("div",{style:{padding:12,borderRadius:10,background:"#f8fafc",border:"1px solid #e2e8f0"},children:[e.jsx("div",{style:{fontSize:12,color:"#0f172a"},children:"Mix"}),e.jsxs("div",{style:{fontSize:14,fontWeight:600},children:[H.companyCount," brands â€¢ ",H.variantCount," variants"]}),e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:se!=="all"?`Filtered: ${se.toUpperCase()}`:"All brands"})]})]}),e.jsxs(ue,{style:{marginBottom:12,flexWrap:"wrap",width:"100%",justifyContent:"space-between"},children:[e.jsxs(ue,{wrap:!0,children:[e.jsx(q,{type:"primary",icon:e.jsx(qs,{}),onClick:Ie,disabled:D,children:"Add Vehicle"}),e.jsx(q,{icon:e.jsx(ja,{}),onClick:de,loading:I,children:"Reload"}),e.jsx(q,{onClick:U,children:"Export CSV"}),D&&e.jsx(he,{color:"red",children:"Save disabled (configure VEHICLE_CATALOG_GAS_URL)"})]}),e.jsxs(ue,{wrap:!0,children:[e.jsx(X,{placeholder:"Search company/model/variant/color/user",allowClear:!0,value:ye,onChange:i=>Le(i.target.value),style:{maxWidth:260}}),e.jsx(X,{placeholder:"Filter variant",allowClear:!0,value:te,onChange:i=>ve(i.target.value),style:{maxWidth:160}}),e.jsx(pe,{value:se,onChange:i=>E(i===void 0?"all":Se(i)),style:{minWidth:140},options:[{value:"all",label:"All Companies"},...l],showSearch:!0,optionFilterProp:"label",allowClear:!1})]})]}),D&&e.jsx(ya,{showIcon:!0,type:"warning",style:{marginBottom:12},message:"Catalog GAS URL not configured",description:"Listing works from the published CSV, but saving/updating requires VEHICLE_CATALOG_GAS_URL in the environment."}),e.jsxs("div",{style:{marginBottom:12,fontSize:12,color:"#475569"},children:["Showing ",Ae.length.toLocaleString("en-IN")," of ",O.length.toLocaleString("en-IN")," catalog records."]}),e.jsx(Bt,{columns:c,dataSource:Ae,loading:I,rowKey:i=>i.id||je(i),tableLayout:d?"auto":"fixed",scroll:d?{x:"max-content"}:void 0,pagination:{current:me,pageSize:Re,total:Ae.length,showSizeChanger:!0,showQuickJumper:!0,pageSizeOptions:["10","25","50","100","200"],onChange:(i,M)=>{Z(i),ie(M)},showTotal:(i,M)=>`${M[0]}-${M[1]} of ${i}`},size:d?"small":"middle"},$e),e.jsx(rt,{open:le,title:x?"Edit Vehicle":"Add Vehicle",onCancel:()=>{L(!1),_(null)},onOk:v,okButtonProps:{loading:A},destroyOnClose:!0,children:e.jsxs(K,{form:Q,layout:"vertical",children:[e.jsx(K.Item,{name:"company",label:"Company",rules:[{required:!0,message:"Enter company"}],children:e.jsx(X,{placeholder:"e.g., HONDA",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>Q.setFieldsValue({company:(i.target.value||"").toUpperCase()})})}),e.jsx(K.Item,{name:"model",label:"Model",rules:[{required:!0,message:"Enter model"}],children:e.jsx(X,{placeholder:"e.g., SHINE",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>Q.setFieldsValue({model:(i.target.value||"").toUpperCase()})})}),e.jsx(K.Item,{name:"variant",label:"Variant",rules:[{required:!0,message:"Enter variant"}],children:e.jsx(X,{placeholder:"e.g., DISC",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>Q.setFieldsValue({variant:(i.target.value||"").toUpperCase()})})}),e.jsx(K.Item,{name:"color",label:"Colors (comma-separated)",children:e.jsx(X,{placeholder:"e.g., RED, BLACK, BLUE",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>Q.setFieldsValue({color:(i.target.value||"").toUpperCase()})})}),e.jsx(K.Item,{name:"onRoadPrice",label:"On-Road Price (â‚¹)",rules:[{required:!0,message:"Enter price"}],children:e.jsx(Ia,{style:{width:"100%"},min:0,step:500,parser:i=>Number((i||"").toString().replace(/[^\d.-]/g,"")),formatter:i=>i?Number(i).toLocaleString("en-IN"):""})})]})})]})}export{Cn as B,An as J,Rn as Q,jn as U,Tn as V,wn as a};
