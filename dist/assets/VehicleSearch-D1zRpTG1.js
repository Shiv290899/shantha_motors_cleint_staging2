import{r as c,j as t,u as Gt}from"./index-DByWGH7d.js";import{u as qt,B as Jt,c as ht,f as Yt}from"./BookingForm-DWuipBFi.js";import{d as Zt,l as Qt,u as W,t as C,n as x,m as Xt,D as eo,A as to,s as oo,a as Pe}from"./caseInsensitive-GFj-Zur4.js";import{e as St}from"./StockUpdate-D0yZO869.js";import{G as xt}from"./index-CINaf3Eu.js";import{F as H}from"./index-fiQTrVnU.js";import{S as F}from"./index-DlPElhKY.js";import{S as O,R as We,E as pt}from"./index-C2v3hDcT.js";import{I as be,s as A}from"./index-mc3XMWnF.js";import{B as L}from"./button-BmMOSO5i.js";import{T as X}from"./index-DMDeWAJZ.js";import{F as so}from"./Table-g31uHPfu.js";import{M as $e}from"./index-BSIb012r.js";import{L as Ee,d as Ct}from"./index-53S8uf0A.js";import{P as ao,h as no}from"./PostServiceSheet-CYx6JQNX.js";import{C as He}from"./index-BP3wDuv0.js";import{z as ro,A as ft}from"./TextArea-BDVSLBQS.js";import{D as lo}from"./index-CKg7-Gtk.js";import{T as io}from"./index-CBM7Jb_H.js";function Uo(){const l=!xt.useBreakpoint().md,[s,m]=c.useState(!1),[f,J]=c.useState([]),[N,D]=c.useState(!1),[Y,w]=c.useState([]),[k,K]=c.useState("all"),[Z,ee]=c.useState(""),[_,Se]=c.useState([]),[,je]=c.useState([]),[,ke]=c.useState([]),[E,xe]=c.useState([]),[v,G]=c.useState([]),[Q,me]=c.useState([]),[te,ne]=c.useState([]),[ue,Me]=c.useState([]),[Fe,Ne]=c.useState(1),[n,i]=c.useState(25),u=c.useMemo(()=>`InStock:list:${k||"all"}`,[k]),[d,p]=c.useState(!1),[I,$]=c.useState(null),[P,T]=c.useState(null),[U,M]=c.useState(!1),[R,oe]=c.useState(null),[he,re]=c.useState(!1),[se]=H.useForm(),[jt,Je]=c.useState(!1),[ae,Ye]=c.useState(null),[V,Ze]=c.useState(null),[kt,Qe]=c.useState(!1),[Ae]=H.useForm(),Mt="https://docs.google.com/spreadsheets/d/e/2PACX-1vQYGuNPY_2ivfS7MTX4bWiu1DWdF2mrHSCnmTznZVEHxNmsrgcGWjVZN4UDUTOzQQdXTnbeM-ylCJbB/pub?gid=408799621&single=true&output=csv",Ie={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"],color:["Color","Colours","Colors","Colour","Available Colors"]},Te=(e,o)=>String(o.map(a=>e[a]??"").find(a=>a!=="")||"").trim(),Nt=e=>e?String(e).split(/[|,/;\n]+/).map(o=>o.trim()).filter(Boolean):[],At=(e={})=>({company:Te(e,Ie.company),model:Te(e,Ie.model),variant:Te(e,Ie.variant),color:Te(e,Ie.color)}),It=e=>{const o=[];let a=[],r="",h=!1;for(let y=0;y<e.length;y++){const g=e[y],B=e[y+1];if(g==='"'&&!h){h=!0;continue}if(g==='"'&&h){if(B==='"'){r+='"',y++;continue}h=!1;continue}if(g===","&&!h){a.push(r),r="";continue}if((g===`
`||g==="\r")&&!h){(r!==""||a.length)&&(a.push(r),o.push(a),a=[],r=""),g==="\r"&&B===`
`&&y++;continue}r+=g}return(r!==""||a.length)&&(a.push(r),o.push(a)),o},Tt=async e=>{const o=await fetch(e,{cache:"no-store"});if(!o.ok)throw new Error("Sheet fetch failed");const a=await o.text();if(a.trim().startsWith("<"))throw new Error("Expected CSV, got HTML");const r=It(a);if(!r.length)return[];const h=r[0].map(y=>(y||"").trim());return r.slice(1).map(y=>{const g={};return h.forEach((B,q)=>g[B]=y[q]??""),g})},[le,Xe]=c.useState([]),[fe,et]=c.useState(!1),[ie,tt]=c.useState(""),[ye,Le]=c.useState(""),[De,Re]=c.useState("");c.useEffect(()=>{(async()=>{try{const o=(await Tt(Mt)).map(At).filter(a=>a.company&&a.model&&a.variant);Xe(o),et(o.length>0)}catch{Xe([]),et(!1)}})()},[]);const Rt=c.useMemo(()=>[...new Set(le.map(e=>e.company))],[le]),Bt=c.useMemo(()=>[...new Set(le.filter(e=>e.company===ie).map(e=>e.model))],[le,ie]),zt=c.useMemo(()=>[...new Set(le.filter(e=>e.company===ie&&e.model===ye).map(e=>e.variant))],[le,ie,ye]),ot=c.useMemo(()=>{const e=le.filter(a=>a.company===ie&&a.model===ye&&a.variant===De).flatMap(a=>Nt(a.color)),o=new Map;return e.forEach(a=>{const r=String(a).toLowerCase();o.has(r)||o.set(r,a)}),Array.from(o.values())},[le,ie,ye,De]),ce=c.useMemo(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}},[]),st=c.useMemo(()=>String(ce?.role||"").toLowerCase(),[ce]),at=c.useMemo(()=>["admin","owner","backend"].includes(st),[st]);c.useEffect(()=>{(async()=>{try{const o=(await Zt({limit:100,status:"active"}).catch(()=>null))?.data?.items||(await Qt({status:"active",limit:100})).data.items||[],a=W((o||[]).map(r=>r?.name));w(a)}catch{w([])}})()},[]),c.useEffect(()=>{try{const e=localStorage.getItem(u);if(!e){D(!1);return}const o=JSON.parse(e);o&&Array.isArray(o.items)?(J(o.items),D(!0)):D(!1)}catch{D(!1)}},[u]);const Ce=async()=>{m(!0);try{const e=await Yt({branch:k==="all"?void 0:k,limit:1e3}),a=(Array.isArray(e?.data)?e.data:[]).map((r,h)=>({key:r._id||r.movementId||h,ts:r.timestamp||r.createdAt||"",chassis:r.chassisNo||"",company:r.company||"",model:r.model||"",variant:r.variant||"",color:r.color||"",branch:r.sourceBranch||r.branch||"",status:r.status||"in stock",movementId:r.movementId||r.lastMovementId||"",lastMovementId:r.lastMovementId||r.movementId||"",notes:r.notes||""}));J(a),D(!0);try{localStorage.setItem(u,JSON.stringify({at:Date.now(),items:a}))}catch{}}catch{N||J([]),D(!1)}finally{m(!1)}};c.useEffect(()=>{Ce()},[k]),c.useEffect(()=>{Se(W(f.map(e=>e.company))),je(W(f.map(e=>e.model))),ke(W(f.map(e=>e.variant)))},[f]);const Et=c.useMemo(()=>{const e=C(E),o=e.size?f.filter(a=>e.has(x(a.company))):f;return W(o.map(a=>a.model))},[f,E]),Ut=c.useMemo(()=>{const e=C(E),o=e.size?f.filter(h=>e.has(x(h.company))):f,a=C(v),r=a.size?o.filter(h=>a.has(x(h.model))):o;return W(r.map(h=>h.variant))},[f,E,v]),Vt=c.useMemo(()=>{const e=C(E),o=e.size?f.filter(g=>e.has(x(g.company))):f,a=C(v),r=a.size?o.filter(g=>a.has(x(g.model))):o,h=C(Q),y=h.size?r.filter(g=>h.has(x(g.variant))):r;return W(y.map(g=>g.color))},[f,E,v,Q]),Ot=e=>{const o=C(e),a=o.size?f.filter(j=>o.has(x(j.company))):f,r=W(a.map(j=>j.model)),h=C(r),y=v.filter(j=>h.has(x(j))),g=C(y),B=g.size?a.filter(j=>g.has(x(j.model))):a,q=W(B.map(j=>j.variant)),de=C(q),S=Q.filter(j=>de.has(x(j))),we=C(S),ze=we.size?B.filter(j=>we.has(x(j.variant))):B,z=W(ze.map(j=>j.color)),ut=C(z),ve=te.filter(j=>ut.has(x(j)));G(y),me(S),ne(ve),xe(e)},Ft=e=>{const o=C(E),a=o.size?f.filter(z=>o.has(x(z.company))):f,r=C(e),h=r.size?a.filter(z=>r.has(x(z.model))):a,y=W(h.map(z=>z.variant)),g=C(y),B=Q.filter(z=>g.has(x(z))),q=C(B),de=q.size?h.filter(z=>q.has(x(z.variant))):h,S=W(de.map(z=>z.color)),we=C(S),ze=te.filter(z=>we.has(x(z)));me(B),ne(ze),G(e)},Lt=e=>{const o=C(E),a=o.size?f.filter(S=>o.has(x(S.company))):f,r=C(v),h=r.size?a.filter(S=>r.has(x(S.model))):a,y=C(e),g=y.size?h.filter(S=>y.has(x(S.variant))):h,B=W(g.map(S=>S.color)),q=C(B),de=te.filter(S=>q.has(x(S)));ne(de),me(e)},ge=c.useMemo(()=>{const e=String(Z||"").toLowerCase(),o=!!e,[a,r]=Array.isArray(ue)?ue:[],h=a&&typeof a?.toDate=="function"?a.toDate():null,y=r&&typeof r?.toDate=="function"?r.toDate():null,g=C(E),B=C(v),q=C(Q),de=C(te);return f.filter(S=>{if(o&&![S.chassis,S.company,S.model,S.variant,S.color,S.branch].some(j=>String(j||"").toLowerCase().includes(e))||!(g.size?g.has(x(S.company)):!0)||!(B.size?B.has(x(S.model)):!0)||!(q.size?q.has(x(S.variant)):!0)||!(de.size?de.has(x(S.color)):!0))return!1;if(h||y){const ve=new Date(S.ts);if(Number.isNaN(ve.getTime())||h&&ve<h)return!1;if(y){const j=new Date(y);if(j.setHours(23,59,59,999),ve>j)return!1}}return!0})},[f,Z,E,v,Q,te,ue]),nt=c.useMemo(()=>{const e=new Map;return(ge||[]).forEach(o=>{const a=Xt(o.branch)||"Unassigned",r=x(a)||"unassigned";e.has(r)||e.set(r,{label:a,count:0});const h=e.get(r);h.count+=1}),Array.from(e.values()).sort((o,a)=>a.count-o.count).map(({label:o,count:a})=>[o,a])},[ge]);c.useEffect(()=>{Ne(1)},[Z,E,v,Q,te,ue,k]);const rt=f.length,Dt=e=>{const o={company:e.company||"",bikeModel:e.model||"",variant:e.variant||"",color:e.color||"",chassisNo:e.chassis||"",purchaseType:"cash",addressProofMode:"aadhaar",executive:ce?.name||ce?.email||"",branch:e.branch||""};$(o),T(e),p(!0)},_t=e=>{oe(e),M(!0),tt(e.company||""),Le(e.model||""),Re(e.variant||""),se.setFieldsValue({company:e.company||void 0,model:e.model||void 0,variant:e.variant||void 0,color:e.color||void 0,notes:e.notes||void 0})},lt=(e,o)=>{Ye(e),Ze(o),Ae.resetFields(),Je(!0)},it=()=>{Je(!1),Ye(null),Ze(null),Ae.resetFields()},Pt=async()=>{if(!V||!ae){A.warning("Select a vehicle first.");return}try{const e=await Ae.validateFields();Qe(!0);const o={Chassis_No:String(V.chassis||"").toUpperCase(),Company:V.company||"",Model:V.model||"",Variant:V.variant||"",Color:V.color||"",Action:ae,Source_Branch:V.branch||"",Notes:e.notes||""};ae==="transfer"&&(o.Target_Branch=e.targetBranch||""),ae==="return"&&(o.Return_To=e.returnTo||"");const a=await ht({data:o,createdBy:ce?.name||ce?.email||"user"});if(a?.success){const r=ae==="transfer"?"Transfer recorded and waiting for admit by the target branch.":"Return recorded.";A.success(r),it(),Ce()}else A.error(a?.message||"Save failed")}catch(e){if(e?.errorFields)return;A.error("Save failed")}finally{Qe(!1)}},Be=e=>String(e||"").trim(),ct={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},_e={whiteSpace:"normal",wordBreak:"break-word",overflowWrap:"anywhere"},dt={..._e,fontSize:11,color:"#475569"},Wt=e=>{const o=String(e||"").toLowerCase();let a="#d1d5db";o.includes("white")?a="#ffffff":o.includes("black")?a="#111827":o.includes("maroon")||o.includes("wine")?a="#800000":o.includes("gold")?a="#d4af37":o.includes("copper")?a="#b87333":o.includes("purple")||o.includes("violet")?a="#8b5cf6":o.includes("brown")?a="#8b4513":o.includes("starlight")&&o.includes("blue")?a="#60a5fa":o.includes("ps")&&o.includes("blue")?a="#1e3a8a":o.includes("decent")&&o.includes("blue")?a="#3b82f6":o.includes("blue")?a="#2563eb":o.includes("deep")&&o.includes("ground")&&o.includes("grey")?a="#374151":o.includes("mat")&&o.includes("grey")?a="#6b7280":o.includes("genny")&&o.includes("grey")?a="#9ca3af":o.includes("silver")?a="#c0c0c0":o.includes("grey")?a="#9ca3af":o.includes("milit")?a="#4b5320":o.includes("green")?a="#10b981":o.includes("yellow")?a="#f59e0b":o.includes("orange")?a="#f97316":o.includes("red")&&(a="#ef4444");const r=a==="#ffffff"?"#e5e7eb":o.includes("silver")?"#9ca3af":"#d1d5db";return t.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[t.jsx("span",{style:{width:12,height:12,borderRadius:3,background:a,border:`1px solid ${r}`}}),e||"-"]})},mt=[{title:"Chassis + Branch",key:"chassisBranch",width:l?void 0:180,render:(e,o)=>t.jsxs("div",{style:ct,children:[t.jsx("div",{style:{..._e,fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace"},children:o.chassis||"-"}),t.jsx("div",{style:dt,children:o.branch||"-"})]})},{title:"Company || Model + Variant || Color",key:"modelVariantColor",width:l?void 0:220,render:(e,o)=>{const a=Be(o.company),r=Be(o.model),h=Be(o.variant),y=Be(o.color);return t.jsxs("div",{style:ct,children:[t.jsx("div",{style:_e,children:[a,r].filter(Boolean).join(" || ")||"-"}),t.jsxs("div",{style:dt,children:[t.jsx("span",{children:h||"-"}),t.jsx("span",{children:h&&y?" || ":""}),y?Wt(y):"-"]})]})}}],$t={title:"Actions",key:"actions",width:l?void 0:200,fixed:l?void 0:"right",render:(e,o)=>at?t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4},children:[t.jsxs(F,{size:4,children:[t.jsx(L,{size:"small",onClick:()=>lt("transfer",o),style:{fontSize:11,height:20,padding:"0 8px"},children:"Transfer"}),t.jsx(L,{size:"small",type:"primary",onClick:()=>Dt(o),style:{fontSize:11,height:20,padding:"0 8px"},children:"Book"})]}),t.jsxs(F,{size:4,children:[t.jsx(L,{size:"small",onClick:()=>lt("return",o),style:{fontSize:11,height:20,padding:"0 8px"},children:"Return"}),t.jsx(L,{size:"small",onClick:()=>_t(o),style:{fontSize:11,height:20,padding:"0 8px"},children:"Edit"})]})]}):t.jsx("span",{style:{color:"#94a3b8"},children:"â€”"})},Ht=at?[...mt,$t]:[...mt],Kt=()=>{if(!ge.length){A.info("No vehicles to export for current filters");return}const e=[{key:"ts",label:"Timestamp"},{key:"chassis",label:"Chassis"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"color",label:"Color"},{key:"branch",label:"Branch"},{key:"status",label:"Status"},{key:"movementId",label:"Movement Id"}],o=ge.map(a=>({ts:a.ts,chassis:a.chassis,company:a.company,model:a.model,variant:a.variant,color:a.color,branch:a.branch,status:a.status,movementId:a.movementId||a.lastMovementId}));St({filename:"in-stock.csv",headers:e,rows:o}),A.success(`Exported ${o.length} vehicles`)};return t.jsxs("div",{children:[t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[t.jsxs(F,{size:"small",wrap:!0,children:[t.jsx(O,{value:k,onChange:K,style:{minWidth:180},options:[{value:"all",label:"All Branches"},...Y.map(e=>({value:e,label:e}))]}),t.jsx(be,{placeholder:"Search chassis / company / model / color",allowClear:!0,value:Z,onChange:e=>ee(e.target.value),style:{minWidth:240}}),t.jsx(O,{mode:"multiple",allowClear:!0,placeholder:"Company",style:{minWidth:180},value:E,onChange:Ot,options:_.map(e=>({value:e,label:e})),maxTagCount:l?1:3}),t.jsx(O,{mode:"multiple",allowClear:!0,placeholder:"Model",style:{minWidth:180},value:v,onChange:Ft,options:Et.map(e=>({value:e,label:e})),maxTagCount:l?1:3}),t.jsx(O,{mode:"multiple",allowClear:!0,placeholder:"Variant",style:{minWidth:200},value:Q,onChange:Lt,options:Ut.map(e=>({value:e,label:e})),maxTagCount:l?1:3}),t.jsx(O,{mode:"multiple",allowClear:!0,placeholder:"Color",style:{minWidth:180},value:te,onChange:ne,options:Vt.map(e=>({value:e,label:e})),maxTagCount:l?1:3}),t.jsx(eo.RangePicker,{value:ue,onChange:Me,allowClear:!0,style:{minWidth:220}})]}),t.jsx("div",{style:{flex:1}}),t.jsxs(F,{children:[t.jsx(L,{onClick:Kt,children:"Export CSV"}),t.jsx(L,{onClick:()=>{xe([]),G([]),me([]),ne([]),Me([]),ee("")},children:"Reset Filters"}),t.jsx(L,{onClick:Ce,loading:s,children:"Refresh"})]})]}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:8,flexWrap:"wrap"},children:[t.jsx(X,{color:"blue",style:{fontSize:12,padding:"4px 10px"},children:k==="all"?`Total In-Stock (All Branches): ${rt}`:`In-Stock (${k}): ${rt}`}),t.jsxs(X,{color:"geekblue",style:{fontSize:12,padding:"4px 10px"},children:["Showing: ",ge.length]})]}),k==="all"&&nt.length>0&&t.jsxs("div",{style:{marginBottom:8},children:[t.jsx("span",{style:{fontWeight:600,marginRight:8},children:"Available at:"}),t.jsx(F,{size:[6,6],wrap:!0,children:nt.map(([e,o])=>t.jsxs(X,{color:"green",children:[e,": ",o]},`avail-${e}`))})]}),t.jsx(so,{dataSource:ge,columns:Ht,loading:s&&!N,size:"small",className:"compact-table stock-finder-table",tableLayout:l?"auto":"fixed",scroll:l?{x:"max-content"}:void 0,pagination:{current:Fe,pageSize:n,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(e,o)=>{Ne(e),o!==n&&i(o)},showTotal:(e,o)=>`${o[0]}-${o[1]} of ${e}`},rowKey:e=>e.chassis||e.key}),t.jsx($e,{title:R?`Edit In-Stock â€“ ${R.chassis}`:"Edit In-Stock",open:U,onCancel:()=>{M(!1),oe(null),se.resetFields()},onOk:async()=>{try{const e=await se.validateFields();re(!0);const o={Company:e.company,Model:e.model,Variant:e.variant,Color:e.color,Notes:e.notes},a=R?.movementId||R?.lastMovementId;if(!a){A.warning("No movement found for this chassis. Try Refresh."),re(!1);return}const r=await qt(a,o);r?.success?(A.success("Saved"),M(!1),oe(null),se.resetFields(),Ce()):A.error(r?.message||"Save failed")}catch(e){if(e?.errorFields)return;A.error("Save failed")}finally{re(!1)}},okText:"Save",confirmLoading:he,destroyOnClose:!0,children:t.jsxs(H,{form:se,layout:"vertical",children:[t.jsx(H.Item,{name:"company",label:"Company",rules:[{required:!0}],children:t.jsx(O,{showSearch:!0,optionFilterProp:"children",placeholder:fe?"Select company":"Type company",value:ie||void 0,onChange:e=>{tt(e),Le(""),Re(""),se.setFieldsValue({model:void 0,variant:void 0})},disabled:!fe,children:Rt.map(e=>t.jsx(O.Option,{value:e,children:e},e))})}),t.jsx(H.Item,{name:"model",label:"Model",rules:[{required:!0}],children:t.jsx(O,{showSearch:!0,optionFilterProp:"children",placeholder:fe?"Select model":"Type model",value:ye||void 0,onChange:e=>{Le(e),Re(""),se.setFieldsValue({variant:void 0})},disabled:!fe||!ie,children:Bt.map(e=>t.jsx(O.Option,{value:e,children:e},e))})}),t.jsx(H.Item,{name:"variant",label:"Variant",rules:[{required:!0}],children:t.jsx(O,{showSearch:!0,optionFilterProp:"children",placeholder:fe?"Select variant":"Type variant",value:De||void 0,onChange:e=>Re(e),disabled:!fe||!ye,children:zt.map(e=>t.jsx(O.Option,{value:e,children:e},e))})}),t.jsx(H.Item,{name:"color",label:"Color",rules:[{required:!0}],children:ot.length?t.jsx(O,{showSearch:!0,optionFilterProp:"children",placeholder:"Select color",children:ot.map(e=>t.jsx(O.Option,{value:e,children:e},e))}):t.jsx(be,{placeholder:"Color"})}),t.jsxs(H.Item,{name:"notes",label:"Notes",children:[" ",t.jsx(be.TextArea,{rows:3,placeholder:"Optional notes"})," "]})]})}),t.jsxs($e,{title:ae==="transfer"?"Transfer Vehicle":ae==="return"?"Return Vehicle":"Movement",open:jt,onCancel:it,onOk:Pt,okText:"Save",confirmLoading:kt,destroyOnClose:!0,children:[V&&t.jsxs("div",{style:{marginBottom:12,fontSize:12,color:"#475569"},children:[t.jsxs("div",{children:[t.jsx("strong",{children:"Chassis:"})," ",V.chassis||"-"]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Vehicle:"})," ",[V.company,V.model,V.variant,V.color].filter(Boolean).join(" ")||"-"]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Branch:"})," ",V.branch||"-"]})]}),t.jsxs(H,{form:Ae,layout:"vertical",children:[ae==="transfer"&&t.jsx(H.Item,{name:"targetBranch",label:"Target Branch",rules:[{required:!0,message:"Select target branch"}],children:t.jsx(O,{showSearch:!0,optionFilterProp:"children",placeholder:"Select branch",options:Y.map(e=>({value:e,label:e}))})}),ae==="return"&&t.jsx(H.Item,{name:"returnTo",label:"Return To (Dealer/Area)",rules:[{required:!0,message:"Enter return destination"}],children:t.jsx(be,{placeholder:"e.g., Kengaria / Dealer name"})}),t.jsx(H.Item,{name:"notes",label:"Notes",children:t.jsx(be.TextArea,{rows:3,placeholder:"Optional notes"})})]})]}),t.jsx($e,{title:"Book",open:d,onCancel:()=>{p(!1),$(null),T(null)},footer:null,destroyOnClose:!0,width:980,children:t.jsx(Jt,{asModal:!0,initialValues:I||{},autoUpdateStockOnSave:!1,onSuccess:async({response:e,payload:o})=>{try{const a=o?.vehicle||{},r={Chassis_No:String(a.chassisNo||P?.chassis||"").toUpperCase(),Company:a.company||P?.company||"",Model:a.model||P?.model||"",Variant:a.variant||P?.variant||"",Color:a.color||P?.color||"",Action:"invoice",Customer_Name:o?.customerName||"",Source_Branch:P?.branch||"",Notes:e?.bookingId?`Book via Booking ID ${e.bookingId}`:"Book via Booking form"};await ht({data:r,createdBy:ce?.name||ce?.email||"owner"}),A.success("Stock updated: vehicle marked booked / out of stock"),p(!1),$(null),T(null),Ce()}catch{A.error("Saved booking but failed to update stock. Please refresh and try again.")}}})})]})}const{Text:Ue}=io,co="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",mo="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",uo="",Ke="",Ge=co,Ve=mo,ho=b=>{const l=["th","st","nd","rd"],s=b%100;return`${b}${l[(s-20)%10]||l[s]||l[0]}`},pe=b=>String(b||"").replace(/\D/g,"").slice(-10),Oe=b=>pe(b).length===10,qe=b=>String(b||"").toUpperCase().replace(/\s+/g,""),po=/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/,fo=b=>{const l=String(b||"").toUpperCase();return/^[A-Z0-9]*$/.test(l)?[/^[A-Z]{0,2}$/,/^[A-Z]{2}\d{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{0,2}$/,/^[A-Z]{2}\d{2}[A-Z]{2}\d{0,4}$/].some(m=>m.test(l)):!1},yt={SONU:"7033558306",KARTHIK:"7338386813",MANMOHAN:"9956079799",MANSUR:"7795047627",IRSHAD:"6207176821",DAKSHAT:"7829096931",SALMAN:"7892335161"},gt=b=>{const l=String(b||"").trim();return l&&(yt[l]||yt[l.toUpperCase()])||""},wt=b=>{const l=Ct(b);return l.isValid()?l:null},vt=b=>{const l=b?.values||{},s=b?.payload||b||{},m=s.vehicle||{},f=pe(s.mobileNumber||s.mobile||""),J=wt(s.ts||s.createdAt),N=(Array.isArray(s.attachments)?s.attachments:[])||(Array.isArray(s.files)?s.files:[]),D=Z=>{const ee=String(Z||"").toLowerCase(),_=N.find(Se=>String(Se?.name||"").toLowerCase().includes(ee));return _?.url||_?.fileId||null},Y=(Z,ee)=>ee.map(_=>Z?.[_]).find(_=>_!=null&&String(_).trim()!=="");let w=s.invoiceFileUrl||b?.invoiceFileUrl||s.invoiceUrl||s.invoiceLink||Y(l,["Invoice File URL","Invoice","InvoiceFileUrl","InvoiceFileURL"])||Y(s,["Invoice File URL","Invoice","InvoiceFileUrl","InvoiceFileURL"])||l?.invoiceFileUrl||l?.invoiceUrl||l?.invoiceLink||l?.["Invoice File URL"]||l?.Invoice||s["Invoice File URL"]||s.Invoice||D("invoice")||null,k=s.insuranceFileUrl||b?.insuranceFileUrl||s.insuranceUrl||s.insuranceLink||l?.insuranceFileUrl||l?.insuranceUrl||l?.insuranceLink||l?.["Insurance File URL"]||l?.Insurance||s["Insurance File URL"]||s.Insurance||D("insurance")||null;!w&&N?.length&&(w=N[0]?.url||N[0]?.fileId||w),!k&&N?.length>1&&(k=N[1]?.url||N[1]?.fileId||k);const K=w||s.bookingSheetUrl||s.file?.url||s.file?.fileId||l?.bookingSheetUrl||l?.file?.url||l?.file?.fileId||N?.[0]?.url||null;return{id:s.bookingId||s.serialNo||s.id||"",customerName:s.customerName||s.name||"",mobile:f,vehicle:[m.company,m.model,m.variant].filter(Boolean).join(" "),color:m.color||"",chassis:m.chassisNo||"",branch:s.branch||"",purchaseMode:s.purchaseMode||s.purchaseType||"",createdAt:J,raw:s,billLink:K,invoiceUrl:w,insuranceUrl:k}},bt=b=>{const l=b||{},s=b?.payload||b?.values||l,m=s.formValues||s.values||{},f=m.custName||s.custName||s.customerName||s["Customer Name"]||s.name||"",J=pe(m.custMobile||s.custMobile||s.mobile||s["Mobile Number"]||s.Mobile||""),N=s.ts||s.timestamp||s.createdAt||s["Created At"]||m.createdAt||m.created_at||m.timestamp||"",D=m.regNo||m.vehicleNo||m.registrationNumber||s.RegNo||s["Vehicle No"]||s["Registration Number"]||"",Y=s.billUrl||s.billLink||s.bill?.url||s.file?.url||(Array.isArray(s.attachments)?s.attachments[0]?.url:null)||null;return{jcNo:m.jcNo||s.jcNo||s["JC No"]||s["Job Card No"]||s["JC Number"]||"",serviceType:m.serviceType||s.serviceType||s["Service Type"]||s.Service||"",regNo:D,model:m.model||s.model||"",company:m.company||s.company||"",color:m.color||s.color||"",colour:m.colour||s.colour||s.color||"",custName:f,amount:s.totals&&s.totals.grand||s.amount||s["Service Amount"]||s["Collected Amount"]||"",paymentMode:s.paymentMode||s["Payment Mode"]||s.Payment_Mode||m.paymentMode||"",branch:m.branch||s.branch||"",mechanic:m.mechanic||s.mechanic||"",executive:m.executive||s.executive||"",remarks:s.remark||s.Remarks||s.remarkText||s["Remark Text"]||m.remarks||l.remarks||l.Remarks||l.remarkText||l["Remark Text"]||"",km:(()=>{const w=m.km||s.km||s.KM||s.KM||s["Odometer Reading"]||s.Odometer||s.totals&&s.totals.km||s.payload&&s.payload.km||s.payload&&s.payload.formValues&&s.payload.formValues.km||l.KM||l.KM||l.values&&(l.values.KM||l.values.KM||l.values["Odometer Reading"]||l.values.Odometer);return String(w||"").replace(/\D/g,"")||w||""})(),serviceNo:(()=>{const w=s.serviceNo||s.serviceNumber||s.visitNo||s.visit||m.serviceNo||s["Service No"]||s["Service #"]||s["Visit No"]||"",k=Number.parseInt(w,10);return Number.isFinite(k)?k:null})()||null,mobile:J,createdAt:wt(N),billLink:Y,raw:s}};function Vo(){const l=!xt.useBreakpoint().md,s=Gt(),[m,f]=c.useState("vehicle"),[J,N]=c.useState(""),[D,Y]=c.useState(!1),[w,k]=c.useState([]),[K,Z]=c.useState([]),[ee,_]=c.useState(""),[Se,je]=c.useState(!1),[ke,E]=c.useState(null),xe=c.useRef(null),v=w[0]||null,G=c.useMemo(()=>[...K].sort((i,u)=>{const d=i.createdAt?i.createdAt.valueOf():0,p=u.createdAt?u.createdAt.valueOf():0;if(d!==p)return d-p;const I=Number.isFinite(i.serviceNo)?i.serviceNo:0,$=Number.isFinite(u.serviceNo)?u.serviceNo:0;return I-$}),[K]),Q=async n=>{const i={action:"getServiceHistory",query:n,mode:m},u=async d=>{const p=await Pe({webhookUrl:Ve,method:d,payload:i}),I=p?.data||p;return Array.isArray(I?.rows)?I.rows:[]};try{let d=[];try{d=await u("GET")}catch(p){console.warn("Service history GET failed",p)}if(!d.length)try{d=await u("POST")}catch(p){console.warn("Service history POST failed",p)}return d}catch(d){return console.warn("Service history fetch failed",d),[]}},me=async()=>{const n=String(J||"").trim();if(!n){A.warning("Enter mobile or vehicle number to search");return}let i=n;if(m==="mobile"){const u=pe(n);if(u.length!==10){A.error("Enter a valid 10-digit mobile number.");return}i=u}else{const u=qe(n);if(!po.test(u)){A.error("Enter vehicle as KA03AB1234 (AA##AA####).");return}i=u}Y(!0),_("");try{const u=[],d=[],p=m==="mobile"?pe(i)||i:qe(i),I=async(T,U="GET")=>{const M=await oo({webhookUrl:Ge,method:U,payload:T}),R=M?.data||M;return Array.isArray(R?.rows)?R.rows:[]},$=(async()=>{if(!(m==="mobile"||Oe(i)||i.toUpperCase().startsWith("BK-")||m==="vehicle"))return;const T=i.toUpperCase().startsWith("BK-")?{action:"search",mode:"booking",query:i.toUpperCase()}:m==="vehicle"&&!Oe(i)?{action:"search",mode:"vehicle",query:qe(i)}:{action:"search",mode:"mobile",query:pe(i)||i};try{(await I(T,"GET")).forEach(M=>u.push(vt(M)))}catch(U){console.warn("Booking search failed",U)}})(),P=(async()=>{let T=!1;try{const M=await Q(p);M.length&&(M.forEach(R=>d.push(bt(R))),T=!0)}catch(M){console.warn("History lookup failed",M)}if(T)return;const U=m==="vehicle"&&!Oe(i)?["reg","vehicle"]:["mobile","reg"];for(const M of U)try{const R={action:"search",mode:M,query:p};let oe=await Pe({webhookUrl:Ve,method:"GET",payload:R}),he=oe?.data||oe,re=Array.isArray(he?.rows)?he.rows:[];if(re.length||(oe=await Pe({webhookUrl:Ve,method:"POST",payload:R}),he=oe?.data||oe,re=Array.isArray(he?.rows)?he.rows:[]),re.length){re.forEach(se=>d.push(bt(se)));return}}catch(R){console.warn("Jobcard search failed",R)}m==="mobile"&&!Oe(i)&&_("No matching job cards found. Try vehicle number search.")})();if(await Promise.allSettled([$,P]),!u.length&&m==="vehicle"&&Ge&&d.length){const T=pe(d[0]?.mobile||d[0]?.custMobile||"");if(T.length===10){const U=Ke?{action:"search",mode:"mobile",query:T,secret:Ke}:{action:"search",mode:"mobile",query:T};try{let M=await I(U,"GET");M.length||(M=await I(U,"POST").catch(()=>[])),M.forEach(R=>u.push(vt(R)))}catch(M){console.warn("Fallback booking-by-mobile failed",M)}}}k(u),Z(d),!u.length&&!d.length&&_("No records found. Check the number and try again.")}finally{Y(!1)}},te=v?[{label:"Customer",value:v.customerName||"-"},{label:"Mobile",value:v.mobile||"-"},{label:"Vehicle",value:v.vehicle||"-"},{label:"Color",value:v.color||"-"},{label:"Chassis",value:v.chassis||"-"},{label:"Branch",value:v.branch||"-"},{label:"Mode",value:(v.purchaseMode||"").toUpperCase()||"-"},{label:"Created",value:v.createdAt?v.createdAt.format("DD-MM-YYYY HH:mm"):"-"}]:[],ne=c.useMemo(()=>{const i=(G&&G.length?G[G.length-1]:null)||v;if(!i)return"";const u=new URLSearchParams,d=i.regNo||i.vehicle||"",p=i.model||i.company||i.vehicle||"",I=i.colour||i.color||i.colour||"",$=i.custName||i.customerName||"",P=i.mobile||i.custMobile||"";return d&&u.set("regNo",d),p&&u.set("model",p),I&&u.set("colour",I),$&&u.set("custName",$),P&&u.set("custMobile",P),u.toString()},[G,v]),ue=()=>{s(ne?`/jobcard?${ne}`:"/jobcard")},Me=n=>{if(!n)return null;const i=n?.raw?.payload||n?.raw||{},u=i.formValues||n?.raw?.formValues||{},d=Array.isArray(i.labourRows)?i.labourRows:[],p=i.totals||{},I=d.reduce((T,U)=>T+Number(U?.qty||0)*Number(U?.rate||0),0),$={labourSub:p.labourSub??I,labourGST:p.labourGST??0,labourDisc:p.labourDisc??0,grand:p.grand??I},P=n.createdAt&&n.createdAt.toDate&&n.createdAt.toDate()||n.createdAt||i.postServiceAt||i.createdAt||new Date;return{vals:{jcNo:n.jcNo||u.jcNo||"",regNo:n.regNo||u.regNo||"",custName:n.custName||u.custName||"",custMobile:n.mobile||u.custMobile||"",km:u.km||"",model:n.model||u.model||"",colour:n.colour||u.colour||"",branch:n.branch||u.branch||"",executive:n.executive||u.executive||"",createdAt:P,labourRows:d,gstLabour:p.gstLabour||p.labourGST||0},totals:$}},Fe=n=>{const i=Me(n);i&&(E(i),je(!0),setTimeout(()=>{try{no(xe.current)}catch{}setTimeout(()=>je(!1),500)},50))},Ne=()=>{const n=d=>{const p=Ct(d);return p.isValid()?p.format("DD-MM-YYYY HH:mm"):""},i=[];if(w.forEach((d,p)=>{i.push({type:"Booking",ref:d.id||`booking-${p+1}`,customer:d.customerName,mobile:d.mobile,vehicle:d.vehicle,color:d.color,chassis:d.chassis,branch:d.branch,createdAt:n(d.createdAt)})}),G.forEach((d,p)=>{i.push({type:"Service",ref:d.jcNo||`service-${p+1}`,customer:d.custName||d.customerName,mobile:d.mobile,vehicle:d.model||d.company,color:d.colour||d.color,chassis:d.regNo,branch:d.branch,createdAt:n(d.createdAt)})}),!i.length){A.info("No search results to export");return}St({filename:"vehicle-search.csv",headers:[{key:"type",label:"Type"},{key:"ref",label:"Reference"},{key:"customer",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"vehicle",label:"Vehicle"},{key:"color",label:"Color"},{key:"chassis",label:"Chassis / Reg No"},{key:"branch",label:"Branch"},{key:"createdAt",label:"Created At"}],rows:i}),A.success(`Exported ${i.length} records`)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{style:{padding:l?12:24,maxWidth:1200,margin:l?"12px auto":"24px auto",borderRadius:l?16:24,background:"radial-gradient(circle at top, #0f172a 0%, #020617 40%, #020617 100%)",boxShadow:"0 24px 60px rgba(15, 23, 42, 0.8)",border:"1px solid rgba(148, 163, 184, 0.2)"},children:[t.jsxs(He,{title:t.jsxs(F,{align:"center",size:8,children:[t.jsx("span",{style:{fontSize:22,color:"#ef4444"},children:"ðŸï¸"}),t.jsx("span",{children:"Vehicle Search"})]}),extra:t.jsxs(F,{children:[t.jsx(L,{size:"small",onClick:Ne,disabled:!w.length&&!K.length,children:"Export CSV"}),t.jsxs(We.Group,{value:m,onChange:n=>{const i=n.target.value;f(i),N("")},size:"small",children:[t.jsx(We.Button,{value:"vehicle",children:"Vehicle No"}),t.jsx(We.Button,{value:"mobile",children:"Mobile"})]})]}),bodyStyle:{padding:l?12:16,paddingBottom:l?10:12},style:{borderRadius:l?16:20,boxShadow:"0 18px 45px rgba(15, 23, 42, 0.25)",border:"1px solid rgba(148, 163, 184, 0.3)",overflow:"hidden"},headStyle:{background:"linear-gradient(135deg, #0f172a 0%, #1d4ed8 60%, #22c55e 100%)",color:"#ffffff",borderBottom:"none",fontSize:l?16:18,fontWeight:700,letterSpacing:.4},children:[t.jsxs(F.Compact,{style:{width:"100%"},children:[t.jsx(be,{size:l?"middle":"large",placeholder:m==="mobile"?"Enter mobile number":"Enter vehicle number (e.g., KA03AB1234)",value:J,onChange:n=>{const i=n.target.value||"";if(m==="mobile"){const d=i.replace(/\D/g,"").slice(0,10);N(d);return}const u=i.toUpperCase().replace(/[^A-Z0-9]/g,"");fo(u)&&N(u)},onPressEnter:me,allowClear:!0,style:{borderRadius:999,boxShadow:"0 10px 30px rgba(15, 23, 42, 0.2)",border:"1px solid rgba(148, 163, 184, 0.5)"}}),t.jsx(L,{type:"primary",size:l?"middle":"large",loading:D,onClick:me,style:{borderRadius:999,paddingInline:l?18:28,boxShadow:"0 12px 30px rgba(37, 99, 235, 0.45)",fontWeight:600},children:"Search"})]}),ee&&t.jsx(to,{style:{marginTop:12},type:"warning",message:ee,showIcon:!0})]}),t.jsxs(ro,{gutter:[16,16],style:{marginTop:16},children:[t.jsx(ft,{xs:24,md:12,children:t.jsx(He,{title:t.jsxs(F,{align:"center",size:6,children:[t.jsx("span",{style:{fontSize:18},children:"ðŸ“’"}),t.jsx("span",{children:"Booking Details"})]}),extra:t.jsx(X,{color:w.length?"green":"default",children:w.length?`${w.length} found`:"None"}),style:{borderRadius:16,boxShadow:"0 8px 24px rgba(15, 23, 42, 0.06)",border:"none",height:"100%"},headStyle:{fontWeight:600,borderBottom:"1px solid #e5e7eb"},bodyStyle:{padding:16},children:w.length?t.jsxs(t.Fragment,{children:[t.jsx(lo,{size:"small",column:1,colon:!0,bordered:!0,items:te.map(n=>({key:n.label,label:n.label,children:n.value||"-"}))}),t.jsxs(F,{wrap:!0,style:{marginTop:8},children:[v.invoiceUrl?t.jsx(L,{size:"small",type:"default",href:v.invoiceUrl,target:"_blank",rel:"noreferrer",children:"Invoice"}):null,v.insuranceUrl?t.jsx(L,{size:"small",type:"default",href:v.insuranceUrl,target:"_blank",rel:"noreferrer",children:"Insurance"}):null]}),w.length>1&&t.jsx(Ee,{style:{marginTop:12},size:"small",bordered:!0,dataSource:w.slice(1),renderItem:n=>t.jsx(Ee.Item,{children:t.jsxs(F,{direction:"vertical",size:2,children:[t.jsx(Ue,{strong:!0,children:n.customerName||"Booking"}),t.jsxs(Ue,{type:"secondary",children:[n.vehicle||"-"," â€¢ ",n.mobile||"-"]})]})})})]}):t.jsx(pt,{description:"No booking data"})})}),t.jsx(ft,{xs:24,md:12,children:t.jsx(He,{title:t.jsxs(F,{align:"center",size:6,children:[t.jsx("span",{style:{fontSize:18},children:"ðŸ”§"}),t.jsx("span",{children:"Service History"})]}),extra:t.jsxs(F,{size:"small",children:[t.jsx(L,{size:"small",onClick:ue,children:"New Jobcard"}),t.jsx(X,{color:K.length?"blue":"default",children:K.length?`${K.length} found`:"None"})]}),style:{borderRadius:16,boxShadow:"0 8px 24px rgba(15, 23, 42, 0.06)",border:"none",height:"100%"},headStyle:{fontWeight:600,borderBottom:"1px solid #e5e7eb"},bodyStyle:{padding:16},children:K.length?t.jsx(Ee,{size:"small",dataSource:G,renderItem:(n,i)=>t.jsx(Ee.Item,{children:t.jsxs("div",{style:{width:"100%",border:"1px solid #e5e7eb",borderRadius:14,padding:18,background:"linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%)",minWidth:0,boxShadow:"0 6px 16px rgba(15, 23, 42, 0.06)"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,alignItems:"flex-start"},children:[t.jsx(X,{color:"gold",style:{fontWeight:600},children:n.createdAt?n.createdAt.format("DD-MM-YYYY HH:mm"):"-"}),t.jsxs(F,{wrap:!0,size:[8,8],children:[t.jsxs(X,{color:"geekblue",children:[ho(n.serviceNo||i+1)," Service"]}),n.serviceType?t.jsx(X,{color:"cyan",children:n.serviceType}):null,n.branch?t.jsx(X,{color:"purple",children:n.branch}):null,n.jcNo?t.jsxs(X,{color:"green",children:["JC #",n.jcNo]}):null]})]}),t.jsxs("div",{style:{marginTop:10,display:"grid",gridTemplateColumns:"1.2fr 1fr 0.6fr",gap:10},children:[t.jsx("div",{style:{fontSize:16},children:n.model||n.company||"-"}),t.jsx("div",{style:{fontSize:16},children:n.colour||n.color||"-"}),t.jsx("div",{style:{fontSize:16},children:n.km?`${n.km} KM`:"-"})]}),t.jsxs("div",{style:{marginTop:8,display:"grid",gridTemplateColumns:"1fr 1fr auto",gap:10,alignItems:"center"},children:[t.jsx("div",{style:{fontSize:15,fontWeight:600},children:n.custName||n.customerName||"-"}),t.jsxs("div",{style:{fontSize:15},children:[n.mechanic||"-",gt(n.mechanic)?` â€¢ ${gt(n.mechanic)}`:""]}),t.jsx(L,{size:"small",type:"primary",ghost:!0,onClick:()=>Fe(n),children:"Service Invoice"},"invoice")]}),t.jsx("div",{style:{marginTop:10,display:"flex",justifyContent:"flex-end",gap:8},children:n.billLink?t.jsx(L,{size:"small",type:"link",href:n.billLink,target:"_blank",rel:"noreferrer",children:"View Bill"},"bill"):null}),n.remarks?t.jsxs("div",{style:{marginTop:6},children:[t.jsx(Ue,{strong:!0,children:"Remarks:"})," ",t.jsx(Ue,{type:"secondary",children:n.remarks})]}):null]})})}):t.jsx(pt,{description:"No service history"})})})]})]}),t.jsx(ao,{ref:xe,active:Se,vals:ke?.vals||{},totals:ke?.totals||{}})]})}export{Uo as I,Vo as V};
