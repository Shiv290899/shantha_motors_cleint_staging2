import{v,r as a,j as e,G as I}from"./index-Ieo0N9F3.js";import{d as E}from"./index-D-crTbsR.js";import{F as m}from"./index-DhuOMrZ7.js";import{T}from"./index-Ds8OLNSI.js";import{B as M}from"./button-CnzkbVQB.js";import{S as k}from"./index-D7eBwa3z.js";import{C as N}from"./index-BgLPR5_C.js";import{T as C}from"./index-Bu8NwQ7H.js";import{M as D}from"./index-DJnp3ZGz.js";import{R as h}from"./index-CY9tsZK0.js";import{I as S,s as j}from"./index-CD4YwGtV.js";const b=async(s={})=>{const{data:r,status:c}=await v.get("/announcements/public",{params:s,validateStatus:()=>!0});return{...r,_status:c}},F=async s=>{const{data:r,status:c}=await v.post("/announcements",s,{validateStatus:()=>!0});return{...r,_status:c}},{Title:L,Paragraph:B,Text:O}=T,A={info:{color:"geekblue",title:"Information"},warning:{color:"gold",title:"Warning"},alert:{color:"volcano",title:"Alert"}};function Y(){const[s,r]=a.useState(null);return a.useEffect(()=>{(async()=>{try{const c=localStorage.getItem("user");if(c)r(JSON.parse(c));else{const l=await I().catch(()=>null);l?.success&&l.data&&(r(l.data),localStorage.setItem("user",JSON.stringify(l.data)))}}catch{}})()},[]),s}function V(){const s=Y(),r=a.useMemo(()=>String(s?.role||"").toLowerCase(),[s]),c=["owner","admin"].includes(r),[l,g]=a.useState([]),[,f]=a.useState(!1),[x,u]=a.useState(!1),[d]=m.useForm(),w=a.useMemo(()=>`Announcements:lastSeen:${s?.email||s?.name||"user"}`,[s]),p=t=>{try{localStorage.setItem(w,String(t||Date.now()))}catch{}},n=async()=>{f(!0);try{const t=await b({limit:50}),o=Array.isArray(t?.data)?t.data:[];g(o);const y=o.length&&o[0]?.createdAt?new Date(o[0].createdAt).getTime():0;y&&p(y);try{window.dispatchEvent(new Event("ann-refresh"))}catch{}}catch{j.error("Failed to load announcements")}finally{f(!1)}};a.useEffect(()=>{n()},[]);const i=async()=>{try{const t=await d.validateFields(),o={title:t.title,body:t.body,type:t.type,expiresInDays:t.expiresInDays||0},y=await F(o);y?.success?(j.success("Announcement published"),u(!1),d.resetFields(),n()):j.error(y?.message||"Failed to publish")}catch{}};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12,flexWrap:"wrap",gap:8},children:[e.jsx(L,{level:4,style:{margin:0},children:"Announcements"}),c&&e.jsx(M,{type:"primary",onClick:()=>u(!0),children:"New Announcement"})]}),l.length===0?e.jsx(B,{type:"secondary",children:"No announcements yet."}):e.jsx(k,{direction:"vertical",style:{width:"100%"},size:"middle",children:l.map(t=>{const o=A[t.type]||A.info;return e.jsx(N,{size:"small",hoverable:!0,children:e.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(C,{color:o.color,children:o.title}),e.jsx(O,{strong:!0,children:t.title})]}),e.jsx("div",{style:{marginTop:6,whiteSpace:"pre-wrap"},children:t.body}),e.jsx("div",{style:{marginTop:6,color:"#666"},children:E(t.createdAt).format("DD-MM-YYYY HH:mm")})]})})},String(t._id||t.id||t.createdAt))})}),e.jsx(D,{open:x,title:"Publish Announcement",onCancel:()=>u(!1),onOk:i,okText:"Announce",children:e.jsxs(m,{layout:"vertical",form:d,initialValues:{type:"info",expiresInDays:3},children:[e.jsx(m.Item,{label:"Type",name:"type",rules:[{required:!0,message:"Select type"}],children:e.jsxs(h.Group,{children:[e.jsx(h.Button,{value:"info",children:"Information"}),e.jsx(h.Button,{value:"warning",children:"Warning"}),e.jsx(h.Button,{value:"alert",children:"Alert"})]})}),e.jsx(m.Item,{label:"Title",name:"title",rules:[{required:!0,message:"Enter title"}],children:e.jsx(S,{placeholder:"Headline",maxLength:120})}),e.jsx(m.Item,{label:"Message",name:"body",rules:[{required:!0,message:"Enter message"}],children:e.jsx(S.TextArea,{rows:4,placeholder:"Write the announcement"})}),e.jsx(m.Item,{label:"Expires in (days)",name:"expiresInDays",children:e.jsx(S,{type:"number",min:0,placeholder:"0 = no expiry"})})]})})]})}function _(s){return`Announcements:lastSeen:${s?.email||s?.name||"user"}`}function Q(){const[s,r]=a.useState(null),[c,l]=a.useState(0),[g,f]=a.useState(null),[x,u]=a.useState(!1),d=a.useMemo(()=>_(s),[s]),w=()=>{try{const n=localStorage.getItem(d);return n?parseInt(n,10):0}catch{return 0}},p=async()=>{try{const n=await b({limit:1}),t=(Array.isArray(n?.data)?n.data:[])[0]||null,o=t&&t.createdAt?new Date(t.createdAt).getTime():0;l(o||0),f(t),u(o>w())}catch{u(!1)}};return a.useEffect(()=>{(async()=>{try{const n=localStorage.getItem("user");if(n)r(JSON.parse(n));else{const i=await I().catch(()=>null);i?.success&&i.data&&(r(i.data),localStorage.setItem("user",JSON.stringify(i.data)))}}catch{}})()},[]),a.useEffect(()=>{if(!s)return;p();const n=()=>p();return window.addEventListener("ann-refresh",n),()=>window.removeEventListener("ann-refresh",n)},[s]),{hasNew:x,latest:c,latestItem:g,refresh:p}}export{V as A,Q as u};
