import{r as o,R as re,j as e,u as qs}from"./index-Ieo0N9F3.js";import{l as Jt,d as da,e as ua,f as ma,h as ha,b as cs,i as pa,j as fa,k as ya,s as ot,u as xt,t as St,n as te,D as fs,a as Dt,A as ga}from"./caseInsensitive-D16MNlnB.js";import{G as Ut}from"./index-HpyCPvYK.js";import{F as H}from"./index-DhuOMrZ7.js";import{s as j,I as Z}from"./index-CD4YwGtV.js";import{S as ue}from"./index-D7eBwa3z.js";import{S as he,a as ba}from"./index-CY9tsZK0.js";import{B as G}from"./button-CnzkbVQB.js";import{R as Gs}from"./PlusOutlined-k6N2XVWJ.js";import{T as me}from"./index-Bu8NwQ7H.js";import{F as Bt}from"./Table-Dhv4ytuv.js";import{M as rt}from"./index-DJnp3ZGz.js";import{z as Pt,A as ne,T as Ct}from"./TextArea-CAqhmoVd.js";import{d as Ue}from"./index-D-crTbsR.js";import{e as Gt,P as xa}from"./StockUpdate-aE8-7JYR.js";import{C as va}from"./index-BnLSe9wz.js";import{B as Ks,b as Sa,l as ka,a as wa,c as ja,U as ls,d as Ls,e as Ws}from"./BookingForm-BhvUDOyf.js";import{C as ys}from"./index-BgLPR5_C.js";import{D as Es}from"./index-vzK1d07y.js";import{E as Ca,T as Zt}from"./index-Ds8OLNSI.js";import{A as Ms}from"./index-BfdppF0Z.js";import{P as Ra,h as Aa}from"./PostServiceSheet-xW9kn41-.js";import{I as Ta}from"./AntdIcon-6jnzrDeS.js";import{R as Ia}from"./ReloadOutlined-BWu9n86q.js";import{T as Na}from"./index-Dshaf5ky.js";function ds(){return ds=Object.assign?Object.assign.bind():function(n){for(var x=1;x<arguments.length;x++){var d=arguments[x];for(var h in d)Object.prototype.hasOwnProperty.call(d,h)&&(n[h]=d[h])}return n},ds.apply(this,arguments)}const La=(n,x)=>o.createElement(Ta,ds({},n,{ref:x,icon:Ca})),Ea=o.forwardRef(La),Os=[{label:"Sales & Services",value:"sales & services"},{label:"Sales",value:"sales"},{label:"Service",value:"service"}],Ps=[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"},{label:"Under Maintenance",value:"under_maintenance"}];function Rn({readOnly:n=!1}){const d=!Ut.useBreakpoint().md,[h,U]=re.useState(!1),[z,L]=re.useState(!1),[q,k]=re.useState([]),[$,w]=re.useState(0),[_,ce]=re.useState(!1),[A,J]=re.useState(null),[D]=H.useForm(),[pe,fe]=re.useState(""),[Le,ae]=re.useState("all"),[E,se]=re.useState("all"),[Re,xe]=re.useState("all"),[X,je]=re.useState(1),[oe,Se]=re.useState(25),ye=re.useCallback(async()=>{U(!0);try{if(n){const l=await Jt({limit:200});l?.success?(k(l.data.items||[]),w(l.data.total||0)):j.error(l?.message||"Failed to load branches")}else{const l=await da({limit:200});if(l?._status===401||l?._status===403){const v=await Jt({limit:200});v?.success?(j.info("Showing public branch list (read-only). Sign in for management."),k(v.data.items||[]),w(v.data.total||0)):(j.warning("Please login again to manage branches."),k([]),w(0))}else l?.success?(k(l.data.items||[]),w(l.data.total||0)):j.error(l?.message||"Failed to load branches")}}catch(l){j.error(l?.message||"Failed to load branches")}finally{U(!1)}},[n]);re.useEffect(()=>{ye()},[ye]);const Pe=re.useMemo(()=>{const l=new Set((q||[]).map(v=>v.address?.city?String(v.address.city).trim():"").filter(Boolean));return["all",...Array.from(l).sort((v,c)=>v.localeCompare(c))]},[q]),ee=re.useMemo(()=>{const l=String(pe||"").toLowerCase();return(q||[]).filter(v=>Le!=="all"&&String(v.address?.city||"")!==Le||E!=="all"&&String(v.type||"")!==E||Re!=="all"&&String(v.status||"")!==Re?!1:l?[v.code,v.name,v.phone,v.email,v.address?.line1,v.address?.line2,v.address?.area,v.address?.city,v.address?.state].map(O=>String(O||"").toLowerCase()).some(O=>O.includes(l)):!0)},[q,pe,Le,E,Re]);re.useEffect(()=>{je(1)},[pe,Le,E,Re]);const ze=re.useMemo(()=>{const l=v=>{const c=new Map;return ee.forEach(O=>{const i=String(O[v]||"");c.set(i,(c.get(i)||0)+1)}),Array.from(c.entries()).sort((O,i)=>i[1]-O[1])};return{byType:l("type"),byStatus:l("status")}},[ee]),de=()=>{const l=["Code","Name","Type","Status","Phone","Email","Line1","Line2","Area","City","State","Pincode","Latitude","Longitude"],v=ee.map(P=>[P.code||"",P.name||"",P.type||"",P.status||"",P.phone||"",P.email||"",P.address?.line1||"",P.address?.line2||"",P.address?.area||"",P.address?.city||"",P.address?.state||"",P.address?.pincode||"",P.location?.coordinates?.[1]??"",P.location?.coordinates?.[0]??""]),c=[l,...v].map(P=>P.map(Ce=>String(Ce).includes(",")?`"${String(Ce).replace(/"/g,'""')}"`:String(Ce)).join(",")).join(`
`),O=new Blob([c],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(O),M=document.createElement("a");M.href=i,M.download="branches.csv",M.click(),setTimeout(()=>URL.revokeObjectURL(i),500)},Ie=()=>{J(null),ce(!0),setTimeout(()=>{D.resetFields(),D.setFieldsValue({type:"sales & services",status:"active"})},0)},De=l=>{J(l),D.setFieldsValue({id:l.id,code:l.code,name:l.name,type:l.type,phone:l.phone,email:l.email,address_line1:l.address?.line1,address_line2:l.address?.line2,area:l.address?.area,city:l.address?.city,state:l.address?.state,pincode:l.address?.pincode,lat:l.location?.coordinates?.[1],lng:l.location?.coordinates?.[0],status:l.status,manager:l.manager||void 0,staffIds:Array.isArray(l.staff)?l.staff.map(String).join(","):void 0,boysIds:Array.isArray(l.boys)?l.boys.map(String).join(","):void 0,mechanicsIds:Array.isArray(l.mechanics)?l.mechanics.map(String).join(","):void 0}),ce(!0)},Ee=async l=>{rt.confirm({title:`Delete ${l.name}?`,content:"This cannot be undone.",okButtonProps:{danger:!0},okText:"Delete",onOk:async()=>{try{const v=await ha(l.id);v?.success?(j.success("Branch deleted"),ye()):j.error(v?.message||"Delete failed")}catch{j.error("Delete failed")}}})},Ae=async()=>{try{const l=await D.validateFields(),v={code:l.code,name:l.name,type:l.type,phone:l.phone,email:l.email,address:{line1:l.address_line1,line2:l.address_line2,area:l.area,city:l.city,state:l.state,pincode:l.pincode},lat:l.lat,lng:l.lng,status:l.status,...l.manager?{manager:String(l.manager).trim()}:{},...l.staffIds?{staff:String(l.staffIds).split(",").map(O=>O.trim()).filter(Boolean)}:{},...l.boysIds?{boys:String(l.boysIds).split(",").map(O=>O.trim()).filter(Boolean)}:{},...l.mechanicsIds?{mechanics:String(l.mechanicsIds).split(",").map(O=>O.trim()).filter(Boolean)}:{}};L(!0);let c;if(A?.id?c=await ua(A.id,v):c=await ma(v),c?._status===401||c?._status===403){j.warning("Please login again to continue.");return}c?.success?(j.success(A?"Branch updated":"Branch created"),ce(!1),J(null),D.resetFields(),ye()):j.error(c?.message||"Save failed")}catch(l){const v=l?.response?.data?.message||l?.message||"Save failed";j.error(v)}finally{L(!1)}},$e=l=>{const v=[l.address?.line1,l.address?.line2,l.address?.area,l.address?.city,l.address?.state,l.address?.pincode].filter(Boolean).join(", ");return v?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v)}`:null},Q=[{title:"Code",dataIndex:"code",key:"code",width:80,sorter:(l,v)=>l.code.localeCompare(v.code)},{title:"Name",dataIndex:"name",key:"name",width:180,ellipsis:!0,sorter:(l,v)=>l.name.localeCompare(v.name),render:(l,v)=>e.jsxs("span",{children:[l," ",e.jsx(Ct,{title:"Open in Google Maps",children:$e(v)&&e.jsx("a",{href:$e(v),target:"_blank",rel:"noopener",style:{fontSize:12,marginLeft:4},children:"Map"})})]})},{title:"Type",dataIndex:"type",key:"type",width:110,render:l=>{const v=l==="sales"?"geekblue":l==="service"?"cyan":"blue";return e.jsx(me,{color:v,children:l})}},{title:"City",key:"city",width:110,ellipsis:!0,render:(l,v)=>v.address?.city||"â€”"},{title:"Phone",dataIndex:"phone",key:"phone",width:110,ellipsis:!0},{title:"Staff",key:"staffCount",width:60,render:(l,v)=>v.activeStaffCount??(Array.isArray(v.staff)?v.staff.length:0)},{title:"Boys",key:"boysCount",width:60,render:(l,v)=>v.activeBoysCount??(Array.isArray(v.boys)?v.boys.length:0)},{title:"Mechanics",key:"mechCount",width:80,render:(l,v)=>v.activeMechanicsCount??(Array.isArray(v.mechanics)?v.mechanics.length:0)},{title:"Status",dataIndex:"status",key:"status",width:110,render:l=>l==="active"?e.jsx(me,{color:"green",children:"Active"}):l==="inactive"?e.jsx(me,{children:"Inactive"}):e.jsx(me,{color:"orange",children:"Under Maintenance"})},...n?[]:[{title:"Actions",key:"actions",width:140,render:(l,v)=>e.jsxs(ue,{size:4,wrap:!0,children:[e.jsx(G,{size:"small",onClick:()=>De(v),children:"Edit"}),e.jsx(G,{size:"small",danger:!0,onClick:()=>Ee(v),children:"Delete"})]})}]];return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[e.jsxs(ue,{size:[8,8],wrap:!0,children:[e.jsx(Z.Search,{placeholder:"Search code/name/city/phone",allowClear:!0,value:pe,onChange:l=>fe(l.target.value),style:{minWidth:220}}),e.jsx(he,{value:Le,onChange:ae,style:{minWidth:160},options:Pe.map(l=>({value:l,label:l==="all"?"All Cities":l}))}),e.jsx(he,{value:E,onChange:se,style:{minWidth:160},options:[{value:"all",label:"All Types"},...Os]}),e.jsx(he,{value:Re,onChange:xe,style:{minWidth:180},options:[{value:"all",label:"All Status"},...Ps]}),e.jsx(G,{onClick:ye,children:"Refresh"}),e.jsx(G,{onClick:de,children:"Export CSV"})]}),e.jsx("div",{style:{flex:1}}),!n&&e.jsx(G,{type:"primary",icon:e.jsx(Gs,{}),onClick:Ie,children:"New Branch"})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginBottom:8},children:[ze.byStatus.map(([l,v])=>e.jsxs(me,{color:l==="active"?"green":l==="inactive"?"default":"orange",children:[l||"unknown",": ",v]},`st-${l||"unknown"}`)),ze.byType.map(([l,v])=>e.jsxs(me,{color:l==="sales"?"geekblue":l==="service"?"cyan":"blue",children:[l||"unknown",": ",v]},`tp-${l||"unknown"}`)),e.jsxs(me,{color:"blue",children:["Total: ",ee.length," / ",$]})]}),e.jsx(Bt,{rowKey:l=>l.id,dataSource:ee,columns:Q,loading:h,tableLayout:d?"auto":"fixed",pagination:{current:X,pageSize:oe,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(l,v)=>{je(l),v!==oe&&Se(v)},showTotal:(l,v)=>`${v[0]}-${v[1]} of ${l}`},size:d?"small":"middle",scroll:d?{x:"max-content"}:void 0}),e.jsx(rt,{title:A?`Edit Branch â€“ ${A.name}`:"New Branch",open:_,onCancel:()=>{ce(!1),J(null)},onOk:Ae,okText:A?"Save":"Create",confirmLoading:z,forceRender:!0,destroyOnClose:!0,children:e.jsx(H,{form:D,layout:"vertical",children:e.jsxs(Pt,{gutter:[12,8],children:[e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"code",label:"Code",rules:[{required:!0,message:"Code is required"}],children:e.jsx(Z,{placeholder:"e.g., BDRH",maxLength:10})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(Z,{placeholder:"e.g., Byadarahalli Branch"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"type",label:"Type",initialValue:"sales & services",rules:[{required:!0}],children:e.jsx(he,{options:Os})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"status",label:"Status",initialValue:"active",rules:[{required:!0}],children:e.jsx(he,{options:Ps})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"phone",label:"Phone",children:e.jsx(Z,{placeholder:"Branch phone"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"email",label:"Email",children:e.jsx(Z,{placeholder:"Branch email",type:"email"})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"address_line1",label:"Address Line 1",children:e.jsx(Z,{})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"address_line2",label:"Address Line 2",children:e.jsx(Z,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"area",label:"Area",children:e.jsx(Z,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"city",label:"City",rules:[{required:!0,message:"City is required"}],children:e.jsx(Z,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"state",label:"State",children:e.jsx(Z,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"pincode",label:"Pincode",children:e.jsx(Z,{})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"lat",label:"Latitude",children:e.jsx(Z,{type:"number",step:"any"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"lng",label:"Longitude",children:e.jsx(Z,{type:"number",step:"any"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"manager",label:"Manager (User ID)",children:e.jsx(Z,{placeholder:"24-char user id (optional)"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"staffIds",label:"Staff (comma-separated User IDs)",children:e.jsx(Z,{placeholder:"id1,id2,id3"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"boysIds",label:"Boys (comma-separated User IDs)",children:e.jsx(Z,{placeholder:"id1,id2"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"mechanicsIds",label:"Mechanics (comma-separated User IDs)",children:e.jsx(Z,{placeholder:"id1,id2"})})})]})})})]})}const Us=[{label:"Admin",value:"admin"},{label:"Owner",value:"owner"},{label:"Staff",value:"staff"},{label:"Mechanic",value:"mechanic"},{label:"Employees",value:"employees"},{label:"User",value:"user"},{label:"Backend",value:"backend"}],Bs=[{label:"Active",value:"active"},{label:"Inactive",value:"inactive"},{label:"Suspended",value:"suspended"}];function An({readOnly:n=!1}){const d=!Ut.useBreakpoint().md,[h,U]=re.useState(!1),[z,L]=re.useState(!1),[q,k]=re.useState([]),[$,w]=re.useState(0),[_,ce]=re.useState(!1),[A,J]=re.useState(null),[D,pe]=re.useState([]),[fe]=H.useForm(),Le=re.useCallback(c=>c?.id||c?._id||c?.userId||null,[]),[ae,E]=re.useState(""),[se,Re]=re.useState(""),[xe,X]=re.useState(),[je,oe]=re.useState(),[Se,ye]=re.useState(),[Pe,ee]=re.useState(1),[ze,de]=re.useState(25),Ie=re.useCallback(async()=>{const c=await Jt({limit:500,status:"active"});c?.success&&pe(c.data.items||[])},[]),De=re.useCallback(async()=>{U(!0);try{if(n){const c=await cs({limit:1e5,page:1,...se?{q:se}:{},...xe?{role:xe}:{},...je?{status:je}:{},...Se?{branch:Se}:{}});c?.success?(k(c.data.items||[]),w(c.data.total||c.data.items?.length||0)):(j.error(c?.message||"Failed to load users"),k([]),w(0))}else{const c=await pa({limit:1e5,page:1,...se?{q:se}:{},...xe?{role:xe}:{},...je?{status:je}:{},...Se?{branch:Se}:{}});if(c?.success)k(c.data.items||[]),w(c.data.total||c.data.items?.length||0);else if(c?._status===401||c?._status===403){const O=await cs({limit:1e5,page:1,...se?{q:se}:{},...xe?{role:xe}:{},...je?{status:je}:{},...Se?{branch:Se}:{}});O?.success?(j.info("Showing public user list (read-only). Sign in for management."),k(O.data.items||[]),w(O.data.total||O.data.items?.length||0)):(j.error(c?.message||"Failed to load users"),k([]),w(0))}else j.error(c?.message||"Failed to load users")}}catch(c){j.error(c?.message||"Failed to load users")}finally{U(!1)}},[se,xe,je,Se,n]);re.useEffect(()=>{Ie()},[Ie]),re.useEffect(()=>{De()},[De]),re.useEffect(()=>{ee(1)},[se,xe,je,Se]);const Ee=c=>{const O=Le(c);if(!O){j.error("User ID missing. Please refresh and try again.");return}J({...c,id:O}),fe.setFieldsValue({id:O,name:c.name,email:c.email,phone:c.phone,role:c.role,status:c.status,jobTitle:c.jobTitle,employeeCode:c.employeeCode,primaryBranch:c.primaryBranch?._id||c.primaryBranch?.id||c.primaryBranch||void 0,branches:Array.isArray(c.branches)?c.branches.map(i=>typeof i=="string"?i:i?._id||i?.id).filter(Boolean):void 0,canSwitchBranch:!!c.canSwitchBranch}),ce(!0)},Ae=async c=>{const O=Le(c);if(!O){j.error("User ID missing. Please refresh and try again.");return}rt.confirm({title:`Delete ${c.name}?`,content:"This cannot be undone.",okButtonProps:{danger:!0},okText:"Delete",onOk:async()=>{try{const i=await ya(O);i?.success?(j.success("User deleted"),De()):j.error(i?.message||"Delete failed")}catch{j.error("Delete failed")}}})},$e=async()=>{try{const c=await fe.validateFields(),O={name:c.name,email:c.email,...c.phone?{phone:c.phone}:{},role:c.role,status:c.status,...c.jobTitle?{jobTitle:c.jobTitle}:{},...c.employeeCode?{employeeCode:c.employeeCode}:{},...c.primaryBranch?{primaryBranch:c.primaryBranch}:{},...Array.isArray(c.branches)?{branches:c.branches}:{},canSwitchBranch:!!c.canSwitchBranch};L(!0);const i=Le(A);if(!i){j.error("Cannot create users here. Use registration.");return}const M=await fa(i,O);if(M?._status===401||M?._status===403){j.warning("Please login again to continue.");return}M?.success?(j.success("User updated"),ce(!1),J(null),fe.resetFields(),De()):j.error(M?.message||"Save failed")}catch(c){const O=c?.response?.data?.message||c?.message||"Save failed";j.error(O)}finally{L(!1)}},Q=D.map(c=>({label:c.name,value:c.id||c._id})),l=[{title:"Name",dataIndex:"name",key:"name",width:160,ellipsis:!0,sorter:(c,O)=>c.name.localeCompare(O.name)},{title:"Email",dataIndex:"email",key:"email",width:180,ellipsis:!0},{title:"Phone",dataIndex:"phone",key:"phone",width:110,ellipsis:!0},{title:"Role",dataIndex:"role",key:"role",width:100,render:c=>e.jsx(me,{color:c==="admin"?"red":c==="owner"?"gold":c==="backend"?"purple":c==="mechanic"?"cyan":c==="staff"?"blue":"default",children:c})},{title:"Primary Branch",key:"primaryBranch",width:140,ellipsis:!0,render:(c,O)=>O.primaryBranch?.name||"â€”"},{title:"Status",dataIndex:"status",key:"status",width:90,render:c=>c==="active"?e.jsx(me,{color:"green",children:"Active"}):c==="inactive"?e.jsx(me,{children:"Inactive"}):e.jsx(me,{color:"orange",children:"Suspended"})},{title:"Last Login",dataIndex:"lastLoginAt",key:"lastLoginAt",width:140,render:c=>c?Ue(c).format("DD-MM-YYYY HH:mm"):"â€”"},...n?[]:[{title:"Actions",key:"actions",width:160,render:(c,O)=>e.jsxs(ue,{size:4,wrap:!0,children:[e.jsx(G,{size:"small",onClick:i=>{i.stopPropagation(),Ee(O)},children:"Edit"}),e.jsx(G,{size:"small",danger:!0,onClick:i=>{i.stopPropagation(),Ae(O)},children:"Delete"})]})}]],v=()=>{if(!q.length){j.info("No users to export for current filters");return}const c=[{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"phone",label:"Phone"},{key:"role",label:"Role"},{key:"status",label:"Status"},{key:"jobTitle",label:"Job Title"},{key:"employeeCode",label:"Employee Code"},{key:"primaryBranch",label:"Primary Branch"},{key:"branches",label:"Additional Branches"},{key:"lastLoginAt",label:"Last Login"}],O=q.map(i=>{const M=Array.isArray(i.branches)?i.branches.map(P=>typeof P=="string"?P:P?.name||P?.branchName||"").filter(Boolean).join("; "):"";return{name:i.name,email:i.email,phone:i.phone,role:i.role,status:i.status,jobTitle:i.jobTitle,employeeCode:i.employeeCode,primaryBranch:(typeof i.primaryBranch=="string"?i.primaryBranch:i.primaryBranch?.name)||"",branches:M,lastLoginAt:i.lastLoginAt}});Gt({filename:"users.csv",headers:c,rows:O}),j.success(`Exported ${O.length} users`)};return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:12,gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Total:"})," ",$]}),e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[e.jsx(Z.Search,{placeholder:"Search name/email/phone",allowClear:!0,value:ae,onChange:c=>E(c.target.value),onSearch:c=>Re((c||"").trim()),style:{width:240}}),e.jsx(he,{placeholder:"Role",allowClear:!0,value:xe,onChange:c=>X(c),options:Us,style:{width:140}}),e.jsx(he,{placeholder:"Status",allowClear:!0,value:je,onChange:c=>oe(c),options:Bs,style:{width:140}}),e.jsx(he,{placeholder:"Branch",allowClear:!0,showSearch:!0,optionFilterProp:"label",value:Se,onChange:c=>ye(c),options:D.map(c=>({label:c.name,value:c.id})),style:{width:220}}),e.jsx(G,{onClick:v,children:"Export CSV"}),e.jsx(G,{onClick:De,children:"Refresh"}),e.jsx(G,{onClick:()=>{E(""),Re(""),X(void 0),oe(void 0),ye(void 0)},children:"Reset"})]})]}),e.jsx(Bt,{rowKey:c=>Le(c)||`${c.email||""}-${c.phone||""}-${c.name||""}`,dataSource:q,columns:l,loading:h,tableLayout:d?"auto":"fixed",pagination:{current:Pe,pageSize:ze,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(c,O)=>{ee(c),O!==ze&&de(O)},showTotal:(c,O)=>`${O[0]}-${O[1]} of ${c}`},size:d?"small":"middle",scroll:d?{x:"max-content"}:void 0}),e.jsx(rt,{title:A?`Edit User â€“ ${A.name}`:"New User",open:_,onCancel:()=>{ce(!1),J(null)},onOk:$e,okText:A?"Save":"Create",confirmLoading:z,forceRender:!0,destroyOnClose:!0,children:e.jsx(H,{form:fe,layout:"vertical",children:e.jsxs(Pt,{gutter:[12,8],children:[e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"name",label:"Name",rules:[{required:!0,message:"Name is required"}],children:e.jsx(Z,{placeholder:"Full name"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"email",label:"Email",rules:[{required:!0,message:"Email is required"},{type:"email",message:"Enter a valid email"}],children:e.jsx(Z,{placeholder:"name@example.com"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"phone",label:"Phone",children:e.jsx(Z,{placeholder:"Mobile number"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"role",label:"Role",initialValue:"user",rules:[{required:!0}],children:e.jsx(he,{options:Us})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"status",label:"Status",initialValue:"active",rules:[{required:!0}],children:e.jsx(he,{options:Bs})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"jobTitle",label:"Job Title",children:e.jsx(Z,{placeholder:"e.g., Sales Executive"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"employeeCode",label:"Employee Code",children:e.jsx(Z,{placeholder:"Unique within primary branch"})})}),e.jsx(ne,{xs:24,sm:12,children:e.jsx(H.Item,{name:"primaryBranch",label:"Primary Branch",children:e.jsx(he,{allowClear:!0,options:Q,placeholder:"Select primary branch"})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"branches",label:"Additional Branches",children:e.jsx(he,{mode:"multiple",allowClear:!0,options:Q,placeholder:"Select additional branches"})})}),e.jsx(ne,{span:24,children:e.jsx(H.Item,{name:"canSwitchBranch",valuePropName:"checked",children:e.jsx(va,{children:"Can switch branches"})})})]})})})]})}function gs(n,x=250){const[d,h]=o.useState(n);return o.useEffect(()=>{const U=setTimeout(()=>h(n),x);return()=>clearTimeout(U)},[n,x]),d}function Ma({open:n,onClose:x,row:d,webhookUrl:h}){const[U,z]=o.useState(!1),[L,q]=o.useState(null),k=($={})=>{const{patch:w}=Sa($);return w||{}};return o.useEffect(()=>{let $=!0;return(async()=>{if(!(!n||!d)){z(!0);try{if(h&&d.bookingId){const _=await ot({webhookUrl:h,method:"GET",payload:{action:"search",mode:"booking",query:d.bookingId}}),ce=_?.data||_,A=Array.isArray(ce?.rows)&&ce.rows.length?ce.rows[0]?.payload:null;$&&q(k(A||{customerName:d.name,mobileNumber:d.mobile,branch:d.branch,vehicle:{company:d.company,model:d.model,variant:d.variant,chassisNo:d.chassis}}))}else $&&q(k({customerName:d?.name,mobileNumber:d?.mobile,branch:d?.branch,vehicle:{company:d?.company,model:d?.model,variant:d?.variant,chassisNo:d?.chassis}}))}catch{$&&(j.warning("Could not fetch full booking. Opening with available fields."),q(k({customerName:d?.name,mobileNumber:d?.mobile,branch:d?.branch,vehicle:{company:d?.company,model:d?.model,variant:d?.variant,chassisNo:d?.chassis}})))}finally{$&&z(!1)}}})(),()=>{$=!1}},[n,d,h]),e.jsx(rt,{open:n,title:"Prefilled Booking Form",onCancel:x,footer:null,width:980,destroyOnClose:!0,children:U?e.jsx("div",{style:{display:"grid",placeItems:"center",height:160},children:e.jsx(ba,{})}):e.jsx("div",{style:{paddingTop:8},children:e.jsx(Ks,{asModal:!0,initialValues:L||{},startPaymentsOnly:!!d?.bookingId,editRefDefault:d?.bookingId?{bookingId:d.bookingId,mobile:d.mobile}:null})})})}const{Text:Ot}=Zt,Qe={ts:["Submitted At","Timestamp","Time","Date"],branch:["Branch"],name:["Customer Name","Customer_Name","Customer","Name"],mobile:["Mobile Number","Mobile","Phone"],bookingId:["Booking ID","Booking_ID","Booking Id","BookingID"],company:["Company"],model:["Model"],variant:["Variant"],color:["Color","Colour","Vehicle Color","Vehicle Colour"],chassis:["Chassis Number","Chassis No","Chassis"],file:["File URL","File","Document URL"],status:["Status","Booking Status","State"],availability:["Chassis Availability","Availability","Stock","Stock Status"]},Ye=(n,x)=>String(x.map(d=>n[d]??"").find(d=>d!=="")||"").trim(),Oa=new Set(["#ERROR!","#N/A","#VALUE!","#REF!","#NAME?","#DIV/0!"]),_s=n=>{const x=String(n??"").trim();return x?Oa.has(x.toUpperCase())?"":x:""};function Tn(){const x=!Ut.useBreakpoint().md,[d,h]=o.useState([]),[U,z]=o.useState(!1),[L,q]=o.useState("all"),[k,$]=o.useState("all"),[w,_]=o.useState(()=>[Ue().startOf("month"),Ue()]),[ce,A]=o.useState(null),[,J]=o.useState(null),[D,pe]=o.useState({open:!1,row:null}),[fe,Le]=o.useState({open:!1,row:null}),[ae,E]=o.useState(""),se=gs(ae,300),[Re,xe]=o.useState(1),[X,je]=o.useState(25),[oe,Se]=o.useState("pagination"),[ye,Pe]=o.useState(25),[ee,ze]=o.useState(0),de="true".toLowerCase()==="true",[Ie,De]=o.useState({}),[Ee,Ae]=o.useState({open:!1,refId:"",level:"ok",text:""}),[$e,Q]=o.useState(!1),[l,v]=o.useState({open:!1,type:"",row:null,fileList:[],loading:!1}),[c,O]=o.useState({open:!1}),[i,M]=o.useState([]),[P,Ce]=o.useState([]),[_e,Be]=o.useState(!1),[ke,lt]=o.useState([]),[Rt,Nt]=o.useState([]),[Lt,pt]=o.useState(!1),[Ke,Fe]=o.useState([]),[ft,At]=o.useState(!1),[Tt,kt]=o.useState(0),[it,ct]=o.useState(""),[dt,et]=o.useState(null),[qe,vt]=o.useState(""),[tt,We]=o.useState(!1),[Ve,ut]=o.useState({open:!1,row:null}),[It,u]=o.useState(""),[p,T]=o.useState(!1),[I,C]=o.useState(!1),[s]=H.useForm(),[r,f]=o.useState(null),[y,g]=o.useState(""),[R,W]=o.useState([]);o.useEffect(()=>{try{const t=localStorage.getItem("user");if(!t)return;const a=JSON.parse(t);f(a),g(String(a?.role||"").toLowerCase());const m=[],b=a?.formDefaults?.branchName||a?.primaryBranch?.name||"";b&&m.push(b),Array.isArray(a?.branches)&&a.branches.forEach(N=>{const B=typeof N=="string"?N:N?.name||"";B&&m.push(B)}),W(Array.from(new Set(m.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(y)&&R.length&&L==="all"&&q(R[0])},[y,R,L]);const F=o.useCallback(async()=>{Be(!0);try{const[t,a]=await Promise.allSettled([Jt({status:"active",limit:500}),cs({role:"staff",status:"active",limit:1e5})]);if(t.status==="fulfilled"&&t.value?.success){const m=xt((t.value.data.items||[]).filter(b=>String(b?.status||"").toLowerCase()==="active").map(b=>b.name));M(m)}else M([]),t.status==="fulfilled"&&j.warning(t.value?.message||"Could not load branches");if(a.status==="fulfilled"&&a.value?.success){const m=xt((a.value.data.items||[]).filter(b=>String(b.role||"").toLowerCase()==="staff").map(b=>b.name||b.email||""));Ce(m)}else Ce([]),a.status==="fulfilled"&&j.warning(a.value?.message||"Could not load executives")}catch{M([]),Ce([]),j.error("Could not load dropdown options")}finally{Be(!1)}},[]);o.useEffect(()=>{F()},[F]);const Y="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",le="",Te=(()=>{const t=w&&w[0]?w[0].startOf("day").valueOf():"",a=w&&w[1]?w[1].endOf("day").valueOf():"";return`Bookings:list:${JSON.stringify({branchFilter:L,statusFilter:k,q:se||"",start:t,end:a,page:Re,pageSize:X,USE_SERVER_PAG:de})}`})(),we=o.useCallback((t,a=0)=>{let m={};try{m=typeof t["Raw Payload"]=="object"?t["Raw Payload"]||{}:JSON.parse(String(t["Raw Payload"]||t.rawPayload||t.payload||"{}"))}catch{m={}}const b=m?.color||m?.vehicle?.color||m?.vehicleColor||m?.formValues?.color||"",N=(m?.remark?.level||t.RemarkLevel||t.remarkLevel||"").toString(),B=m?.remark?.text||t.RemarkText||t.remarkText||"",V=String(N||"").toLowerCase(),S=_s(Ye(t,Qe.name)),K=_s(m?.customerName||m?.name||m?.formValues?.custName||m?.formValues?.name||"");return{key:a,ts:Ye(t,Qe.ts),tsMs:is(Ye(t,Qe.ts)),bookingId:Ye(t,Qe.bookingId),name:S||K,mobile:Ye(t,Qe.mobile),company:Ye(t,Qe.company),model:Ye(t,Qe.model),variant:Ye(t,Qe.variant),color:Ye(t,Qe.color)||String(b||"").trim(),chassis:Ye(t,Qe.chassis),fileUrl:Ye(t,Qe.file),branch:Ye(t,Qe.branch),status:(Ye(t,Qe.status)||"pending").toLowerCase(),availability:Ye(t,Qe.availability),RemarkLevel:N||"",RemarkText:B||"",_remarkLevel:V,_remarkText:B||"",_raw:t}},[]);o.useEffect(()=>{try{const t=localStorage.getItem(Te);if(!t)return;const a=JSON.parse(t);a&&Array.isArray(a.rows)&&(h(a.rows),ze(typeof a.total=="number"?a.total:a.rows.length),Q(!0))}catch{}},[Te]),o.useEffect(()=>{let t=!1;return(async()=>{try{const b=await ot({webhookUrl:Y,method:"GET",payload:le?{action:"list",page:1,pageSize:5e3,secret:le}:{action:"list",page:1,pageSize:5e3}}),N=b?.data||b,V=(Array.isArray(N?.data)?N.data:[]).map((S,K)=>we(S,K));t||lt(V)}catch{}})(),()=>{t=!0}},[Y,le,we]),o.useEffect(()=>{let t=!1;return(async()=>{pt(!0);try{let N=1,B=[];for(;;){const V={action:"list"},S={q:se||"",branch:L!=="all"?L:"",status:k!=="all"?k:""};w&&w[0]&&w[1]&&(S.start=w[0].startOf("day").valueOf(),S.end=w[1].endOf("day").valueOf());const K={...V,page:N,pageSize:5e3,...S},be=await ot({webhookUrl:Y,method:"GET",payload:K}),Oe=be?.data||be,ve=Array.isArray(Oe?.data)?Oe.data:[];B=B.concat(ve.map((mt,bt)=>we(mt,bt)));const He=typeof Oe?.total=="number"?Oe.total:null;if(He!==null&&B.length>=He||ve.length===0||(N+=1,N>200))break}t||Nt(B)}catch{t||Nt([])}finally{t||pt(!1)}})(),()=>{t=!0}},[se,L,k,w,Y,we]),o.useEffect(()=>{let t=!1;const a=async()=>{z(!0);try{const b=Y,N="",B={action:"list"},V={q:se||"",branch:L!=="all"?L:"",status:k!=="all"?k:""};w&&w[0]&&w[1]&&(V.start=w[0].startOf("day").valueOf(),V.end=w[1].endOf("day").valueOf());const S=de?{...B,page:Re,pageSize:X,...V,...N?{secret:N}:{}}:N?{...B,secret:N}:B,K=await ot({webhookUrl:b,method:"GET",payload:S}),be=K?.data||K;if(!be?.ok||!Array.isArray(be?.data))throw new Error("Invalid response");const ve=be.data.map((He,mt)=>we(He,mt)).filter(He=>He.bookingId||He.name||He.mobile);if(!t){h(ve);const He=typeof be.total=="number"?be.total:ve.length;ze(He);const mt={};ve.forEach(bt=>{bt.bookingId&&(mt[bt.bookingId]={level:bt._remarkLevel||String(bt.RemarkLevel||"").toLowerCase(),text:bt._remarkText||bt.RemarkText||""})}),De(mt);try{localStorage.setItem(Te,JSON.stringify({at:Date.now(),rows:ve,total:He}))}catch{}}}catch{j.error("Could not load bookings via Apps Script. Check Web App URL / access."),t||(h([]),ze(0))}finally{t||z(!1)}};a();const m=()=>a();return window.addEventListener("reload-bookings",m),()=>{t=!0}},[se,L,k,Re,X,w,Y,de]);const ge=ke.length?ke:d,Ne=o.useMemo(()=>{const a=["all",...xt(ge.map(b=>b.branch))];if(!["owner","admin","backend"].includes(y)&&R.length){const b=St(R);return a.filter(N=>N==="all"||b.has(te(N)))}return a},[ge,y,R]),Ge=o.useMemo(()=>["all",...xt(ge.map(t=>t.status))],[ge]),nt=o.useCallback(t=>{const a=St(R);return(t||[]).filter(b=>{if(a.size&&!["owner","admin","backend"].includes(y)&&!a.has(te(b.branch))||L!=="all"&&te(b.branch)!==te(L)||k!=="all"&&te(b.status)!==te(k))return!1;if(w&&w[0]&&w[1]){const N=w[0].startOf("day").valueOf(),B=w[1].endOf("day").valueOf(),V=b.tsMs??is(b.ts);if(!V||V<N||V>B)return!1}if(se){const N=se.toLowerCase();if(![b.bookingId,b.name,b.mobile,b.company,b.model,b.variant,b.color,b.chassis,b.branch].some(B=>String(B||"").toLowerCase().includes(N)))return!1}return!0}).slice().sort((b,N)=>(N.tsMs||0)-(b.tsMs||0))},[R,L,w,se,k,y]),yt=o.useMemo(()=>nt(d),[nt,d]);o.useEffect(()=>{xe(1),Pe(X)},[L,k,se,w]),o.useEffect(()=>{Pe(X)},[X]);const Et=o.useCallback(async()=>{if(!de)return d;const t={action:"list",page:1,pageSize:1e4},a={q:se||"",branch:L!=="all"?L:"",status:k!=="all"?k:""};w&&w[0]&&w[1]&&(a.start=w[0].startOf("day").valueOf(),a.end=w[1].endOf("day").valueOf());const m={...t,...a},b=await ot({webhookUrl:Y,method:"GET",payload:m}),N=b?.data||b;return(Array.isArray(N?.data)?N.data:[]).map((V,S)=>we(V,S)).filter(V=>V.bookingId||V.name||V.mobile)},[de,Y,le,L,w,se,we,k,d]),gt=async()=>{const t="export-bookings";j.loading({key:t,content:"Preparing CSVâ€¦",duration:0});try{const a=de?await Et():d,m=nt(a);if(!m.length){j.info({key:t,content:"No rows to export for current filters"});return}const b=[{key:"ts",label:"Submitted At"},{key:"bookingId",label:"Booking ID"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"status",label:"Status"},{key:"availability",label:"Stock Status"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"chassis",label:"Chassis"},{key:"fileUrl",label:"File URL"}],N=m.map(B=>({ts:B.ts,bookingId:B.bookingId,name:B.name,mobile:B.mobile,branch:B.branch,status:B.status,availability:bs(B.chassis,B.availability),company:B.company,model:B.model,variant:B.variant,chassis:B.chassis,fileUrl:B.fileUrl}));Gt({filename:"bookings.csv",headers:b,rows:N}),j.success({key:t,content:`Exported ${N.length} bookings`})}catch{j.error({key:t,content:"Export failed. Please try again."})}},Xt=120*1e3,Kt=o.useMemo(()=>{const t=["owner","admin","backend"].includes(y);return L!=="all"?L:!t&&R.length===1?R[0]:""},[R,L,y]),_t=o.useMemo(()=>St(i),[i]),Mt=o.useMemo(()=>L!=="all"?St([L]):!["owner","admin","backend"].includes(y)&&R.length?St(R):null,[R,L,y]),Wt=o.useCallback(t=>{const a=te(t?.sourceBranch||t?.branch||"");if(!a||_t.size&&!_t.has(a)||Mt&&Mt.size&&!Mt.has(a))return!1;const m=String(t?.status||"").toLowerCase();return!(m&&m!=="in_stock"&&m!=="in stock")},[_t,Mt]),Ht=o.useCallback(async(t=!1)=>{if(ft)return;const a=Kt||"";if(!(!t&&Ke.length>0&&Date.now()-Tt<Xt&&it===a)){At(!0);try{const b=await ka({branch:a||void 0,limit:2e3}),N=Array.isArray(b?.data)?b.data:[];Fe(N),kt(Date.now()),ct(a)}catch{j.error("Could not load stock list.")}finally{At(!1)}}},[ft,Ke.length,Tt,it,Kt]),Ys={pending:"gold",seen:"blue",approved:"green",allotted:"purple",cancelled:"red"},bs=t=>!!String(t||"").trim()?"In Stock":"To be allotted",Js=t=>t==="In Stock"?"green":"volcano",wt=async(t,a,m)=>{let b=!1;try{J(t);const B="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",V="",S=a||{},K={...S};S.invoiceStatus&&(K["Invoice Status"]=S.invoiceStatus),(S.invoiceFileUrl||S.invoiceFile)&&(K["Invoice File URL"]=S.invoiceFileUrl||S.invoiceFile),S.insuranceStatus&&(K["Insurance Status"]=S.insuranceStatus),(S.insuranceFileUrl||S.insuranceFile)&&(K["Insurance File URL"]=S.insuranceFileUrl||S.insuranceFile),S.rtoStatus&&(K["RTO Status"]=S.rtoStatus),(S.vehicleNo||S.regNo)&&(K["Vehicle No"]=S.vehicleNo||S.regNo),S.status&&(K.Status=S.status),await ot({webhookUrl:B,method:"POST",payload:V?{action:"update",bookingId:t,mobile:m,patch:K,secret:V}:{action:"update",bookingId:t,mobile:m,patch:K}}),h(be=>be.map(Oe=>{if(Oe.bookingId!==t)return Oe;const ve={...Oe};return a.status&&(ve.status=String(a.status).toLowerCase()),a.invoiceStatus&&(ve.invoiceStatus=a.invoiceStatus),(a.invoiceFileUrl||a.invoiceFile)&&(ve.invoiceFileUrl=a.invoiceFileUrl||a.invoiceFile),a.insuranceStatus&&(ve.insuranceStatus=a.insuranceStatus),(a.insuranceFileUrl||a.insuranceFile)&&(ve.insuranceFileUrl=a.insuranceFileUrl||a.insuranceFile),a.rtoStatus&&(ve.rtoStatus=a.rtoStatus),(a.vehicleNo||a.regNo)&&(ve.vehicleNo=a.vehicleNo||a.regNo),Object.prototype.hasOwnProperty.call(a,"chassis")&&(ve.chassis=a.chassis),Object.prototype.hasOwnProperty.call(a,"chassisNo")&&(ve.chassis=a.chassisNo),ve._raw={...Oe._raw||{},...a},ve})),j.success("Updated"),b=!0}catch{j.error("Update failed"),b=!1}finally{J(null)}return b},Zs=async t=>{const m="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",b="",N=new FormData;N.append("action","upload");const B=t?.originFileObj||t;N.append("file",B,t?.name||B?.name||"document.pdf");try{const S=await(await fetch(m,{method:"POST",body:N,credentials:"omit"})).json().catch(()=>({}));if(S&&(S.ok||S.success))return S;throw new Error("Upload failed")}catch(V){try{const S=await new Promise((ve,He)=>{const mt=new FileReader,bt=t?.originFileObj||t;mt.onload=()=>{const rs=String(mt.result||""),Ns=rs.indexOf(",");ve(Ns>=0?rs.slice(Ns+1):rs)},mt.onerror=He,mt.readAsDataURL(bt)}),K=b?{action:"upload_base64",name:t?.name||"document.pdf",base64:S,secret:b}:{action:"upload_base64",name:t?.name||"document.pdf",base64:S},be=await ot({webhookUrl:m,method:"POST",payload:K}),Oe=be?.data||be;if(Oe&&(Oe.ok||Oe.success))return Oe}catch{}throw V}},Xs=t=>t.type==="application/pdf"||(t.name||"").toLowerCase().endsWith(".pdf")?(t.size||0)<=10*1024*1024?!1:(j.error("File must be <= 5MB"),ls.LIST_IGNORE):(j.error("Only PDF files allowed"),ls.LIST_IGNORE),ea=async(t,a)=>{a==="received"?v({open:!0,type:"invoice",row:t,fileList:[],loading:!1}):await wt(t.bookingId,{invoiceStatus:a},t.mobile)},ta=async(t,a)=>{a==="received"?v({open:!0,type:"insurance",row:t,fileList:[],loading:!1}):await wt(t.bookingId,{insuranceStatus:a},t.mobile)},sa=async(t,a)=>{await wt(t.bookingId,{rtoStatus:a},t.mobile)},[xs,aa]=o.useState({}),vs=async t=>{const a=String(xs[t.bookingId]||"").trim(),m=Fs(a);if(!m){j.error("Enter vehicle number");return}if(!/^[A-Z]{2}\d{2}[A-Z]{2}\d{4}$/.test(m)){j.error("Use format KA55HY5666 (2 letters, 2 digits, 2 letters, 4 digits)");return}await wt(t.bookingId,{vehicleNo:m,regNo:m},t.mobile)},Ss=o.useCallback(t=>{if(!t)return[];const a=te(t.company),m=te(t.model),b=te(t.variant),N=te(t.color),B=new Set,V=[];return Ke.forEach(S=>{if(!Wt(S)||a&&te(S.company)!==a||m&&te(S.model)!==m||b&&te(S.variant)!==b||N&&te(S.color)!==N)return;const K=Je(S.chassisNo||S.chassis||"");if(!K||B.has(K))return;B.add(K);const be=[K],Oe=String(S.color||"").trim(),ve=String(S.sourceBranch||S.branch||"").trim();Oe&&be.push(Oe),ve&&be.push(ve),V.push({value:K,label:be.join(" - ")})}),V.sort((S,K)=>S.label.localeCompare(K.label))},[Ke,Wt]),ks=o.useCallback((t,a)=>{const m=Je(a);if(!m||!t)return null;const b=te(t.company),N=te(t.model),B=te(t.variant),V=te(t.color);return Ke.find(S=>!(!Wt(S)||Je(S.chassisNo||S.chassis||"")!==m||b&&te(S.company)!==b||N&&te(S.model)!==N||B&&te(S.variant)!==B||V&&te(S.color)!==V))||null},[Ke,Wt]);o.useEffect(()=>{if(!Ve.open||!Ve.row)return;const t=Ve.row,a=t.bookingId?`Booking ID ${t.bookingId}`:"";s.setFieldsValue({company:t.company||"",model:t.model||"",variant:t.variant||"",color:t.color||"",sourceBranch:t.branch||"",chassis:"",notes:a?`Added for ${a}`:""}),u(""),Ht()},[Ve.open,Ve.row,Ht,s]);const es=t=>{if(!t?.bookingId){j.warning("Booking ID missing for this row.");return}et(null),vt(""),ut({open:!0,row:t})},ws=()=>{p||I||(ut({open:!1,row:null}),u(""),s.resetFields())},na=t=>{if(!t?.bookingId){j.warning("Booking ID missing for this row.");return}if(!t?.chassis){es(t);return}et(t.bookingId),vt(Je(t?.chassis||"")),Ht()},js=()=>{tt||(et(null),vt(""))},ts=async(t,a,m={})=>{if(!t?.bookingId)return!1;const b=Je(a);if(!b)return j.error("Select a chassis from stock to assign."),!1;const N=m?.matchedOverride||ks(t,b);if(!N)return j.error("Chassis not found in stock. Add stock movement first."),!1;if(!await wt(t.bookingId,{chassis:b},t.mobile))return!1;if(N&&b){const V=r?.name||r?.email||"user",S={Chassis_No:b,Company:N.company||t.company||"",Model:N.model||t.model||"",Variant:N.variant||t.variant||"",Color:N.color||t.color||"",Action:"invoice",Customer_Name:t.name||"",Source_Branch:N.sourceBranch||N.branch||"",Notes:t.bookingId?`Allotted to Booking ID ${t.bookingId}`:"Allotted from bookings"};try{const K=await Ls({data:S,createdBy:V});!!(K?.success??K?.ok)?Fe(Oe=>Oe.filter(ve=>Je(ve.chassisNo||ve.chassis||"")!==b)):j.error(K?.message||"Saved booking but failed to update stock.")}catch{j.error("Saved booking but failed to update stock.")}}return!0},ss=async()=>{if(!Ve.row||p)return;T(!0);const t=await ts(Ve.row,It);T(!1),t&&(ut({open:!1,row:null}),u(""),s.resetFields())},oa=async()=>{if(!Ve.row||I||p)return;if(Je(s.getFieldValue("chassis"))){await ra();return}if(Je(It)){await ss();return}j.warning("Enter chassis number or pick from stock.")},ra=async()=>{if(!Ve.row||I)return;let t=!1;try{const a=await s.validateFields();C(!0);const m=Ve.row,b=Je(a.chassis),N=m.bookingId?`Booking ID ${m.bookingId}`:"",B=String(a.notes||"").trim(),V=N?B?`${B} | ${N}`:N:B,S={Chassis_No:b,Company:a.company||m.company||"",Model:a.model||m.model||"",Variant:a.variant||m.variant||"",Color:a.color||m.color||"",Action:"add",Source_Branch:a.sourceBranch||m.branch||"",Notes:V},K=r?.name||r?.email||"user",be=await Ls({data:S,createdBy:K});if(!!(be?.success??be?.ok)){const ve={chassisNo:b,company:S.Company||m.company||"",model:S.Model||m.model||"",variant:S.Variant||m.variant||"",color:S.Color||m.color||"",sourceBranch:S.Source_Branch||m.branch||"",status:"in_stock"};await ts(m,b,{matchedOverride:ve})?(j.success("Stock movement saved and chassis assigned."),t=!0):(j.warning("Stock movement saved. Assign chassis from stock below."),Ht(!0),u(b))}else j.error(be?.message||"Failed to save stock movement.")}catch(a){if(a?.errorFields)return;const m=a?.response?.data?.message||a?.message;j.error(m||"Failed to save stock movement.")}finally{C(!1),t&&ws()}},Cs=async t=>{if(!t?.bookingId||tt)return;const a=Je(qe),m=Je(t?.chassis||"");if(a===m){js();return}We(!0);const b=await ts(t,a);We(!1),b&&(et(null),vt(""))},as={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},Ft={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},la={...Ft,fontSize:11},ns={whiteSpace:"normal"},ia=t=>{const a=Ue().format("DD-MM-YYYY HH:mm"),m=String(t||"").trim();return m?`${a} - ${m}`:a},Me=Ve.row,Rs=Me?[Me.company,Me.model,Me.variant,Me.color].filter(Boolean).join(" "):"",As=Me?xt([Me.branch,...i].filter(Boolean)):i;let Qt=[{title:"Date / Branch",key:"dateBranch",width:130,render:(t,a)=>{const m=is(a.ts),b=m?Ue(m).format("DD-MM-YYYY HH:mm"):"â€”";return e.jsxs("div",{style:as,children:[e.jsx("div",{style:Ft,children:b}),e.jsx("div",{style:Ft,children:e.jsx(Ot,{type:"secondary",children:a.branch||"â€”"})})]})}},{title:"Customer / Mobile / Model / File",key:"customerVehicleFile",width:240,render:(t,a)=>{const m=String(a.model||"").trim()||"â€”",b=String(a.variant||"").trim()||"â€”",N=String(a.color||"").trim(),B=[m,b,N].filter(Boolean).join(" || ")||"â€”";return e.jsxs("div",{style:as,children:[e.jsx("div",{style:Ft,children:a.name||"â€”"}),e.jsx("div",{style:Ft,children:e.jsx(Ot,{type:"secondary",children:a.mobile||"â€”"})}),e.jsx("div",{style:la,children:B}),e.jsx("div",{style:ns,children:e.jsxs(ue,{size:6,wrap:!0,children:[e.jsx(Ba,{url:a.fileUrl}),e.jsx(G,{size:"small",type:"primary",onClick:()=>pe({open:!0,row:a}),title:"Print","aria-label":"Print",children:"ðŸ–¨ï¸"}),e.jsx(G,{size:"small",onClick:()=>Le({open:!0,row:a}),title:"View details","aria-label":"View details",children:"ðŸ‘ï¸"})]})})]})}},{title:"Chassis / Stk Status + Actions",key:"chassisStock",width:210,render:(t,a)=>{if(dt===a.bookingId){const V=Ss(a),S=ks(a,qe);return e.jsxs(ue,{direction:"vertical",size:4,children:[e.jsxs(ue,{size:6,align:"center",wrap:!0,children:[e.jsx(Ms,{value:qe,options:V,allowClear:!0,style:{width:200},placeholder:ft?"Loading stock...":"Pick chassis from stock",disabled:tt,onChange:K=>vt(Je(K)),onKeyDown:K=>{K.key==="Enter"&&(K.preventDefault(),Cs(a))},filterOption:(K,be)=>String(be?.value||"").toLowerCase().includes(String(K||"").toLowerCase())||String(be?.label||"").toLowerCase().includes(String(K||"").toLowerCase())}),e.jsx(G,{size:"small",type:"primary",loading:tt,onClick:()=>Cs(a),children:"Save"}),e.jsx(G,{size:"small",disabled:tt,onClick:js,children:"Cancel"})]}),e.jsx(Ot,{type:"secondary",children:S?`In stock at ${S.sourceBranch||S.branch||"branch"} - will be allotted on save.`:V.length?"Pick from stock list to allot. If missing, add stock movement first.":"No stock for this model in current branches. Add stock movement first."})]})}const b=bs(a.chassis,a.availability),N=String(a.status||"pending").replace(/_/g," "),B=!a.chassis;return e.jsxs("div",{style:as,children:[e.jsx("div",{style:ns,children:e.jsxs(ue,{size:6,align:"center",wrap:!0,children:[e.jsx("span",{style:{fontFamily:"ui-monospace, SFMono-Regular, Menlo, monospace",cursor:"pointer"},title:B?"Assign chassis":"Edit chassis",onClick:()=>B?es(a):na(a),children:a.chassis||"-"}),B?e.jsx(G,{size:"small",type:"link",onClick:()=>es(a),children:"Assign"}):null]})}),e.jsx("div",{style:ns,children:e.jsxs(ue,{size:6,wrap:!0,children:[e.jsx(me,{color:Js(b),children:b}),e.jsx(me,{color:Ys[String(a.status||"").toLowerCase()]||"default",children:N})]})})]})}}];Qt.push({title:"More",key:"more",width:200,render:(t,a)=>e.jsxs(ue,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsx(he,{size:"small",placeholder:"Invoice",style:{width:"100%"},onChange:m=>ea(a,m),options:[{value:"submit_to_dealer",label:"Submit to dealer"},{value:"pending_by_dealer",label:"Pending by dealer"},{value:"received",label:"Received (upload)"}]}),e.jsx(he,{size:"small",placeholder:"Insurance",style:{width:"100%"},onChange:m=>ta(a,m),options:[{value:"sent",label:"Sent insurance"},{value:"received",label:"Received (upload)"}]}),e.jsx(he,{size:"small",placeholder:"RTO status",style:{width:"100%"},onChange:m=>sa(a,m),options:[{value:"finance_otp_pending",label:"Finance Payment pending"},{value:"customer_otp_taken",label:"Customer OTP Pending"},{value:"registration_done",label:"Registration done"}]}),e.jsxs(ue,{size:6,align:"center",children:[e.jsx(Z,{size:"small",placeholder:"KA55HY5666",style:{width:120},value:xs[a.bookingId]??(a.vehicleNo||""),onChange:m=>aa(b=>({...b,[a.bookingId]:Fs(m.target.value)})),onPressEnter:()=>vs(a)}),e.jsx(G,{size:"small",onClick:()=>vs(a),children:"Save"})]})]})}),Qt.push({title:"Progress",key:"progress",width:120,render:(t,a)=>{const m=a._raw||{},b=m["Invoice Status"]||m.invoiceStatus||a.invoiceStatus||"",N=m["Invoice File URL"]||m.Invoice_File_URL||m.invoiceFileUrl||a.invoiceFileUrl||"",B=m["Insurance Status"]||m.insuranceStatus||a.insuranceStatus||"",V=m["Insurance File URL"]||m.Insurance_File_URL||m.insuranceFileUrl||a.insuranceFileUrl||"",S=m["RTO Status"]||m.rtoStatus||a.rtoStatus||"",K=m["Vehicle No"]||m.Vehicle_No||m.vehicleNo||a.vehicleNo||"",be={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:4,fontSize:11},children:[e.jsxs("div",{style:be,children:[e.jsx(me,{color:"geekblue",title:"Invoice",children:String(b||"-").replace(/_/g," ")}),N?e.jsx("a",{href:N,target:"_blank",rel:"noopener noreferrer",children:"ðŸ“Ž"}):null]}),e.jsxs("div",{style:be,children:[e.jsx(me,{color:"cyan",title:"Insurance",children:String(B||"-").replace(/_/g," ")}),V?e.jsx("a",{href:V,target:"_blank",rel:"noopener noreferrer",children:"ðŸ“Ž"}):null]}),e.jsx("div",{style:be,children:e.jsx(me,{title:"RTO",children:String(S||"-").replace(/_/g," ")})}),e.jsx("div",{style:be,children:e.jsx(me,{title:"Vehicle No",children:K||"-"})})]})}});const os=["backend","admin","owner"].includes(y);Qt.push({title:os?"Actions + Remarks":"Actions",key:"actions",width:os?210:170,render:(t,a)=>e.jsxs(ue,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsx(he,{size:"small",defaultValue:a.status||"pending",style:{width:"100%"},onChange:m=>wt(a.bookingId,{status:m},a.mobile),options:[{value:"pending",label:"Pending"},{value:"seen",label:"Seen"},{value:"approved",label:"Approved"},{value:"allotted",label:"Allotted"},{value:"cancelled",label:"Cancelled"}]}),os?e.jsxs(ue,{direction:"vertical",size:4,style:{width:"100%"},children:[e.jsxs(ue,{size:6,wrap:!0,children:[e.jsx(me,{color:Ie[a.bookingId]?.level==="alert"?"red":Ie[a.bookingId]?.level==="warning"?"gold":Ie[a.bookingId]?.level==="ok"?"green":"default",children:Ie[a.bookingId]?.level?String(Ie[a.bookingId].level).toUpperCase():"â€”"}),e.jsx(G,{size:"small",onClick:()=>Ae({open:!0,refId:a.bookingId,level:Ie[a.bookingId]?.level||"ok",text:Ie[a.bookingId]?.text||""}),children:"Remark"})]}),e.jsx(Ct,{title:Ie[a.bookingId]?.text?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:Ie[a.bookingId].text}):null,children:e.jsx("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:Ie[a.bookingId]?.text||"â€”"})})]}):null]})});const Ts=de?ee:d.length,Is=x?420:600,zt=de?yt:oe==="loadMore"?yt.slice(0,ye):yt,ca=o.useMemo(()=>{const t=Rt.length?Rt:nt(ke.length?ke:d),a=new Map;return(t||[]).forEach(m=>{const b=String(m.branch||"Unknown").trim()||"Unknown",N=te(b);a.has(N)||a.set(N,{key:N,branch:b,total:0});const B=a.get(N);B.total+=1}),Array.from(a.values()).sort((m,b)=>b.total-m.total)},[nt,ke,d,Rt]);return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:12,flexWrap:"wrap"},children:[e.jsxs(ue,{size:"small",wrap:!0,children:[e.jsx(he,{value:L,onChange:q,style:{minWidth:160},disabled:!["owner","admin","backend"].includes(y),options:Ne.map(t=>({value:t,label:t==="all"?"All Branches":t}))}),e.jsx(he,{value:k,onChange:$,style:{minWidth:160},options:Ge.map(t=>({value:t,label:t==="all"?"All Statuses":t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ")}))}),e.jsx(fs.RangePicker,{value:w,onChange:t=>{_(t),A(null)},allowClear:!0}),e.jsx(G,{size:"small",type:ce==="today"?"primary":"default",onClick:()=>{const t=Ue();_([t,t]),A("today")},children:"Today"}),e.jsx(G,{size:"small",type:ce==="yesterday"?"primary":"default",onClick:()=>{const t=Ue().subtract(1,"day");_([t,t]),A("yesterday")},children:"Yesterday"}),e.jsx(G,{size:"small",onClick:()=>{_(null),A(null)},children:"Clear"}),e.jsx(Z,{placeholder:"Search name/mobile/booking",allowClear:!0,value:ae,onChange:t=>E(t.target.value),style:{minWidth:220}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(ue,{children:[e.jsx(G,{type:"primary",onClick:()=>{O({open:!0}),(!i.length||!P.length)&&F()},children:"Booking Form"}),e.jsx(wa,{webhookUrl:Y}),e.jsxs(me,{color:"blue",children:["Total: ",Ts]}),e.jsxs(me,{color:"geekblue",children:["Showing: ",de||oe==="loadMore"?zt.length:yt.length,k!=="all"?` (status: ${k})`:""]}),!de&&e.jsx(he,{size:"small",value:oe,onChange:t=>{Se(t),Pe(X)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(G,{onClick:gt,children:"Export CSV"}),e.jsx(G,{loading:U,onClick:()=>{const t=new Event("reload-bookings");window.dispatchEvent(t)},children:"Refresh"})]})]}),e.jsxs(Pt,{gutter:[12,12],style:{marginBottom:12},children:[Lt?e.jsx(ne,{xs:24,children:e.jsx(me,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,ca.map(t=>e.jsx(ne,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ys,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:t.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:t.total})]})})},t.key))]}),e.jsx(Bt,{dataSource:zt,columns:Qt,loading:U&&!$e,size:"small",className:"compact-table",tableLayout:x?"auto":"fixed",pagination:de?{current:Re,pageSize:X,total:Ts,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(t,a)=>{xe(t),a!==X&&je(a)},showTotal:(t,a)=>`${a[0]}-${a[1]} of ${t}`}:oe==="pagination"?{current:Re,pageSize:X,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(t,a)=>{xe(t),a!==X&&je(a)},showTotal:(t,a)=>`${a[0]}-${a[1]} of ${t}`}:!1,rowKey:t=>`${t.bookingId}-${t.mobile}-${t.ts}-${t.key}`,scroll:x?{x:"max-content",y:Is}:{y:Is}}),!de&&oe==="loadMore"&&zt.length<yt.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(G,{onClick:()=>Pe(t=>Math.min(t+X,yt.length)),children:["Load more (",yt.length-zt.length," more)"]})}):null,e.jsx(rt,{open:c.open,onCancel:()=>O({open:!1}),footer:null,width:1040,destroyOnClose:!0,title:"New Booking",bodyStyle:{paddingTop:8},children:e.jsx(Ks,{allowBranchSelect:!0,allowExecutiveSelect:!0,branchOptions:i,executiveOptions:P,branchOptionsLoading:_e,executiveOptionsLoading:_e,onSuccess:()=>{O({open:!1});try{window.dispatchEvent(new Event("reload-bookings"))}catch{}}})}),e.jsx(ja,{open:D.open,onClose:()=>pe({open:!1,row:null}),row:D.row,webhookUrl:Y,secret:le}),e.jsx(Ma,{open:fe.open,onClose:()=>Le({open:!1,row:null}),row:fe.row,webhookUrl:Y}),e.jsxs(rt,{open:Ve.open,title:Me?`New Stock Movement â€“ ${Me.bookingId||Me.name||""}`:"New Stock Movement",onCancel:ws,footer:null,width:760,destroyOnClose:!0,maskClosable:!p&&!I,closable:!p&&!I,children:[Me?e.jsxs("div",{style:{marginBottom:12},children:[e.jsxs("div",{style:{fontWeight:600},children:[Me.name||"Customer",Me.mobile?` â€¢ ${Me.mobile}`:""]}),e.jsxs("div",{style:{color:"#6b7280"},children:[Me.branch||"â€”",Rs?` â€¢ ${Rs}`:""]}),Me.bookingId?e.jsxs("div",{style:{color:"#6b7280"},children:["Booking ID: ",Me.bookingId]}):null]}):null,e.jsx(Es,{orientation:"left",style:{marginTop:0},children:"New Stock Movement"}),e.jsxs(H,{form:s,layout:"vertical",children:[e.jsxs(Pt,{gutter:[12,8],children:[e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"company",label:"Company",children:e.jsx(Z,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"model",label:"Model",children:e.jsx(Z,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"variant",label:"Variant",children:e.jsx(Z,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"color",label:"Color",children:e.jsx(Z,{disabled:!0})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"sourceBranch",label:"Source Branch",rules:[{required:!0,message:"Source branch is required"}],children:As.length?e.jsx(he,{showSearch:!0,optionFilterProp:"label",placeholder:"Select branch",options:As.map(t=>({label:t,value:t}))}):e.jsx(Z,{placeholder:"Enter source branch"})})}),e.jsx(ne,{xs:24,md:12,children:e.jsx(H.Item,{name:"chassis",label:"Chassis No.",rules:[{required:!0,message:"Chassis number is required"}],children:e.jsx(Z,{placeholder:"Enter chassis number",onChange:t=>s.setFieldsValue({chassis:Je(t.target.value)})})})})]}),e.jsx(H.Item,{name:"notes",label:"Notes",children:e.jsx(Z.TextArea,{rows:2,placeholder:"Optional notes"})}),e.jsxs(ue,{children:[e.jsx(G,{type:"primary",onClick:oa,loading:I||p,disabled:!Me,children:"Save & Assign"}),e.jsx(Ot,{type:"secondary",children:"Type chassis above or pick from stock below."})]})]}),e.jsx(Es,{orientation:"left",children:"Assign from Stock"}),e.jsxs(ue,{direction:"vertical",size:8,style:{width:"100%"},children:[e.jsx(Ms,{value:It,options:Me?Ss(Me):[],allowClear:!0,style:{width:"100%"},placeholder:ft?"Loading stock...":"Pick chassis from stock",disabled:p,onChange:t=>u(Je(t)),onKeyDown:t=>{t.key==="Enter"&&(t.preventDefault(),ss())},filterOption:(t,a)=>String(a?.value||"").toLowerCase().includes(String(t||"").toLowerCase())||String(a?.label||"").toLowerCase().includes(String(t||"").toLowerCase())}),e.jsxs(ue,{children:[e.jsx(G,{type:"primary",onClick:ss,loading:p,disabled:!Me,children:"Assign Chassis"}),e.jsx(Ot,{type:"secondary",children:"Only chassis from stock list can be assigned."})]})]})]}),e.jsx(rt,{open:Ee.open,title:`Update Remark: ${Ee.refId}`,onCancel:()=>Ae({open:!1,refId:"",level:"ok",text:""}),onOk:()=>{const{refId:t,level:a,text:m}=Ee,b=ia(m),N=Ie[t],B=d.find(V=>V.bookingId===t);De(V=>({...V,[t]:{level:a,text:b}})),h(V=>V.map(S=>S.bookingId===t?{...S,RemarkLevel:a.toUpperCase(),RemarkText:b,_remarkLevel:a,_remarkText:b}:S)),Ae({open:!1,refId:"",level:"ok",text:""}),(async()=>{try{const S=await ot({webhookUrl:Y,method:"POST",payload:le?{action:"remark",bookingId:t,level:a,text:b,secret:le}:{action:"remark",bookingId:t,level:a,text:b}}),K=S?.data||S;if(!(K&&(K.ok||K.success)))throw new Error("Save failed");j.success("Remark saved to sheet")}catch{De(V=>{const S={...V};return N?S[t]=N:delete S[t],S}),B&&h(V=>V.map(S=>S.bookingId===t?B:S)),j.error("Save failed")}})()},children:e.jsxs(ue,{direction:"vertical",style:{width:"100%"},children:[e.jsx(he,{value:Ee.level,onChange:t=>Ae(a=>({...a,level:t})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(Z,{maxLength:140,showCount:!0,value:Ee.text,onChange:t=>Ae(a=>({...a,text:t.target.value})),placeholder:"Short note (optional)"})]})}),e.jsx(rt,{open:l.open,title:`${l.type==="invoice"?"Invoice":"Insurance"} â€“ Upload file`,onCancel:()=>v({open:!1,type:"",row:null,fileList:[],loading:!1}),confirmLoading:l.loading,okText:l.loading?"Savingâ€¦":"Save",cancelButtonProps:{disabled:l.loading},maskClosable:!l.loading,onOk:async()=>{if(l.loading)return;if(!l.row){v({open:!1,type:"",row:null,fileList:[],loading:!1});return}const t=(l.fileList||[])[0];if(!t){j.error("Please select a PDF file");return}v(m=>({...m,loading:!0}));const a="upload-progress";j.loading({key:a,content:"Uploading and savingâ€¦",duration:0}),setTimeout(async()=>{try{const m=await Zs(t),b=m?.url||m?.downloadUrl||"";if(!b){j.error({key:a,content:"Upload failed"}),v(N=>({...N,loading:!1}));return}l.type==="invoice"?await wt(l.row.bookingId,{invoiceStatus:"received",invoiceFileUrl:b},l.row.mobile):l.type==="insurance"&&await wt(l.row.bookingId,{insuranceStatus:"received",insuranceFileUrl:b},l.row.mobile),j.success({key:a,content:"Saved successfully"}),v({open:!1,type:"",row:null,fileList:[],loading:!1})}catch{j.error({key:a,content:"Could not upload file"}),v(m=>({...m,loading:!1}))}},0)},children:e.jsx(ls.Dragger,{multiple:!1,beforeUpload:Xs,accept:".pdf",fileList:l.fileList,maxCount:1,disabled:l.loading,onChange:({fileList:t})=>v(a=>({...a,fileList:t.slice(0,1)})),itemRender:t=>t,children:e.jsx("p",{children:"Drop PDF here or click to select (max 5MB, PDF only)"})})})]})}function is(n){if(!n)return null;if(n instanceof Date)return n.getTime();if(typeof n=="number")return n;const x=String(n).trim(),d=new Date(x);if(!isNaN(d.getTime()))return d.getTime();const h=x.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(h){const U=h[2];let z=parseInt(h[1],10),L=parseInt(h[3],10),q=parseInt(h[4],10);q<100&&(q+=2e3);let k,$;U==="-"||z>12?($=z,k=L-1):(k=z-1,$=L);let w=h[5]?parseInt(h[5],10):0;const _=h[6]?parseInt(h[6],10):0,ce=h[7]?parseInt(h[7],10):0,A=(h[8]||"").toUpperCase();A==="PM"&&w<12&&(w+=12),A==="AM"&&w===12&&(w=0);const J=new Date(q,k,$,w,_,ce);if(!isNaN(J.getTime()))return J.getTime()}return null}function Pa(n){try{if(!n)return null;const x=new URL(n);if(x.searchParams.get("id"))return x.searchParams.get("id");const d=x.pathname.match(/\/d\/([^/]+)/);return d&&d[1]?d[1]:null}catch{const x=String(n||"").match(/[?&]id=([^&]+)/);return x?x[1]:null}}function Ua(n){if(!n)return{view:"",download:"",embed:""};const x=Pa(n);return x?{view:`https://drive.google.com/uc?export=view&id=${x}`,download:`https://drive.google.com/uc?export=download&id=${x}`,embed:`https://drive.google.com/file/d/${x}/preview`}:{view:n,download:n,embed:n}}function Je(n){return String(n||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,20)}function Fs(n){return String(n||"").toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,10)}function Ba({url:n}){if(!n)return e.jsx(Ot,{type:"secondary",children:"â€”"});const{view:x,download:d,embed:h}=Ua(n),U=e.jsxs("div",{style:{width:340},children:[e.jsx("div",{style:{height:260,border:"1px solid #e5e7eb",borderRadius:8,overflow:"hidden",marginBottom:8},children:e.jsx("iframe",{src:h,title:"preview",width:"100%",height:"100%",style:{display:"block",border:0},allow:"fullscreen"})}),e.jsxs(ue,{children:[e.jsx("a",{href:x,target:"_blank",rel:"noopener",children:"Open"}),e.jsx("a",{href:d,children:"Download"})]})]});return e.jsxs(ue,{size:6,children:[e.jsx(Ws,{content:U,title:"Preview",trigger:"click",children:e.jsx(G,{size:"small",title:"Preview","aria-label":"Preview",children:"ðŸ”"})}),e.jsx("a",{href:d,title:"Download","aria-label":"Download",children:"â¬‡ï¸"})]})}const{Text:us}=Zt,Ze={ts:["Timestamp","Time","Date"],name:["Customer_Name","Customer","Name"],mobile:["Mobile","Phone","Mobile Number"],branch:["Branch"],executive:["Executive","Executive_Name","Executive Name"],serialNo:["Quotation No.","Quotation No","Serial","Serial No","Quote Id","Quotation_ID","Quotation ID"],company:["Company"],model:["Model","Bike Model"],variant:["Variant"],price:["On-Road Price","On Road Price","Price"],offerings:["Offerings","Remarks","Remark","Quotation Remarks"],payload:["Payload"],status:["Status","FollowUp Status","Quotation Status"],followUpNotes:["Follow-up Notes","Follow Up Notes","Followup Notes","Notes"]},st=(n,x)=>String(x.map(d=>n[d]??"").find(d=>d!=="")||"").trim(),zs=typeof Intl<"u"?new Intl.NumberFormat("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2}):null,qt=n=>{if(n==null||Number.isNaN(Number(n)))return"â€”";const x=Number(n),d=zs?zs.format(Math.abs(x)):String(Math.abs(x));return`${x<0?"-":""}â‚¹${d}`},_a=9,Fa=11,za=8e3,Da=(n,x)=>{const d=Number(n||0),h=Number(x||0);return(d>0?h/d:0)>=.3?_a:Fa},$a=(n,x,d)=>{const U=Math.max(Number(n||0)-Number(x||0),0)+za,z=d/12,L=Da(n,x),q=U*(L/100)*z,k=U+q;return d>0?k/d:0},Va=n=>String(n||"")==="12"?[12,18,24,36]:[24,30,36,48],Hs=(n,x,d)=>{const h=Va(d);if(!Number(n||0))return"";const U=h.map(z=>`${z}:${qt($a(n,x,z))}`);return U.length?`EMI(${d||"12"}): ${U.join(" | ")}`:""},qa=n=>String(n||"").trim().toLowerCase(),Qs=n=>["loan","nohp","hp","finance"].includes(qa(n)),Ga=({payload:n,baseOfferings:x})=>{const d=String(x||"").trim();if(!n||typeof n!="object")return d;const h=n.formValues||{},U=Array.isArray(n.extraVehicles)?n.extraVehicles:[],z=h.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType??"cash",L=[],q=(k,$,w,_,ce)=>{const A=Number($||0),J=Number(w||0);if(!(A||J))return;const D=Qs(ce??z),pe=[];A&&pe.push(`Price ${qt(A)}`),D&&J&&pe.push(`DP ${qt(J)}`);const fe=D?Hs(A,J,_||n.emiSet||"12"):"";D&&fe&&pe.push(fe),L.push(`${k}: ${pe.join(" | ")}`)};return q("V1",h.onRoadPrice??n.onRoadPrice,h.downPayment??n.downPayment,n.emiSet,h.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType),U.forEach((k,$)=>{q(`V${$+2}`,k.onRoadPrice,k.downPayment,k.emiSet||n.emiSet,k.mode??k.purchaseMode??k.purchaseType??k.paymentType)}),[d,...L].filter(Boolean).join(" â€¢ ")},Ds=(n=[])=>Array.from(new Set((Array.isArray(n)?n:[]).map(x=>String(x||"").trim()).filter(Boolean))),Ka=({payload:n,baseOfferings:x,fallbackText:d,fallbackCompany:h,fallbackModel:U,fallbackVariant:z})=>{const L=String(x||"").trim(),q=[];if(n&&typeof n=="object"){const k=n.formValues||{},$=Ds(n.fittings),w=k.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType??"cash",_=({label:A,company:J,model:D,variant:pe,priceRaw:fe,dpRaw:Le,emiSetRaw:ae,fittingsRaw:E,modeRaw:se})=>{const Re=String(J||"").trim(),xe=String(D||"").trim(),X=String(pe||"").trim(),je=Number(fe||0),oe=Number(Le||0),Se=Ds(E||$),ye=[Re,xe,X].filter(Boolean).join(" "),Pe=!!(ye||Se.length||je||oe),ee=Qs(se??w);Pe&&q.push({label:A,title:ye||"Vehicle details not available",priceText:je?qt(je):"â€”",dpText:oe?qt(oe):"â€”",emiText:ee&&je?Hs(je,oe,ae||n.emiSet||"12"):"",fittings:Se,showFinance:ee})};_({label:"Vehicle 1",company:k.company??n.company??h,model:k.bikeModel??k.model??n.model??U,variant:k.variant??n.variant??z,priceRaw:k.onRoadPrice??n.onRoadPrice,dpRaw:k.downPayment??n.downPayment,emiSetRaw:n.emiSet,fittingsRaw:n.fittings,modeRaw:k.mode??n.mode??n.purchaseMode??n.purchaseType??n.paymentType}),(Array.isArray(n.extraVehicles)?n.extraVehicles:[]).forEach((A,J)=>{_({label:`Vehicle ${J+2}`,company:A.company,model:A.model,variant:A.variant,priceRaw:A.onRoadPrice,dpRaw:A.downPayment,emiSetRaw:A.emiSet||n.emiSet,fittingsRaw:A.fittings,modeRaw:A.mode??A.purchaseMode??A.purchaseType??A.paymentType})})}return!q.length&&d&&String(d).split("â€¢").map($=>$.trim()).filter(Boolean).forEach($=>{const w=$.match(/^V(\d+)\s*:\s*(.+)$/i);w&&q.push({label:`Vehicle ${w[1]}`,title:w[2],priceText:"â€”",dpText:"â€”",emiText:"",fittings:[],showFinance:!1})}),{remarks:L,vehicles:q}};function In(){const x=!Ut.useBreakpoint().md,d=qs(),[h,U]=o.useState([]),[z,L]=o.useState(!1),[q,k]=o.useState(!1),[$,w]=o.useState([]),[_,ce]=o.useState("all"),[A,J]=o.useState("all"),[D,pe]=o.useState("all"),[fe,Le]=o.useState(""),ae=gs(fe,300),[E,se]=o.useState(()=>[Ue().startOf("month"),Ue()]),[Re,xe]=o.useState(null),[X,je]=o.useState(""),[oe,Se]=o.useState([]),[ye,Pe]=o.useState(1),[ee,ze]=o.useState(25),[de,Ie]=o.useState("pagination"),[De,Ee]=o.useState(25),[Ae,$e]=o.useState(0),Q="true".toLowerCase()==="true",[l,v]=o.useState({}),[c,O]=o.useState({open:!1,refId:"",level:"ok",text:""}),[i,M]=o.useState(!1),[P,Ce]=o.useState([]);o.useEffect(()=>{try{const u=localStorage.getItem("user");if(!u)return;const p=JSON.parse(u);je(String(p?.role||"").toLowerCase());const T=[],I=p?.formDefaults?.branchName||p?.primaryBranch?.name||"";I&&T.push(I),Array.isArray(p?.branches)&&p.branches.forEach(C=>{const s=typeof C=="string"?C:C?.name||"";s&&T.push(s)}),Se(Array.from(new Set(T.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(X)&&oe.length&&_==="all"&&ce(oe[0])},[X,oe,_]);const _e=(()=>{const u=E&&E[0]?E[0].startOf("day").valueOf():"",p=E&&E[1]?E[1].endOf("day").valueOf():"";return`Quotations:list:${JSON.stringify({branchFilter:_,modeFilter:A,statusFilter:D,q:ae||"",start:u,end:p,page:ye,pageSize:ee,USE_SERVER_PAG:Q})}`})(),Be=o.useMemo(()=>({GAS_URL:"https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",SECRET:""}),[]),ke=o.useCallback((u,p=0)=>{const T=u&&u.values?u.values:u,I=u&&u.payload?u.payload:(T?T[Ze.payload[0]]:void 0)||"";let C=null;try{C=typeof I=="object"?I:JSON.parse(String(I||"{}"))}catch{C=null}const s=C&&C.formValues?C.formValues:{},r=st(T,Ze.ts),f=String(s.createdAt||C&&(C.createdAt||C.created_at||C.createdOn||C.created_on||C.quoteCreatedAt||C.quotationCreatedAt)||T["Created At"]||T.CreatedAt||T["Quotation Created At"]||T["Quotation Created"]||T["Created Time"]||r||"").trim(),y=C&&C.mode||"",g=C&&C.followUp&&C.followUp.status||st(T,Ze.status)||"",R=C&&C.brand||"",W=s.company||st(T,Ze.company),F=s.bikeModel||s.model||st(T,Ze.model),ie=s.variant||st(T,Ze.variant),Y=String(s.onRoadPrice||st(T,Ze.price)||"").trim(),le=String(s.remarks||C&&C.remarks||st(T,Ze.offerings)||"").trim(),Te=Ga({payload:C,baseOfferings:le}),we=String(C&&C.followUp&&C.followUp.notes||C&&C.closeNotes||C&&C.followupNotes||C&&C.notes||st(T,Ze.followUpNotes)||"").trim(),ge=C&&C.remark&&C.remark.level||T.RemarkLevel||T.remarkLevel||"",Ne=C&&C.remark&&C.remark.text||T.RemarkText||T.remarkText||"",Ge=String(ge||"").toLowerCase();return{key:p,ts:f||r,tsMs:ms(f||r),name:s.name||st(T,Ze.name),mobile:s.mobile||st(T,Ze.mobile),branch:s.branch||st(T,Ze.branch),executive:s.executive||st(T,Ze.executive),serialNo:s.serialNo||st(T,Ze.serialNo),company:W,model:F,variant:ie,price:Y,offerings:Te,offeringsBase:le,payload:C,mode:y||C&&C.mode||"",brand:R,status:g,followUpNotes:we,RemarkLevel:ge||"",RemarkText:Ne||"",_remarkLevel:Ge,_remarkText:Ne||""}},[]);o.useEffect(()=>{try{const u=localStorage.getItem(_e);if(!u)return;const p=JSON.parse(u);p&&Array.isArray(p.rows)&&(U(p.rows),$e(typeof p.total=="number"?p.total:p.rows.length),M(!0))}catch{}},[_e]),o.useEffect(()=>{let u=!1;return(async()=>{try{const{GAS_URL:T,SECRET:I}=Be;if(!T)return;const s=await ot({webhookUrl:T,method:"GET",payload:I?{action:"list",page:1,pageSize:5e3,secret:I}:{action:"list",page:1,pageSize:5e3}}),r=s?.data||s;if(!r||!r.ok&&!r.success)return;const y=(Array.isArray(r.data)?r.data:Array.isArray(r.rows)?r.rows:[]).map((g,R)=>ke(g,R));u||Ce(y)}catch{}})(),()=>{u=!0}},[Be,ke]),o.useEffect(()=>{let u=!1;const p=async()=>{L(!0);try{const{GAS_URL:I,SECRET:C}=Be;if(!I){j.info("Quotations: Apps Script URL not configured â€” showing empty list."),u||(U([]),$e(0));return}const s={action:"list"},r={q:ae||"",branch:_!=="all"?_:"",mode:A!=="all"?A:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(r.start=E[0].startOf("day").valueOf(),r.end=E[1].endOf("day").valueOf());const f=Q?{...s,page:ye,pageSize:ee,...r,...C?{secret:C}:{}}:C?{...s,secret:C}:s,y=await ot({webhookUrl:I,method:"GET",payload:f}),g=y?.data||y;if(!g||!g.ok&&!g.success)throw new Error("Invalid response");const F=(Array.isArray(g.data)?g.data:Array.isArray(g.rows)?g.rows:[]).map((ie,Y)=>ke(ie,Y)).filter(ie=>ie.name||ie.mobile||ie.serialNo);if(!u){U(F);const ie=typeof g.total=="number"?g.total:F.length;$e(ie);const Y={};F.forEach(le=>{le.serialNo&&(Y[le.serialNo]={level:le._remarkLevel||void 0,text:le._remarkText||""})}),v(Y);try{localStorage.setItem(_e,JSON.stringify({at:Date.now(),rows:F,total:ie}))}catch{}}}catch{j.error("Could not load quotations via Apps Script. Check QUOTATION Web App URL / access."),u||(U([]),$e(0))}finally{u||L(!1)}};p();const T=()=>p();return window.addEventListener("reload-quotations",T),()=>{u=!0,window.removeEventListener("reload-quotations",T)}},[ae,_,A,D,ye,ee,E,Q]);const lt=P.length?P:h,Rt=o.useMemo(()=>{const p=["all",...xt(lt.map(I=>I.branch))];if(!["owner","admin","backend"].includes(X)&&oe.length){const I=St(oe);return p.filter(C=>C==="all"||I.has(te(C)))}return p},[lt,X,oe]),Nt=o.useMemo(()=>["all",...xt(lt.map(u=>u.mode))],[lt]),Lt=o.useMemo(()=>{const u=lt.map(p=>p.status).filter(p=>te(p)!=="lost");return["all",...xt(u)]},[lt]),pt=o.useCallback(u=>{const p=St(oe);return(u||[]).filter(I=>{const C=te(I.branch);if(p.size&&!["owner","admin","backend"].includes(X)&&!p.has(C)||_!=="all"&&C!==te(_)||A!=="all"&&te(I.mode)!==te(A)||D!=="all"&&te(I.status)!==te(D))return!1;if(E&&E[0]&&E[1]){const s=E[0].startOf("day").valueOf(),r=E[1].endOf("day").valueOf(),f=I.tsMs??ms(I.ts);if(!f||f<s||f>r)return!1}if(ae){const s=ae.toLowerCase();if(![I.name,I.mobile,I.serialNo,I.company,I.model,I.variant,I.branch,I.executive,I.status,I.followUpNotes].some(r=>String(r||"").toLowerCase().includes(s)))return!1}return!0}).slice().sort((I,C)=>(C.tsMs||0)-(I.tsMs||0))},[oe,_,E,ae,A,D,X]),Ke=o.useCallback(async()=>{if(!Q)return h;const{GAS_URL:u,SECRET:p}=Be;if(!u)return h;const T=100,I={q:ae||"",branch:_!=="all"?_:"",mode:A!=="all"?A:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(I.start=E[0].startOf("day").valueOf(),I.end=E[1].endOf("day").valueOf());const C=[],s=new Set;let r=1,f=200;for(;r<=f;){const y={action:"list",page:r,pageSize:T},g=p?{...y,...I,secret:p}:{...y,...I},R=await ot({webhookUrl:u,method:"GET",payload:g}),W=R?.data||R;typeof W?.total=="number"&&Number.isFinite(W.total)&&(f=Math.ceil(W.total/T));const F=Array.isArray(W?.data)?W.data:Array.isArray(W?.rows)?W.rows:[];if(!F.length)break;let ie=0;if(F.forEach(Y=>{const Te=String(Y?.values?.["Quotation No."]||Y?.values?.["Quotation No"]||Y?.values?.Serial||Y?.serialNo||Y?.["Quotation No."]||Y?.["Quotation No"]||Y?.Serial||"").trim()||JSON.stringify(Y);s.has(Te)||(s.add(Te),C.push(Y),ie+=1)}),ie===0||F.length<T)break;r+=1}return C.map((y,g)=>ke(y,g)).filter(y=>y.name||y.mobile||y.serialNo)},[Q,Be,_,E,ae,ke,A,h,D]),Fe=o.useMemo(()=>pt(h),[pt,h]);o.useEffect(()=>{let u=!1;return(async()=>{if(!Q){w(Fe);return}k(!0);try{const T=await Ke(),I=pt(T);u||w(I)}catch{u||w([])}finally{u||k(!1)}})(),()=>{u=!0}},[Q,Ke,pt,_,A,D,ae,E,X,oe]),o.useEffect(()=>{Pe(1),Ee(ee)},[_,A,D,ae,E]),o.useEffect(()=>{Ee(ee)},[ee]);const ft=async()=>{const u="export-quotations";j.loading({key:u,content:"Preparing CSVâ€¦",duration:0});try{const p=Q?await Ke():h,T=pt(p);if(!T.length){j.info({key:u,content:"No rows to export for current filters"});return}const I=[{key:"ts",label:"Timestamp"},{key:"serialNo",label:"Quotation No"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"executive",label:"Executive"},{key:"mode",label:"Mode"},{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"price",label:"On-Road Price"},{key:"status",label:"Status"},{key:"RemarkLevel",label:"Remark Level"},{key:"RemarkText",label:"Remark"}],C=T.map(s=>({ts:s.ts,serialNo:s.serialNo,name:s.name,mobile:s.mobile,branch:s.branch,executive:s.executive,mode:s.mode,company:s.company,model:s.model,variant:s.variant,price:s.price,status:s.status,RemarkLevel:s.RemarkLevel||s._remarkLevel,RemarkText:s.RemarkText||s._remarkText}));Gt({filename:"quotations.csv",headers:I,rows:C}),j.success({key:u,content:`Exported ${C.length} quotations`})}catch{j.error({key:u,content:"Export failed. Please try again."})}},At=u=>{const p=String(u||"").toLowerCase();return p==="converted"||p==="booked"||p==="completed"?"green":p==="pending"?"orange":p==="not_interested"?"default":p==="unreachable"?"volcano":p==="wrong_number"?"magenta":p==="purchased_elsewhere"?"geekblue":p==="no_response"?"gold":"default"},Tt=u=>{const p=String(u||"").trim();return p?p.toLowerCase()==="converted"?"Booked":p.replace(/_/g," "):"â€”"},kt=u=>{const p=Ue().format("DD-MM-YYYY HH:mm"),T=String(u||"").trim();return T?`${p} - ${T}`:p},it={display:"flex",flexDirection:"column",gap:2,lineHeight:1},ct={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},dt={...ct,fontSize:8},et={...ct,fontSize:10},qe={...ct,fontSize:9,lineHeight:1.1},vt={display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:x?3:4,overflow:"hidden",whiteSpace:"normal",fontSize:6,lineHeight:1},tt=[{title:"Time / Branch",key:"timeBranch",width:120,render:(u,p)=>e.jsxs("div",{style:it,children:[e.jsx("div",{style:et,children:Wa(p.ts)}),e.jsx("div",{style:et,children:e.jsx(us,{type:"secondary",style:{fontSize:"inherit"},children:p.branch||"â€”"})})]})},{title:"Customer / Mobile",key:"customerMobile",width:100,render:(u,p)=>e.jsxs("div",{style:it,children:[e.jsx("div",{style:et,children:p.name||"â€”"}),e.jsx("div",{style:et,children:e.jsx(us,{type:"secondary",style:{fontSize:"inherit"},children:p.mobile||"â€”"})})]})},{title:"Offerings",key:"offerings",width:280,render:(u,p)=>{const T=Ka({payload:p.payload,baseOfferings:p.offeringsBase,fallbackText:p.offerings,fallbackCompany:p.company,fallbackModel:p.model,fallbackVariant:p.variant}),I=T.vehicles.length,C=e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8,minWidth:360,maxWidth:520},children:[e.jsx("div",{style:{fontSize:13,fontWeight:800,color:"#1d4ed8"},children:I?`${I} Vehicle Offer${I>1?"s":""}`:"Offer Details"}),T.vehicles.length?T.vehicles.map(s=>e.jsxs("div",{style:{border:"1px solid #dbeafe",borderRadius:10,padding:8,background:"#f8fbff"},children:[e.jsx("div",{style:{fontSize:11,fontWeight:800,color:"#1e3a8a",textTransform:"uppercase",marginBottom:4},children:s.label}),e.jsx("div",{style:{fontSize:12,fontWeight:700,color:"#111827",marginBottom:4},children:s.title}),e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",fontSize:12,color:"#1f2937"},children:[e.jsxs("span",{children:[e.jsx("b",{children:"Price"}),": ",s.priceText]}),s.showFinance?e.jsxs("span",{children:[e.jsx("b",{children:"DP"}),": ",s.dpText]}):null]}),s.showFinance&&s.emiText?e.jsx("div",{style:{marginTop:4,fontSize:11,color:"#334155",lineHeight:1.3},children:s.emiText}):null,s.fittings.length?e.jsxs("div",{style:{marginTop:4,fontSize:11,color:"#334155",lineHeight:1.3},children:[e.jsx("b",{children:"Fittings"}),": ",s.fittings.join(", ")]}):null]},s.label)):e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:"No vehicle-wise offer added."})]});return e.jsx("div",{style:it,children:I?e.jsx(Ws,{content:C,trigger:["hover","click"],placement:"topLeft",children:e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:4},children:T.vehicles.map(s=>e.jsxs("div",{style:{...ct,fontSize:10.5,color:"#1f2937"},children:[e.jsxs("span",{style:{fontWeight:800,color:"#1d4ed8"},children:[s.label,":"]})," ",s.title]},s.label))})}):e.jsx("div",{style:vt,children:"No offering details"})})}},{title:"Status / Follow-up Notes",key:"statusNotes",width:150,render:(u,p)=>{const T=String(p.followUpNotes||"").trim();return e.jsxs("div",{style:it,children:[e.jsx("div",{style:ct,children:e.jsx(me,{color:At(p.status),children:Tt(p.status)})}),T?e.jsx(Ct,{title:e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:T}),placement:"topLeft",children:e.jsx("div",{style:dt,children:T})}):e.jsx("div",{style:dt})]})}},{title:"Mode / Executive",key:"vehicleMeta",width:120,render:(u,p)=>{const T=String(p.mode||"").trim().toUpperCase(),C=[String(p.executive||"").trim()||"â€”"].join(" || ");return e.jsxs("div",{style:it,children:[e.jsx("div",{style:{...qe,fontSize:10,fontWeight:700},children:T||"â€”"}),e.jsx("div",{style:qe,children:C})]})}}];["backend","admin","owner"].includes(X)&&tt.push({title:"Remarks / Remark Text",key:"remarks",width:240,render:(u,p)=>{const T=l[p.serialNo],I=String(T?.text||""),C=T?.level==="alert"?"red":T?.level==="warning"?"gold":T?.level==="ok"?"green":"default";return e.jsxs("div",{style:it,children:[e.jsx("div",{style:ct,children:e.jsxs(ue,{size:6,children:[e.jsx(me,{color:C,children:T?.level?T.level.toUpperCase():"â€”"}),e.jsx(G,{size:"small",onClick:()=>O({open:!0,refId:p.serialNo,level:T?.level||"ok",text:T?.text||""}),children:"Remark"})]})}),e.jsx(Ct,{title:I?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:I}):null,children:e.jsx("div",{style:ct,children:I||"â€”"})})]})}});const We=Q?Ae:h.length,Ve=x?420:600,ut=Q?Fe:de==="loadMore"?Fe.slice(0,De):Fe,It=o.useMemo(()=>{const u=(Q?$:Fe)||[],p=new Map;return u.forEach(T=>{const I=String(T.branch||"Unknown").trim()||"Unknown",C=te(I);p.has(C)||p.set(C,{key:C,branch:I,total:0});const s=p.get(C);s.total+=1}),Array.from(p.values()).sort((T,I)=>I.total-T.total)},[Q,$,Fe]);return e.jsxs("div",{style:{paddingTop:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxs(ue,{wrap:!0,children:[e.jsx(he,{value:_,onChange:ce,style:{minWidth:120},disabled:!["owner","admin","backend"].includes(X),options:Rt.map(u=>({value:u,label:u==="all"?"All Branches":u}))}),e.jsx(he,{value:A,onChange:J,style:{minWidth:100},options:Nt.map(u=>({value:u,label:u==="all"?"All Modes":String(u).toUpperCase()}))}),e.jsx(he,{value:D,onChange:pe,style:{minWidth:100},options:Lt.map(u=>({value:u,label:u==="all"?"All Statuses":Tt(u)}))}),e.jsx(fs.RangePicker,{value:E,onChange:u=>{se(u),xe(null)},allowClear:!0}),e.jsx(G,{size:"small",type:Re==="today"?"primary":"default",onClick:()=>{const u=Ue();se([u,u]),xe("today")},children:"Today"}),e.jsx(G,{size:"small",type:Re==="yesterday"?"primary":"default",onClick:()=>{const u=Ue().subtract(1,"day");se([u,u]),xe("yesterday")},children:"Yesterday"}),e.jsx(G,{size:"small",onClick:()=>{se(null),xe(null)},children:"Clear"}),e.jsx(Z,{placeholder:"Search name/mobile/quotation/company/model",allowClear:!0,value:fe,onChange:u=>Le(u.target.value),style:{minWidth:150}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(ue,{children:[e.jsx(G,{type:"primary",onClick:()=>d("/quotation"),children:"Quotation"}),e.jsxs(me,{color:"blue",children:["Total: ",We]}),e.jsxs(me,{color:"geekblue",children:["Showing: ",Q||de==="loadMore"?ut.length:Fe.length]}),!Q&&e.jsx(he,{size:"small",value:de,onChange:u=>{Ie(u),Ee(ee)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(G,{onClick:ft,children:"Export CSV"}),e.jsx(G,{loading:z,onClick:()=>{const u=new Event("reload-quotations");window.dispatchEvent(u)},children:"Refresh"})]})]}),e.jsxs(Pt,{gutter:[12,12],style:{marginBottom:12},children:[q?e.jsx(ne,{xs:24,children:e.jsx(me,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,It.map(u=>e.jsx(ne,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ys,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:u.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:u.total})]})})},u.key))]}),e.jsx(Bt,{dataSource:ut,columns:tt,loading:z&&!i,size:"small",className:"compact-table",scroll:x?{x:"max-content",y:Ve}:{y:Ve},tableLayout:x?"auto":"fixed",pagination:Q?{current:ye,pageSize:ee,total:We,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(u,p)=>{Pe(u),p!==ee&&ze(p)},showTotal:(u,p)=>`${p[0]}-${p[1]} of ${u}`}:de==="pagination"?{current:ye,pageSize:ee,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(u,p)=>{Pe(u),p!==ee&&ze(p)},showTotal:(u,p)=>`${p[0]}-${p[1]} of ${u}`}:!1,rowKey:u=>`${u.serialNo}-${u.mobile}-${u.ts}-${u.key}`}),!Q&&de==="loadMore"&&ut.length<Fe.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(G,{onClick:()=>Ee(u=>Math.min(u+ee,Fe.length)),children:["Load more (",Fe.length-ut.length," more)"]})}):null,e.jsx(rt,{open:c.open,title:`Update Remark: ${c.refId}`,onCancel:()=>O({open:!1,refId:"",level:"ok",text:""}),onOk:()=>{const{refId:u,level:p,text:T}=c,I=kt(T),C=l[u],s=h.find(r=>r.serialNo===u);v(r=>({...r,[u]:{level:p,text:I}})),U(r=>r.map(f=>f.serialNo===u?{...f,RemarkLevel:p.toUpperCase(),RemarkText:I,_remarkLevel:p,_remarkText:I}:f)),O({open:!1,refId:"",level:"ok",text:""}),(async()=>{try{const f=await ot({webhookUrl:Qa,method:"POST",payload:$s?{action:"remark",serialNo:u,level:p,text:I,secret:$s}:{action:"remark",serialNo:u,level:p,text:I}}),y=f?.data||f;if(!(y&&(y.ok||y.success)))throw new Error("Save failed");j.success("Remark saved to sheet")}catch{v(r=>{const f={...r};return C?f[u]=C:delete f[u],f}),s&&U(r=>r.map(f=>f.serialNo===u?s:f)),j.error("Save failed")}})()},children:e.jsxs(ue,{direction:"vertical",style:{width:"100%"},children:[e.jsx(he,{value:c.level,onChange:u=>O(p=>({...p,level:u})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(Z,{maxLength:140,showCount:!0,value:c.text,onChange:u=>O(p=>({...p,text:u.target.value})),placeholder:"Short note (optional)"})]})})]})}function Wa(n){if(!n)return e.jsx(us,{type:"secondary",children:"â€”"});try{const x=ms(n);return x?Ue(x).format("DD-MM-YYYY HH:mm"):String(n)}catch{return String(n)}}function ms(n){if(!n)return null;if(n instanceof Date)return n.getTime();if(typeof n=="number")return n;const x=String(n).trim(),d=new Date(x);if(!isNaN(d.getTime()))return d.getTime();const h=x.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(h){const U=h[2];let z=parseInt(h[1],10),L=parseInt(h[3],10),q=parseInt(h[4],10);q<100&&(q+=2e3);let k,$;U==="-"||z>12?($=z,k=L-1):(k=z-1,$=L);let w=h[5]?parseInt(h[5],10):0;const _=h[6]?parseInt(h[6],10):0,ce=h[7]?parseInt(h[7],10):0,A=(h[8]||"").toUpperCase();A==="PM"&&w<12&&(w+=12),A==="AM"&&w===12&&(w=0);const J=new Date(q,k,$,w,_,ce);if(!isNaN(J.getTime()))return J.getTime()}return null}const Ha="https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",Qa=Ha,$s="",Ya="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",jt=Ya,ht="",{Text:hs}=Zt,Xe={ts:["Timestamp","Time","Date"],name:["Customer Name","Customer","Name","Customer_Name"],mobile:["Mobile","Phone","Mobile Number"],branch:["Branch"],executive:["Executive"],jcNo:["JC No.","JC No","Job Card No","JobCard No","JCNumber"],regNo:["Vehicle No","Vehicle_No","Registration Number","RegNo","Reg No"],company:["Company","Company Name","Vehicle Company","Brand"],model:["Model","Bike Model"],serviceType:["Service Type","Service","Service_Type"],vehicleType:["Vehicle Type","Type of Vehicle","Vehicle_Type"],amount:["Service Amount","Collected Amount","Collected_Amount","Amount"],paymentMode:["Payment Mode","Mode of Payment","Payment_Mode","paymentMode"],payload:["Payload"]},at=(n,x)=>String(x.map(d=>n?.[d]??"").find(d=>d!=="")||"").trim();function Nn(){const x=!Ut.useBreakpoint().md,d=qs(),[h,U]=o.useState([]),[z,L]=o.useState(!1),[q,k]=o.useState(!1),[$,w]=o.useState([]),[_,ce]=o.useState("all"),[A,J]=o.useState("all"),[D,pe]=o.useState("all"),[fe,Le]=o.useState(""),ae=gs(fe,300),[E,se]=o.useState(()=>[Ue().startOf("month"),Ue()]),[Re,xe]=o.useState(null),[X,je]=o.useState(""),[oe,Se]=o.useState([]),[ye,Pe]=o.useState(1),[ee,ze]=o.useState(25),[de,Ie]=o.useState("pagination"),[De,Ee]=o.useState(25),[Ae,$e]=o.useState(0),Q="true".toLowerCase()==="true",[l,v]=o.useState({}),[c,O]=o.useState({open:!1,refId:"",level:"ok",text:""}),[i,M]=o.useState(!1),[P,Ce]=o.useState([]),_e=o.useRef(null),[Be,ke]=o.useState(!1),[lt,Rt]=o.useState(null),[Nt,Lt]=o.useState(null),pt=s=>{if(!s)return;const r=String(s?.mobile||"").replace(/\D/g,"").slice(-10),f=String(s?.jcNo||s?.serialNo||"").trim(),y=new URLSearchParams;y.set("autoFetch","1"),r?(y.set("mode","mobile"),y.set("query",r)):f&&(y.set("mode","jc"),y.set("query",f)),f&&y.set("jcNo",f);const g=y.toString();d(g?`/jobcard?${g}`:"/jobcard")};o.useEffect(()=>{try{const s=localStorage.getItem("user");if(!s)return;const r=JSON.parse(s);je(String(r?.role||"").toLowerCase());const f=[],y=r?.formDefaults?.branchName||r?.primaryBranch?.name||"";y&&f.push(y),Array.isArray(r?.branches)&&r.branches.forEach(g=>{const R=typeof g=="string"?g:g?.name||"";R&&f.push(R)}),Se(Array.from(new Set(f.filter(Boolean))))}catch{}},[]),o.useEffect(()=>{!["owner","admin","backend"].includes(X)&&oe.length&&_==="all"&&ce(oe[0])},[X,oe,_]);const Ke=(()=>{const s=E&&E[0]?E[0].startOf("day").valueOf():"",r=E&&E[1]?E[1].endOf("day").valueOf():"";return`Jobcards:list:${JSON.stringify({branchFilter:_,serviceFilter:A,statusFilter:D,q:ae||"",start:s,end:r,page:ye,pageSize:ee,USE_SERVER_PAG:Q})}`})(),Fe=o.useCallback((s,r=0)=>{const f=s&&s.values?s.values:s,y=s&&s.payload?s.payload:(f?f[Xe.payload[0]]:void 0)||"";let g=null;try{g=typeof y=="object"?y:JSON.parse(String(y||"{}"))}catch{g=null}const R=g&&g.formValues?g.formValues:{},W=R.company||g?.company||at(f,Xe.company),F=R.model||at(f,Xe.model),ie=R.regNo||at(f,Xe.regNo),Y=(()=>{const gt=g?.totals?.grand;return gt!=null&&gt!==""?String(gt):String(at(f,Xe.amount)||"")})(),le=(()=>{const gt=at(f,Xe.paymentMode);return String(gt||g?.paymentMode||"")})(),Te=g&&g.postServiceAt||f&&(f.Post_Service_At||f["Post Service At"])||"",we=(()=>{const gt=String(Te||"").trim().length>0,Xt=Array.isArray(g?.payments)&&g.payments.some(Mt=>Number(Mt?.amount||0)>0);if(gt||Xt)return"completed";const Kt=String(le||"").trim().length>0,_t=String(Y||"").trim().length>0;return Kt&&_t?"completed":"pending"})(),ge=g?.remark?.level||f?.RemarkLevel||f?.["Remark Level"]||"",Ne=g?.remark?.text||f?.RemarkText||f?.["Remark Text"]||"",Ge=String(ge||"").toLowerCase(),nt=R.serviceType||R.service||at(f,Xe.serviceType),yt=String(R.km||f?.KM||f?.["Odometer Reading"]||"").replace(/\D/g,""),Et=g?.savedAt||g?.createdAt||g?.ts||g?.timestamp||R?.savedAt||R?.createdAt||R?.timestamp||at(f,Xe.ts);return{key:r,ts:Et,tsMs:ps(Et),name:R.name||at(f,Xe.name),mobile:R.mobile||at(f,Xe.mobile),branch:R.branch||at(f,Xe.branch),executive:R.executive||at(f,Xe.executive),jcNo:R.jcNo||at(f,Xe.jcNo),regNo:ie,model:F,company:W,serviceType:nt||"",vehicleType:R.vehicleType||at(f,Xe.vehicleType),amount:Y,km:yt,paymentMode:le,postAt:Te,status:we,RemarkLevel:ge||"",RemarkText:Ne||"",_remarkLevel:Ge,_remarkText:Ne||"",payload:g,_raw:s}},[]),ft=s=>{if(!s)return null;if(s.payload&&typeof s.payload=="object")return s.payload;const r=s.payload||s.Payload||s.PAYLOAD||s?.values?.Payload||s?.values?.payload||s?.values?.PAYLOAD||s?._raw?.payload||s?._raw?.Payload||s?._raw?.PAYLOAD||s?._raw?.values?.Payload||s?._raw?.values?.payload||s?._raw?.values?.PAYLOAD||"";if(r&&typeof r=="object")return r;if(r&&typeof r=="string")try{return JSON.parse(r)}catch{return null}return s.formValues||s.values?s:null},At=(s,r)=>{if(!s)return null;const f=s.formValues||s.values||{},y=Array.isArray(s.labourRows)?s.labourRows:Array.isArray(f.labourRows)?f.labourRows:[],g=s.totals||f.totals||{},R=y.reduce((ie,Y)=>ie+Number(Y?.qty||0)*Number(Y?.rate||0),0),W={labourSub:g.labourSub??R,labourGST:g.labourGST??0,labourDisc:g.labourDisc??0,grand:g.grand??R},F=s.postServiceAt||s.createdAt||s.savedAt||r?.postAt||r?.ts||new Date;return{vals:{jcNo:r?.jcNo||f.jcNo||"",regNo:r?.regNo||f.regNo||"",custName:r?.name||f.custName||f.name||"",custMobile:r?.mobile||f.custMobile||f.mobile||"",km:r?.km||f.km||"",model:r?.model||f.model||"",colour:f.colour||r?.colour||"",branch:r?.branch||f.branch||"",executive:r?.executive||f.executive||"",createdAt:F,labourRows:y,gstLabour:g.gstLabour||g.labourGST||0},totals:W}},Tt=async s=>{if(!s)return;if(String(s.status||"").toLowerCase()!=="completed"){j.warning("Complete post-service to generate the service invoice.");return}const f=s.jcNo||s.key||s.mobile||"";Lt(f);try{let y=ft(s),g=y?At(y,s):null;const R=Array.isArray(g?.vals?.labourRows)&&g.vals.labourRows.length>0;if(!g||!R){const W=String(s.mobile||"").replace(/\D/g,"").slice(-10);if(W.length===10){const F={action:"search",mode:"mobile",query:W},ie=ht?{...F,secret:ht}:F,Y=await Dt({webhookUrl:jt,method:"GET",payload:ie}),le=Y?.data||Y,Te=Array.isArray(le?.rows)?le.rows:Array.isArray(le?.data)?le.data:[];if(Te.length){let we=Te[0];if(s.jcNo){const Ne=Te.find(Ge=>{const nt=ft(Ge),Et=(nt?.formValues||nt?.values||{}).jcNo||Ge?.jcNo||Ge?.values?.["JC No"]||Ge?.values?.["JC No."]||Ge?.values?.["Job Card No"]||"";return String(Et||"").trim()===String(s.jcNo||"").trim()});Ne&&(we=Ne)}const ge=ft(we);g=ge?At(ge,s):g}}}if(!g){j.error("Could not load service invoice data.");return}Rt(g),ke(!0),setTimeout(()=>{try{Aa(_e.current)}catch{}setTimeout(()=>ke(!1),500)},50)}catch{j.error("Could not generate service invoice.")}finally{Lt(null)}};o.useEffect(()=>{try{const s=localStorage.getItem(Ke);if(!s){M(!1);return}const r=JSON.parse(s);r&&Array.isArray(r.rows)?(U(r.rows),$e(typeof r.total=="number"?r.total:r.rows.length),M(!0)):M(!1)}catch{M(!1)}},[Ke]),o.useEffect(()=>{let s=!1;const r=async()=>{L(!0);try{const y={action:"list"},g={q:ae||"",branch:_!=="all"?_:"",service:A!=="all"?A:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(g.start=E[0].startOf("day").valueOf(),g.end=E[1].endOf("day").valueOf());const R=Q?ht?{...y,page:ye,pageSize:ee,...g,secret:ht}:{...y,page:ye,pageSize:ee,...g}:ht?{...y,secret:ht}:y,W=await Dt({webhookUrl:jt,method:"GET",payload:R}),F=W?.data||W;if(!F||!F.ok&&!F.success)throw new Error("Invalid response");const Te=(Array.isArray(F.data)?F.data:Array.isArray(F.rows)?F.rows:[]).map((we,ge)=>Fe(we,ge)).filter(we=>we.jcNo||we.name||we.mobile).slice().sort((we,ge)=>(ge.tsMs||0)-(we.tsMs||0));if(!s){U(Te);const we=typeof F.total=="number"?F.total:Te.length;$e(we);const ge={};Te.forEach(Ne=>{if(!Ne.jcNo)return;const Ge=(typeof Ne._remarkLevel<"u"?Ne._remarkLevel:Ne.remarkLevel)??String(Ne.RemarkLevel||"").toLowerCase(),nt=(typeof Ne._remarkText<"u"?Ne._remarkText:Ne.remarkText)??Ne.RemarkText??"";ge[Ne.jcNo]={level:Ge||"",text:nt||""}}),v(ge);try{localStorage.setItem(Ke,JSON.stringify({at:Date.now(),rows:Te,total:we}))}catch{}}}catch{j.error("Could not load job cards via Apps Script. Check JOBCARD Web App URL / access."),s||(U([]),$e(0))}finally{s||L(!1)}};r();const f=()=>r();return window.addEventListener("reload-jobcards",f),()=>{s=!0,window.removeEventListener("reload-jobcards",f)}},[_,A,D,ae,E,ye,ee,Q]);const kt=P.length?P:h,it=o.useMemo(()=>{const s=xt(kt.map(f=>f.branch));if(!["owner","admin","backend"].includes(X)&&oe.length){const f=St(oe);return["all",...s.filter(y=>f.has(te(y)))]}return["all",...s]},[kt,X,oe]),ct=o.useMemo(()=>["all",...xt(kt.map(s=>s.serviceType))],[kt]),dt=o.useCallback(s=>{const r=St(oe);return(s||[]).filter(y=>{if(r.size&&!["owner","admin","backend"].includes(X)&&!r.has(te(y.branch))||_!=="all"&&te(y.branch)!==te(_)||A!=="all"&&te(y.serviceType)!==te(A)||D!=="all"&&te(y.status)!==te(D))return!1;if(E&&E[0]&&E[1]){const g=E[0].startOf("day").valueOf(),R=E[1].endOf("day").valueOf(),W=y.tsMs??ps(y.ts);if(!W||W<g||W>R)return!1}if(ae){const g=ae.toLowerCase();if(![y.name,y.mobile,y.jcNo,y.regNo,y.model,y.branch,y.executive,y.paymentMode,y.status].some(R=>String(R||"").toLowerCase().includes(g)))return!1}return!0}).slice().sort((y,g)=>(g.tsMs||0)-(y.tsMs||0))},[oe,_,E,ae,A,D,X]),et=o.useCallback(async()=>{if(!Q)return h;const s=100,r={q:ae||"",branch:_!=="all"?_:"",service:A!=="all"?A:"",status:D!=="all"?D:""};E&&E[0]&&E[1]&&(r.start=E[0].startOf("day").valueOf(),r.end=E[1].endOf("day").valueOf());const f=[],y=new Set;let g=1,R=200,W=null;for(;g<=R;){const ie={...{action:"list",page:g,pageSize:s},...r},Y=await Dt({webhookUrl:jt,method:"GET",payload:ie}),le=Y?.data||Y;typeof le?.total=="number"&&Number.isFinite(le.total)&&(W=le.total,R=Math.ceil(le.total/s));const Te=Array.isArray(le?.data)?le.data:Array.isArray(le?.rows)?le.rows:[];if(!Te.length)break;let we=0;if(Te.forEach(ge=>{const Ge=String(ge?.values?.["JC No"]||ge?.values?.["JC No."]||ge?.values?.["Job Card No"]||ge?.jcNo||ge?.JCNo||ge?.["JC No"]||ge?.["JC No."]||"").trim()||JSON.stringify(ge);y.has(Ge)||(y.add(Ge),f.push(ge),we+=1)}),W!==null&&y.size>=W||we===0||Te.length<s)break;g+=1}return f.map((F,ie)=>Fe(F,ie)).filter(F=>F.jcNo||F.name||F.mobile)},[Q,jt,ht,_,E,ae,Fe,h,A,D]),qe=o.useMemo(()=>Q?h:dt(h),[Q,dt,h]);o.useEffect(()=>{let s=!1;return(async()=>{if(!Q){w(dt(h));return}k(!0);try{const f=await et(),y=dt(f);s||w(y)}catch{s||w([])}finally{s||k(!1)}})(),()=>{s=!0}},[Q,et,dt,_,A,D,ae,E,X,oe,h]),o.useEffect(()=>{Pe(1),Ee(ee)},[_,A,D,ae,E]),o.useEffect(()=>{Ee(ee)},[ee]);const vt=async()=>{const s="export-jobcards";j.loading({key:s,content:"Preparing CSVâ€¦",duration:0});try{const r=Q?await et():h,f=Q?r:dt(r);if(!f.length){j.info({key:s,content:"No rows to export for current filters"});return}const y=[{key:"ts",label:"Timestamp"},{key:"jcNo",label:"Job Card No"},{key:"name",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"branch",label:"Branch"},{key:"serviceType",label:"Service Type"},{key:"vehicleType",label:"Vehicle Type"},{key:"regNo",label:"Vehicle No"},{key:"model",label:"Model"},{key:"company",label:"Company"},{key:"amount",label:"Service Amount"},{key:"paymentMode",label:"Payment Mode"},{key:"status",label:"Status"},{key:"RemarkLevel",label:"Remark Level"},{key:"RemarkText",label:"Remark"}],g=f.map(R=>({ts:R.ts,jcNo:R.jcNo,name:R.name,mobile:R.mobile,branch:R.branch,serviceType:R.serviceType,vehicleType:R.vehicleType,regNo:R.regNo,model:R.model,company:R.company,amount:R.amount,paymentMode:R.paymentMode,status:R.status,RemarkLevel:R.RemarkLevel||R._remarkLevel,RemarkText:R.RemarkText||R._remarkText}));Gt({filename:"jobcards.csv",headers:y,rows:g}),j.success({key:s,content:`Exported ${g.length} job cards`})}catch{j.error({key:s,content:"Export failed. Please try again."})}};o.useEffect(()=>{let s=!1;return(async()=>{try{const y=await Dt({webhookUrl:jt,method:"GET",payload:ht?{action:"list",page:1,pageSize:5e3,secret:ht}:{action:"list",page:1,pageSize:5e3}}),g=y?.data||y;if(!g||!g.ok&&!g.success)return;const W=(Array.isArray(g.data)?g.data:Array.isArray(g.rows)?g.rows:[]).map((F,ie)=>Fe(F,ie));s||Ce(W)}catch{}})(),()=>{s=!0}},[]);const tt={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},We={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},Ve=s=>{const r=String(s||"").toLowerCase();return r==="completed"?"green":r==="pending"?"orange":"default"},ut=s=>{const r=String(s||"").toLowerCase();return r==="completed"?"Completed":r==="pending"?"Pending":String(s||"â€”")||"â€”"},It=s=>{const r=Ue().format("DD-MM-YYYY HH:mm"),f=String(s||"").trim();return f?`${r} - ${f}`:r},u=[{title:"Time / Branch",key:"timeBranch",width:90,render:(s,r)=>e.jsxs("div",{style:tt,children:[e.jsx("div",{style:We,children:Ja(r.ts)}),e.jsx("div",{style:We,children:e.jsx(hs,{type:"secondary",children:r.branch||"â€”"})})]})},{title:"Customer / Mobile",key:"customerMobile",width:100,render:(s,r)=>e.jsxs("div",{style:tt,children:[e.jsx("div",{style:We,children:r.name||"â€”"}),e.jsx("div",{style:We,children:e.jsx(hs,{type:"secondary",children:r.mobile||"â€”"})})]})},{title:"Service / Status",key:"serviceStatus",width:200,render:(s,r)=>{const f=String(r.company||"").trim()||"â€”",y=String(r.model||"").trim()||"â€”",g=String(r.serviceType||"").trim()||"â€”",R=String(r.amount||"").trim()||"â€”",W=String(r.paymentMode||"").trim(),F=`${f} || ${y} || ${g} || ${R} || ${W?W.toUpperCase():"â€”"}`,ie=String(r.executive||"").trim()||"â€”",Y=String(r.regNo||"").trim()||"â€”";return e.jsxs("div",{style:tt,children:[e.jsx("div",{style:We,children:F}),e.jsx("div",{style:We,children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:4},children:[e.jsx(me,{color:Ve(r.status),children:ut(r.status)}),e.jsx("span",{children:`|| ${ie} || ${Y}`})]})})]})}}];["backend","admin","owner"].includes(X)&&u.push({title:"Remarks / Remark Text",key:"remarks",width:250,render:(s,r)=>{const f=l[r.jcNo],y=String(f?.text||""),g=String(f?.level||"").toLowerCase(),R=g==="alert"?"red":g==="warning"?"gold":g==="ok"?"green":"default",W=y||"No remark yet",F=String(r.status||"").toLowerCase(),ie=F==="completed",Y=F==="pending",le=Nt===(r.jcNo||r.key||r.mobile||"");return e.jsxs("div",{style:tt,children:[e.jsx("div",{style:We,children:e.jsxs(ue,{size:6,children:[e.jsx(Ct,{title:W,children:e.jsx(me,{color:R,children:g?g.toUpperCase():"â€”"})}),e.jsx(G,{size:"small",onClick:()=>O({open:!0,refId:r.jcNo,level:f?.level||"ok",text:f?.text||""}),children:"Remark"}),ie?e.jsx(Ct,{title:"Print service invoice",children:e.jsx(G,{size:"small",type:"primary",ghost:!0,loading:le,onClick:()=>Tt(r),children:"Service Invoice"})}):e.jsx(Ct,{title:Y?"Post service":"Service not completed",children:e.jsx(G,{size:"small",type:"primary",onClick:()=>pt(r),children:"Post Service"})})]})}),e.jsx(Ct,{title:y?e.jsx("span",{style:{whiteSpace:"pre-wrap"},children:y}):null,children:e.jsx("div",{style:We,children:y||"â€”"})})]})}});const p=Q?Ae:h.length,T=x?420:600,I=Q?qe:de==="loadMore"?qe.slice(0,De):qe,C=o.useMemo(()=>{const s=(Q?$:qe)||[],r=new Map;return s.forEach(f=>{const y=String(f.branch||"Unknown").trim()||"Unknown",g=te(y);r.has(g)||r.set(g,{key:g,branch:y,total:0});const R=r.get(g);R.total+=1}),Array.from(r.values()).sort((f,y)=>y.total-f.total)},[Q,$,qe]);return e.jsxs("div",{style:{paddingTop:12},children:[e.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:8,flexWrap:"wrap"},children:[e.jsxs(ue,{wrap:!0,children:[e.jsx(he,{value:_,onChange:ce,style:{minWidth:120},disabled:!["owner","admin","backend"].includes(X),options:it.map(s=>({value:s,label:s==="all"?"All Branches":s}))}),e.jsx(he,{value:A,onChange:J,style:{minWidth:100},options:ct.map(s=>({value:s,label:s==="all"?"All Services":String(s).toUpperCase()}))}),e.jsx(he,{value:D,onChange:pe,style:{minWidth:100},options:[{value:"all",label:"All Statuses"},{value:"pending",label:"Pending"},{value:"completed",label:"Completed"}]}),e.jsx(fs.RangePicker,{value:E,onChange:s=>{se(s),xe(null)},allowClear:!0}),e.jsx(G,{size:"small",type:Re==="today"?"primary":"default",onClick:()=>{const s=Ue();se([s,s]),xe("today")},children:"Today"}),e.jsx(G,{size:"small",type:Re==="yesterday"?"primary":"default",onClick:()=>{const s=Ue().subtract(1,"day");se([s,s]),xe("yesterday")},children:"Yesterday"}),e.jsx(G,{size:"small",onClick:()=>{se(null),xe(null)},children:"Clear"}),e.jsx(Z,{placeholder:"Search name/mobile/jc/vehicle/model/mode",allowClear:!0,value:fe,onChange:s=>Le(s.target.value),style:{minWidth:120}})]}),e.jsx("div",{style:{flex:1}}),e.jsxs(ue,{children:[e.jsx(G,{type:"primary",onClick:()=>d("/jobcard"),children:"Job Card"}),e.jsxs(me,{color:"blue",children:["Total: ",p]}),e.jsxs(me,{color:"geekblue",children:["Showing: ",Q||de==="loadMore"?I.length:qe.length]}),!Q&&e.jsx(he,{size:"small",value:de,onChange:s=>{Ie(s),Ee(ee)},options:[{value:"pagination",label:"Pagination"},{value:"loadMore",label:"Load More"}],style:{width:130}}),e.jsx(G,{onClick:vt,children:"Export CSV"}),e.jsx(G,{loading:z,onClick:()=>{const s=new Event("reload-jobcards");window.dispatchEvent(s)},children:"Refresh"})]})]}),e.jsxs(Pt,{gutter:[12,12],style:{marginBottom:12},children:[q?e.jsx(ne,{xs:24,children:e.jsx(me,{color:"blue",children:"Loading branch totalsâ€¦"})}):null,C.map(s=>e.jsx(ne,{xs:12,sm:8,md:6,lg:4,xl:3,children:e.jsx(ys,{size:"small",bodyStyle:{padding:"6px 8px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("span",{style:{fontWeight:600,fontSize:12,lineHeight:"16px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:1},children:s.branch}),e.jsx("span",{style:{fontSize:11,fontWeight:700,lineHeight:"16px",padding:"0 6px",borderRadius:10,background:"#eef2ff",color:"#1d4ed8"},children:s.total})]})})},s.key))]}),e.jsx(Bt,{dataSource:I,columns:u,loading:z&&!i,size:"small",className:"compact-table",tableLayout:x?"auto":"fixed",pagination:Q?{current:ye,pageSize:ee,total:p,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(s,r)=>{Pe(s),r!==ee&&ze(r)},showTotal:(s,r)=>`${r[0]}-${r[1]} of ${s}`}:de==="pagination"?{current:ye,pageSize:ee,showSizeChanger:!0,pageSizeOptions:["10","25","50","100"],onChange:(s,r)=>{Pe(s),r!==ee&&ze(r)},showTotal:(s,r)=>`${r[0]}-${r[1]} of ${s}`}:!1,rowKey:s=>`${s.jcNo}-${s.mobile}-${s.ts}-${s.key}`,scroll:x?{x:"max-content",y:T}:{y:T}}),!Q&&de==="loadMore"&&I.length<qe.length?e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:8},children:e.jsxs(G,{onClick:()=>Ee(s=>Math.min(s+ee,qe.length)),children:["Load more (",qe.length-I.length," more)"]})}):null,e.jsx(rt,{open:c.open,title:`Update Remark: ${c.refId}`,onCancel:()=>O({open:!1,refId:"",level:"ok",text:""}),onOk:()=>{const{refId:s,level:r,text:f}=c,y=It(f),g=l[s],R=h.find(W=>W.jcNo===s);v(W=>({...W,[s]:{level:r,text:y}})),U(W=>W.map(F=>F.jcNo===s?{...F,RemarkLevel:r.toUpperCase(),RemarkText:y,_remarkLevel:r,_remarkText:y}:F)),O({open:!1,refId:"",level:"ok",text:""}),(async()=>{try{const F=await Dt({webhookUrl:jt,method:"POST",payload:ht?{action:"remark",jcNo:s,level:r,text:y,secret:ht}:{action:"remark",jcNo:s,level:r,text:y}}),ie=F?.data||F;if(!(ie&&(ie.ok||ie.success)))throw new Error("Save failed");j.success("Remark saved to sheet")}catch{v(W=>{const F={...W};return g?F[s]=g:delete F[s],F}),R&&U(W=>W.map(F=>F.jcNo===s?R:F)),j.error("Save failed")}})()},children:e.jsxs(ue,{direction:"vertical",style:{width:"100%"},children:[e.jsx(he,{value:c.level,onChange:s=>O(r=>({...r,level:s})),options:[{value:"ok",label:"OK (Green)"},{value:"warning",label:"Warning (Yellow)"},{value:"alert",label:"Alert (Red)"}],style:{width:220}}),e.jsx(Z,{maxLength:140,showCount:!0,value:c.text,onChange:s=>O(r=>({...r,text:s.target.value})),placeholder:"Short note (optional)"})]})}),e.jsx(Ra,{ref:_e,active:Be,vals:lt?.vals||{},totals:lt?.totals||{}})]})}function Ja(n){if(!n)return e.jsx(hs,{type:"secondary",children:"â€”"});try{const x=ps(n);return x?Ue(x).format("DD-MM-YYYY HH:mm"):String(n)}catch{return String(n)}}function ps(n){if(!n)return null;if(n instanceof Date)return n.getTime();if(typeof n=="number")return n;const x=String(n).trim(),d=new Date(x);if(!isNaN(d.getTime()))return d.getTime();const h=x.match(/^(\d{1,2})([/-])(\d{1,2})\2(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);if(h){const U=h[2];let z=parseInt(h[1],10),L=parseInt(h[3],10),q=parseInt(h[4],10);q<100&&(q+=2e3);let k,$;U==="-"||z>12?($=z,k=L-1):(k=z-1,$=L);let w=h[5]?parseInt(h[5],10):0;const _=h[6]?parseInt(h[6],10):0,ce=h[7]?parseInt(h[7],10):0,A=(h[8]||"").toUpperCase();A==="PM"&&w<12&&(w+=12),A==="AM"&&w===12&&(w=0);const J=new Date(q,k,$,w,_,ce);if(!isNaN(J.getTime()))return J.getTime()}return null}const{Text:Yt}=Zt,$t={company:["Company","Company Name"],model:["Model","Model Name"],variant:["Variant"],color:["Color","Colours","Colors","Colour","Available Colors"],price:["On-Road Price","On Road Price","OnRoadPrice","Price"]},Za=n=>{const x=[];let d=[],h="",U=!1;for(let z=0;z<n.length;z++){const L=n[z],q=n[z+1];if(L==='"'&&!U){U=!0;continue}if(L==='"'&&U){if(q==='"'){h+='"',z++;continue}U=!1;continue}if(L===","&&!U){d.push(h),h="";continue}if((L===`
`||L==="\r")&&!U){(h!==""||d.length)&&(d.push(h),x.push(d),d=[],h=""),L==="\r"&&q===`
`&&z++;continue}h+=L}return(h!==""||d.length)&&(d.push(h),x.push(d)),x},Xa=async n=>{const x=await fetch(n,{cache:"no-store"});if(!x.ok)throw new Error("Sheet fetch failed");const d=await x.text();if(d.trim().startsWith("<"))throw new Error("Expected CSV, got HTML");const h=Za(d);if(!h.length)return[];const U=h[0].map(z=>(z||"").trim());return h.slice(1).map(z=>{const L={};return U.forEach((q,k)=>L[q]=z[k]??""),L})},Vt=(n,x)=>String(x.map(d=>n[d]??"").find(d=>d!=="")||"").trim(),Vs=(n={})=>{const x=Vt(n,$t.price)||n.onRoadPrice||n.OnRoadPrice||n.onroadprice||n.price||0,d=Vt(n,$t.color)||n.color||n.colors||"",h=pe=>Number(String(pe||0).replace(/[",\sâ‚¹]/g,""))||0,U=pe=>{const fe=String(pe||"").replace(/[",\sâ‚¹]/g,"");return fe!==""&&!Number.isNaN(Number(fe))},z=Vt(n,$t.company)||n.company||"",L=Vt(n,$t.model)||n.model||"",q=Vt(n,$t.variant)||n.variant||"";let k=h(x),$=String(d||"").trim();const w=n.UpdatedAt||n.updatedAt||n.updated_at||n.updated||"",_=n.UpdatedBy||n.updatedBy||n.updated_by||n.user||"",ce=pe=>String(pe||"").includes("|");let A=w,J=_;return!U(x)&&U(d)&&k===0&&(k=h(d),$="",!_&&ce(x)&&(J=w)),{id:n.id||n._id||n.rowId||n._row||void 0,company:z,model:L,variant:q,color:$,onRoadPrice:k,updatedAt:A,updatedBy:J}};function Ln({csvFallbackUrl:n}){const d=!Ut.useBreakpoint().md,h="https://script.google.com/macros/s/AKfycbw0zvptYU-X0yBRFytBJZeli0Dr-uOBFDSfpYgQeWv7nKMWXD73piVndyyTiARU0FL-Lg/exec",[U,z]=o.useState([]),[L,q]=o.useState(!1),[k,$]=o.useState(!1),[w,_]=o.useState(null),[ce,A]=o.useState(!1),[J]=H.useForm(),[D,pe]=o.useState(!1),[fe,Le]=o.useState(""),[ae,E]=o.useState("all"),[se,Re]=o.useState(""),[xe,X]=o.useState(1),[je,oe]=o.useState(25),Se=i=>String(i||"").trim().toLowerCase(),ye=i=>`${String(i.company||"").trim().toUpperCase()}|${String(i.model||"").trim().toUpperCase()}|${String(i.variant||"").trim().toUpperCase()}`,Pe=async()=>{const i=`${h}?action=list`,M=await fetch(i,{method:"GET",mode:"cors",credentials:"omit"});if(!M.ok)throw new Error("Failed to fetch catalog");return M.json()},ee=async i=>{const M=new URLSearchParams({action:"upsert",...i}),P=await fetch(h,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},body:M});if(!P.ok)throw new Error("Save failed");return P.json()},ze=async i=>{const M=new URLSearchParams({action:"delete",...i}),P=await fetch(h,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"},body:M});if(!P.ok)throw new Error("Delete failed");return P.json()},de=async()=>{q(!0),pe(!1);try{const i=await Pe(),M=i?.data||i?.items||i?.rows||i||[],P=Array.isArray(M)?M.map(Vs).filter(Ce=>Ce.company&&Ce.model&&Ce.variant):[];z(P),i?.ok===!1&&/catalog gas url/i.test(String(i?.message||""))&&pe(!0)}catch{if(n)try{const M=(await Xa(n)).map(Vs).filter(P=>P.company&&P.model&&P.variant);z(M),pe(!0)}catch{z([])}else z([])}finally{q(!1)}};o.useEffect(()=>{de()},[]);const Ie=()=>{_(null),J.resetFields(),A(!0)},De=i=>{_(i),J.setFieldsValue({company:i.company,model:i.model,variant:i.variant,color:i.color,onRoadPrice:i.onRoadPrice}),A(!0)},Ee=async i=>{try{$(!0);const P={id:i.id||i.rowId||void 0,company:i.company,model:i.model,variant:i.variant},Ce=await ze(P);if(!((Ce?.success??Ce?.ok??!0)!==!1))throw new Error(Ce?.message||"Delete failed");j.success("Vehicle deleted"),await de()}catch(M){j.error(M?.message||"Could not delete vehicle")}finally{$(!1)}},Ae=o.useMemo(()=>{const i=fe.trim().toLowerCase(),M=se.trim().toLowerCase();return U.filter(P=>{const Ce=!i||[P.company,P.model,P.variant,P.color,P.updatedBy].some(ke=>String(ke||"").toLowerCase().includes(i)),_e=ae==="all"||Se(P.company)===ae,Be=!M||Se(P.variant).includes(M);return Ce&&_e&&Be})},[U,fe,ae,se]),$e=o.useMemo(()=>`vc-${ae}-${se}-${fe}`,[ae,se,fe]);o.useEffect(()=>{X(1)},[ae,se,fe]);const Q=o.useMemo(()=>{const i=Ae.length,M=Ae.reduce((Be,ke)=>Be+(Number(ke.onRoadPrice)||0),0),P=i?Math.round(M/i):0,Ce=new Set(Ae.map(Be=>Se(Be.company))),_e=new Set(Ae.map(Be=>Se(Be.variant)));return{count:i,totalPrice:M,avgPrice:P,companyCount:Ce.size,variantCount:_e.size}},[Ae,Se]),l=o.useMemo(()=>{const i=new Set(U.map(M=>Se(M.company)).filter(Boolean));return Array.from(i).map(M=>({value:M,label:(M||"").toUpperCase()})).sort((M,P)=>M.label.localeCompare(P.label))},[U]),v=async()=>{try{const i=await J.validateFields();["company","model","variant"].forEach(ke=>{i[ke]&&(i[ke]=String(i[ke]).toUpperCase())}),i.color&&(i.color=String(i.color).toUpperCase().trim());const M=ye(i);if(U.find(ke=>ye(ke)===M&&String(ke.id||"")!==String(w?.id||""))){j.error("Duplicate vehicle: same Company + Model + Variant already exists");return}$(!0);const Ce={...i,onRoadPrice:Number(i.onRoadPrice||0)||0,id:w?.id,updatedBy:(()=>{try{const ke=JSON.parse(localStorage.getItem("user")||"null");return ke?.name||ke?.email||""}catch{return""}})(),action:"upsert"},_e=await ee(Ce);if(!((_e?.success??_e?.ok??!0)!==!1))throw new Error(_e?.message||"Save failed");j.success(w?"Vehicle updated":"Vehicle added"),A(!1),_(null),await de()}catch(i){if(i?.errorFields)return;j.error(i?.message||"Could not save vehicle")}finally{$(!1)}},c=o.useMemo(()=>[{title:"Company",dataIndex:"company",key:"company",sorter:(i,M)=>i.company.localeCompare(M.company)},{title:"Model",dataIndex:"model",key:"model",sorter:(i,M)=>i.model.localeCompare(M.model)},{title:"Variant",dataIndex:"variant",key:"variant",sorter:(i,M)=>i.variant.localeCompare(M.variant)},{title:"Colors",dataIndex:"color",key:"color",render:i=>i||e.jsx(Yt,{type:"secondary",children:"-"})},{title:"On-Road Price (â‚¹)",dataIndex:"onRoadPrice",key:"onRoadPrice",render:i=>i?i.toLocaleString("en-IN"):e.jsx(Yt,{type:"secondary",children:"0"}),sorter:(i,M)=>(i.onRoadPrice||0)-(M.onRoadPrice||0)},{title:"Updated At",dataIndex:"updatedAt",key:"updatedAt",render:i=>i?Ue(i).format("DD-MM-YYYY HH:mm"):e.jsx(Yt,{type:"secondary",children:"-"})},{title:"Updated By",dataIndex:"updatedBy",key:"updatedBy",render:i=>i||e.jsx(Yt,{type:"secondary",children:"-"})},{title:"Actions",key:"actions",render:(i,M)=>e.jsxs(ue,{children:[e.jsx(G,{size:"small",icon:e.jsx(Ea,{}),onClick:()=>De(M),disabled:k||D,children:"Edit"}),e.jsx(xa,{title:"Delete this vehicle?",onConfirm:()=>Ee(M),disabled:k||D,children:e.jsx(G,{size:"small",danger:!0,disabled:k||D,children:"Delete"})})]})}],[k,D]),O=()=>{if(!Ae.length){j.info("No catalog rows to export for current filters");return}const i=[{key:"company",label:"Company"},{key:"model",label:"Model"},{key:"variant",label:"Variant"},{key:"color",label:"Color"},{key:"onRoadPrice",label:"On-Road Price"},{key:"updatedAt",label:"Updated At"},{key:"updatedBy",label:"Updated By"}],M=Ae.map(P=>({company:P.company,model:P.model,variant:P.variant,color:P.color,onRoadPrice:P.onRoadPrice,updatedAt:P.updatedAt,updatedBy:P.updatedBy}));Gt({filename:"vehicle-catalog.csv",headers:i,rows:M}),j.success(`Exported ${M.length} vehicles`)};return e.jsxs("div",{style:{background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:16},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:12,marginBottom:12},children:[e.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(120deg,#2563eb0d,#2563eb1f)",border:"1px solid #dbeafe"},children:[e.jsx("div",{style:{fontSize:12,color:"#2563eb"},children:"Records"}),e.jsx("div",{style:{fontSize:22,fontWeight:700},children:Q.count.toLocaleString("en-IN")}),e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:"Filtered vehicles"})]}),e.jsxs("div",{style:{padding:12,borderRadius:10,background:"#f8fafc",border:"1px solid #e2e8f0"},children:[e.jsx("div",{style:{fontSize:12,color:"#0f172a"},children:"Mix"}),e.jsxs("div",{style:{fontSize:14,fontWeight:600},children:[Q.companyCount," brands â€¢ ",Q.variantCount," variants"]}),e.jsx("div",{style:{fontSize:12,color:"#64748b"},children:ae!=="all"?`Filtered: ${ae.toUpperCase()}`:"All brands"})]})]}),e.jsxs(ue,{style:{marginBottom:12,flexWrap:"wrap",width:"100%",justifyContent:"space-between"},children:[e.jsxs(ue,{wrap:!0,children:[e.jsx(G,{type:"primary",icon:e.jsx(Gs,{}),onClick:Ie,disabled:D,children:"Add Vehicle"}),e.jsx(G,{icon:e.jsx(Ia,{}),onClick:de,loading:L,children:"Reload"}),e.jsx(G,{onClick:O,children:"Export CSV"}),D&&e.jsx(me,{color:"red",children:"Save disabled (configure VEHICLE_CATALOG_GAS_URL)"})]}),e.jsxs(ue,{wrap:!0,children:[e.jsx(Z,{placeholder:"Search company/model/variant/color/user",allowClear:!0,value:fe,onChange:i=>Le(i.target.value),style:{maxWidth:260}}),e.jsx(Z,{placeholder:"Filter variant",allowClear:!0,value:se,onChange:i=>Re(i.target.value),style:{maxWidth:160}}),e.jsx(he,{value:ae,onChange:i=>E(i===void 0?"all":Se(i)),style:{minWidth:140},options:[{value:"all",label:"All Companies"},...l],showSearch:!0,optionFilterProp:"label",allowClear:!1})]})]}),D&&e.jsx(ga,{showIcon:!0,type:"warning",style:{marginBottom:12},message:"Catalog GAS URL not configured",description:"Listing works from the published CSV, but saving/updating requires VEHICLE_CATALOG_GAS_URL in the environment."}),e.jsxs("div",{style:{marginBottom:12,fontSize:12,color:"#475569"},children:["Showing ",Ae.length.toLocaleString("en-IN")," of ",U.length.toLocaleString("en-IN")," catalog records."]}),e.jsx(Bt,{columns:c,dataSource:Ae,loading:L,rowKey:i=>i.id||ye(i),tableLayout:d?"auto":"fixed",scroll:d?{x:"max-content"}:void 0,pagination:{current:xe,pageSize:je,total:Ae.length,showSizeChanger:!0,showQuickJumper:!0,pageSizeOptions:["10","25","50","100","200"],onChange:(i,M)=>{X(i),oe(M)},showTotal:(i,M)=>`${M[0]}-${M[1]} of ${i}`},size:d?"small":"middle"},$e),e.jsx(rt,{open:ce,title:w?"Edit Vehicle":"Add Vehicle",onCancel:()=>{A(!1),_(null)},onOk:v,okButtonProps:{loading:k},destroyOnClose:!0,children:e.jsxs(H,{form:J,layout:"vertical",children:[e.jsx(H.Item,{name:"company",label:"Company",rules:[{required:!0,message:"Enter company"}],children:e.jsx(Z,{placeholder:"e.g., HONDA",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>J.setFieldsValue({company:(i.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"model",label:"Model",rules:[{required:!0,message:"Enter model"}],children:e.jsx(Z,{placeholder:"e.g., SHINE",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>J.setFieldsValue({model:(i.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"variant",label:"Variant",rules:[{required:!0,message:"Enter variant"}],children:e.jsx(Z,{placeholder:"e.g., DISC",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>J.setFieldsValue({variant:(i.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"color",label:"Colors (comma-separated)",children:e.jsx(Z,{placeholder:"e.g., RED, BLACK, BLUE",allowClear:!0,style:{textTransform:"uppercase"},onChange:i=>J.setFieldsValue({color:(i.target.value||"").toUpperCase()})})}),e.jsx(H.Item,{name:"onRoadPrice",label:"On-Road Price (â‚¹)",rules:[{required:!0,message:"Enter price"}],children:e.jsx(Na,{style:{width:"100%"},min:0,step:500,parser:i=>Number((i||"").toString().replace(/[^\d.-]/g,"")),formatter:i=>i?Number(i).toLocaleString("en-IN"):""})})]})})]})}export{Tn as B,Nn as J,In as Q,An as U,Ln as V,Rn as a};
