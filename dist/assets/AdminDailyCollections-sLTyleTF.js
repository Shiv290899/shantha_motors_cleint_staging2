import{r as i,j as n}from"./index-Cpnbu_hS.js";import{a as J,b as Ue}from"./caseInsensitive-DUicqe8X.js";import{e as ze}from"./StockUpdate-D-ASYu6-.js";import{G as Re}from"./index-BzB-oRld.js";import{F as A}from"./index-DNb1SccI.js";import{S as O}from"./index-Bh1aWF1p.js";import{S as pe}from"./PostServiceSheet-B3EW42tp.js";import{S as ae}from"./index-D-dakd2l.js";import{B as y}from"./button-BatQfFEZ.js";import{F as oe}from"./Table-CrLdrUTt.js";import{M as $e}from"./index-_eB-6_5d.js";import{I as Se,s as p}from"./index-LPdCTC9Y.js";import{T as Je}from"./index-Hb-OJ-YF.js";import{D as We}from"./index-btmmUnu2.js";import{T as Ke}from"./index-1WhPD5b5.js";const{Text:Ve}=Ke;function dt(){const c=!Re.useBreakpoint().md,I="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",b="",be=()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}},F=i.useMemo(()=>be(),[]),we=F?.name||F?.displayName||F?.email||F?.username||"OWNER",[B,xe]=i.useState("summary"),[v,W]=i.useState([]),[K,re]=i.useState(!1),[S,ve]=i.useState("unsettled"),[w,V]=i.useState([]),[ie,j]=i.useState(!1),[m,je]=i.useState([]),[h,ke]=i.useState([]),[_,E]=i.useState(""),[q,G]=i.useState(!1),[Ce,Ne]=i.useState([]),[Ae,le]=i.useState(!1),[Ie,ce]=i.useState(!1),[L]=A.useForm(),[de,Le]=i.useState([]),[Pe,ue]=i.useState(!1),H=e=>`OwnerLedger:list:${String(e||"unsettled")}`;i.useEffect(()=>{try{const e=localStorage.getItem(H(S));if(!e){j(!1);return}const t=JSON.parse(e);t&&Array.isArray(t.rows)?(W(t.rows),j(!0)):j(!1)}catch{j(!1)}},[S]);const fe=async()=>{re(!0);try{const t=await J({webhookUrl:I,method:"GET",payload:b?{action:"owner_ledger_list",status:S,secret:b}:{action:"owner_ledger_list",status:S}}),o=t?.data||t||{},s=Array.isArray(o.rows)?o.rows:[];W(s);try{localStorage.setItem(H(S),JSON.stringify({at:Date.now(),rows:s}))}catch{}j(!0)}catch{p.error("Failed to load transactions")}finally{re(!1)}};i.useEffect(()=>{fe()},[B,JSON.stringify(m),JSON.stringify(h),S,I]);const me=async()=>{le(!0);try{const t=await J({webhookUrl:I,method:"GET",payload:b?{action:"owner_prev_due_list",secret:b}:{action:"owner_prev_due_list"}}),o=t?.data||t||{},s=Array.isArray(o.rows)?o.rows.slice():[],r=a=>{const l=Number(new Date(String(a||"")));return Number.isFinite(l)?l:0};s.sort((a,l)=>r(l?.updatedAt)-r(a?.updatedAt)),Ne(s)}catch{p.error("Could not load previous due entries")}finally{le(!1)}},Me=async()=>{ue(!0);try{const e=await Ue({role:"staff",status:"active",limit:1e5}),o=(Array.isArray(e?.data?.items)?e.data.items:[]).map(s=>{const r=s?.formDefaults?.staffName||s?.name||"",a=s?.formDefaults?.branchName||s?.primaryBranch&&(s.primaryBranch.name||s.primaryBranch.branchName)||"",l=[r||"(No name)"];return a&&l.push(`· ${a}`),{value:r,label:l.join(" "),branchName:a}}).filter(s=>s.value);Le(o)}catch{p.error("Could not load staff list")}finally{ue(!1)}},Te=async e=>{ce(!0);try{const t={action:"owner_prev_due_set",branch:String(e.branch||"").trim(),staff:String(e.staff||"").trim(),amount:e.amount,note:e.note||"",updatedBy:we},o=await J({webhookUrl:I,method:"POST",payload:t}),s=o?.data||o||{};if(s.success===!1)throw new Error(s.message||"Failed");p.success("Previous due updated"),me()}catch(t){p.error(t?.message||"Could not update previous due")}finally{ce(!1)}};i.useEffect(()=>{if(!q)return;L.resetFields();const e={};(m||[]).length===1&&(e.branch=m[0]),(h||[]).length===1&&(e.staff=h[0]),Object.keys(e).length&&L.setFieldsValue(e),Me(),me()},[q]),i.useEffect(()=>{V([])},[JSON.stringify(m),JSON.stringify(h)]);const De=Array.from(new Set(v.map(e=>(e.staff||"").toString()))).map(e=>({value:e,label:e||"(Unknown)"})),Oe=Array.from(new Set(v.map(e=>(e.branch||"").toString()))).map(e=>({value:e,label:e||"(Unknown)"})),U=e=>Number(e||0)||0,g=e=>String(e??"").trim().toLowerCase(),z=e=>{const t=e?.dateTimeIso||e?.date,o=Number(new Date(String(t)));return Number.isFinite(o)?o:0},Y=e=>[g(e?.branch),g(e?.staff),g(e?.sourceType),g(e?.sourceId),g(e?.customerMobile),g(e?.paymentMode),g(e?.cashAmount??e?.cashPending),g(e?.onlineAmount??e?.onlinePending),g(e?.utr)].join("|"),P=e=>{const t=U(e?.cashPending),o=U(e?.onlinePending),s=U(e?.cashAmount??e?.cashPending),r=U(e?.onlineAmount??e?.onlinePending),a=Math.max(0,s-t),l=Math.max(0,r-o);return{cashPending:t,onlinePending:o,cashAmount:s,onlineAmount:r,cashSettled:a,onlineSettled:l}},k=e=>{const t=P(e);return{cash:t.cashAmount,online:t.onlineAmount}},C="Cash",N="Online",Q="Total Amount",Z=e=>{try{if(!e)return"";const t=e instanceof Date?e:new Date(String(e));if(Number.isNaN(t.getTime()))return String(e);const o=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0");return`${r}-${s}-${o} ${a}:${l}`}catch{return String(e||"")}},X={display:"flex",flexDirection:"column",gap:2,lineHeight:1.2},R={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},ee={...R,opacity:.7},Fe=[{title:"DateTime / Branch",key:"dt",width:150,render:(e,t)=>n.jsxs("div",{style:X,children:[n.jsx("div",{style:R,children:Z(t.dateTimeIso||t.date)}),n.jsx("div",{style:ee,children:t.branch||"—"})]})},{title:"Source / Staff",key:"src",width:180,render:(e,t)=>{const o=`${String(t.sourceType||"").toUpperCase()} ${t.sourceId||""}`.trim();return n.jsxs("div",{style:X,children:[n.jsx("div",{style:R,children:o||"—"}),n.jsx("div",{style:ee,children:t.staff||"—"})]})}},{title:"Customer / Mobile",key:"cust",width:170,render:(e,t)=>n.jsxs("div",{style:X,children:[n.jsx("div",{style:R,children:t.customerName||"—"}),n.jsx("div",{style:ee,children:t.customerMobile||"—"})]})},{title:"Mode",dataIndex:"paymentMode",key:"mode",width:80,render:e=>String(e||"—").toUpperCase()},{title:C,key:"cash",width:80,align:"right",render:(e,t)=>Number(k(t).cash||0).toLocaleString("en-IN")},{title:N,key:"online",width:80,align:"right",render:(e,t)=>Number(k(t).online||0).toLocaleString("en-IN")},{title:"UTR / Ref",dataIndex:"utr",key:"utr",width:120,render:(e,t)=>{if(String(t?.paymentMode||"").toLowerCase()==="cash")return"";const s=String(e??"").trim();return!s||s.toLowerCase()==="undefined"||s.toLowerCase()==="null"?"":s}},{title:"Action",key:"act",width:110,render:(e,t)=>{const o=Number(t.cashPending||0)>0,s=Number(t.onlinePending||0)>0,r=a=>{const l=Y(t),d=Array.from(new Set((v||[]).filter(u=>Y(u)===l).map(u=>u?.id).filter(Boolean)));d.length&&ne([a],d)};return n.jsxs(O,{direction:"vertical",size:4,children:[o?n.jsx(y,{size:"small",onClick:()=>r("cash"),children:"Collect"}):null,s?n.jsx(y,{size:"small",onClick:()=>r("online"),children:"Verify"}):null]})}}],Be=[{title:"Branch",dataIndex:"branch",key:"branch"},{title:"Staff",dataIndex:"staff",key:"staff"},{title:"Amount",dataIndex:"amount",key:"amount",align:"right",render:e=>Number(e||0).toLocaleString("en-IN")},{title:"Note",dataIndex:"note",key:"note",ellipsis:!0},{title:"Updated By",dataIndex:"updatedBy",key:"updatedBy"},{title:"Updated At",dataIndex:"updatedAt",key:"updatedAt",render:e=>Z(e)}],f=e=>String(e||"").trim().toLowerCase(),te=i.useMemo(()=>{const e=new Map;return(v||[]).forEach(t=>{const o=Y(t),s=e.get(o);(!s||z(t)>=z(s))&&e.set(o,t)}),Array.from(e.values())},[v]),M=i.useMemo(()=>{const e=new Set((m||[]).map(f)),t=new Set((h||[]).map(f)),o=new Map;return(te||[]).forEach(s=>{const r=String(s.branch||""),a=String(s.staff||"");if(e.size&&!e.has(f(r))||t.size&&!t.has(f(a)))return;const l=`${f(r)}|${f(a)}`,d=o.get(l)||{branch:r,staff:a,cash:0,online:0},u=k(s);d.cash+=u.cash,d.online+=u.online,o.set(l,d)}),Array.from(o.values()).map(s=>({...s,total:s.cash+s.online}))},[v,m,h]),_e=[{title:"Branch",dataIndex:"branch",key:"branch"},{title:"Staff",dataIndex:"staff",key:"staff"},{title:C,dataIndex:"cash",key:"cash",align:"right",render:e=>Number(e||0).toLocaleString("en-IN")},{title:N,dataIndex:"online",key:"online",align:"right",render:e=>Number(e||0).toLocaleString("en-IN")},{title:Q,dataIndex:"total",key:"total",align:"right",render:e=>Number(e||0).toLocaleString("en-IN")}],$=i.useMemo(()=>M.reduce((e,t)=>(e.count=(e.count||0)+1,e.cash=(e.cash||0)+(Number(t.cash||0)||0),e.online=(e.online||0)+(Number(t.online||0)||0),e.total=(e.total||0)+(Number(t.total||0)||0),e),{}),[M]),x=i.useMemo(()=>{const e=new Set((m||[]).map(f)),t=new Set((h||[]).map(f)),o=(te||[]).filter(s=>{const r=f(s.branch),a=f(s.staff);return!(e.size&&!e.has(r)||t.size&&!t.has(a))});return o.sort((s,r)=>z(r)-z(s)),o},[te,m,h]),he=i.useMemo(()=>{const e=new Set(w),t=x.filter(r=>e.has(r.id)),o=t.reduce((r,a)=>r+(k(a).cash||0),0),s=t.reduce((r,a)=>r+(k(a).online||0),0);return{cash:o,online:s}},[w,x]),ge=i.useMemo(()=>{const e=new Set(w),t=x.filter(r=>e.has(r.id)),o=t.reduce((r,a)=>r+(P(a).cashPending||0),0),s=t.reduce((r,a)=>r+(P(a).onlinePending||0),0);return{cash:o,online:s}},[w,x]),ne=async(e,t,o={})=>{const s=e.includes("cash")&&e.includes("online")?"both":e[0]||"both";if(!t||!t.length)return;const r=o.optimistic!==!1,a=o.showMessage!==!1,l=new Set(e);if(r){const d=new Set;W(u=>{const T=(u||[]).map(se=>{if(!t.includes(se.id))return se;const D={...se};(l.has("cash")||l.has("both"))&&(D.cashPending=0),(l.has("online")||l.has("both"))&&(D.onlinePending=0);const ye=P(D);return ye.cashPending<=0&&ye.onlinePending<=0?(d.add(D.id),null):D}).filter(Boolean);try{localStorage.setItem(H(S),JSON.stringify({at:Date.now(),rows:T}))}catch{}return T}),d.size&&V(u=>u.filter(T=>!d.has(T))),j(!0)}try{const u=await J({webhookUrl:I,method:"POST",payload:b?{action:"owner_ledger_settle",mode:s,ids:t,secret:b}:{action:"owner_ledger_settle",mode:s,ids:t}});if(!((u?.data||u)?.success!==!1))throw new Error("Failed");a&&p.success("Updated")}catch{p.error("Update failed. Refresh to sync.")}},Ee=()=>{const e=B==="summary",t=e?[{key:"branch",label:"Branch"},{key:"staff",label:"Staff"},{key:"cash",label:C},{key:"online",label:N},{key:"total",label:Q}]:[{key:"date",label:"DateTime"},{key:"staff",label:"Staff"},{key:"branch",label:"Branch"},{key:"mode",label:"Mode"},{key:"cashAmount",label:C},{key:"onlineAmount",label:N},{key:"cashPending",label:"Cash Pending"},{key:"onlinePending",label:"Online Pending"},{key:"utr",label:"UTR / Ref"},{key:"customer",label:"Customer"},{key:"mobile",label:"Mobile"},{key:"source",label:"Source"}];if(!(e?M:x).length){p.info("No rows to export for current filters");return}const s=e?M.map(a=>({branch:a.branch,staff:a.staff,cash:a.cash,online:a.online,total:a.total})):x.map(a=>{const l=k(a),d=P(a);return{date:Z(a.dateTimeIso||a.date),staff:a.staff,branch:a.branch,mode:a.paymentMode,cashAmount:l.cash,onlineAmount:l.online,cashPending:d.cashPending,onlinePending:d.onlinePending,utr:a.utr,customer:a.customerName,mobile:a.customerMobile,source:`${String(a.sourceType||"").toUpperCase()} ${a.sourceId||""}`.trim()}});ze({filename:e?"daily-collections-summary.csv":"daily-collections-transactions.csv",headers:t,rows:s}),p.success(`Exported ${s.length} ${e?"rows":"transactions"}`)};return n.jsxs("div",{children:[n.jsxs(O,{style:{marginBottom:12,width:"100%",justifyContent:"space-between",flexWrap:"wrap"},children:[n.jsxs(O,{wrap:!0,children:[n.jsx(pe,{value:B,onChange:xe,options:[{label:"Summary",value:"summary"},{label:"Transactions",value:"transactions"}]}),n.jsx(ae,{mode:"multiple",allowClear:!0,placeholder:"Branches",value:m,onChange:je,style:{minWidth:c?140:220},options:Oe}),n.jsx(pe,{value:S,onChange:ve,options:[{label:"Unsettled",value:"unsettled"},{label:"Settled",value:"settled"},{label:"All",value:"all"}]}),n.jsx(ae,{mode:"multiple",allowClear:!0,placeholder:"Staff",value:h,onChange:ke,style:{minWidth:c?140:220},options:De})]}),n.jsxs(O,{children:[n.jsx(y,{onClick:Ee,children:"Export CSV"}),n.jsx(y,{onClick:fe,loading:K,children:"Refresh"}),n.jsx(y,{type:"primary",ghost:!0,onClick:()=>G(!0),children:"Assign Previous Due"})]})]}),B==="summary"?n.jsxs(n.Fragment,{children:[n.jsxs("div",{style:{display:"grid",gridTemplateColumns:c?"repeat(2, 1fr)":"repeat(6, 1fr)",gap:12,marginBottom:12},children:[n.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(135deg,#e0f7fa,#b2ebf2)"},children:[n.jsx("div",{style:{fontSize:12,opacity:.8},children:"Staff"}),n.jsx("div",{style:{fontSize:22,fontWeight:800},children:$.count||0})]}),n.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(135deg,#e8f5e9,#c8e6c9)"},children:[n.jsx("div",{style:{fontSize:12,opacity:.8},children:C}),n.jsx("div",{style:{fontSize:22,fontWeight:800},children:Number($.cash||0).toLocaleString("en-IN")})]}),n.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(135deg,#e3f2fd,#bbdefb)"},children:[n.jsx("div",{style:{fontSize:12,opacity:.8},children:N}),n.jsx("div",{style:{fontSize:22,fontWeight:800},children:Number($.online||0).toLocaleString("en-IN")})]}),n.jsxs("div",{style:{padding:12,borderRadius:10,background:"linear-gradient(135deg,#fff3e0,#ffe0b2)"},children:[n.jsx("div",{style:{fontSize:12,opacity:.8},children:Q}),n.jsx("div",{style:{fontSize:22,fontWeight:800},children:Number($.total||0).toLocaleString("en-IN")})]})]}),n.jsx(oe,{rowKey:e=>`${e.branch}-${e.staff}`,dataSource:M,columns:_e,loading:K&&!ie,size:c?"small":"middle",scroll:{x:"max-content"},pagination:{pageSize:c?10:20,size:c?"small":"default"}})]}):n.jsxs(n.Fragment,{children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,flexWrap:"wrap",gap:8},children:[n.jsxs("div",{style:{display:"flex",gap:16,alignItems:"center"},children:[n.jsxs("div",{children:[n.jsxs("strong",{children:["Selected ",C,":"]})," ",he.cash.toLocaleString("en-IN")]}),n.jsxs("div",{children:[n.jsxs("strong",{children:["Selected ",N,":"]})," ",he.online.toLocaleString("en-IN")]})]}),n.jsxs(O,{children:[n.jsx(y,{type:"primary",disabled:ge.cash<=0||!!_,loading:_==="cash",onClick:async()=>{E("cash");try{await ne(["cash"],w)}finally{E("")}},children:"Collect Cash"}),n.jsx(y,{type:"primary",disabled:ge.online<=0||!!_,loading:_==="online",onClick:async()=>{E("online");try{await ne(["online"],w)}finally{E("")}},children:"Verify Online"})]})]}),n.jsx(oe,{rowKey:e=>e.id,dataSource:x,columns:Fe,loading:K&&!ie,size:"small",className:"compact-table",tableLayout:c?"auto":"fixed",rowSelection:{selectedRowKeys:w,onChange:V},pagination:{pageSize:c?10:20,size:c?"small":"default"},scroll:c?{x:"max-content"}:void 0})]}),n.jsxs($e,{open:q,title:"Assign Previous Due",onCancel:()=>G(!1),width:c?Math.min((typeof window<"u"?window.innerWidth:360)-24,720):720,footer:[n.jsx(y,{onClick:()=>G(!1),children:"Close"},"close"),n.jsx(y,{type:"primary",loading:Ie,onClick:()=>L.submit(),children:"Save"},"save")],destroyOnClose:!0,children:[n.jsxs(A,{layout:"vertical",form:L,onFinish:Te,children:[n.jsx(A.Item,{label:"Staff",name:"staff",rules:[{required:!0,message:"Staff is required"}],children:n.jsx(ae,{showSearch:!0,placeholder:"Select staff",optionFilterProp:"label",loading:Pe,options:de,onChange:e=>{try{const t=de.find(o=>o.value===e);t?.branchName&&L.setFieldsValue({branch:t.branchName})}catch{}}})}),n.jsx(A.Item,{label:"Branch",name:"branch",rules:[{required:!0,message:"Branch is required"}],children:n.jsx(Se,{placeholder:"Auto-filled from staff primary branch",autoComplete:"off",disabled:!0})}),n.jsx(A.Item,{label:"Amount (₹)",name:"amount",rules:[{required:!0,message:"Amount is required"}],children:n.jsx(Je,{min:0,step:100,style:{width:"100%"},placeholder:"Enter amount"})}),n.jsx(A.Item,{label:"Owner Note",name:"note",children:n.jsx(Se.TextArea,{rows:2,maxLength:240,placeholder:"Optional note shown to staff"})})]}),n.jsx(We,{orientation:"left",plain:!0,children:"Assigned amounts"}),n.jsx(oe,{rowKey:e=>e.id||`${e.branch}-${e.staff}`,dataSource:Ce,columns:Be,loading:Ae,size:c?"small":"middle",pagination:{pageSize:c?5:8,size:c?"small":"default"},scroll:{x:"max-content"}}),n.jsx(Ve,{type:"secondary",style:{fontSize:12},children:"Amounts assigned here appear as Previous Due on the staff dashboard without inflating the cash/online pending cards."})]})]})}export{dt as A};
