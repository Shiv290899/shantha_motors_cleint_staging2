import{j as e,r as N,R as Be,G as $e,u as rt}from"./index-DByWGH7d.js";import ot from"./Quotation-l_ikMOIo.js";import at from"./JobCard-B3-NKmp8.js";import{F as Ve,R as it,P as lt,B as ct}from"./BookingForm-DWuipBFi.js";import{V as dt,I as mt}from"./VehicleSearch-D1zRpTG1.js";import{P as ut,S as pt}from"./StockUpdate-D0yZO869.js";import{T as Ge,C as xe}from"./index-BP3wDuv0.js";import{R as ht}from"./ToolOutlined-DHI-CmMa.js";import{u as ft,A as gt}from"./useAnnouncementBadge-DHloFZST.js";import{h as yt}from"./PostServiceSheet-CYx6JQNX.js";import{d as bt}from"./index-53S8uf0A.js";import{s as Fe,a as Te}from"./caseInsensitive-GFj-Zur4.js";import{F as k}from"./index-fiQTrVnU.js";import{s as Y,I as ve}from"./index-mc3XMWnF.js";import{z as me,A as z,T as xt}from"./TextArea-BDVSLBQS.js";import{S as qe,a as We,E as we}from"./index-C2v3hDcT.js";import{T as ue}from"./index-eVJyXskz.js";import{B as X}from"./button-BmMOSO5i.js";import{D as Pe}from"./index-BW-IFf4J.js";import{F as Ye}from"./Table-g31uHPfu.js";import{T as ye}from"./index-CBM7Jb_H.js";import{S as be}from"./index-DlPElhKY.js";import{G as Xe}from"./index-CINaf3Eu.js";import{T as $}from"./index-DMDeWAJZ.js";import{M as jt}from"./index-BSIb012r.js";import"./index-Bbhzw47L.js";import"./useBubbleLock-CujG_eFi.js";import"./PrinterOutlined-De6aMjcs.js";import"./AntdIcon-DqBt8ItB.js";import"./PlusOutlined-DysDbfLf.js";import"./PlusOutlined-68_8d4GS.js";import"./index-BnYplE8B.js";import"./iconBase-CLQOV217.js";import"./index-DU0h2yX8.js";import"./PurePanel-B8np65kh.js";import"./ThunderboltOutlined-BvFXYw4P.js";import"./CheckOutlined-BWW6_Ha2.js";import"./pickAttrs-DLhOEXIt.js";import"./index-BQHoEo7h.js";import"./EyeOutlined-DF4m-4HC.js";import"./index-CKg7-Gtk.js";import"./Skeleton-wxJCniSA.js";import"./useClosable-Dko-A-M4.js";import"./LeftOutlined-BxWPQNPi.js";import"./DownOutlined-CAwmfW-2.js";import"./index-CUWDS_la.js";import"./addEventListener-7EhgV0gu.js";function St(){const t=(y,j)=>e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:6},children:[y,e.jsx("span",{children:j})]}),s="https://script.google.com/macros/s/AKfycbxXtfRVEFeaKu10ijzfQdOVlgkZWyH1q1t4zS3PHTX9rQQ7ztRJdpFV5svk98eUs3UXuw/exec",n="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",i=s,l=n,c=[{key:"quotation",label:t(e.jsx(it,{}),"Quotation"),children:e.jsx(Ve,{mode:"quotation",webhookUrl:i})},{key:"jobcard",label:t(e.jsx(ht,{}),"Job Card"),children:e.jsx(Ve,{mode:"jobcard",webhookUrl:l})}];return e.jsx(Ge,{defaultActiveKey:"quotation",items:c,destroyInactiveTabPane:!0})}function Nt(t){try{const s=bt(t);return s.isValid()?s.format("DD-MM-YYYY HH:mm"):"-"}catch{return"-"}}const At=N.forwardRef(function({active:s=!0,vals:n={}},i){const l=String(n?.branchName||"").trim(),c=l==="Byadarahalli",y=n?.dateTimeIso||new Date,j=Array.isArray(n?.items)?n.items:[],A=Number(n?.summaryTotal||0)||0,r=Number(n?.customer?.cashCollected??n?.cashCollected??0)||0,f=Number(n?.customer?.onlineCollected??n?.onlineCollected??0)||0,S=r>0&&f>0?`CASH â‚¹${r} + ONLINE â‚¹${f}`:r>0?`CASH â‚¹${r}`:f>0?`ONLINE â‚¹${f}`:String(n?.customer?.paymentMode||"").toUpperCase()||"-",m=n?.customer?.utr||n?.utr;return e.jsxs("div",{ref:i,className:`print-sheet ${s?"active":""}`,children:[e.jsx("style",{children:`
@page { size: A4 portrait; margin: 0; }
@media screen { body:not(.print-host) .print-sheet { display: none !important; } }
@media print {
  body * { visibility: hidden !important; }
  .print-sheet { display: block; }
  .print-sheet.active, .print-sheet.active * { visibility: visible !important; }
  .print-sheet.active { position: absolute; inset: 0; width: 100%; }
}
.wrap { padding: 10mm; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif; color: #000; }
.box { border: 1px solid #111; border-radius: 2mm; padding: 4mm; }
.hdr { display: grid; grid-template-columns: 26mm 1fr 26mm; align-items: center; gap: 4mm; }
.shop { text-align: center; }
.shop .en { font-size: 14.5pt; font-weight: 700; line-height: 1.08; }
.shop .sub { font-size: 9.5pt; margin-top: 1mm; }
.title { text-align: center; font-size: 16.5pt; font-weight: 800; margin: 6px 0 10px; letter-spacing: .4px; }
.kv{ display:grid; grid-template-columns: 32mm 1fr; column-gap:3mm; padding:1.5mm 0; border-bottom:1px solid #e5e7eb; }
.kv .name{ font-weight:600; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:2mm; }
.full{ grid-column:1 / -1; }
table { width: 100%; border-collapse: collapse; font-size: 11pt; margin-top: 2mm; }
th, td { border: 1px solid #111; padding: 2.5mm; }
th { background: #fafafa; }
.right { text-align: right; }
.center { text-align: center; }
.sign-row { display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:8mm; }
.sign { border-top: 1px dashed #777; padding-top: 3mm; text-align: center; font-size: 10pt; }
      `}),e.jsx("div",{className:"wrap",children:e.jsxs("div",{className:"box",children:[e.jsxs("div",{className:"hdr",children:[e.jsx("img",{src:c?"/honda-logo.png":"/shantha-logoprint.jpg",alt:"Logo",style:{width:"100%",maxHeight:92}}),e.jsx("div",{className:"shop",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"en",children:"NH MOTORS | à²à²¨à³ à²à²šà³ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsxs("div",{className:"sub",children:["Site No. 116/1, Bydarahalli, Magadi Main Road, Opp.",e.jsx("br",{}),"HP Petrol Bunk, Bangalore - 560091"]}),e.jsx("div",{className:"sub",children:"Mob: 9731366921 / 8073283502 / 9741609799"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"en",children:"SHANTHA MOTORS | à²¶à²¾à²‚à²¤ à²®à³‹à²Ÿà²°à³à²¸à³"}),e.jsx("div",{className:"sub",children:"Multi Brand Two Wheeler Sales & Service"}),e.jsx("div",{className:"sub",children:"Mob No : 9731366921 / 8073283502"})]})}),e.jsxs("div",{children:[e.jsx("img",{src:"/location-qr.png",alt:"QR",style:{width:"100%",maxHeight:92}}),e.jsx("div",{style:{fontSize:12,fontWeight:600,marginTop:4,textAlign:"center"},children:"Scan for Location"})]})]}),e.jsx("div",{className:"title",children:"Minor Sales Receipt"}),e.jsxs("div",{className:"grid",children:[e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Date/Time:"}),e.jsx("div",{children:Nt(y)})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Order ID:"}),e.jsx("div",{children:n?.orderId||"-"})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Branch:"}),e.jsx("div",{children:l||"-"})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Executive:"}),e.jsx("div",{children:n?.staffName||"-"})]}),e.jsxs("div",{className:"kv full",children:[e.jsx("div",{className:"name",children:"Customer:"}),e.jsxs("div",{children:[String(n?.customer?.name||"-").toUpperCase()," (",n?.customer?.mobile||"-",")"]})]}),e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"Payment:"}),e.jsx("div",{children:S})]}),f>0&&e.jsxs("div",{className:"kv",children:[e.jsx("div",{className:"name",children:"UTR / Ref:"}),e.jsx("div",{children:m||"-"})]})]}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{className:"center",style:{width:"16mm"},children:"Qty"}),e.jsx("th",{className:"right",style:{width:"26mm"},children:"Unit"}),e.jsx("th",{className:"right",style:{width:"30mm"},children:"Amount"})]})}),e.jsxs("tbody",{children:[j.map((a,p)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.item}),e.jsx("td",{className:"center",children:a.qty}),e.jsxs("td",{className:"right",children:["â‚¹",a.unitPrice]}),e.jsxs("td",{className:"right",children:["â‚¹",a.amount]})]},p)),e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"right",style:{fontWeight:700},children:"Total"}),e.jsxs("td",{className:"right",style:{fontWeight:700},children:["â‚¹",A]})]})]})]}),e.jsxs("div",{className:"sign-row",children:[e.jsx("div",{className:"sign",children:"Customer Signature"}),e.jsx("div",{className:"sign",children:"Authorized Signature"})]})]})})]})}),Ce="https://script.google.com/macros/s/AKfycbzUYgfSeU54u65-wYXCFUAnlCCX9jUnbRYC3DhKrexWBi5wLJzbKlghU1TrfuChGtbc/exec",vt=[{required:!0,message:"Mobile number is required"},{pattern:/^[6-9]\d{9}$/,message:"Enter a valid 10-digit Indian mobile number"}],Ze={helmet:{label:"Helmet",prices:[500,400]},mat:{label:"Floor Mat",prices:[200,150,100]},vehicleCover:{label:"Vehicle Cover",prices:[300,250,200]},numberPlateFrame:{label:"Number Plate Frame",prices:[200,150,100]},others:{label:"Others",prices:[]}},wt=[...Object.entries(Ze)].sort((t,s)=>(t[0]==="others")-(s[0]==="others")).map(([t,s])=>({value:t,label:s.label})),W=t=>Number(String(t??0).replace(/[â‚¹,\s]/g,""))||0;function Je(t){return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(Math.max(0,Math.round(t||0)))}function He(t){return String(t||"").replace(/\D/g,"").slice(-10)}function Oe(){const t=new Date;return[t.getFullYear().toString().slice(-2),("0"+(t.getMonth()+1)).slice(-2),("0"+t.getDate()).slice(-2),"-",Math.random().toString(36).slice(2,6).toUpperCase()].join("")}function Ct(){const[t]=k.useForm(),[,s]=N.useState(!1),[n,i]=N.useState({staffName:"",branchName:""}),[l,c]=N.useState([]),[y,j]=N.useState(Oe()),[A,r]=N.useState(!1),[f,S]=N.useState(null),m=Be.useRef(null),a="MinorSales:outbox",p=(o,u)=>{try{const h=localStorage.getItem(o);return h?JSON.parse(h):u}catch{return u}},v=(o,u)=>{try{localStorage.setItem(o,JSON.stringify(u))}catch{}},V=o=>{const u=p(a,[]),h={id:Date.now()+":"+Math.random().toString(36).slice(2),job:o};return u.push(h),v(a,u),h.id},Z=o=>{const u=p(a,[]);v(a,u.filter(h=>h.id!==o))},U=async()=>{try{const o=p(a,[]);for(const u of o){const h=u.job||{};if(h?.type==="minor"&&Ce)try{const g=await Fe({webhookUrl:Ce,method:"POST",payload:h.data});(g?.data||g)?.success!==!1&&Z(u.id)}catch{}}}catch{}};N.useEffect(()=>{setTimeout(()=>{U()},0)},[]),N.useEffect(()=>{const o=()=>U();return window.addEventListener("online",o),()=>window.removeEventListener("online",o)},[]),N.useEffect(()=>{(async()=>{try{let o=null;try{const g=localStorage.getItem("user");o=g?JSON.parse(g):null}catch{}if(!o){const g=await $e().catch(()=>null);if(g?.success&&g.data){o=g.data;try{localStorage.setItem("user",JSON.stringify(o))}catch{}}}const u=o?.formDefaults?.staffName||o?.name||"",h=o?.formDefaults?.branchName||o?.primaryBranch?.name||(Array.isArray(o?.branches)?typeof o.branches[0]=="string"?o.branches[0]:o.branches[0]?.name||"":"");i({staffName:u,branchName:h})}catch{}})()},[]);const I=k.useWatch("item",t),M=I?Ze[I]:null,F=k.useWatch("price",t),le=k.useWatch("qty",t)||1,J=k.useWatch("customItemName",t),ee=k.useWatch("customQty",t)||1,H=k.useWatch("paymentCash",t),ce=k.useWatch("paymentOnline",t),E=N.useMemo(()=>!Array.isArray(l)||l.length===0?0:l.reduce((o,u)=>o+Number(u.amount||0),0),[l]),Ie=N.useMemo(()=>W(H)+W(ce),[H,ce]),Se=E>0&&Ie===W(E),te=N.useMemo(()=>{if(!I)return null;if(I==="others"){const g=Number(F),T=Number(ee),O=(J||"").trim();return!O||!g?null:{item:O.toUpperCase(),qty:T,unitPrice:g,amount:g*T}}if(!M||!F)return null;const o=Number(le),u=Number(F);return{item:String(M.label||"").toUpperCase(),qty:o,unitPrice:u,amount:u*o}},[I,M,F,le,ee,J]);N.useEffect(()=>{const o=W(H),u=W(ce);E>0&&o===0&&u===0&&t.setFieldsValue({paymentCash:E,paymentOnline:0})},[E,H,ce,t]);function ze(){if(!te){Y.warning("Select item, price, and qty first");return}c(o=>{const u=o.findIndex(h=>h.item===te.item&&Number(h.unitPrice)===Number(te.unitPrice));if(u>=0){const h=[...o],g=Number(h[u].qty||0)+Number(te.qty||0);return h[u]={...h[u],qty:g,amount:g*Number(h[u].unitPrice)},h}return[...o,te]}),I==="others"?t.setFieldsValue({item:void 0,price:void 0,customQty:1,customItemName:void 0}):t.setFieldsValue({item:void 0,price:void 0,qty:1})}N.useEffect(()=>{if(!I||I==="others"||!M||!F)return;t.getFieldValue("qty")||t.setFieldsValue({qty:1});const u=te;u&&u.item&&Number(u.unitPrice)>0&&(c(h=>{const g=h.findIndex(T=>T.item===u.item&&Number(T.unitPrice)===Number(u.unitPrice));if(g>=0){const T=[...h],O=Number(T[g].qty||0)+Number(u.qty||1);return T[g]={...T[g],qty:O,amount:O*Number(T[g].unitPrice)},T}return[...h,u]}),t.setFieldsValue({item:void 0,price:void 0,qty:1}),Y.success("Added to cart"))},[I,F]);function de(o,u){c(h=>{const g=[...h],T=Math.max(1,Number(u||1)),O=Number(g[o].unitPrice||0);return g[o]={...g[o],qty:T,amount:T*O},g})}function L(o){c(u=>u.filter((h,g)=>g!==o))}async function ne(){r(!0);try{if(await new Promise(se=>setTimeout(se,0)),!l.length){Y.warning("Add at least one item to cart");return}const o=await t.validateFields(["custName","custMobile","paymentCash","paymentOnline","utr"]),u=W(o.paymentCash),h=W(o.paymentOnline),g=u+h;if(g!==W(E)){Y.error("Cash + Online should equal the cart total.");return}const T=u>0&&h>0?"CASH+ONLINE":h>0?"ONLINE":"CASH",O={action:"minor_sales_save",data:{staffName:n.staffName||void 0,branchName:n.branchName||void 0,dateTimeIso:new Date().toISOString(),orderId:y,summaryTotal:E,source:"minorsales",cashCollected:u,onlineCollected:h,totalCollected:g,items:l,purchased:!0,customer:{name:String(o.custName||"").trim().toUpperCase(),mobile:He(o.custMobile),paymentMode:T,utr:h>0&&String(t.getFieldValue("utr")||"").trim()||void 0,cashCollected:u,onlineCollected:h}}},Ne=V({type:"minor",data:O});setTimeout(async()=>{try{if(Ce){const se=await Fe({webhookUrl:Ce,method:"POST",payload:O});(se?.data||se)?.success!==!1&&Z(Ne)}}catch{}},0),Y.loading({key:"msave",content:"Saving in backgroundâ€¦",duration:1}),S({staffName:n.staffName,branchName:n.branchName,dateTimeIso:new Date().toISOString(),orderId:y,summaryTotal:E,source:"minorsales",cashCollected:u,onlineCollected:h,totalCollected:g,items:l,customer:{name:String(o.custName||"").trim().toUpperCase(),mobile:He(o.custMobile),paymentMode:T,cashCollected:u,onlineCollected:h,utr:h>0&&String(t.getFieldValue("utr")||"").trim()||void 0}}),await new Promise(se=>setTimeout(se,0)),await yt(m.current);try{t.resetFields()}catch{}c([]),j(Oe()),S(null)}catch(o){if(o?.errorFields)return;console.error("Print slip failed",o),Y.error("Unable to print slip")}finally{r(!1)}}const pe=N.useMemo(()=>({item:void 0,price:void 0,qty:1,customQty:1,paymentCash:0,paymentOnline:0}),[]);function he(){try{t.resetFields()}catch{}c([]),j(Oe())}return e.jsxs(xe,{title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(ye.Text,{strong:!0,style:{fontSize:16},children:"Minor Sales (Quick)"}),e.jsxs("div",{style:{fontSize:11,color:"#888"},children:[n.branchName||""," Â· ",n.staffName||""]})]}),e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontSize:11,textTransform:"uppercase",letterSpacing:1},children:"Order ID"}),e.jsx("div",{style:{fontWeight:700},children:y})]})]}),bodyStyle:{padding:16},style:{borderRadius:10,boxShadow:"0 3px 10px rgba(0,0,0,0.06)"},extra:e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx(ye.Text,{style:{fontSize:12,color:"#888"},children:"Cart Total"}),e.jsx("div",{style:{fontWeight:700,fontSize:16},children:Je(E)})]}),children:[e.jsxs(k,{form:t,layout:"vertical",initialValues:pe,children:[e.jsxs(me,{gutter:[12,12],children:[e.jsx(z,{xs:24,md:10,children:e.jsx(k.Item,{name:"item",label:"Item",rules:[{required:!0,message:"Select item"}],children:e.jsx(qe,{options:wt,placeholder:"Choose item",showSearch:!0,optionFilterProp:"label",allowClear:!0})})}),e.jsx(z,{xs:24,md:8,children:I==="others"?e.jsx(k.Item,{name:"price",label:"Price (â‚¹)",rules:[{required:!0,message:"Enter price"}],children:e.jsx(ue,{style:{width:"100%"},min:1,step:1,placeholder:"Enter price"})}):e.jsx(k.Item,{name:"price",label:"Price (â‚¹)",rules:[{required:!0,message:"Select price"}],children:e.jsx(qe,{placeholder:"Select price",disabled:!M,options:(M?.prices||[]).map(o=>({label:`â‚¹${o}`,value:o}))})})}),e.jsx(z,{xs:24,md:6,children:I==="others"?e.jsx(k.Item,{name:"customQty",label:"Quantity",rules:[{required:!0,message:"Enter quantity"}],children:e.jsx(ue,{style:{width:"100%"},min:1,step:1})}):e.jsx(k.Item,{name:"qty",label:"Quantity",rules:[{required:!0,message:"Enter quantity"}],children:e.jsx(ue,{style:{width:"100%"},min:1,step:1})})})]}),I==="others"&&e.jsx(me,{gutter:[12,12],children:e.jsx(z,{xs:24,md:16,children:e.jsx(k.Item,{name:"customItemName",label:"Item Name (Others)",rules:[{required:!0,message:"Enter item name"}],getValueFromEvent:o=>o&&o.target?o.target.value.toUpperCase():o,children:e.jsx(ve,{placeholder:"TYPE ITEM NAME"})})})}),e.jsx(me,{children:e.jsx(z,{span:24,children:e.jsx(X,{onClick:ze,type:"primary",ghost:!0,disabled:I==="others"?!(J&&F):!(M&&F),children:"Add to cart"})})}),e.jsx(Pe,{style:{margin:"12px 0"}}),e.jsx(xe,{size:"small",title:"Cart",style:{marginBottom:12},bodyStyle:{padding:8},extra:e.jsxs(ye.Text,{strong:!0,children:["Items: ",l.length]}),children:e.jsx(Ye,{dataSource:l.map((o,u)=>({key:u,...o})),pagination:!1,size:"small",locale:{emptyText:"No items added yet"},columns:[{title:"Item",dataIndex:"item"},{title:"Qty",dataIndex:"qty",render:(o,u,h)=>e.jsx(ue,{min:1,value:o,onChange:g=>de(h,g)})},{title:"Unit (â‚¹)",dataIndex:"unitPrice"},{title:"Amount (â‚¹)",dataIndex:"amount"},{title:"Action",render:(o,u,h)=>e.jsx(ut,{title:"Remove this item?",onConfirm:()=>L(h),children:e.jsx(X,{danger:!0,size:"small",children:"Remove"})})}]})}),e.jsxs(xe,{size:"small",title:"Customer & Payment",bodyStyle:{padding:8},children:[e.jsxs(me,{gutter:12,children:[e.jsx(z,{xs:24,md:8,children:e.jsx(k.Item,{name:"custName",label:"Name",rules:[{required:!0,message:"Name is required"}],getValueFromEvent:o=>o&&o.target?o.target.value.toUpperCase():o,children:e.jsx(ve,{placeholder:"CUSTOMER NAME"})})}),e.jsx(z,{xs:24,md:8,children:e.jsx(k.Item,{name:"custMobile",label:"Mobile",rules:vt,children:e.jsx(ve,{maxLength:10,placeholder:"10-digit mobile"})})})]}),e.jsxs(me,{gutter:12,children:[e.jsx(z,{xs:24,md:8,children:e.jsx(k.Item,{name:"paymentCash",label:"Cash (â‚¹)",rules:[{validator:(o,u)=>W(u)>=0?Promise.resolve():Promise.reject(new Error("Enter cash amount (â‚¹)"))}],children:e.jsx(ue,{min:0,step:50,style:{width:"100%"},prefix:"â‚¹",placeholder:"0"})})}),e.jsx(z,{xs:24,md:8,children:e.jsx(k.Item,{name:"paymentOnline",label:"Online (â‚¹)",rules:[{validator:(o,u)=>W(u)>=0?Promise.resolve():Promise.reject(new Error("Enter online amount (â‚¹)"))}],children:e.jsx(ue,{min:0,step:50,style:{width:"100%"},prefix:"â‚¹",placeholder:"0"})})}),e.jsx(z,{xs:24,md:8,children:e.jsx(k.Item,{shouldUpdate:!0,noStyle:!0,children:()=>{const o=W(t.getFieldValue("paymentOnline"));return e.jsx(k.Item,{name:"utr",label:"UTR / Reference No.",rules:o>0?[{required:!0,message:"Enter UTR/Reference for online payments"}]:[],getValueFromEvent:u=>{const h=u&&u.target?u.target.value:u;return typeof h=="string"?h.toUpperCase():h},children:e.jsx(ve,{placeholder:"e.g., 23XXXXUTR123",style:{textTransform:"uppercase"},disabled:o<=0})})}})})]})]}),e.jsxs(me,{justify:"space-between",align:"middle",style:{marginTop:12},children:[e.jsxs(z,{children:[e.jsx(ye.Text,{type:"secondary",style:{fontSize:12},children:"Net Payable"}),e.jsx("div",{style:{fontSize:18,fontWeight:700},children:Je(E)})]}),e.jsx(z,{children:e.jsxs(be,{children:[e.jsx(X,{onClick:he,disabled:A,children:"Clear"}),e.jsx(X,{type:"primary",onClick:ne,disabled:!l.length||A||!Se,loading:A,children:"Print"})]})})]})]}),e.jsx("div",{style:{display:"none"},children:e.jsx(At,{ref:m,active:A,vals:f||{}})})]})}const Pt={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},{Text:P}=ye;function Tt(){const t=rt(),n=!Xe.useBreakpoint().md,l="https://script.google.com/macros/s/AKfycbxwuwETUUiAoFyksSoEOHVimCtlIZYb6JTQ7yJ8-vkwth9xYwEOlMA8ktiE45UQ6VA3Lg/exec",c="",j="https://script.google.com/macros/s/AKfycbwSn5hp1cSWlJMGhe2cYUtid2Ruqh9H13mZbq0PwBpYB0lMLufZbIjZ5zioqtKgE_0sNA/exec",A="",[r,f]=N.useState({bookingAmountPending:0,jcAmountPending:0,minorSalesAmountPending:0,totalPending:0,prevDueAssigned:0}),[S,m]=N.useState(!1),[a,p]=N.useState(!1),[v,V]=N.useState("cash"),[Z,U]=N.useState([]),[I,M]=N.useState(!1),[F,le]=N.useState(!1),[J,ee]=N.useState(!1),[H,ce]=N.useState([]),[E,Ie]=N.useState([]),[Se,te]=N.useState(null),de=(()=>{try{return JSON.parse(localStorage.getItem("user")||"null")}catch{return null}})(),L=de?.formDefaults?.branchName||de?.primaryBranch?.name||"",ne=de?.formDefaults?.staffName||de?.name||"",pe=`StaffAccount:${L}|${ne}`;N.useEffect(()=>{try{const d=localStorage.getItem(pe);if(d){const b=JSON.parse(d);b&&b.data&&(f(b.data),le(!0))}}catch{}},[pe]);const he=d=>{try{localStorage.setItem(pe,JSON.stringify({at:Date.now(),data:d}))}catch{}},o=async()=>{if(!(!L||!ne)){m(!0);try{const b=await Te({webhookUrl:l,method:"GET",payload:c?{action:"staff_ledger_summary",branch:L,staff:ne,secret:c}:{action:"staff_ledger_summary",branch:L,staff:ne}}),w=b?.data||b||{};if(!w?.success)throw new Error("Failed");const x=w?.data&&typeof w.data=="object"?w.data:w,C=Number(x.prevDueAssigned??x.openingBalance??x.opening??0)||0,Q={bookingAmountPending:0,jcAmountPending:0,minorSalesAmountPending:0,totalPending:Number(x.totalPending||0)||0,cashAmountPending:Number(x.cashPending||0)||0,onlineAmountPending:Number(x.onlinePending||0)||0,total:Number(x.totalPending||0)||0,cashAmount:Number(x.cashPending||0)||0,onlineAmount:Number(x.onlinePending||0)||0,settlementDone:!1,lastSettledAt:x.lastSettledAt||void 0,prevDueAssigned:C,prevDueNote:x.prevDueNote||"",prevDueUpdatedAt:x.prevDueUpdatedAt||x.prevDueAssignedAt||"",prevDueUpdatedBy:x.prevDueUpdatedBy||""};f(Q),he(Q),m(!1);try{const re=await Qe({GAS_URL:l,SECRET:c,branch:L,staff:ne,mode:"all"}),K=q=>{const _=String(q||"").toLowerCase().trim().replace(/[^a-z]/g,"");return _.startsWith("book")?"booking":_==="jc"||_.includes("jobcard")||_.includes("job")?"jc":_.includes("minor")?"minor":"other"},B=re.reduce((q,R)=>{const _=K(R.sourceType??R.SourceType??R.srcType??R.SrcType),Me=Number(R.cashPending??R.CashPending??R.cash??R.Cash??0)||0,fe=Number(R.onlinePending??R.OnlinePending??R.onLinePending??R.online??R.Online??0)||0,ae=Me+fe;return _==="booking"?q.booking+=ae:_==="jc"?q.jc+=ae:_==="minor"?q.minor+=ae:q.other+=ae,q},{booking:0,jc:0,minor:0,other:0}),oe={...Q,bookingAmount:B.booking,jcAmount:B.jc,minorSalesAmount:B.minor,bookingAmountPending:B.booking,jcAmountPending:B.jc,minorSalesAmountPending:B.minor};f(oe),he(oe)}catch{f(Q),he(Q)}}catch{Y.error("Could not load account summary")}finally{m(!1)}}};N.useEffect(()=>{o()},[l]);const u=Math.max(1e3,parseInt("600000",10)||6e5);N.useEffect(()=>{const d=setInterval(()=>{try{o()}catch{}try{Ae()}catch{}},u);return()=>clearInterval(d)},[l,u]);const h=d=>new Intl.NumberFormat("en-IN",{maximumFractionDigits:0}).format(Number(d||0)),g=N.useMemo(()=>{const d=ae=>Number.isFinite(Number(ae))?Number(ae):0,b=d(r.cashAmount??r.cashAmountPending??r.cash??r.cashPending??0),w=d(r.onlineAmount??r.onlineAmountPending??r.online??r.onlinePending??0);let x=d(r.total??r.totalPending??b+w);x||(x=b+w);const C=d(r.bookingAmountPending??r.bookingAmount??0),Q=d(r.minorSalesAmountPending??r.minorSalesAmount??0),re=d(r.jcAmountPending??r.jcAmount??0),K=C+Q+re,B=d(r.prevDueAssigned??r.prevDue??r.openingBalance??r.opening??0),oe=B+K;d(r.jcCashPending??r.jcCash??0),d(r.jcOnlinePending??r.jcOnline??0);let q=d(r.closingPending??r.outstandingPending??r.closing??0);q||(q=Math.max(0,K-x));const R=Math.max(0,B+K-x),_=b,Me=_+w,fe={total:x,cash:_,online:w,totalCollected:Me,jc:re,booking:C,minor:Q,prevDue:B,breakdownTotal:oe,prevDueNote:r.prevDueNote||"",prevDueUpdatedAt:r.prevDueUpdatedAt||void 0,prevDueUpdatedBy:r.prevDueUpdatedBy||"",settlementDone:!!r.settlementDone,lastSettledAt:r.lastSettledAt||r.lastSettlementAt||void 0,pending:q,pendingAll:R,sales:K};return fe.settlementDone?{total:0,cash:0,online:0,totalCollected:0,jc:0,booking:0,minor:0,prevDue:0,breakdownTotal:0,prevDueNote:"",prevDueUpdatedAt:void 0,prevDueUpdatedBy:"",settlementDone:!0,lastSettledAt:fe.lastSettledAt,pending:0,pendingAll:0,sales:0}:fe},[r]),T=N.useMemo(()=>{const d=[];if(r.prevDueNote&&d.push(`Note: ${r.prevDueNote}`),r.prevDueUpdatedBy||r.prevDueUpdatedAt){const b=r.prevDueUpdatedAt?ge(r.prevDueUpdatedAt):"",x=["Assigned",(r.prevDueUpdatedBy?`by ${r.prevDueUpdatedBy}`:"").trim(),b?`on ${b}`:""].filter(Boolean).join(" ");x.trim()&&d.push(x.trim())}return d.join(" â€¢ ")},[r.prevDueNote,r.prevDueUpdatedAt,r.prevDueUpdatedBy]),O=({label:d,value:b,subtle:w})=>e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",gap:6,opacity:w?.9:1},children:[e.jsx(P,{type:w?"secondary":void 0,children:d}),e.jsxs(P,{strong:!0,children:["â‚¹ ",h(b)]})]}),Ne=async d=>{try{V(d),p(!0),U([]),M(!0);const b=await Qe({GAS_URL:l,SECRET:c,branch:L,staff:ne,mode:d});U(b);try{if(b.filter(x=>!x.customerName&&String(x.sourceType||"").toLowerCase()==="jc").length){const x=await Promise.all(b.map(async C=>{if(C.customerName||String(C.sourceType||"").toLowerCase()!=="jc")return C;try{const Q=c?{action:"search",mode:"jc",query:String(C.sourceId||""),secret:c}:{action:"search",mode:"jc",query:String(C.sourceId||"")},re=await Te({webhookUrl:l,method:"GET",payload:Q}),K=re?.data||re||{},B=Array.isArray(K.rows)&&K.rows.length?K.rows[0]:null,oe=B?.values?.Customer_Name||B?.payload?.formValues?.custName||"";return oe?{...C,customerName:oe}:C}catch{return C}}));U(x)}}catch{}}catch{Y.error("Could not load transactions")}finally{M(!1)}},se=d=>{const b=String(d?.mobile||"").replace(/\D/g,"").slice(-10),w=String(d?.jcNo||d?.serialNo||"").trim(),x=new URLSearchParams;x.set("autoFetch","1"),b?(x.set("mode","mobile"),x.set("query",b)):w&&(x.set("mode","jc"),x.set("query",w)),w&&x.set("jcNo",w);const C=x.toString();t(C?`/jobcard?${C}`:"/jobcard")},Ae=async()=>{if(L){ee(!0);try{const[d,b]=await Promise.all([kt({GAS_URL:l,SECRET:c,branch:L}),Dt({BOOKING_GAS_URL:j,BOOKING_SECRET:A,branch:L})]);ce(d),Ie(b),te(new Date)}catch{Y.error("Could not load pending summary")}finally{ee(!1)}}};N.useEffect(()=>{Ae()},[L,l,j]);const Ee=N.useMemo(()=>{const d=Array.isArray(H)?H.length:0,b=Array.isArray(E)?E.length:0,w=(Array.isArray(E)?E:[]).reduce((x,C)=>x+(Number(C.balanceValue||0)||0),0);return{service:d,sales:b,salesBalance:w}},[H,E]);return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:n?"1fr":"1fr 1fr",gap:16,alignItems:"start"},children:[e.jsxs(xe,{size:"small",loading:S&&!F,title:"Account Summary",style:{width:"100%"},extra:e.jsx(X,{size:"small",onClick:o,disabled:S,children:"Refresh"}),children:[e.jsxs(be,{direction:"vertical",style:{width:"100%"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:n?"1fr":"1fr 1fr",gap:12},children:[e.jsxs("div",{style:{padding:12,border:"1px solid #f0f0f0",borderRadius:8,background:"#fff"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(P,{strong:!0,children:"Cash to Hand Over"}),e.jsxs(be,{size:6,children:[e.jsx(X,{size:"small",onClick:()=>Ne("cash"),children:"View"}),e.jsx($,{color:"green",children:"Cash"})]})]}),e.jsxs("div",{style:{fontSize:24,fontWeight:800,marginTop:6},children:["â‚¹ ",h(g.cash)]})]}),e.jsxs("div",{style:{padding:12,border:"1px solid #f0f0f0",borderRadius:8,background:"#fafafa"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsx(P,{strong:!0,children:"Online Collected"}),e.jsxs(be,{size:6,children:[e.jsx(X,{size:"small",onClick:()=>Ne("online"),children:"View"}),e.jsx($,{color:"blue",children:"Online"})]})]}),e.jsxs("div",{style:{fontSize:24,fontWeight:800,marginTop:6},children:["â‚¹ ",h(g.online)]}),e.jsx(P,{type:"secondary",style:{fontSize:12},children:"Shown for record, not handed over"})]})]}),e.jsxs("div",{style:{paddingTop:6},children:[e.jsx(P,{strong:!0,children:"Total Sales"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto",alignItems:"center",gap:12},children:[e.jsx(lt,{percent:g.totalCollected||0?100:0,showInfo:!1,strokeColor:{from:"#52c41a",to:"#2f54eb"}}),e.jsxs(P,{style:{fontSize:18,fontWeight:700},children:["â‚¹ ",h(g.totalCollected)]})]}),e.jsx(P,{type:"secondary",style:{fontSize:12},children:"Cash to hand over + Online collected"})]}),e.jsx(Pe,{style:{margin:"8px 0"}}),e.jsx(P,{type:"secondary",style:{fontSize:12},children:"Breakdown"}),e.jsx(O,{label:"Previous Due (carry forward)",value:g.prevDue,subtle:!0}),T?e.jsx(P,{type:"secondary",style:{fontSize:11,marginTop:-6,marginBottom:4},children:T}):null,e.jsx(O,{label:"From Job Cards",value:g.jc,subtle:!0}),e.jsx(O,{label:"From Bookings",value:g.booking,subtle:!0}),e.jsx(O,{label:"From Minor Sales",value:g.minor,subtle:!0}),e.jsx(O,{label:"Total Pending Payments",value:g.breakdownTotal}),e.jsx(Pe,{style:{margin:"8px 0"}}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsx(xt,{title:"After owner collects cash, only the owner can reset amounts to zero.",children:e.jsx($,{color:"orange",children:"Owner resets to zero after collection"})}),g.settlementDone?e.jsx($,{color:"green",children:"Settled"}):null,g.lastSettledAt?e.jsxs($,{color:"default",children:["Last settled: ",String(g.lastSettledAt)]}):null]})]}),e.jsx(jt,{open:a,title:v==="cash"?"Cash Transactions (Pending)":"Online Transactions (Pending)",onCancel:()=>{p(!1),U([])},footer:null,width:n?Math.min((typeof window<"u"?window.innerWidth:360)-24,520):800,children:e.jsx(Ye,{size:"small",rowKey:d=>`${d.dateTimeIso}-${d.sourceType}-${d.sourceId}`,dataSource:Z,loading:I,locale:I?{emptyText:" "}:void 0,columns:[{title:"Date",key:"date",render:(d,b)=>ge(b.dateTimeIso||b.date)},{title:"Customer",dataIndex:"customerName",key:"customer"},{title:"Mobile",dataIndex:"customerMobile",key:"mobile"},{title:"Source",key:"src",render:(d,b)=>`${String(b.sourceType||"").toUpperCase()} ${b.sourceId||""}`},{title:"Amount",key:"amt",align:"right",render:(d,b)=>(v==="cash"?b.cashPending:b.onlinePending).toLocaleString("en-IN")},{title:"UTR",key:"utr",render:(d,b)=>{if(String(b?.paymentMode||v||"").toLowerCase()==="cash")return"";const x=b?.utr??b?.utrNo??b?.reference??b?.ref,C=String(x??"").trim();return!C||C.toLowerCase()==="undefined"||C.toLowerCase()==="null"?"":C}}],pagination:{pageSize:n?6:10,size:n?"small":"default"},scroll:{x:"max-content"}})})]}),e.jsx(xe,{size:"small",title:"Pending Summary",style:{width:"100%"},extra:e.jsx(X,{size:"small",onClick:Ae,disabled:J,children:"Refresh"}),children:e.jsxs(be,{direction:"vertical",style:{width:"100%"},size:12,children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"},children:[e.jsxs($,{color:"orange",children:["Service Pending: ",Ee.service]}),e.jsxs($,{color:"blue",children:["Sales Pending: ",Ee.sales]}),e.jsxs($,{color:"geekblue",children:["Sales Balance: â‚¹ ",h(Ee.salesBalance)]}),Se?e.jsxs(P,{type:"secondary",style:{fontSize:11},children:["Last refresh: ",ge(Se)]}):null]}),e.jsxs("div",{children:[e.jsx(P,{strong:!0,children:"Service"}),e.jsx(P,{type:"secondary",style:{fontSize:12,marginLeft:6},children:"Pending Job Cards"}),e.jsx("div",{style:{marginTop:8,display:"grid",gap:8},children:J?e.jsx("div",{style:{padding:8},children:e.jsx(We,{size:"small"})}):H.length?H.slice(0,8).map(d=>e.jsxs("div",{style:{padding:"8px 10px",border:"1px solid #f0f0f0",borderRadius:10,background:"#fff",display:"flex",alignItems:"center",gap:n?6:10,flexWrap:n?"wrap":"nowrap",fontSize:n?10:11},children:[e.jsx(P,{strong:!0,style:{fontSize:n?10:11,minWidth:n?0:110,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:n?"1 1 100%":"0 0 auto"},children:d.name||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:90,whiteSpace:"nowrap"},children:d.mobile||"â€”"}),e.jsx(P,{style:{fontSize:n?10:11,minWidth:n?0:140,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[d.model,d.regNo].filter(Boolean).join(" | ")||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:120,whiteSpace:"nowrap"},children:d.dateAt?ge(d.dateAt):""}),e.jsx(X,{size:"small",type:"primary",style:{marginLeft:n?0:"auto",height:22,padding:"0 8px",fontSize:10},onClick:()=>se(d),children:"Post Service"})]},d.key)):e.jsx(we,{image:we.PRESENTED_IMAGE_SIMPLE,description:"No pending job cards"})})]}),e.jsx(Pe,{style:{margin:"6px 0"}}),e.jsxs("div",{children:[e.jsx(P,{strong:!0,children:"Sales"}),e.jsx(P,{type:"secondary",style:{fontSize:12,marginLeft:6},children:"Pending Balance (Bookings)"}),e.jsx("div",{style:{marginTop:8,display:"grid",gap:8,maxHeight:n?220:240,overflowY:"auto",paddingRight:4},children:J?e.jsx("div",{style:{padding:8},children:e.jsx(We,{size:"small"})}):E.length?E.map(d=>e.jsxs("div",{style:{padding:"8px 10px",border:"1px solid #f0f0f0",borderRadius:10,background:"#fff",display:"flex",alignItems:"center",gap:n?6:10,flexWrap:n?"wrap":"nowrap",fontSize:n?10:11},children:[e.jsx(P,{strong:!0,style:{fontSize:n?10:11,minWidth:n?0:110,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis",flex:n?"1 1 100%":"0 0 auto"},children:d.name||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:90,whiteSpace:"nowrap"},children:d.mobile||"â€”"}),e.jsx(P,{style:{fontSize:n?10:11,minWidth:n?0:170,whiteSpace:n?"normal":"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:[d.model,d.variant,d.color].filter(Boolean).join(" | ")||"â€”"}),e.jsx(P,{type:"secondary",style:{fontSize:n?9:10,minWidth:n?0:120,whiteSpace:"nowrap"},children:d.dateAt?ge(d.dateAt):""}),e.jsxs($,{color:"blue",style:{marginLeft:n?0:"auto",fontSize:10,lineHeight:"14px",padding:"0 6px"},children:["â‚¹ ",h(d.balanceValue||0)]})]},d.key)):e.jsx(we,{image:we.PRESENTED_IMAGE_SIMPLE,description:"No pending balances"})})]})]})})]})}async function Qe({GAS_URL:t,SECRET:s,branch:n,staff:i,mode:l}){const y=await Te({webhookUrl:t,method:"GET",payload:{action:"staff_ledger_transactions",branch:n,staff:i,mode:l}}),j=y?.data||y||{};if(!j?.success)throw new Error("Failed");const A=Array.isArray(j.rows)?j.rows:[],r=a=>String(a??"").trim().toLowerCase(),f=a=>{const p=a?.dateTimeIso||a?.date,v=Number(new Date(String(p)));return Number.isFinite(v)?v:0},S=a=>{const p=r(a?.sourceId||a?.sourceID||a?.jcNo||a?.source||""),v=r(a?.dateTimeIso||a?.date||"");return[r(a?.branch),r(a?.staff),r(a?.sourceType),p||v,r(a?.customerMobile),r(a?.paymentMode),r(a?.cashAmount??a?.cashPending),r(a?.onlineAmount??a?.onlinePending),r(a?.utr)].join("|")},m=new Map;return A.forEach(a=>{const p=S(a),v=m.get(p);(!v||f(a)>=f(v))&&m.set(p,a)}),Array.from(m.values())}async function kt({GAS_URL:t,SECRET:s,branch:n}){if(!n)return[];const l=await Te({webhookUrl:t,method:"GET",payload:{action:"list",branch:n,page:1,pageSize:1e4}}),c=l?.data||l||{},y=Array.isArray(c?.rows)?c.rows:Array.isArray(c?.data)?c.data:[],j=ke(n);return y.map((r,f)=>{const S=tt(r)||{},m=S.formValues||{},a=r?.values&&typeof r.values=="object"?r.values:r||{},p=m.branch||S.branch||a.Branch||a["Branch Name"]||a.Branch||"",v=It(S,a),V=m.jcNo||m.JCNo||S.jcNo||S.JCNo||m.serialNo||S.serialNo||a["JC No"]||a["JC No."]||a["Job Card No"]||"-";return{key:V||f,jcNo:V||"-",name:m.custName||m.name||a.Customer_Name||a["Customer Name"]||a.Customer||a.Name||"-",mobile:m.custMobile||m.mobile||a.Mobile||a["Mobile Number"]||a.Phone||"-",model:S.model||S.vehicle?.model||m.bikeModel||m.model||a.Model||"",regNo:m.regNo||a["Vehicle No"]||a.Vehicle_No||"",branch:String(p||"").trim(),dateAt:et(S,a),postServiced:v}}).filter(r=>ke(r.branch)===j).filter(r=>!r.postServiced).sort((r,f)=>De(f.dateAt)-De(r.dateAt)).slice(0,50)}async function Dt({BOOKING_GAS_URL:t,BOOKING_SECRET:s,branch:n}){if(!n)return[];const i={action:"list",page:1,pageSize:1e4},l=n?{...i,branch:n}:i,c=await Fe({webhookUrl:t,method:"GET",payload:l}),y=c?.data||c||{},j=Array.isArray(y?.rows)?y.rows:Array.isArray(y?.data)?y.data:[],A=ke(n);return j.map((f,S)=>{const m=tt(f)||{},a=m.formValues||{},p=f?.values&&typeof f.values=="object"?f.values:f||{},v=nt(m.rawPayload,p?.["Raw Payload"],p?.rawPayload,p?.RawPayload,p?.rawpayload,f.rawPayload,f.payload?.rawPayload),V=a.branch||m.branch||p.Branch||p["Branch Name"]||p.Branch||"",{balanceValue:Z,balanceLabel:U}=_t({payload:m,values:p,rawPayload:v});return{key:a.bookingId||m.bookingId||p["Booking ID"]||p.Booking_Id||p["Booking Id"]||S,bookingId:a.bookingId||m.bookingId||p["Booking ID"]||p.Booking_Id||p["Booking Id"]||"",name:a.custName||a.name||p.Customer_Name||p["Customer Name"]||p.Customer||p.Name||"-",mobile:a.custMobile||a.mobile||p.Mobile||p["Mobile Number"]||p.Phone||"-",model:m.model||m.vehicle?.model||a.bikeModel||a.model||p.Model||"",variant:m.variant||m.vehicle?.variant||a.variant||p.Variant||"",color:m.color||m.vehicle?.color||a.color||p.Color||p.Colour||p["Vehicle Color"]||p["Vehicle Colour"]||"",branch:String(V||"").trim(),dateAt:et(m,p),balanceValue:Z,balanceLabel:U}}).filter(f=>ke(f.branch)===A).filter(f=>Number(f.balanceValue||0)>st).sort((f,S)=>De(S.dateAt)-De(f.dateAt))}const ke=t=>String(t||"").trim().toLowerCase(),De=t=>{if(!t)return 0;const s=t instanceof Date?t:new Date(String(t)),n=Number(s.getTime());return Number.isFinite(n)?n:0},et=(t={},s={})=>{const n=[t.postServiceAt,t.savedAt,t.ts,t.tsMs,t.createdAt,s["Post Service At"],s.PostServiceAt,s.Post_Service_At,s["Saved At"],s.savedAt,s.Timestamp,s.timestamp,s.DateTime,s["Date Time"],s.Date_Time,s["Submitted At"],s.SubmittedAt,s.submittedAt,s["Created At"],s.CreatedAt,s.createdAt].find(l=>l!=null&&String(l).trim()!=="");if(!n)return null;const i=n instanceof Date?n:new Date(String(n));return Number.isFinite(i.getTime())?i:null},tt=t=>{if(!t)return null;if(t.payload&&typeof t.payload=="object")return t.payload;if(typeof t.payload=="string")try{return JSON.parse(t.payload)}catch{}const s=t.values&&(t.values.Payload||t.values.payload||t.values.PAYLOAD)||t.Payload||t.PAYLOAD;if(typeof s=="string")try{return JSON.parse(s)}catch{}return t.formValues&&(t.followUp||t.savedAt||t.postServiceAt)?t:null},It=(t={},s={})=>{if(t.postServiceAt||Array.isArray(t.payments)&&t.payments.some(l=>Number(l?.amount||0)>0)||s["Post Service At"]||s.PostServiceAt||s.Post_Service_At)return!0;const i=l=>String(s[l]||"").trim().toLowerCase();return!!["yes","done","completed","true"].includes(i("Post Service"))},D=t=>{if(t==null||t==="")return 0;const s=String(t).replace(/[^0-9.-]/g,""),n=Number(s);return Number.isFinite(n)?n:0},Le=t=>{if(t==null)return null;if(typeof t=="object")return t;if(typeof t!="string")return null;try{return JSON.parse(t)}catch{return null}},nt=(...t)=>{for(const s of t){if(!s&&s!==0)continue;if(typeof s=="object")return s;const n=Le(s);if(n)return n}return null},G=t=>{const s=Number(t);return Number.isFinite(s)&&s>=0?s:null},st=.01,Re=/balance/i,_e=t=>{if(t==null)return{found:!1};const s=typeof t;if(s==="object"||s==="boolean")return{found:!1};if((s==="string"?t.trim():String(t).trim())==="")return{found:!1};const i=D(t);return Number.isFinite(i)?{found:!0,value:i}:{found:!1}},ie=t=>{const s=_e(t);return s.found?s.value:null},Et=(t,s=[])=>{if(!(!t||!s.length))return s.reduce((n,i)=>{if(!(!n||typeof n!="object"))return n[i]},t)},Ue=(t,s=[])=>{if(!Array.isArray(t))return[];const n=[];for(const i of t)if(!(!i||typeof i!="object"))for(const l of s){const c=Et(i,l);if(c==null)continue;const y=_e(c);y.found&&n.push(y.value)}return n},je=(t,s,n=3,i=new WeakSet)=>{if(!t||typeof t!="object"||n<0)return[];if(i.has(t))return[];i.add(t);const l=Array.isArray(t)?t.map((y,j)=>[String(j),y]):Object.entries(t),c=[];for(const[y,j]of l){if(s.test(String(y||""))){const A=_e(j);A.found&&c.push(A.value)}if(j&&typeof j=="object")c.push(...je(j,s,n-1,i));else if(typeof j=="string"){const A=Le(j);A&&typeof A=="object"&&c.push(...je(A,s,n-1,i))}}return c},Mt=(...t)=>{const s=[],n=i=>{if(!(!i||typeof i!="object")){if(Array.isArray(i)){i.forEach(n);return}"payments"in i&&Array.isArray(i.payments)&&n(i.payments),"paymentSplit"in i&&Array.isArray(i.paymentSplit)&&i.paymentSplit.forEach(l=>{l&&typeof l=="object"&&s.push(l)}),"paymentDetails"in i&&Array.isArray(i.paymentDetails)&&n(i.paymentDetails),!("payments"in i)&&!("paymentSplit"in i)&&!("paymentDetails"in i)&&s.push(i)}};return t.forEach(i=>{if(i){if(Array.isArray(i)){i.forEach(n);return}if(typeof i=="string"){try{const l=JSON.parse(i);n(l)}catch{return}return}n(i)}}),s},Ot=({payload:t,values:s,rawPayload:n})=>{const i=s||{},l=Mt(t?.payments,i.payments,i.paymentDetails,t?.paymentSplit,i.paymentSplit,n?.payments,n?.paymentSplit,n?.paymentDetails),c={cash:0,online:0,total:0};l.forEach(f=>{const S=G(f?.amount);if(S===null)return;const m=String(f?.mode||"").trim().toLowerCase();m==="cash"?c.cash+=S:m==="online"&&(c.online+=S),c.total+=S});const y=G(t?.dp?.totalDp)??G(t?.totalDp)??G(t?.downPayment)??G(i.totalDp)??G(i.downPayment)??G(n?.dp?.totalDp)??G(n?.totalDp)??G(n?.downPayment),j=y!==null,A=j?y:0,r=Math.max(0,A-c.total);return{cashCollected:c.cash,onlineCollected:c.online,totalCollected:c.total,totalDp:A,balancedDp:r,hasTotals:j}},Ke=t=>{const s=t?.payload||{},n=t?.values||{},i=["purchaseMode","purchase_mode","purchase type","Purchase Mode","Purchase_Mode","Purchase Type","paymentMode","payment_mode","Payment Mode","Payment Type","paymentType","payment_type"],c=[s.purchaseMode,s.purchaseType,s.paymentType,...i.map(y=>n[y])].find(y=>typeof y=="string"&&y.trim());return String(c||"cash").trim().toLowerCase()},Rt=t=>{if(!t)return!1;const s=String(t).trim().toLowerCase();return["loan","nohp","hp","finance"].includes(s)},Ut=({payload:t={},values:s={},rawPayload:n=null,purchaseType:i}={})=>{if(!t||typeof t!="object")return{pendingAmount:null,pendingLabel:""};const l=nt(n,s?.rawPayload,s?.["Raw Payload"],t?.rawPayload,t?.["Raw Payload"])||{},c=[D(t?.bookingAmount),D(s?.["Booking Amount"]),D(s?.bookingAmount),D(s?.Booking_Amount),D(l?.bookingAmount)].find(v=>v>0)??0,y=[D(l?.totalVehicleCost),D(l?.cash?.totalVehicleCost),D(l?.cash?.onRoadPrice),D(t?.totalVehicleCost),D(t?.onRoadPrice),D(s?.["Total Vehicle Cost"]),D(s?.["On Road Price"])].find(v=>v>0)??0,j=[D(l?.totalDp),D(l?.dp?.totalDp),D(t?.totalDp),D(t?.dp?.totalDp),D(s?.["Total DP"])].find(v=>v>0)??0,A=D(l?.downPayment||t?.downPayment||s?.["Down Payment"])+D(l?.extraFittingAmount||t?.extraFittingAmount||s?.["Extra Fitting Amount"])+D(l?.affidavitCharges||t?.affidavitCharges||s?.["Affidavit Charges"]),r=j||A||0,f=String(i||t?.purchaseMode||s?.["Purchase Mode"]||l?.purchaseMode||"cash").trim().toLowerCase(),S=["loan","nohp","hp","finance"].includes(f),m=S?"Balanced DP":"Balance Amount",a=S?r-c:y-c;return{pendingAmount:Math.max(0,Number.isFinite(a)?a:0),pendingLabel:m}},Bt=[["dp","balancedDp"],["dp","balanceTP"],["dp","balanceTPIC"],["balanceTP"],["balancedDp"],["balance"]],Ft=[["balancedAmount"],["balanceAmount"],["cash","balancedAmount"],["balance"],["dp","balancedDp"]],Lt=[["cash","totalVehicleCost"],["cash","onRoadPrice"],["cash","price"],["vehicle","totalVehicleCost"],["vehicle","onRoadPrice"],["vehicle","price"],["totalVehicleCost"],["onRoadPrice"],["price"]],_t=({payload:t={},values:s={},rawPayload:n=null})=>{const i=[];if(t&&typeof t=="object"&&i.push(t),s&&typeof s=="object"&&i.push(s),n){const M=Le(n);M&&typeof M=="object"&&i.push(M)}const l={payload:t,values:s},c=Rt(Ke(l)),y=Ot({payload:t,values:s,rawPayload:n}),j=Ut({payload:t,values:s,rawPayload:n,purchaseType:Ke(l)}),A=Ue(i,Ft),r=Ue(i,Bt),f=Ue(i,Lt),S=Number.isFinite(y.totalCollected)?y.totalCollected:0,m=f.length?Math.max(...f):null,a=m!==null?Math.max(0,m-S):null,p=ie(t?.cash?.balancedAmount)??ie(t?.balancedAmount)??ie(s?.balancedAmount)??ie(s?.balanceAmount)??(A.length?Math.max(...A):null)??(a!==null?a:null),v=ie(t?.dp?.balancedDp)??ie(t?.balancedDp)??ie(s?.balancedDp)??(r.length?Math.max(...r):null)??(y.hasTotals?y.balancedDp:null),V=Number.isFinite(j?.pendingAmount)?j.pendingAmount:null,Z=j?.pendingLabel||"";let U=V!==null?V:c&&v!==null?v:p;if(U===null||!Number.isFinite(U)){const M=je(t,Re,3),F=je(s,Re,2),le=n&&typeof n=="object"?je(n,Re,2):[],J=[...M,...F,...le].filter(ee=>Number.isFinite(ee)&&ee>st);J.length&&(U=Math.max(...J))}const I=Z||(c&&U!==null?"Balanced DP":"Balanced Amount");return{balanceValue:Number(U||0),balanceLabel:I}};function ge(t){try{if(!t)return"";const s=t instanceof Date?t:new Date(String(t));if(Number.isNaN(s.getTime()))return String(t);const n=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),l=String(s.getDate()).padStart(2,"0"),c=String(s.getHours()).padStart(2,"0"),y=String(s.getMinutes()).padStart(2,"0");return`${l}-${i}-${n} ${c}:${y}`}catch{return String(t||"")}}function Rn(){const s=!Xe.useBreakpoint().md,[n,i]=Be.useState(""),l={maxWidth:1200,margin:"0 auto",padding:s?12:16},c={paddingTop:12,width:"100%",overflowX:"auto",minWidth:0},{hasNew:y,latestItem:j}=ft(),A=m=>m==="alert"?"#fa541c":m==="warning"?"#faad14":"#2f54eb",r=()=>y?e.jsx("span",{style:{marginLeft:6,padding:"0 6px",borderRadius:10,fontSize:11,color:"#fff",fontWeight:700,background:A(j?.type),display:"inline-block",animation:"annPulse 1.6s ease-in-out infinite"},children:"NEW"}):null,f=(m,a)=>e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:8},children:[e.jsx("span",{"aria-hidden":!0,style:{fontSize:16},children:m}),e.jsx("span",{children:a})]});Be.useEffect(()=>{(async()=>{try{let m=null;try{const p=localStorage.getItem("user");m=p?JSON.parse(p):null}catch{}if(!m){const p=await $e().catch(()=>null);if(p?.success&&p.data){m=p.data;try{localStorage.setItem("user",JSON.stringify(m))}catch{}}}const a=m?.formDefaults?.branchName||m?.primaryBranch?.name||(Array.isArray(m?.branches)?typeof m.branches[0]=="string"?m.branches[0]:m.branches[0]?.name||"":"");i(a||"")}catch{i("")}})()},[]);const S=[{key:"quotation",label:f("ğŸ§¾","Quotation"),children:e.jsx("div",{style:c,children:e.jsx(ot,{})})},{key:"jobcard",label:f("ğŸ”§","Job Card"),children:e.jsx("div",{style:c,children:e.jsx(at,{})})},{key:"followups",label:f("ğŸ“","Follow-ups"),children:e.jsx("div",{style:c,children:e.jsx(St,{})})},{key:"booking",label:f("ğŸ“…","Booking"),children:e.jsx("div",{style:c,children:e.jsx(ct,{})})},{key:"vehicle-search",label:f("ğŸï¸","Vehicle Search"),children:e.jsx("div",{style:c,children:e.jsx(dt,{})})},{key:"stock",label:f("ğŸ”","Stock Finder"),children:e.jsx("div",{style:c,children:e.jsx(mt,{})})},{key:"stock-update",label:f("ğŸ“¦","Stock Update"),children:e.jsx("div",{style:c,children:e.jsx(pt,{})})},{key:"minorsales",label:e.jsxs(e.Fragment,{children:[e.jsx("style",{children:"@keyframes annPulse{0%{transform:scale(1);}60%{transform:scale(1.05);}100%{transform:scale(1);}}"}),e.jsxs("span",{children:[f("ğŸ›’","Minor Sales"),e.jsx(r,{})]})]}),children:e.jsx("div",{style:c,children:e.jsx(Ct,{})})},{key:"account",label:f("ğŸ’¼","Account"),children:e.jsx("div",{style:c,children:e.jsx(Tt,{})})},{key:"announcements",label:e.jsxs(e.Fragment,{children:[e.jsx("style",{children:"@keyframes annPulse{0%{transform:scale(1);}60%{transform:scale(1.05);}100%{transform:scale(1);}}"}),e.jsxs("span",{children:[f("ğŸ“£","Announcements"),e.jsx(r,{})]})]}),children:e.jsx("div",{style:c,children:e.jsx(gt,{})})}];return e.jsxs("div",{style:l,children:[e.jsx("h2",{style:{marginTop:0,display:"flex",alignItems:"baseline",flexWrap:"wrap",gap:s?8:12,lineHeight:1.15},children:n?e.jsx("span",{title:"Your branch",style:{marginLeft:0,fontSize:s?18:28,fontWeight:800,letterSpacing:.3,whiteSpace:"nowrap",display:"inline-flex",alignItems:"center",lineHeight:1.1,background:"linear-gradient(90deg,#2f54eb 0%, #13c2c2 45%, #52c41a 100%)",WebkitBackgroundClip:"text",backgroundClip:"text",color:"transparent",textShadow:"0 1px 1px rgba(0,0,0,0.08)"},children:n}):null}),e.jsx(Ge,{defaultActiveKey:"quotation",items:S,tabPosition:"top",size:s?"small":"middle",tabBarGutter:s?8:16,tabBarStyle:{marginBottom:s?8:12},style:{width:"100%"},destroyInactiveTabPane:!0})]})}export{Rn as default};
